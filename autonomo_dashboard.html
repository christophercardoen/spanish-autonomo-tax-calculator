<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Autonomo Tax Calculator - 2025/2026</title>
  <style>
    /* Minimal styling for now - Phase 5 adds full dashboard */
    :root {
      --bg: #1a1a2e;
      --text: #eaeaea;
      --accent: #4ade80;
    }
    body {
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 2rem;
    }
    .container { max-width: 800px; margin: 0 auto; }
    input[type="number"] { padding: 0.5rem; font-size: 1rem; width: 150px; }
    input[type="checkbox"] { width: auto; }
    button { padding: 0.5rem 1rem; cursor: pointer; }
    .result { margin-top: 1rem; font-family: monospace; }
    .breakdown { margin-left: 1rem; font-size: 0.9rem; opacity: 0.8; }
    .input-section {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .input-section label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    h2 { color: var(--accent); margin-top: 2rem; }
    h3 { margin-top: 1.5rem; margin-bottom: 0.5rem; opacity: 0.9; }
    hr { border: none; border-top: 1px solid rgba(255,255,255,0.2); margin: 0.5rem 0; }

    /* Source citation styling */
    .source-hint {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      margin-left: 4px;
      background: rgba(74, 222, 128, 0.2);
      border: 1px solid var(--accent);
      border-radius: 50%;
      font-size: 10px;
      color: var(--accent);
      cursor: help;
      position: relative;
      vertical-align: middle;
    }

    .source-hint:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #2d2d44;
      border: 1px solid var(--accent);
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      font-size: 11px;
      white-space: normal;
      max-width: 300px;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      margin-bottom: 8px;
    }

    .source-hint:hover::before {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--accent);
      z-index: 101;
    }

    /* Footnotes section */
    .footnotes {
      margin-top: 3rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .footnotes h4 {
      margin-bottom: 1rem;
      color: var(--accent);
    }

    .footnotes ul {
      list-style: none;
      padding: 0;
    }

    .footnotes li {
      margin-bottom: 0.5rem;
    }

    .footnotes a {
      color: var(--accent);
      text-decoration: none;
    }

    .footnotes a:hover {
      text-decoration: underline;
    }

    .confidence-high { color: #4ade80; }
    .confidence-medium { color: #facc15; }

    /* Belgium Pattern Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
      position: absolute;
    }

    .toggle-switch .slider {
      position: relative;
      width: 50px;
      height: 26px;
      background: #444;
      border-radius: 13px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle-switch .slider::before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      left: 3px;
      top: 3px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }

    .toggle-switch input:checked + .slider {
      background: var(--accent);
    }

    .toggle-switch input:checked + .slider::before {
      transform: translateX(24px);
    }

    .toggle-switch input:focus + .slider {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .toggle-label {
      font-size: 0.9rem;
      opacity: 0.7;
    }

    .toggle-label.active {
      opacity: 1;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Autonomo Tax Calculator 2025/2026</h1>
    <p>Calculate your IRPF liability as a Spanish autonomo</p>

    <div class="input-section">
      <label>
        Monthly Revenue (EUR):
        <input type="number" id="monthlyRevenue" value="6000" min="0" step="100">
      </label>
      <label>
        Monthly Deductible Expenses (EUR):
        <input type="number" id="monthlyExpenses" value="0" min="0" step="50">
      </label>
      <label>
        <input type="checkbox" id="hasDescendant" checked>
        1 Dependent Child (adds 2,400 EUR minimo)
      </label>
      <button onclick="calculate()">Calculate</button>
    </div>

    <div id="results" class="result"></div>
  </div>
  <script>
    // ============================================================
    // FISCAL_2025 CONSTANTS
    // ============================================================
    // All fiscal data verified from official AEAT/BOE sources
    // See: .planning/research/FISCAL_DATA.md for full citations
    // ============================================================

    const FISCAL_2025 = Object.freeze({
      // IRPF Brackets - Combined estatal + autonomica rates
      // Source: Wolters Kluwer, AEAT - unchanged from 2024
      // https://www.wolterskluwer.com/es-es/expert-insights/tramos-retenciones-irpf-2025-novedades
      //
      // baseTax = cumulative tax from all lower brackets
      // prevLimit = upper boundary of previous bracket
      IRPF_BRACKETS: Object.freeze([
        { upTo: 12450, rate: 0.19, baseTax: 0, prevLimit: 0 },
        { upTo: 20200, rate: 0.24, baseTax: 2365.50, prevLimit: 12450 },
        { upTo: 35200, rate: 0.30, baseTax: 4225.50, prevLimit: 20200 },
        { upTo: 60000, rate: 0.37, baseTax: 8725.50, prevLimit: 35200 },
        { upTo: 300000, rate: 0.45, baseTax: 17901.50, prevLimit: 60000 },
        { upTo: Infinity, rate: 0.47, baseTax: 125901.50, prevLimit: 300000 }
      ]),

      // Personal/Family minimums
      // Source: AEAT Manual Practico IRPF 2024
      // https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2024/c14-adecuacion-impuesto-circunstancias-personales/cuadro-resumen-minimo-personal-familiar.html
      MINIMO_PERSONAL: 5550,
      MINIMO_DESCENDIENTES_PRIMERO: 2400,

      // Fixed RETA from user registration
      // This is the actual cuota paid, not a calculated value
      // Source: User's Seguridad Social registration document
      RETA_MONTHLY: 428.40,
      RETA_ANNUAL: 5140.80,

      // Gastos dificil justificacion (Estimacion Directa Simplificada)
      // Source: AEAT Estimacion Directa Simplificada
      // https://sede.agenciatributaria.gob.es/Sede/irpf/empresarios-individuales-profesionales/regimenes-determinar-rendimiento-actividad/estimacion-directa-simplificada.html
      // Note: Was 7% in 2023, reverted to 5% for 2024 onwards
      GASTOS_DIFICIL_RATE: 0.05,
      GASTOS_DIFICIL_MAX: 2000,

      // Private costs (fixed, not deductible)
      // Breakdown: Rent 70% (808.50) + GSM 50% (27.50) + Electricity 91% (91) + Auto (600) + Insurance (200)
      PRIVATE_COSTS_MONTHLY: 1727
    });

    // ============================================================
    // OFFICIAL SOURCE CITATIONS
    // ============================================================
    // All fiscal data traced to official AEAT/BOE/Seguridad Social sources
    // ============================================================

    const SOURCES = Object.freeze({
      IRPF_BRACKETS: {
        name: "IRPF Tramos 2025",
        source: "AEAT / Wolters Kluwer",
        url: "https://www.wolterskluwer.com/es-es/expert-insights/tramos-retenciones-irpf-2025-novedades",
        note: "Unchanged from 2024. Combined estatal + autonomica rates.",
        confidence: "HIGH"
      },
      MINIMO_PERSONAL: {
        name: "Minimo del Contribuyente",
        source: "AEAT Manual Practico IRPF 2024",
        url: "https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2024/c14-adecuacion-impuesto-circunstancias-personales/cuadro-resumen-minimo-personal-familiar.html",
        note: "5,550 EUR for all taxpayers regardless of age.",
        confidence: "HIGH"
      },
      MINIMO_DESCENDIENTES: {
        name: "Minimo por Descendientes",
        source: "AEAT",
        url: "https://sede.agenciatributaria.gob.es/Sede/ciudadanos-familias-personas-discapacidad/minimo-personal-familiar/minimo-descendientes.html",
        note: "2,400 EUR for first child. Add 2,800 EUR if under 3 years old.",
        confidence: "HIGH"
      },
      RETA: {
        name: "Cuota RETA",
        source: "User registration document / BOE",
        url: "https://www.boe.es/diario_boe/txt.php?id=BOE-A-2025-3780",
        note: "Fixed cuota 428.40 EUR/month from autonomo registration.",
        confidence: "HIGH"
      },
      GASTOS_DIFICIL: {
        name: "Gastos de Dificil Justificacion",
        source: "AEAT Estimacion Directa Simplificada",
        url: "https://sede.agenciatributaria.gob.es/Sede/irpf/empresarios-individuales-profesionales/regimenes-determinar-rendimiento-actividad/estimacion-directa-simplificada.html",
        note: "5% of rendimiento neto, maximum 2,000 EUR/year. Was 7% only in 2023.",
        confidence: "HIGH"
      },
      MINIMO_APPLICATION: {
        name: "4-Phase Minimo Method",
        source: "AEAT Cuotas Integras Example",
        url: "https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2022/c15-calculo-impuesto-determinacion-cuotas-integras/ejemplo-practico-calculo-cuotas-integras-autonomica.html",
        note: "Minimos reduce TAX LIABILITY, not taxable base. Tax on minimo is subtracted from tax on full base.",
        confidence: "HIGH"
      }
    });

    // ============================================================
    // EXPENSE DATA CONSTANTS
    // ============================================================
    // Pre-filled expense data for Spain deductible, Belgium costs, and private
    // All amounts from CLAUDE.md Fixed Costs section
    // ============================================================

    const DEFAULT_EXPENSES = Object.freeze({
      version: 1,
      belgiumPattern: 'high',  // 'low' (1000) or 'high' (2500)
      categories: Object.freeze({
        spainDeductible: Object.freeze([
          Object.freeze({ id: 'huur', name: 'Huur (Rent)', baseAmount: 1155, deductionPct: 30, deletable: true }),
          Object.freeze({ id: 'gsm', name: 'GSM (Mobile)', baseAmount: 55, deductionPct: 50, deletable: true }),
          Object.freeze({ id: 'elektriciteit', name: 'Elektriciteit', baseAmount: 100, deductionPct: 9, deletable: true })
        ]),
        belgiumCosts: Object.freeze([
          Object.freeze({ id: 'belgium-travel', name: 'Belgium Work Costs', amount: 2500, isPatternLinked: true, deletable: true })
        ]),
        private: Object.freeze([
          Object.freeze({ id: 'huur-private', name: 'Huur 70%', amount: 808.50, deletable: true }),
          Object.freeze({ id: 'gsm-private', name: 'GSM 50%', amount: 27.50, deletable: true }),
          Object.freeze({ id: 'elektriciteit-private', name: 'Elektriciteit 91%', amount: 91, deletable: true }),
          Object.freeze({ id: 'auto', name: 'Auto', amount: 600, deletable: true }),
          Object.freeze({ id: 'verzekeringen', name: 'Verzekeringen', amount: 200, deletable: true })
        ])
      })
    });

    // ============================================================
    // LOCALSTORAGE PERSISTENCE
    // ============================================================
    // Expense data persists between browser sessions
    // Graceful fallback for Safari private mode and quota errors
    // ============================================================

    const STORAGE_KEY = 'autonomo_expenses_v1';

    /**
     * Load expenses from localStorage
     * Falls back to DEFAULT_EXPENSES on error or invalid data
     * @returns {object} - Expense data object (mutable clone)
     */
    function loadExpenses() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);
          // Version check for future migration support
          if (parsed && parsed.version === 1) {
            return parsed;
          }
        }
      } catch (e) {
        console.warn('localStorage load failed (Safari private mode?):', e.message);
      }
      // Return mutable clone of defaults
      return structuredClone(DEFAULT_EXPENSES);
    }

    /**
     * Save expenses to localStorage
     * Handles QuotaExceededError gracefully
     * @returns {boolean} - True if save succeeded
     */
    function saveExpenses() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(expenseData));
        return true;
      } catch (e) {
        if (e.name === 'QuotaExceededError') {
          console.warn('localStorage quota exceeded - changes not persisted');
        } else {
          console.warn('localStorage save failed:', e.message);
        }
        return false;
      }
    }

    // Global expense data - initialized from localStorage or defaults
    let expenseData = loadExpenses();

    // ============================================================
    // BELGIUM PATTERN TOGGLE
    // ============================================================
    // Toggle between low-travel (1K/month) and high-travel (2.5K/month)
    // Pattern affects Belgium costs breakdown and formula display
    // ============================================================

    /**
     * Update Belgium cost based on current pattern
     * Finds expense with isPatternLinked: true and updates amount
     */
    function updateBelgiumCost() {
      const belgiumExpense = expenseData.categories.belgiumCosts.find(e => e.isPatternLinked);
      if (belgiumExpense) {
        belgiumExpense.amount = expenseData.belgiumPattern === 'high' ? 2500 : 1000;
      }
    }

    /**
     * Initialize Belgium toggle switch
     * Sets initial state and adds change event listener
     */
    function initBelgiumToggle() {
      const toggle = document.getElementById('belgiumToggle');
      if (!toggle) return;  // Toggle not yet in DOM

      // Set initial state based on expenseData
      toggle.checked = expenseData.belgiumPattern === 'high';

      // Update label active states
      updateToggleLabels(toggle.checked);

      // Add change event listener
      toggle.addEventListener('change', (e) => {
        expenseData.belgiumPattern = e.target.checked ? 'high' : 'low';
        updateBelgiumCost();
        saveExpenses();
        updateToggleLabels(e.target.checked);
        // Note: UI re-render will be added in Plan 02-02
      });
    }

    /**
     * Update toggle label active states
     * @param {boolean} isHigh - True if high pattern selected
     */
    function updateToggleLabels(isHigh) {
      const lowLabel = document.querySelector('.toggle-label.low');
      const highLabel = document.querySelector('.toggle-label.high');

      if (lowLabel) {
        lowLabel.classList.toggle('active', !isHigh);
      }
      if (highLabel) {
        highLabel.classList.toggle('active', isHigh);
      }
    }

    /**
     * Get Belgium breakdown formula for current pattern
     * Shows transparent calculation: days x dietas + flights x cost
     * @returns {string} - Formatted formula string
     */
    function getBelgiumBreakdownFormula() {
      const pattern = expenseData.belgiumPattern;

      if (pattern === 'high') {
        // High travel: ~17 days, 4 flights per month
        return `~17 days x ${formatEUR(91.35)} dietas + 4 flights x ${formatEUR(250)} = ~${formatEUR(2500)}`;
      } else {
        // Low travel: ~3 days, 1 flight per month
        return `~3 days x ${formatEUR(91.35)} dietas + 1 flight x ${formatEUR(250)} = ~${formatEUR(1000)}`;
      }
    }

    // ============================================================
    // CALCULATION FUNCTIONS
    // ============================================================
    // Implements official AEAT IRPF calculation methodology
    // CRITICAL: Uses 4-phase method where minimos reduce TAX, not BASE
    // ============================================================

    /**
     * Apply progressive IRPF brackets to any amount
     * Uses cumulative baseTax approach for accuracy at bracket boundaries
     * @param {number} amount - Taxable amount in EUR
     * @returns {number} - Tax amount in EUR (rounded to 2 decimals)
     */
    function applyBrackets(amount) {
      if (amount <= 0) return 0;

      for (const bracket of FISCAL_2025.IRPF_BRACKETS) {
        if (amount <= bracket.upTo) {
          return Math.round((bracket.baseTax + (amount - bracket.prevLimit) * bracket.rate) * 100) / 100;
        }
      }
      // Fallback (should never reach with Infinity bound)
      const last = FISCAL_2025.IRPF_BRACKETS[FISCAL_2025.IRPF_BRACKETS.length - 1];
      return Math.round((last.baseTax + (amount - last.prevLimit) * last.rate) * 100) / 100;
    }

    /**
     * Calculate Cuota Integra using 4-phase AEAT method
     * CRITICAL: Minimos reduce TAX liability, NOT taxable base
     *
     * Method:
     * 1. Calculate tax on full base liquidable
     * 2. Calculate tax on minimo amount (capped at base liquidable)
     * 3. Subtract #2 from #1 to get cuota integra
     *
     * Source: AEAT practical examples
     * https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2022/c15-calculo-impuesto-determinacion-cuotas-integras/ejemplo-practico-calculo-cuotas-integras-autonomica.html
     *
     * @param {number} baseLiquidable - Taxable base after all deductions
     * @param {number} minimoTotal - Sum of minimo personal + descendientes
     * @returns {number} - Cuota integra (tax liability) in EUR
     */
    function calculateCuotaIntegra(baseLiquidable, minimoTotal) {
      const cuota1 = applyBrackets(baseLiquidable);
      const minimoApplicable = Math.min(minimoTotal, baseLiquidable);
      const cuota3 = applyBrackets(minimoApplicable);
      return Math.max(0, Math.round((cuota1 - cuota3) * 100) / 100);
    }

    /**
     * Calculate Gastos de Dificil Justificacion
     * For Estimacion Directa Simplificada: 5% with 2000 EUR annual cap
     *
     * Source: AEAT Estimacion Directa Simplificada
     * Note: Was 7% in 2023, reverted to 5% for 2024 onwards
     *
     * @param {number} rendimientoNetoPrevio - Net income before gastos dificil
     * @returns {number} - Deductible amount in EUR
     */
    function calculateGastosDificil(rendimientoNetoPrevio) {
      if (rendimientoNetoPrevio <= 0) return 0;
      const calculated = rendimientoNetoPrevio * FISCAL_2025.GASTOS_DIFICIL_RATE;
      return Math.round(Math.min(calculated, FISCAL_2025.GASTOS_DIFICIL_MAX) * 100) / 100;
    }

    /**
     * Main IRPF calculation function - returns all intermediate values
     *
     * CALC-05 Clarification:
     * The 7% reduccion rendimientos applies only when calculating the RETA base
     * for Social Security purposes. For IRPF, the actual RETA cuota paid
     * (428.40 EUR/month) is deducted as an expense. Since the user has a fixed
     * RETA cuota from registration, we simply deduct it as a business expense.
     *
     * @param {number} monthlyRevenue - Gross monthly revenue in EUR
     * @param {number} monthlyDeductibleExpenses - Monthly deductible business expenses in EUR
     * @param {boolean} hasDescendant - Whether user has 1 dependent child
     * @returns {object} - Complete calculation breakdown
     */
    function calculateFullIRPF(monthlyRevenue, monthlyDeductibleExpenses = 0, hasDescendant = true) {
      // Step 1: Annualize inputs
      const annualRevenue = monthlyRevenue * 12;
      const annualExpenses = monthlyDeductibleExpenses * 12;

      // Step 2: Total deductible = expenses + RETA (fixed cuota, not calculated)
      // CALC-05: RETA cuota is deducted as expense. The 7% reduccion is for SS, not IRPF.
      const totalDeductible = annualExpenses + FISCAL_2025.RETA_ANNUAL;

      // Step 3: Rendimiento Neto Previo (before gastos dificil)
      const rendimientoNetoPrevio = annualRevenue - totalDeductible;

      // Step 4: Gastos dificil justificacion
      const gastosDificil = calculateGastosDificil(rendimientoNetoPrevio);

      // Step 5: Rendimiento Neto = Base Liquidable (for autonomo)
      const rendimientoNeto = rendimientoNetoPrevio - gastosDificil;
      const baseLiquidable = Math.max(0, rendimientoNeto);

      // Step 6: Calculate minimos
      const minimoPersonal = FISCAL_2025.MINIMO_PERSONAL;
      const minimoDescendientes = hasDescendant ? FISCAL_2025.MINIMO_DESCENDIENTES_PRIMERO : 0;
      const minimoTotal = minimoPersonal + minimoDescendientes;

      // Step 7: Cuota Integra using 4-phase method
      const cuotaIntegra = calculateCuotaIntegra(baseLiquidable, minimoTotal);

      // Step 8: Effective tax rate
      const effectiveRate = rendimientoNeto > 0 ? (cuotaIntegra / rendimientoNeto) : 0;

      // Step 9: Net income calculations
      const netAnnual = annualRevenue - totalDeductible - gastosDificil - cuotaIntegra;
      const netMonthly = netAnnual / 12;

      // Step 10: Leefgeld (after private costs)
      const leefgeld = netMonthly - FISCAL_2025.PRIVATE_COSTS_MONTHLY;

      return {
        // Inputs
        monthlyRevenue,
        annualRevenue,
        monthlyExpenses: monthlyDeductibleExpenses,
        annualExpenses,

        // Deductions
        retaMonthly: FISCAL_2025.RETA_MONTHLY,
        retaAnnual: FISCAL_2025.RETA_ANNUAL,
        totalDeductible,

        // Calculation chain
        rendimientoNetoPrevio,
        gastosDificil,
        rendimientoNeto,
        baseLiquidable,

        // Minimos (for display)
        minimoPersonal,
        minimoDescendientes,
        minimoTotal,

        // Tax
        cuotaIntegra,
        effectiveRate,

        // Net income
        netAnnual,
        netMonthly,
        leefgeld,

        // Private costs (for reference)
        privateCostsMonthly: FISCAL_2025.PRIVATE_COSTS_MONTHLY
      };
    }

    // ============================================================
    // FORMATTING UTILITIES
    // ============================================================

    /**
     * Format amount as EUR currency (Spanish locale)
     * @param {number} amount - Amount in EUR
     * @returns {string} - Formatted string like "5.550,00 EUR"
     */
    function formatEUR(amount) {
      return new Intl.NumberFormat('es-ES', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(amount);
    }

    /**
     * Format decimal as percentage
     * @param {number} decimal - Decimal value (0.25 = 25%)
     * @returns {string} - Formatted percentage like "25,00 %"
     */
    function formatPercent(decimal) {
      return new Intl.NumberFormat('es-ES', {
        style: 'percent',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(decimal);
    }

    // ============================================================
    // SOURCE CITATION UTILITIES
    // ============================================================

    /**
     * Create source hint HTML for inline citations
     * @param {string} sourceKey - Key from SOURCES constant
     * @returns {string} - HTML string with tooltip
     */
    function sourceHint(sourceKey) {
      const s = SOURCES[sourceKey];
      if (!s) return '';
      const tooltip = `${s.source}: ${s.note}`;
      return `<span class="source-hint" data-tooltip="${tooltip.replace(/"/g, '&quot;')}" data-source="${sourceKey}">i</span>`;
    }

    /**
     * Create footnotes section HTML listing all sources
     * @returns {string} - HTML string with sources list
     */
    function createFootnotes() {
      let html = '<div class="footnotes"><h4>Sources</h4><ul>';
      for (const [key, s] of Object.entries(SOURCES)) {
        html += `<li>
          <strong>${s.name}</strong> -
          <a href="${s.url}" target="_blank" rel="noopener">${s.source}</a>
          <span class="confidence-${s.confidence.toLowerCase()}">[${s.confidence}]</span>
        </li>`;
      }
      html += '</ul></div>';
      return html;
    }

    // ============================================================
    // UI FUNCTIONS
    // ============================================================

    /**
     * Main calculate function - triggered by button click
     * Reads inputs, calculates IRPF, and displays results
     */
    function calculate() {
      const monthlyRevenue = parseFloat(document.getElementById('monthlyRevenue').value) || 0;
      const monthlyExpenses = parseFloat(document.getElementById('monthlyExpenses').value) || 0;
      const hasDescendant = document.getElementById('hasDescendant').checked;

      const r = calculateFullIRPF(monthlyRevenue, monthlyExpenses, hasDescendant);

      const html = `
        <h2>Results</h2>

        <h3>Income</h3>
        <div class="breakdown">
          Monthly Revenue: ${formatEUR(r.monthlyRevenue)}<br>
          Annual Revenue: ${formatEUR(r.annualRevenue)}
        </div>

        <h3>Deductions</h3>
        <div class="breakdown">
          RETA (Seguridad Social): ${formatEUR(r.retaAnnual)} (${formatEUR(r.retaMonthly)}/month) ${sourceHint('RETA')}<br>
          Business Expenses: ${formatEUR(r.annualExpenses)}<br>
          <strong>Total Deductible: ${formatEUR(r.totalDeductible)}</strong>
        </div>

        <h3>IRPF Calculation ${sourceHint('IRPF_BRACKETS')}</h3>
        <div class="breakdown">
          Rendimiento Neto Previo: ${formatEUR(r.rendimientoNetoPrevio)}<br>
          Gastos Dificil Justificacion (5%, max 2000): ${formatEUR(r.gastosDificil)} ${sourceHint('GASTOS_DIFICIL')}<br>
          <strong>Rendimiento Neto / Base Liquidable: ${formatEUR(r.baseLiquidable)}</strong>
        </div>

        <h3>Minimos (reduce tax, not base) ${sourceHint('MINIMO_APPLICATION')}</h3>
        <div class="breakdown">
          Minimo Personal: ${formatEUR(r.minimoPersonal)} ${sourceHint('MINIMO_PERSONAL')}<br>
          Minimo por Descendientes: ${formatEUR(r.minimoDescendientes)} ${sourceHint('MINIMO_DESCENDIENTES')}<br>
          <strong>Total Minimos: ${formatEUR(r.minimoTotal)}</strong>
        </div>

        <h3>Tax</h3>
        <div class="breakdown">
          <strong>Cuota Integra (Annual IRPF): ${formatEUR(r.cuotaIntegra)}</strong><br>
          Effective Tax Rate: ${formatPercent(r.effectiveRate)}
        </div>

        <h3>Net Income</h3>
        <div class="breakdown">
          Annual Net: ${formatEUR(r.netAnnual)}<br>
          <strong>Monthly Net: ${formatEUR(r.netMonthly)}</strong><br>
          <hr>
          Private Costs: ${formatEUR(r.privateCostsMonthly)}/month<br>
          <strong style="color: var(--accent);">Leefgeld (after all costs): ${formatEUR(r.leefgeld)}/month</strong>
        </div>

        ${createFootnotes()}
      `;

      document.getElementById('results').innerHTML = html;
    }

    // Calculate on page load with default values
    document.addEventListener('DOMContentLoaded', calculate);
  </script>
</body>
</html>
