<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net https://accounts.google.com https://apis.google.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://accounts.google.com; font-src https://fonts.gstatic.com; img-src 'self' data: blob:; connect-src 'self' https://*.supabase.co https://*.supabase.in https://accounts.google.com https://apis.google.com https://*.googleapis.com; frame-src https://accounts.google.com;">
  <title>Autonomo Tax Calculator - 2025/2026</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ===========================================
       PHASE 5: DASHBOARD UI
       =========================================== */

    :root {
      /* Updated theme colors per CONTEXT.md */
      --bg: #1a1a1a;           /* Charcoal (was #1a1a2e) */
      --bg-surface: #242424;   /* Slightly lighter for cards */
      --bg-elevated: #2d2d44;  /* For modals, tooltips */
      --text: #eaeaea;
      --text-muted: #a0a0a0;
      --accent: #4ade80;

      /* Semantic colors per UI-07 */
      --positive: #4ade80;     /* green - income/positive values */
      --negative: #f87171;     /* red - expenses/negative values */
      --warning: #fb923c;      /* orange - threshold warnings */
      --belgium: #60a5fa;      /* blue - Belgium related */

      /* Typography per CONTEXT.md and UI-11 */
      --font-ui: 'DM Sans', system-ui, sans-serif;
      --font-mono: 'JetBrains Mono', 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Mono', 'Droid Sans Mono', 'Source Code Pro', monospace;
      --size-header: 20px;
      --size-numbers: 18px;
      --size-labels: 14px;
      --size-small: 12px;

      /* Spacing scale (Phase 7.2) */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      --spacing-2xl: 48px;

      /* Border radius tokens (Phase 7.2) */
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
    }
    body {
      font-family: var(--font-ui);
      background: var(--bg);
      color: var(--text);
      padding: 2rem;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      box-sizing: border-box;
    }

    /* Prevent horizontal overflow on html/body */
    html, body {
      overflow-x: hidden;
    }

    /* Text overflow handling */
    .expense-name,
    .metric .label,
    .block-row .label,
    .detail-row .label {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Number overflow prevention */
    .metric .value,
    .expense-value,
    .block-row .value,
    .detail-row .value {
      flex-shrink: 0;
    }

    /* ===========================================
       PHASE 7.2: GLOBAL POLISH
       =========================================== */

    /* Cross-browser compatibility */
    * {
      -webkit-tap-highlight-color: transparent; /* Remove tap highlight on iOS */
      -webkit-touch-callout: none; /* Disable long-press context menu on images */
    }

    /* Enable text selection for inputs and text */
    input, textarea, [contenteditable="true"] {
      -webkit-user-select: text;
      user-select: text;
    }

    /* Touch-action for interactive elements (prevents 300ms delay) */
    button, a, .day-cell, .scenario-card, .tab-label {
      touch-action: manipulation;
    }

    /* Safari flexbox fixes */
    .scenario-cards,
    .calendar-grid,
    .export-actions,
    .dialog-footer {
      -webkit-box-pack: start;
    }

    /* Focus-visible styles for keyboard accessibility */
    :focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Fallback for browsers without :focus-visible */
    @supports not selector(:focus-visible) {
      :focus {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
      }
    }

    /* Button consistency */
    button {
      font-family: var(--font-ui);
      font-weight: 500;
      border-radius: var(--radius-md);
      transition: background-color 0.15s ease, transform 0.1s ease;
      -webkit-appearance: none; /* Remove iOS button styling */
      appearance: none;
    }

    button:hover:not(:disabled) {
      transform: scale(1.02);
    }

    button:active:not(:disabled) {
      transform: scale(0.98);
    }

    /* Input cross-browser styling */
    input, select {
      -webkit-appearance: none;
      appearance: none;
    }

    /* Preserve native select dropdown arrow */
    select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a0a0a0' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      padding-right: 2rem;
    }

    /* ===========================================
       PHASE 5: TAB NAVIGATION
       =========================================== */

    /* Dashboard wrapper for relative positioning */
    .dashboard {
      position: relative;  /* For absolute positioned radio inputs */
    }

    /* Dashboard header (Phase 7.2: subtle gradient for depth) */
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-lg);
      padding-bottom: var(--spacing-md);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, transparent 100%);
    }

    .dashboard-title {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text);
    }

    .dashboard-subtitle {
      margin: 0.25rem 0 0 0;
      font-size: var(--size-small);
      color: var(--text-muted);
    }

    /* Hide radio buttons but keep accessible */
    .tab-input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    /* Tab navigation bar */
    .tab-nav {
      display: flex;
      gap: 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 1.5rem;
    }

    /* Tab labels as clickable buttons */
    .tab-label {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      color: var(--text-muted);
      font-weight: 500;
      font-size: var(--size-labels);
      transition: border-color 0.2s, color 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .tab-label:hover {
      color: var(--text);
    }

    /* Active tab styling (Phase 7.2: enhanced letter-spacing) */
    #tab-scenarios:checked ~ .tab-nav .tab-label[for="tab-scenarios"],
    #tab-calendar:checked ~ .tab-nav .tab-label[for="tab-calendar"],
    #tab-expenses:checked ~ .tab-nav .tab-label[for="tab-expenses"],
    #tab-invoices:checked ~ .tab-nav .tab-label[for="tab-invoices"],
    #tab-details:checked ~ .tab-nav .tab-label[for="tab-details"],
    #tab-income:checked ~ .tab-nav .tab-label[for="tab-income"],
    #tab-compliance:checked ~ .tab-nav .tab-label[for="tab-compliance"],
    #tab-clients:checked ~ .tab-nav .tab-label[for="tab-clients"] {
      border-bottom-color: var(--accent);
      color: var(--accent);
      letter-spacing: 0.75px;
    }

    /* Hide all tab content by default */
    .tab-panel {
      display: none;
    }

    /* Show content for checked tab */
    #tab-scenarios:checked ~ .tab-panels .panel-scenarios,
    #tab-calendar:checked ~ .tab-panels .panel-calendar,
    #tab-expenses:checked ~ .tab-panels .panel-expenses,
    #tab-invoices:checked ~ .tab-panels .panel-invoices,
    #tab-details:checked ~ .tab-panels .panel-details,
    #tab-income:checked ~ .tab-panels .panel-income,
    #tab-compliance:checked ~ .tab-panels .panel-compliance,
    #tab-clients:checked ~ .tab-panels .panel-clients {
      display: block;
    }

    /* ===========================================
       PHASE 15: CLIENTS TAB STYLES
       =========================================== */

    /* Client List Styles */
    .panel-clients {
      padding: var(--spacing-md);
    }

    .clients-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .clients-header h2 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
    }

    .clients-filters {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      flex-wrap: wrap;
    }

    .clients-filters .search-input {
      flex: 1;
      min-width: 200px;
      padding: 0.5rem 1rem;
      background: var(--bg-surface);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: var(--size-small);
    }

    .clients-filters .search-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .clients-filters .filter-select {
      padding: 0.5rem 2rem 0.5rem 0.75rem;
      background: var(--bg-surface);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: var(--size-small);
    }

    .clients-filters .filter-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      font-size: var(--size-small);
      color: var(--text-muted);
    }

    .clients-filters .filter-checkbox:hover {
      color: var(--text);
    }

    .client-list {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .client-row {
      display: grid;
      grid-template-columns: auto 1fr auto auto auto;
      gap: var(--spacing-md);
      align-items: center;
      padding: var(--spacing-md);
      background: var(--bg-surface);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: border-color 0.2s, background-color 0.2s;
    }

    .client-row:hover {
      border-color: var(--accent);
      background: rgba(255,255,255,0.02);
    }

    .client-flag {
      font-size: 1.5rem;
    }

    .client-name {
      font-weight: 500;
      color: var(--text);
    }

    .client-projects {
      color: var(--text-muted);
      font-size: var(--size-small);
    }

    .client-invoiced {
      font-family: var(--font-mono);
      color: var(--text);
    }

    .client-last-invoice {
      color: var(--text-muted);
      font-size: var(--size-small);
    }

    .clients-empty-state {
      text-align: center;
      padding: var(--spacing-2xl);
      color: var(--text-muted);
    }

    /* Responsive: stack client rows on mobile */
    @media (max-width: 600px) {
      .client-row {
        grid-template-columns: auto 1fr;
        grid-template-rows: auto auto;
      }

      .client-flag {
        grid-row: 1 / 3;
      }

      .client-projects,
      .client-invoiced,
      .client-last-invoice {
        grid-column: 2;
        justify-self: start;
      }

      .clients-filters {
        flex-direction: column;
      }

      .clients-filters .search-input {
        min-width: 100%;
      }
    }

    /* ===========================================
       PHASE 15: CLIENT DETAIL VIEW STYLES
       =========================================== */

    /* Client Detail View */
    .detail-view {
      padding: 1rem;
    }

    .detail-view.hidden {
      display: none;
    }

    .back-btn {
      background: transparent;
      border: none;
      color: var(--accent);
      cursor: pointer;
      padding: 0.5rem 0;
      margin-bottom: 1rem;
      font-size: var(--size-labels);
    }

    .back-btn:hover {
      text-decoration: underline;
    }

    .client-detail-header {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 2rem;
      align-items: start;
      padding: 1.5rem;
      background: var(--bg-surface);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: var(--radius-md);
      margin-bottom: 1rem;
    }

    .client-detail-main {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
    }

    .client-detail-flag {
      font-size: 3rem;
    }

    .client-detail-info h2 {
      margin: 0 0 0.5rem 0;
      font-size: 1.5rem;
    }

    .client-detail-meta {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .tax-id-badge,
    .category-badge,
    .vies-badge {
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-family: var(--font-mono);
    }

    .tax-id-badge {
      background: rgba(255,255,255,0.1);
      color: var(--text-muted);
    }

    .category-badge {
      background: var(--accent);
      color: #1a1a1a;
    }

    .vies-badge.valid {
      background: var(--positive);
      color: #1a1a1a;
    }

    .vies-badge.invalid {
      background: var(--warning);
      color: #1a1a1a;
    }

    .client-detail-summary {
      display: flex;
      gap: 2rem;
    }

    .summary-item {
      text-align: right;
    }

    .summary-label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }

    .summary-value {
      font-family: var(--font-mono);
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text);
    }

    .client-detail-actions {
      display: flex;
      gap: 0.5rem;
    }

    .client-detail-tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 1rem;
    }

    .detail-tab {
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
      font-size: var(--size-labels);
    }

    .detail-tab:hover {
      color: var(--text);
    }

    .detail-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .detail-panel {
      background: var(--bg-surface);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: var(--radius-md);
      padding: 1rem;
    }

    .detail-panel.hidden {
      display: none;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .panel-header h3 {
      margin: 0;
      font-size: 1rem;
    }

    .btn-small {
      padding: 0.25rem 0.75rem;
      font-size: 0.875rem;
    }

    .coming-soon {
      color: var(--text-muted);
      font-style: italic;
      text-align: center;
      padding: 2rem;
    }

    /* Contact list styles */
    .contacts-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .contact-item {
      display: grid;
      grid-template-columns: auto 1fr auto auto;
      gap: 1rem;
      align-items: center;
      padding: 0.75rem;
      background: rgba(255,255,255,0.03);
      border-radius: var(--radius-sm);
    }

    .contact-item.primary {
      border-left: 3px solid var(--accent);
    }

    .contact-role {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      min-width: 100px;
    }

    .contact-name {
      font-weight: 500;
    }

    .contact-details {
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    .contact-details a {
      color: var(--accent);
      text-decoration: none;
    }

    .contact-details a:hover {
      text-decoration: underline;
    }

    /* Project list styles */
    .projects-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .project-item {
      display: grid;
      grid-template-columns: 1fr auto auto auto auto;
      gap: 1rem;
      align-items: center;
      padding: 0.75rem;
      background: rgba(255,255,255,0.03);
      border-radius: var(--radius-sm);
    }

    .project-name {
      font-weight: 500;
    }

    .project-rate {
      font-family: var(--font-mono);
      color: var(--accent);
    }

    .project-dates {
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    .status-badge {
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      text-transform: uppercase;
    }

    .status-badge.active {
      background: var(--positive);
      color: #1a1a1a;
    }

    .status-badge.upcoming {
      background: var(--warning);
      color: #1a1a1a;
    }

    .status-badge.completed {
      background: var(--text-muted);
      color: #1a1a1a;
    }

    .status-badge.cancelled {
      background: var(--negative);
      color: white;
    }

    .empty-state {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }

    .empty-state.hidden {
      display: none;
    }

    /* Icon buttons */
    .btn-icon {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--text-muted);
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 0.875rem;
    }

    .btn-icon:hover {
      background: rgba(255,255,255,0.05);
      color: var(--text);
    }

    .btn-icon.btn-danger:hover {
      background: rgba(248,113,113,0.2);
      color: var(--negative);
    }

    /* Responsive detail view */
    @media (max-width: 768px) {
      .client-detail-header {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .client-detail-summary {
        flex-wrap: wrap;
        gap: 1rem;
      }

      .summary-item {
        text-align: left;
      }

      .client-detail-actions {
        justify-content: flex-end;
      }

      .client-detail-tabs {
        flex-wrap: wrap;
      }

      .detail-tab {
        padding: 0.5rem 1rem;
      }

      .contact-item,
      .project-item {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }
    }

    /* ===========================================
       PHASE 8: INCOME TAB STYLES
       =========================================== */

    /* Income panel styles */
    .panel-income {
      padding: var(--spacing-md);
    }

    .income-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
      flex-wrap: wrap;
      gap: var(--spacing-sm);
    }

    .income-header h2 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
    }

    .income-summary {
      display: flex;
      gap: var(--spacing-md);
      align-items: center;
    }

    .income-total {
      font-weight: 600;
      color: var(--accent);
    }

    .income-count {
      color: var(--text-muted);
      font-size: var(--size-small);
    }

    .income-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
      gap: var(--spacing-md);
      flex-wrap: wrap;
    }

    .income-filters {
      display: flex;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
    }

    .income-filters select,
    .income-filters input {
      padding: 8px 12px;
      background: var(--bg-surface);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: var(--size-small);
    }

    .income-filters input {
      min-width: 200px;
    }

    .income-list {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    /* Income entry card */
    .income-entry {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--bg-surface);
      border-radius: var(--radius-md);
      border: 1px solid rgba(255,255,255,0.06);
      align-items: center;
    }

    .income-entry:hover {
      border-color: rgba(255,255,255,0.12);
    }

    .income-entry-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .income-client {
      font-weight: 600;
      color: var(--text);
    }

    .income-details {
      display: flex;
      gap: var(--spacing-md);
      font-size: var(--size-small);
      color: var(--text-muted);
    }

    .income-amount {
      font-family: var(--font-mono);
      font-size: var(--size-numbers);
      color: var(--accent);
      font-weight: 600;
    }

    .income-actions {
      display: flex;
      gap: var(--spacing-xs);
    }

    .income-actions button {
      padding: 6px 10px;
      font-size: var(--size-small);
      background: transparent;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      cursor: pointer;
    }

    .income-actions button:hover {
      background: rgba(255,255,255,0.05);
      color: var(--text);
    }

    .income-actions .delete-btn:hover {
      border-color: var(--negative);
      color: var(--negative);
    }

    /* Empty state */
    .income-empty {
      text-align: center;
      padding: var(--spacing-2xl);
      color: var(--text-muted);
    }

    /* Income dialog */
    #incomeDialog {
      max-width: 500px;
    }

    #incomeDialog .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-md);
    }

    /* Responsive: stack income entry on mobile */
    @media (max-width: 600px) {
      .income-entry {
        grid-template-columns: 1fr;
        gap: var(--spacing-sm);
      }

      .income-amount {
        text-align: left;
      }

      .income-actions {
        justify-content: flex-start;
      }

      .income-filters input {
        min-width: 150px;
      }

      #incomeDialog .form-row {
        grid-template-columns: 1fr;
      }
    }

    /* ===========================================
       PHASE 7: COMPLIANCE TAB STYLES - COMPACT
       =========================================== */

    /* Compliance panel - reduced padding */
    .panel-compliance {
      padding: var(--spacing-md);
    }

    .panel-compliance h2 {
      margin: 0 0 8px 0;
      font-size: 1rem;
      font-weight: 600;
    }

    /* Compliance sections - minimal spacing */
    .compliance-section {
      margin-bottom: 4px;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: var(--radius-sm);
      overflow: hidden;
    }

    .compliance-section:last-child {
      margin-bottom: 0;
    }

    .compliance-section .section-header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(255,255,255,0.02);
      border: none;
      color: var(--text);
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      text-align: left;
      transition: background 0.15s ease;
    }

    .compliance-section .section-header:hover {
      background: rgba(255,255,255,0.05);
    }

    .compliance-section .section-header[aria-expanded="true"] {
      background: rgba(74, 222, 128, 0.08);
    }

    .compliance-section .section-icon {
      font-size: 0.7rem;
      transition: transform 0.15s ease;
      color: var(--text-muted);
      flex-shrink: 0;
    }

    .compliance-section .section-header[aria-expanded="true"] .section-icon {
      transform: rotate(90deg);
      color: var(--accent);
    }

    /* Compact content area */
    .compliance-section .section-content {
      padding: 10px 12px 12px;
      background: rgba(0,0,0,0.15);
      font-size: 0.85rem;
      line-height: 1.5;
    }

    .compliance-section .section-content[hidden] {
      display: none;
    }

    /* Legal text - compact quote style */
    .legal-text {
      background: rgba(255,255,255,0.02);
      border-left: 2px solid var(--accent);
      padding: 8px 12px;
      margin: 0 0 8px 0;
      font-style: italic;
      font-size: 0.8rem;
      line-height: 1.5;
      color: var(--text-muted);
    }

    /* Plain summary - tighter */
    .plain-summary {
      font-size: 0.85rem;
      line-height: 1.5;
      color: var(--text);
      margin: 0 0 8px 0;
      padding: 0;
    }

    .plain-summary:last-child {
      margin-bottom: 0;
    }

    .plain-summary strong {
      color: var(--accent);
    }

    /* Two-column layout for compliance content on wide screens */
    .compliance-columns {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    @media (min-width: 900px) {
      .compliance-columns {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-md);
      }
    }

    .compliance-col {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    /* Action phase grouping - minimal headers */
    .action-phase {
      margin-bottom: 2px;
    }

    .action-phase h3 {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin: 0 0 4px 0;
      padding: 4px 8px;
      background: rgba(255,255,255,0.02);
      border-radius: 4px;
    }

    .compliance-grid {
      display: grid;
      gap: 8px;
    }

    /* Compact fiscal table */
    .fiscal-table {
      width: 100%;
      border-collapse: collapse;
      margin: 6px 0;
      font-size: 0.8rem;
    }

    .fiscal-table th,
    .fiscal-table td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    .fiscal-table th {
      color: var(--text-muted);
      font-weight: 500;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .fiscal-table td.highlight {
      color: var(--accent);
      font-weight: 600;
    }

    .fiscal-table tbody tr:hover {
      background: rgba(255,255,255,0.03);
    }

    /* Source citation - minimal */
    .panel-compliance .source-citation {
      display: block;
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 6px;
      font-style: normal;
      opacity: 0.7;
    }

    /* Official source links (Phase 8: ENH-03/04/05) */
    .official-source-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--belgium);
      text-decoration: none;
      font-size: var(--size-small);
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      background: rgba(96, 165, 250, 0.1);
      border: 1px solid rgba(96, 165, 250, 0.2);
      transition: all 0.15s ease;
    }

    .official-source-link:hover {
      background: rgba(96, 165, 250, 0.2);
      border-color: var(--belgium);
    }

    /* Inline source citation (within text) */
    .inline-source-link {
      color: var(--belgium);
      text-decoration: none;
      border-bottom: 1px dotted var(--belgium);
    }

    .inline-source-link:hover {
      border-bottom-style: solid;
    }

    /* External link icon */
    .external-link-icon {
      font-size: 0.8em;
      opacity: 0.7;
    }

    .official-source-link:hover .external-link-icon,
    .inline-source-link:hover .external-link-icon {
      opacity: 1;
    }

    /* Sources section in Compliance */
    .sources-section {
      margin-top: var(--spacing-lg);
      padding: var(--spacing-md);
      background: var(--bg-surface);
      border-radius: var(--radius-md);
      border: 1px solid rgba(255,255,255,0.06);
    }

    .sources-section h3 {
      margin: 0 0 var(--spacing-md) 0;
      font-size: 1rem;
      color: var(--text);
    }

    .sources-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: var(--spacing-sm);
    }

    .sources-category {
      margin-bottom: var(--spacing-md);
    }

    .sources-category h4 {
      margin: 0 0 var(--spacing-xs) 0;
      font-size: var(--size-small);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .sources-category-links {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }

    /* Requirements list - compact */
    .requirements-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .requirements-list li {
      padding: 3px 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      display: flex;
      gap: 4px;
      font-size: 0.75rem;
      line-height: 1.3;
    }

    .requirements-list li:last-child {
      border-bottom: none;
    }

    .requirements-list .field-name {
      color: var(--accent);
      flex-shrink: 0;
      font-weight: 500;
      min-width: 120px;
    }

    /* Invalid list - compact */
    .invalid-list {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }

    .invalid-list h5 {
      color: var(--negative);
      margin: 0 0 6px 0;
      font-size: 0.8rem;
    }

    .invalid-list li {
      color: var(--text-muted);
    }

    .invalid-list .invalid-type {
      color: var(--negative);
      font-weight: 500;
    }

    /* Tie-breaker steps - ultra-compact numbered list */
    .tie-breaker-steps {
      list-style: none;
      padding: 0;
      margin: 0;
      counter-reset: step;
    }

    .tie-breaker-steps li {
      padding: 4px 4px 4px 24px;
      margin-bottom: 2px;
      counter-increment: step;
      position: relative;
      font-size: 0.75rem;
      line-height: 1.3;
    }

    .tie-breaker-steps li:last-child {
      margin-bottom: 0;
    }

    .tie-breaker-steps li::before {
      content: counter(step);
      position: absolute;
      left: 0;
      top: 4px;
      width: 16px;
      height: 16px;
      background: var(--accent);
      color: var(--bg);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.65rem;
    }

    .tie-breaker-steps .step-name {
      font-weight: 600;
      color: var(--text);
      display: inline;
      font-size: 0.75rem;
    }

    .tie-breaker-steps .step-name::after {
      content: " - ";
      color: var(--text-muted);
    }

    .tie-breaker-steps .step-plain {
      font-size: 0.75rem;
      color: var(--text-muted);
      display: inline;
    }

    /* Payment warning - compact */
    .payment-warning {
      background: rgba(248, 113, 113, 0.1);
      border-left: 2px solid var(--negative);
      padding: 8px 10px;
      margin-top: 8px;
      border-radius: 0 4px 4px 0;
      font-size: 0.8rem;
    }

    .payment-warning strong {
      color: var(--negative);
    }

    .payment-warning p {
      margin: 4px 0 0 0;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Entry/exit warning - similar to payment warning */
    .entry-exit-warning {
      background: rgba(251, 146, 60, 0.1);
      border-left: 2px solid var(--warning);
      padding: 8px 10px;
      margin-top: 8px;
      border-radius: 0 4px 4px 0;
      font-size: 0.8rem;
    }

    .entry-exit-warning strong {
      color: var(--warning);
    }

    .entry-exit-warning p {
      margin: 4px 0 0 0;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Compliance Warning Banner (COMP-01) */
    .compliance-warning-banner {
      display: none;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
      background: rgba(251, 146, 60, 0.15);
      border: 1px solid var(--warning);
      border-radius: 8px;
      color: var(--text);
    }

    .compliance-warning-banner.visible {
      display: flex;
    }

    .compliance-warning-banner.threshold-170 {
      background: rgba(251, 146, 60, 0.1);
    }

    .compliance-warning-banner.threshold-180 {
      background: rgba(251, 146, 60, 0.15);
    }

    .compliance-warning-banner.threshold-183 {
      background: rgba(248, 113, 113, 0.15);
      border-color: var(--negative);
    }

    .compliance-warning-banner .warning-text {
      font-size: 0.9rem;
      flex: 1;
    }

    .compliance-warning-banner .warning-text strong {
      color: var(--warning);
    }

    .compliance-warning-banner.threshold-183 .warning-text strong {
      color: var(--negative);
    }

    .compliance-warning-banner .dismiss-btn {
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 1.25rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      margin-left: 1rem;
      opacity: 0.7;
    }

    .compliance-warning-banner .dismiss-btn:hover {
      opacity: 1;
    }

    /* Global Disclaimer Footer (COMP-08) */
    .global-disclaimer {
      margin-top: 3rem;
      padding: 1rem;
      background: rgba(255,255,255,0.02);
      border-top: 1px solid rgba(255,255,255,0.1);
      text-align: center;
    }

    .global-disclaimer p {
      font-size: 0.8rem;
      color: var(--text-muted);
      line-height: 1.5;
      max-width: 800px;
      margin: 0 auto;
    }

    /* Entry/Exit Day Warning (COMP-10) */
    .entry-exit-warning {
      background: rgba(251, 146, 60, 0.1);
      border-left: 3px solid var(--warning);
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 0 4px 4px 0;
      font-size: 0.9rem;
    }

    .entry-exit-warning strong {
      color: var(--warning);
    }

    input[type="number"] { padding: 0.5rem; font-size: 1rem; width: 150px; }
    input[type="checkbox"] { width: auto; }
    button { padding: 0.5rem 1rem; cursor: pointer; }
    .result { margin-top: 1rem; font-family: monospace; }
    .breakdown { margin-left: 1rem; font-size: 0.9rem; opacity: 0.8; }
    .input-section {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .input-section label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* What-If Calculator Layout */
    .calculator-header {
      margin-bottom: var(--spacing-lg);
    }

    .calculator-header h2 {
      margin: 0 0 var(--spacing-xs) 0;
      color: var(--accent);
    }

    .calculator-subtitle {
      margin: 0;
      color: var(--text-muted);
      font-size: var(--size-labels);
    }

    .calculator-layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: var(--spacing-xl);
      align-items: start;
    }

    .calculator-inputs {
      position: sticky;
      top: var(--spacing-md);
    }

    .input-section {
      background: var(--bg-surface);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    .input-section-title {
      margin: 0 0 var(--spacing-md) 0;
      font-size: var(--size-labels);
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .input-field {
      margin-bottom: var(--spacing-md);
    }

    .input-field:last-child {
      margin-bottom: 0;
    }

    .input-field label {
      display: block;
      font-size: var(--size-small);
      color: var(--text);
      margin-bottom: var(--spacing-xs);
    }

    .input-with-euro {
      display: flex;
      align-items: center;
      background: var(--bg);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: var(--radius-sm);
      overflow: hidden;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .input-with-euro:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(74, 222, 128, 0.2);
    }

    .input-with-euro input {
      flex: 1;
      padding: var(--spacing-sm) var(--spacing-md);
      background: transparent;
      border: none;
      color: var(--text);
      font-family: var(--font-mono);
      font-size: var(--size-numbers);
      text-align: right;
      min-width: 0;
    }

    .input-with-euro input:focus {
      outline: none;
    }

    .input-unit {
      padding: var(--spacing-sm) var(--spacing-md);
      background: rgba(255,255,255,0.05);
      color: var(--text-muted);
      font-size: var(--size-small);
      white-space: nowrap;
    }

    .input-hint {
      display: block;
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
      opacity: 0.8;
    }

    .checkbox-field label {
      margin-bottom: 0;
    }

    .checkbox-inline {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      cursor: pointer;
    }

    .checkbox-inline input {
      width: 16px;
      height: 16px;
      accent-color: var(--accent);
    }

    /* Advanced Options */
    .advanced-section {
      background: var(--bg-surface);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-md);
    }

    .advanced-toggle {
      padding: var(--spacing-md);
      cursor: pointer;
      font-size: var(--size-small);
      color: var(--text-muted);
      list-style: none;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .advanced-toggle::before {
      content: '>';
      font-family: var(--font-mono);
      transition: transform 0.2s ease;
    }

    .advanced-section[open] .advanced-toggle::before {
      transform: rotate(90deg);
    }

    .advanced-toggle:hover {
      color: var(--accent);
    }

    .advanced-content {
      padding: 0 var(--spacing-md) var(--spacing-md);
      border-top: 1px solid rgba(255,255,255,0.1);
      padding-top: var(--spacing-md);
    }

    .calculator-actions {
      display: flex;
      gap: var(--spacing-sm);
    }

    .calculator-actions button {
      flex: 1;
    }

    .calculator-results {
      min-height: 400px;
    }

    /* Mobile responsive for calculator */
    @media (max-width: 900px) {
      .calculator-layout {
        grid-template-columns: 1fr;
      }

      .calculator-inputs {
        position: static;
      }

      .calculator-actions {
        flex-direction: column;
      }
    }

    /* Results Summary Cards */
    .results-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-xl);
    }

    .summary-card {
      background: var(--bg-surface);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      text-align: center;
    }

    .summary-card.highlight {
      background: rgba(74, 222, 128, 0.1);
      border-color: rgba(74, 222, 128, 0.3);
    }

    .summary-label {
      display: block;
      font-size: var(--size-small);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--spacing-xs);
    }

    .summary-value {
      font-family: var(--font-mono);
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text);
    }

    .summary-value.accent {
      color: var(--accent);
    }

    .summary-value.negative {
      color: var(--negative);
    }

    .summary-unit {
      font-size: 0.75rem;
      font-weight: 400;
      color: var(--text-muted);
      margin-left: 2px;
    }

    /* Results Grid */
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--spacing-lg);
    }

    .results-section {
      background: var(--bg-surface);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
    }

    .results-section-title {
      font-size: var(--size-labels);
      font-weight: 600;
      color: var(--accent);
      margin: 0 0 var(--spacing-md) 0;
      padding-bottom: var(--spacing-sm);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .results-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-xs) 0;
      font-size: var(--size-labels);
    }

    .results-row.total {
      border-top: 1px solid rgba(255,255,255,0.1);
      margin-top: var(--spacing-sm);
      padding-top: var(--spacing-sm);
      font-weight: 600;
    }

    .row-label {
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .row-value {
      font-family: var(--font-mono);
      color: var(--text);
    }

    /* Mobile: stack vertically */
    @media (max-width: 768px) {
      .details-layout {
        grid-template-columns: 1fr;
      }

      .details-sidebar {
        position: static;
      }

      .results-summary {
        grid-template-columns: repeat(2, 1fr);
      }

      .results-grid {
        grid-template-columns: 1fr;
      }
    }
    h2 { color: var(--accent); margin-top: 2rem; }
    h3 { margin-top: 1.5rem; margin-bottom: 0.5rem; opacity: 0.9; }
    hr { border: none; border-top: 1px solid rgba(255,255,255,0.2); margin: 0.5rem 0; }

    /* Source citation button styling (click to open modal) */
    .source-hint-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      margin-left: 4px;
      background: rgba(74, 222, 128, 0.2);
      border: 1px solid var(--accent);
      border-radius: 50%;
      font-size: 11px;
      font-weight: 600;
      color: var(--accent);
      cursor: pointer;
      vertical-align: middle;
      padding: 0;
      transition: background 0.15s ease, transform 0.1s ease;
    }

    .source-hint-btn:hover {
      background: var(--accent);
      color: var(--bg);
      transform: scale(1.1);
    }

    .source-hint-btn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Legacy hover tooltip styling (kept for calendar info) */
    .source-hint {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      margin-left: 4px;
      background: rgba(74, 222, 128, 0.2);
      border: 1px solid var(--accent);
      border-radius: 50%;
      font-size: 10px;
      color: var(--accent);
      cursor: help;
      position: relative;
      vertical-align: middle;
    }

    .source-hint:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #2d2d44;
      border: 1px solid var(--accent);
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      font-size: 11px;
      white-space: normal;
      max-width: 300px;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      margin-bottom: 8px;
    }

    .source-hint:hover::before {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--accent);
      z-index: 101;
    }

    /* Footnotes section */
    .footnotes {
      margin-top: 3rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .footnotes h4 {
      margin-bottom: 1rem;
      color: var(--accent);
    }

    .footnotes ul {
      list-style: none;
      padding: 0;
    }

    .footnotes li {
      margin-bottom: 0.5rem;
    }

    .footnotes a {
      color: var(--accent);
      text-decoration: none;
    }

    .footnotes a:hover {
      text-decoration: underline;
    }

    .confidence-high { color: #4ade80; }
    .confidence-medium { color: #facc15; }

    /* Expense Sections */
    .expenses-container {
      margin-top: 2rem;
    }

    .expense-section {
      margin-bottom: 2rem;
      padding: 1rem;
      border-radius: 8px;
      background: rgba(255,255,255,0.03);
    }

    .expense-section.spain-deductible {
      border-left: 3px solid #4ade80;  /* Green - deductible */
    }

    .expense-section.work-travel {
      border-left: 3px solid #60a5fa;  /* Blue - work travel */
    }

    .expense-section.private {
      border-left: 3px solid #f87171;  /* Red - not deductible */
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .section-title {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-total {
      font-family: 'JetBrains Mono', monospace;
      opacity: 0.8;
    }

    .expense-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .expense-row:last-child {
      border-bottom: none;
    }

    .expense-name {
      font-weight: 500;
      min-width: 150px;
    }

    .expense-formula {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      opacity: 0.7;
      flex: 1;
      text-align: center;
    }

    .expense-value {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      min-width: 200px;
      text-align: right;
    }

    .expense-actions {
      display: flex;
      gap: 0.25rem;
    }

    .delete-btn {
      background: transparent;
      border: 1px solid #f87171;
      color: #f87171;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      padding: 0;
    }

    .delete-btn:hover {
      background: #f87171;
      color: var(--bg);
    }

    /* Add Expense Form */
    .add-expense-btn {
      background: transparent;
      border: 1px dashed rgba(255,255,255,0.3);
      color: var(--text);
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 0.5rem;
      width: 100%;
    }

    .add-expense-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Expense Dialog Modal - use margin:auto for reliable centering */
    .expense-dialog {
      max-width: 400px;
      width: 90%;
      padding: 0;
      border: none;
      border-radius: 12px;
      background: var(--bg-surface);
      color: var(--text);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      /* Dialog centering using margin:auto (works with showModal) */
      margin: auto;
      position: fixed;
      inset: 0;
      height: fit-content;
    }

    .expense-dialog::backdrop {
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
    }

    /* Legacy add-form styles (kept for compatibility) */
    .add-form {
      background: rgba(0,0,0,0.2);
      padding: 1rem;
      border-radius: 4px;
      margin-top: 0.5rem;
    }

    .add-form.hidden {
      display: none;
    }

    .add-form h4 {
      margin: 0 0 1rem 0;
      color: var(--accent);
    }

    .form-row {
      margin-bottom: 0.75rem;
    }

    .form-row label {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.9rem;
    }

    .form-row input,
    .form-row select {
      padding: 0.5rem;
      background: var(--bg);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      color: var(--text);
    }

    .form-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .form-actions button {
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
    }

    .form-actions button:first-child {
      background: var(--accent);
      border: none;
      color: var(--bg);
    }

    .form-actions button:last-child {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.3);
      color: var(--text);
    }

    /* Reset button */
    .reset-btn {
      background: transparent;
      border: 1px solid #f87171;
      color: #f87171;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .reset-btn:hover {
      background: #f87171;
      color: var(--bg);
    }

    /* Detection badge for auto-detected expense categories (ENH-01) */
    .detection-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      border-radius: var(--radius-sm);
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }

    .detection-badge.suggested {
      background: rgba(74, 222, 128, 0.2);
      color: var(--accent);
      border: 1px solid var(--accent);
    }

    .detection-badge.medium {
      background: rgba(251, 146, 60, 0.2);
      color: var(--warning);
      border: 1px solid var(--warning);
    }

    .detection-hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
      font-style: italic;
    }

    .deduction-field-wrapper {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
    }

    .deduction-field-wrapper input {
      flex: 1;
      min-width: 80px;
    }

    /* Scenario Cards Section */
    .scenario-section {
      margin-top: 2rem;
    }

    .scenario-cards {
      display: flex;
      gap: 1rem;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      scroll-padding: 1rem;
      padding: 1rem 0 1.5rem 0;  /* Extra bottom padding for scrollbar clearance */
      -webkit-overflow-scrolling: touch;
      margin-bottom: 0.5rem;
    }

    /* Enhanced scenario cards per UI-02, UI-03, Phase 7.2 polish */
    .scenario-card {
      flex: 0 0 320px;           /* Wider for full breakdown */
      scroll-snap-align: start;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      box-shadow: 0 1px 3px rgba(0,0,0,0.3), 0 4px 12px rgba(0,0,0,0.2);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;           /* Indicate clickable */
    }

    .scenario-card:hover {
      transform: translateY(-6px);  /* Enhanced lift effect */
      box-shadow: 0 8px 24px rgba(74, 222, 128, 0.15), 0 4px 12px rgba(0,0,0,0.3);
    }

    /* Optimal scenario indicator - Bloomberg green highlight */
    .scenario-card.optimal {
      background: rgba(74, 222, 128, 0.08);
      border-color: rgba(74, 222, 128, 0.3);
    }

    .scenario-card.optimal:hover {
      box-shadow:
        0 8px 24px rgba(0,0,0,0.4),
        0 0 0 1px rgba(74, 222, 128, 0.4);  /* Stronger glow for optimal */
    }

    /* Custom scenario visual distinction */
    .scenario-card.custom {
      border-left: 3px solid #60a5fa;
    }

    /* Selected scenario */
    .scenario-card.selected {
      border: 2px solid var(--accent);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .card-header input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    .card-header h3 {
      margin: 0;
      font-size: 1.1rem;
      flex: 1;
    }

    .optimal-badge {
      background: var(--accent);
      color: var(--bg);
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-weight: 600;
    }

    /* Full breakdown metrics per CONTEXT.md */
    .card-metrics {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .metric {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      padding: 0.2rem 0;
    }

    .metric .label {
      color: var(--text-muted);
    }

    .metric .value {
      font-family: var(--font-mono);
      font-size: var(--size-labels);
    }

    /* Divider for metric groups */
    .metric.divider {
      padding: 0;
      margin: 0.4rem 0;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    /* Highlight row (leefgeld) */
    .metric.highlight {
      padding: 0.4rem 0;
      margin-top: 0.4rem;
      border-top: 1px solid rgba(255,255,255,0.15);
    }

    .metric.highlight .value {
      color: var(--accent);
      font-weight: 600;
      font-size: var(--size-numbers);
    }

    /* Color-coded values per UI-07 */
    .value-positive { color: var(--positive); }
    .value-negative { color: var(--negative); }
    .value-warning { color: var(--warning); }

    .edit-btn {
      margin-top: 1rem;
      width: 100%;
      padding: 0.5rem;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text);
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
    }

    .edit-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Scrollbar styling */
    .scenario-cards::-webkit-scrollbar {
      height: 8px;
    }

    .scenario-cards::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
    }

    .scenario-cards::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
    }

    /* Edit Modal Dialog - centered using margin:auto */
    dialog {
      background: var(--bg);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 0;
      max-width: 900px;
      width: 90vw;
      max-height: 90vh;
      /* Dialog centering */
      margin: auto;
      position: fixed;
      inset: 0;
      height: fit-content;
    }

    dialog::backdrop {
      background: rgba(0, 0, 0, 0.7);
      -webkit-backdrop-filter: blur(4px);
      backdrop-filter: blur(4px);
    }

    /* Detail modal for scenario breakdown (UI-04) */
    .detail-dialog {
      background: var(--bg);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 0;
      max-width: 500px;
      width: 90%;
      color: var(--text);
      /* Ensure proper centering */
      margin: auto;
      position: fixed;
      inset: 0;
      height: fit-content;
    }

    .detail-dialog::backdrop {
      background: rgba(0,0,0,0.7);
    }

    .detail-content {
      padding: 1.5rem;
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .detail-title {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
    }

    .detail-header .close-btn {
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 1.5rem;
      cursor: pointer;
      opacity: 0.7;
      padding: 0;
    }

    .detail-header .close-btn:hover {
      opacity: 1;
    }

    .detail-body {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .detail-section {
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      padding: 1rem;
    }

    .detail-section h4 {
      margin: 0 0 0.75rem 0;
      font-size: var(--size-labels);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 0.4rem 0;
      font-size: 0.9rem;
    }

    .detail-row .label {
      color: var(--text-muted);
    }

    .detail-row .value {
      font-family: var(--font-mono);
    }

    .detail-row.total {
      border-top: 1px solid rgba(255,255,255,0.1);
      margin-top: 0.5rem;
      padding-top: 0.75rem;
      font-weight: 600;
    }

    .detail-row.total .value {
      color: var(--accent);
    }

    .detail-footer {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .detail-footer button {
      flex: 1;
    }

    .dialog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .dialog-header h2 {
      margin: 0;
      color: var(--accent);
    }

    .dialog-close {
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      opacity: 0.7;
    }

    .dialog-close:hover {
      opacity: 1;
    }

    .dialog-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      padding: 1.5rem;
      max-height: 60vh;
      overflow-y: auto;
    }

    .input-pane, .results-pane {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .input-pane h3, .results-pane h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
      opacity: 0.8;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 0.5rem;
    }

    .results-pane {
      background: rgba(255,255,255,0.03);
      padding: 1rem;
      border-radius: 8px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .form-group label {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .form-group input,
    .form-group select {
      padding: 0.5rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .checkbox-group {
      flex-direction: row;
      align-items: center;
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    .fiscal-overrides {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .fiscal-overrides summary {
      cursor: pointer;
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .fiscal-overrides[open] summary {
      margin-bottom: 1rem;
    }

    /* Live results display */
    .live-result-row {
      display: flex;
      justify-content: space-between;
      padding: 0.4rem 0;
      font-size: 0.9rem;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .live-result-row:last-child {
      border-bottom: none;
    }

    .live-result-row .label {
      opacity: 0.7;
    }

    .live-result-row .value {
      font-family: 'JetBrains Mono', monospace;
    }

    .live-result-row.highlight {
      padding: 0.6rem 0;
      margin-top: 0.5rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .live-result-row.highlight .value {
      color: var(--accent);
      font-weight: 600;
      font-size: 1rem;
    }

    .dialog-footer {
      display: flex;
      gap: 1rem;
      padding: 1rem 1.5rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .dialog-footer .spacer {
      flex: 1;
    }

    .dialog-footer button {
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .primary-btn {
      background: var(--accent);
      color: var(--bg);
      border: none;
      font-weight: 600;
    }

    .primary-btn:hover {
      opacity: 0.9;
    }

    .secondary-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text);
    }

    .secondary-btn:hover {
      border-color: rgba(255,255,255,0.4);
    }

    .danger-btn {
      background: transparent;
      border: 1px solid #f87171;
      color: #f87171;
    }

    .danger-btn:hover {
      background: #f87171;
      color: var(--bg);
    }

    /* Responsive: stack on mobile */
    @media (max-width: 700px) {
      .dialog-body {
        grid-template-columns: 1fr;
      }
    }

    /* Comparison Table with sticky first column (UI-06) */
    .comparison-container {
      margin-top: 2rem;
      overflow-x: auto;      /* Enable horizontal scroll */
      overflow-y: visible;   /* Let content expand vertically */
      max-width: 100%;
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    /* Horizontal scrollbar for comparison */
    .comparison-container::-webkit-scrollbar {
      height: 8px;
    }

    .comparison-container::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
    }

    .comparison-container::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
    }

    .comparison-container::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.3);
    }

    /* Base table */
    .comparison-table {
      width: max-content;    /* Allow table to exceed container */
      min-width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    /* Sticky header row - z-index: 100 */
    .comparison-table thead th {
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 100;
      border-bottom: 2px solid var(--accent);
      padding: 0.75rem 1rem;
      text-align: right;
      font-weight: 600;
      white-space: nowrap;
    }

    /* Sticky first column (metric names) - z-index: 99 */
    .comparison-table tbody td:first-child,
    .comparison-table thead th:first-child {
      position: sticky;
      left: 0;
      z-index: 99;
      background: var(--bg);
      min-width: 180px;
      text-align: left;
    }

    /* Corner cell (sticky both directions) - z-index: 101 */
    .comparison-table thead th:first-child {
      z-index: 101;
    }

    /* Regular cells */
    .comparison-table tbody td {
      padding: 0.5rem 1rem;
      text-align: right;
      font-family: var(--font-mono);
      border-bottom: 1px solid rgba(255,255,255,0.05);
      white-space: nowrap;
    }

    .comparison-table tbody td:first-child {
      font-family: var(--font-ui);
      color: var(--text-muted);
    }

    /* Divider row */
    .comparison-table tr.divider td {
      padding: 0.25rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.15);
    }

    /* Highlight row (leefgeld) */
    .comparison-table tr.highlight-row td {
      padding: 0.75rem 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
      font-weight: 600;
    }

    /* Optimal value cell */
    .comparison-table td.optimal {
      color: var(--accent);
      font-weight: 700;
    }

    /* Color-coded values in comparison table (UI-07) */
    .comparison-table .value-positive { color: var(--positive); }
    .comparison-table .value-negative { color: var(--negative); }
    .comparison-table .value-warning { color: var(--warning); }

    /* Table row hover state (Phase 7.2) */
    .comparison-table tbody tr:hover {
      background: rgba(255,255,255,0.05);
    }

    /* Empty state */
    .comparison-empty {
      text-align: center;
      padding: 2rem;
      opacity: 0.6;
    }

    .comparison-empty p {
      margin: 0;
    }

    /* New Scenario Button */
    .new-scenario-btn {
      background: transparent;
      border: 2px dashed rgba(255,255,255,0.2);
      color: var(--text);
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      margin-left: 1rem;
      flex-shrink: 0;
      transition: border-color 0.2s, color 0.2s;
    }

    .new-scenario-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Template Selection Dialog */
    #templateSelectDialog {
      max-width: 400px;
    }

    .template-options {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin: 1rem 0;
    }

    .template-option {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .template-option:hover {
      border-color: var(--accent);
    }

    .template-option input[type="radio"] {
      accent-color: var(--accent);
    }

    .template-option .template-info {
      flex: 1;
    }

    .template-option .template-name {
      font-weight: 600;
    }

    .template-option .template-desc {
      font-size: 0.85rem;
      opacity: 0.7;
    }

    /* Calendar Section */
    .calendar-section {
      margin-top: 2rem;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding: 0 0.5rem;
    }

    .calendar-header h3 {
      margin: 0;
      flex: 1;
      text-align: center;
      font-size: 1.2rem;
    }

    .nav-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text);
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      transition: border-color 0.2s, color 0.2s;
    }

    .nav-btn:hover:not(:disabled) {
      border-color: var(--accent);
      color: var(--accent);
    }

    .nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 0.5rem;
    }

    .day-header {
      text-align: center;
      padding: 0.5rem;
      font-size: 0.85rem;
      font-weight: 600;
      opacity: 0.6;
    }

    /* Calendar Toolbar */
    .calendar-toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      background: var(--bg-surface);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-md);
    }

    .toolbar-selection {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .toolbar-label {
      font-size: var(--size-small);
      color: var(--text-muted);
    }

    .toolbar-btn {
      padding: 4px 10px;
      font-size: var(--size-small);
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      cursor: pointer;
    }

    .toolbar-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .toolbar-actions {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
    }

    .toolbar-status-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      font-size: var(--size-small);
      font-weight: 500;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: var(--radius-sm);
      color: var(--text);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .toolbar-status-btn:hover {
      background: rgba(255,255,255,0.1);
    }

    .toolbar-status-btn.belgium:hover {
      border-color: var(--belgium);
      background: rgba(59, 130, 246, 0.15);
    }

    .toolbar-status-btn.spain:hover {
      border-color: var(--positive);
      background: rgba(74, 222, 128, 0.15);
    }

    .toolbar-status-btn.travel:hover {
      border-color: var(--warning);
      background: rgba(251, 146, 60, 0.15);
    }

    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 2px;
    }

    .status-indicator.belgium { background: var(--belgium); }
    .status-indicator.spain { background: var(--positive); }
    .status-indicator.travel { background: var(--warning); }

    /* Day Cell - Checkbox-based selection */
    .day-cell {
      min-height: 60px;
      background: rgba(255,255,255,0.03);
      border: 1px solid transparent;
      border-radius: 4px;
      padding: 6px;
      display: flex;
      flex-direction: column;
      transition: all 0.15s ease;
    }

    .day-cell:hover:not(.empty) {
      background: rgba(255,255,255,0.06);
    }

    .day-cell.empty {
      background: transparent;
    }

    .day-cell.selected {
      border-color: var(--accent);
      background: rgba(74, 222, 128, 0.2) !important;
      border: 2px solid var(--accent) !important;
      box-shadow: 0 0 8px rgba(74, 222, 128, 0.3);
    }

    /* Checkbox checked state enhancement */
    .day-cell.selected .day-checkbox {
      accent-color: var(--accent);
    }

    .day-cell.belgium {
      background: rgba(59, 130, 246, 0.15);
      border-color: rgba(59, 130, 246, 0.3);
    }

    .day-cell.spain {
      background: rgba(74, 222, 128, 0.15);
      border-color: rgba(74, 222, 128, 0.3);
    }

    .day-cell.travel {
      background: rgba(251, 146, 60, 0.15);
      border-color: rgba(251, 146, 60, 0.3);
    }

    .day-cell.selected.belgium,
    .day-cell.selected.spain,
    .day-cell.selected.travel {
      box-shadow: 0 0 0 2px var(--accent);
    }

    .day-cell-header {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .day-checkbox {
      width: 14px;
      height: 14px;
      margin: 0;
      cursor: pointer;
      accent-color: var(--accent);
    }

    .day-number {
      font-size: 0.8rem;
      font-weight: 600;
      flex: 1;
    }

    .contracted-badge {
      font-size: 9px;
      font-weight: 600;
      color: var(--accent);
      opacity: 0.8;
    }

    .day-status-display {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 4px;
      margin-top: 4px;
    }

    .day-status-display:hover {
      background: rgba(255,255,255,0.05);
    }

    .status-emoji {
      font-size: 1.4rem;
    }

    .status-empty {
      font-size: 1rem;
      color: var(--text-muted);
      opacity: 0.3;
    }

    /* Day Picker Dialog Status Options */
    .status-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }

    .status-option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .status-option:hover {
      border-color: var(--accent);
    }

    .status-option input[type="radio"] {
      accent-color: var(--accent);
    }

    /* Visual feedback when option is selected */
    .status-option:has(input:checked) {
      border-color: var(--accent);
      background: rgba(74, 222, 128, 0.15);
      box-shadow: 0 0 0 2px rgba(74, 222, 128, 0.2);
    }

    /* Fallback for browsers without :has() support */
    .status-option input[type="radio"]:checked + .status-emoji-large {
      transform: scale(1.1);
      transition: transform 0.15s ease;
    }

    .status-emoji-large {
      font-size: 1.5rem;
    }

    /* Day Picker Dialog - narrower width */
    #dayPickerDialog {
      max-width: 400px;
    }

    #bulkPickerDialog {
      max-width: 400px;
    }

    /* Selected day cells (for bulk selection) - Enhanced visuals (ENH-06) */
    .day-cell.selected {
      background: rgba(74, 222, 128, 0.2) !important;
      border: 2px solid var(--accent) !important;
      box-shadow: 0 0 8px rgba(74, 222, 128, 0.3);
    }

    /* Selection count badge styling (ENH-06) */
    .selection-count-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--accent);
      color: var(--bg);
      padding: 2px 10px;
      border-radius: 999px;
      font-weight: 700;
      font-size: var(--size-small);
      min-width: 24px;
    }

    /* ===========================================
       CALENDAR MULTI-SELECT ENHANCEMENTS (BUG-05)
       =========================================== */

    /* Selection Indicator Bar */
    /* Calendar Help Tip */
    .calendar-help-tip {
      padding: 10px 14px;
      margin-bottom: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      font-size: var(--size-small);
      color: var(--text-muted);
      line-height: 1.5;
    }

    .calendar-help-tip strong {
      color: var(--accent);
    }

    .calendar-help-tip kbd {
      display: inline-block;
      padding: 2px 6px;
      margin: 0 2px;
      background: var(--bg-surface);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 3px;
      font-family: var(--font-mono);
      font-size: 0.85em;
    }

    .selection-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--accent);
      color: var(--bg);
      font-weight: 600;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .selection-indicator.hidden {
      display: none;
    }

    .selection-indicator .clear-btn {
      padding: 6px 12px;
      background: rgba(0, 0, 0, 0.2);
      border: none;
      border-radius: 4px;
      color: var(--bg);
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .selection-indicator .clear-btn:hover {
      background: rgba(0, 0, 0, 0.3);
    }

    /* Week Selector Button */
    .week-selector {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      padding: 0;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--bg-surface);
      color: var(--text-muted);
      font-size: 0.7rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .week-selector:hover {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }

    /* Month Select All Button */
    .month-select-all {
      padding: 4px 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: transparent;
      color: var(--text-muted);
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      margin-left: 12px;
    }

    .month-select-all:hover {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }

    /* Year Navigation (Phase 16-04) */
    .year-nav {
      display: flex;
      gap: 0.5rem;
    }

    .year-jump-btn {
      padding: 4px 12px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      background: transparent;
      color: var(--text-muted);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .year-jump-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .year-jump-btn.active {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }

    /* Year Summary (Phase 16-04) */
    .year-summary {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.03);
      border-radius: 6px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }

    .year-summary strong {
      color: var(--text);
    }

    .year-summary .threshold-indicator {
      font-family: var(--font-mono);
      font-size: 0.85rem;
    }

    .year-summary .threshold-indicator.warning {
      color: var(--warning);
    }

    .year-summary .threshold-indicator.danger {
      color: var(--negative);
    }

    /* Calendar grid with week selectors - 8 columns */
    .calendar-grid-with-weeks {
      display: grid;
      grid-template-columns: 32px repeat(7, 1fr);
      gap: 2px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 0.5rem;
    }

    .calendar-grid-with-weeks .day-header {
      text-align: center;
      padding: 0.5rem;
      font-size: 0.85rem;
      font-weight: 600;
      opacity: 0.6;
    }

    .calendar-grid-with-weeks .week-selector-cell {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Unsaved changes indicator */
    .unsaved-indicator {
      color: #facc15;
      font-size: 0.9rem;
      align-self: center;
    }
    .unsaved-indicator.hidden { display: none; }

    /* Calendar Stats Display */
    .calendar-stats {
      display: flex;
      gap: 2rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .count-display {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .count-label {
      opacity: 0.7;
    }

    .count-value {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      font-size: 1.1rem;
    }

    /* Warning Badge */
    .warning-badge {
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .warning-badge.yellow { background: #facc15; color: #1a1a2e; }
    .warning-badge.orange { background: #fb923c; color: #1a1a2e; }
    .warning-badge.red { background: #f87171; color: #1a1a2e; }

    /* Warning Banner */
    .warning-banner {
      padding: 0.75rem 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      font-weight: 500;
    }

    .warning-banner.yellow { background: rgba(250, 204, 21, 0.15); border: 1px solid #facc15; color: #facc15; }
    .warning-banner.orange { background: rgba(251, 146, 60, 0.15); border: 1px solid #fb923c; color: #fb923c; }
    .warning-banner.red { background: rgba(248, 113, 113, 0.15); border: 1px solid #f87171; color: #f87171; }

    .warning-banner.hidden, .warning-badge.hidden { display: none; }

    /* Threshold Warning Banner (Phase 16-04) */
    .threshold-banner {
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.9rem;
    }

    .threshold-banner.safe {
      display: none;
    }

    .threshold-banner.caution {
      background: rgba(250, 204, 21, 0.15);
      border: 1px solid rgba(250, 204, 21, 0.3);
      color: #fbbf24;
    }

    .threshold-banner.warning {
      background: rgba(251, 146, 60, 0.15);
      border: 1px solid rgba(251, 146, 60, 0.3);
      color: #f97316;
    }

    .threshold-banner.danger {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }

    .threshold-banner .warning-icon {
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .threshold-banner .warning-message {
      flex: 1;
      font-weight: 500;
    }

    .threshold-banner .warning-count {
      margin-left: auto;
      font-family: var(--font-mono);
      font-size: 0.85rem;
      white-space: nowrap;
    }

    .threshold-banner .warning-count strong {
      font-size: 1rem;
    }

    .threshold-banner .warning-dismiss {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      opacity: 0.7;
      padding: 0.25rem;
      color: inherit;
      line-height: 1;
    }

    .threshold-banner .warning-dismiss:hover {
      opacity: 1;
    }

    /* Export Section */
    .export-section {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .export-buttons {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .export-buttons button {
      display: flex;
      align-items: center;
    }

    /* Phase 16-06: Google Calendar Sync Section */
    .gcal-section {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem 0;
      border-top: 1px solid rgba(255,255,255,0.1);
      margin-top: 1rem;
    }

    .gcal-section h4 {
      width: 100%;
      margin-bottom: 0.25rem;
    }

    .gcal-not-configured {
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .gcal-status {
      color: var(--positive);
      font-size: 0.85rem;
      margin-right: 0.5rem;
    }

    #gcalConnected {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    #gcalConnected .btn-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
    }

    /* Notification Toast */
    .notification {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateY(1rem);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .notification.success {
      background: rgba(74, 222, 128, 0.2);
      border: 1px solid var(--accent);
      color: var(--accent);
    }

    .notification.error {
      background: rgba(248, 113, 113, 0.2);
      border: 1px solid #f87171;
      color: #f87171;
    }

    .notification.hidden {
      display: none;
    }

    /* ===========================================
       PHASE 5/7.1: TOOLTIP MODALS (UI-09, BUG-02)
       =========================================== */

    /* Tooltip trigger - clickable info icon */
    .term-tooltip-trigger {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: inherit;
      text-decoration: none;
      border-bottom: 1px dotted var(--text-muted);
    }

    .term-tooltip-trigger:hover,
    .term-tooltip-trigger:focus {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .term-tooltip-trigger:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      font-size: 10px;
      font-weight: 700;
      color: var(--bg);
      background: var(--accent);
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* Tooltip Modal Dialog - use margin:auto for reliable centering */
    .tooltip-modal {
      max-width: 400px;
      width: 90%;
      padding: 0;
      border: none;
      border-radius: 12px;
      background: var(--bg-surface);
      color: var(--text);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      /* Dialog centering using margin:auto (works with showModal) */
      margin: auto;
      position: fixed;
      inset: 0;
      height: fit-content;
    }

    .tooltip-modal::backdrop {
      background: rgba(0, 0, 0, 0.6);
      -webkit-backdrop-filter: blur(4px);
      backdrop-filter: blur(4px);
    }

    .tooltip-modal-content {
      padding: 24px;
    }

    .tooltip-modal-title {
      margin: 0 0 12px 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--accent);
    }

    .tooltip-modal-text {
      margin: 0 0 20px 0;
      font-size: 0.95rem;
      line-height: 1.6;
      color: var(--text);
    }

    .tooltip-modal-close {
      display: block;
      width: 100%;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      background: var(--accent);
      color: var(--bg);
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .tooltip-modal-close:hover {
      opacity: 0.9;
    }

    .tooltip-modal-close:focus-visible {
      outline: 2px solid var(--text);
      outline-offset: 2px;
    }

    /* Ensure tooltips in cards don't get clipped */
    .scenario-card {
      overflow: visible;
    }

    /* ===========================================
       PHASE 5: PRINT STYLES (UI-10)
       =========================================== */

    /* Export actions bar */
    .export-actions {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      justify-content: flex-end;
    }

    .export-actions button {
      font-size: var(--size-small);
      padding: 0.4rem 0.75rem;
    }

    @media print {
      /* Light theme for printing */
      body {
        background: white !important;
        color: black !important;
        font-size: 11pt;
        padding: 0;
      }

      .container {
        max-width: 100%;
      }

      /* Hide interactive elements */
      .tab-nav,
      .tab-input,
      .edit-btn,
      .delete-btn,
      .add-expense-btn,
      .new-scenario-btn,
      .export-actions,
      .nav-btn,
      .reset-btn,
      button:not(.print-include),
      dialog,
      .calendar-section,
      .panel-calendar,
      .panel-expenses,
      .panel-invoices,
      .panel-details,
      [role="tooltip"] {
        display: none !important;
      }

      /* Show only scenarios panel */
      .tab-panel {
        display: block !important;
      }

      .panel-scenarios {
        display: block !important;
      }

      /* Dashboard header adjustments */
      .dashboard-header {
        border-bottom: 2px solid #333;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
      }

      .dashboard-title {
        color: black;
        font-size: 16pt;
      }

      .dashboard-subtitle {
        color: #666;
      }

      /* Scenario cards in print grid */
      .scenario-cards {
        display: grid !important;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
        overflow: visible !important;
      }

      .scenario-card {
        background: white !important;
        border: 1px solid #ccc !important;
        color: black !important;
        page-break-inside: avoid;
        padding: 0.75rem;
        flex: none !important;
      }

      .scenario-card.optimal {
        border: 2px solid #333 !important;
        background: #f5f5f5 !important;
      }

      .optimal-badge {
        background: #333 !important;
        color: white !important;
      }

      /* Metrics in print */
      .metric .label,
      .metric .value {
        color: black !important;
      }

      .metric.highlight .value {
        color: black !important;
        font-weight: 700;
      }

      /* Comparison table for print */
      .comparison-container {
        overflow: visible !important;
        border: 1px solid #ccc !important;
      }

      .comparison-table {
        width: 100% !important;
      }

      .comparison-table th,
      .comparison-table td {
        position: static !important;
        background: white !important;
        color: black !important;
        border: 1px solid #ddd !important;
        padding: 0.4rem !important;
        font-size: 9pt;
      }

      .comparison-table thead th {
        background: #f0f0f0 !important;
        font-weight: 700;
      }

      .comparison-table td.optimal {
        background: #e8f5e9 !important;
        font-weight: 700;
      }

      /* Color classes in print */
      .value-positive,
      .value-negative,
      .value-warning {
        color: black !important;
      }

      /* Hide mobile comparison on print */
      .comparison-mobile {
        display: none !important;
      }

      /* Page settings */
      @page {
        margin: 1cm;
        size: landscape;
      }
    }

    /* ===========================================
       PHASE 7.2: DESKTOP LAYOUT POLISH
       =========================================== */

    /* Large desktop (1440px+) */
    @media (min-width: 1440px) {
      .container {
        max-width: 1400px;
      }

      /* More comfortable padding on large screens */
      body {
        padding: 2.5rem;
      }

      /* Scenario cards can be wider */
      .scenario-card {
        flex: 0 0 340px;
      }

      /* Comparison table with more padding */
      .comparison-table tbody td,
      .comparison-table thead th {
        padding: 0.75rem 1.25rem;
      }
    }

    /* Extra large desktop (1920px+) */
    @media (min-width: 1920px) {
      .container {
        max-width: 1600px;
      }

      body {
        padding: 3rem;
      }

      /* Dashboard header enhanced */
      .dashboard-title {
        font-size: 1.75rem;
      }

      /* Wider scenario cards on large displays */
      .scenario-card {
        flex: 0 0 360px;
      }

      /* More spacious metrics */
      .metric {
        padding: 0.3rem 0;
        font-size: 0.9rem;
      }

      /* Calendar day cells larger */
      .day-cell {
        min-height: 70px;
      }
    }

    /* Smooth scrolling for horizontal containers */
    .scenario-cards,
    .comparison-container {
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }

    /* Ensure scrollbar is always visible on desktop for horizontal scroll containers */
    @media (min-width: 769px) {
      .scenario-cards::-webkit-scrollbar,
      .comparison-container::-webkit-scrollbar {
        height: 10px;
      }
    }

    /* ===========================================
       PHASE 5: RESPONSIVE DESIGN (UI-08)
       =========================================== */

    /* Mobile comparison blocks (hidden on desktop) */
    .comparison-mobile {
      display: none;
    }

    .comparison-block {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .comparison-block.optimal {
      border-color: var(--accent);
      background: rgba(74, 222, 128, 0.05);
    }

    .block-title {
      margin: 0 0 1rem 0;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .block-metrics {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .block-row {
      display: flex;
      justify-content: space-between;
      padding: 0.4rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .block-row:last-child {
      border-bottom: none;
    }

    .block-row .label {
      color: var(--text-muted);
    }

    .block-row .value {
      font-family: var(--font-mono);
    }

    .block-row.highlight {
      padding-top: 0.6rem;
      margin-top: 0.4rem;
      border-top: 1px solid rgba(255,255,255,0.1);
      border-bottom: none;
    }

    .block-row.highlight .value {
      color: var(--accent);
      font-weight: 600;
    }

    /* Tablet breakpoint */
    @media (max-width: 900px) {
      .container {
        padding: 1rem;
      }

      /* Scrollable tab nav for tablet */
      .tab-nav {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
        position: relative;
      }
      .tab-nav::-webkit-scrollbar {
        display: none;
      }
      .tab-label {
        flex-shrink: 0;
        white-space: nowrap;
      }

      .scenario-cards {
        gap: 0.75rem;
      }

      .scenario-card {
        flex: 0 0 280px;
      }

      .dialog-body {
        grid-template-columns: 1fr;
      }
    }

    /* Medium tablet breakpoint */
    @media (max-width: 768px) {
      /* Reduce container padding */
      body {
        padding: 1rem;
      }

      /* Tab nav adjustments */
      .tab-label {
        padding: 0.6rem 1rem;
        font-size: 0.8rem;
      }

      /* Calendar adjustments for tablet */
      .calendar-stats {
        flex-direction: column;
        gap: 0.75rem;
      }

      /* Expense form full width */
      .add-form {
        padding: 1rem;
      }

      .form-row input,
      .form-row select {
        width: 100%;
        min-height: 44px; /* Touch-friendly size */
      }

      /* Dialog adjustments */
      dialog {
        max-width: 95vw;
        width: 95vw;
      }

      /* Compliance sections */
      .requirements-list li {
        flex-direction: column;
        gap: 0.25rem;
      }

      .requirements-list .field-name {
        min-width: unset;
      }
    }

    /* Mobile breakpoint */
    @media (max-width: 600px) {
      body {
        padding: 0.5rem;
      }

      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .dashboard-title {
        font-size: 1.25rem;
      }

      /* Stack tabs in 2x3 grid on mobile */
      .tab-nav {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0;
        border-bottom: none;
      }

      .tab-label {
        padding: 0.75rem 0.5rem;
        font-size: 0.7rem;
        text-align: center;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        border-right: 1px solid rgba(255,255,255,0.1);
        min-height: 44px; /* Touch-friendly size */
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .tab-label:nth-child(3n) {
        border-right: none;
      }

      .tab-label:nth-child(4),
      .tab-label:nth-child(5) {
        border-bottom: none;
      }

      /* Scenario cards full width */
      .scenario-cards {
        flex-direction: column;
        overflow-x: visible;
        gap: 0.75rem;
      }

      .scenario-card {
        flex: none;
        width: 100%;
        padding: var(--spacing-md);
      }

      .card-header {
        flex-wrap: wrap;
      }

      /* Edit button full width */
      .edit-btn {
        min-height: 44px;
      }

      /* Hide horizontal comparison table on mobile */
      .comparison-container {
        display: none;
      }

      /* Show vertical comparison blocks on mobile */
      .comparison-mobile {
        display: block;
      }

      /* Mobile comparison blocks styling */
      .comparison-block {
        padding: var(--spacing-md);
      }

      .block-row {
        padding: 0.5rem 0;
      }

      .block-row .value {
        font-size: 0.9rem;
      }

      /* Export actions stack */
      .export-actions {
        flex-direction: column;
      }

      .export-actions button {
        width: 100%;
        min-height: 44px;
      }

      /* Calendar adjustments */
      .calendar-header {
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0;
      }

      .calendar-header h3 {
        order: 1;
        width: 100%;
        text-align: center;
        font-size: 1rem;
        margin-bottom: 0.5rem;
      }

      .nav-btn {
        order: 2;
        min-height: 44px;
        min-width: 44px;
        flex: 1;
      }

      .calendar-grid {
        gap: 1px;
        padding: 0.25rem;
      }

      .day-header {
        padding: 0.25rem;
        font-size: 0.7rem;
      }

      .day-cell {
        min-height: 48px; /* Touch-friendly minimum */
        padding: 0.2rem;
        font-size: 0.75rem;
      }

      .day-number {
        font-size: 0.75rem;
      }

      .status-emoji {
        font-size: 1.1rem;
      }

      .contracted-badge {
        font-size: 8px;
        top: 1px;
        right: 2px;
      }

      /* Week selector buttons */
      .week-selector {
        min-width: 24px;
        min-height: 24px;
      }

      /* Selection indicator mobile */
      .selection-indicator {
        flex-wrap: wrap;
        padding: 10px 12px;
        font-size: 0.85rem;
      }

      .selection-indicator .clear-btn {
        min-height: 36px;
        padding: 8px 12px;
      }

      /* Calendar stats mobile */
      .calendar-stats {
        flex-direction: column;
        gap: 0.5rem;
      }

      .count-display {
        flex-wrap: wrap;
        font-size: 0.9rem;
      }

      /* Calendar actions */
      .calendar-actions {
        flex-direction: column-reverse !important;
        align-items: stretch !important;
      }

      .calendar-actions .primary-btn {
        width: 100%;
        min-height: 44px;
      }

      /* Export section mobile */
      .export-section {
        margin-top: 1rem;
      }

      .export-buttons {
        flex-direction: column;
      }

      .export-buttons button {
        width: 100%;
        min-height: 44px;
        justify-content: center;
      }

      /* Phase 16-06: GCal section responsive */
      .gcal-section {
        flex-direction: column;
        align-items: flex-start;
      }

      #gcalConnected {
        flex-direction: column;
        width: 100%;
      }

      #gcalConnected .btn {
        width: 100%;
        min-height: 44px;
      }

      /* Dialog full width on mobile */
      dialog {
        width: 100vw;
        max-width: 100vw;
        max-height: 100vh;
        margin: 0;
        border-radius: 0;
      }

      .dialog-header {
        padding: 1rem;
      }

      .dialog-header h2 {
        font-size: 1.1rem;
      }

      .dialog-body {
        padding: 1rem;
        max-height: calc(100vh - 140px);
      }

      .dialog-footer {
        padding: 1rem;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .dialog-footer button {
        min-height: 44px;
        flex: 1 1 auto;
      }

      .dialog-footer .spacer {
        display: none;
      }

      /* Form groups on mobile */
      .form-group input,
      .form-group select {
        width: 100%;
        min-height: 44px;
        font-size: 16px; /* Prevents zoom on iOS */
      }

      /* Detail dialog mobile */
      .detail-dialog {
        max-width: 100vw;
        width: 100vw;
        max-height: 100vh;
        border-radius: 0;
      }

      .detail-content {
        padding: 1rem;
        max-height: calc(100vh - 60px);
        overflow-y: auto;
      }

      .detail-footer {
        flex-direction: column;
        gap: 0.5rem;
      }

      .detail-footer button {
        min-height: 44px;
      }

      /* Tooltip modal mobile */
      .tooltip-modal {
        max-width: 95vw;
        width: 95vw;
      }

      /* Status options in day picker */
      .status-options {
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
      }

      .status-option {
        padding: 0.6rem;
        min-height: 60px;
        flex-direction: column;
        justify-content: center;
        text-align: center;
      }

      .status-emoji-large {
        font-size: 1.25rem;
      }

      /* Expense sections mobile */
      .expense-section {
        padding: 0.75rem;
      }

      .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .expense-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
        padding: 0.75rem 0;
      }

      .expense-name {
        min-width: unset;
        width: 100%;
      }

      .expense-formula {
        text-align: left;
        font-size: 0.8rem;
      }

      .expense-value {
        min-width: unset;
        text-align: left;
        display: flex;
        justify-content: space-between;
        width: 100%;
        align-items: center;
      }

      .expense-actions {
        margin-left: auto;
      }

      .delete-btn {
        min-width: 36px;
        min-height: 36px;
      }

      /* Add expense button */
      .add-expense-btn {
        min-height: 44px;
      }

      /* Add form mobile */
      .add-form {
        padding: 0.75rem;
      }

      .form-row input,
      .form-row select {
        width: 100%;
        min-height: 44px;
        font-size: 16px; /* Prevents zoom on iOS */
      }

      .form-actions {
        flex-direction: column;
      }

      .form-actions button {
        min-height: 44px;
      }

      /* Reset button */
      .reset-btn {
        min-height: 44px;
        width: 100%;
      }

      /* Compliance tab mobile */
      .compliance-section .section-header {
        padding: 0.75rem;
      }

      .compliance-section .section-content {
        padding: 0 0.75rem 0.75rem;
      }

      .tie-breaker-steps li {
        padding-left: 2.5rem;
        padding: 0.75rem 0.75rem 0.75rem 2.5rem;
      }

      .tie-breaker-steps li::before {
        left: 0.5rem;
        width: 1.25rem;
        height: 1.25rem;
        font-size: 0.75rem;
      }

      /* Global disclaimer mobile */
      .global-disclaimer {
        padding: 0.75rem;
        margin-top: 2rem;
      }

      .global-disclaimer p {
        font-size: 0.75rem;
      }

      /* Template dialog mobile */
      #templateSelectDialog {
        max-width: 100vw;
        width: 100vw;
      }

      .template-option {
        padding: 0.75rem;
        min-height: 60px;
      }

      /* Warning banner mobile */
      .compliance-warning-banner {
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-start;
      }

      .compliance-warning-banner .dismiss-btn {
        align-self: flex-end;
        margin-left: 0;
      }
    }

    /* Extra small mobile (375px - iPhone SE) */
    @media (max-width: 400px) {
      body {
        padding: 0.25rem;
      }

      .dashboard-title {
        font-size: 1.1rem;
      }

      .tab-label {
        font-size: 0.65rem;
        padding: 0.5rem 0.25rem;
      }

      .day-cell {
        min-height: 44px;
      }

      .day-number {
        font-size: 0.7rem;
      }

      .status-emoji {
        font-size: 1rem;
        margin-top: 0.15rem;
      }

      .metric {
        font-size: 0.8rem;
      }

      .metric .value {
        font-size: 0.8rem;
      }
    }

    /* ===========================================
       PHASE 12: LOADING SCREEN
       =========================================== */

    /* Loading Screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .loading-screen.visible {
      opacity: 1;
      visibility: visible;
    }

    .loading-content {
      text-align: center;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--bg-surface);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto var(--spacing-md);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    #loading-status {
      color: var(--text-muted);
      font-size: var(--size-labels);
    }

    #loading-status.error {
      color: var(--negative);
    }

    /* Sync Indicator (Phase 12) */
    .sync-indicator {
      position: fixed;
      top: var(--spacing-md);
      right: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: var(--spacing-xs) var(--spacing-sm);
      background: var(--bg-surface);
      border-radius: var(--radius-md);
      font-size: var(--size-small);
      cursor: pointer;
      z-index: 1000;
      transition: background 0.2s, box-shadow 0.2s;
    }

    .sync-indicator:hover {
      background: var(--bg-elevated);
    }

    .sync-indicator.synced {
      color: var(--positive);
    }

    .sync-indicator.pending {
      color: var(--warning);
    }

    .sync-indicator.alert {
      color: var(--negative);
      box-shadow: 0 0 0 2px var(--negative);
    }

    .sync-indicator.critical {
      color: var(--negative);
      animation: pulse 1s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 2px var(--negative); }
      50% { box-shadow: 0 0 0 4px var(--negative); }
    }

    .sync-icon {
      flex-shrink: 0;
    }

    .sync-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      background: var(--warning);
      color: var(--bg);
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }

    .sync-indicator.alert .sync-badge,
    .sync-indicator.critical .sync-badge {
      background: var(--negative);
    }

    /* ===========================================
       PHASE 13: ENTITY CREATION MODAL
       =========================================== */

    .entity-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
    }

    .entity-modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .entity-modal {
      background: var(--bg-surface, #242424);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-lg, 12px);
      width: 90%;
      max-width: 560px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(-20px);
      transition: transform 0.2s;
    }

    .entity-modal-overlay.active .entity-modal {
      transform: translateY(0);
    }

    .entity-modal__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-lg, 24px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .entity-modal__title {
      font-size: var(--size-header, 20px);
      font-weight: 600;
      color: var(--text, #eaeaea);
      margin: 0;
    }

    .entity-modal__close {
      background: transparent;
      border: none;
      color: var(--text-muted, #a0a0a0);
      font-size: 24px;
      cursor: pointer;
      padding: var(--spacing-xs, 4px);
      line-height: 1;
    }

    .entity-modal__close:hover {
      color: var(--text, #eaeaea);
    }

    .entity-modal__body {
      padding: var(--spacing-lg, 24px);
    }

    .entity-modal__section {
      margin-bottom: var(--spacing-lg, 24px);
    }

    .entity-modal__section-title {
      font-size: var(--size-small, 12px);
      font-weight: 600;
      color: var(--text-muted, #a0a0a0);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--spacing-md, 16px);
    }

    .entity-type-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-md, 16px);
    }

    .entity-type-option {
      padding: var(--spacing-md, 16px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-md, 8px);
      cursor: pointer;
      transition: border-color 0.15s, background-color 0.15s;
      text-align: center;
    }

    .entity-type-option:hover {
      border-color: var(--accent, #4ade80);
      background: rgba(74, 222, 128, 0.1);
    }

    .entity-type-option.selected {
      border-color: var(--accent, #4ade80);
      background: rgba(74, 222, 128, 0.15);
    }

    .entity-type-option__icon {
      font-size: 32px;
      margin-bottom: var(--spacing-sm, 8px);
    }

    .entity-type-option__name {
      font-weight: 600;
      color: var(--text, #eaeaea);
      margin-bottom: var(--spacing-xs, 4px);
    }

    .entity-type-option__desc {
      font-size: var(--size-small, 12px);
      color: var(--text-muted, #a0a0a0);
    }

    .entity-form__group {
      margin-bottom: var(--spacing-md, 16px);
    }

    .entity-form__label {
      display: block;
      font-size: var(--size-small, 12px);
      font-weight: 500;
      color: var(--text-muted, #a0a0a0);
      margin-bottom: 6px;
    }

    .entity-form__label--required::after {
      content: ' *';
      color: var(--negative, #f87171);
    }

    .entity-form__input,
    .entity-form__select {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg, #1a1a1a);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-sm, 4px);
      color: var(--text, #eaeaea);
      font-size: var(--size-labels, 14px);
      font-family: inherit;
      box-sizing: border-box;
    }

    .entity-form__input:focus,
    .entity-form__select:focus {
      outline: none;
      border-color: var(--accent, #4ade80);
    }

    .entity-form__input.invalid {
      border-color: var(--negative, #f87171);
    }

    .entity-form__input.valid {
      border-color: var(--positive, #4ade80);
    }

    .entity-form__error {
      font-size: var(--size-small, 12px);
      color: var(--negative, #f87171);
      margin-top: var(--spacing-xs, 4px);
    }

    .entity-form__hint {
      font-size: var(--size-small, 12px);
      color: var(--text-muted, #a0a0a0);
      margin-top: var(--spacing-xs, 4px);
      opacity: 0.8;
    }

    .entity-form__row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-md, 16px);
    }

    .entity-form__row--3 {
      grid-template-columns: 1fr 1fr 1fr;
    }

    .entity-modal__footer {
      display: flex;
      justify-content: flex-end;
      gap: var(--spacing-md, 16px);
      padding: var(--spacing-md, 16px) var(--spacing-lg, 24px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .entity-modal__btn {
      padding: 10px 20px;
      border-radius: var(--radius-sm, 4px);
      font-size: var(--size-labels, 14px);
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.15s;
    }

    .entity-modal__btn--secondary {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-muted, #a0a0a0);
    }

    .entity-modal__btn--secondary:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text, #eaeaea);
    }

    .entity-modal__btn--primary {
      background: var(--accent, #4ade80);
      border: none;
      color: var(--bg, #1a1a1a);
    }

    .entity-modal__btn--primary:hover {
      background: #3bc972;
    }

    .entity-modal__btn--primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Registro Mercantil fieldset */
    .registro-mercantil-fields {
      background: var(--bg, #1a1a1a);
      border-radius: var(--radius-md, 8px);
      padding: var(--spacing-md, 16px);
      margin-top: var(--spacing-sm, 8px);
    }

    /* Responsive adjustments for entity modal */
    @media (max-width: 600px) {
      .entity-type-selector {
        grid-template-columns: 1fr;
      }

      .entity-form__row,
      .entity-form__row--3 {
        grid-template-columns: 1fr;
      }

      .entity-modal__footer {
        flex-direction: column-reverse;
      }

      .entity-modal__btn {
        width: 100%;
      }
    }

    /* ===========================================
       Entity Switcher (Phase 13-04)
       =========================================== */
    .entity-switcher-container {
      position: relative;
      margin-right: 16px;
    }

    .entity-switcher {
      position: relative;
      font-family: 'DM Sans', sans-serif;
    }

    .entity-switcher__trigger {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg, #1a1a1a);
      border: 1px solid var(--border-color, #3a3a3a);
      border-radius: 6px;
      color: var(--text-primary, #fff);
      cursor: pointer;
      min-width: 200px;
      transition: border-color 0.15s, background-color 0.15s;
      font-family: inherit;
      font-size: 14px;
    }

    .entity-switcher__trigger:hover {
      background: var(--card-bg, #252525);
      border-color: var(--accent, #3b82f6);
    }

    .entity-switcher__trigger:focus {
      outline: 2px solid var(--accent, #3b82f6);
      outline-offset: 2px;
    }

    .entity-switcher__icon {
      font-size: 18px;
      flex-shrink: 0;
    }

    .entity-switcher__name {
      flex: 1;
      text-align: left;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .entity-switcher__type {
      font-size: 11px;
      color: var(--text-secondary, #888);
      background: var(--card-bg, #333);
      padding: 2px 6px;
      border-radius: 4px;
      flex-shrink: 0;
    }

    .entity-switcher__chevron {
      width: 16px;
      height: 16px;
      transition: transform 0.15s;
      flex-shrink: 0;
    }

    .entity-switcher[aria-expanded="true"] .entity-switcher__chevron {
      transform: rotate(180deg);
    }

    .entity-switcher__menu {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 4px;
      padding: 4px 0;
      background: var(--card-bg, #252525);
      border: 1px solid var(--border-color, #3a3a3a);
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      list-style: none;
      max-height: 300px;
      overflow-y: auto;
    }

    .entity-switcher__option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      cursor: pointer;
      transition: background-color 0.1s;
    }

    .entity-switcher__option:hover,
    .entity-switcher__option:focus {
      background: var(--bg, #1a1a1a);
      outline: none;
    }

    .entity-switcher__option--active {
      background: rgba(59, 130, 246, 0.15);
    }

    .entity-switcher__option--action {
      color: var(--accent, #3b82f6);
    }

    .entity-switcher__option-icon {
      font-size: 16px;
      flex-shrink: 0;
    }

    .entity-switcher__option-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .entity-switcher__option-type {
      font-size: 11px;
      color: var(--text-secondary, #888);
      flex-shrink: 0;
    }

    .entity-switcher__check {
      color: var(--positive, #22c55e);
      flex-shrink: 0;
      font-size: 16px;
      font-weight: bold;
      margin-left: 8px;
    }

    .entity-switcher__divider {
      height: 1px;
      margin: 4px 0;
      background: var(--border-color, #3a3a3a);
    }

    .entity-switcher__empty {
      padding: 16px;
      text-align: center;
      color: var(--text-secondary, #888);
      font-size: 13px;
    }

    /* Visually hidden for screen readers */
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* ===========================================
       PHASE 13-05: Dual Activity Warning Banner
       =========================================== */

    .dual-activity-warning {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 16px 20px;
      background: linear-gradient(135deg, rgba(234, 179, 8, 0.15), rgba(234, 179, 8, 0.05));
      border: 1px solid rgba(234, 179, 8, 0.3);
      border-radius: 8px;
      margin: 16px 24px;
    }

    .dual-activity-warning__icon {
      font-size: 24px;
      flex-shrink: 0;
    }

    .dual-activity-warning__content {
      flex: 1;
    }

    .dual-activity-warning__title {
      font-weight: 600;
      color: #eab308;
      margin-bottom: 4px;
    }

    .dual-activity-warning__text {
      font-size: 13px;
      color: var(--text-secondary, #888);
      line-height: 1.5;
      margin-bottom: 8px;
    }

    .dual-activity-warning__entities {
      font-size: 12px;
      color: var(--text-tertiary, #666);
    }

    .dual-activity-warning__entity-count {
      background: rgba(255, 255, 255, 0.05);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .dual-activity-warning__dismiss {
      background: transparent;
      border: none;
      color: var(--text-tertiary, #666);
      font-size: 16px;
      cursor: pointer;
      padding: 4px;
      flex-shrink: 0;
    }

    .dual-activity-warning__dismiss:hover {
      color: var(--text-primary, #fff);
    }

    /* ===========================================
       PHASE 14-03: AUTH SCREEN
       =========================================== */

    /* Auth Screen Styles */
    .auth-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg, #1a1a1a);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .auth-screen.hidden {
      display: none;
    }

    .auth-container {
      background: var(--bg-surface, #242424);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 48px;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }

    .auth-logo {
      font-size: 24px;
      font-weight: 600;
      color: var(--text, #eaeaea);
      margin-bottom: 8px;
    }

    .auth-subtitle {
      color: var(--text-muted, #a0a0a0);
      font-size: 14px;
      margin-bottom: 32px;
    }

    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .auth-input {
      background: var(--bg, #1a1a1a);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 14px 16px;
      font-size: 16px;
      color: var(--text, #eaeaea);
      width: 100%;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }

    .auth-input:focus {
      outline: none;
      border-color: var(--accent, #4ade80);
    }

    .auth-input::placeholder {
      color: var(--text-muted, #a0a0a0);
    }

    .auth-button {
      background: var(--accent, #4ade80);
      color: #1a1a1a;
      border: none;
      border-radius: 8px;
      padding: 14px 24px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
    }

    .auth-button:hover {
      background: #22c55e;
    }

    .auth-button:active {
      transform: scale(0.98);
    }

    .auth-button:disabled {
      background: #4b5563;
      cursor: not-allowed;
    }

    .auth-button.google {
      background: #fff;
      color: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .auth-button.google:hover {
      background: #f3f4f6;
    }

    .auth-button.google svg {
      width: 20px;
      height: 20px;
    }

    .auth-divider {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 8px 0;
      color: var(--text-muted, #a0a0a0);
      font-size: 13px;
    }

    .auth-divider::before,
    .auth-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: rgba(255, 255, 255, 0.1);
    }

    .auth-message {
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      margin-top: 16px;
    }

    .auth-message.success {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .auth-message.error {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .auth-footer {
      margin-top: 24px;
      color: var(--text-muted, #a0a0a0);
      font-size: 12px;
    }

    .auth-link {
      color: var(--accent, #4ade80);
      cursor: pointer;
      text-decoration: none;
      background: none;
      border: none;
      font-size: inherit;
      font-family: inherit;
    }

    .auth-link:hover {
      text-decoration: underline;
    }

    /* Password reset view */
    .auth-container[data-view="reset"] .auth-main-form,
    .auth-container[data-view="main"] .auth-reset-form,
    .auth-container[data-view="new-password"] .auth-main-form,
    .auth-container[data-view="new-password"] .auth-reset-form,
    .auth-container[data-view="main"] .auth-new-password-form,
    .auth-container[data-view="reset"] .auth-new-password-form {
      display: none;
    }

    /* Offline mode notice */
    .auth-offline-notice {
      background: rgba(234, 179, 8, 0.1);
      border: 1px solid rgba(234, 179, 8, 0.2);
      color: #eab308;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 24px;
    }

    /* ===========================================
       PHASE 14-03: USER MENU
       =========================================== */

    .user-menu {
      position: relative;
      margin-left: auto;
    }

    .user-menu-trigger {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-surface, #242424);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: var(--text, #eaeaea);
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    }

    .user-menu-trigger:hover {
      background: var(--bg-elevated, #2d2d44);
    }

    .user-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--accent, #4ade80);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: #1a1a1a;
    }

    .user-menu-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: var(--bg-surface, #242424);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      min-width: 200px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      display: none;
    }

    .user-menu-dropdown.open {
      display: block;
    }

    .user-menu-item {
      padding: 12px 16px;
      color: var(--text, #eaeaea);
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-menu-item:first-child {
      border-radius: 8px 8px 0 0;
    }

    .user-menu-item:last-child {
      border-radius: 0 0 8px 8px;
    }

    .user-menu-item:hover {
      background: var(--bg-elevated, #2d2d44);
    }

    .user-menu-item.danger {
      color: var(--negative, #f87171);
    }

    .user-menu-divider {
      height: 1px;
      background: rgba(255, 255, 255, 0.1);
      margin: 4px 0;
    }

    /* ===========================================
       PHASE 14-03: PROFILE SECTION
       =========================================== */

    .profile-section {
      max-width: 600px;
      margin: 0 auto;
      padding: 24px;
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 32px;
    }

    .profile-avatar-large {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--accent, #4ade80);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: 600;
      color: #1a1a1a;
    }

    .profile-info h2 {
      margin: 0 0 4px 0;
      font-size: 24px;
      color: var(--text, #eaeaea);
    }

    .profile-info p {
      margin: 0;
      color: var(--text-muted, #a0a0a0);
      font-size: 14px;
    }

    .profile-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .profile-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .profile-field label {
      font-size: 13px;
      color: var(--text-muted, #a0a0a0);
      font-weight: 500;
    }

    .profile-field input {
      background: var(--bg, #1a1a1a);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 12px 14px;
      font-size: 15px;
      color: var(--text, #eaeaea);
      transition: border-color 0.2s;
    }

    .profile-field input:focus {
      outline: none;
      border-color: var(--accent, #4ade80);
    }

    .profile-actions {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }

    .profile-save-btn {
      background: var(--accent, #4ade80);
      color: #1a1a1a;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .profile-save-btn:hover {
      background: #22c55e;
    }

    .profile-save-btn:disabled {
      background: #4b5563;
      cursor: not-allowed;
    }

    /* Profile Tab Content */
    .profile-tab-content {
      display: none;
    }

    .profile-tab-content.active {
      display: block;
    }

    /* MFA Modal Styles - Phase 14-04 */
    .mfa-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .mfa-modal.hidden {
      display: none;
    }

    .mfa-content {
      background: var(--bg-secondary, #242424);
      border: 1px solid var(--border-color, #333);
      border-radius: 12px;
      padding: 32px;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }

    .mfa-content h3 {
      margin: 0 0 8px 0;
      font-size: 20px;
      color: var(--text-primary, #fff);
    }

    .mfa-content p {
      color: var(--text-secondary, #888);
      font-size: 14px;
      margin-bottom: 24px;
    }

    .mfa-qr-code {
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: inline-block;
    }

    .mfa-qr-code img,
    .mfa-qr-code svg {
      width: 180px;
      height: 180px;
    }

    .mfa-secret {
      background: var(--bg-primary, #1a1a1a);
      padding: 12px;
      border-radius: 6px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--text-secondary, #888);
      margin-bottom: 20px;
      word-break: break-all;
    }

    .mfa-secret-label {
      font-size: 11px;
      color: var(--text-tertiary, #666);
      margin-bottom: 4px;
    }

    .mfa-code-input {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 20px;
    }

    .mfa-code-input input {
      width: 48px;
      height: 56px;
      text-align: center;
      font-size: 24px;
      font-family: 'JetBrains Mono', monospace;
      background: var(--bg-primary, #1a1a1a);
      border: 1px solid var(--border-color, #333);
      border-radius: 8px;
      color: var(--text-primary, #fff);
    }

    .mfa-code-input input:focus {
      outline: none;
      border-color: var(--accent-color, #3b82f6);
    }

    .mfa-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .mfa-btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .mfa-btn-primary {
      background: var(--accent-color, #3b82f6);
      color: #fff;
      border: none;
    }

    .mfa-btn-primary:hover {
      background: #2563eb;
    }

    .mfa-btn-primary:disabled {
      background: #4b5563;
      cursor: not-allowed;
    }

    .mfa-btn-secondary {
      background: transparent;
      color: var(--text-secondary, #888);
      border: 1px solid var(--border-color, #333);
    }

    .mfa-btn-secondary:hover {
      background: var(--bg-tertiary, #2a2a2a);
    }

    /* Sessions Modal Styles - Phase 14-04 */
    .sessions-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .sessions-modal.hidden {
      display: none;
    }

    .sessions-content {
      background: var(--bg-secondary, #242424);
      border: 1px solid var(--border-color, #333);
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .sessions-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .sessions-header h3 {
      margin: 0;
      font-size: 18px;
      color: var(--text-primary, #fff);
    }

    .sessions-close {
      background: none;
      border: none;
      color: var(--text-secondary, #888);
      cursor: pointer;
      padding: 4px;
      font-size: 20px;
    }

    .sessions-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .session-item {
      background: var(--bg-primary, #1a1a1a);
      border: 1px solid var(--border-color, #333);
      border-radius: 8px;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .session-item.current {
      border-color: var(--accent-color, #3b82f6);
    }

    .session-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .session-device {
      font-size: 14px;
      color: var(--text-primary, #fff);
      font-weight: 500;
    }

    .session-details {
      font-size: 12px;
      color: var(--text-secondary, #888);
    }

    .session-current-badge {
      font-size: 11px;
      background: var(--accent-color, #3b82f6);
      color: #fff;
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: 8px;
    }

    .session-revoke {
      background: transparent;
      border: 1px solid #ef4444;
      color: #ef4444;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .session-revoke:hover {
      background: #ef4444;
      color: #fff;
    }

    .sessions-actions {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color, #333);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .sessions-action-btn {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .sessions-action-btn.danger {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }

    .sessions-action-btn.danger:hover {
      background: rgba(239, 68, 68, 0.2);
    }

    .sessions-empty {
      text-align: center;
      color: var(--text-secondary, #888);
      padding: 32px;
      font-size: 14px;
    }

    /* Invite Modal Styles - Phase 14-05 */
    .invite-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .invite-modal.hidden {
      display: none;
    }

    .invite-content {
      background: var(--bg-secondary, #242424);
      border: 1px solid var(--border-color, #333);
      border-radius: 12px;
      padding: 24px;
      max-width: 480px;
      width: 90%;
    }

    .invite-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .invite-header h3 {
      margin: 0;
      font-size: 18px;
      color: var(--text-primary, #fff);
    }

    .invite-close {
      background: none;
      border: none;
      color: var(--text-secondary, #888);
      cursor: pointer;
      padding: 4px;
      font-size: 20px;
    }

    .invite-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .invite-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .invite-field label {
      font-size: 13px;
      color: var(--text-secondary, #888);
      font-weight: 500;
    }

    .invite-field input,
    .invite-field select {
      background: var(--bg-primary, #1a1a1a);
      border: 1px solid var(--border-color, #333);
      border-radius: 8px;
      padding: 12px 14px;
      font-size: 15px;
      color: var(--text-primary, #fff);
      transition: border-color 0.2s;
    }

    .invite-field input:focus,
    .invite-field select:focus {
      outline: none;
      border-color: var(--accent-color, #3b82f6);
    }

    .invite-field select {
      cursor: pointer;
    }

    .invite-field .help-text {
      font-size: 12px;
      color: var(--text-tertiary, #666);
      margin-top: 4px;
    }

    .invite-submit {
      background: var(--accent-color, #3b82f6);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
      margin-top: 8px;
    }

    .invite-submit:hover {
      background: #2563eb;
    }

    .invite-submit:disabled {
      background: #4b5563;
      cursor: not-allowed;
    }

    /* Invite result (link/code) */
    .invite-result {
      margin-top: 20px;
      padding: 16px;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: 8px;
    }

    .invite-result-title {
      font-size: 14px;
      font-weight: 500;
      color: #22c55e;
      margin-bottom: 12px;
    }

    .invite-result-field {
      margin-bottom: 12px;
    }

    .invite-result-label {
      font-size: 12px;
      color: var(--text-tertiary, #666);
      margin-bottom: 4px;
    }

    .invite-result-value {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .invite-result-value input {
      flex: 1;
      background: var(--bg-primary, #1a1a1a);
      border: 1px solid var(--border-color, #333);
      border-radius: 6px;
      padding: 10px 12px;
      font-size: 13px;
      color: var(--text-primary, #fff);
      font-family: 'JetBrains Mono', monospace;
    }

    .invite-copy-btn {
      background: var(--bg-tertiary, #2a2a2a);
      border: 1px solid var(--border-color, #333);
      border-radius: 6px;
      padding: 10px 14px;
      color: var(--text-primary, #fff);
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
    }

    .invite-copy-btn:hover {
      background: var(--border-color, #333);
    }

    /* Sharing Section Styles - Phase 14-05 */
    .sharing-section {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--border-color, #333);
    }

    .sharing-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .sharing-header h4 {
      margin: 0;
      font-size: 16px;
      color: var(--text-primary, #fff);
    }

    .sharing-invite-btn {
      background: var(--accent-color, #3b82f6);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 13px;
      cursor: pointer;
    }

    .sharing-invite-btn:hover {
      background: #2563eb;
    }

    .sharing-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sharing-item {
      background: var(--bg-primary, #1a1a1a);
      border: 1px solid var(--border-color, #333);
      border-radius: 8px;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sharing-item.pending {
      border-style: dashed;
      opacity: 0.8;
    }

    .sharing-user {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .sharing-user-name {
      font-size: 14px;
      color: var(--text-primary, #fff);
    }

    .sharing-user-email {
      font-size: 12px;
      color: var(--text-secondary, #888);
    }

    .sharing-user-status {
      font-size: 11px;
      color: var(--text-tertiary, #666);
      font-style: italic;
    }

    .sharing-role {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .sharing-role-badge {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 500;
    }

    .sharing-role-badge.owner {
      background: rgba(168, 85, 247, 0.2);
      color: #a855f7;
    }

    .sharing-role-badge.partner {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .sharing-role-badge.accountant {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    .sharing-role-badge.gestor {
      background: rgba(234, 179, 8, 0.2);
      color: #eab308;
    }

    .sharing-revoke {
      background: none;
      border: none;
      color: #ef4444;
      cursor: pointer;
      font-size: 12px;
      padding: 4px 8px;
    }

    .sharing-revoke:hover {
      text-decoration: underline;
    }

    .sharing-empty {
      text-align: center;
      color: var(--text-tertiary, #666);
      padding: 24px;
      font-size: 14px;
    }

    /* Accept Invite Banner - Phase 14-05 */
    .invite-accept-banner {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .invite-accept-banner.hidden {
      display: none;
    }

    .invite-accept-info h4 {
      margin: 0 0 4px 0;
      font-size: 14px;
      color: var(--text-primary, #fff);
    }

    .invite-accept-info p {
      margin: 0;
      font-size: 13px;
      color: var(--text-secondary, #888);
    }

    .invite-accept-actions {
      display: flex;
      gap: 8px;
    }

    .invite-accept-btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .invite-accept-btn.accept {
      background: var(--accent-color, #3b82f6);
      color: #fff;
      border: none;
    }

    .invite-accept-btn.accept:hover {
      background: #2563eb;
    }

    .invite-accept-btn.decline {
      background: transparent;
      color: var(--text-secondary, #888);
      border: 1px solid var(--border-color, #333);
    }

    .invite-accept-btn.decline:hover {
      background: var(--bg-tertiary, #2a2a2a);
    }

    /* Permission UI Styles - Phase 14-06 */
    .permission-disabled {
      opacity: 0.5;
      cursor: not-allowed !important;
    }

    .role-indicator {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: 8px;
    }

    .role-indicator.role-owner {
      background: rgba(168, 85, 247, 0.2);
      color: #a855f7;
    }

    .role-indicator.role-partner {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .role-indicator.role-accountant {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    .role-indicator.role-gestor {
      background: rgba(234, 179, 8, 0.2);
      color: #eab308;
    }

    /* Read-only mode indicator for gestors */
    .read-only-banner {
      background: rgba(234, 179, 8, 0.1);
      border: 1px solid rgba(234, 179, 8, 0.2);
      color: #eab308;
      padding: 8px 16px;
      font-size: 13px;
      text-align: center;
      display: none;
      border-radius: 6px;
      margin-bottom: 16px;
    }

    .read-only-banner.visible {
      display: block;
    }

    /* Role badge in entity switcher items */
    .entity-switcher__option-role {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 8px;
      margin-left: auto;
      margin-right: 8px;
    }

    .entity-switcher__option-role.role-partner {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .entity-switcher__option-role.role-accountant {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    .entity-switcher__option-role.role-gestor {
      background: rgba(234, 179, 8, 0.2);
      color: #eab308;
    }

    /* ===========================================
       PHASE 15: CLIENT FORM MODAL STYLES
       =========================================== */

    /* Client Form Modal */
    .client-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .client-modal.hidden {
      display: none;
    }

    .client-modal-content {
      background: var(--bg-surface);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-lg);
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .client-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-md) var(--spacing-lg);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .client-modal-header h3 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text);
    }

    .client-modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 1.5rem;
      padding: 4px;
      line-height: 1;
    }

    .client-modal-close:hover {
      color: var(--text);
    }

    .client-modal-form {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
      padding: var(--spacing-lg);
    }

    .client-form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-md);
    }

    .client-form-row.full-width {
      grid-template-columns: 1fr;
    }

    .client-form-group {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }

    .client-form-group label {
      font-size: var(--size-small);
      font-weight: 500;
      color: var(--text);
    }

    .client-form-group input,
    .client-form-group select,
    .client-form-group textarea {
      width: 100%;
      padding: 0.5rem 0.75rem;
      background: var(--bg);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: var(--size-labels);
      font-family: var(--font-ui);
    }

    .client-form-group input:focus,
    .client-form-group select:focus,
    .client-form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .client-form-group textarea {
      resize: vertical;
      min-height: 60px;
    }

    .client-form-group .form-help {
      font-size: var(--size-small);
      color: var(--text-muted);
    }

    /* Tax ID input with VIES button */
    .tax-id-input-group {
      display: flex;
      gap: var(--spacing-sm);
    }

    .tax-id-input-group input {
      flex: 1;
    }

    .tax-id-input-group .vies-btn {
      padding: 0.5rem 0.75rem;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      cursor: pointer;
      font-size: var(--size-small);
      white-space: nowrap;
    }

    .tax-id-input-group .vies-btn:hover:not(:disabled) {
      border-color: var(--accent);
      color: var(--accent);
    }

    .tax-id-input-group .vies-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Validation message */
    .validation-message {
      font-size: var(--size-small);
      margin-top: var(--spacing-xs);
    }

    .validation-message.valid {
      color: var(--positive);
    }

    .validation-message.invalid {
      color: var(--negative);
    }

    .validation-message.warning {
      color: var(--warning);
    }

    /* Checkbox label */
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      cursor: pointer;
      font-size: var(--size-labels);
      color: var(--text);
    }

    .checkbox-label input[type="checkbox"] {
      appearance: none;
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      margin: 0;
      border: 2px solid var(--border, #444);
      border-radius: 4px;
      background: transparent;
      cursor: pointer;
      position: relative;
      flex-shrink: 0;
      transition: border-color 0.15s, background-color 0.15s;
    }

    .checkbox-label input[type="checkbox"]:checked {
      border-color: var(--positive, #22c55e);
      background: var(--positive, #22c55e);
    }

    .checkbox-label input[type="checkbox"]:checked::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #000;
      font-size: 14px;
      font-weight: bold;
      line-height: 1;
    }

    .checkbox-label input[type="checkbox"]:focus {
      outline: 2px solid var(--accent, #3b82f6);
      outline-offset: 2px;
    }

    /* Modal actions */
    .client-modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: var(--spacing-sm);
      padding: var(--spacing-md) var(--spacing-lg);
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .client-modal-actions .btn {
      padding: 0.5rem 1rem;
      border-radius: var(--radius-sm);
      font-weight: 500;
      cursor: pointer;
      font-size: var(--size-labels);
    }

    .client-modal-actions .btn-secondary {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--text);
    }

    .client-modal-actions .btn-secondary:hover {
      background: rgba(255,255,255,0.05);
    }

    .client-modal-actions .btn-primary {
      background: var(--accent);
      border: none;
      color: #000;
    }

    .client-modal-actions .btn-primary:hover {
      opacity: 0.9;
    }

    /* Responsive: stack form rows on mobile */
    @media (max-width: 600px) {
      .client-form-row {
        grid-template-columns: 1fr;
      }

      .tax-id-input-group {
        flex-direction: column;
      }
    }

    /* ===========================================
       PHASE 16-02: DAY EDITOR MODAL STYLES
       =========================================== */

    .radio-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.5rem 0.75rem;
      background: var(--bg);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
    }

    .radio-option:hover {
      background: var(--bg-surface);
      border-color: rgba(255,255,255,0.2);
    }

    .radio-option input[type="radio"] {
      margin: 0;
      cursor: pointer;
    }

    .radio-option input[type="radio"]:checked + span {
      color: var(--accent);
      font-weight: 500;
    }

    .day-editor-info-text {
      color: var(--text-muted);
      font-size: var(--size-small);
    }

    .btn-danger {
      background: var(--negative);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 500;
    }

    .btn-danger:hover {
      opacity: 0.9;
    }

    /* Calendar cell client tag and expense badge */
    .day-cell {
      position: relative;
    }

    .day-client {
      font-size: 0.65rem;
      color: var(--text-muted);
      position: absolute;
      bottom: 2px;
      left: 2px;
      max-width: calc(100% - 4px);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .day-expense-badge {
      position: absolute;
      top: 2px;
      right: 2px;
      background: var(--accent);
      color: var(--bg);
      font-size: 0.6rem;
      padding: 0 3px;
      border-radius: 50%;
      min-width: 12px;
      text-align: center;
      font-weight: 600;
    }

    /* Day editor expenses list (Phase 17-05) */
    .day-editor-expenses-list {
      max-height: 150px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .day-expense-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 4px 8px;
      background: rgba(255,255,255,0.03);
      border-radius: var(--radius-sm);
      font-size: 0.78rem;
    }

    .day-expense-item .de-cat {
      font-size: 0.7rem;
      opacity: 0.7;
      min-width: 80px;
    }

    .day-expense-item .de-vendor {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .day-expense-item .de-amount {
      font-family: var(--font-mono);
      font-size: 0.75rem;
      white-space: nowrap;
    }

    .day-expense-item .de-deductible {
      font-family: var(--font-mono);
      font-size: 0.7rem;
      color: var(--accent);
      white-space: nowrap;
    }

    .day-expense-item .de-trip-badge {
      display: inline-block;
      padding: 0 4px;
      border-radius: 4px;
      font-size: 0.6rem;
      font-weight: 600;
      background: rgba(96, 165, 250, 0.15);
      color: #60a5fa;
    }

    .day-editor-expenses-empty {
      font-size: 0.78rem;
      color: var(--text-muted);
      padding: 4px 0;
    }

    /* Deduction indicators (Phase 17-05) */
    .deduction-full {
      color: var(--accent);
    }

    .deduction-partial {
      color: #fbbf24;
    }

    .deduction-pct-badge {
      display: inline-block;
      padding: 0 4px;
      border-radius: 4px;
      font-size: 0.6rem;
      font-weight: 600;
      background: rgba(251, 191, 36, 0.15);
      color: #fbbf24;
      margin-left: 3px;
    }

    .deduction-zero-badge {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 8px;
      font-size: 0.6rem;
      font-weight: 600;
      background: rgba(248, 113, 113, 0.15);
      color: #f87171;
      margin-left: 3px;
    }

    /* Category deduction hint in form (Phase 17-05) */
    .category-deduction-hint {
      font-size: 0.72rem;
      padding: 4px 8px;
      margin-top: 4px;
      border-radius: var(--radius-sm);
      background: rgba(255,255,255,0.03);
      color: var(--text-muted);
      border-left: 2px solid var(--accent);
    }

    /* Deduction summary (Phase 17-05) */
    .deduction-summary {
      margin-top: 1.5rem;
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .deduction-summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.6rem 1rem;
      background: rgba(255,255,255,0.03);
      cursor: pointer;
      user-select: none;
    }

    .deduction-summary-header h4 {
      margin: 0;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .deduction-summary-header .toggle-icon {
      font-size: 0.7rem;
      opacity: 0.5;
      transition: transform 0.2s;
    }

    .deduction-summary.expanded .toggle-icon {
      transform: rotate(180deg);
    }

    .deduction-summary-body {
      display: none;
      padding: 0;
    }

    .deduction-summary.expanded .deduction-summary-body {
      display: block;
    }

    .deduction-summary-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    .deduction-summary-table th {
      padding: 0.4rem 0.75rem;
      text-align: left;
      font-weight: 500;
      color: var(--text-muted);
      border-bottom: 1px solid rgba(255,255,255,0.06);
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .deduction-summary-table th:nth-child(2),
    .deduction-summary-table th:nth-child(3),
    .deduction-summary-table th:nth-child(4) {
      text-align: right;
    }

    .deduction-summary-table td {
      padding: 0.4rem 0.75rem;
      border-bottom: 1px solid rgba(255,255,255,0.03);
    }

    .deduction-summary-table td:nth-child(2),
    .deduction-summary-table td:nth-child(3),
    .deduction-summary-table td:nth-child(4) {
      text-align: right;
      font-family: var(--font-mono);
      font-size: 0.75rem;
    }

    .deduction-summary-table td:nth-child(3) {
      color: var(--accent);
    }

    .deduction-summary-table tr.summary-total-row td {
      font-weight: 700;
      border-top: 2px solid rgba(255,255,255,0.1);
    }

    /* Client detail expenses list (Phase 17-05) */
    .client-expenses-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .client-expense-item,
    .client-invoice-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 10px;
      background: rgba(255,255,255,0.03);
      border-radius: var(--radius-sm);
      font-size: 0.8rem;
    }

    .client-invoice-item:hover {
      background: rgba(255,255,255,0.06);
    }

    .client-expense-item .ce-meta {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex: 1;
      overflow: hidden;
    }

    .client-expense-item .ce-date {
      font-family: var(--font-mono);
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .client-expense-item .ce-vendor {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .client-expense-item .ce-amount {
      font-family: var(--font-mono);
      white-space: nowrap;
      margin-left: 0.5rem;
    }

    .client-expenses-summary {
      display: flex;
      gap: 1.5rem;
      padding: 0.5rem 0;
      margin-bottom: 0.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      font-size: 0.82rem;
    }

    .client-expenses-summary .ces-label {
      color: var(--text-muted);
    }

    .client-expenses-summary .ces-value {
      font-family: var(--font-mono);
      font-weight: 600;
      color: var(--accent);
    }

    /* Bulk tag modal styles */
    .bulk-tag-count {
      font-family: var(--font-mono);
      color: var(--accent);
      font-weight: 600;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
    }

    .checkbox-label input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .form-hint {
      font-size: var(--size-small);
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    /* Phase 16-03: Work Pattern Form Styles */
    .form-fieldset {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
    }

    .form-fieldset legend {
      font-weight: 500;
      padding: 0 0.5rem;
      color: var(--text-secondary);
    }

    .day-checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .day-checkbox-group label {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      font-size: var(--size-small);
      transition: all 0.15s ease;
    }

    .day-checkbox-group label:hover {
      border-color: var(--accent-primary);
    }

    .day-checkbox-group input[type="checkbox"]:checked + span,
    .day-checkbox-group label:has(input:checked) {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: #fff;
    }

    /* Phase 16-03: Pattern Preview Styles */
    .pattern-preview {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
    }

    .pattern-preview .preview-text {
      color: var(--text-muted);
      margin: 0;
      font-size: var(--size-small);
    }

    .pattern-preview .preview-count {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--accent-primary);
      margin-bottom: 0.5rem;
    }

    .pattern-preview .preview-dates {
      font-size: var(--size-small);
      color: var(--text-secondary);
      max-height: 100px;
      overflow-y: auto;
      line-height: 1.5;
    }

    .pattern-preview .preview-warning {
      color: var(--warning-color, #f59e0b);
      font-size: var(--size-small);
      margin-top: 0.5rem;
    }

    /* Phase 17: Expense Form Dialog */
    .expense-form-dialog {
      max-width: 520px;
      width: 92%;
      padding: 0;
      border: none;
      border-radius: 12px;
      background: var(--bg-surface);
      color: var(--text);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      margin: auto;
      position: fixed;
      inset: 0;
      height: fit-content;
      max-height: 90vh;
    }

    .expense-form-dialog::backdrop {
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
    }

    .expense-form-dialog .dialog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .expense-form-dialog .dialog-header h2 {
      margin: 0;
      color: var(--accent);
      font-size: 1.1rem;
    }

    .expense-form-dialog .expense-form-body {
      padding: 1.5rem;
      overflow-y: auto;
      max-height: calc(90vh - 140px);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .expense-form-dialog .form-row-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }

    .expense-form-dialog .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .expense-form-dialog .form-group label {
      font-size: 0.85rem;
      opacity: 0.8;
    }

    .expense-form-dialog .form-group input,
    .expense-form-dialog .form-group select,
    .expense-form-dialog .form-group textarea {
      padding: 0.5rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
    }

    .expense-form-dialog .form-group textarea {
      font-family: 'DM Sans', sans-serif;
      resize: vertical;
    }

    .expense-form-dialog .form-group input:focus,
    .expense-form-dialog .form-group select:focus,
    .expense-form-dialog .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .expense-form-dialog .conditional-fields {
      display: none;
    }

    .expense-form-dialog .conditional-fields.visible {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding: 0.75rem;
      background: rgba(255,255,255,0.02);
      border-radius: 6px;
      border: 1px dashed rgba(255,255,255,0.1);
    }

    .expense-form-dialog .receipt-upload-area {
      padding: 0.75rem;
      background: rgba(255,255,255,0.02);
      border-radius: 6px;
      border: 1px dashed rgba(255,255,255,0.15);
    }

    .expense-form-dialog .receipt-upload-area input[type="file"] {
      font-family: 'DM Sans', sans-serif;
      font-size: 0.85rem;
    }

    .expense-form-dialog .ocr-status {
      display: none;
      margin-top: 0.5rem;
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .expense-form-dialog .ocr-status.scanning {
      display: block;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #93c5fd;
    }

    .expense-form-dialog .ocr-status.success {
      display: block;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #86efac;
    }

    .expense-form-dialog .ocr-status.error {
      display: block;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #fca5a5;
    }

    .expense-form-dialog .ocr-confidence {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .expense-form-dialog .ocr-confidence.high {
      background: rgba(34, 197, 94, 0.2);
      color: #86efac;
    }

    .expense-form-dialog .ocr-confidence.medium {
      background: rgba(245, 158, 11, 0.2);
      color: #fcd34d;
    }

    .expense-form-dialog .ocr-confidence.low {
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
    }

    .expense-form-dialog .ocr-raw-text {
      margin-top: 0.5rem;
    }

    .expense-form-dialog .ocr-raw-text summary {
      cursor: pointer;
      font-size: 0.8rem;
      opacity: 0.6;
    }

    .expense-form-dialog .ocr-raw-text pre {
      font-size: 0.75rem;
      background: rgba(0,0,0,0.3);
      padding: 0.5rem;
      border-radius: 4px;
      max-height: 100px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
      margin-top: 0.25rem;
    }

    .expense-form-dialog .checkbox-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .expense-form-dialog .checkbox-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    .expense-form-dialog .checkbox-row label {
      font-size: 0.85rem;
      opacity: 0.8;
    }

    .expense-form-dialog .dialog-footer {
      display: flex;
      gap: 1rem;
      padding: 1rem 1.5rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .expense-form-dialog .dialog-footer .spacer {
      flex: 1;
    }

    .expense-tracker-section .empty-state {
      font-size: 0.9rem;
      color: var(--text);
    }

    /* ===========================================
       PHASE 17-04: EXPENSE LIST & FILTER STYLES
       =========================================== */

    /* Filter Bar */
    .expense-filters {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .expense-filters .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .expense-filters .filter-group label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }

    .expense-filters .filter-group input,
    .expense-filters .filter-group select {
      padding: 0.4rem 0.6rem;
      background: var(--bg-surface);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: var(--size-small);
      min-width: 120px;
    }

    .expense-filters .filter-group input[type="date"] {
      min-width: 140px;
    }

    .expense-filters .filter-group input:focus,
    .expense-filters .filter-group select:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Summary Bar */
    .expense-summary-bar {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      padding: 0.75rem 1rem;
      background: var(--bg-surface);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: var(--radius-md);
      flex-wrap: wrap;
    }

    .expense-summary-bar .summary-stat {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .expense-summary-bar .summary-stat .stat-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }

    .expense-summary-bar .summary-stat .stat-value {
      font-family: var(--font-mono);
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
    }

    .expense-summary-bar .summary-stat .stat-value.deductible {
      color: var(--accent);
    }

    /* Expense List Table */
    .expense-list-container {
      overflow-x: auto;
      border-radius: var(--radius-md);
      border: 1px solid rgba(255,255,255,0.06);
    }

    .expense-list-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .expense-list-table thead th {
      position: sticky;
      top: 0;
      background: var(--bg-surface);
      z-index: 10;
      border-bottom: 2px solid rgba(255,255,255,0.1);
      padding: 0.6rem 0.75rem;
      text-align: left;
      font-weight: 500;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .expense-list-table thead th.col-amount,
    .expense-list-table thead th.col-deductible {
      text-align: right;
    }

    .expense-list-table thead th.col-actions {
      text-align: center;
      width: 80px;
    }

    .expense-list-table tbody td {
      padding: 0.6rem 0.75rem;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      vertical-align: middle;
    }

    .expense-list-table tbody td.col-amount,
    .expense-list-table tbody td.col-deductible {
      text-align: right;
      font-family: var(--font-mono);
      white-space: nowrap;
    }

    .expense-list-table tbody td.col-deductible {
      color: var(--accent);
    }

    .expense-list-table tbody td.col-date {
      font-family: var(--font-mono);
      font-size: 0.8rem;
      white-space: nowrap;
      color: var(--text-muted);
    }

    .expense-list-table tbody td.col-vendor {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .expense-list-table tbody td.col-client {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    /* Row hover */
    .expense-row:hover {
      background: rgba(255,255,255,0.02);
    }

    /* Category badge */
    .expense-category-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 500;
      background: rgba(74, 222, 128, 0.1);
      color: var(--accent);
      white-space: nowrap;
    }

    /* Billable badge */
    .expense-billable-badge {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 600;
      background: rgba(96, 165, 250, 0.15);
      color: #60a5fa;
      margin-left: 4px;
    }

    /* Phase 17-06: Dietas warnings in expense form */
    .dietas-warnings {
      margin-top: 0.5rem;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }
    .dietas-warnings:empty { display: none; }
    .dietas-warning-item {
      padding: 0.4rem 0.6rem;
      border-radius: var(--radius-sm);
      font-size: 0.78rem;
      line-height: 1.3;
      display: flex;
      align-items: flex-start;
      gap: 0.4rem;
    }
    .dietas-warning-item.level-error {
      background: rgba(248, 113, 113, 0.12);
      border-left: 3px solid #f87171;
      color: #fca5a5;
    }
    .dietas-warning-item.level-warning {
      background: rgba(251, 191, 36, 0.10);
      border-left: 3px solid #fbbf24;
      color: #fde68a;
    }
    .dietas-warning-item.level-info {
      background: rgba(96, 165, 250, 0.08);
      border-left: 3px solid #60a5fa;
      color: #93c5fd;
    }
    .dietas-warning-item .warning-icon {
      flex-shrink: 0;
      font-size: 0.85rem;
      margin-top: 1px;
    }
    .expense-form-dialog select.cash-warning-highlight {
      border-color: rgba(248, 113, 113, 0.5);
      background: rgba(248, 113, 113, 0.06);
    }
    .expense-cash-badge {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 600;
      background: rgba(248, 113, 113, 0.15);
      color: #f87171;
      margin-left: 4px;
    }
    .expense-dietas-warn-icon {
      display: inline-block;
      margin-left: 4px;
      color: #fbbf24;
      cursor: help;
      font-size: 12px;
    }
    .expense-receipt-icon {
      display: inline-block;
      margin-left: 4px;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 12px;
      transition: color 0.15s;
    }
    .expense-receipt-icon:hover { color: var(--accent); }
    .receipt-preview-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    .receipt-preview-modal {
      background: var(--bg-card);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-md);
      padding: 1rem;
      max-width: 500px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .receipt-preview-modal .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .receipt-preview-modal .preview-header h3 {
      margin: 0; font-size: 0.9rem; color: var(--text);
    }
    .receipt-preview-modal .preview-header button {
      background: transparent; border: none; color: var(--text-muted);
      cursor: pointer; font-size: 1.1rem; padding: 2px 6px;
    }
    .receipt-preview-modal .preview-header button:hover { color: var(--text); }
    .receipt-preview-modal .preview-image-container {
      overflow: auto; max-height: 60vh; text-align: center;
    }
    .receipt-preview-modal .preview-image-container img {
      max-width: 100%; border-radius: var(--radius-sm);
    }
    .receipt-preview-modal .preview-footer {
      display: flex; justify-content: flex-end; gap: 0.5rem;
    }
    .receipt-preview-modal .preview-footer button {
      padding: 0.35rem 0.75rem; border-radius: var(--radius-sm);
      font-size: 0.8rem; cursor: pointer;
      border: 1px solid rgba(255,255,255,0.15);
      background: transparent; color: var(--text-muted);
      transition: background 0.15s, color 0.15s;
    }
    .receipt-preview-modal .preview-footer button:hover {
      background: rgba(255,255,255,0.05); color: var(--text);
    }
    .expense-summary-bar .summary-stat .billable-detail {
      font-size: 10px; color: var(--text-muted); opacity: 0.7; margin-top: 1px;
    }
    .expense-archived-toggle {
      display: flex; align-items: center; gap: 0.5rem;
      margin-top: var(--spacing-md); padding: 0.5rem 0;
      border-top: 1px solid rgba(255,255,255,0.06);
      font-size: 0.8rem; color: var(--text-muted); cursor: pointer;
    }
    .expense-archived-toggle:hover { color: var(--text); }
    .expense-archived-list {
      margin-top: 0.5rem;
      border: 1px dashed rgba(255,255,255,0.1);
      border-radius: var(--radius-md);
      padding: 0.75rem;
    }
    .expense-archived-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0.4rem 0; border-bottom: 1px solid rgba(255,255,255,0.04);
      font-size: 0.82rem;
    }
    .expense-archived-item:last-child { border-bottom: none; }
    .expense-archived-item .archived-info {
      display: flex; gap: 0.75rem; color: var(--text-muted);
    }
    .expense-archived-item .restore-btn {
      padding: 2px 8px; font-size: 11px;
      border: 1px solid rgba(74, 222, 128, 0.3);
      border-radius: var(--radius-sm);
      background: transparent; color: var(--accent);
      cursor: pointer; transition: background 0.15s;
    }
    .expense-archived-item .restore-btn:hover {
      background: rgba(74, 222, 128, 0.1);
    }
    .expense-archived-item .restore-btn:disabled {
      opacity: 0.4; cursor: not-allowed;
    }

    /* Actions column */
    .expense-actions {
      display: flex;
      gap: 4px;
      justify-content: center;
    }

    .expense-actions button {
      padding: 3px 8px;
      font-size: 11px;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-sm);
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      transition: background 0.15s, color 0.15s, border-color 0.15s;
    }

    .expense-actions button:hover {
      background: rgba(255,255,255,0.05);
      color: var(--text);
      border-color: rgba(255,255,255,0.2);
    }

    .expense-actions button.archive-btn:hover {
      color: #f87171;
      border-color: rgba(248, 113, 113, 0.3);
    }

    /* Empty state for expense list */
    .expense-list-empty {
      text-align: center;
      padding: var(--spacing-2xl) var(--spacing-md);
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .expense-list-empty .empty-hint {
      font-size: 0.8rem;
      margin-top: 0.5rem;
      opacity: 0.6;
    }

    /* Mobile responsive: card layout */
    @media (max-width: 768px) {
      .expense-filters {
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .expense-filters .filter-group {
        width: 100%;
      }

      .expense-filters .filter-group input,
      .expense-filters .filter-group select {
        width: 100%;
      }

      .expense-list-table {
        display: none;
      }

      .expense-list-cards {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .expense-card {
        background: var(--bg-surface);
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
      }

      .expense-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }

      .expense-card-header .card-vendor {
        font-weight: 500;
        max-width: 60%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .expense-card-header .card-amount {
        font-family: var(--font-mono);
        font-weight: 600;
      }

      .expense-card-meta {
        display: flex;
        gap: var(--spacing-sm);
        flex-wrap: wrap;
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
      }

      .expense-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 0.5rem;
        border-top: 1px solid rgba(255,255,255,0.04);
      }

      .expense-card-footer .card-deductible {
        font-family: var(--font-mono);
        color: var(--accent);
        font-size: 0.85rem;
      }
    }

    /* Desktop: hide card layout */
    @media (min-width: 769px) {
      .expense-list-cards {
        display: none;
      }
    }

    @media (max-width: 600px) {
      .expense-form-dialog {
        width: 98%;
        max-height: 95vh;
      }
      .expense-form-dialog .form-row-grid {
        grid-template-columns: 1fr;
      }
      .expense-form-dialog .expense-form-body {
        max-height: calc(95vh - 140px);
      }
    }

    /* ===========================================
       PHASE 18: INVOICES TAB STYLES
       =========================================== */

    /* Invoice Panel Container */
    .panel-invoices {
      padding: var(--spacing-md);
    }

    /* Overdue Alert Banner */
    .overdue-alert {
      background: rgba(248, 113, 113, 0.12);
      border: 1px solid rgba(248, 113, 113, 0.3);
      border-radius: var(--radius-md);
      padding: var(--spacing-sm) var(--spacing-md);
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      color: var(--negative);
      font-size: 0.9rem;
    }

    .overdue-alert-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--negative);
      color: #fff;
      font-weight: 700;
      font-size: 0.8rem;
      flex-shrink: 0;
    }

    /* Invoice Header */
    .invoices-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .invoices-header h2 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
    }

    /* Invoice Filters */
    .invoices-filters {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .invoices-filters select,
    .invoices-filters input {
      padding: 0.5rem 0.75rem;
      background: var(--bg-surface);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: var(--size-small);
      min-width: 140px;
    }

    .invoices-filters select:focus,
    .invoices-filters input:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Invoice Summary Bar */
    .invoices-summary-bar {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--bg-surface);
      border-radius: var(--radius-md);
      border: 1px solid rgba(255,255,255,0.06);
      flex-wrap: wrap;
    }

    .invoices-summary-bar .summary-item {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      flex: 1;
      min-width: 120px;
    }

    .invoices-summary-bar .summary-label {
      font-size: var(--size-small);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .invoices-summary-bar .summary-value {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .invoices-summary-bar .summary-value.mono {
      font-family: var(--font-mono);
    }

    .invoices-summary-bar .overdue-value {
      color: var(--negative);
    }

    .invoices-summary-bar .paid-value {
      color: var(--positive);
    }

    /* Invoice Table (Desktop) */
    .invoice-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .invoice-table thead th {
      padding: 0.75rem 1rem;
      text-align: left;
      font-weight: 600;
      font-size: var(--size-small);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .invoice-table thead th.text-right {
      text-align: right;
    }

    .invoice-table tbody tr {
      border-bottom: 1px solid rgba(255,255,255,0.04);
      cursor: pointer;
      transition: background 0.15s;
    }

    .invoice-table tbody tr:nth-child(even) {
      background: rgba(255,255,255,0.02);
    }

    .invoice-table tbody tr:hover {
      background: rgba(74, 222, 128, 0.06);
    }

    .invoice-table tbody td {
      padding: 0.75rem 1rem;
      vertical-align: middle;
    }

    .invoice-table tbody td.text-right {
      text-align: right;
    }

    .invoice-table .mono {
      font-family: var(--font-mono);
    }

    /* Invoice Status Badges */
    .invoice-status-badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .badge-draft {
      background: rgba(160, 160, 160, 0.2);
      color: var(--text-muted);
    }

    .badge-sent {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
    }

    .badge-paid {
      background: rgba(74, 222, 128, 0.2);
      color: var(--positive);
    }

    .badge-overdue {
      background: rgba(248, 113, 113, 0.2);
      color: var(--negative);
    }

    .badge-partial {
      background: rgba(251, 146, 60, 0.2);
      color: var(--warning);
    }

    /* Invoice Cards (Mobile) */
    .invoice-cards {
      display: none;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .invoice-card {
      background: var(--bg-surface);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      cursor: pointer;
      transition: background 0.15s;
    }

    .invoice-card:hover {
      background: rgba(74, 222, 128, 0.06);
    }

    .invoice-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .invoice-card-number {
      font-weight: 600;
      font-family: var(--font-mono);
      font-size: 0.9rem;
    }

    .invoice-card-client {
      color: var(--text-muted);
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
    }

    .invoice-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 0.5rem;
      border-top: 1px solid rgba(255,255,255,0.04);
    }

    .invoice-card-total {
      font-family: var(--font-mono);
      font-weight: 600;
      font-size: 1rem;
    }

    .invoice-card-date {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* Invoice Actions */
    .invoice-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .invoice-actions button {
      padding: 0.2rem 0.5rem;
      font-size: 0.8rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.15s;
    }

    .invoice-actions button:hover {
      background: rgba(255,255,255,0.1);
      color: var(--text);
    }

    /* Empty State */
    .panel-invoices .empty-state {
      text-align: center;
      padding: var(--spacing-xl);
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    /* ===========================================
       PHASE 18: INVOICE FORM DIALOG STYLES
       =========================================== */

    .invoice-dialog {
      max-width: 800px;
      width: 92%;
      padding: 0;
      border: none;
      border-radius: 12px;
      background: var(--bg-surface);
      color: var(--text);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      margin: auto;
      position: fixed;
      inset: 0;
      height: fit-content;
      max-height: 90vh;
    }

    .invoice-dialog::backdrop {
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
    }

    .invoice-dialog .dialog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .invoice-dialog .dialog-header h2 {
      margin: 0;
      color: var(--accent);
      font-size: 1.1rem;
    }

    .invoice-dialog .dialog-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      transition: all 0.15s;
    }

    .invoice-dialog .dialog-close:hover {
      color: var(--text);
      background: rgba(255,255,255,0.1);
    }

    .invoice-dialog-body {
      padding: 1.5rem;
      overflow-y: auto;
      max-height: calc(90vh - 60px);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    /* Meta Row (multi-column fields) */
    .invoice-meta-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }

    .invoice-meta-row .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .invoice-meta-row .form-group label {
      font-size: 0.85rem;
      opacity: 0.8;
    }

    .invoice-meta-row .form-group select,
    .invoice-meta-row .form-group input {
      padding: 0.5rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 0.9rem;
    }

    .invoice-meta-row .form-group select:focus,
    .invoice-meta-row .form-group input:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* IVA Treatment Info */
    .iva-treatment-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.25);
      border-radius: var(--radius-sm);
      padding: var(--spacing-sm) var(--spacing-md);
      font-size: 0.85rem;
      color: #60a5fa;
    }

    /* Calendar Populate Section */
    .calendar-populate-section {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm) 0;
    }

    .populate-info {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* Line Items Section */
    .invoice-line-items-section {
      margin-top: 0.5rem;
    }

    .invoice-line-items-section h3 {
      margin: 0 0 0.75rem 0;
      font-size: 1rem;
      font-weight: 600;
    }

    .invoice-line-items-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .invoice-line-items-table thead th {
      padding: 0.5rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .invoice-line-items-table thead th.text-right {
      text-align: right;
    }

    .invoice-line-items-table tbody td {
      padding: 0.4rem 0.5rem;
      vertical-align: middle;
    }

    .invoice-line-items-table tbody td input,
    .invoice-line-items-table tbody td select {
      width: 100%;
      padding: 0.4rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 3px;
      color: var(--text);
      font-size: 0.85rem;
    }

    .invoice-line-items-table tbody td input[type="number"] {
      font-family: var(--font-mono);
      text-align: right;
    }

    .invoice-line-items-table tbody td input:focus,
    .invoice-line-items-table tbody td select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .invoice-line-items-table .line-total {
      font-family: var(--font-mono);
      font-weight: 600;
      text-align: right;
      padding-right: 0.5rem;
    }

    .invoice-line-items-table .remove-line-btn {
      background: none;
      border: none;
      color: var(--negative);
      cursor: pointer;
      font-size: 1rem;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      opacity: 0.6;
      transition: opacity 0.15s;
    }

    .invoice-line-items-table .remove-line-btn:hover {
      opacity: 1;
      background: rgba(248, 113, 113, 0.1);
    }

    .line-items-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: var(--spacing-sm);
    }

    /* Discount Row */
    .invoice-discount-row {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm) 0;
    }

    .invoice-discount-row label {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .invoice-discount-row select,
    .invoice-discount-row input {
      padding: 0.4rem 0.5rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.85rem;
    }

    .invoice-discount-row input[type="number"] {
      width: 100px;
      font-family: var(--font-mono);
      text-align: right;
    }

    .invoice-discount-row select:focus,
    .invoice-discount-row input:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Totals Section */
    .invoice-totals-section {
      margin-left: auto;
      width: 280px;
      padding-top: var(--spacing-sm);
    }

    .totals-row {
      display: flex;
      justify-content: space-between;
      padding: 0.35rem 0;
      font-size: 0.9rem;
    }

    .totals-row .mono {
      font-family: var(--font-mono);
    }

    .totals-row.totals-total {
      border-top: 2px solid rgba(255,255,255,0.15);
      margin-top: 0.25rem;
      padding-top: 0.5rem;
      font-weight: 700;
      font-size: 1.05rem;
    }

    .totals-row.totals-total .mono {
      color: var(--accent);
    }

    /* Notes textarea */
    .invoice-dialog-body .form-group label {
      font-size: 0.85rem;
      opacity: 0.8;
    }

    .invoice-dialog-body .form-group textarea {
      padding: 0.5rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.9rem;
      resize: vertical;
    }

    .invoice-dialog-body .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Dialog Actions */
    .invoice-dialog .dialog-actions {
      display: flex;
      justify-content: flex-end;
      gap: var(--spacing-sm);
      padding-top: var(--spacing-md);
      border-top: 1px solid rgba(255,255,255,0.08);
    }

    .invoice-dialog .dialog-actions .btn {
      padding: 0.5rem 1.25rem;
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      transition: all 0.15s;
    }

    .invoice-dialog .dialog-actions .btn:hover {
      background: rgba(255,255,255,0.1);
    }

    .invoice-dialog .dialog-actions .btn-primary {
      background: var(--accent);
      color: #1a1a1a;
      border-color: var(--accent);
      font-weight: 600;
    }

    .invoice-dialog .dialog-actions .btn-primary:hover {
      opacity: 0.9;
    }

    /* ===========================================
       PHASE 18: INVOICE DETAIL VIEW STYLES
       =========================================== */

    .invoice-detail-view {
      padding: 0;
    }

    .invoice-detail-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      flex-wrap: wrap;
    }

    .invoice-detail-header h2 {
      margin: 0;
      font-family: var(--font-mono);
      font-size: 1.2rem;
    }

    .invoice-detail-actions {
      margin-left: auto;
      display: flex;
      gap: 0.5rem;
    }

    .invoice-detail-meta {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--bg-surface);
      border-radius: var(--radius-md);
      border: 1px solid rgba(255,255,255,0.06);
    }

    .invoice-detail-meta .detail-entity-info,
    .invoice-detail-meta .detail-client-info {
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .invoice-detail-meta .detail-entity-info strong,
    .invoice-detail-meta .detail-client-info strong {
      display: block;
      margin-bottom: 0.25rem;
      font-size: 0.95rem;
    }

    .invoice-detail-info-row {
      display: flex;
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .invoice-detail-info-row strong {
      color: var(--text);
    }

    /* Detail Lines Table */
    .invoice-detail-lines-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: var(--spacing-md);
    }

    .invoice-detail-lines-table thead th {
      padding: 0.6rem 0.75rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.78rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .invoice-detail-lines-table thead th.text-right {
      text-align: right;
    }

    .invoice-detail-lines-table tbody td {
      padding: 0.6rem 0.75rem;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      font-size: 0.9rem;
    }

    .invoice-detail-lines-table tbody td.text-right {
      text-align: right;
      font-family: var(--font-mono);
    }

    /* Detail Totals */
    .invoice-detail-totals {
      margin-left: auto;
      width: 280px;
      margin-bottom: var(--spacing-md);
    }

    .invoice-detail-totals .totals-row {
      display: flex;
      justify-content: space-between;
      padding: 0.35rem 0;
      font-size: 0.9rem;
    }

    .invoice-detail-totals .totals-row .mono {
      font-family: var(--font-mono);
    }

    .invoice-detail-totals .totals-row.totals-total {
      border-top: 2px solid rgba(255,255,255,0.15);
      margin-top: 0.25rem;
      padding-top: 0.5rem;
      font-weight: 700;
      font-size: 1.05rem;
    }

    /* Legal Text */
    .invoice-legal-text {
      background: rgba(59, 130, 246, 0.08);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: var(--radius-sm);
      padding: var(--spacing-sm) var(--spacing-md);
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: var(--spacing-md);
      font-style: italic;
    }

    /* Rectificativa Reference */
    .rectificativa-ref {
      background: rgba(251, 146, 60, 0.08);
      border: 1px solid rgba(251, 146, 60, 0.2);
      border-radius: var(--radius-sm);
      padding: var(--spacing-sm) var(--spacing-md);
      font-size: 0.85rem;
      color: var(--warning);
      margin-bottom: var(--spacing-md);
    }

    .rect-original-ref {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: var(--spacing-md);
    }

    /* Payment Section */
    .payment-section {
      margin-top: var(--spacing-md);
      padding-top: var(--spacing-md);
      border-top: 1px solid rgba(255,255,255,0.08);
    }

    .payment-section h3 {
      margin: 0 0 var(--spacing-sm) 0;
      font-size: 1rem;
      font-weight: 600;
    }

    .payment-section h4 {
      margin: var(--spacing-sm) 0;
      font-size: 0.9rem;
      font-weight: 500;
    }

    #payment-history {
      margin-bottom: var(--spacing-md);
    }

    .payment-record {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-sm) 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      font-size: 0.85rem;
    }

    .payment-record .payment-amount {
      font-family: var(--font-mono);
      font-weight: 600;
      color: var(--positive);
    }

    .payment-record .payment-date {
      color: var(--text-muted);
    }

    .payment-record .payment-method {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .payment-form {
      display: flex;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .payment-form input,
    .payment-form select {
      padding: 0.4rem 0.5rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.85rem;
    }

    .payment-form input[type="number"] {
      width: 130px;
      font-family: var(--font-mono);
    }

    .payment-form input[type="text"] {
      width: 150px;
    }

    .payment-form input:focus,
    .payment-form select:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Invoice Notes (detail view) */
    .invoice-notes {
      background: rgba(255,255,255,0.03);
      border-radius: var(--radius-sm);
      padding: var(--spacing-md);
      font-size: 0.85rem;
      color: var(--text-muted);
      white-space: pre-wrap;
      margin-top: var(--spacing-md);
    }

    /* Calendar Populate Preview */
    .calendar-pop-preview {
      margin-top: var(--spacing-sm);
      padding: var(--spacing-sm);
      background: rgba(255,255,255,0.03);
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
      color: var(--text-muted);
      min-height: 2rem;
    }

    /* ===========================================
       PHASE 18: INVOICE MOBILE RESPONSIVE
       =========================================== */

    @media (max-width: 768px) {
      .invoice-table {
        display: none;
      }

      .invoice-cards {
        display: flex;
      }

      .invoices-filters {
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .invoices-filters select,
      .invoices-filters input {
        width: 100%;
        min-width: unset;
      }

      .invoices-summary-bar {
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .invoices-summary-bar .summary-item {
        flex-direction: row;
        justify-content: space-between;
        min-width: unset;
      }

      .invoice-meta-row {
        grid-template-columns: 1fr;
      }

      .invoice-dialog {
        width: 98%;
        max-height: 95vh;
      }

      .invoice-dialog-body {
        max-height: calc(95vh - 60px);
      }

      .invoice-totals-section {
        width: 100%;
      }

      .invoice-detail-meta {
        grid-template-columns: 1fr;
      }

      .invoice-detail-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .invoice-detail-actions {
        margin-left: 0;
      }

      .invoice-detail-info-row {
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .invoice-detail-totals {
        width: 100%;
      }

      .payment-form {
        flex-direction: column;
      }

      .payment-form input,
      .payment-form select {
        width: 100%;
      }

      .payment-form input[type="number"],
      .payment-form input[type="text"] {
        width: 100%;
      }

      .invoice-line-items-table {
        font-size: 0.75rem;
      }

      .invoice-line-items-table thead th {
        font-size: 0.65rem;
        padding: 0.3rem;
      }

      .invoice-line-items-table tbody td {
        padding: 0.3rem;
      }

      .invoice-line-items-table tbody td input,
      .invoice-line-items-table tbody td select {
        padding: 0.3rem;
        font-size: 0.8rem;
      }
    }

    /* Desktop: hide card layout for invoices */
    @media (min-width: 769px) {
      .invoice-cards {
        display: none;
      }
    }

    /* Toast notifications */
    #toast-container {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      z-index: 10000;
      display: flex;
      flex-direction: column-reverse;
      gap: 0.5rem;
      pointer-events: none;
    }
    .toast {
      pointer-events: auto;
      min-width: 280px;
      max-width: 420px;
      padding: 0.85rem 1.25rem;
      border-radius: 8px;
      font-size: 0.9rem;
      line-height: 1.4;
      color: #fff;
      background: var(--card-bg, #1e1e2e);
      border-left: 4px solid;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      cursor: pointer;
      opacity: 0;
      transform: translateX(100%);
      animation: toast-in 0.3s ease forwards;
    }
    .toast.toast-out {
      animation: toast-out 0.3s ease forwards;
    }
    .toast-success { border-color: var(--accent, #4ade80); }
    .toast-error { border-color: #ef4444; }
    .toast-warning { border-color: #f59e0b; }
    .toast-info { border-color: #3b82f6; }
    @keyframes toast-in {
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes toast-out {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(100%); }
    }
  </style>

  <!-- Phase 12: Dexie.js v4.x for IndexedDB -->
  <script src="https://unpkg.com/dexie@4/dist/dexie.min.js"></script>

  <!-- Phase 12: currency.js for money handling -->
  <script src="https://unpkg.com/currency.js@2.0.4/dist/currency.min.js"></script>

  <!-- Phase 14: Supabase client for authentication -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Phase 16-06: Google Identity Services for OAuth -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Phase 16-06: Google API Client for Calendar API -->
  <script src="https://apis.google.com/js/api.js" async defer></script>
</head>
<body>
  <!-- Phase 14-03: Auth Screen -->
  <div id="auth-screen" class="auth-screen">
    <div class="auth-container" data-view="main">
      <div class="auth-logo">Autonomo Dashboard</div>
      <div class="auth-subtitle">Business Management for Spanish SMEs</div>

      <!-- Offline mode notice (shown when Supabase not configured) -->
      <div id="auth-offline-notice" class="auth-offline-notice" style="display: none;">
        Running in offline mode. Authentication disabled.<br>
        <button class="auth-link" onclick="AuthUI.continueOffline()">Continue without sign in</button>
      </div>

      <!-- Main login form -->
      <form class="auth-form auth-main-form" onsubmit="AuthUI.handleMagicLink(event)">
        <input
          type="email"
          class="auth-input"
          id="auth-email"
          placeholder="Enter your email"
          required
          autocomplete="email"
        >
        <button type="submit" class="auth-button" id="auth-submit-btn">
          Continue with Email
        </button>

        <div class="auth-divider">or</div>

        <button type="button" class="auth-button google" onclick="AuthUI.handleGoogle()">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          Continue with Google
        </button>

        <div id="auth-message" class="auth-message" style="display: none;"></div>
      </form>

      <!-- Demo mode button (outside form) -->
      <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color, #333);">
        <p style="color: var(--text-muted, #888); font-size: 12px; text-align: center; margin-bottom: 12px;">
          For testing without authentication:
        </p>
        <button type="button" id="demo-mode-btn" style="width: 100%; padding: 12px 16px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border: none; border-radius: 8px; color: white; font-size: 14px; font-weight: 500; cursor: pointer;">
           Enter Demo Mode
        </button>
      </div>

      <!-- Password reset form -->
      <form class="auth-form auth-reset-form" onsubmit="AuthUI.handlePasswordReset(event)">
        <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 16px;">
          Enter your email to receive a password reset link.
        </p>
        <input
          type="email"
          class="auth-input"
          id="auth-reset-email"
          placeholder="Enter your email"
          required
          autocomplete="email"
        >
        <button type="submit" class="auth-button">
          Send Reset Link
        </button>
        <button type="button" class="auth-link" onclick="AuthUI.showView('main')" style="margin-top: 8px;">
          Back to sign in
        </button>
        <div id="auth-reset-message" class="auth-message" style="display: none;"></div>
      </form>

      <!-- New password form (after clicking reset link) -->
      <form class="auth-form auth-new-password-form" onsubmit="AuthUI.handleNewPassword(event)">
        <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 16px;">
          Enter your new password.
        </p>
        <input
          type="password"
          class="auth-input"
          id="auth-new-password"
          placeholder="New password"
          required
          minlength="8"
          autocomplete="new-password"
        >
        <input
          type="password"
          class="auth-input"
          id="auth-confirm-password"
          placeholder="Confirm password"
          required
          minlength="8"
          autocomplete="new-password"
        >
        <button type="submit" class="auth-button">
          Update Password
        </button>
        <div id="auth-password-message" class="auth-message" style="display: none;"></div>
      </form>

      <div class="auth-footer">
        <span class="auth-link" onclick="AuthUI.showView('reset')">Forgot password?</span>
      </div>
    </div>
  </div>

  <!-- Phase 14-04: MFA Challenge Modal (shown during login when 2FA required) -->
  <div id="mfa-challenge-modal" class="mfa-modal hidden">
    <div class="mfa-content">
      <h3>Two-Factor Authentication</h3>
      <p>Enter the 6-digit code from your authenticator app.</p>

      <div class="mfa-code-input" id="mfa-challenge-code">
        <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="0">
        <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="1">
        <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="2">
        <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="3">
        <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="4">
        <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="5">
      </div>

      <div id="mfa-challenge-message" class="auth-message" style="display: none;"></div>

      <div class="mfa-actions">
        <button class="mfa-btn mfa-btn-primary" onclick="MFAUI.verifyChallenge()">
          Verify
        </button>
        <button class="mfa-btn mfa-btn-secondary" onclick="MFAUI.cancelChallenge()">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Phase 14-04: MFA Enrollment Modal -->
  <div id="mfa-enroll-modal" class="mfa-modal hidden">
    <div class="mfa-content">
      <h3>Set Up Two-Factor Authentication</h3>
      <p>Scan this QR code with your authenticator app (Google Authenticator, Authy, etc.)</p>

      <div class="mfa-qr-code" id="mfa-qr-container">
        <!-- QR code will be inserted here -->
      </div>

      <div class="mfa-secret-label">Or enter this code manually:</div>
      <div class="mfa-secret" id="mfa-secret-code">Loading...</div>

      <p style="margin-top: 20px;">Enter the 6-digit code to verify:</p>

      <div class="mfa-code-input" id="mfa-enroll-code">
        <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="0">
        <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="1">
        <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="2">
        <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="3">
        <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="4">
        <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="5">
      </div>

      <div id="mfa-enroll-message" class="auth-message" style="display: none;"></div>

      <div class="mfa-actions">
        <button class="mfa-btn mfa-btn-primary" onclick="MFAUI.completeEnrollment()">
          Enable 2FA
        </button>
        <button class="mfa-btn mfa-btn-secondary" onclick="MFAUI.cancelEnrollment()">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Phase 14-04: Sessions Modal (AUTH-06) -->
  <div id="sessions-modal" class="sessions-modal hidden">
    <div class="sessions-content">
      <div class="sessions-header">
        <h3>Active Sessions</h3>
        <button class="sessions-close" onclick="SessionsUI.close()">&times;</button>
      </div>

      <div id="sessions-list" class="sessions-list">
        <!-- Sessions will be populated dynamically -->
      </div>

      <div class="sessions-actions">
        <button class="sessions-action-btn danger" onclick="SessionsUI.signOutOthers()">
          Sign out all other devices
        </button>
      </div>
    </div>
  </div>

  <!-- Phase 14-05: Invite User Modal (PERM-01, PERM-02) -->
  <div id="invite-modal" class="invite-modal hidden">
    <div class="invite-content">
      <div class="invite-header">
        <h3>Invite User to Entity</h3>
        <button class="invite-close" onclick="InviteUI.closeModal()">&times;</button>
      </div>

      <form class="invite-form" id="invite-form" onsubmit="InviteUI.create(event)">
        <div class="invite-field">
          <label for="invite-email">Email Address (optional)</label>
          <input type="email" id="invite-email" placeholder="user@example.com">
          <div class="help-text">Leave empty to generate a shareable link only</div>
        </div>

        <div class="invite-field">
          <label for="invite-role">Role</label>
          <select id="invite-role" required>
            <option value="gestor">Gestor (View Only)</option>
            <option value="accountant">Accountant (View &amp; Edit)</option>
            <option value="partner">Partner (Full Access)</option>
          </select>
          <div class="help-text" id="invite-role-help">
            Can view and export data, but cannot make changes
          </div>
        </div>

        <button type="submit" class="invite-submit" id="invite-submit-btn">
          Create Invitation
        </button>

        <div id="invite-message" class="auth-message" style="display: none;"></div>
      </form>

      <!-- Invitation result (shown after creation) -->
      <div id="invite-result" class="invite-result" style="display: none;">
        <div class="invite-result-title">Invitation Created!</div>

        <div class="invite-result-field">
          <div class="invite-result-label">Shareable Link</div>
          <div class="invite-result-value">
            <input type="text" id="invite-result-link" readonly>
            <button type="button" class="invite-copy-btn" onclick="InviteUI.copyLink()">
              Copy
            </button>
          </div>
        </div>

        <div class="invite-result-field">
          <div class="invite-result-label">Invite Code</div>
          <div class="invite-result-value">
            <input type="text" id="invite-result-code" readonly>
            <button type="button" class="invite-copy-btn" onclick="InviteUI.copyCode()">
              Copy
            </button>
          </div>
        </div>

        <div class="help-text" style="margin-top: 12px;">
          This invitation expires in 7 days.
        </div>
      </div>
    </div>
  </div>

  <!-- Phase 14-05: Accept Invitation Banner (shown when URL has invite param) -->
  <div id="invite-accept-banner" class="invite-accept-banner hidden">
    <div class="invite-accept-info">
      <h4 id="invite-accept-title">You've been invited!</h4>
      <p id="invite-accept-desc">Entity Owner invited you as Gestor</p>
    </div>
    <div class="invite-accept-actions">
      <button class="invite-accept-btn accept" onclick="InviteUI.acceptFromBanner()">
        Accept
      </button>
      <button class="invite-accept-btn decline" onclick="InviteUI.declineBanner()">
        Decline
      </button>
    </div>
  </div>

  <!-- Phase 15: Client Form Modal -->
  <div id="client-modal" class="client-modal hidden">
    <div class="client-modal-content">
      <div class="client-modal-header">
        <h3 id="client-modal-title">New Client</h3>
        <button class="client-modal-close" onclick="ClientFormUI.close()">&times;</button>
      </div>

      <form id="client-form" class="client-modal-form">
        <div class="client-form-row full-width">
          <div class="client-form-group">
            <label for="client-name">Name / Company *</label>
            <input type="text" id="client-name" required placeholder="Company or person name">
          </div>
        </div>

        <div class="client-form-row">
          <div class="client-form-group">
            <label for="client-country">Country *</label>
            <select id="client-country" required>
              <option value="ES">Spain</option>
              <option value="BE">Belgium</option>
              <option value="NL">Countryes Bajos</option>
              <option value="DE">Germany</option>
              <option value="FR">France</option>
              <option value="IT">Italy</option>
              <option value="PT">Portugal</option>
              <option value="AT">Austria</option>
              <option value="IE">Irlanda</option>
              <option value="LU">Luxemburgo</option>
              <option value="GB">United Kingdom</option>
              <option value="US">United States</option>
              <option value="CA">Canada</option>
              <option value="AU">Australia</option>
            </select>
          </div>

          <div class="client-form-group">
            <label for="client-tax-id">NIF / CIF / VAT</label>
            <div class="tax-id-input-group">
              <input type="text" id="client-tax-id" placeholder="E.g.: B12345678">
              <button type="button" id="vies-verify-btn" class="vies-btn hidden">
                Verify VIES
              </button>
            </div>
            <span id="tax-id-validation" class="validation-message"></span>
          </div>
        </div>

        <div id="eu-b2b-section" class="client-form-row hidden">
          <div class="client-form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="client-is-b2b" checked>
              B2B Client (reverse charge)
            </label>
            <span class="form-help">Uncheck if consumer (B2C)</span>
          </div>
        </div>

        <div id="w8ben-section" class="client-form-row hidden">
          <div class="client-form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="client-w8ben">
              W-8BEN on file (0% withholding)
            </label>
            <span class="form-help">For US clients with tax treaty</span>
          </div>
        </div>

        <div class="client-form-row">
          <div class="client-form-group">
            <label for="client-email">Email</label>
            <input type="email" id="client-email" placeholder="billing@company.com">
          </div>

          <div class="client-form-group">
            <label for="client-phone">Phone</label>
            <input type="tel" id="client-phone" placeholder="+34 600 000 000">
          </div>
        </div>

        <div class="client-form-row full-width">
          <div class="client-form-group">
            <label for="client-address">Address</label>
            <textarea id="client-address" rows="2" placeholder="Street, number, postal code, city"></textarea>
          </div>
        </div>
      </form>

      <div class="client-modal-actions">
        <button type="button" class="btn btn-secondary" onclick="ClientFormUI.close()">Cancel</button>
        <button type="button" class="btn btn-primary" id="client-submit-btn" onclick="ClientFormUI.handleSubmit(event)">Create Client</button>
      </div>
    </div>
  </div>

  <!-- Phase 15-05: Contact Form Modal -->
  <div id="contact-modal" class="client-modal hidden">
    <div class="client-modal-content">
      <div class="client-modal-header">
        <h3 id="contact-modal-title">New Contact</h3>
        <button class="client-modal-close" onclick="ContactFormUI.close()">&times;</button>
      </div>

      <form id="contact-form" class="client-modal-form">
        <input type="hidden" id="contact-client-id">

        <div class="client-form-row full-width">
          <div class="client-form-group">
            <label for="contact-name">Name *</label>
            <input type="text" id="contact-name" required placeholder="Contact name">
          </div>
        </div>

        <div class="client-form-row">
          <div class="client-form-group">
            <label for="contact-email">Email</label>
            <input type="email" id="contact-email" placeholder="email@company.com">
          </div>
          <div class="client-form-group">
            <label for="contact-phone">Phone</label>
            <input type="tel" id="contact-phone" placeholder="+34 600 000 000">
          </div>
        </div>

        <div class="client-form-row">
          <div class="client-form-group">
            <label for="contact-role">Role</label>
            <select id="contact-role">
              <option value="general">General</option>
              <option value="billing">Billing</option>
              <option value="project_manager">Project Manager</option>
              <option value="technical">Technical</option>
            </select>
          </div>
          <div class="client-form-group">
            <label class="checkbox-label" style="margin-top: 1.5rem;">
              <input type="checkbox" id="contact-primary">
              Primary contact
            </label>
          </div>
        </div>
      </form>

      <div class="client-modal-actions">
        <button type="button" class="btn btn-secondary" onclick="ContactFormUI.close()">Cancel</button>
        <button type="button" class="btn btn-primary" id="contact-submit-btn" onclick="ContactFormUI.handleSubmit(event)">Save</button>
      </div>
    </div>
  </div>

  <!-- Phase 15-05: Project Form Modal -->
  <div id="project-modal" class="client-modal hidden">
    <div class="client-modal-content">
      <div class="client-modal-header">
        <h3 id="project-modal-title">New Project</h3>
        <button class="client-modal-close" onclick="ProjectFormUI.close()">&times;</button>
      </div>

      <form id="project-form" class="client-modal-form">
        <input type="hidden" id="project-client-id">

        <div class="client-form-row full-width">
          <div class="client-form-group">
            <label for="project-name">Project name *</label>
            <input type="text" id="project-name" required placeholder="E.g.: IT Consulting Q1 2026">
          </div>
        </div>

        <div class="client-form-row">
          <div class="client-form-group">
            <label for="project-rate-type">Rate type</label>
            <select id="project-rate-type">
              <option value="daily">Daily</option>
              <option value="hourly">Hourly</option>
              <option value="fixed">Fixed price</option>
              <option value="monthly_retainer">Monthly retainer</option>
            </select>
          </div>
          <div class="client-form-group">
            <label for="project-rate">Rate (EUR)</label>
            <input type="number" id="project-rate" step="0.01" min="0" placeholder="650.00">
          </div>
        </div>

        <div class="client-form-row">
          <div class="client-form-group">
            <label for="project-start">Start date</label>
            <input type="date" id="project-start">
          </div>
          <div class="client-form-group">
            <label for="project-end">End date</label>
            <input type="date" id="project-end">
          </div>
        </div>

        <div class="client-form-row">
          <div class="client-form-group">
            <label for="project-status-override">Status (manual)</label>
            <select id="project-status-override">
              <option value="">Auto (based on dates)</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </div>

        <div class="client-form-row full-width">
          <div class="client-form-group">
            <label for="project-notes">Notes</label>
            <textarea id="project-notes" rows="2" placeholder="Additional notes about the project"></textarea>
          </div>
        </div>

        <!-- Phase 16-03: Work Pattern Fields -->
        <fieldset class="form-fieldset">
          <legend>Work Pattern</legend>

          <div class="client-form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="projectPatternActive" />
              Enable recurring work pattern
            </label>
          </div>

          <div id="projectPatternFields" style="display: none;">
            <div class="client-form-group">
              <label>Work Days (select all that apply)</label>
              <div class="day-checkbox-group">
                <label><input type="checkbox" name="patternDay" value="1" /> Mon</label>
                <label><input type="checkbox" name="patternDay" value="2" /> Tue</label>
                <label><input type="checkbox" name="patternDay" value="3" /> Wed</label>
                <label><input type="checkbox" name="patternDay" value="4" /> Thu</label>
                <label><input type="checkbox" name="patternDay" value="5" /> Fri</label>
                <label><input type="checkbox" name="patternDay" value="6" /> Sat</label>
                <label><input type="checkbox" name="patternDay" value="7" /> Sun</label>
              </div>
            </div>

            <div class="client-form-group">
              <label>Extra days in first week of month</label>
              <div class="day-checkbox-group">
                <label><input type="checkbox" name="patternFirstWeek" value="3" /> Wed</label>
                <label><input type="checkbox" name="patternFirstWeek" value="4" /> Thu</label>
                <label><input type="checkbox" name="patternFirstWeek" value="5" /> Fri</label>
              </div>
              <small class="form-hint">For patterns like "Mon-Tue + first week Wed-Fri"</small>
            </div>

            <div class="client-form-group">
              <label for="projectPatternLocation">Default Location</label>
              <select id="projectPatternLocation">
                <option value="belgium">BE Belgium</option>
                <option value="spain">ES Spain</option>
                <option value="travel">Travel</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>
        </fieldset>
      </form>

      <div class="client-modal-actions">
        <button type="button" class="btn btn-secondary" onclick="ProjectFormUI.close()">Cancel</button>
        <button type="button" class="btn btn-primary" id="project-submit-btn" onclick="ProjectFormUI.handleSubmit(event)">Save</button>
      </div>
    </div>
  </div>

  <!-- Phase 16-02: Day Editor Modal -->
  <div id="dayEditorModal" class="client-modal hidden">
    <div class="client-modal-content" style="max-width: 500px;">
      <div class="client-modal-header">
        <h3 id="dayEditorTitle">Edit Day</h3>
        <button type="button" class="client-modal-close" onclick="closeDayEditor()">&times;</button>
      </div>
      <form id="dayEditorForm" class="client-modal-form" onsubmit="saveDayEditor(event)">
        <input type="hidden" id="dayEditorDate" />

        <!-- Location Selection -->
        <div class="client-form-group">
          <label>Location</label>
          <div class="radio-group" id="dayEditorLocationGroup">
            <label class="radio-option">
              <input type="radio" name="dayLocation" value="belgium" />
              <span> Belgium</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="dayLocation" value="spain" />
              <span> Spain</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="dayLocation" value="travel" />
              <span> Travel</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="dayLocation" value="other" />
              <span>Other</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="dayLocation" value="unset" checked />
              <span>Unset</span>
            </label>
          </div>
        </div>

        <!-- Client Selection -->
        <div class="client-form-group">
          <label for="dayEditorClient">Client</label>
          <select id="dayEditorClient" onchange="updateDayEditorProjectDropdown()">
            <option value="">-- No client --</option>
          </select>
        </div>

        <!-- Project Selection -->
        <div class="client-form-group">
          <label for="dayEditorProject">Project</label>
          <select id="dayEditorProject" disabled>
            <option value="">-- Select client first --</option>
          </select>
        </div>

        <!-- Notes -->
        <div class="client-form-group">
          <label for="dayEditorNotes">Notes</label>
          <textarea id="dayEditorNotes" rows="2" placeholder="Optional notes for this day"></textarea>
        </div>

        <!-- Linked Expenses (read-only info + mini list) -->
        <div class="client-form-group" id="dayEditorExpensesInfo" style="display: none;">
          <label>Linked Expenses (<span id="dayEditorExpensesCount">0</span>)</label>
          <div id="dayEditorExpensesList" class="day-editor-expenses-list"></div>
          <button type="button" class="btn btn-secondary btn-sm" id="dayEditorAddExpenseBtn" style="margin-top: 0.5rem; font-size: 0.75rem;" onclick="addExpenseForDay()">+ Add Expense for This Day</button>
        </div>

        <!-- Actions -->
        <div class="client-modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeDayEditor()">Cancel</button>
          <button type="button" class="btn btn-danger" onclick="clearDayEditor()" style="margin-right: auto;">Clear Day</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Phase 16-02: Bulk Tag Modal -->
  <div id="bulkTagModal" class="client-modal hidden">
    <div class="client-modal-content" style="max-width: 400px;">
      <div class="client-modal-header">
        <h3>Tag Selected Days</h3>
        <button type="button" class="client-modal-close" onclick="closeBulkTagModal()">&times;</button>
      </div>
      <form id="bulkTagForm" class="client-modal-form" onsubmit="executeBulkTag(event)">
        <div class="client-form-group">
          <label>Selected days: <span id="bulkTagCount" class="bulk-tag-count">0</span></label>
        </div>

        <div class="client-form-group">
          <label for="bulkTagClient">Client</label>
          <select id="bulkTagClient" onchange="updateBulkTagProjects()">
            <option value="">-- Select client --</option>
          </select>
        </div>

        <div class="client-form-group">
          <label for="bulkTagProject">Project</label>
          <select id="bulkTagProject" disabled>
            <option value="">-- Select client first --</option>
          </select>
        </div>

        <div class="client-form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="bulkTagOverwrite" />
            <span>Overwrite existing client tags</span>
          </label>
          <small class="form-hint">If unchecked, days with existing client tags will be skipped</small>
        </div>

        <div class="client-modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeBulkTagModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Apply Tags</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Phase 16-03: Apply Work Pattern Modal -->
  <div id="applyPatternModal" class="client-modal hidden">
    <div class="client-modal-content" style="max-width: 450px;">
      <div class="client-modal-header">
        <h3>Apply Work Pattern</h3>
        <button type="button" class="client-modal-close" onclick="closeApplyPatternModal()">&times;</button>
      </div>
      <form id="applyPatternForm" class="client-modal-form" onsubmit="executeApplyPattern(event)">
        <div class="client-form-group">
          <label for="applyPatternClient">Client</label>
          <select id="applyPatternClient" required onchange="loadClientProjectsForPattern()">
            <option value="">-- Select client --</option>
          </select>
        </div>

        <div class="client-form-group">
          <label for="applyPatternProject">Project (with pattern)</label>
          <select id="applyPatternProject" required disabled onchange="previewApplyPattern()">
            <option value="">-- Select client first --</option>
          </select>
        </div>

        <div class="client-form-row">
          <div class="client-form-group">
            <label for="applyPatternStart">Start Date</label>
            <input type="date" id="applyPatternStart" required onchange="previewApplyPattern()" />
          </div>
          <div class="client-form-group">
            <label for="applyPatternEnd">End Date</label>
            <input type="date" id="applyPatternEnd" required onchange="previewApplyPattern()" />
          </div>
        </div>

        <div id="applyPatternPreview" class="pattern-preview">
          <p class="preview-text">Select a project to see preview</p>
        </div>

        <div class="client-modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeApplyPatternModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="applyPatternSubmitBtn" disabled>Apply Pattern</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Phase 12: Loading Screen for Database Initialization -->
  <div id="loading-screen" class="loading-screen">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p id="loading-status">Initializing database...</p>
    </div>
  </div>

  <!-- Notification Toast (used by clipboard copy) -->
  <div id="notification" class="notification hidden"></div>

  <div class="container">
    <div class="dashboard">
      <!-- Dashboard Header -->
      <header class="dashboard-header">
        <div>
          <h1 class="dashboard-title">Autonomo Tax Calculator</h1>
          <p class="dashboard-subtitle">Self-Employed Tax Calculator 2025/2026</p>
        </div>
        <!-- Phase 13-04: Entity Switcher -->
        <div id="entity-switcher-container" class="entity-switcher-container"></div>
        <!-- Phase 14-06: Role indicator -->
        <span id="current-role-indicator" class="role-indicator" style="display: none;"></span>

        <!-- Phase 14-03: User Menu (shown when authenticated) -->
        <div id="user-menu" class="user-menu" style="display: none;">
          <button class="user-menu-trigger" onclick="UserMenuUI.toggle()">
            <div class="user-avatar" id="user-avatar-initial">?</div>
            <span id="user-menu-name">User</span>
            <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
              <path d="M6 8L2 4h8L6 8z"/>
            </svg>
          </button>
          <div id="user-menu-dropdown" class="user-menu-dropdown">
            <div class="user-menu-item" onclick="UserMenuUI.showProfile()">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 8a3 3 0 100-6 3 3 0 000 6zm0 2c-3.314 0-6 1.343-6 3v1h12v-1c0-1.657-2.686-3-6-3z"/>
              </svg>
              Profile
            </div>
            <div class="user-menu-item" onclick="UserMenuUI.showSessions()">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M2 3h12a1 1 0 011 1v8a1 1 0 01-1 1H2a1 1 0 01-1-1V4a1 1 0 011-1zm0 2v6h12V5H2z"/>
              </svg>
              Active Sessions
            </div>
            <div class="user-menu-divider"></div>
            <div class="user-menu-item danger" onclick="UserMenuUI.signOut()">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M11 3v2h2v6h-2v2h4V3h-4zM3 8l4-4v3h4v2H7v3L3 8z"/>
              </svg>
              Sign Out
            </div>
          </div>
        </div>
      </header>

      <!-- Compliance Warning Banner (COMP-01) -->
      <div id="complianceWarningBanner" class="compliance-warning-banner" role="alert" aria-live="polite">
        <span class="warning-text" id="warningText"></span>
        <button class="dismiss-btn" aria-label="Dismiss warning" onclick="dismissComplianceWarning()">&times;</button>
      </div>

      <!-- Phase 14-06: Read-only banner for gestors -->
      <div id="read-only-banner" class="read-only-banner">
        You have view-only access to this entity. Contact the owner to request edit permissions.
      </div>

      <!-- Tab radio inputs (hidden) -->
      <input type="radio" name="tabs" id="tab-scenarios" class="tab-input" checked>
      <input type="radio" name="tabs" id="tab-calendar" class="tab-input">
      <input type="radio" name="tabs" id="tab-expenses" class="tab-input">
      <input type="radio" name="tabs" id="tab-invoices" class="tab-input">
      <input type="radio" name="tabs" id="tab-details" class="tab-input">
      <input type="radio" name="tabs" id="tab-income" class="tab-input">
      <input type="radio" name="tabs" id="tab-clients" class="tab-input">
      <input type="radio" name="tabs" id="tab-compliance" class="tab-input">

      <!-- Tab navigation -->
      <nav class="tab-nav">
        <label for="tab-scenarios" class="tab-label">Scenarios</label>
        <label for="tab-calendar" class="tab-label">Calendar</label>
        <label for="tab-expenses" class="tab-label">Expenses</label>
        <label for="tab-invoices" class="tab-label">Invoices</label>
        <label for="tab-details" class="tab-label">Details</label>
        <label for="tab-income" class="tab-label">Income</label>
        <label for="tab-clients" class="tab-label">Clients</label>
        <label for="tab-compliance" class="tab-label">Compliance</label>
      </nav>

      <!-- Tab panels container -->
      <div class="tab-panels">

        <!-- EXPENSES TAB -->
        <section class="tab-panel panel-expenses">
          <div class="expenses-container">
      <h2>Expense Tracking</h2>
      <div id="spainSection"></div>
      <div id="workTravelSection"></div>
      <div id="privateSection"></div>
      <div style="margin-top: 1rem; display: flex; justify-content: flex-end;">
        <button class="reset-btn" data-permission="edit" data-permission-type="expense" onclick="resetToDefaults()">Reset to Defaults</button>
      </div>

      <!-- Add Expense Dialog (modal for better UX) -->
      <dialog id="addExpenseDialog" class="expense-dialog">
        <div class="dialog-header">
          <h2>Add New Expense</h2>
          <button type="button" class="dialog-close" onclick="hideAddForm()">x</button>
        </div>
        <div style="padding: 1.5rem;">
          <div class="form-row">
            <label>Name:
              <input type="text" id="newExpName" placeholder="e.g., Software subscription" required oninput="handleExpenseNameInput(this.value)">
            </label>
            <span id="detectionBadge" class="detection-badge" style="display: none;"></span>
          </div>
          <div class="form-row">
            <label>Amount (EUR/month):
              <input type="number" id="newExpAmount" min="0" step="0.01" required>
            </label>
          </div>
          <div class="form-row">
            <label>Category:
              <select id="newExpCategory" onchange="toggleDeductionField()">
                <option value="spainDeductible">Spain Deductible</option>
                <option value="workTravel">Work Travel</option>
                <option value="private">Private</option>
              </select>
            </label>
          </div>
          <div class="form-row" id="deductionRow">
            <label>Deduction %:
              <div class="deduction-field-wrapper">
                <input type="number" id="newExpDeduction" min="0" max="100" value="100" onchange="handleDeductionChange(this.value)">
              </div>
            </label>
            <div id="deductionHint" class="detection-hint" style="display: none;"></div>
          </div>
        </div>
        <div class="dialog-footer">
          <div class="spacer"></div>
          <button class="secondary-btn" onclick="hideAddForm()">Cancel</button>
          <button class="primary-btn" onclick="submitNewExpense()">Add Expense</button>
        </div>
      </dialog>

      <!-- Phase 17: Expense Tracker Section -->
      <div class="expense-tracker-section" style="margin-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h3 style="margin: 0;">Expense Tracker</h3>
          <button class="primary-btn" data-permission="edit" data-permission-type="expense" onclick="openExpenseFormDialog()">+ Add Expense</button>
        </div>
        <div id="expenseTrackerList">
          <!-- Phase 17-04: Filter Bar -->
          <div class="expense-filters">
            <div class="filter-group">
              <label for="expFilterDateFrom">From</label>
              <input type="date" id="expFilterDateFrom" onchange="renderExpenseList()">
            </div>
            <div class="filter-group">
              <label for="expFilterDateTo">To</label>
              <input type="date" id="expFilterDateTo" onchange="renderExpenseList()">
            </div>
            <div class="filter-group">
              <label for="expFilterCategory">Category</label>
              <select id="expFilterCategory" onchange="renderExpenseList()">
                <option value="">All categories</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="expFilterClient">Client</label>
              <select id="expFilterClient" onchange="renderExpenseList()">
                <option value="">All clients</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="expFilterBillable">Billable</label>
              <select id="expFilterBillable" onchange="renderExpenseList()">
                <option value="">All</option>
                <option value="true">Billable only</option>
                <option value="false">Non-billable only</option>
              </select>
            </div>
          </div>

          <!-- Phase 17-04: Summary Bar -->
          <div class="expense-summary-bar">
            <div class="summary-stat">
              <span class="stat-label">Total</span>
              <span class="stat-value" id="expSummaryTotal">--</span>
            </div>
            <div class="summary-stat">
              <span class="stat-label">Deductible</span>
              <span class="stat-value deductible" id="expSummaryDeductible">--</span>
            </div>
            <div class="summary-stat">
              <span class="stat-label">Count</span>
              <span class="stat-value" id="expSummaryCount">0</span>
            </div>
          </div>

          <!-- Phase 17-04: Expense List Container -->
          <div id="expenseListContainer">
            <div class="expense-list-empty">
              No expenses tracked yet. Click "+ Add Expense" to get started.
            </div>
          </div>

          <!-- Phase 17-06: Archived Expenses Toggle -->
          <div class="expense-archived-toggle" onclick="renderArchivedExpenses()">
            <span id="expenseArchivedToggle">Show Archived</span>
          </div>
          <div id="expenseArchivedContainer" style="display: none;"></div>
        </div>
      </div>

      <!-- Phase 17: Expense Form Dialog -->
      <dialog id="expenseFormDialog" class="expense-form-dialog" data-edit-id="">
        <div class="dialog-header">
          <h2 id="expenseFormTitle">Add Expense</h2>
          <button type="button" class="dialog-close" onclick="closeExpenseFormDialog()">x</button>
        </div>
        <form id="expenseForm" class="expense-form-body" onsubmit="event.preventDefault(); submitExpenseForm();">

          <!-- Row 1: Date + Amount -->
          <div class="form-row-grid">
            <div class="form-group">
              <label for="efDate">Date</label>
              <input type="date" id="efDate" required>
            </div>
            <div class="form-group">
              <label for="efAmount">Amount (EUR)</label>
              <input type="number" id="efAmount" step="0.01" min="0" required placeholder="0.00" oninput="_triggerDietasValidation()">
            </div>
          </div>

          <!-- Row 2: IVA + Vendor -->
          <div class="form-row-grid">
            <div class="form-group">
              <label for="efIva">IVA Amount (EUR)</label>
              <input type="number" id="efIva" step="0.01" min="0" value="0" placeholder="0.00">
            </div>
            <div class="form-group">
              <label for="efVendor">Vendor</label>
              <input type="text" id="efVendor" placeholder="e.g., Ryanair, Amazon, Gestor X">
            </div>
          </div>

          <!-- Row 3: Category + Subcategory -->
          <div class="form-row-grid">
            <div class="form-group">
              <label for="efCategory">Category</label>
              <select id="efCategory" required onchange="onExpenseCategoryChange(this)">
                <option value="">-- Select --</option>
              </select>
              <div id="efCategoryDeductionHint" class="category-deduction-hint" style="display: none;"></div>
            </div>
            <div class="form-group" id="efSubcategoryGroup" style="display: none;">
              <label for="efSubcategory">Subcategory</label>
              <select id="efSubcategory">
                <option value="">-- None --</option>
              </select>
            </div>
          </div>

          <!-- Description -->
          <div class="form-group">
            <label for="efDescription">Description</label>
            <textarea id="efDescription" rows="2" placeholder="Optional notes about this expense"></textarea>
          </div>

          <!-- Receipt Upload -->
          <div class="receipt-upload-area">
            <div class="form-group">
              <label for="efReceipt">Receipt Upload</label>
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input type="file" id="efReceipt" accept="image/*,.pdf" onchange="handleReceiptUpload(this)">
              </div>
            </div>
            <div id="efOcrStatus" class="ocr-status"></div>
          </div>

          <!-- Conditional fields: Travel -->
          <div id="efTravelFields" class="conditional-fields">
            <div style="font-size: 0.8rem; opacity: 0.6; margin-bottom: 0.25rem;">Travel Details</div>
            <div class="form-group">
              <label for="efDestination">Destination</label>
              <input type="text" id="efDestination" placeholder="e.g., BE, ES, NL">
            </div>
            <div class="form-row-grid">
              <div class="form-group">
                <label for="efTripStartDate">Trip Start Date</label>
                <input type="date" id="efTripStartDate">
              </div>
              <div class="form-group">
                <label for="efTripEndDate">Trip End Date</label>
                <input type="date" id="efTripEndDate">
              </div>
            </div>
            <div class="checkbox-row">
              <input type="checkbox" id="efHasOvernight">
              <label for="efHasOvernight">Has Overnight Stay</label>
            </div>
          </div>

          <!-- Conditional fields: Meals/Dietas -->
          <div id="efMealsFields" class="conditional-fields">
            <div style="font-size: 0.8rem; opacity: 0.6; margin-bottom: 0.25rem;">Meals / Dietas Details</div>
            <div class="form-group">
              <label for="efMealsDestination">Destination</label>
              <input type="text" id="efMealsDestination" placeholder="e.g., BE, ES, NL" oninput="_triggerDietasValidation()">
            </div>
            <div class="checkbox-row">
              <input type="checkbox" id="efMealsHasOvernight" onchange="_triggerDietasValidation()">
              <label for="efMealsHasOvernight">Has Overnight Stay</label>
            </div>
            <div class="form-group">
              <label for="efPaymentMethod">Payment Method</label>
              <select id="efPaymentMethod" onchange="_triggerDietasValidation()">
                <option value="card">Card</option>
                <option value="transfer">Transfer</option>
                <option value="bizum">Bizum</option>
                <option value="cash">Cash</option>
              </select>
            </div>
            <!-- Phase 17-06: Dietas real-time warnings container -->
            <div id="efDietasWarnings" class="dietas-warnings"></div>
          </div>

          <!-- Conditional fields: Home Office (autonomo only) -->
          <div id="efHomeOfficeFields" class="conditional-fields">
            <div style="font-size: 0.8rem; opacity: 0.6; margin-bottom: 0.25rem;">Home Office Deduction</div>
            <div class="form-group">
              <label for="efDeductiblePct">Deductible % (max 30% for autonomo)</label>
              <input type="number" id="efDeductiblePct" min="0" max="30" value="30" step="1">
            </div>
          </div>

          <!-- Client + Project (optional, for EXPENSE-09) -->
          <div class="form-row-grid">
            <div class="form-group">
              <label for="efClient">Client (optional)</label>
              <select id="efClient" onchange="onExpenseClientChange(this)">
                <option value="">-- None --</option>
              </select>
            </div>
            <div class="form-group" id="efProjectGroup" style="display: none;">
              <label for="efProject">Project</label>
              <select id="efProject">
                <option value="">-- None --</option>
              </select>
            </div>
          </div>

          <!-- Billable checkbox (shown when client selected) -->
          <div id="efBillableGroup" style="display: none;">
            <div class="checkbox-row">
              <input type="checkbox" id="efBillable">
              <label for="efBillable">Billable to client (EXPENSE-14)</label>
            </div>
          </div>

        </form>
        <div class="dialog-footer">
          <div class="spacer"></div>
          <button type="button" class="secondary-btn" onclick="closeExpenseFormDialog()">Cancel</button>
          <button type="button" class="primary-btn" onclick="submitExpenseForm()">Save Expense</button>
        </div>
      </dialog>

          </div>
        </section>

        <!-- INVOICES TAB -->
        <section class="tab-panel panel-invoices">
          <!-- Overdue Alert Banner (hidden by default) -->
          <div id="overdue-alert" class="overdue-alert" style="display: none;">
            <span class="overdue-alert-icon">!</span>
            <span id="overdue-alert-text"></span>
          </div>

          <!-- Invoice List View -->
          <div id="invoice-list-view">
            <div class="invoices-header">
              <h2>Invoices</h2>
              <button class="btn btn-primary" id="new-invoice-btn" data-permission="create" onclick="openInvoiceForm()">+ New Invoice</button>
            </div>

            <!-- Filters -->
            <div class="invoices-filters">
              <select id="invoiceFilterClient" onchange="renderInvoiceList()">
                <option value="">All Clients</option>
              </select>
              <select id="invoiceFilterStatus" onchange="renderInvoiceList()">
                <option value="">All Statuses</option>
                <option value="draft">Draft</option>
                <option value="sent">Sent</option>
                <option value="paid">Paid</option>
                <option value="overdue">Overdue</option>
              </select>
              <input type="month" id="invoiceFilterMonth" onchange="renderInvoiceList()">
              <select id="invoiceFilterProject" onchange="renderInvoiceList()">
                <option value="">All Projects</option>
              </select>
            </div>

            <!-- Summary Bar -->
            <div class="invoices-summary-bar">
              <div class="summary-item">
                <span class="summary-label">Total Invoiced</span>
                <span id="invoiceSummaryTotal" class="summary-value mono">-</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Outstanding</span>
                <span id="invoiceSummaryOutstanding" class="summary-value mono">-</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Overdue</span>
                <span id="invoiceSummaryOverdue" class="summary-value mono overdue-value">-</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Paid</span>
                <span id="invoiceSummaryPaid" class="summary-value mono paid-value">-</span>
              </div>
            </div>

            <!-- Desktop Table -->
            <table class="invoice-table" id="invoiceTable">
              <thead>
                <tr>
                  <th>Number</th>
                  <th>Client</th>
                  <th>Date</th>
                  <th>Due Date</th>
                  <th class="text-right">Total</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="invoiceTableBody"></tbody>
            </table>

            <!-- Mobile Cards -->
            <div class="invoice-cards" id="invoiceCards"></div>

            <!-- Empty State -->
            <div id="invoiceEmptyState" class="empty-state" style="display: none;">
              <p id="invoiceEmptyText">No invoices yet. Create your first invoice.</p>
            </div>
          </div>

          <!-- Invoice Detail View (hidden by default) -->
          <div id="invoice-detail-view" class="invoice-detail-view" style="display: none;">
            <div class="invoice-detail-header">
              <button class="btn btn-small" onclick="showInvoiceList()">Back to List</button>
              <h2 id="detail-invoice-number"></h2>
              <span id="detail-invoice-status" class="invoice-status-badge"></span>
              <div class="invoice-detail-actions" id="detail-invoice-actions"></div>
            </div>
            <div class="invoice-detail-body">
              <div class="invoice-detail-meta">
                <div class="detail-entity-info" id="detail-entity-info"></div>
                <div class="detail-client-info" id="detail-client-info"></div>
              </div>
              <div class="invoice-detail-info-row">
                <span>Date: <strong id="detail-invoice-date"></strong></span>
                <span>Due: <strong id="detail-invoice-due"></strong></span>
                <span id="detail-invoice-currency-info"></span>
              </div>
              <table class="invoice-detail-lines-table">
                <thead>
                  <tr>
                    <th>Description</th>
                    <th class="text-right">Qty</th>
                    <th class="text-right">Unit Price</th>
                    <th class="text-right">IVA %</th>
                    <th class="text-right">Total</th>
                  </tr>
                </thead>
                <tbody id="detail-line-items"></tbody>
              </table>
              <div class="invoice-detail-totals" id="detail-totals"></div>

              <!-- Legal Text (EU B2B, export, etc.) -->
              <div id="detail-legal-text" class="invoice-legal-text" style="display: none;"></div>

              <!-- Rectificativa Reference -->
              <div id="detail-rectificativa-ref" class="rectificativa-ref" style="display: none;"></div>

              <!-- Payment History -->
              <div class="payment-section">
                <h3>Payments</h3>
                <div id="payment-history"></div>
                <div id="payment-form-container" style="display: none;">
                  <h4>Record Payment</h4>
                  <div class="payment-form">
                    <input type="number" id="paymentAmount" placeholder="Amount (EUR)" step="0.01" min="0">
                    <input type="date" id="paymentDate">
                    <select id="paymentMethod">
                      <option value="transfer">Bank Transfer</option>
                      <option value="card">Card</option>
                      <option value="cash">Cash</option>
                      <option value="other">Other</option>
                    </select>
                    <input type="text" id="paymentReference" placeholder="Reference / Note">
                    <button class="btn btn-primary" data-permission="edit" onclick="handleRecordPayment()">Record</button>
                  </div>
                </div>
              </div>

              <!-- Notes -->
              <div id="detail-notes" class="invoice-notes" style="display: none;"></div>
            </div>
          </div>
        </section>

        <!-- SCENARIOS TAB -->
        <section class="tab-panel panel-scenarios">
          <div class="scenario-section">
            <h2>Scenario Comparison</h2>
            <div id="scenarioCards" class="scenario-cards">
              <!-- Populated by renderScenarioCards() -->
            </div>
            <div class="export-actions">
              <button onclick="resetScenarios()" class="reset-btn">
                Reset to Defaults
              </button>
              <button onclick="copyTableToClipboard()" class="secondary-btn">
                Copy to Clipboard
              </button>
              <button onclick="window.print()" class="secondary-btn">
                Print / PDF
              </button>
            </div>
            <div id="comparisonTable">
              <!-- Populated by renderComparisonTable() -->
            </div>
            <div class="comparison-mobile">
              <!-- Populated by renderMobileComparison() -->
            </div>
          </div>
        </section>

        <!-- CALENDAR TAB -->
        <section class="tab-panel panel-calendar">
          <div class="calendar-section">
      <h2>Belgium Calendar <span id="calendarYearTitle">2026</span></h2>

      <!-- Year Summary (Phase 16-04) -->
      <div id="yearSummary" class="year-summary">
        <strong id="yearSummaryLabel">2026 Summary:</strong>
        <span id="yearSummaryBelgium">0</span> Belgium
        <span id="yearSummarySpain">0</span> Spain
        <span id="yearSummaryTravel">0</span> Travel
        <span id="yearSummaryThreshold" class="threshold-indicator">(0/183)</span>
      </div>

      <div class="calendar-info" style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 4px; font-size: 0.9rem;">
        <strong style="color: var(--accent);">How days are counted:</strong>
        <ul style="margin: 0.5rem 0 0 1.5rem; opacity: 0.8; line-height: 1.6;">
          <li><strong>Belgium days</strong> + <strong>Travel days</strong> count toward 183-day threshold</li>
          <li><strong>Spain days</strong> do not count toward threshold</li>
          <li><strong>Travel days:</strong> Use for flight days between countries</li>
        </ul>
      </div>

      <div class="calendar-stats">
        <div class="count-display">
          <span class="count-label">This month:</span>
          <span id="monthBelgiumCount" class="count-value">0</span> Belgium
        </div>
        <div class="count-display">
          <span class="count-label">Annual total:</span>
          <span id="annualBelgiumCount" class="count-value">0</span> Belgium + Travel
          <span class="source-hint" data-tooltip="Entry and exit days (travel days between Belgium and Spain) may be counted by BOTH countries' tax authorities. This calculator counts Travel days toward the 183-day threshold as a conservative approach. Art. 4 Spain-Belgium tax treaty applies for tie-breaker.">?</span>
          <span id="warningBadge" class="warning-badge hidden"></span>
        </div>
      </div>

      <!-- Progressive Threshold Warning Banner (Phase 16-04) -->
      <div id="thresholdWarningBanner" class="threshold-banner" style="display: none;">
        <span class="warning-icon"></span>
        <span class="warning-message"></span>
        <span class="warning-count">
          <strong id="thresholdCount">0</strong> of 183 days
        </span>
        <button type="button" class="warning-dismiss" onclick="dismissThresholdWarning()" aria-label="Dismiss warning">&times;</button>
      </div>

      <div id="warningBanner" class="warning-banner hidden"></div>

      <!-- Calendar Toolbar - Always visible for bulk operations -->
      <div class="calendar-toolbar">
        <div class="toolbar-selection">
          <span class="toolbar-label">Selected: <span id="selectionCount" class="selection-count-badge">0</span> days</span>
          <button type="button" class="toolbar-btn" onclick="clearSelection()" title="Clear selection">Clear</button>
        </div>
        <div class="toolbar-actions">
          <span class="toolbar-label">Set status:</span>
          <button type="button" class="toolbar-status-btn belgium" onclick="applyStatusToSelected('belgium')">
            <span class="status-indicator belgium"></span> Belgium
          </button>
          <button type="button" class="toolbar-status-btn spain" onclick="applyStatusToSelected('spain')">
            <span class="status-indicator spain"></span> Spain
          </button>
          <button type="button" class="toolbar-status-btn travel" onclick="applyStatusToSelected('travel')">
            <span class="status-indicator travel"></span> Travel
          </button>
          <button type="button" class="toolbar-status-btn clear" onclick="applyStatusToSelected('unset')">
            Clear Status
          </button>
          <button type="button" class="toolbar-btn" onclick="openBulkTagModal()" title="Tag selected days with client/project">
            Tag with Client
          </button>
        </div>
      </div>

      <div id="calendarContainer">
        <!-- Populated by renderCalendar() -->
      </div>
      <div class="calendar-actions" style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: flex-end; align-items: center;">
        <button type="button" class="secondary-btn" onclick="openApplyPatternModal()">Apply Work Pattern</button>
        <button class="reset-btn" onclick="resetCalendar()">Reset Calendar</button>
        <span id="unsavedIndicator" class="unsaved-indicator hidden">Unsaved changes</span>
        <button id="saveCalendarBtn" class="primary-btn" onclick="commitCalendarChanges()" disabled>Save Calendar</button>
      </div>

      <div class="export-section">
        <h4 style="margin: 0 0 0.75rem 0; opacity: 0.8;">Export Calendar</h4>
        <div class="export-buttons">
          <button class="secondary-btn" onclick="downloadICS()">
            <span style="margin-right: 0.5rem;">&#128197;</span>
            Export ICS
          </button>
          <button class="secondary-btn" onclick="downloadCSV()">
            <span style="margin-right: 0.5rem;">&#128196;</span>
            Export CSV
          </button>
          <button class="secondary-btn" onclick="copyToClipboard()">
            <span style="margin-right: 0.5rem;">&#128203;</span>
            Copy Summary
          </button>
        </div>
      </div>

      <!-- Phase 16-06: Google Calendar Sync Section -->
      <div class="gcal-section">
        <h4 style="margin: 0; opacity: 0.8;">Google Calendar Sync</h4>

        <!-- State: Not configured (no CLIENT_ID) -->
        <div id="gcalNotConfigured" class="gcal-not-configured">
          <span class="text-muted">Google Calendar sync requires configuration. Set CLIENT_ID in code.</span>
        </div>

        <!-- State: Configured but not connected -->
        <div id="gcalDisconnected" style="display: none;">
          <button type="button" id="gcalConnectBtn" class="btn btn-secondary" onclick="GCalSync.authorize()" disabled>
            &#128279; Connect Google Calendar
          </button>
        </div>

        <!-- State: Connected -->
        <div id="gcalConnected" style="display: none;">
          <span class="gcal-status">&#10003; Connected to Google Calendar</span>
          <button type="button" id="gcalSyncBtn" class="btn btn-primary" onclick="syncToGCal()">
            &#128260; Sync Now
          </button>
          <button type="button" class="btn btn-secondary btn-sm" onclick="GCalSync.revoke()">
            Disconnect
          </button>
        </div>
      </div>

      <details class="holidays-reference" style="margin-top: 1rem;">
        <summary style="cursor: pointer; opacity: 0.8;">Belgian Public Holidays 2026 (Reference)</summary>
        <div style="padding: 1rem 0; font-size: 0.9rem; opacity: 0.8;">
          <p style="margin-bottom: 0.5rem;">These are NOT auto-marked. Mark manually if you are in Belgium:</p>
          <ul style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">
            <li>Apr 6 - Easter Monday</li>
            <li>May 1 - Labour Day</li>
            <li>May 14 - Ascension Day</li>
            <li>May 25 - Whit Monday</li>
            <li>Jul 21 - Belgian National Holiday</li>
            <li>Aug 15 - Assumption Day (Saturday - substitute TBD)</li>
            <li>Nov 1 - All Saints' Day (Sunday - substitute TBD)</li>
            <li>Nov 11 - Armistice Day</li>
            <li>Dec 25 - Christmas Day</li>
          </ul>
          <p style="margin-top: 0.75rem; font-style: italic;">
            If a holiday falls the day before a contracted work day, you may need to be in Belgium.
            These still count toward the 183-day threshold.
          </p>
        </div>
      </details>
          </div>
        </section>

        <!-- DETAILS TAB - What-If Calculator -->
        <section class="tab-panel panel-details">
          <div class="calculator-header">
            <h2>What-If Calculator</h2>
            <p class="calculator-subtitle">Adjust any value to see how it affects your net income</p>
          </div>

          <div class="calculator-layout">
            <!-- Input Panel -->
            <div class="calculator-inputs">
              <!-- Income Section -->
              <div class="input-section">
                <h3 class="input-section-title">Income</h3>
                <div class="input-field">
                  <label for="monthlyRevenue">Monthly Revenue</label>
                  <div class="input-with-euro">
                    <input type="number" id="monthlyRevenue" value="6000" min="0" step="100" oninput="recalculateTotals()">
                    <span class="input-unit">EUR/mo</span>
                  </div>
                </div>
              </div>

              <!-- Expenses Section -->
              <div class="input-section">
                <h3 class="input-section-title">Monthly Expenses</h3>
                <div class="input-field">
                  <label for="calcSpainDeductible">Spain Deductible</label>
                  <div class="input-with-euro">
                    <input type="number" id="calcSpainDeductible" value="383" min="0" step="10" oninput="recalculateTotals()">
                    <span class="input-unit">EUR/mo</span>
                  </div>
                  <span class="input-hint">Home office, phone, utilities</span>
                </div>
                <div class="input-field">
                  <label for="calcWorkTravel">Work Travel (Belgium)</label>
                  <div class="input-with-euro">
                    <input type="number" id="calcWorkTravel" value="1000" min="0" step="100" oninput="recalculateTotals()">
                    <span class="input-unit">EUR/mo</span>
                  </div>
                  <span class="input-hint">Flights, hotels, transport</span>
                </div>
                <div class="input-field">
                  <label for="calcPrivateCosts">Private Costs</label>
                  <div class="input-with-euro">
                    <input type="number" id="calcPrivateCosts" value="1727" min="0" step="50" oninput="recalculateTotals()">
                    <span class="input-unit">EUR/mo</span>
                  </div>
                  <span class="input-hint">Rent, car, insurance (not deductible)</span>
                </div>
              </div>

              <!-- Tax Options Section -->
              <div class="input-section">
                <h3 class="input-section-title">Tax Options</h3>
                <div class="input-field checkbox-field">
                  <label class="checkbox-inline">
                    <input type="checkbox" id="hasDescendant" checked onchange="recalculateTotals()">
                    <span>1 Dependent Child</span>
                  </label>
                  <span class="input-hint">Adds 2,400 EUR minimo</span>
                </div>
              </div>

              <!-- Advanced Options (Collapsible) -->
              <details class="advanced-section">
                <summary class="advanced-toggle">Advanced Options</summary>
                <div class="advanced-content">
                  <div class="input-field">
                    <label for="calcRetaMonthly">RETA (Social Security)</label>
                    <div class="input-with-euro">
                      <input type="number" id="calcRetaMonthly" value="428.40" min="0" step="10" oninput="recalculateTotals()">
                      <span class="input-unit">EUR/mo</span>
                    </div>
                    <span class="input-hint" id="retaSourceHint">Fixed from registration</span>
                  </div>
                  <div class="input-field">
                    <label for="calcMinimoPersonal">Minimo Personal</label>
                    <div class="input-with-euro">
                      <input type="number" id="calcMinimoPersonal" value="5550" min="0" step="100" oninput="recalculateTotals()">
                      <span class="input-unit">EUR/yr</span>
                    </div>
                    <span class="input-hint" id="minimoSourceHint"></span>
                  </div>
                </div>
              </details>

              <!-- Action Buttons -->
              <div class="calculator-actions">
                <button class="secondary-btn" onclick="resetDetailsForm()">Reset to Defaults</button>
                <button class="primary-btn" onclick="saveAsScenario()">Save as Scenario</button>
              </div>
            </div>

            <!-- Results Panel -->
            <div class="calculator-results" id="results">
              <!-- Populated by recalculateTotals() -->
            </div>
          </div>
        </section>

        <!-- INCOME TAB (Phase 8 - ENH-02) -->
        <section class="tab-panel panel-income">
          <div class="income-header">
            <h2>Income Tracking</h2>
            <div class="income-summary">
              <span class="income-total">Total: <span id="incomeTotalDisplay" class="mono">0.00 EUR</span></span>
              <span class="income-count">(<span id="incomeCountDisplay">0</span> entries)</span>
            </div>
          </div>

          <div class="income-controls">
            <div class="income-filters">
              <select id="incomeSortBy" onchange="renderIncomeList()">
                <option value="date-desc">Newest First</option>
                <option value="date-asc">Oldest First</option>
                <option value="amount-desc">Highest Amount</option>
                <option value="amount-asc">Lowest Amount</option>
                <option value="client-asc">Client A-Z</option>
              </select>
              <input type="text" id="incomeFilterText" placeholder="Filter by client or invoice..." oninput="renderIncomeList()">
            </div>
            <button type="button" class="add-btn" data-permission="create" data-permission-type="income" onclick="openIncomeDialog()">+ Add Income</button>
          </div>

          <div id="incomeList" class="income-list">
            <!-- Income entries rendered here -->
          </div>
        </section>

        <!-- CLIENTS TAB (Phase 15) -->
        <section class="tab-panel panel-clients">
          <div class="clients-header">
            <h2>Clients</h2>
            <div class="clients-actions">
              <button id="add-client-btn" class="add-btn" data-permission="create" data-permission-type="client">
                + New Client
              </button>
            </div>
          </div>

          <div class="clients-filters">
            <input type="text" id="client-search" class="search-input" placeholder="Search by name, tax ID...">
            <select id="client-country-filter" class="filter-select">
              <option value="">All countries</option>
              <option value="ES">Spain</option>
              <option value="BE">Belgium</option>
              <option value="NL">Netherlands</option>
              <option value="DE">Germany</option>
              <option value="FR">France</option>
              <option value="IT">Italy</option>
              <option value="PT">Portugal</option>
              <option value="GB">United Kingdom</option>
              <option value="US">United States</option>
            </select>
            <label class="filter-checkbox">
              <input type="checkbox" id="client-active-filter">
              Only with active projects
            </label>
          </div>

          <div id="client-list" class="client-list">
            <!-- Populated by ClientListUI -->
          </div>

          <div id="client-empty-state" class="clients-empty-state hidden">
            <p>No clients yet. Create your first client to get started.</p>
          </div>

          <!-- Client Detail View (replaces list when viewing detail) -->
          <div id="client-detail-view" class="detail-view hidden">
            <button class="back-btn" id="client-back-btn">&larr; Back to clients</button>

            <div class="client-detail-header">
              <div class="client-detail-main">
                <span class="client-detail-flag" id="detail-flag"></span>
                <div class="client-detail-info">
                  <h2 id="detail-name"></h2>
                  <div class="client-detail-meta">
                    <span id="detail-tax-id" class="tax-id-badge"></span>
                    <span id="detail-category" class="category-badge"></span>
                    <span id="detail-vies-status" class="vies-badge hidden"></span>
                  </div>
                </div>
              </div>
              <div class="client-detail-summary">
                <div class="summary-item">
                  <span class="summary-label">Total invoiced</span>
                  <span class="summary-value" id="detail-total-invoiced">0,00 EUR</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Outstanding</span>
                  <span class="summary-value" id="detail-outstanding">0,00 EUR</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Profit</span>
                  <span class="summary-value" id="detail-profit">0,00 EUR</span>
                </div>
              </div>
              <div class="client-detail-actions">
                <button class="btn btn-secondary" id="edit-client-btn" data-permission="edit">Edit</button>
                <button class="btn btn-danger" id="archive-client-btn" data-permission="delete">Archive</button>
              </div>
            </div>

            <div class="client-detail-tabs">
              <button class="detail-tab active" data-detail-tab="contacts">Contacts</button>
              <button class="detail-tab" data-detail-tab="projects">Projects</button>
              <button class="detail-tab" data-detail-tab="invoices">Invoices</button>
              <button class="detail-tab" data-detail-tab="expenses">Expenses</button>
              <button class="detail-tab" data-detail-tab="calendar">Calendar</button>
            </div>

            <div id="detail-contacts-panel" class="detail-panel">
              <div class="panel-header">
                <h3>Contacts</h3>
                <button class="btn btn-small" id="add-contact-btn" data-permission="create">+ Contact</button>
              </div>
              <div id="contacts-list" class="contacts-list"></div>
              <div id="contacts-empty" class="empty-state hidden">
                <p>No contacts. Add a contact for this client.</p>
              </div>
            </div>

            <div id="detail-projects-panel" class="detail-panel hidden">
              <div class="panel-header">
                <h3>Projects</h3>
                <button class="btn btn-small" id="add-project-btn" data-permission="create">+ Project</button>
              </div>
              <div id="projects-list" class="projects-list"></div>
              <div id="projects-empty" class="empty-state hidden">
                <p>No projects. Create a project for this client.</p>
              </div>
            </div>

            <div id="detail-invoices-panel" class="detail-panel hidden">
              <div id="client-invoices-header" class="panel-header" style="margin-bottom: 0.5rem;">
                <h3>Invoices</h3>
                <span id="client-invoices-count" class="text-dim" style="margin-left: 0.5rem;"></span>
                <button class="btn btn-small btn-primary" data-permission="create" onclick="createInvoiceForClient()" style="margin-left: auto;">+ Invoice</button>
              </div>
              <div id="client-invoices-list"></div>
              <div id="client-invoices-empty" class="empty-state hidden">
                <p>No invoices for this client yet.</p>
              </div>
            </div>

            <div id="detail-expenses-panel" class="detail-panel hidden">
              <div class="panel-header">
                <h3>Linked Expenses</h3>
              </div>
              <div id="expenses-list" class="expenses-list">
                <p class="coming-soon">No expenses linked to this client yet.</p>
              </div>
            </div>

            <div id="detail-calendar-panel" class="detail-panel hidden">
              <div class="panel-header">
                <h3>Days worked</h3>
              </div>
              <div id="client-mini-calendar" class="mini-calendar">
                <p class="coming-soon">Client calendar will be available in phase 16.</p>
              </div>
            </div>
          </div>
        </section>

        <!-- COMPLIANCE TAB -->
        <section class="tab-panel panel-compliance" id="compliancePanel">
          <!-- Content populated by renderComplianceContent() -->
        </section>

      </div><!-- end .tab-panels -->

      <!-- Phase 14-03: Profile Section (shown via user menu) -->
      <div id="profile-tab" class="profile-tab-content">
        <div class="profile-section">
          <div class="profile-header">
            <div class="profile-avatar-large" id="profile-avatar">?</div>
            <div class="profile-info">
              <h2 id="profile-display-name">User</h2>
              <p id="profile-email">user@example.com</p>
            </div>
          </div>

          <form class="profile-form" onsubmit="ProfileUI.save(event)">
            <div class="profile-field">
              <label for="profile-name">Full Name</label>
              <input type="text" id="profile-name" placeholder="Your full name">
            </div>

            <div class="profile-field">
              <label for="profile-nif">NIF/CIF</label>
              <input type="text" id="profile-nif" placeholder="12345678A">
            </div>

            <div class="profile-field">
              <label for="profile-phone">Phone</label>
              <input type="tel" id="profile-phone" placeholder="+34 600 000 000">
            </div>

            <div class="profile-field">
              <label for="profile-address">Address</label>
              <input type="text" id="profile-address" placeholder="Street, City, Postal Code">
            </div>

            <!-- 2FA Settings - Phase 14-04 -->
            <div class="profile-field" id="profile-2fa-section">
              <label>Two-Factor Authentication</label>
              <div id="profile-2fa-status" style="display: flex; align-items: center; gap: 12px; margin-top: 8px;">
                <span id="profile-2fa-text">Loading...</span>
                <button type="button" id="profile-2fa-btn" class="auth-link" onclick="ProfileUI.toggle2FA()">
                  Enable
                </button>
              </div>
            </div>

            <div class="profile-actions">
              <button type="submit" class="profile-save-btn">Save Changes</button>
            </div>

            <div id="profile-message" class="auth-message" style="display: none;"></div>
          </form>

          <!-- Phase 14-05: Entity Sharing Section (PERM-01 through PERM-05) -->
          <div id="sharing-section" class="sharing-section" style="display: none;">
            <div class="sharing-header">
              <h4>Team Access</h4>
              <button id="sharing-invite-btn" class="sharing-invite-btn" data-permission="invite" onclick="InviteUI.openModal()">
                + Invite User
              </button>
            </div>
            <div id="sharing-list" class="sharing-list">
              <!-- Populated by SharingUI.load() -->
            </div>
          </div>
        </div>
      </div>

      <!-- Global Disclaimer Footer (COMP-08) -->
      <footer class="global-disclaimer" id="globalDisclaimer">
        <p>
          <strong>Disclaimer:</strong> This calculator provides estimates for informational and educational purposes only.
          It does not constitute tax, legal, or financial advice. Tax laws are complex, subject to change, and vary by
          individual circumstances. Your actual tax liability may differ from these estimates. Always consult with a
          qualified tax professional (asesor fiscal, gestor) for guidance specific to your situation before making any
          financial decisions or filing tax returns.
        </p>
      </footer>
    </div><!-- end .dashboard -->

    <!-- Edit Scenario Modal -->
    <dialog id="editScenarioDialog" aria-labelledby="dialogTitle">
      <form method="dialog" class="edit-form">
        <header class="dialog-header">
          <h2 id="dialogTitle">Edit Scenario</h2>
          <button type="button" class="dialog-close" aria-label="Close" onclick="closeEditModal()">x</button>
        </header>

        <div class="dialog-body">
          <!-- Input pane (left) -->
          <div class="input-pane">
            <div class="form-group">
              <label for="editScenarioName">Scenario Name</label>
              <input type="text" id="editScenarioName" required autofocus>
            </div>

            <h3>Income & Expenses</h3>
            <div class="form-group">
              <label for="editMonthlyRevenue">Monthly Revenue (EUR)</label>
              <input type="number" id="editMonthlyRevenue" min="0" step="100">
            </div>
            <div class="form-group">
              <label for="editMonthlyExpenses">Monthly Expenses (EUR)</label>
              <input type="number" id="editMonthlyExpenses" min="0" step="100">
            </div>
            <div class="form-group">
              <label for="editWorkTravelCost">Work Travel Cost (EUR/month)</label>
              <input type="number" id="editWorkTravelCost" min="0" step="100" placeholder="e.g., 1000 or 2500">
            </div>
            <div class="form-group checkbox-group">
              <input type="checkbox" id="editHasDescendant">
              <label for="editHasDescendant">1 Dependent Child (adds 2,400 EUR minimo)</label>
            </div>

            <details class="fiscal-overrides">
              <summary>Fiscal Overrides (What-If Analysis)</summary>
              <div class="form-group">
                <label for="editRetaOverride">RETA Monthly (EUR)</label>
                <input type="number" id="editRetaOverride" placeholder="428.40" min="0" step="0.01">
              </div>
              <div class="form-group">
                <label for="editMinimoPersonalOverride">Minimo Personal (EUR)</label>
                <input type="number" id="editMinimoPersonalOverride" placeholder="5550" min="0" step="1">
              </div>
              <div class="form-group">
                <label for="editMinimoDescOverride">Minimo Descendientes (EUR)</label>
                <input type="number" id="editMinimoDescOverride" placeholder="2400" min="0" step="1">
              </div>
            </details>
          </div>

          <!-- Results pane (right) - live updating -->
          <div class="results-pane">
            <h3>Calculated Results</h3>
            <div id="liveEditResults">
              <!-- Populated by updateLiveResults() -->
            </div>
          </div>
        </div>

        <footer class="dialog-footer">
          <button type="button" id="deleteScenarioBtn" class="danger-btn" data-permission="delete" data-permission-type="scenario" onclick="confirmDeleteScenario()">Delete</button>
          <div class="spacer"></div>
          <button type="button" class="secondary-btn" onclick="closeEditModal()">Cancel</button>
          <button type="submit" value="save" class="primary-btn">Save Changes</button>
        </footer>
      </form>
    </dialog>

    <!-- Detail Modal for Scenario Breakdown (UI-04) -->
    <dialog id="detail-modal" class="detail-dialog">
      <div class="detail-content">
        <header class="detail-header">
          <h2 class="detail-title">Scenario Details</h2>
          <button class="close-btn" onclick="closeDetailModal()">&times;</button>
        </header>
        <div class="detail-body" id="detail-body">
          <!-- Populated by openDetailModal() -->
        </div>
        <footer class="detail-footer">
          <button class="secondary-btn" onclick="closeDetailModal()">Close</button>
          <button class="primary-btn" onclick="editFromDetail()">Edit Scenario</button>
        </footer>
      </div>
    </dialog>

    <!-- Template Selection Dialog for New Scenario -->
    <dialog id="templateSelectDialog" aria-labelledby="templateDialogTitle">
      <form method="dialog">
        <header class="dialog-header">
          <h2 id="templateDialogTitle">Create New Scenario</h2>
          <button type="button" class="dialog-close" aria-label="Close" onclick="closeTemplateDialog()">x</button>
        </header>

        <div style="padding: 1.5rem;">
          <div class="form-group">
            <label for="newScenarioName">Scenario Name (required)</label>
            <input type="text" id="newScenarioName" required placeholder="e.g., Aggressive Growth">
          </div>

          <h3 style="margin-top: 1rem; font-size: 0.95rem;">Copy values from:</h3>
          <div class="template-options" id="templateOptions">
            <!-- Populated by showTemplateDialog() -->
          </div>
        </div>

        <footer class="dialog-footer">
          <div class="spacer"></div>
          <button type="button" class="secondary-btn" onclick="closeTemplateDialog()">Cancel</button>
          <button type="submit" value="create" class="primary-btn">Create Scenario</button>
        </footer>
      </form>
    </dialog>

    <!-- Contracted Pattern Wizard Dialog -->
    <dialog id="contractedWizardDialog">
      <div class="dialog-header">
        <h2>Apply Contracted Pattern?</h2>
        <button type="button" class="dialog-close" onclick="declineContractedPattern()">x</button>
      </div>
      <div style="padding: 1.5rem;">
        <p>Pre-fill calendar with your contracted work pattern?</p>
        <ul style="opacity: 0.8; margin: 1rem 0;">
          <li>Monday and Tuesday every week</li>
          <li>Wednesday-Friday of first week each month</li>
        </ul>
        <p style="font-size: 0.9rem; opacity: 0.7;">
          Belgian holidays are NOT auto-filled. You can override any day later.
        </p>
      </div>
      <div class="dialog-footer">
        <div class="spacer"></div>
        <button class="secondary-btn" onclick="declineContractedPattern()">Skip</button>
        <button class="primary-btn" onclick="applyContractedPattern()">Apply Pattern</button>
      </div>
    </dialog>

    <!-- Day Picker Dialog (Single Day Status) -->
    <dialog id="dayPickerDialog">
      <div class="dialog-header">
        <h2 id="pickerDateDisplay">February 15, 2026</h2>
        <button type="button" class="dialog-close" onclick="closeDayPicker()">x</button>
      </div>
      <div style="padding: 1.5rem;">
        <p id="pickerContracted" style="opacity: 0.7; margin-bottom: 1rem;"></p>

        <div class="status-options">
          <label class="status-option">
            <input type="radio" name="dayStatus" value="belgium">
            <span class="status-emoji-large">&#x1F1E7;&#x1F1EA;</span>
            <span>Belgium</span>
          </label>
          <label class="status-option">
            <input type="radio" name="dayStatus" value="spain">
            <span class="status-emoji-large">&#x1F1EA;&#x1F1F8;</span>
            <span>Spain</span>
          </label>
          <label class="status-option">
            <input type="radio" name="dayStatus" value="travel">
            <span class="status-emoji-large">&#x2708;&#xFE0F;</span>
            <span>Travel</span>
          </label>
          <label class="status-option">
            <input type="radio" name="dayStatus" value="unset">
            <span class="status-emoji-large">&#x26AA;</span>
            <span>Unset</span>
          </label>
        </div>

        <div class="picker-counts" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
          <p id="pickerMonthCount" style="opacity: 0.8;"></p>
          <p id="pickerAnnualCount" style="opacity: 0.8;"></p>
        </div>
      </div>
      <div class="dialog-footer">
        <div class="spacer"></div>
        <button class="secondary-btn" onclick="closeDayPicker()">Cancel</button>
        <button class="primary-btn" onclick="saveDayStatus()">Save</button>
      </div>
    </dialog>

    <!-- Bulk Picker Dialog (Multiple Days Status) -->
    <dialog id="bulkPickerDialog">
      <div class="dialog-header">
        <h2>Set Status for <span id="bulkCount">5</span> Days</h2>
        <button type="button" class="dialog-close" onclick="closeBulkPicker()">x</button>
      </div>
      <div style="padding: 1.5rem;">
        <p style="opacity: 0.7; margin-bottom: 1rem;">Apply status to all selected days:</p>
        <div class="status-options">
          <label class="status-option">
            <input type="radio" name="bulkStatus" value="belgium">
            <span class="status-emoji-large">&#x1F1E7;&#x1F1EA;</span>
            <span>Belgium</span>
          </label>
          <label class="status-option">
            <input type="radio" name="bulkStatus" value="spain">
            <span class="status-emoji-large">&#x1F1EA;&#x1F1F8;</span>
            <span>Spain</span>
          </label>
          <label class="status-option">
            <input type="radio" name="bulkStatus" value="travel">
            <span class="status-emoji-large">&#x2708;&#xFE0F;</span>
            <span>Travel</span>
          </label>
          <label class="status-option">
            <input type="radio" name="bulkStatus" value="unset">
            <span class="status-emoji-large">&#x26AA;</span>
            <span>Unset</span>
          </label>
        </div>
      </div>
      <div class="dialog-footer">
        <div class="spacer"></div>
        <button class="secondary-btn" onclick="closeBulkPicker()">Cancel</button>
        <button class="primary-btn" onclick="saveBulkStatus()">Apply to All</button>
      </div>
    </dialog>

    <!-- Income Entry Dialog (Phase 8 - ENH-02) -->
    <dialog id="incomeDialog" class="modal-dialog">
      <form id="incomeForm" onsubmit="saveIncomeEntry(event)">
        <div class="dialog-header">
          <h3 id="incomeDialogTitle">Add Income Entry</h3>
          <button type="button" class="dialog-close" onclick="closeIncomeDialog()">x</button>
        </div>

        <div style="padding: var(--spacing-md);">
          <div class="form-group">
            <label for="incomeClient">Client Name *</label>
            <input type="text" id="incomeClient" name="clientName" required>
          </div>

          <div class="form-group">
            <label for="incomeInvoice">Invoice Number</label>
            <input type="text" id="incomeInvoice" name="invoiceNumber" placeholder="INV-2026-001">
          </div>

          <div class="form-group">
            <label for="incomeAmount">Amount (EUR) *</label>
            <input type="number" id="incomeAmount" name="amount" step="0.01" min="0" required>
          </div>

          <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
            <div class="form-group">
              <label for="incomeDateInvoiced">Date Invoiced</label>
              <input type="date" id="incomeDateInvoiced" name="dateInvoiced">
            </div>
            <div class="form-group">
              <label for="incomeDateReceived">Date Received *</label>
              <input type="date" id="incomeDateReceived" name="dateReceived" required>
            </div>
          </div>

          <div class="form-group">
            <label for="incomeDescription">Description</label>
            <textarea id="incomeDescription" name="description" rows="2" placeholder="IT Consulting - January 2026" style="width: 100%; resize: vertical;"></textarea>
          </div>

          <div class="form-group">
            <label for="incomeStatus">Status</label>
            <select id="incomeStatus" name="status">
              <option value="paid">Paid</option>
              <option value="pending">Pending</option>
              <option value="overdue">Overdue</option>
            </select>
          </div>

          <input type="hidden" id="incomeEditId" name="editId">
        </div>

        <div class="dialog-footer">
          <button type="button" class="secondary-btn" onclick="closeIncomeDialog()">Cancel</button>
          <button type="submit" class="primary-btn">Save</button>
        </div>
      </form>
    </dialog>

    <!-- Tooltip Modal (single instance, reused for all tooltips) -->
    <dialog id="tooltipModal" class="tooltip-modal">
      <div class="tooltip-modal-content">
        <h3 id="tooltipModalTitle" class="tooltip-modal-title"></h3>
        <p id="tooltipModalText" class="tooltip-modal-text"></p>
        <button type="button" class="tooltip-modal-close" autofocus onclick="closeTooltipModal()">Got it</button>
      </div>
    </dialog>

    <!-- Invoice Form Dialog -->
    <dialog id="invoiceDialog" class="invoice-dialog">
      <div class="dialog-header">
        <h2 id="invoiceDialogTitle">New Invoice</h2>
        <button type="button" class="dialog-close" onclick="closeInvoiceForm()">x</button>
      </div>
      <div class="invoice-dialog-body">
        <!-- Meta Fields Row -->
        <div class="invoice-meta-row">
          <div class="form-group">
            <label for="invoiceClient">Client *</label>
            <select id="invoiceClient" onchange="handleInvoiceClientChange()" required>
              <option value="">Select client...</option>
            </select>
          </div>
          <div class="form-group">
            <label for="invoiceDate">Issue Date *</label>
            <input type="date" id="invoiceDate" required>
          </div>
          <div class="form-group">
            <label for="invoiceDueDate">Due Date</label>
            <input type="date" id="invoiceDueDate">
          </div>
        </div>

        <div class="invoice-meta-row">
          <div class="form-group">
            <label for="invoiceCurrency">Currency</label>
            <select id="invoiceCurrency" onchange="handleInvoiceCurrencyChange()">
              <option value="EUR">EUR</option>
              <option value="USD">USD</option>
              <option value="GBP">GBP</option>
            </select>
          </div>
          <div class="form-group" id="exchangeRateGroup" style="display: none;">
            <label for="invoiceExchangeRate">Exchange Rate (to EUR)</label>
            <input type="number" id="invoiceExchangeRate" step="0.0001" min="0" value="1">
            <button class="btn btn-small" onclick="fetchExchangeRateForInvoice()">Fetch Rate</button>
          </div>
          <div class="form-group" id="irpfGroup" style="display: none;">
            <label for="invoiceIrpf">IRPF Retention</label>
            <select id="invoiceIrpf" onchange="recalculateInvoiceFormTotals()">
              <option value="0">None</option>
              <option value="15">15% (standard)</option>
              <option value="7">7% (first 3 years)</option>
            </select>
          </div>
        </div>

        <!-- IVA Treatment Info -->
        <div id="invoiceIvaTreatment" class="iva-treatment-info" style="display: none;"></div>

        <!-- Auto-populate from Calendar -->
        <div id="calendarPopulateSection" class="calendar-populate-section" style="display: none;">
          <button class="btn btn-small" onclick="openCalendarPopulate()">Populate from Calendar Days</button>
          <span id="calendarPopulateInfo" class="populate-info"></span>
        </div>

        <!-- Line Items -->
        <div class="invoice-line-items-section">
          <h3>Line Items</h3>
          <table class="invoice-line-items-table">
            <thead>
              <tr>
                <th>Description</th>
                <th class="text-right" style="width:70px">Qty</th>
                <th class="text-right" style="width:100px">Unit Price</th>
                <th class="text-right" style="width:80px">IVA %</th>
                <th class="text-right" style="width:100px">Total</th>
                <th style="width:40px"></th>
              </tr>
            </thead>
            <tbody id="invoiceLineItemsBody"></tbody>
          </table>
          <div class="line-items-actions">
            <button class="btn btn-small" onclick="addInvoiceLineItem()">+ Add Line</button>
            <button class="btn btn-small" id="addFromExpenseBtn" onclick="openExpenseSelector()" style="display: none;">+ From Expense</button>
            <button class="btn btn-small" id="addFromProjectBtn" onclick="addLineFromProject()" style="display: none;">+ From Project</button>
          </div>
        </div>

        <!-- Discount -->
        <div class="invoice-discount-row">
          <label>Discount:</label>
          <select id="invoiceDiscountType" onchange="handleDiscountTypeChange()">
            <option value="">None</option>
            <option value="percentage">Percentage (%)</option>
            <option value="fixed">Fixed Amount</option>
          </select>
          <input type="number" id="invoiceDiscountValue" value="0" min="0" step="0.01" oninput="recalculateInvoiceFormTotals()" style="display: none;">
        </div>

        <!-- Totals -->
        <div class="invoice-totals-section">
          <div class="totals-row"><span>Subtotal:</span><span id="invoiceFormSubtotal" class="mono">0.00</span></div>
          <div class="totals-row" id="discountRow" style="display: none;"><span>Discount:</span><span id="invoiceFormDiscount" class="mono">-0.00</span></div>
          <div class="totals-row"><span id="invoiceIvaLabel">IVA (21%):</span><span id="invoiceFormIva" class="mono">0.00</span></div>
          <div class="totals-row" id="irpfRow" style="display: none;"><span id="invoiceIrpfLabel">IRPF (15%):</span><span id="invoiceFormIrpf" class="mono">-0.00</span></div>
          <div class="totals-row totals-total"><span>TOTAL:</span><span id="invoiceFormTotal" class="mono">0.00</span></div>
        </div>

        <!-- Notes -->
        <div class="form-group">
          <label for="invoiceNotes">Notes / Payment Terms</label>
          <textarea id="invoiceNotes" rows="3" placeholder="Bank details, payment terms..."></textarea>
        </div>

        <!-- Dialog Actions -->
        <div class="dialog-actions">
          <button class="btn" onclick="closeInvoiceForm()">Cancel</button>
          <button class="btn btn-primary" id="saveInvoiceBtn" data-permission="create" onclick="handleSaveInvoice()">Save Draft</button>
        </div>
      </div>
    </dialog>

    <!-- Calendar Populate Dialog -->
    <dialog id="calendarPopulateDialog" class="invoice-dialog" style="max-width: 500px;">
      <div class="dialog-header">
        <h2>Populate from Calendar</h2>
        <button type="button" class="dialog-close" onclick="document.getElementById('calendarPopulateDialog').close()">x</button>
      </div>
      <div style="padding: 1.5rem;">
        <div class="form-group">
          <label for="calPopProject">Project</label>
          <select id="calPopProject"></select>
        </div>
        <div class="form-group">
          <label for="calPopStartDate">Start Date</label>
          <input type="date" id="calPopStartDate">
        </div>
        <div class="form-group">
          <label for="calPopEndDate">End Date</label>
          <input type="date" id="calPopEndDate">
        </div>
        <div id="calPopPreview" class="calendar-pop-preview"></div>
        <div class="dialog-actions">
          <button class="btn" onclick="document.getElementById('calendarPopulateDialog').close()">Cancel</button>
          <button class="btn btn-primary" onclick="handleCalendarPopulate()">Add Line Item</button>
        </div>
      </div>
    </dialog>

    <!-- Rectificativa Dialog -->
    <dialog id="rectificativaDialog" class="invoice-dialog" style="max-width: 500px;">
      <div class="dialog-header">
        <h2>Create Factura Rectificativa</h2>
        <button type="button" class="dialog-close" onclick="document.getElementById('rectificativaDialog').close()">x</button>
      </div>
      <div style="padding: 1.5rem;">
        <p id="rectOriginalRef" class="rect-original-ref"></p>
        <div class="form-group">
          <label for="rectReason">Correction Reason *</label>
          <select id="rectReason" required>
            <option value="">Select reason...</option>
            <option value="error_datos_fiscales">Error in fiscal data</option>
            <option value="modificacion_base">Modification of taxable base</option>
            <option value="descuento_posterior">Subsequent discount</option>
            <option value="devolucion_envases">Return of packaging</option>
            <option value="impago_concurso">Non-payment (insolvency)</option>
            <option value="otros">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label for="rectDescription">Description</label>
          <textarea id="rectDescription" rows="3" placeholder="Describe the correction..."></textarea>
        </div>
        <div class="dialog-actions">
          <button class="btn" onclick="document.getElementById('rectificativaDialog').close()">Cancel</button>
          <button class="btn btn-primary" onclick="handleSubmitRectificativa()">Create Rectificativa</button>
        </div>
      </div>
    </dialog>

    <!-- Email Invoice Dialog (18-07) -->
    <dialog id="emailInvoiceDialog" class="invoice-dialog" style="max-width: 500px;">
      <div class="dialog-header">
        <h2>Email Invoice</h2>
        <button type="button" class="dialog-close" onclick="document.getElementById('emailInvoiceDialog').close()">x</button>
      </div>
      <div style="padding: 1.5rem;">
        <div class="form-group">
          <label for="emailTo">To *</label>
          <input type="email" id="emailTo" required placeholder="client@company.com">
        </div>
        <div class="form-group">
          <label for="emailCc">CC</label>
          <input type="email" id="emailCc" placeholder="copy@company.com">
        </div>
        <div class="form-group">
          <label for="emailSubject">Subject</label>
          <input type="text" id="emailSubject">
        </div>
        <div class="form-group">
          <label for="emailBody">Message</label>
          <textarea id="emailBody" rows="6" style="font-family: inherit; resize: vertical;"></textarea>
        </div>
        <p class="text-dim" style="font-size: 0.8rem; margin-top: 0.5rem;">PDF will be attached automatically.</p>
        <div id="emailStatusMsg" style="display: none; padding: 0.75rem; border-radius: 4px; margin-top: 0.75rem; font-size: 0.85rem;"></div>
        <div class="dialog-actions">
          <button class="btn" onclick="document.getElementById('emailInvoiceDialog').close()">Cancel</button>
          <button class="btn btn-primary" id="sendEmailBtn" onclick="handleSendInvoiceEmail()">Send Email</button>
        </div>
      </div>
    </dialog>
  </div>
  <script>
    // ============================================================
    // DEBUG FLAG  Set to true to enable verbose console.log output
    // ============================================================
    const DEBUG = false;

    // ============================================================
    // TOAST NOTIFICATION SYSTEM
    // ============================================================
    function showToast(message, type = 'info', duration = 5000) {
      const container = document.getElementById('toast-container');
      if (!container) return;
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      toast.addEventListener('click', () => dismissToast(toast));
      container.appendChild(toast);
      if (duration > 0) {
        setTimeout(() => dismissToast(toast), duration);
      }
    }
    function dismissToast(toast) {
      if (toast.classList.contains('toast-out')) return;
      toast.classList.add('toast-out');
      toast.addEventListener('animationend', () => toast.remove());
    }

    // ============================================================
    // BROWSER COMPATIBILITY CHECK
    // ============================================================
    // Check for required browser features
    (function() {
      const requiredFeatures = [
        { name: 'dialog', test: () => typeof HTMLDialogElement !== 'undefined' },
        { name: 'localStorage', test: () => {
          try {
            localStorage.setItem('test', 'test');
            localStorage.removeItem('test');
            return true;
          } catch (e) {
            return false; // Private mode - app still works, just no persistence
          }
        }},
        { name: 'structuredClone', test: () => typeof structuredClone === 'function' }
      ];

      const missing = requiredFeatures.filter(f => !f.test()).map(f => f.name);

      // Dialog is critical - show warning if missing
      if (missing.includes('dialog')) {
        console.warn('Your browser does not support the <dialog> element. Please use a modern browser (Chrome 37+, Firefox 98+, Safari 15.4+, Edge 79+) for the best experience.');
      }

      // Polyfill structuredClone if missing (older Safari)
      if (typeof structuredClone === 'undefined') {
        window.structuredClone = function(obj) {
          return JSON.parse(JSON.stringify(obj));
        };
      }
    })();

    // ============================================================
    // FISCAL_2025 CONSTANTS
    // ============================================================
    // All fiscal data verified from official AEAT/BOE sources
    // See: .planning/research/FISCAL_DATA.md for full citations
    // ============================================================

    const FISCAL_2025 = Object.freeze({
      // IRPF Brackets - Combined estatal + autonomica rates
      // Source: Wolters Kluwer, AEAT - unchanged from 2024
      // https://www.wolterskluwer.com/es-es/expert-insights/tramos-retenciones-irpf-2025-novedades
      //
      // baseTax = cumulative tax from all lower brackets
      // prevLimit = upper boundary of previous bracket
      IRPF_BRACKETS: Object.freeze([
        { upTo: 12450, rate: 0.19, baseTax: 0, prevLimit: 0 },
        { upTo: 20200, rate: 0.24, baseTax: 2365.50, prevLimit: 12450 },
        { upTo: 35200, rate: 0.30, baseTax: 4225.50, prevLimit: 20200 },
        { upTo: 60000, rate: 0.37, baseTax: 8725.50, prevLimit: 35200 },
        { upTo: 300000, rate: 0.45, baseTax: 17901.50, prevLimit: 60000 },
        { upTo: Infinity, rate: 0.47, baseTax: 125901.50, prevLimit: 300000 }
      ]),

      // Personal/Family minimums
      // Source: AEAT Manual Practico IRPF 2024
      // https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2024/c14-adecuacion-impuesto-circunstancias-personales/cuadro-resumen-minimo-personal-familiar.html
      MINIMO_PERSONAL: 5550,
      MINIMO_DESCENDIENTES_PRIMERO: 2400,

      // Fixed RETA from user registration
      // This is the actual cuota paid, not a calculated value
      // Source: User's Seguridad Social registration document
      RETA_MONTHLY: 428.40,
      RETA_ANNUAL: 5140.80,

      // Expenses dificil justificacion (Estimacion Directa Simplificada)
      // Source: AEAT Estimacion Directa Simplificada
      // https://sede.agenciatributaria.gob.es/Sede/irpf/empresarios-individuales-profesionales/regimenes-determinar-rendimiento-actividad/estimacion-directa-simplificada.html
      // Note: Was 7% in 2023, reverted to 5% for 2024 onwards
      GASTOS_DIFICIL_RATE: 0.05,
      GASTOS_DIFICIL_MAX: 2000,

      // Private costs (fixed, not deductible)
      // Breakdown: Rent 70% (808.50) + GSM 50% (27.50) + Electricity 91% (91) + Auto (600) + Insurance (200)
      PRIVATE_COSTS_MONTHLY: 1727
    });

    // ============================================================
    // OFFICIAL SOURCE CITATIONS
    // ============================================================
    // All fiscal data traced to official AEAT/BOE/Seguridad Social sources
    // ============================================================

    // ============================================================
    // CALENDAR CONSTANTS
    // ============================================================
    // Data structures for Belgium presence calendar (Feb-Dec 2026)
    // ============================================================

    const CALENDAR_STORAGE_KEY = 'autonomo_calendar_v1';

    const DAY_STATUS = Object.freeze({
      UNSET: 'unset',
      BELGIUM: 'belgium',
      SPAIN: 'spain',
      TRAVEL: 'travel'
    });

    /**
     * CALENDAR_RANGE - Define valid date ranges for each supported year
     * 2026: Feb-Dec (first year of tracking, starting after project inception)
     * 2027: Full year (complete fiscal year)
     */
    const CALENDAR_RANGE = Object.freeze({
      2026: { startMonth: 1, endMonth: 11 },  // Feb-Dec (0-indexed)
      2027: { startMonth: 0, endMonth: 11 }   // Jan-Dec (0-indexed)
    });

    const DEFAULT_CALENDAR_STATE = Object.freeze({
      version: 2,  // Incremented for multi-year support
      year: 2026,
      currentYear: 2026,  // Track year independently for navigation
      startMonth: 1,  // February (0-indexed) - legacy compatibility
      endMonth: 11,   // December (0-indexed) - legacy compatibility
      days: {},       // { "2026-02-15": { status: "belgium", contracted: true } }
      contractedPatternApplied: false,
      lastModified: null,
      currentMonth: 1  // February (0-indexed) - for navigation
    });

    // ============================================================
    // CALENDAR STATE MANAGEMENT
    // ============================================================
    // localStorage persistence for calendar state
    // ============================================================

    /**
     * Convert Date to ISO date key string (YYYY-MM-DD)
     * @param {Date} date - Date object
     * @returns {string} - ISO date string like "2026-02-15"
     */
    function toISODateKey(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    /**
     * Load calendar state from localStorage
     * Falls back to DEFAULT_CALENDAR_STATE on error or invalid data
     * Handles version migration (v1 -> v2)
     * @returns {object} - Calendar state object (mutable clone)
     */
    function loadCalendarState() {
      try {
        const stored = localStorage.getItem(CALENDAR_STORAGE_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);

          // Handle v1 -> v2 migration (add currentYear)
          if (parsed && parsed.version === 1) {
            parsed.version = 2;
            parsed.currentYear = parsed.year || 2026;
            // Update month bounds if needed
            const yearRange = CALENDAR_RANGE[parsed.currentYear];
            if (yearRange) {
              // Ensure currentMonth is within valid range for current year
              if (parsed.currentMonth < yearRange.startMonth) {
                parsed.currentMonth = yearRange.startMonth;
              } else if (parsed.currentMonth > yearRange.endMonth) {
                parsed.currentMonth = yearRange.endMonth;
              }
            }
            return parsed;
          }

          // v2 state - return as-is
          if (parsed && parsed.version === 2) {
            return parsed;
          }
        }
      } catch (e) {
        console.warn('localStorage calendar load failed:', e.message);
      }
      // Return mutable clone of defaults
      return structuredClone(DEFAULT_CALENDAR_STATE);
    }

    /**
     * Save calendar state to localStorage
     * Updates lastModified timestamp
     * @returns {boolean} - True if save succeeded
     */
    function saveCalendarState() {
      try {
        calendarState.lastModified = new Date().toISOString();
        localStorage.setItem(CALENDAR_STORAGE_KEY, JSON.stringify(calendarState));
        return true;
      } catch (e) {
        if (e.name === 'QuotaExceededError') {
          console.warn('localStorage quota exceeded - calendar state not persisted');
          showToast('Storage full  calendar changes not saved. Clear some data.', 'warning');
        } else {
          console.warn('localStorage calendar save failed:', e.message);
          showToast('Failed to save calendar data.', 'error');
        }
        return false;
      }
    }

    // Global calendar state - initialized from localStorage or defaults
    let calendarState = loadCalendarState();

    // Selection state for bulk operations
    let lastClickedDate = null;
    let selectedDates = new Set();
    let unsavedChanges = false;

    // ============================================================
    // CALENDAR RENDERING FUNCTIONS
    // ============================================================
    // Month grid rendering with navigation for Feb-Dec 2026
    // ============================================================

    /**
     * Get month grid as 2D array of weeks
     * Each week is 7 cells (Date or null for empty padding)
     * Uses Monday-start week alignment
     *
     * @param {number} year - Year (e.g., 2026)
     * @param {number} month - Month (0-indexed, 0=January)
     * @returns {array} - Array of weeks, each week is array of 7 elements
     */
    function getMonthGrid(year, month) {
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const totalDays = lastDay.getDate();

      // Monday-start: convert Sunday=0 to 6, Mon=1 to 0, etc.
      const startOffset = (firstDay.getDay() + 6) % 7;

      const weeks = [];
      let currentWeek = [];

      // Add empty cells for days before month starts
      for (let i = 0; i < startOffset; i++) {
        currentWeek.push(null);
      }

      // Add days of month
      for (let day = 1; day <= totalDays; day++) {
        currentWeek.push(new Date(year, month, day));

        if (currentWeek.length === 7) {
          weeks.push(currentWeek);
          currentWeek = [];
        }
      }

      // Add empty cells to complete last week
      while (currentWeek.length > 0 && currentWeek.length < 7) {
        currentWeek.push(null);
      }
      if (currentWeek.length > 0) {
        weeks.push(currentWeek);
      }

      return weeks;
    }

    /**
     * Get status emoji for a day status
     * @param {string} status - Day status from DAY_STATUS
     * @returns {string} - Emoji character
     */
    function getStatusEmoji(status) {
      switch (status) {
        case DAY_STATUS.BELGIUM: return '\u{1F1E7}\u{1F1EA}'; // Flag Belgium
        case DAY_STATUS.SPAIN: return '\u{1F1EA}\u{1F1F8}'; // Flag Spain
        case DAY_STATUS.TRAVEL: return '\u{2708}\u{FE0F}'; // Airplane
        default: return '';
      }
    }

    /**
     * Check if navigation is allowed to a specific month/year
     * @param {number} year - Target year
     * @param {number} month - Target month (0-indexed)
     * @returns {boolean} True if navigation is allowed
     */
    function isNavigationAllowed(year, month) {
      const yearRange = CALENDAR_RANGE[year];
      if (!yearRange) return false;
      return month >= yearRange.startMonth && month <= yearRange.endMonth;
    }

    /**
     * Check if previous month navigation is possible
     * @returns {boolean} True if can navigate to previous month
     */
    function canNavigatePrev() {
      const currentYear = calendarState.currentYear || calendarState.year;
      const currentMonth = calendarState.currentMonth;

      // First, check within current year
      const yearRange = CALENDAR_RANGE[currentYear];
      if (yearRange && currentMonth > yearRange.startMonth) return true;

      // Then check if can go to previous year
      const prevYear = currentYear - 1;
      const prevYearRange = CALENDAR_RANGE[prevYear];
      return !!prevYearRange;
    }

    /**
     * Check if next month navigation is possible
     * @returns {boolean} True if can navigate to next month
     */
    function canNavigateNext() {
      const currentYear = calendarState.currentYear || calendarState.year;
      const currentMonth = calendarState.currentMonth;

      // First, check within current year
      const yearRange = CALENDAR_RANGE[currentYear];
      if (yearRange && currentMonth < yearRange.endMonth) return true;

      // Then check if can go to next year
      const nextYear = currentYear + 1;
      const nextYearRange = CALENDAR_RANGE[nextYear];
      return !!nextYearRange;
    }

    /**
     * Navigate to different month with year boundary handling
     * Automatically crosses year boundaries when needed
     *
     * @param {number} delta - Direction (-1 for prev, +1 for next)
     */
    async function navigateMonth(delta) {
      let newMonth = calendarState.currentMonth + delta;
      let newYear = calendarState.currentYear || calendarState.year;

      // Handle year rollover
      if (newMonth > 11) {
        newMonth = 0;
        newYear++;
      } else if (newMonth < 0) {
        newMonth = 11;
        newYear--;
      }

      // Check if new position is within allowed range
      const yearRange = CALENDAR_RANGE[newYear];
      if (!yearRange) return;  // Year not supported

      // Clamp to allowed months for the target year
      if (newMonth < yearRange.startMonth) {
        // If going to prev year but landing before valid range, go to end of prev year
        const prevYear = newYear - 1;
        const prevRange = CALENDAR_RANGE[prevYear];
        if (!prevRange) return;  // Can't navigate further back
        newYear = prevYear;
        newMonth = prevRange.endMonth;
      } else if (newMonth > yearRange.endMonth) {
        // If going to next year but landing after valid range, go to start of next year
        const nextYear = newYear + 1;
        const nextRange = CALENDAR_RANGE[nextYear];
        if (!nextRange) return;  // Can't navigate further forward
        newYear = nextYear;
        newMonth = nextRange.startMonth;
      }

      // Apply changes
      calendarState.currentYear = newYear;
      calendarState.year = newYear;  // Keep legacy field in sync
      calendarState.currentMonth = newMonth;

      saveCalendarState();
      await renderCalendarAsync();  // Use async version for IndexedDB
      updateCountDisplaysAsync().catch(() => updateCountDisplays());  // Use async with fallback
    }

    /**
     * Jump directly to a specific year
     * Positions at the first valid month for that year
     *
     * @param {number} year - Target year (e.g., 2026, 2027)
     */
    async function jumpToYear(year) {
      const yearRange = CALENDAR_RANGE[year];
      if (!yearRange) {
        console.warn(`jumpToYear: Year ${year} not supported`);
        return;
      }

      calendarState.currentYear = year;
      calendarState.year = year;  // Keep legacy field in sync

      // Position at first valid month for this year
      const currentMonth = calendarState.currentMonth;
      if (currentMonth < yearRange.startMonth || currentMonth > yearRange.endMonth) {
        calendarState.currentMonth = yearRange.startMonth;
      }

      saveCalendarState();
      await renderCalendarAsync();
      updateCountDisplaysAsync().catch(() => updateCountDisplays());
    }

    /**
     * Render calendar for current month
     * Shows month header with navigation and day grid
     * NOTE: This is the legacy sync version, renderCalendarAsync() is preferred
     */
    function renderCalendar() {
      // Delegate to async version for IndexedDB support
      renderCalendarAsync().catch(err => {
        console.error('renderCalendarAsync failed:', err);
        renderCalendarSync();  // Fallback to sync version
      });
    }

    /**
     * Synchronous fallback calendar render (uses localStorage only)
     * Used when IndexedDB is not available
     */
    function renderCalendarSync() {
      const container = document.getElementById('calendarContainer');
      if (!container) return;

      const year = calendarState.currentYear || calendarState.year;
      const month = calendarState.currentMonth;

      // Get month name with year display
      const monthName = new Intl.DateTimeFormat('en-US', { month: 'long' })
        .format(new Date(year, month, 1));

      // Check navigation bounds using helper functions
      const canPrev = canNavigatePrev();
      const canNext = canNavigateNext();

      // Build year quick-jump buttons
      const yearButtons = Object.keys(CALENDAR_RANGE).map(y => {
        const isActive = parseInt(y) === year;
        return `<button type="button" class="year-jump-btn ${isActive ? 'active' : ''}" onclick="jumpToYear(${y})">${y}</button>`;
      }).join('');

      // Build header with Select All button and year display
      const headerHtml = `
        <div class="calendar-header">
          <button class="nav-btn" onclick="navigateMonth(-1)" ${canPrev ? '' : 'disabled'}>
            &larr; Prev
          </button>
          <div style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
            <div class="year-nav">${yearButtons}</div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <h3 style="margin: 0;">${monthName} ${year}</h3>
              <button type="button" class="month-select-all" onclick="selectMonth(${month})" title="Select all days in ${monthName}">Select All</button>
            </div>
          </div>
          <button class="nav-btn" onclick="navigateMonth(1)" ${canNext ? '' : 'disabled'}>
            Next &rarr;
          </button>
        </div>
      `;

      // Build grid with week selectors
      const weeks = getMonthGrid(year, month);
      const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

      let gridHtml = '<div class="calendar-grid-with-weeks">';

      // Day headers (empty cell for week selector column)
      gridHtml += '<div class="day-header"></div>';
      dayNames.forEach(name => {
        gridHtml += `<div class="day-header">${name}</div>`;
      });

      // Day cells with week selectors
      weeks.forEach((week, weekIndex) => {
        // Find first non-null date in this week to calculate Monday
        const firstDateInWeek = week.find(d => d !== null);
        let weekStartKey = null;

        if (firstDateInWeek) {
          // Calculate the Monday of this week
          const monday = new Date(firstDateInWeek);
          const dayOfWeek = monday.getDay();
          // Adjust to Monday (0=Sunday, so Sunday needs -6, others need 1-dayOfWeek)
          const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
          monday.setDate(monday.getDate() - daysToSubtract);
          weekStartKey = toISODateKey(monday);
        }

        // Week selector button
        if (weekStartKey) {
          gridHtml += `<div class="week-selector-cell"><button type="button" class="week-selector" onclick="selectWeek('${weekStartKey}')" title="Select entire week" aria-label="Select week starting ${weekStartKey}">W</button></div>`;
        } else {
          gridHtml += '<div class="week-selector-cell"></div>';
        }

        // Day cells for this week
        week.forEach(date => {
          if (date === null) {
            gridHtml += '<div class="day-cell empty"></div>';
          } else {
            const dateKey = toISODateKey(date);
            const dayData = calendarState.days[dateKey] || {};
            const status = dayData.status || DAY_STATUS.UNSET;
            const isContracted = dayData.contracted === true;
            const emoji = getStatusEmoji(status);

            const isSelected = selectedDates.has(dateKey);
            gridHtml += `
              <div class="day-cell ${status} ${isSelected ? 'selected' : ''}" data-date="${dateKey}" onclick="handleDayClick('${dateKey}', event)">
                <div class="day-cell-header">
                  <input type="checkbox" class="day-checkbox"
                    ${isSelected ? 'checked' : ''}
                    onchange="toggleDaySelection('${dateKey}', this.checked)"
                    onclick="event.stopPropagation()"
                    aria-label="Select ${date.getDate()}">
                  <span class="day-number">${date.getDate()}</span>
                  ${isContracted ? '<span class="contracted-badge">C</span>' : ''}
                </div>
                <div class="day-status-display">
                  ${emoji ? `<span class="status-emoji">${emoji}</span>` : '<span class="status-empty">-</span>'}
                </div>
              </div>
            `;
          }
        });
      });

      gridHtml += '</div>';

      container.innerHTML = headerHtml + gridHtml;
    }

    // ============================================================
    // CONTRACTED PATTERN FUNCTIONS
    // ============================================================
    // Generate contracted work pattern: Mon-Tue weekly + first-week Wed-Fri
    // ============================================================

    /**
     * Generate contracted work pattern for Feb-Dec 2026
     * Pattern: Monday and Tuesday every week, plus Wed-Fri of first week each month
     *
     * @param {number} year - Year (e.g., 2026)
     * @param {number} startMonth - Start month (0-indexed)
     * @param {number} endMonth - End month (0-indexed)
     * @returns {array} - Array of ISO date strings (contracted days)
     */
    function generateContractedPattern(year, startMonth, endMonth) {
      const contractedDays = [];
      for (let month = startMonth; month <= endMonth; month++) {
        const lastOfMonth = new Date(year, month + 1, 0);
        let isFirstWeek = true;

        for (let day = 1; day <= lastOfMonth.getDate(); day++) {
          const date = new Date(year, month, day);
          const dayOfWeek = date.getDay(); // 0=Sunday, 1=Monday, etc.

          // Monday (1) or Tuesday (2) = always contracted
          if (dayOfWeek === 1 || dayOfWeek === 2) {
            contractedDays.push(toISODateKey(date));
          }

          // First week: Wed(3), Thu(4), Fri(5) also contracted
          if (isFirstWeek && (dayOfWeek === 3 || dayOfWeek === 4 || dayOfWeek === 5)) {
            contractedDays.push(toISODateKey(date));
          }

          // End first week on Sunday (after first full week)
          if (dayOfWeek === 0 && day > 1) {
            isFirstWeek = false;
          }
        }
      }
      return contractedDays;
    }

    /**
     * Show contracted pattern wizard dialog
     * Only shows if contractedPatternApplied is false
     */
    function showContractedWizard() {
      if (calendarState.contractedPatternApplied) {
        return; // Already applied or declined
      }

      const dialog = document.getElementById('contractedWizardDialog');
      if (dialog) {
        dialog.showModal();
      }
    }

    /**
     * Apply contracted pattern to calendar
     * Marks all contracted days as Belgium with contracted flag
     */
    function applyContractedPattern() {
      const contractedDays = generateContractedPattern(
        calendarState.year,
        calendarState.startMonth,
        calendarState.endMonth
      );

      // Mark each contracted day as Belgium + contracted
      contractedDays.forEach(dateKey => {
        calendarState.days[dateKey] = {
          status: DAY_STATUS.BELGIUM,
          contracted: true
        };
      });

      calendarState.contractedPatternApplied = true;
      saveCalendarState();
      renderCalendar();
      updateCountDisplays();  // Update counts after applying pattern

      // Close dialog
      const dialog = document.getElementById('contractedWizardDialog');
      if (dialog) {
        dialog.close();
      }
    }

    /**
     * Decline contracted pattern
     * Sets flag so wizard doesn't appear again
     */
    function declineContractedPattern() {
      calendarState.contractedPatternApplied = true;
      saveCalendarState();

      // Close dialog
      const dialog = document.getElementById('contractedWizardDialog');
      if (dialog) {
        dialog.close();
      }
    }

    /**
     * Toggle selection of a single day
     * @param {string} dateKey - ISO date key (YYYY-MM-DD)
     * @param {boolean} isChecked - Whether checkbox is checked (optional, toggles if not provided)
     */
    function toggleDaySelection(dateKey, isChecked) {
      if (typeof isChecked === 'boolean') {
        if (isChecked) {
          selectedDates.add(dateKey);
        } else {
          selectedDates.delete(dateKey);
        }
      } else {
        // Toggle if no explicit value
        if (selectedDates.has(dateKey)) {
          selectedDates.delete(dateKey);
        } else {
          selectedDates.add(dateKey);
        }
      }
      lastClickedDate = dateKey;
      renderCalendar();
      updateSelectionCount();
    }

    /**
     * Update the selection count display in toolbar
     */
    function updateSelectionCount() {
      const countEl = document.getElementById('selectionCount');
      if (countEl) {
        countEl.textContent = selectedDates.size;
      }
    }

    /**
     * Apply a status to all selected days
     * @param {string} status - Status to apply ('belgium', 'spain', 'travel', 'unset')
     */
    function applyStatusToSelected(status) {
      if (selectedDates.size === 0) {
        return; // Nothing selected
      }

      selectedDates.forEach(dateKey => {
        const existingData = calendarState.days[dateKey] || {};

        if (status === 'unset') {
          if (existingData.contracted) {
            calendarState.days[dateKey] = { status: 'unset', contracted: true };
          } else {
            delete calendarState.days[dateKey];
          }
        } else {
          calendarState.days[dateKey] = {
            status: status,
            contracted: existingData.contracted || false
          };
        }
      });

      // Mark as unsaved, clear selection, update UI
      markUnsaved();
      selectedDates.clear();
      renderCalendar();
      updateSelectionCount();
      updateCountDisplays();
    }

    /**
     * Set day status directly (for single day quick click on status display)
     * @param {string} dateKey - ISO date key (YYYY-MM-DD)
     * @param {string} status - New status
     */
    function setDayStatus(dateKey, status) {
      const existingData = calendarState.days[dateKey] || {};

      if (status === 'unset') {
        if (existingData.contracted) {
          calendarState.days[dateKey] = { status: 'unset', contracted: true };
        } else {
          delete calendarState.days[dateKey];
        }
      } else {
        calendarState.days[dateKey] = {
          status: status,
          contracted: existingData.contracted || false
        };
      }

      markUnsaved();
      renderCalendar();
      updateCountDisplays();
    }

    // ============================================================
    // DAY PICKER DIALOG FUNCTIONS (legacy, kept for bulk operations)
    // ============================================================
    // Open/close day picker and save status for individual days
    // ============================================================

    /**
     * Open day picker dialog for a specific date
     * Shows date info, contracted status, and current status selection
     *
     * @param {string} dateKey - ISO date key (YYYY-MM-DD)
     */
    function openDayPicker(dateKey) {
      const dialog = document.getElementById('dayPickerDialog');
      if (!dialog) return;

      // Store dateKey for save operation
      dialog.dataset.dateKey = dateKey;

      // Format date for display
      const date = new Date(dateKey);
      const dateDisplay = new Intl.DateTimeFormat('en-US', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      }).format(date);
      document.getElementById('pickerDateDisplay').textContent = dateDisplay;

      // Show contracted status
      const dayData = calendarState.days[dateKey] || {};
      const contractedEl = document.getElementById('pickerContracted');
      if (dayData.contracted) {
        contractedEl.textContent = 'Contracted work day';
      } else {
        contractedEl.textContent = '';
      }

      // Set current status radio
      const currentStatus = dayData.status || 'unset';
      const radios = dialog.querySelectorAll('input[name="dayStatus"]');
      radios.forEach(radio => {
        radio.checked = radio.value === currentStatus;
      });

      // Update count displays
      updatePickerCounts();

      dialog.showModal();
    }

    /**
     * Update the count displays in the day picker dialog
     */
    function updatePickerCounts() {
      const counts = calculateCounts();
      const monthCountEl = document.getElementById('pickerMonthCount');
      const annualCountEl = document.getElementById('pickerAnnualCount');

      if (monthCountEl) {
        monthCountEl.textContent = `${counts.monthBelgium} days in Belgium this month`;
      }
      if (annualCountEl) {
        annualCountEl.textContent = `${counts.annualThreshold} days in Belgium (annual total)`;
      }
    }

    /**
     * Save the selected status for the current day
     * Marks state as dirty (unsaved) - requires explicit Save to commit
     */
    function saveDayStatus() {
      const dialog = document.getElementById('dayPickerDialog');
      if (!dialog) return;

      const dateKey = dialog.dataset.dateKey;
      if (!dateKey) return;

      // Get selected status
      const selectedRadio = dialog.querySelector('input[name="dayStatus"]:checked');
      const newStatus = selectedRadio ? selectedRadio.value : 'unset';

      // Update calendarState.days, preserving contracted flag
      const existingData = calendarState.days[dateKey] || {};
      calendarState.days[dateKey] = {
        status: newStatus,
        contracted: existingData.contracted || false
      };

      // Mark as having unsaved changes
      markUnsaved();

      // Close dialog and re-render
      dialog.close();
      renderCalendar();
      updateCountDisplays();
    }

    /**
     * Close day picker dialog without saving
     */
    function closeDayPicker() {
      const dialog = document.getElementById('dayPickerDialog');
      if (dialog) {
        dialog.close();
      }
    }

    /**
     * Handle day cell click
     * Single click opens day editor modal; Shift+click toggles selection for bulk operation
     *
     * @param {string} dateKey - ISO date key (YYYY-MM-DD)
     * @param {Event} event - Click event
     */
    function handleDayClick(dateKey, event) {
      // If clicking on checkbox, let the checkbox handler deal with it
      if (event.target.classList.contains('day-checkbox')) {
        return;
      }

      // Shift+click for multi-select (toggle)
      if (event.shiftKey) {
        toggleDaySelection(dateKey);
        lastClickedDate = dateKey;
        return;
      }

      // Regular click - open day editor modal
      openDayEditor(dateKey);
    }

    /**
     * Select a range of dates between start and end
     * Opens bulk picker after selection
     *
     * @param {string} start - Start date key (YYYY-MM-DD)
     * @param {string} end - End date key (YYYY-MM-DD)
     */
    function selectDateRange(start, end) {
      const startDate = new Date(start);
      const endDate = new Date(end);

      // Ensure start < end
      const [from, to] = startDate <= endDate
        ? [startDate, endDate]
        : [endDate, startDate];

      selectedDates.clear();
      const current = new Date(from);
      while (current <= to) {
        // Only include dates in valid range (Feb-Dec 2026)
        const month = current.getMonth();
        if (current.getFullYear() === 2026 && month >= 1 && month <= 11) {
          selectedDates.add(toISODateKey(current));
        }
        current.setDate(current.getDate() + 1);
      }

      // Re-render to show selection, then open bulk picker
      renderCalendar();
      updateSelectionIndicator();
      openBulkPicker();
    }

    /**
     * Open bulk picker dialog for multiple selected dates
     */
    function openBulkPicker() {
      const dialog = document.getElementById('bulkPickerDialog');
      if (!dialog) return;

      // Update count display
      document.getElementById('bulkCount').textContent = selectedDates.size;

      // Default to belgium selected
      const radios = dialog.querySelectorAll('input[name="bulkStatus"]');
      radios.forEach(radio => {
        radio.checked = radio.value === 'belgium';
      });

      dialog.showModal();
    }

    /**
     * Close bulk picker dialog without saving
     */
    function closeBulkPicker() {
      const dialog = document.getElementById('bulkPickerDialog');
      if (dialog) {
        dialog.close();
      }
      // Clear selection
      selectedDates.clear();
      renderCalendar();
      updateSelectionIndicator();
    }

    /**
     * Save bulk status to all selected dates
     */
    function saveBulkStatus() {
      const dialog = document.getElementById('bulkPickerDialog');
      if (!dialog) return;

      // Get selected status
      const selectedRadio = dialog.querySelector('input[name="bulkStatus"]:checked');
      const newStatus = selectedRadio ? selectedRadio.value : 'unset';

      // Apply status to all selected dates
      selectedDates.forEach(dateKey => {
        const existingData = calendarState.days[dateKey] || {};
        calendarState.days[dateKey] = {
          status: newStatus,
          contracted: existingData.contracted || false
        };
      });

      // Mark as having unsaved changes
      markUnsaved();

      // Close dialog, clear selection, and re-render
      dialog.close();
      selectedDates.clear();
      renderCalendar();
      updateSelectionIndicator();
      updateCountDisplays();
    }

    /**
     * Mark calendar as having unsaved changes
     * Shows indicator and enables save button
     */
    function markUnsaved() {
      unsavedChanges = true;
      const indicator = document.getElementById('unsavedIndicator');
      const saveBtn = document.getElementById('saveCalendarBtn');
      if (indicator) indicator.classList.remove('hidden');
      if (saveBtn) saveBtn.disabled = false;
    }

    // ============================================================
    // MULTI-SELECT ENHANCEMENTS (BUG-05)
    // ============================================================
    // Week and month selection with selection indicator
    // ============================================================

    /**
     * Select all days in a week (adds to existing selection)
     * @param {string} weekStartKey - ISO date key of week's Monday
     */
    function selectWeek(weekStartKey) {
      const start = new Date(weekStartKey);

      for (let i = 0; i < 7; i++) {
        const day = new Date(start);
        day.setDate(start.getDate() + i);

        // Only include valid range (Feb-Dec 2026)
        if (day.getFullYear() === 2026 && day.getMonth() >= 1) {
          selectedDates.add(toISODateKey(day));
        }
      }

      renderCalendar();
      updateSelectionCount();
    }

    /**
     * Select all days in a month (adds to existing selection)
     * @param {number} month - Month index (0-11)
     */
    function selectMonth(month) {
      const year = 2026;
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);

      const current = new Date(firstDay);
      while (current <= lastDay) {
        selectedDates.add(toISODateKey(current));
        current.setDate(current.getDate() + 1);
      }

      renderCalendar();
      updateSelectionCount();
    }

    /**
     * Update selection indicator visibility and count
     * Updated for ENH-06: Uses badge styling in toolbar
     */
    function updateSelectionIndicator() {
      const countEl = document.getElementById('selectionCount');
      if (!countEl) return;

      // Update count with badge styling (ENH-06)
      countEl.textContent = selectedDates.size;
    }

    /**
     * Clear all selected dates
     */
    function clearSelection() {
      selectedDates.clear();
      renderCalendar();
      updateSelectionCount();
    }

    // ============================================================
    // COUNTING SYSTEM AND WARNING THRESHOLDS (Task 2)
    // ============================================================
    // Count Belgium/Spain/Travel days and display warnings
    // ============================================================

    const WARNING_THRESHOLDS = Object.freeze({
      YELLOW: 170,
      ORANGE: 180,
      RED: 183
    });

    /**
     * WARNING_LEVELS - Progressive warning system for 183-day threshold
     * Three-tier warning at 170, 180, and 183+ days
     */
    const WARNING_LEVELS = Object.freeze({
      SAFE: { threshold: 0, class: 'safe', icon: '', message: '' },
      CAUTION: { threshold: 170, class: 'caution', icon: '\u26A0\uFE0F', message: 'Approaching 183-day threshold' },
      WARNING: { threshold: 180, class: 'warning', icon: '\uD83D\uDD36', message: 'Very close to 183-day threshold' },
      DANGER: { threshold: 183, class: 'danger', icon: '\uD83D\uDEA8', message: 'EXCEEDED 183-day threshold!' }
    });

    /**
     * Calculate all day counts for current month and year (SYNC VERSION - LEGACY)
     * Falls back to localStorage when IndexedDB not available
     * @returns {object} - Monthly and annual counts
     */
    function calculateCounts() {
      const days = calendarState.days;
      let monthBelgium = 0, monthTravel = 0, monthSpain = 0;
      let annualBelgium = 0, annualTravel = 0, annualSpain = 0;

      const currentMonth = calendarState.currentMonth;
      const year = calendarState.year;

      Object.entries(days).forEach(([dateKey, data]) => {
        const [y, m] = dateKey.split('-').map(Number);
        if (y !== year) return;

        // Annual counts
        if (data.status === 'belgium') annualBelgium++;
        else if (data.status === 'travel') annualTravel++;
        else if (data.status === 'spain') annualSpain++;

        // Monthly counts (for current displayed month)
        if (m - 1 === currentMonth) {  // m is 1-indexed from ISO string
          if (data.status === 'belgium') monthBelgium++;
          else if (data.status === 'travel') monthTravel++;
          else if (data.status === 'spain') monthSpain++;
        }
      });

      return {
        monthBelgium, monthTravel, monthSpain,
        annualBelgium, annualTravel, annualSpain,
        annualThreshold: annualBelgium + annualTravel  // Conservative: both count
      };
    }

    /**
     * Calculate threshold counts using IndexedDB data (ASYNC VERSION)
     * Provides monthly and annual breakdowns for 183-day tracking
     * @param {number} year - Year to calculate for (e.g., 2026)
     * @returns {Promise<object>} - { annual: {...}, monthly: {...} }
     */
    async function calculateThresholdCounts(year) {
      // Try to get days from IndexedDB
      let days = [];
      try {
        days = await CalendarManager.getDaysForYear(year);
      } catch (err) {
        console.warn('calculateThresholdCounts: IndexedDB unavailable, falling back to localStorage');
      }

      // If no IndexedDB data, check localStorage (migration may be pending)
      if (days.length === 0 && calendarState && calendarState.days) {
        const localDays = Object.entries(calendarState.days);
        const yearStr = String(year);
        const hasLocalData = localDays.some(([k]) => k.startsWith(yearStr));

        if (hasLocalData) {
          // Convert localStorage format to array format for counting
          // (Migration prompt would appear here in full implementation)
          const fallbackCounts = calculateCounts();
          return {
            annual: {
              belgium: fallbackCounts.annualBelgium,
              spain: fallbackCounts.annualSpain,
              travel: fallbackCounts.annualTravel,
              other: 0,
              threshold: fallbackCounts.annualThreshold
            },
            monthly: {}  // Monthly breakdown not available in fallback
          };
        }
      }

      let belgium = 0, spain = 0, travel = 0, other = 0;
      const monthCounts = {};

      // Initialize month counts (month is 1-12 for display)
      for (let m = 1; m <= 12; m++) {
        monthCounts[m] = { belgium: 0, spain: 0, travel: 0 };
      }

      days.forEach(d => {
        const month = parseInt(d.date.split('-')[1], 10);

        switch (d.location) {
          case 'belgium':
            belgium++;
            monthCounts[month].belgium++;
            break;
          case 'spain':
            spain++;
            monthCounts[month].spain++;
            break;
          case 'travel':
            travel++;
            monthCounts[month].travel++;
            break;
          case 'other':
            other++;
            break;
        }
      });

      return {
        annual: {
          belgium,
          spain,
          travel,
          other,
          threshold: belgium + travel  // Both count toward 183
        },
        monthly: monthCounts
      };
    }

    /**
     * Get warning level based on threshold count
     * @param {number} thresholdCount - Number of Belgium + Travel days
     * @returns {string|null} - 'red', 'orange', 'yellow', or null (legacy API)
     */
    function getWarningLevel(thresholdCount) {
      if (thresholdCount >= WARNING_THRESHOLDS.RED) return 'red';
      if (thresholdCount >= WARNING_THRESHOLDS.ORANGE) return 'orange';
      if (thresholdCount >= WARNING_THRESHOLDS.YELLOW) return 'yellow';
      return null;
    }

    /**
     * Get progressive warning level object for threshold count
     * Returns WARNING_LEVELS entry for appropriate tier
     * @param {number} thresholdCount - Number of Belgium + Travel days
     * @returns {object} - WARNING_LEVELS entry
     */
    function getProgressiveWarningLevel(thresholdCount) {
      if (thresholdCount >= WARNING_LEVELS.DANGER.threshold) return WARNING_LEVELS.DANGER;
      if (thresholdCount >= WARNING_LEVELS.WARNING.threshold) return WARNING_LEVELS.WARNING;
      if (thresholdCount >= WARNING_LEVELS.CAUTION.threshold) return WARNING_LEVELS.CAUTION;
      return WARNING_LEVELS.SAFE;
    }

    /**
     * Update threshold warning banner with progressive styling
     * @param {number} thresholdCount - Current threshold count
     */
    function updateThresholdWarning(thresholdCount) {
      const banner = document.getElementById('thresholdWarningBanner');
      if (!banner) return;

      const level = getProgressiveWarningLevel(thresholdCount);

      if (level === WARNING_LEVELS.SAFE) {
        banner.style.display = 'none';
        return;
      }

      banner.className = `threshold-banner ${level.class}`;
      const iconEl = banner.querySelector('.warning-icon');
      const msgEl = banner.querySelector('.warning-message');
      const countEl = document.getElementById('thresholdCount');

      if (iconEl) iconEl.textContent = level.icon;
      if (msgEl) msgEl.textContent = level.message;
      if (countEl) countEl.textContent = thresholdCount;

      banner.style.display = 'flex';
    }

    /**
     * Dismiss threshold warning banner
     * Banner reappears when count changes
     */
    function dismissThresholdWarning() {
      const banner = document.getElementById('thresholdWarningBanner');
      if (banner) banner.style.display = 'none';
    }

    /**
     * Update count displays and warning banners (ASYNC VERSION)
     * Loads data from IndexedDB and updates all count displays
     */
    async function updateCountDisplaysAsync() {
      const year = calendarState?.currentYear || calendarState?.year || 2026;
      const currentMonth = calendarState?.currentMonth ?? 1;

      try {
        const counts = await calculateThresholdCounts(year);

        // Update calendar title with current year
        const titleEl = document.getElementById('calendarYearTitle');
        if (titleEl) titleEl.textContent = year;

        // Update year summary display
        const summaryLabel = document.getElementById('yearSummaryLabel');
        const summaryBelgium = document.getElementById('yearSummaryBelgium');
        const summarySpain = document.getElementById('yearSummarySpain');
        const summaryTravel = document.getElementById('yearSummaryTravel');
        const summaryThreshold = document.getElementById('yearSummaryThreshold');

        if (summaryLabel) summaryLabel.textContent = `${year} Summary:`;
        if (summaryBelgium) { summaryBelgium.textContent = counts.annual.belgium; summaryBelgium.style.color = 'var(--belgium)'; }
        if (summarySpain) { summarySpain.textContent = counts.annual.spain; summarySpain.style.color = 'var(--positive)'; }
        if (summaryTravel) { summaryTravel.textContent = counts.annual.travel; summaryTravel.style.color = 'var(--warning)'; }
        if (summaryThreshold) {
          const thresholdClass = counts.annual.threshold >= 183 ? 'danger' :
                                 counts.annual.threshold >= 170 ? 'warning' : '';
          summaryThreshold.className = `threshold-indicator ${thresholdClass}`;
          summaryThreshold.textContent = `(${counts.annual.threshold}/183)`;
        }

        // Update monthly count (current month display)
        const monthCountEl = document.getElementById('monthBelgiumCount');
        if (monthCountEl) {
          // currentMonth is 0-indexed, monthCounts uses 1-indexed
          const monthData = counts.monthly[currentMonth + 1] || { belgium: 0 };
          monthCountEl.textContent = monthData.belgium;
        }

        // Update annual count
        const annualCountEl = document.getElementById('annualBelgiumCount');
        if (annualCountEl) {
          annualCountEl.textContent = counts.annual.threshold;
        }

        // Update progressive warning banner
        updateThresholdWarning(counts.annual.threshold);

        // Update legacy warning elements (badge and banner)
        const warningLevel = getWarningLevel(counts.annual.threshold);
        const badge = document.getElementById('warningBadge');
        const banner = document.getElementById('warningBanner');

        // Reset classes
        if (badge) badge.className = 'warning-badge hidden';
        if (banner) banner.className = 'warning-banner hidden';

        if (warningLevel && badge && banner) {
          badge.className = `warning-badge ${warningLevel}`;
          badge.textContent = warningLevel === 'red' ? 'EXCEEDED' : 'WARNING';

          banner.className = `warning-banner ${warningLevel}`;
          const messages = {
            yellow: `Approaching threshold: ${counts.annual.threshold} days in Belgium (183 triggers residency review)`,
            orange: `Very close to threshold: ${counts.annual.threshold} days in Belgium (183 triggers residency review)`,
            red: `Threshold exceeded: ${counts.annual.threshold} days in Belgium (exceeds 183-day limit)`
          };
          banner.textContent = messages[warningLevel];
        }
      } catch (err) {
        console.warn('updateCountDisplaysAsync failed, using sync fallback:', err.message);
        updateCountDisplays();
      }
    }

    /**
     * Update count displays and warning banners (SYNC VERSION - LEGACY)
     * Called after any day status change
     */
    function updateCountDisplays() {
      const counts = calculateCounts();
      const year = calendarState?.currentYear || calendarState?.year || 2026;

      // Update calendar title with current year
      const titleEl = document.getElementById('calendarYearTitle');
      if (titleEl) titleEl.textContent = year;

      // Update year summary display (sync version - limited data)
      const summaryLabel = document.getElementById('yearSummaryLabel');
      const summaryBelgium = document.getElementById('yearSummaryBelgium');
      const summarySpain = document.getElementById('yearSummarySpain');
      const summaryTravel = document.getElementById('yearSummaryTravel');
      const summaryThreshold = document.getElementById('yearSummaryThreshold');

      if (summaryLabel) summaryLabel.textContent = `${year} Summary:`;
      if (summaryBelgium) { summaryBelgium.textContent = counts.annualBelgium; summaryBelgium.style.color = 'var(--belgium)'; }
      if (summarySpain) { summarySpain.textContent = counts.annualSpain; summarySpain.style.color = 'var(--positive)'; }
      if (summaryTravel) { summaryTravel.textContent = counts.annualTravel; summaryTravel.style.color = 'var(--warning)'; }
      if (summaryThreshold) {
        const thresholdClass = counts.annualThreshold >= 183 ? 'danger' :
                               counts.annualThreshold >= 170 ? 'warning' : '';
        summaryThreshold.className = `threshold-indicator ${thresholdClass}`;
        summaryThreshold.textContent = `(${counts.annualThreshold}/183)`;
      }

      const monthCountEl = document.getElementById('monthBelgiumCount');
      const annualCountEl = document.getElementById('annualBelgiumCount');
      if (monthCountEl) monthCountEl.textContent = counts.monthBelgium;
      if (annualCountEl) annualCountEl.textContent = counts.annualThreshold;

      // Update progressive warning banner
      updateThresholdWarning(counts.annualThreshold);

      const warningLevel = getWarningLevel(counts.annualThreshold);
      const badge = document.getElementById('warningBadge');
      const banner = document.getElementById('warningBanner');

      // Reset classes
      if (badge) badge.className = 'warning-badge hidden';
      if (banner) banner.className = 'warning-banner hidden';

      if (warningLevel && badge && banner) {
        badge.className = `warning-badge ${warningLevel}`;
        badge.textContent = warningLevel === 'red' ? 'EXCEEDED' : 'WARNING';

        banner.className = `warning-banner ${warningLevel}`;
        const messages = {
          yellow: `Approaching threshold: ${counts.annualThreshold} days in Belgium (183 triggers residency review)`,
          orange: `Very close to threshold: ${counts.annualThreshold} days in Belgium (183 triggers residency review)`,
          red: `Threshold exceeded: ${counts.annualThreshold} days in Belgium (exceeds 183-day limit)`
        };
        banner.textContent = messages[warningLevel];
      }
    }

    /**
     * Commit calendar changes to localStorage
     * Clears unsaved indicator and disables save button
     */
    function commitCalendarChanges() {
      calendarState.lastModified = new Date().toISOString();
      saveCalendarState();
      unsavedChanges = false;
      const indicator = document.getElementById('unsavedIndicator');
      const saveBtn = document.getElementById('saveCalendarBtn');
      if (indicator) indicator.classList.add('hidden');
      if (saveBtn) saveBtn.disabled = true;
      // Update compliance warning banner when calendar changes are saved
      updateComplianceWarning();
    }

    /**
     * Reset calendar to empty state (clears all day statuses)
     * Asks for confirmation before clearing
     */
    function resetCalendar() {
      if (!confirm('Reset calendar? This will clear all day statuses. This action cannot be undone.')) {
        return;
      }

      // Clear all day data but keep structure
      calendarState.days = {};
      calendarState.contractedPatternApplied = false;
      calendarState.lastModified = new Date().toISOString();

      // Clear from localStorage
      localStorage.removeItem('autonomoCalendarState');

      // Clear selection
      selectedDates.clear();
      lastClickedDate = null;

      // Re-render and update displays
      renderCalendar();
      updateSelectionIndicator();
      updateCountDisplays();
      updateComplianceWarning();

      // Mark as clean (no unsaved changes since we just cleared)
      unsavedChanges = false;
      const indicator = document.getElementById('unsavedIndicator');
      const saveBtn = document.getElementById('saveCalendarBtn');
      if (indicator) indicator.classList.add('hidden');
      if (saveBtn) saveBtn.disabled = true;

      // Show wizard again
      showContractedWizard();
    }

    // ============================================================
    // CALENDAR EXPORT FUNCTIONS (Task 1)
    // ============================================================
    // ICS and CSV export with Blob API download
    // Enhanced in Phase 16-05 with client/project information
    // ============================================================

    /**
     * Format date for ICS timestamp (YYYYMMDDTHHMMSSZ format)
     * @param {Date} date - Date to format
     * @returns {string} - ICS formatted timestamp
     */
    function formatICSTimestamp(date) {
      return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
    }

    /**
     * Escape special characters for ICS format (RFC 5545)
     * @param {string} str - String to escape
     * @returns {string} - ICS-safe string
     */
    function escapeICS(str) {
      if (!str) return '';
      return str
        .replace(/\\/g, '\\\\')
        .replace(/,/g, '\\,')
        .replace(/;/g, '\\;')
        .replace(/\n/g, '\\n');
    }

    /**
     * Generate enhanced ICS (iCalendar) content with client/project information
     * Uses CalendarManager (IndexedDB) for v2 data
     * @param {number} year - Year to export
     * @returns {Promise<string>} - Valid ICS file content
     */
    async function generateEnhancedICS(year) {
      // Get all days for the year from IndexedDB
      const days = await CalendarManager.getDaysForYear(year);

      // Get client lookup for names
      const clients = await ClientManager.getClients({});
      const clientMap = new Map(clients.map(c => [c.id, c.name]));

      // Get project lookup for names
      const projects = await db.projects
        .where('entity_id').equals(EntityContext.entityId)
        .toArray();
      const projectMap = new Map(projects.map(p => [p.id, p.name]));

      // Generate events
      const events = days
        .filter(d => d.location && d.location !== 'unset')
        .map(d => {
          const date = new Date(d.date);
          const nextDay = new Date(date);
          nextDay.setDate(nextDay.getDate() + 1);

          // Build summary with location and client
          const locationText = {
            belgium: 'Belgium',
            spain: 'Spain',
            travel: 'Travel',
            other: 'Other'
          }[d.location] || d.location;

          const locationEmoji = {
            belgium: '',
            spain: '',
            travel: '',
            other: ''
          }[d.location] || '';

          const clientName = d.client_id ? clientMap.get(d.client_id) : null;
          const projectName = d.project_id ? projectMap.get(d.project_id) : null;

          let summary = `${locationText} ${locationEmoji}`;
          if (clientName) summary += ` - ${clientName}`;
          if (projectName) summary += ` (${projectName})`;

          // Build description
          let description = `Location: ${locationText}`;
          if (clientName) description += `\\nClient: ${clientName}`;
          if (projectName) description += `\\nProject: ${projectName}`;
          if (d.notes) description += `\\nNotes: ${d.notes}`;

          return `BEGIN:VEVENT
DTSTART;VALUE=DATE:${d.date.replace(/-/g, '')}
DTEND;VALUE=DATE:${toISODateKey(nextDay).replace(/-/g, '')}
DTSTAMP:${formatICSTimestamp(new Date())}
UID:${d.id || d.date}-${EntityContext.entityId}@autonomo-calculator
SUMMARY:${escapeICS(summary)}
DESCRIPTION:${escapeICS(description)}
END:VEVENT`;
        });

      return `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Autonomo Tax Calculator//Work Calendar v2.0//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:Work Calendar ${year}
X-WR-CALDESC:Autonomo work presence calendar
${events.join('\n')}
END:VCALENDAR`;
    }

    /**
     * Legacy: Generate ICS (iCalendar) content for all marked days
     * Follows RFC 5545 specification
     * @returns {string} - Valid ICS file content
     * @deprecated Use generateEnhancedICS for v2 data
     */
    function generateICS() {
      const events = Object.entries(calendarState.days)
        .filter(([_, data]) => data.status && data.status !== 'unset')
        .map(([dateKey, data]) => {
          const date = new Date(dateKey);
          const nextDay = new Date(date);
          nextDay.setDate(nextDay.getDate() + 1);

          const statusText = {
            belgium: 'Belgium Work Day',
            spain: 'Spain',
            travel: 'Travel Day'
          }[data.status];

          const contractedNote = data.contracted ? ' (Contracted)' : '';

          // ICS format for all-day events
          return `BEGIN:VEVENT
UID:${dateKey}-autonomo@tax-calculator
DTSTAMP:${formatICSTimestamp(new Date())}
DTSTART;VALUE=DATE:${dateKey.replace(/-/g, '')}
DTEND;VALUE=DATE:${toISODateKey(nextDay).replace(/-/g, '')}
SUMMARY:${statusText}${contractedNote}
DESCRIPTION:${statusText} - Autonomo Tax Calculator Belgium Tracking
END:VEVENT`;
        });

      return `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Autonomo Tax Calculator//Belgium Calendar//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:Belgium Work Calendar 2026
${events.join('\n')}
END:VCALENDAR`;
    }

    /**
     * Download ICS file via Blob API (enhanced version)
     * Uses CalendarManager for v2 data with client/project info
     */
    async function downloadICS() {
      const year = calendarState.currentYear;

      // Check if we have IndexedDB data (v2) or legacy data
      const v2Days = await CalendarManager.getDaysForYear(year);

      let ics;
      if (v2Days.length > 0) {
        // Use enhanced ICS generation with client/project info
        ics = await generateEnhancedICS(year);
      } else {
        // Fall back to legacy generation from calendarState.days
        ics = generateICS();
      }

      const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `work-calendar-${year}.ics`;
      document.body.appendChild(a);
      a.click();

      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    /**
     * Escape a field value for CSV (handles quotes, commas, newlines)
     * @param {any} value - Value to escape
     * @returns {string} - CSV-safe string
     */
    function escapeCSVField(value) {
      if (value == null) return '';
      const str = String(value);
      if (str.search(/("|,|\n)/g) >= 0) {
        return '"' + str.replace(/"/g, '""') + '"';
      }
      return str;
    }

    /**
     * Generate enhanced CSV content with client/project information
     * Uses CalendarManager (IndexedDB) for v2 data
     * @param {number} year - Year to export
     * @returns {Promise<string>} - CSV file content
     */
    async function generateEnhancedCSV(year) {
      // Get all days for the year from IndexedDB
      const days = await CalendarManager.getDaysForYear(year);

      // Get client and project lookups
      const clients = await ClientManager.getClients({});
      const clientMap = new Map(clients.map(c => [c.id, c.name]));

      const projects = await db.projects
        .where('entity_id').equals(EntityContext.entityId)
        .toArray();
      const projectMap = new Map(projects.map(p => [p.id, p.name]));

      // CSV header
      const headers = ['Date', 'Day', 'Location', 'Client', 'Project', 'Notes'];

      // CSV rows
      const rows = days
        .sort((a, b) => a.date.localeCompare(b.date))
        .filter(d => d.location && d.location !== 'unset')
        .map(d => {
          const date = new Date(d.date);
          const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
          const location = d.location || '';
          const client = d.client_id ? (clientMap.get(d.client_id) || '') : '';
          const project = d.project_id ? (projectMap.get(d.project_id) || '') : '';
          const notes = d.notes || '';

          return [
            d.date,
            dayName,
            location,
            escapeCSVField(client),
            escapeCSVField(project),
            escapeCSVField(notes)
          ];
        });

      // Get statistics for summary
      const stats = await CalendarManager.getYearStatistics(year);

      // Add summary rows at bottom
      const summaryRows = [
        [],  // Empty row
        ['SUMMARY'],
        ['Total Belgium Days', stats.belgium],
        ['Total Travel Days', stats.travel],
        ['Total Spain Days', stats.spain],
        ['Total Other Days', stats.other],
        ['Combined (Belgium + Travel)', stats.belgium + stats.travel],
        ['183-day Threshold', (stats.belgium + stats.travel) >= 183 ? 'EXCEEDED' : 'OK']
      ];

      const allRows = [headers, ...rows, ...summaryRows];
      return allRows.map(row => row.map(escapeCSVField).join(',')).join('\n');
    }

    /**
     * Legacy: Generate CSV content for all marked days
     * Includes headers, data rows, and summary section
     * @returns {string} - CSV file content
     * @deprecated Use generateEnhancedCSV for v2 data
     */
    function generateCSV() {
      const headers = ['Date', 'Day of Week', 'Status', 'Contracted', 'Month'];
      const rows = Object.entries(calendarState.days)
        .filter(([_, data]) => data.status && data.status !== 'unset')
        .sort(([a], [b]) => a.localeCompare(b))
        .map(([dateKey, data]) => {
          const date = new Date(dateKey);
          return [
            dateKey,
            date.toLocaleDateString('en-GB', { weekday: 'long' }),
            data.status,
            data.contracted ? 'Yes' : 'No',
            date.toLocaleDateString('en-GB', { month: 'long' })
          ];
        });

      // Add summary rows at bottom
      const counts = calculateCounts();
      const summaryRows = [
        [],  // Empty row
        ['SUMMARY'],
        ['Total Belgium Days', counts.annualBelgium],
        ['Total Travel Days', counts.annualTravel],
        ['Total Spain Days', counts.annualSpain],
        ['Combined (Belgium + Travel)', counts.annualThreshold],
        ['183-day Threshold', counts.annualThreshold >= 183 ? 'EXCEEDED' : 'OK']
      ];

      const allRows = [headers, ...rows, ...summaryRows];
      return allRows.map(row => row.map(escapeCSVField).join(',')).join('\n');
    }

    /**
     * Download CSV file via Blob API (enhanced version)
     * Uses CalendarManager for v2 data with client/project info
     */
    async function downloadCSV() {
      const year = calendarState.currentYear;

      // Check if we have IndexedDB data (v2) or legacy data
      const v2Days = await CalendarManager.getDaysForYear(year);

      let csv;
      if (v2Days.length > 0) {
        // Use enhanced CSV generation with client/project info
        csv = await generateEnhancedCSV(year);
      } else {
        // Fall back to legacy generation from calendarState.days
        csv = generateCSV();
      }

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `work-calendar-${year}.csv`;
      document.body.appendChild(a);
      a.click();

      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ============================================================
    // CLIPBOARD COPY AND NOTIFICATION (Task 2)
    // ============================================================
    // Copy summary to clipboard with visual feedback notification
    // ============================================================

    /**
     * Show notification toast with auto-hide
     * @param {string} message - Message to display
     * @param {string} type - 'success' or 'error'
     */
    function showNotification(message, type = 'success') {
      showToast(message, type, 3000);
    }

    /**
     * Generate monthly breakdown text for summary
     * @returns {string} - Formatted monthly breakdown
     */
    function generateMonthlyBreakdown() {
      const months = ['Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const breakdown = [];

      for (let m = 1; m <= 11; m++) {  // Feb(1) to Dec(11) - 0-indexed months
        let belgium = 0, travel = 0, spain = 0;

        Object.entries(calendarState.days).forEach(([dateKey, data]) => {
          const month = parseInt(dateKey.split('-')[1], 10) - 1;  // Convert to 0-indexed
          if (month === m) {
            if (data.status === 'belgium') belgium++;
            else if (data.status === 'travel') travel++;
            else if (data.status === 'spain') spain++;
          }
        });

        if (belgium + travel + spain > 0) {
          breakdown.push(`  ${months[m - 1]}: ${belgium} BE, ${travel} Travel, ${spain} ES`);
        }
      }

      return breakdown.length > 0 ? breakdown.join('\n') : '  No days marked yet';
    }

    /**
     * Copy calendar summary to clipboard
     * Shows notification on success/failure
     */
    async function copyToClipboard() {
      const counts = calculateCounts();
      const warningLevel = getWarningLevel(counts.annualThreshold);
      const warningText = warningLevel
        ? `\nWARNING: ${counts.annualThreshold >= 183 ? 'THRESHOLD EXCEEDED' : 'Approaching threshold'}`
        : '';

      const summary = `Belgium Calendar 2026 Summary
============================
Total Belgium days: ${counts.annualBelgium}
Total Travel days: ${counts.annualTravel}
Total Spain days: ${counts.annualSpain}
Combined (Belgium + Travel): ${counts.annualThreshold}
183-day threshold status: ${counts.annualThreshold >= 183 ? 'EXCEEDED' : 'OK'}${warningText}

Monthly Breakdown:
${generateMonthlyBreakdown()}

Note: Entry and exit days may count in BOTH Belgium and Spain.
Generated by Autonomo Tax Calculator`;

      try {
        await navigator.clipboard.writeText(summary);
        showNotification('Summary copied to clipboard!');
      } catch (err) {
        console.error('Clipboard write failed:', err);
        showNotification('Copy failed - please try again', 'error');
      }
    }

    const SOURCES = Object.freeze({
      IRPF_BRACKETS: {
        name: "IRPF Tramos 2025",
        source: "AEAT / Wolters Kluwer",
        url: "https://www.wolterskluwer.com/es-es/expert-insights/tramos-retenciones-irpf-2025-novedades",
        note: "Unchanged from 2024. Combined estatal + autonomica rates.",
        confidence: "HIGH"
      },
      MINIMO_PERSONAL: {
        name: "Minimo del Contribuyente",
        source: "AEAT Manual Practico IRPF 2024",
        url: "https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2024/c14-adecuacion-impuesto-circunstancias-personales/cuadro-resumen-minimo-personal-familiar.html",
        note: "5,550 EUR for all taxpayers regardless of age.",
        confidence: "HIGH"
      },
      MINIMO_DESCENDIENTES: {
        name: "Minimo por Descendientes",
        source: "AEAT",
        url: "https://sede.agenciatributaria.gob.es/Sede/ciudadanos-familias-personas-discapacidad/minimo-personal-familiar/minimo-descendientes.html",
        note: "2,400 EUR for first child. Add 2,800 EUR if under 3 years old.",
        confidence: "HIGH"
      },
      RETA: {
        name: "Cuota RETA",
        source: "User registration document / BOE",
        url: "https://www.boe.es/diario_boe/txt.php?id=BOE-A-2025-3780",
        note: "Fixed cuota 428.40 EUR/month from autonomo registration.",
        confidence: "HIGH"
      },
      GASTOS_DIFICIL: {
        name: "Expenses de Dificil Justificacion",
        source: "AEAT Estimacion Directa Simplificada",
        url: "https://sede.agenciatributaria.gob.es/Sede/irpf/empresarios-individuales-profesionales/regimenes-determinar-rendimiento-actividad/estimacion-directa-simplificada.html",
        note: "5% of rendimiento neto, maximum 2,000 EUR/year. Was 7% only in 2023.",
        confidence: "HIGH"
      },
      MINIMO_APPLICATION: {
        name: "4-Phase Minimo Method",
        source: "AEAT Cuotas Integras Example",
        url: "https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2022/c15-calculo-impuesto-determinacion-cuotas-integras/ejemplo-practico-calculo-cuotas-integras-autonomica.html",
        note: "Minimos reduce TAX LIABILITY, not taxable base. Tax on minimo is subtracted from tax on full base.",
        confidence: "HIGH"
      },
      DIETAS: {
        name: "Dietas y Asignaciones para Expenses de Viaje",
        source: "Reglamento IRPF Art. 9",
        url: "https://www.boe.es/buscar/act.php?id=BOE-A-2007-6820&tn=1&p=20231228#a9",
        note: "Abroad: 91.35 EUR/day with overnight, 48.08 EUR without. Spain: 53.34 EUR/day with overnight, 26.67 EUR without.",
        confidence: "HIGH"
      }
    });

    // ===========================================
    // PHASE 8: OFFICIAL SOURCES (ENH-03, ENH-04, ENH-05)
    // ===========================================
    // Verified URLs to official AEAT, BOE, and Seguridad Social pages
    // All links verified 2026-02-02
    // ===========================================

    const OFFICIAL_SOURCES = Object.freeze({
      // IRPF General
      AEAT_IRPF: {
        name: 'IRPF - Agencia Tributaria',
        url: 'https://sede.agenciatributaria.gob.es/Sede/irpf.html',
        description: 'Main IRPF information page'
      },

      // Autonomo Specific
      AEAT_AUTONOMOS: {
        name: 'Empresarios y Profesionales - AEAT',
        url: 'https://sede.agenciatributaria.gob.es/Sede/empresarios-individuales-profesionales.html',
        description: 'Self-employed taxpayer information'
      },

      // Estimation Methods - Expenses Dificil
      AEAT_ESTIMACION_DIRECTA: {
        name: 'Estimacion Directa Simplificada - AEAT',
        url: 'https://sede.agenciatributaria.gob.es/Sede/irpf/empresarios-individuales-profesionales/regimenes-determinar-rendimiento-actividad/estimacion-directa-simplificada.html',
        description: '5% gastos de dificil justificacion, 2000 EUR limit'
      },

      // Minimo Personal
      AEAT_MINIMO_PERSONAL: {
        name: 'Minimo del Contribuyente - AEAT',
        url: 'https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2024/c14-adecuacion-impuesto-circunstancias-personales/cuadro-resumen-minimo-personal-familiar.html',
        description: '5,550 EUR personal allowance'
      },

      // Minimo Descendientes
      AEAT_MINIMO_DESCENDIENTES: {
        name: 'Minimo por Descendientes - AEAT',
        url: 'https://sede.agenciatributaria.gob.es/Sede/ciudadanos-familias-personas-discapacidad/minimo-personal-familiar/minimo-descendientes.html',
        description: '2,400 EUR for first child'
      },

      // RETA Cotizacion
      RETA_COTIZACION: {
        name: 'Sistema de Cotizacion Autonomos - AEAT',
        url: 'https://sede.agenciatributaria.gob.es/Sede/empresarios-individuales-profesionales/nuevo-sistema-cotizacion-autonomos.html',
        description: 'RETA contribution system since 2023'
      },

      // Seguridad Social RETA
      SS_RETA: {
        name: 'Cotizacion Autonomos - Seg. Social',
        url: 'https://www.seg-social.es/wps/portal/wss/internet/Trabajadores/CotizacionRecaudacionTrabajadores/10721/10724/1320',
        description: 'Official RETA contribution rates'
      },

      // Dietas
      AEAT_DIETAS: {
        name: 'Dietas y Expenses de Viaje - AEAT',
        url: 'https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-ayuda-presentacion/irpf-2023/7-cumplimentacion-irpf/7_1-rendimientos-trabajo-personal/7_1_1-rendimientos-integros/7_1_1_2-dietas-gastos-viaje/asignaciones-gastos-manutencion-estancia.html',
        description: '91.35 EUR/day abroad with overnight'
      },

      // Reglamento IRPF - Dietas Article
      BOE_REGLAMENTO_IRPF: {
        name: 'Reglamento IRPF Art. 9 - BOE',
        url: 'https://www.boe.es/buscar/act.php?id=BOE-A-2007-6820&tn=1&p=20231228#a9',
        description: 'Official dietas limits regulation'
      },

      // Spain-Belgium Treaty
      BOE_TREATY: {
        name: 'Convenio Spain-Belgium - BOE',
        url: 'https://www.boe.es/buscar/act.php?id=BOE-A-2003-13375',
        description: 'Double taxation treaty (BOE-A-2003-13375)'
      },

      // AEAT Treaty Page for Belgium
      AEAT_TREATY_BELGIUM: {
        name: 'CDI Belgium - AEAT',
        url: 'https://sede.agenciatributaria.gob.es/Sede/normativa-criterios-interpretativos/fiscalidad-internacional/convenios-doble-imposicion-firmados-espana/belgica.html',
        description: 'AEAT treaty information page for Belgium'
      },

      // LIRPF - Tax Residence Definition
      BOE_LIRPF: {
        name: 'Ley IRPF Art. 9 - BOE',
        url: 'https://www.boe.es/buscar/act.php?id=BOE-A-2006-20764&p=20240101&tn=1#a9',
        description: 'Tax residence definition (183-day rule, family presumption)'
      },

      // Factura Requirements
      AEAT_FACTURACION: {
        name: 'Obligaciones de Facturacion - AEAT',
        url: 'https://sede.agenciatributaria.gob.es/Sede/empresarios-individuales-profesionales/obligacion-facturacion.html',
        description: 'Invoice requirements for autonomos'
      }
    });

    /**
     * Render external link with icon (Phase 8: ENH-03/04/05)
     * @param {string} sourceKey - Key from OFFICIAL_SOURCES
     * @returns {string} - HTML anchor element
     */
    function renderSourceLink(sourceKey) {
      const s = OFFICIAL_SOURCES[sourceKey];
      if (!s) {
        console.warn('Unknown source key:', sourceKey);
        return '';
      }

      return `<a href="${s.url}" target="_blank" rel="noopener noreferrer"
                 class="official-source-link" title="${s.description}">
        ${s.name} <span class="external-link-icon">&#8599;</span>
      </a>`;
    }

    /**
     * Render inline source citation (Phase 8: ENH-03/04/05)
     * @param {string} sourceKey - Key from OFFICIAL_SOURCES
     * @param {string} label - Optional custom label
     * @returns {string} - HTML anchor element for inline use
     */
    function renderInlineSource(sourceKey, label = null) {
      const s = OFFICIAL_SOURCES[sourceKey];
      if (!s) return '';

      const displayLabel = label || s.name;
      return `<a href="${s.url}" target="_blank" rel="noopener noreferrer"
                 class="inline-source-link" title="${s.description}">
        ${displayLabel}<span class="external-link-icon">&#8599;</span>
      </a>`;
    }

    // ===========================================
    // PHASE 8: DEDUCTIBLE EXPENSE AUTO-DETECTION (ENH-01)
    // ===========================================
    // Keyword patterns for detecting 100% deductible IT/consulting expenses
    // HIGH confidence: auto-fill 100%, MEDIUM: suggest but don't auto-fill
    // ===========================================

    const DEDUCTIBLE_100_CATEGORIES = Object.freeze({
      keywords: [
        // Software (HIGH confidence)
        { pattern: /\b(software|licencia|subscription|suscripcion)\b/i, category: 'Software', confidence: 'HIGH' },
        { pattern: /\b(adobe|microsoft 365|google workspace|slack|notion|github|jira|figma|jetbrains)\b/i, category: 'Software', confidence: 'HIGH' },

        // Cloud/Hosting (HIGH confidence)
        { pattern: /\b(hosting|domain|dominio|servidor|server|cloud|aws|azure|gcp|heroku|vercel|netlify)\b/i, category: 'Cloud/Hosting', confidence: 'HIGH' },

        // Equipment (HIGH confidence)
        { pattern: /\b(ordenador|computer|laptop|macbook|monitor|pantalla)\b/i, category: 'Equipment', confidence: 'HIGH' },
        { pattern: /\b(teclado|keyboard|raton|mouse|webcam|camara|microfono|auriculares|headphones)\b/i, category: 'Equipment', confidence: 'HIGH' },

        // Professional Services (HIGH confidence)
        { pattern: /\b(gestor|gestoria|asesor|asesoria|accountant|contable|abogado|lawyer|notario)\b/i, category: 'Professional Services', confidence: 'HIGH' },

        // Training (HIGH confidence)
        { pattern: /\b(curso|course|formacion|training|certificacion|certification|udemy|coursera|pluralsight)\b/i, category: 'Training', confidence: 'HIGH' },

        // Marketing (HIGH confidence)
        { pattern: /\b(marketing|publicidad|advertising|google ads|facebook ads|linkedin)\b/i, category: 'Marketing', confidence: 'HIGH' },

        // Workspace (MEDIUM confidence)
        { pattern: /\b(coworking|oficina|office)\b/i, category: 'Workspace', confidence: 'MEDIUM' }
      ],

      detect(name) {
        for (const rule of this.keywords) {
          if (rule.pattern.test(name)) {
            return { suggested: true, category: rule.category, confidence: rule.confidence };
          }
        }
        return { suggested: false, category: null, confidence: null };
      }
    });

    /**
     * Detect if expense name matches a 100% deductible category (ENH-01)
     * @param {string} name - Expense name to check
     * @returns {object} - Detection result with suggested, category, confidence
     */
    function detectDeductibleCategory(name) {
      return DEDUCTIBLE_100_CATEGORIES.detect(name);
    }

    // ===========================================
    // PHASE 7: COMPLIANCE CONSTANTS
    // ===========================================

    const DIETAS_LIMITS = Object.freeze({
      spain: {
        withOvernight: 53.34,
        withoutOvernight: 26.67
      },
      abroad: {
        withOvernight: 91.35,
        withoutOvernight: 48.08
      },
      source: 'Art. 9 Reglamento IRPF (RD 439/2007)'
    });

    const TREATY_ARTICLE_4 = Object.freeze({
      title: 'Article 4: Tax Residence Tie-Breaker',
      source: 'Spain-Belgium Tax Treaty (BOE-A-2003-13375)',
      steps: [
        {
          name: 'Permanent Home',
          legal: 'vivienda permanente a su disposicion',
          plain: 'The country where you have a permanent home available to you. If only in one country, that country is your tax residence.'
        },
        {
          name: 'Center of Vital Interests',
          legal: 'centro de intereses vitales - relaciones personales y economicas mas estrechas',
          plain: 'If permanent homes in both countries: where your personal ties (family, social life) and economic ties (work, assets) are strongest. Family location receives special weight per OECD Commentary.'
        },
        {
          name: 'Habitual Abode',
          legal: 'viva habitualmente',
          plain: 'If center cannot be determined: the country where you spend more time overall.'
        },
        {
          name: 'Nationality',
          legal: 'nacional',
          plain: 'If habitual abode is equal: the country of your citizenship.'
        },
        {
          name: 'Mutual Agreement',
          legal: 'autoridades competentes resolveran de comun acuerdo',
          plain: 'If dual national or none: tax authorities of both countries negotiate.'
        }
      ]
    });

    const ARTICLE_9_1_B = Object.freeze({
      title: 'Art. 9.1.b LIRPF: Family Presumption',
      source: 'Ley 35/2006, Art. 9.1.b (BOE-A-2006-20764)',
      legalText: 'Se presumira, salvo prueba en contrario, que el contribuyente tiene su residencia habitual en territorio espanol cuando, de acuerdo con los criterios anteriores, resida habitualmente en Spain el conyuge no separado legalmente y los hijos menores de edad que dependan de aquel.',
      plainSummary: 'If your non-legally-separated spouse AND/OR dependent minor children habitually reside in Spain, Spanish law PRESUMES you are also a Spanish tax resident. This presumption is "rebuttable" (can be challenged), but the burden of proof shifts to you to demonstrate your tax residence is elsewhere.',
      implication: 'For a person with family in Spain, this presumption operates in your FAVOR when another country might claim tax residency. Spain starts from the position that you are Spanish resident based on family ties, making it easier to defend Spanish tax residence under treaty tie-breaker rules.'
    });

    const FACTURA_REQUIREMENTS = Object.freeze({
      title: 'Factura Completa Requirements',
      source: 'AEAT - Reglamento de Facturacion',
      required: [
        { field: 'Numero de factura', description: 'Sequential invoice number' },
        { field: 'Fecha de emision', description: 'Issue date' },
        { field: 'NIF del emisor', description: 'Supplier tax ID' },
        { field: 'Nombre/Razon social emisor', description: 'Supplier name or company' },
        { field: 'Domicilio fiscal emisor', description: 'Supplier address' },
        { field: 'NIF del destinatario', description: 'YOUR tax ID (autonomo NIF)' },
        { field: 'Nombre destinatario', description: 'YOUR name' },
        { field: 'Domicilio fiscal destinatario', description: 'YOUR fiscal address' },
        { field: 'Descripcion', description: 'Description of goods/services' },
        { field: 'Base imponible', description: 'Taxable amount before IVA' },
        { field: 'Tipo de IVA', description: 'IVA rate (if applicable)' },
        { field: 'Cuota de IVA', description: 'IVA amount' },
        { field: 'Total', description: 'Total amount' }
      ],
      notValid: [
        { type: 'Ticket/Receipt', reason: 'Missing recipient identification' },
        { type: 'Factura simplificada', reason: 'Lacks full recipient data for IRPF deduction' },
        { type: 'Bank statement alone', reason: 'Not proof of business expense' },
        { type: 'Airbnb confirmation email', reason: 'Not a valid tax invoice' }
      ]
    });

    // ============================================================
    // PHASE 7: DISCLAIMER CONSTANT
    // ============================================================

    const DISCLAIMER = Object.freeze({
      title: 'Disclaimer',
      text: 'This calculator provides estimates for informational and educational purposes only. It does not constitute tax, legal, or financial advice. Tax laws are complex, subject to change, and vary by individual circumstances. Your actual tax liability may differ from these estimates. Always consult with a qualified tax professional (asesor fiscal, gestor) for guidance specific to your situation before making any financial decisions or filing tax returns.',
      shortVersion: 'For informational purposes only. Consult a qualified tax professional for advice specific to your situation.'
    });

    // ============================================================
    // TOOLTIPS (UI-09)
    // ============================================================
    // Accessible tooltip definitions for technical tax terms
    // ============================================================

    const TOOLTIPS = Object.freeze({
      irpf: {
        title: 'IRPF (Impuesto sobre la Renta)',
        text: 'Spanish personal income tax. Progressive rates from 19% to 47% based on taxable income brackets.'
      },
      reta: {
        title: 'RETA (Regimen Especial)',
        text: 'Spanish social security contribution for self-employed. Fixed monthly quota (cuota) based on income tramo.'
      },
      minimo: {
        title: 'Minimo Personal',
        text: 'Tax-free personal allowance (5,550 EUR). Reduces the tax owed, not the taxable base.'
      },
      descendientes: {
        title: 'Minimo por Descendientes',
        text: 'Child allowance (2,400 EUR for first child). Reduces tax liability after rate application.'
      },
      gastos: {
        title: 'Expenses de Dificil Justificacion',
        text: '5% deduction on net income for hard-to-document expenses. Capped at 2,000 EUR annually.'
      },
      leefgeld: {
        title: 'Disposable Income',
        text: 'Money remaining after all taxes AND private living costs. Your true take-home pay.'
      },
      dietas: {
        title: 'Dietas (Per Diem)',
        text: 'Tax-exempt daily allowance for work travel. Belgium: 91.35 EUR with overnight stay.'
      },
      treaty: {
        title: 'Spain-Belgium Tax Treaty',
        text: 'Bilateral agreement preventing double taxation. Article 4 defines tax residency rules.'
      }
    });

    /**
     * Create clickable tooltip trigger that opens modal
     * @param {string} term - Key from TOOLTIPS constant
     * @param {string} displayText - Text to display as trigger
     * @returns {string} - HTML with click trigger or just displayText if term not found
     */
    function createTooltip(term, displayText) {
      const tooltip = TOOLTIPS[term];
      if (!tooltip) return displayText;

      // Escape quotes for inline handlers
      const title = tooltip.title.replace(/'/g, "\\'").replace(/"/g, '&quot;');
      const text = tooltip.text.replace(/'/g, "\\'").replace(/"/g, '&quot;');

      return `<span class="term-tooltip-trigger" tabindex="0"
        onclick="openTooltipModal('${title}', '${text}')"
        onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openTooltipModal('${title}', '${text}')}"
        role="button"
        aria-label="Learn more about ${tooltip.title}">
        ${displayText}<span class="info-icon">i</span>
      </span>`;
    }

    /**
     * Open tooltip modal with title and text
     * @param {string} title - Modal title
     * @param {string} text - Modal body text
     */
    function openTooltipModal(title, text) {
      const dialog = document.getElementById('tooltipModal');
      if (!dialog) return;

      document.getElementById('tooltipModalTitle').textContent = title;
      document.getElementById('tooltipModalText').textContent = text;
      dialog.showModal();
    }

    /**
     * Close tooltip modal
     */
    function closeTooltipModal() {
      const dialog = document.getElementById('tooltipModal');
      if (dialog) dialog.close();
    }

    // ============================================================
    // EXPENSE DATA CONSTANTS
    // ============================================================
    // Pre-filled expense data for Spain deductible, Belgium costs, and private
    // All amounts from CLAUDE.md Fixed Costs section
    // ============================================================

    const DEFAULT_EXPENSES = Object.freeze({
      version: 1,
      categories: Object.freeze({
        spainDeductible: Object.freeze([
          Object.freeze({ id: 'huur', name: 'Rent (30% deductible)', baseAmount: 1155, deductionPct: 30, deletable: true }),
          Object.freeze({ id: 'gsm', name: 'Mobile (50% deductible)', baseAmount: 55, deductionPct: 50, deletable: true }),
          Object.freeze({ id: 'elektriciteit', name: 'Electricity (9% deductible)', baseAmount: 100, deductionPct: 9, deletable: true })
        ]),
        workTravel: Object.freeze([
          Object.freeze({ id: 'belgium-travel-low', name: 'Belgium Travel (Standard)', amount: 1000, description: '3 days, 1 flight (Mon-Wed pattern)', deletable: true }),
          Object.freeze({ id: 'belgium-travel-high', name: 'Belgium Travel (Extended)', amount: 2500, description: '17 days, 4 flights (full week pattern)', deletable: true })
        ]),
        private: Object.freeze([
          Object.freeze({ id: 'huur-private', name: 'Rent (70% private)', amount: 808.50, deletable: true }),
          Object.freeze({ id: 'gsm-private', name: 'Mobile (50% private)', amount: 27.50, deletable: true }),
          Object.freeze({ id: 'elektriciteit-private', name: 'Electricity (91% private)', amount: 91, deletable: true }),
          Object.freeze({ id: 'auto', name: 'Car', amount: 600, deletable: true }),
          Object.freeze({ id: 'verzekeringen', name: 'Insurance', amount: 200, deletable: true })
        ])
      })
    });

    // ============================================================
    // LOCALSTORAGE PERSISTENCE
    // ============================================================
    // Expense data persists between browser sessions
    // Graceful fallback for Safari private mode and quota errors
    // ============================================================

    const STORAGE_KEY = 'autonomo_expenses_v1';

    /**
     * Migrate old expense data format to new work-travel structure
     * Converts belgiumPattern + belgiumCosts to workTravel category
     * @param {object} data - Expense data object
     * @returns {object} - Migrated expense data
     */
    function migrateExpenseData(data) {
      // Migrate old belgiumPattern to new work-travel expenses
      if (data.belgiumPattern !== undefined || data.categories.belgiumCosts !== undefined) {
        const amount = data.belgiumPattern === 'high' ? 2500 : 1000;

        // Create workTravel category from old data
        if (!data.categories.workTravel) {
          data.categories.workTravel = [
            { id: 'belgium-travel-migrated', name: 'Belgium Travel', amount: amount,
              description: 'Migrated from pattern', deletable: true }
          ];
        }

        // Remove old belgiumCosts category and belgiumPattern
        delete data.categories.belgiumCosts;
        delete data.belgiumPattern;

        DEBUG && console.log('Migrated expense data from belgiumPattern to workTravel');
      }

      return data;
    }

    /**
     * Load expenses from localStorage
     * Falls back to DEFAULT_EXPENSES on error or invalid data
     * @returns {object} - Expense data object (mutable clone)
     */
    function loadExpenses() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);
          // Version check for future migration support
          if (parsed && parsed.version === 1) {
            // Apply migration for old data format
            return migrateExpenseData(parsed);
          }
        }
      } catch (e) {
        console.warn('localStorage load failed (Safari private mode?):', e.message);
      }
      // Return mutable clone of defaults
      return structuredClone(DEFAULT_EXPENSES);
    }

    /**
     * Save expenses to localStorage
     * Handles QuotaExceededError gracefully
     * @returns {boolean} - True if save succeeded
     */
    function saveExpenses() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(expenseData));
        return true;
      } catch (e) {
        if (e.name === 'QuotaExceededError') {
          console.warn('localStorage quota exceeded - changes not persisted');
          showToast('Storage full  expense changes not saved. Clear some data.', 'warning');
        } else {
          console.warn('localStorage save failed:', e.message);
          showToast('Failed to save expense data.', 'error');
        }
        return false;
      }
    }

    // Global expense data - initialized from localStorage or defaults
    let expenseData = loadExpenses();

    // ============================================================
    // INCOME DATA MANAGEMENT (Phase 8 - ENH-02)
    // ============================================================
    // Track client income entries with localStorage persistence
    // ============================================================

    const INCOME_STORAGE_KEY = 'autonomo_income_v1';

    const DEFAULT_INCOME = Object.freeze({
      version: 1,
      entries: []
    });

    /**
     * Load income data from localStorage
     * @returns {Array} - Array of income entries
     */
    function loadIncomeData() {
      try {
        const stored = localStorage.getItem(INCOME_STORAGE_KEY);
        if (stored) {
          const data = JSON.parse(stored);
          return data.entries || [];
        }
      } catch (e) {
        console.error('Error loading income data:', e);
      }
      return [];
    }

    /**
     * Save income data to localStorage
     * @param {Array} entries - Array of income entries
     */
    function saveIncomeData(entries) {
      localStorage.setItem(INCOME_STORAGE_KEY, JSON.stringify({
        version: 1,
        entries: entries
      }));
    }

    /**
     * Open income dialog for add or edit
     * @param {string|null} editId - Entry ID to edit, or null for new entry
     */
    function openIncomeDialog(editId = null) {
      const dialog = document.getElementById('incomeDialog');
      const form = document.getElementById('incomeForm');
      const title = document.getElementById('incomeDialogTitle');
      const editIdInput = document.getElementById('incomeEditId');

      form.reset();

      if (editId) {
        title.textContent = 'Edit Income Entry';
        const entries = loadIncomeData();
        const entry = entries.find(e => e.id === editId);
        if (entry) {
          document.getElementById('incomeClient').value = entry.clientName || '';
          document.getElementById('incomeInvoice').value = entry.invoiceNumber || '';
          document.getElementById('incomeAmount').value = entry.amount || '';
          document.getElementById('incomeDateInvoiced').value = entry.dateInvoiced || '';
          document.getElementById('incomeDateReceived').value = entry.dateReceived || '';
          document.getElementById('incomeDescription').value = entry.description || '';
          document.getElementById('incomeStatus').value = entry.status || 'paid';
          editIdInput.value = editId;
        }
      } else {
        title.textContent = 'Add Income Entry';
        editIdInput.value = '';
        // Set default date to today
        document.getElementById('incomeDateReceived').value = new Date().toISOString().split('T')[0];
      }

      dialog.showModal();
    }

    /**
     * Close income dialog
     */
    function closeIncomeDialog() {
      document.getElementById('incomeDialog').close();
    }

    /**
     * Save income entry from form
     * @param {Event} event - Form submit event
     */
    function saveIncomeEntry(event) {
      event.preventDefault();
      const form = event.target;
      const editId = form.editId.value;

      const entry = {
        id: editId || 'income-' + Date.now(),
        clientName: form.clientName.value.trim(),
        invoiceNumber: form.invoiceNumber.value.trim(),
        amount: parseFloat(form.amount.value) || 0,
        dateInvoiced: form.dateInvoiced.value,
        dateReceived: form.dateReceived.value,
        description: form.description.value.trim(),
        status: form.status.value
      };

      let entries = loadIncomeData();

      if (editId) {
        const index = entries.findIndex(e => e.id === editId);
        if (index !== -1) {
          entries[index] = entry;
        }
      } else {
        entries.push(entry);
      }

      saveIncomeData(entries);
      closeIncomeDialog();
      renderIncomeList();
    }

    /**
     * Delete income entry by ID
     * @param {string} id - Entry ID to delete
     */
    function deleteIncomeEntry(id) {
      if (!confirm('Delete this income entry?')) return;

      let entries = loadIncomeData();
      entries = entries.filter(e => e.id !== id);
      saveIncomeData(entries);
      renderIncomeList();
    }

    /**
     * Escape HTML to prevent XSS
     * @param {string} text - Raw text to escape
     * @returns {string} - Escaped HTML
     */
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    /**
     * Render income list with filtering and sorting
     */
    function renderIncomeList() {
      const container = document.getElementById('incomeList');
      const totalDisplay = document.getElementById('incomeTotalDisplay');
      const countDisplay = document.getElementById('incomeCountDisplay');
      const sortBy = document.getElementById('incomeSortBy').value;
      const filterText = document.getElementById('incomeFilterText').value.toLowerCase().trim();

      let entries = loadIncomeData();

      // Calculate total from ALL entries (before filtering)
      const allEntries = loadIncomeData();
      const total = allEntries.reduce((sum, e) => sum + (e.amount || 0), 0);
      totalDisplay.textContent = total.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' EUR';
      countDisplay.textContent = allEntries.length;

      // Filter
      if (filterText) {
        entries = entries.filter(e =>
          (e.clientName && e.clientName.toLowerCase().includes(filterText)) ||
          (e.invoiceNumber && e.invoiceNumber.toLowerCase().includes(filterText))
        );
      }

      // Sort
      entries.sort((a, b) => {
        switch (sortBy) {
          case 'date-desc':
            return new Date(b.dateReceived) - new Date(a.dateReceived);
          case 'date-asc':
            return new Date(a.dateReceived) - new Date(b.dateReceived);
          case 'amount-desc':
            return b.amount - a.amount;
          case 'amount-asc':
            return a.amount - b.amount;
          case 'client-asc':
            return (a.clientName || '').localeCompare(b.clientName || '');
          default:
            return 0;
        }
      });

      // Render empty state
      if (entries.length === 0) {
        if (filterText) {
          container.innerHTML = '<div class="income-empty">No entries match your filter.</div>';
        } else {
          container.innerHTML = '<div class="income-empty">No income entries yet. Click "+ Add Income" to start tracking.</div>';
        }
        return;
      }

      // Status colors
      const statusColors = {
        paid: 'var(--accent)',
        pending: 'var(--warning)',
        overdue: 'var(--negative)'
      };

      // Render entries
      container.innerHTML = entries.map(entry => {
        const dateDisplay = entry.dateReceived ? new Date(entry.dateReceived).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : '-';
        const statusColor = statusColors[entry.status] || 'var(--text-muted)';

        return `
          <div class="income-entry">
            <div class="income-entry-info">
              <span class="income-client">${escapeHtml(entry.clientName)}</span>
              <div class="income-details">
                ${entry.invoiceNumber ? `<span>Invoice: ${escapeHtml(entry.invoiceNumber)}</span>` : ''}
                <span>Received: ${dateDisplay}</span>
                <span style="color: ${statusColor}; text-transform: capitalize;">${entry.status}</span>
              </div>
              ${entry.description ? `<div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">${escapeHtml(entry.description)}</div>` : ''}
            </div>
            <div class="income-amount">${entry.amount.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} EUR</div>
            <div class="income-actions">
              <button type="button" data-permission="edit" data-permission-type="income" onclick="openIncomeDialog('${entry.id}')">Edit</button>
              <button type="button" class="delete-btn" data-permission="delete" data-permission-type="income" onclick="deleteIncomeEntry('${entry.id}')">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // ============================================================
    // SCENARIO PRESETS
    // ============================================================
    // Pre-configured scenarios (A-E) from CLAUDE.md
    // Values: A(3K), B(6K), C(9K), D(12K), E(18K)
    // Belgium patterns: A/B use 'low' (1K), C/D/E use 'high' (2.5K)
    // ============================================================

    const SCENARIO_PRESETS = Object.freeze({
      'A': Object.freeze({
        id: 'A',
        name: 'Scenario A',
        isPreset: true,
        monthlyRevenue: 3000,
        monthlyExpenses: 750,
        workTravelCost: 1000,  // Standard pattern: 3 days, 1 flight
        hasDescendant: true,
        fiscalOverrides: null
      }),
      'B': Object.freeze({
        id: 'B',
        name: 'Scenario B',
        isPreset: true,
        monthlyRevenue: 6000,
        monthlyExpenses: 1500,
        workTravelCost: 1000,  // Standard pattern
        hasDescendant: true,
        fiscalOverrides: null
      }),
      'C': Object.freeze({
        id: 'C',
        name: 'Scenario C',
        isPreset: true,
        monthlyRevenue: 9000,
        monthlyExpenses: 3000,
        workTravelCost: 2500,  // Extended pattern: 17 days, 4 flights
        hasDescendant: true,
        fiscalOverrides: null
      }),
      'D': Object.freeze({
        id: 'D',
        name: 'Scenario D',
        isPreset: true,
        monthlyRevenue: 12000,
        monthlyExpenses: 5000,
        workTravelCost: 2500,  // Extended pattern
        hasDescendant: true,
        fiscalOverrides: null
      }),
      'E': Object.freeze({
        id: 'E',
        name: 'Scenario E',
        isPreset: true,
        monthlyRevenue: 18000,
        monthlyExpenses: 8000,
        workTravelCost: 2500,  // Extended pattern
        hasDescendant: true,
        fiscalOverrides: null
      })
    });

    // ============================================================
    // SCENARIO STATE MANAGEMENT
    // ============================================================
    // Centralized state with localStorage persistence
    // ============================================================

    const SCENARIO_STORAGE_KEY = 'autonomo_scenarios_v1';

    // Scenario state - initialized on DOMContentLoaded
    let scenarioState = null;

    /**
     * Initialize scenario state from localStorage or defaults
     * @returns {object} - Scenario state object
     */
    function initScenarioState() {
      try {
        const stored = localStorage.getItem(SCENARIO_STORAGE_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);
          if (parsed.version === 1) {
            return parsed;
          }
        }
      } catch (e) {
        console.warn('Failed to load scenarios:', e.message);
      }
      // Return default state with presets
      return {
        version: 1,
        scenarios: structuredClone(SCENARIO_PRESETS),
        selected: [],
        customOrder: []
      };
    }

    /**
     * Save scenario state to localStorage
     * @returns {boolean} - True if save succeeded
     */
    function saveScenarioState() {
      try {
        localStorage.setItem(SCENARIO_STORAGE_KEY, JSON.stringify(scenarioState));
        return true;
      } catch (e) {
        console.warn('Failed to save scenarios:', e.message);
        showToast('Failed to save scenario changes.', 'error');
        return false;
      }
    }

    /**
     * Reset all scenarios to default presets
     * Removes any custom scenarios and restores A-E presets
     */
    function resetScenarios() {
      if (!confirm('Reset all scenarios to defaults? This will remove any custom scenarios and reset edits.')) {
        return;
      }

      // Clear from localStorage
      localStorage.removeItem(SCENARIO_STORAGE_KEY);

      // Reinitialize state from defaults
      scenarioState = {
        version: 1,
        scenarios: structuredClone(SCENARIO_PRESETS),
        selected: [],
        customOrder: []
      };

      // Re-render (recalculation happens automatically via getSortedScenarios())

      renderScenarioCards();
      renderComparisonTable();
    }

    // ============================================================
    // SCENARIO CALCULATION FUNCTIONS
    // ============================================================
    // Extends Phase 1 calculateFullIRPF with fiscal override support
    // ============================================================

    /**
     * Calculate full IRPF with optional fiscal configuration overrides
     * This is a copy of Phase 1's calculateFullIRPF but accepts a fiscal parameter
     * for what-if analysis (scenarios can override RETA, minimos, brackets)
     *
     * @param {number} monthlyRevenue - Gross monthly revenue in EUR
     * @param {number} monthlyDeductibleExpenses - Monthly deductible business expenses in EUR
     * @param {boolean} hasDescendant - Whether user has 1 dependent child
     * @param {object|null} fiscal - Optional fiscal config overrides (defaults to FISCAL_2025)
     * @returns {object} - Complete calculation breakdown
     */
    function sanitizeNumeric(value, fallback = 0, max = 10000000) {
      if (typeof value !== 'number' || isNaN(value) || !isFinite(value)) return fallback;
      return Math.min(Math.max(value, 0), max);
    }

    function calculateFullIRPFWithFiscal(monthlyRevenue, monthlyDeductibleExpenses = 0, hasDescendant = true, fiscal = null) {
      monthlyRevenue = sanitizeNumeric(monthlyRevenue);
      monthlyDeductibleExpenses = sanitizeNumeric(monthlyDeductibleExpenses);

      // Use provided fiscal config or default to FISCAL_2025
      const config = fiscal || FISCAL_2025;

      // Step 1: Annualize inputs
      const annualRevenue = monthlyRevenue * 12;
      const annualExpenses = monthlyDeductibleExpenses * 12;

      // Step 2: Total deductible = expenses + RETA
      const retaAnnual = config.RETA_ANNUAL || FISCAL_2025.RETA_ANNUAL;
      const totalDeductible = annualExpenses + retaAnnual;

      // Step 3: Rendimiento Neto Previo (before gastos dificil)
      const rendimientoNetoPrevio = annualRevenue - totalDeductible;

      // Step 4: Expenses dificil justificacion (use FISCAL_2025 rates - these don't change)
      const gastosDificil = calculateExpensesDificil(rendimientoNetoPrevio);

      // Step 5: Rendimiento Neto = Base Liquidable (for autonomo)
      const rendimientoNeto = rendimientoNetoPrevio - gastosDificil;
      const baseLiquidable = Math.max(0, rendimientoNeto);

      // Step 6: Calculate minimos (can be overridden)
      const minimoPersonal = config.MINIMO_PERSONAL || FISCAL_2025.MINIMO_PERSONAL;
      const minimoDescendientes = hasDescendant
        ? (config.MINIMO_DESCENDIENTES_PRIMERO || FISCAL_2025.MINIMO_DESCENDIENTES_PRIMERO)
        : 0;
      const minimoTotal = minimoPersonal + minimoDescendientes;

      // Step 7: Cuota Integra using 4-phase method
      const cuotaIntegra = calculateCuotaIntegra(baseLiquidable, minimoTotal);

      // Step 8: Effective tax rate
      const effectiveRate = rendimientoNeto > 0 ? (cuotaIntegra / rendimientoNeto) : 0;

      // Step 9: Net income calculations
      const netAnnual = annualRevenue - totalDeductible - gastosDificil - cuotaIntegra;
      const netMonthly = netAnnual / 12;

      // Step 10: Leefgeld (after private costs)
      const privateCostsMonthly = config.PRIVATE_COSTS_MONTHLY || FISCAL_2025.PRIVATE_COSTS_MONTHLY;
      const leefgeld = netMonthly - privateCostsMonthly;

      const retaMonthly = config.RETA_MONTHLY || FISCAL_2025.RETA_MONTHLY;

      // Return all values matching Phase 1's calculateFullIRPF return structure
      return {
        // Inputs
        monthlyRevenue,
        annualRevenue,
        monthlyExpenses: monthlyDeductibleExpenses,
        annualExpenses,

        // Deductions
        retaMonthly,
        retaAnnual,
        totalDeductible,

        // Calculation chain
        rendimientoNetoPrevio,
        gastosDificil,
        rendimientoNeto,
        baseLiquidable,

        // Minimos (for display)
        minimoPersonal,
        minimoDescendientes,
        minimoTotal,

        // Tax
        cuotaIntegra,
        effectiveRate,

        // Net income
        netAnnual,
        netMonthly,
        leefgeld,

        // Private costs (for reference)
        privateCostsMonthly
      };
    }

    /**
     * Calculate results for a scenario
     * Wraps calculateFullIRPFWithFiscal with scenario-specific inputs
     *
     * @param {object} scenario - Scenario object
     * @returns {object} - Complete calculation results
     */
    function calculateScenarioResults(scenario) {
      if (!scenario || typeof scenario !== 'object') {
        return calculateFullIRPFWithFiscal(0, 0, true, null);
      }
      scenario.monthlyRevenue = sanitizeNumeric(scenario.monthlyRevenue);
      scenario.monthlyExpenses = sanitizeNumeric(scenario.monthlyExpenses);
      const workTravelCost = getWorkTravelCost(scenario);
      const totalDeductible = scenario.monthlyExpenses + workTravelCost;

      // Allow fiscal overrides for what-if analysis
      const fiscal = scenario.fiscalOverrides
        ? { ...FISCAL_2025, ...scenario.fiscalOverrides }
        : FISCAL_2025;

      // Call calculateFullIRPFWithFiscal (derived from Phase 1's calculateFullIRPF)
      return calculateFullIRPFWithFiscal(
        scenario.monthlyRevenue,
        totalDeductible,
        scenario.hasDescendant,
        fiscal
      );
    }

    /**
     * Get work travel cost for a scenario
     * Supports both new workTravelCost property and legacy belgiumPattern
     * @param {object} scenario - Scenario object
     * @returns {number} - Monthly work travel cost
     */
    function getWorkTravelCost(scenario) {
      if (scenario.workTravelCost !== undefined) {
        return scenario.workTravelCost;
      }
      // Legacy support for old belgiumPattern
      return scenario.belgiumPattern === 'high' ? 2500 : 1000;
    }

    /**
     * Get all scenarios sorted by leefgeld (highest first)
     * Each scenario includes its calculated results
     *
     * @returns {array} - Array of scenarios with results, sorted by leefgeld descending
     */
    function getSortedScenarios() {
      const scenarios = Object.values(scenarioState.scenarios);
      return scenarios
        .map(s => ({
          ...s,
          results: calculateScenarioResults(s)
        }))
        .sort((a, b) => b.results.leefgeld - a.results.leefgeld);
    }

    // ============================================================
    // DEPRECATED: Belgium pattern toggle functions removed
    // Work travel expenses are now editable items like other categories
    // Migration function in loadExpenses() handles old localStorage data
    // ============================================================

    // ============================================================
    // EXPENSE DATA MANAGEMENT
    // ============================================================
    // Reset, calculation helpers, and totals for expense tracking
    // ============================================================

    /**
     * Reset all expenses to default values with confirmation
     * @returns {boolean} - True if reset occurred
     */
    function resetToDefaults() {
      if (confirm('Reset all expenses to default values? This cannot be undone.')) {
        expenseData = structuredClone(DEFAULT_EXPENSES);
        saveExpenses();
        renderAllSections();
        recalculateTotals();
        return true;
      }
      return false;
    }

    /**
     * Calculate deductible amount for an expense
     * Spain expenses have baseAmount * deductionPct; others use amount directly
     * @param {object} expense - Expense object
     * @returns {number} - Monthly deductible amount (rounded to 2 decimals)
     */
    function calculateDeductible(expense) {
      if (expense.baseAmount !== undefined && expense.deductionPct !== undefined) {
        return Math.round(expense.baseAmount * (expense.deductionPct / 100) * 100) / 100;
      }
      return Math.round((expense.amount || 0) * 100) / 100;
    }

    /**
     * Calculate total deductible for a category
     * @param {string} categoryKey - Key in expenseData.categories
     * @returns {number} - Total monthly amount (rounded to 2 decimals)
     */
    function calculateCategoryTotal(categoryKey) {
      const category = expenseData.categories[categoryKey];
      if (!category) return 0;

      const total = category.reduce((sum, exp) => sum + calculateDeductible(exp), 0);
      return Math.round(total * 100) / 100;
    }

    /**
     * Get all expense totals for integration with IRPF calculation
     * @returns {object} - Monthly and annual totals per category
     */
    function getExpenseTotals() {
      const spainMonthly = calculateCategoryTotal('spainDeductible');
      const workTravelMonthly = calculateCategoryTotal('workTravel');
      const privateMonthly = calculateCategoryTotal('private');

      return {
        spainDeductible: {
          monthly: spainMonthly,
          annual: Math.round(spainMonthly * 12 * 100) / 100
        },
        workTravel: {
          monthly: workTravelMonthly,
          annual: Math.round(workTravelMonthly * 12 * 100) / 100
        },
        private: {
          monthly: privateMonthly,
          annual: Math.round(privateMonthly * 12 * 100) / 100
        },
        totalDeductible: {
          monthly: Math.round((spainMonthly + workTravelMonthly) * 100) / 100,
          annual: Math.round((spainMonthly + workTravelMonthly) * 12 * 100) / 100
        }
      };
    }

    // ============================================================
    // EXPENSE SECTION RENDERING
    // ============================================================
    // Render expense sections with formulas, delete buttons, and totals
    // ============================================================

    /**
     * Format expense calculation formula for display
     * Shows transparent calculation: BASE x PERCENT% = RESULT
     * @param {object} expense - Expense object
     * @param {string} categoryKey - Category key for context
     * @returns {string} - Formatted formula string
     */
    function formatFormula(expense, categoryKey) {
      if (expense.baseAmount !== undefined && expense.deductionPct !== undefined) {
        // Spain deductible: show base x percent
        const result = expense.baseAmount * (expense.deductionPct / 100);
        return `${formatEUR(expense.baseAmount)} x ${expense.deductionPct}% = ${formatEUR(result)}`;
      } else if (categoryKey === 'private') {
        // Private: 0% deductible
        return `${formatEUR(expense.amount)} x 0% = ${formatEUR(0)}`;
      } else {
        // Belgium costs: 100% deductible
        return `${formatEUR(expense.amount)} x 100% = ${formatEUR(expense.amount)}`;
      }
    }

    /**
     * Render a single expense row with formula and delete button
     * @param {object} expense - Expense object
     * @param {string} categoryKey - Category key
     * @returns {string} - HTML string for expense row
     */
    function renderExpenseRow(expense, categoryKey) {
      const monthly = calculateDeductible(expense);
      const annual = Math.round(monthly * 12 * 100) / 100;

      return `
        <div class="expense-row" data-id="${expense.id}" data-category="${categoryKey}">
          <span class="expense-name">${escapeHtml(expense.name)}</span>
          <span class="expense-formula">${formatFormula(expense, categoryKey)}</span>
          <span class="expense-value">${formatEUR(monthly)}/month (${formatEUR(annual)}/year)</span>
          <div class="expense-actions">
            <button class="delete-btn" data-permission="delete" data-permission-type="expense" onclick="deleteExpense('${categoryKey}', '${expense.id}')" title="Delete">x</button>
          </div>
        </div>
      `;
    }

    /**
     * Render a complete expense section with header, rows, and add button
     * @param {string} categoryKey - Category key in expenseData.categories
     * @param {string} sectionClass - CSS class for section styling
     * @param {string} title - Section title
     * @returns {string} - HTML string for section
     */
    function renderExpenseSection(categoryKey, sectionClass, title) {
      const expenses = expenseData.categories[categoryKey] || [];
      const total = calculateCategoryTotal(categoryKey);
      const annual = Math.round(total * 12 * 100) / 100;

      // Render expense rows
      const rowsHtml = expenses.map(exp => renderExpenseRow(exp, categoryKey)).join('');

      return `
        <div class="expense-section ${sectionClass}">
          <div class="section-header">
            <span class="section-title">${title}</span>
            <span class="section-total">Total: ${formatEUR(total)}/month (${formatEUR(annual)}/year)</span>
          </div>
          <div class="expense-rows">
            ${rowsHtml}
          </div>
          <button class="add-expense-btn" data-permission="create" data-permission-type="expense" onclick="showAddForm('${categoryKey}')">+ Add Expense</button>
        </div>
      `;
    }

    /**
     * Render all expense sections
     * Updates the DOM with current expense data
     */
    function renderAllSections() {
      const spainEl = document.getElementById('spainSection');
      const workTravelEl = document.getElementById('workTravelSection');
      const privateEl = document.getElementById('privateSection');

      if (spainEl) {
        spainEl.innerHTML = renderExpenseSection('spainDeductible', 'spain-deductible', 'Spain Deductible Expenses');
      }
      if (workTravelEl) {
        workTravelEl.innerHTML = renderExpenseSection('workTravel', 'work-travel', 'Work Travel Expenses');
      }
      if (privateEl) {
        privateEl.innerHTML = renderExpenseSection('private', 'private', 'Private Expenses (Not Deductible)');
      }
    }

    // ============================================================
    // ADD/DELETE EXPENSE FUNCTIONALITY
    // ============================================================
    // User can add new expenses and delete existing ones
    // Changes trigger IRPF recalculation
    // ============================================================

    /**
     * Add a new expense to a category
     * @param {string} categoryKey - Category key in expenseData.categories
     * @param {object} expense - Expense object to add
     */
    function addExpense(categoryKey, expense) {
      expense.id = expense.id || crypto.randomUUID();
      expense.deletable = true;
      expenseData.categories[categoryKey].push(expense);
      saveExpenses();
      renderAllSections();
      recalculateTotals();
    }

    /**
     * Delete an expense from a category
     * @param {string} categoryKey - Category key in expenseData.categories
     * @param {string} expenseId - ID of expense to delete
     */
    function deleteExpense(categoryKey, expenseId) {
      const category = expenseData.categories[categoryKey];
      const index = category.findIndex(e => e.id === expenseId);
      if (index !== -1) {
        category.splice(index, 1);
        saveExpenses();
        renderAllSections();
        recalculateTotals();
      }
    }

    /**
     * Show the add expense dialog as modal
     * @param {string} categoryKey - Category to pre-select
     */
    function showAddForm(categoryKey) {
      const dialog = document.getElementById('addExpenseDialog');
      if (dialog) {
        const categorySelect = document.getElementById('newExpCategory');
        if (categorySelect) {
          categorySelect.value = categoryKey;
          toggleDeductionField();
        }
        // Focus on name input after opening
        dialog.showModal();
        setTimeout(() => document.getElementById('newExpName').focus(), 50);
      }
    }

    /**
     * Hide the add expense dialog and clear values
     */
    function hideAddForm() {
      const dialog = document.getElementById('addExpenseDialog');
      if (dialog) {
        dialog.close();
        document.getElementById('newExpName').value = '';
        document.getElementById('newExpAmount').value = '';
        document.getElementById('newExpDeduction').value = '100';
        // Clear detection state (ENH-01)
        clearExpenseDetection();
      }
    }

    /**
     * Toggle visibility of deduction percentage field
     * Only shown for Spain Deductible expenses
     */
    function toggleDeductionField() {
      const category = document.getElementById('newExpCategory').value;
      const deductionRow = document.getElementById('deductionRow');
      if (deductionRow) {
        deductionRow.style.display = category === 'spainDeductible' ? 'block' : 'none';
      }
      // Clear detection when category changes (ENH-01)
      clearExpenseDetection();
      // Re-detect if name has content and switching to spainDeductible
      if (category === 'spainDeductible') {
        const name = document.getElementById('newExpName').value.trim();
        if (name) {
          handleExpenseNameInput(name);
        }
      }
    }

    // Track current detection state for expense form (ENH-01)
    let currentDetection = { suggested: false, category: null, confidence: null };
    let userOverrodeDetection = false;

    /**
     * Handle expense name input for auto-detection (ENH-01)
     * Only activates for Spain Deductible category
     * @param {string} name - Current expense name value
     */
    function handleExpenseNameInput(name) {
      const category = document.getElementById('newExpCategory').value;
      const badge = document.getElementById('detectionBadge');
      const deductionInput = document.getElementById('newExpDeduction');
      const hint = document.getElementById('deductionHint');

      // Only detect for Spain Deductible expenses
      if (category !== 'spainDeductible' || !badge) {
        clearExpenseDetection();
        return;
      }

      // Detect category
      const detection = detectDeductibleCategory(name);
      currentDetection = detection;

      if (detection.suggested) {
        // Show detection badge
        badge.style.display = 'inline-flex';

        if (detection.confidence === 'HIGH') {
          badge.className = 'detection-badge suggested';
          badge.textContent = '100% (suggested)';

          // Auto-fill 100% for HIGH confidence if user hasn't overridden
          if (!userOverrodeDetection && deductionInput) {
            deductionInput.value = 100;
          }
        } else {
          // MEDIUM confidence
          badge.className = 'detection-badge medium';
          badge.textContent = '100%?';
        }

        // Show hint about category
        if (hint) {
          hint.style.display = 'block';
          hint.textContent = `Detected: ${detection.category} - typically 100% business deductible`;
        }
      } else {
        clearExpenseDetection();
      }
    }

    /**
     * Handle deduction percentage change (ENH-01)
     * Shows confirmation when user overrides auto-detected value
     * @param {number} value - New deduction percentage
     */
    function handleDeductionChange(value) {
      const hint = document.getElementById('deductionHint');

      // Check if user is overriding an auto-detected 100%
      if (currentDetection.suggested && currentDetection.confidence === 'HIGH') {
        if (parseInt(value) !== 100) {
          userOverrodeDetection = true;
          if (hint) {
            hint.style.display = 'block';
            hint.textContent = `Note: ${currentDetection.category} expenses are typically 100% deductible`;
            hint.style.color = 'var(--warning)';
          }
        } else {
          userOverrodeDetection = false;
          if (hint) {
            hint.style.display = 'block';
            hint.textContent = `Detected: ${currentDetection.category} - typically 100% business deductible`;
            hint.style.color = '';
          }
        }
      }
    }

    /**
     * Clear expense detection state (ENH-01)
     */
    function clearExpenseDetection() {
      const badge = document.getElementById('detectionBadge');
      const hint = document.getElementById('deductionHint');

      if (badge) {
        badge.style.display = 'none';
        badge.textContent = '';
      }
      if (hint) {
        hint.style.display = 'none';
        hint.textContent = '';
        hint.style.color = '';
      }

      currentDetection = { suggested: false, category: null, confidence: null };
      userOverrodeDetection = false;
    }

    /**
     * Submit new expense from form
     * Validates input and adds to appropriate category
     */
    function submitNewExpense() {
      const name = document.getElementById('newExpName').value.trim();
      const amount = parseFloat(document.getElementById('newExpAmount').value) || 0;
      const category = document.getElementById('newExpCategory').value;
      const deduction = parseFloat(document.getElementById('newExpDeduction').value) || 100;

      // Validate
      if (!name) {
        alert('Please enter a name for the expense.');
        return;
      }
      if (amount < 0) {
        alert('Amount cannot be negative.');
        return;
      }

      let expense;
      if (category === 'spainDeductible') {
        expense = {
          name,
          baseAmount: amount,
          deductionPct: Math.min(100, Math.max(0, deduction))
        };
      } else {
        expense = { name, amount };
      }

      addExpense(category, expense);
      hideAddForm();
    }

    /**
     * Reset the What-If Calculator to default values
     */
    function resetDetailsForm() {
      const defaults = {
        monthlyRevenue: 6000,
        calcSpainDeductible: 383,
        calcWorkTravel: 1000,
        calcPrivateCosts: 1727,
        calcRetaMonthly: 428.40,
        calcMinimoPersonal: 5550,
        hasDescendant: true
      };

      Object.entries(defaults).forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (el) {
          if (el.type === 'checkbox') {
            el.checked = value;
          } else {
            el.value = value;
          }
        }
      });

      recalculateTotals();
    }

    /**
     * Save current What-If Calculator values as a new scenario
     */
    function saveAsScenario() {
      const monthlyRevenue = parseFloat(document.getElementById('monthlyRevenue')?.value) || 0;
      const spainDeductible = parseFloat(document.getElementById('calcSpainDeductible')?.value) || 0;
      const workTravel = parseFloat(document.getElementById('calcWorkTravel')?.value) || 0;
      const privateCosts = parseFloat(document.getElementById('calcPrivateCosts')?.value) || 0;
      const hasDescendant = document.getElementById('hasDescendant')?.checked ?? true;

      // Prompt for scenario name
      const name = prompt('Enter a name for this scenario:', `Custom (${formatEUR(monthlyRevenue)}/mo)`);
      if (!name) return;

      // Create new scenario
      const newScenario = {
        id: crypto.randomUUID(),
        name: name,
        monthlyRevenue: monthlyRevenue,
        monthlyExpenses: spainDeductible,
        workTravelCost: workTravel,
        hasDescendant: hasDescendant,
        isCustom: true
      };

      // Add to scenario state
      scenarioState.scenarios[newScenario.id] = newScenario;
      scenarioState.customOrder.push(newScenario.id);
      saveScenarioState();

      // Re-render scenarios
      renderScenarioCards();
      renderComparisonTable();

      // Notify user
      alert(`Scenario "${name}" saved! Switch to the Scenarios tab to view it.`);
    }

    /**
     * Recalculate totals and update IRPF results
     * Uses What-If Calculator inputs if available, falls back to expense data
     */
    function recalculateTotals() {
      // Get inputs - use calculator fields if they exist, otherwise use expense totals
      const monthlyRevenue = parseFloat(document.getElementById('monthlyRevenue')?.value) || 0;
      const hasDescendant = document.getElementById('hasDescendant')?.checked ?? true;

      // Calculator inputs (What-If mode)
      const calcSpainEl = document.getElementById('calcSpainDeductible');
      const calcTravelEl = document.getElementById('calcWorkTravel');
      const calcPrivateEl = document.getElementById('calcPrivateCosts');
      const calcRetaEl = document.getElementById('calcRetaMonthly');
      const calcMinimoEl = document.getElementById('calcMinimoPersonal');

      let spainDeductible, workTravel, privateCostsMonthly, retaMonthly, minimoPersonal;

      if (calcSpainEl && calcTravelEl && calcPrivateEl) {
        // Use calculator inputs
        spainDeductible = parseFloat(calcSpainEl.value) || 0;
        workTravel = parseFloat(calcTravelEl.value) || 0;
        privateCostsMonthly = parseFloat(calcPrivateEl.value) || 0;
        retaMonthly = calcRetaEl ? parseFloat(calcRetaEl.value) || FISCAL_2025.RETA_MONTHLY : FISCAL_2025.RETA_MONTHLY;
        minimoPersonal = calcMinimoEl ? parseFloat(calcMinimoEl.value) || FISCAL_2025.MINIMO_PERSONAL : FISCAL_2025.MINIMO_PERSONAL;
      } else {
        // Fallback to expense data totals
        const totals = getExpenseTotals();
        spainDeductible = totals.spainDeductible.monthly;
        workTravel = totals.workTravel.monthly;
        privateCostsMonthly = totals.private.monthly;
        retaMonthly = FISCAL_2025.RETA_MONTHLY;
        minimoPersonal = FISCAL_2025.MINIMO_PERSONAL;
      }

      const totalDeductible = spainDeductible + workTravel;

      // Create fiscal config with possible overrides
      const fiscalConfig = {
        ...FISCAL_2025,
        RETA_MONTHLY: retaMonthly,
        RETA_ANNUAL: retaMonthly * 12,
        MINIMO_PERSONAL: minimoPersonal
      };

      // Calculate IRPF with custom fiscal config
      const r = calculateFullIRPFWithConfig(monthlyRevenue, totalDeductible, hasDescendant, fiscalConfig);

      // Override with our calculated values for display
      const totals = {
        spainDeductible: { monthly: spainDeductible, annual: spainDeductible * 12 },
        workTravel: { monthly: workTravel, annual: workTravel * 12 },
        private: { monthly: privateCostsMonthly, annual: privateCostsMonthly * 12 }
      };

      const leefgeld = r.netMonthly - privateCostsMonthly;

      const html = `
        <!-- Key Metrics Summary -->
        <div class="results-summary">
          <div class="summary-card highlight">
            <span class="summary-label">Disposable Income</span>
            <span class="summary-value accent">${formatEUR(leefgeld)}<span class="summary-unit">/month</span></span>
          </div>
          <div class="summary-card">
            <span class="summary-label">Net After Tax</span>
            <span class="summary-value">${formatEUR(r.netMonthly)}<span class="summary-unit">/month</span></span>
          </div>
          <div class="summary-card">
            <span class="summary-label">IRPF Tax</span>
            <span class="summary-value negative">${formatEUR(r.cuotaIntegra)}<span class="summary-unit">/year</span></span>
          </div>
          <div class="summary-card">
            <span class="summary-label">Effective Rate</span>
            <span class="summary-value">${formatPercent(r.effectiveRate)}</span>
          </div>
        </div>

        <!-- Detailed Breakdown Grid -->
        <div class="results-grid">
          <div class="results-section">
            <h3 class="results-section-title">Income</h3>
            <div class="results-row">
              <span class="row-label">Monthly Revenue</span>
              <span class="row-value">${formatEUR(r.monthlyRevenue)}</span>
            </div>
            <div class="results-row">
              <span class="row-label">Annual Revenue</span>
              <span class="row-value">${formatEUR(r.annualRevenue)}</span>
            </div>
          </div>

          <div class="results-section">
            <h3 class="results-section-title">Deductions</h3>
            <div class="results-row">
              <span class="row-label">RETA (Social Security) ${sourceHint('RETA')}</span>
              <span class="row-value">${formatEUR(r.retaAnnual)}</span>
            </div>
            <div class="results-row">
              <span class="row-label">Spain Deductible</span>
              <span class="row-value">${formatEUR(totals.spainDeductible.annual)}</span>
            </div>
            <div class="results-row">
              <span class="row-label">Work Travel</span>
              <span class="row-value">${formatEUR(totals.workTravel.annual)}</span>
            </div>
            <div class="results-row total">
              <span class="row-label">Total Deductible</span>
              <span class="row-value">${formatEUR(r.totalDeductible)}</span>
            </div>
          </div>

          <div class="results-section">
            <h3 class="results-section-title">IRPF Calculation ${sourceHint('IRPF_BRACKETS')}</h3>
            <div class="results-row">
              <span class="row-label">Rendimiento Neto Previo</span>
              <span class="row-value">${formatEUR(r.rendimientoNetoPrevio)}</span>
            </div>
            <div class="results-row">
              <span class="row-label">Expenses Dificil (5%, max 2000) ${sourceHint('GASTOS_DIFICIL')}</span>
              <span class="row-value">-${formatEUR(r.gastosDificil)}</span>
            </div>
            <div class="results-row total">
              <span class="row-label">Base Liquidable</span>
              <span class="row-value">${formatEUR(r.baseLiquidable)}</span>
            </div>
          </div>

          <div class="results-section">
            <h3 class="results-section-title">Tax Reductions ${sourceHint('MINIMO_APPLICATION')}</h3>
            <div class="results-row">
              <span class="row-label">Minimo Personal ${sourceHint('MINIMO_PERSONAL')}</span>
              <span class="row-value">${formatEUR(r.minimoPersonal)}</span>
            </div>
            <div class="results-row">
              <span class="row-label">Minimo Descendientes ${sourceHint('MINIMO_DESCENDIENTES')}</span>
              <span class="row-value">${formatEUR(r.minimoDescendientes)}</span>
            </div>
            <div class="results-row total">
              <span class="row-label">Total Minimos</span>
              <span class="row-value">${formatEUR(r.minimoTotal)}</span>
            </div>
          </div>

          <div class="results-section">
            <h3 class="results-section-title">Final Calculation</h3>
            <div class="results-row">
              <span class="row-label">Annual Net (after IRPF + RETA)</span>
              <span class="row-value">${formatEUR(r.netAnnual)}</span>
            </div>
            <div class="results-row">
              <span class="row-label">Monthly Net</span>
              <span class="row-value">${formatEUR(r.netMonthly)}</span>
            </div>
            <div class="results-row">
              <span class="row-label">Private Costs (non-deductible)</span>
              <span class="row-value">-${formatEUR(privateCostsMonthly)}/mo</span>
            </div>
          </div>
        </div>

        ${createFootnotes()}
      `;

      document.getElementById('results').innerHTML = html;
    }

    // ============================================================
    // CALCULATION FUNCTIONS
    // ============================================================
    // Implements official AEAT IRPF calculation methodology
    // CRITICAL: Uses 4-phase method where minimos reduce TAX, not BASE
    // ============================================================

    /**
     * Apply progressive IRPF brackets to any amount
     * Uses cumulative baseTax approach for accuracy at bracket boundaries
     * @param {number} amount - Taxable amount in EUR
     * @returns {number} - Tax amount in EUR (rounded to 2 decimals)
     */
    function applyBrackets(amount) {
      amount = sanitizeNumeric(amount);
      if (amount <= 0) return 0;

      for (const bracket of FISCAL_2025.IRPF_BRACKETS) {
        if (amount <= bracket.upTo) {
          return Math.round((bracket.baseTax + (amount - bracket.prevLimit) * bracket.rate) * 100) / 100;
        }
      }
      // Fallback (should never reach with Infinity bound)
      const last = FISCAL_2025.IRPF_BRACKETS[FISCAL_2025.IRPF_BRACKETS.length - 1];
      return Math.round((last.baseTax + (amount - last.prevLimit) * last.rate) * 100) / 100;
    }

    /**
     * Calculate Cuota Integra using 4-phase AEAT method
     * CRITICAL: Minimos reduce TAX liability, NOT taxable base
     *
     * Method:
     * 1. Calculate tax on full base liquidable
     * 2. Calculate tax on minimo amount (capped at base liquidable)
     * 3. Subtract #2 from #1 to get cuota integra
     *
     * Source: AEAT practical examples
     * https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2022/c15-calculo-impuesto-determinacion-cuotas-integras/ejemplo-practico-calculo-cuotas-integras-autonomica.html
     *
     * @param {number} baseLiquidable - Taxable base after all deductions
     * @param {number} minimoTotal - Sum of minimo personal + descendientes
     * @returns {number} - Cuota integra (tax liability) in EUR
     */
    function calculateCuotaIntegra(baseLiquidable, minimoTotal) {
      const cuota1 = applyBrackets(baseLiquidable);
      const minimoApplicable = Math.min(minimoTotal, baseLiquidable);
      const cuota3 = applyBrackets(minimoApplicable);
      return Math.max(0, Math.round((cuota1 - cuota3) * 100) / 100);
    }

    /**
     * Calculate Expenses de Dificil Justificacion
     * For Estimacion Directa Simplificada: 5% with 2000 EUR annual cap
     *
     * Source: AEAT Estimacion Directa Simplificada
     * Note: Was 7% in 2023, reverted to 5% for 2024 onwards
     *
     * @param {number} rendimientoNetoPrevio - Net income before gastos dificil
     * @returns {number} - Deductible amount in EUR
     */
    function calculateExpensesDificil(rendimientoNetoPrevio) {
      if (rendimientoNetoPrevio <= 0) return 0;
      const calculated = rendimientoNetoPrevio * FISCAL_2025.GASTOS_DIFICIL_RATE;
      return Math.round(Math.min(calculated, FISCAL_2025.GASTOS_DIFICIL_MAX) * 100) / 100;
    }

    /**
     * Main IRPF calculation function - returns all intermediate values
     *
     * CALC-05 Clarification:
     * The 7% reduccion rendimientos applies only when calculating the RETA base
     * for Social Security purposes. For IRPF, the actual RETA cuota paid
     * (428.40 EUR/month) is deducted as an expense. Since the user has a fixed
     * RETA cuota from registration, we simply deduct it as a business expense.
     *
     * @param {number} monthlyRevenue - Gross monthly revenue in EUR
     * @param {number} monthlyDeductibleExpenses - Monthly deductible business expenses in EUR
     * @param {boolean} hasDescendant - Whether user has 1 dependent child
     * @returns {object} - Complete calculation breakdown
     */
    function calculateFullIRPF(monthlyRevenue, monthlyDeductibleExpenses = 0, hasDescendant = true) {
      monthlyRevenue = sanitizeNumeric(monthlyRevenue);
      monthlyDeductibleExpenses = sanitizeNumeric(monthlyDeductibleExpenses);

      // Step 1: Annualize inputs
      const annualRevenue = monthlyRevenue * 12;
      const annualExpenses = monthlyDeductibleExpenses * 12;

      // Step 2: Total deductible = expenses + RETA (fixed cuota, not calculated)
      // CALC-05: RETA cuota is deducted as expense. The 7% reduccion is for SS, not IRPF.
      const totalDeductible = annualExpenses + FISCAL_2025.RETA_ANNUAL;

      // Step 3: Rendimiento Neto Previo (before gastos dificil)
      const rendimientoNetoPrevio = annualRevenue - totalDeductible;

      // Step 4: Expenses dificil justificacion
      const gastosDificil = calculateExpensesDificil(rendimientoNetoPrevio);

      // Step 5: Rendimiento Neto = Base Liquidable (for autonomo)
      const rendimientoNeto = rendimientoNetoPrevio - gastosDificil;
      const baseLiquidable = Math.max(0, rendimientoNeto);

      // Step 6: Calculate minimos
      const minimoPersonal = FISCAL_2025.MINIMO_PERSONAL;
      const minimoDescendientes = hasDescendant ? FISCAL_2025.MINIMO_DESCENDIENTES_PRIMERO : 0;
      const minimoTotal = minimoPersonal + minimoDescendientes;

      // Step 7: Cuota Integra using 4-phase method
      const cuotaIntegra = calculateCuotaIntegra(baseLiquidable, minimoTotal);

      // Step 8: Effective tax rate
      const effectiveRate = rendimientoNeto > 0 ? (cuotaIntegra / rendimientoNeto) : 0;

      // Step 9: Net income calculations
      const netAnnual = annualRevenue - totalDeductible - gastosDificil - cuotaIntegra;
      const netMonthly = netAnnual / 12;

      // Step 10: Leefgeld (after private costs)
      const leefgeld = netMonthly - FISCAL_2025.PRIVATE_COSTS_MONTHLY;

      return {
        // Inputs
        monthlyRevenue,
        annualRevenue,
        monthlyExpenses: monthlyDeductibleExpenses,
        annualExpenses,

        // Deductions
        retaMonthly: FISCAL_2025.RETA_MONTHLY,
        retaAnnual: FISCAL_2025.RETA_ANNUAL,
        totalDeductible,

        // Calculation chain
        rendimientoNetoPrevio,
        gastosDificil,
        rendimientoNeto,
        baseLiquidable,

        // Minimos (for display)
        minimoPersonal,
        minimoDescendientes,
        minimoTotal,

        // Tax
        cuotaIntegra,
        effectiveRate,

        // Net income
        netAnnual,
        netMonthly,
        leefgeld,

        // Private costs (for reference)
        privateCostsMonthly: FISCAL_2025.PRIVATE_COSTS_MONTHLY
      };
    }

    /**
     * Calculate IRPF with custom fiscal configuration
     * Allows overriding RETA, minimos for what-if analysis
     *
     * @param {number} monthlyRevenue - Gross monthly revenue
     * @param {number} monthlyDeductibleExpenses - Monthly deductible expenses
     * @param {boolean} hasDescendant - Has dependent child
     * @param {object} fiscal - Custom fiscal config (merged with FISCAL_2025)
     * @returns {object} - Complete calculation breakdown
     */
    function calculateFullIRPFWithConfig(monthlyRevenue, monthlyDeductibleExpenses = 0, hasDescendant = true, fiscal = FISCAL_2025) {
      monthlyRevenue = sanitizeNumeric(monthlyRevenue);
      monthlyDeductibleExpenses = sanitizeNumeric(monthlyDeductibleExpenses);

      const annualRevenue = monthlyRevenue * 12;
      const annualExpenses = monthlyDeductibleExpenses * 12;

      const retaAnnual = fiscal.RETA_ANNUAL || FISCAL_2025.RETA_ANNUAL;
      const retaMonthly = fiscal.RETA_MONTHLY || FISCAL_2025.RETA_MONTHLY;
      const totalDeductible = annualExpenses + retaAnnual;

      const rendimientoNetoPrevio = annualRevenue - totalDeductible;
      const gastosDificil = calculateExpensesDificil(rendimientoNetoPrevio);
      const rendimientoNeto = rendimientoNetoPrevio - gastosDificil;
      const baseLiquidable = Math.max(0, rendimientoNeto);

      const minimoPersonal = fiscal.MINIMO_PERSONAL || FISCAL_2025.MINIMO_PERSONAL;
      const minimoDescendientes = hasDescendant ? (fiscal.MINIMO_DESCENDIENTES_PRIMERO || FISCAL_2025.MINIMO_DESCENDIENTES_PRIMERO) : 0;
      const minimoTotal = minimoPersonal + minimoDescendientes;

      const cuotaIntegra = calculateCuotaIntegra(baseLiquidable, minimoTotal);
      const effectiveRate = rendimientoNeto > 0 ? (cuotaIntegra / rendimientoNeto) : 0;

      const netAnnual = annualRevenue - totalDeductible - gastosDificil - cuotaIntegra;
      const netMonthly = netAnnual / 12;

      return {
        monthlyRevenue,
        annualRevenue,
        monthlyExpenses: monthlyDeductibleExpenses,
        annualExpenses,
        retaMonthly,
        retaAnnual,
        totalDeductible,
        rendimientoNetoPrevio,
        gastosDificil,
        rendimientoNeto,
        baseLiquidable,
        minimoPersonal,
        minimoDescendientes,
        minimoTotal,
        cuotaIntegra,
        effectiveRate,
        netAnnual,
        netMonthly
      };
    }

    // ============================================================
    // FORMATTING UTILITIES
    // ============================================================

    /**
     * Format amount as EUR currency (Spanish locale)
     * @param {number} amount - Amount in EUR
     * @returns {string} - Formatted string like "5.550,00 EUR"
     */
    function formatEUR(amount) {
      return new Intl.NumberFormat('es-ES', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(amount);
    }

    /**
     * Format decimal as percentage
     * @param {number} decimal - Decimal value (0.25 = 25%)
     * @returns {string} - Formatted percentage like "25,00 %"
     */
    function formatPercent(decimal) {
      return new Intl.NumberFormat('es-ES', {
        style: 'percent',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(decimal);
    }

    // ============================================================
    // SOURCE CITATION UTILITIES
    // ============================================================

    /**
     * Create source hint HTML for inline citations
     * Uses click modal for better UX
     * @param {string} sourceKey - Key from SOURCES constant
     * @returns {string} - HTML string with clickable info icon
     */
    function sourceHint(sourceKey) {
      const s = SOURCES[sourceKey];
      if (!s) return '';
      const title = s.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
      const text = `${s.source}: ${s.note}`.replace(/'/g, "\\'").replace(/"/g, '&quot;');
      return `<button type="button" class="source-hint-btn" onclick="openTooltipModal('${title}', '${text}')" aria-label="More info about ${s.name}">?</button>`;
    }

    /**
     * Create footnotes section HTML listing all sources
     * @returns {string} - HTML string with sources list
     */
    function createFootnotes() {
      let html = '<div class="footnotes"><h4>Sources</h4><ul>';
      for (const [key, s] of Object.entries(SOURCES)) {
        html += `<li>
          <strong>${s.name}</strong> -
          <a href="${s.url}" target="_blank" rel="noopener">${s.source}</a>
          <span class="confidence-${s.confidence.toLowerCase()}">[${s.confidence}]</span>
        </li>`;
      }
      html += '</ul></div>';
      return html;
    }

    // ============================================================
    // UI FUNCTIONS
    // ============================================================

    /**
     * Legacy calculate function - kept for compatibility
     * Now redirects to recalculateTotals()
     */
    function calculate() {
      recalculateTotals();
    }

    /**
     * Reset the Details tab form to defaults
     */
    function resetDetailsForm() {
      document.getElementById('monthlyRevenue').value = '6000';
      document.getElementById('hasDescendant').checked = true;
      recalculateTotals();
    }

    // ============================================================
    // SCENARIO CARD RENDERING
    // ============================================================
    // Renders scenario cards sorted by leefgeld (highest first)
    // ============================================================

    /**
     * Render all scenario cards sorted by leefgeld (highest first)
     * First card (optimal) shows "Highest Disposable" badge
     * Includes "+ New Scenario" button at the end
     */
    function renderScenarioCards() {
      const container = document.getElementById('scenarioCards');
      if (!container) return;

      const sorted = getSortedScenarios();

      const cardsHtml = sorted.map((scenario, index) => {
        const isOptimal = index === 0;
        const isSelected = scenarioState.selected.includes(scenario.id);
        const isCustom = !scenario.isPreset;
        const workTravelCost = getWorkTravelCost(scenario);
        const totalExpenses = (scenario.monthlyExpenses + workTravelCost) * 12;
        const annualRevenue = scenario.monthlyRevenue * 12;
        const effectiveRate = scenario.results.effectiveRate || 0;

        const classes = [
          'scenario-card',
          isOptimal ? 'optimal' : '',
          isSelected ? 'selected' : '',
          isCustom ? 'custom' : ''
        ].filter(Boolean).join(' ');

        // Full breakdown card with onclick for detail modal (UI-02, UI-04)
        return `
          <div class="${classes}" data-id="${scenario.id}" onclick="if(!event.target.closest('.edit-btn') && !event.target.closest('input') && !event.target.closest('.term-tooltip-trigger')) openDetailModal('${scenario.id}')">
            <div class="card-header">
              <input type="checkbox"
                     ${isSelected ? 'checked' : ''}
                     onchange="toggleScenarioSelection('${scenario.id}')"
                     aria-label="Select ${escapeHtml(scenario.name)} for comparison">
              <h3>${escapeHtml(scenario.name)}</h3>
              ${isOptimal ? '<span class="optimal-badge">Highest Disposable</span>' : ''}
            </div>

            <div class="card-metrics">
              <div class="metric">
                <span class="label">Revenue</span>
                <span class="value value-positive">${formatEUR(annualRevenue)}/yr</span>
              </div>
              <div class="metric">
                <span class="label">Expenses</span>
                <span class="value value-negative">${formatEUR(totalExpenses)}/yr</span>
              </div>
              <div class="metric divider"></div>
              <div class="metric">
                <span class="label">${createTooltip('irpf', 'IRPF')}</span>
                <span class="value value-negative">${formatEUR(scenario.results.cuotaIntegra)}</span>
              </div>
              <div class="metric">
                <span class="label">${createTooltip('reta', 'RETA')}</span>
                <span class="value value-negative">${formatEUR(scenario.results.retaAnnual)}</span>
              </div>
              <div class="metric">
                <span class="label">Tax Rate</span>
                <span class="value">${(effectiveRate * 100).toFixed(1)}%</span>
              </div>
              <div class="metric divider"></div>
              <div class="metric">
                <span class="label">Net Income</span>
                <span class="value value-positive">${formatEUR(scenario.results.netAnnual)}/yr</span>
              </div>
              <div class="metric">
                <span class="label">Monthly Net</span>
                <span class="value">${formatEUR(scenario.results.netMonthly)}</span>
              </div>
              <div class="metric highlight">
                <span class="label">${createTooltip('leefgeld', 'Disposable Income')}</span>
                <span class="value">${formatEUR(scenario.results.leefgeld)}/mo</span>
              </div>
            </div>

            <button class="edit-btn" data-permission="edit" data-permission-type="scenario" onclick="openEditModal('${scenario.id}')">
              Edit
            </button>
          </div>
        `;
      }).join('');

      // Add "+ New" button at end
      const newButtonHtml = `
        <button class="new-scenario-btn" data-permission="create" data-permission-type="scenario" onclick="showTemplateDialog()">+ New Scenario</button>
      `;

      container.innerHTML = cardsHtml + newButtonHtml;
    }

    /**
     * Toggle scenario selection for comparison
     * Updates state, saves to localStorage, and re-renders
     *
     * @param {string} scenarioId - ID of scenario to toggle
     */
    function toggleScenarioSelection(scenarioId) {
      const idx = scenarioState.selected.indexOf(scenarioId);
      if (idx === -1) {
        scenarioState.selected.push(scenarioId);
      } else {
        scenarioState.selected.splice(idx, 1);
      }
      saveScenarioState();
      renderScenarioCards();
      renderComparisonTable();
    }

    // ============================================================
    // COMPARISON TABLE RENDERING
    // ============================================================
    // Renders side-by-side comparison table for selected scenarios
    // ============================================================

    /**
     * Render comparison table for selected scenarios
     * Shows full calculation breakdown with sticky header and optimal highlighting
     */
    function renderComparisonTable() {
      const container = document.getElementById('comparisonTable');
      if (!container) return;

      const selectedIds = scenarioState.selected;

      // Empty state
      if (selectedIds.length === 0) {
        container.innerHTML = `
          <div class="comparison-empty">
            <p>Select scenarios using checkboxes to compare them side-by-side</p>
          </div>
        `;
        return;
      }

      // Get selected scenarios with results
      const scenarios = selectedIds
        .map(id => scenarioState.scenarios[id])
        .filter(Boolean)
        .map(s => ({
          ...s,
          results: calculateScenarioResults(s)
        }));

      // Verify all required properties exist on first results object (defensive check)
      if (scenarios.length > 0) {
        const requiredProps = [
          'annualRevenue', 'annualExpenses', 'retaAnnual', 'totalDeductible',
          'rendimientoNetoPrevio', 'gastosDificil', 'baseLiquidable',
          'minimoPersonal', 'minimoDescendientes', 'minimoTotal',
          'cuotaIntegra', 'effectiveRate', 'netAnnual', 'netMonthly',
          'leefgeld', 'privateCostsMonthly'
        ];
        const firstResults = scenarios[0].results;
        for (const prop of requiredProps) {
          if (firstResults[prop] === undefined) {
            console.error(`renderComparisonTable: missing property '${prop}' in results object. Check calculateFullIRPFWithFiscal return value in Plan 03-01.`);
          }
        }
      }

      // Find optimal values for highlighting
      const optimalLeefgeld = Math.max(...scenarios.map(s => s.results.leefgeld));
      const optimalEffRate = Math.min(...scenarios.map(s => s.results.effectiveRate));
      const optimalNetMonthly = Math.max(...scenarios.map(s => s.results.netMonthly));

      // Define metric rows (full breakdown per CONTEXT.md) with valueClass for color-coding (UI-07)
      // Tooltips added for key terms (UI-09)
      const metrics = [
        { label: 'Monthly Revenue', getValue: (s) => s.monthlyRevenue, format: formatEUR, valueClass: 'value-positive' },
        { label: 'Monthly Expenses', getValue: (s) => s.monthlyExpenses, format: formatEUR, valueClass: '' },
        { label: 'Work Travel Costs', getValue: (s) => getWorkTravelCost(s), format: formatEUR, valueClass: '' },
        { label: 'Total Monthly Expenses', getValue: (s) => s.monthlyExpenses + getWorkTravelCost(s), format: formatEUR, valueClass: 'value-negative' },
        { divider: true },
        { label: 'Annual Revenue', getValue: (s) => s.results.annualRevenue, format: formatEUR, valueClass: 'value-positive' },
        { label: createTooltip('reta', 'RETA (Annual)'), getValue: (s) => s.results.retaAnnual, format: formatEUR, valueClass: 'value-negative' },
        { label: 'Annual Expenses', getValue: (s) => s.results.annualExpenses, format: formatEUR, valueClass: '' },
        { label: 'Total Deductible', getValue: (s) => s.results.totalDeductible, format: formatEUR, valueClass: 'value-negative' },
        { divider: true },
        { label: 'Rendimiento Neto Previo', getValue: (s) => s.results.rendimientoNetoPrevio, format: formatEUR, valueClass: '' },
        { label: createTooltip('gastos', 'Expenses Dificil (5%)'), getValue: (s) => s.results.gastosDificil, format: formatEUR, valueClass: '' },
        { label: 'Base Liquidable', getValue: (s) => s.results.baseLiquidable, format: formatEUR, valueClass: '' },
        { divider: true },
        { label: createTooltip('minimo', 'Minimo Personal'), getValue: (s) => s.results.minimoPersonal, format: formatEUR, valueClass: '' },
        { label: createTooltip('descendientes', 'Minimo Descendientes'), getValue: (s) => s.results.minimoDescendientes, format: formatEUR, valueClass: '' },
        { label: 'Total Minimos', getValue: (s) => s.results.minimoTotal, format: formatEUR, valueClass: '' },
        { divider: true },
        { label: createTooltip('irpf', 'Cuota Integra (Annual IRPF)'), getValue: (s) => s.results.cuotaIntegra, format: formatEUR, valueClass: 'value-negative', optimalMin: true },
        { label: 'Effective Tax Rate', getValue: (s) => s.results.effectiveRate, format: formatPercent, valueClass: '', optimalMin: true },
        { divider: true },
        { label: 'Net Annual', getValue: (s) => s.results.netAnnual, format: formatEUR, valueClass: 'value-positive' },
        { label: 'Net Monthly', getValue: (s) => s.results.netMonthly, format: formatEUR, valueClass: 'value-positive', optimalMax: optimalNetMonthly },
        { label: 'Private Costs', getValue: (s) => s.results.privateCostsMonthly, format: formatEUR, valueClass: 'value-negative' },
        { label: createTooltip('leefgeld', 'Disposable Income'), getValue: (s) => s.results.leefgeld, format: formatEUR, valueClass: '', optimalMax: optimalLeefgeld, highlight: true }
      ];

      // Build table HTML
      let tableHtml = `
        <div class="comparison-container">
          <table class="comparison-table">
            <thead>
              <tr>
                <th>Metric</th>
                ${scenarios.map(s => `<th>${escapeHtml(s.name)}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
      `;

      metrics.forEach(metric => {
        if (metric.divider) {
          tableHtml += `<tr class="divider"><td colspan="${scenarios.length + 1}"></td></tr>`;
        } else {
          const rowClass = metric.highlight ? 'highlight-row' : '';
          tableHtml += `<tr class="${rowClass}">`;
          tableHtml += `<td>${metric.label}</td>`;

          scenarios.forEach(s => {
            const value = metric.getValue(s);
            const cellClasses = [];

            // Determine if this value is optimal
            if (metric.optimalMax !== undefined && value === metric.optimalMax) {
              cellClasses.push('optimal');
            }
            if (metric.optimalMin && value === optimalEffRate) {
              cellClasses.push('optimal');
            }
            // Add color class (UI-07) unless optimal takes precedence
            if (metric.valueClass && !cellClasses.includes('optimal')) {
              cellClasses.push(metric.valueClass);
            }

            const classAttr = cellClasses.length ? cellClasses.join(' ') : '';
            tableHtml += `<td class="${classAttr}">${metric.format(value)}</td>`;
          });

          tableHtml += '</tr>';
        }
      });

      tableHtml += `
            </tbody>
          </table>
        </div>
      `;

      container.innerHTML = tableHtml;

      // Also render mobile comparison view (UI-08)
      const mobileContainer = document.querySelector('.comparison-mobile');
      if (mobileContainer) {
        mobileContainer.innerHTML = renderMobileComparison(scenarios);
      }
    }

    /**
     * Render mobile comparison blocks (vertical layout)
     * @param {array} scenarios - Array of scenario objects with results
     * @returns {string} - HTML string of comparison blocks
     */
    function renderMobileComparison(scenarios) {
      if (!scenarios || scenarios.length === 0) {
        return '<p class="comparison-empty">Select scenarios to compare</p>';
      }

      const optimalLeefgeld = Math.max(...scenarios.map(s => s.results.leefgeld));

      return scenarios.map(s => {
        const isOptimal = s.results.leefgeld === optimalLeefgeld;

        return `
          <div class="comparison-block${isOptimal ? ' optimal' : ''}">
            <h4 class="block-title">${escapeHtml(s.name)}${isOptimal ? ' <span class="optimal-badge">Optimal</span>' : ''}</h4>
            <div class="block-metrics">
              <div class="block-row">
                <span class="label">Revenue</span>
                <span class="value value-positive">${formatEUR(s.results.annualRevenue)}/yr</span>
              </div>
              <div class="block-row">
                <span class="label">Expenses</span>
                <span class="value value-negative">${formatEUR(s.results.totalDeductible)}</span>
              </div>
              <div class="block-row">
                <span class="label">IRPF</span>
                <span class="value value-negative">${formatEUR(s.results.cuotaIntegra)}</span>
              </div>
              <div class="block-row">
                <span class="label">RETA</span>
                <span class="value value-negative">${formatEUR(s.results.retaAnnual)}</span>
              </div>
              <div class="block-row">
                <span class="label">Tax Rate</span>
                <span class="value">${(s.results.effectiveRate * 100).toFixed(1)}%</span>
              </div>
              <div class="block-row">
                <span class="label">Net Income</span>
                <span class="value value-positive">${formatEUR(s.results.netAnnual)}</span>
              </div>
              <div class="block-row highlight">
                <span class="label">Disposable Income</span>
                <span class="value">${formatEUR(s.results.leefgeld)}/mo</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    /**
     * Copy comparison table data to clipboard (UI-10)
     * Strips tooltips from cells before copying
     */
    async function copyTableToClipboard() {
      const table = document.querySelector('.comparison-table');
      if (!table) {
        showNotification('No comparison data to copy', 'error');
        return;
      }

      const rows = Array.from(table.querySelectorAll('tr'));
      const text = rows.map(row => {
        const cells = Array.from(row.querySelectorAll('th, td'));
        return cells.map(cell => {
          // Get text content, stripping tooltips
          const clone = cell.cloneNode(true);
          clone.querySelectorAll('[role="tooltip"]').forEach(t => t.remove());
          return clone.textContent.trim();
        }).join('\t');
      }).join('\n');

      try {
        await navigator.clipboard.writeText(text);
        showNotification('Copied to clipboard!');
      } catch (err) {
        console.error('Clipboard write failed:', err);
        showNotification('Copy failed - try again', 'error');
      }
    }

    // ============================================================
    // DETAIL MODAL FUNCTIONALITY (UI-04)
    // ============================================================
    // Read-only modal for viewing full scenario breakdown
    // ============================================================

    let currentDetailScenarioId = null;

    /**
     * Open detail modal showing full scenario breakdown
     * @param {string} scenarioId - ID of scenario to display
     */
    function openDetailModal(scenarioId) {
      const scenario = scenarioState.scenarios[scenarioId];
      if (!scenario) return;

      currentDetailScenarioId = scenarioId;
      const results = calculateScenarioResults(scenario);
      const body = document.getElementById('detail-body');
      const dialog = document.getElementById('detail-modal');
      const title = dialog.querySelector('.detail-title');
      const isOptimal = getSortedScenarios()[0]?.id === scenarioId;

      title.textContent = scenario.name + (isOptimal ? ' (Optimal)' : '');

      const workTravelCost = getWorkTravelCost(scenario);

      body.innerHTML = `
        <div class="detail-section">
          <h4>Income</h4>
          <div class="detail-row">
            <span class="label">Monthly Revenue</span>
            <span class="value">${formatEUR(scenario.monthlyRevenue)}</span>
          </div>
          <div class="detail-row">
            <span class="label">Annual Revenue</span>
            <span class="value">${formatEUR(results.annualRevenue)}</span>
          </div>
        </div>

        <div class="detail-section">
          <h4>Expenses</h4>
          <div class="detail-row">
            <span class="label">Spain Deductible</span>
            <span class="value value-negative">${formatEUR(scenario.monthlyExpenses * 12)}</span>
          </div>
          <div class="detail-row">
            <span class="label">Work Travel Costs</span>
            <span class="value value-negative">${formatEUR(workTravelCost * 12)}</span>
          </div>
          <div class="detail-row">
            <span class="label">Private Costs</span>
            <span class="value value-negative">${formatEUR(results.privateCostsMonthly * 12)}</span>
          </div>
          <div class="detail-row total">
            <span class="label">Total Expenses</span>
            <span class="value">${formatEUR(results.annualExpenses + (workTravelCost * 12))}</span>
          </div>
        </div>

        <div class="detail-section">
          <h4>Taxes</h4>
          <div class="detail-row">
            <span class="label">IRPF (Income Tax)</span>
            <span class="value value-negative">${formatEUR(results.cuotaIntegra)}</span>
          </div>
          <div class="detail-row">
            <span class="label">RETA (Social Security)</span>
            <span class="value value-negative">${formatEUR(results.retaAnnual)}</span>
          </div>
          <div class="detail-row">
            <span class="label">Effective Tax Rate</span>
            <span class="value">${(results.effectiveRate * 100).toFixed(1)}%</span>
          </div>
        </div>

        <div class="detail-section">
          <h4>Net Result</h4>
          <div class="detail-row">
            <span class="label">Net Income (Annual)</span>
            <span class="value value-positive">${formatEUR(results.netAnnual)}</span>
          </div>
          <div class="detail-row">
            <span class="label">Monthly Net</span>
            <span class="value value-positive">${formatEUR(results.netMonthly)}</span>
          </div>
          <div class="detail-row total">
            <span class="label">Disposable Income</span>
            <span class="value">${formatEUR(results.leefgeld)}/mo</span>
          </div>
        </div>
      `;

      dialog.showModal();
    }

    /**
     * Close detail modal
     */
    function closeDetailModal() {
      document.getElementById('detail-modal').close();
      currentDetailScenarioId = null;
    }

    /**
     * Transition from detail modal to edit modal
     */
    function editFromDetail() {
      const scenarioId = currentDetailScenarioId;
      closeDetailModal();
      if (scenarioId && typeof openEditModal === 'function') {
        openEditModal(scenarioId);
      }
    }

    // ============================================================
    // EDIT MODAL FUNCTIONALITY
    // ============================================================
    // Modal for editing scenario values with live results preview
    // ============================================================

    let currentEditScenarioId = null;

    /**
     * Open edit modal for a scenario
     * Populates form with scenario values and shows modal
     *
     * @param {string} scenarioId - ID of scenario to edit
     */
    function openEditModal(scenarioId) {
      const scenario = scenarioState.scenarios[scenarioId];
      if (!scenario) return;

      currentEditScenarioId = scenarioId;
      const dialog = document.getElementById('editScenarioDialog');

      // Populate form fields
      document.getElementById('editScenarioName').value = scenario.name;
      document.getElementById('editMonthlyRevenue').value = scenario.monthlyRevenue;
      document.getElementById('editMonthlyExpenses').value = scenario.monthlyExpenses;
      document.getElementById('editWorkTravelCost').value = getWorkTravelCost(scenario);
      document.getElementById('editHasDescendant').checked = scenario.hasDescendant;

      // Populate fiscal overrides (empty means use default)
      const overrides = scenario.fiscalOverrides || {};
      document.getElementById('editRetaOverride').value = overrides.RETA_MONTHLY || '';
      document.getElementById('editMinimoPersonalOverride').value = overrides.MINIMO_PERSONAL || '';
      document.getElementById('editMinimoDescOverride').value = overrides.MINIMO_DESCENDIENTES_PRIMERO || '';

      // Show/hide delete button based on preset status
      const deleteBtn = document.getElementById('deleteScenarioBtn');
      deleteBtn.style.display = scenario.isPreset ? 'none' : 'block';

      // Update dialog title
      document.getElementById('dialogTitle').textContent = `Edit ${scenario.name}`;

      // Calculate and show initial results
      updateLiveResults();

      // Open modal
      dialog.showModal();
    }

    /**
     * Close edit modal without saving
     */
    function closeEditModal() {
      const dialog = document.getElementById('editScenarioDialog');
      dialog.close();
      currentEditScenarioId = null;
    }

    // ============================================================
    // LIVE RECALCULATION
    // ============================================================
    // requestAnimationFrame-debounced live recalculation on input
    // ============================================================

    let liveCalcRafId = null;

    /**
     * Handle input change in edit modal
     * Uses requestAnimationFrame for debouncing
     */
    function onScenarioInputChange() {
      // Cancel any pending recalculation
      if (liveCalcRafId) {
        cancelAnimationFrame(liveCalcRafId);
      }

      // Schedule recalculation for next frame
      liveCalcRafId = requestAnimationFrame(() => {
        updateLiveResults();
        liveCalcRafId = null;
      });
    }

    /**
     * Get current values from edit form
     * @returns {object} - Form values with fiscalOverrides if any
     */
    function getEditFormValues() {
      const monthlyRevenue = parseFloat(document.getElementById('editMonthlyRevenue').value) || 0;
      const monthlyExpenses = parseFloat(document.getElementById('editMonthlyExpenses').value) || 0;
      const workTravelCost = parseFloat(document.getElementById('editWorkTravelCost').value) || 0;
      const hasDescendant = document.getElementById('editHasDescendant').checked;

      // Fiscal overrides (empty string = use default)
      const retaOverride = document.getElementById('editRetaOverride').value;
      const minimoPersonalOverride = document.getElementById('editMinimoPersonalOverride').value;
      const minimoDescOverride = document.getElementById('editMinimoDescOverride').value;

      let fiscalOverrides = null;
      if (retaOverride || minimoPersonalOverride || minimoDescOverride) {
        fiscalOverrides = {};
        if (retaOverride) {
          fiscalOverrides.RETA_MONTHLY = parseFloat(retaOverride);
          fiscalOverrides.RETA_ANNUAL = parseFloat(retaOverride) * 12;
        }
        if (minimoPersonalOverride) {
          fiscalOverrides.MINIMO_PERSONAL = parseFloat(minimoPersonalOverride);
        }
        if (minimoDescOverride) {
          fiscalOverrides.MINIMO_DESCENDIENTES_PRIMERO = parseFloat(minimoDescOverride);
        }
      }

      return {
        name: document.getElementById('editScenarioName').value.trim(),
        monthlyRevenue,
        monthlyExpenses,
        workTravelCost,
        hasDescendant,
        fiscalOverrides
      };
    }

    /**
     * Update live results pane with calculated values
     * Called on every input change (debounced)
     */
    function updateLiveResults() {
      const values = getEditFormValues();
      const results = calculateScenarioResults(values);

      // Verify results object has all expected properties (defensive programming)
      // These properties are guaranteed by calculateFullIRPFWithFiscal in Plan 03-01
      const requiredProps = [
        'annualRevenue', 'totalDeductible', 'rendimientoNeto', 'gastosDificil',
        'baseLiquidable', 'minimoTotal', 'cuotaIntegra', 'effectiveRate',
        'retaAnnual', 'netMonthly', 'leefgeld'
      ];
      for (const prop of requiredProps) {
        if (results[prop] === undefined) {
          console.error(`updateLiveResults: missing property '${prop}' in results object`);
        }
      }

      const container = document.getElementById('liveEditResults');
      container.innerHTML = `
        <div class="live-result-row">
          <span class="label">Annual Revenue</span>
          <span class="value">${formatEUR(results.annualRevenue)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Total Deductible</span>
          <span class="value">${formatEUR(results.totalDeductible)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Rendimiento Neto</span>
          <span class="value">${formatEUR(results.rendimientoNeto)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Expenses Dificil (5%)</span>
          <span class="value">${formatEUR(results.gastosDificil)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Base Liquidable</span>
          <span class="value">${formatEUR(results.baseLiquidable)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Total Minimos</span>
          <span class="value">${formatEUR(results.minimoTotal)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Cuota Integra (IRPF)</span>
          <span class="value">${formatEUR(results.cuotaIntegra)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Effective Tax Rate</span>
          <span class="value">${formatPercent(results.effectiveRate)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">RETA Annual</span>
          <span class="value">${formatEUR(results.retaAnnual)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Net Monthly</span>
          <span class="value">${formatEUR(results.netMonthly)}</span>
        </div>
        <div class="live-result-row highlight">
          <span class="label">Disposable Income</span>
          <span class="value">${formatEUR(results.leefgeld)}/mo</span>
        </div>
      `;
    }

    // ============================================================
    // SAVE AND DELETE FUNCTIONALITY
    // ============================================================

    /**
     * Save changes from edit form to scenario state
     * Called when dialog closes with 'save' return value
     */
    function saveScenarioChanges() {
      if (!currentEditScenarioId) return;

      const values = getEditFormValues();

      // Validate name
      if (!values.name) {
        alert('Please enter a scenario name');
        return;
      }

      const scenario = scenarioState.scenarios[currentEditScenarioId];
      if (!scenario) return;

      // Update scenario (keep id and isPreset)
      Object.assign(scenario, {
        name: values.name,
        monthlyRevenue: values.monthlyRevenue,
        monthlyExpenses: values.monthlyExpenses,
        workTravelCost: values.workTravelCost,
        hasDescendant: values.hasDescendant,
        fiscalOverrides: values.fiscalOverrides
      });
      // Remove legacy property if present
      delete scenario.belgiumPattern;

      saveScenarioState();
      renderScenarioCards();
      renderComparisonTable();
    }

    /**
     * Confirm and delete current scenario
     * Only works for custom scenarios (not presets A-E)
     */
    function confirmDeleteScenario() {
      if (!currentEditScenarioId) return;

      const scenario = scenarioState.scenarios[currentEditScenarioId];
      if (!scenario) return;

      if (scenario.isPreset) {
        alert('Cannot delete preset scenarios (A-E). You can only delete custom scenarios.');
        return;
      }

      if (confirm(`Delete "${scenario.name}"? This cannot be undone.`)) {
        delete scenarioState.scenarios[currentEditScenarioId];
        scenarioState.customOrder = scenarioState.customOrder.filter(id => id !== currentEditScenarioId);
        scenarioState.selected = scenarioState.selected.filter(id => id !== currentEditScenarioId);
        saveScenarioState();
        closeEditModal();
        renderScenarioCards();
        renderComparisonTable();
      }
    }

    /**
     * Initialize edit dialog event handlers
     * Called on DOMContentLoaded
     */
    function initEditDialog() {
      const dialog = document.getElementById('editScenarioDialog');
      if (!dialog) return;

      // Handle form submit (Save button)
      dialog.addEventListener('close', () => {
        if (dialog.returnValue === 'save') {
          saveScenarioChanges();
        }
      });

      // Prevent Esc from saving (cancel event)
      dialog.addEventListener('cancel', (e) => {
        // Default behavior is fine - just closes without saving
      });

      // Attach input change handlers for live recalculation
      const inputs = dialog.querySelectorAll('input, select');
      inputs.forEach(input => {
        input.addEventListener('input', onScenarioInputChange);
        input.addEventListener('change', onScenarioInputChange); // For checkboxes and selects
      });
    }

    // ============================================================
    // TEMPLATE DIALOG / CUSTOM SCENARIO CREATION
    // ============================================================
    // Create new scenarios from existing scenario templates
    // ============================================================

    let selectedTemplateId = null;

    /**
     * Show template selection dialog for creating new scenario
     */
    function showTemplateDialog() {
      const dialog = document.getElementById('templateSelectDialog');
      const optionsContainer = document.getElementById('templateOptions');

      // Build template options from all scenarios
      const allScenarios = Object.values(scenarioState.scenarios);

      optionsContainer.innerHTML = allScenarios.map((s, index) => {
        const workTravelCost = getWorkTravelCost(s);
        const checked = index === 0 ? 'checked' : '';

        return `
          <label class="template-option">
            <input type="radio" name="template" value="${s.id}" ${checked}>
            <div class="template-info">
              <div class="template-name">${escapeHtml(s.name)}</div>
              <div class="template-desc">${formatEUR(s.monthlyRevenue)}/mo revenue, ${formatEUR(s.monthlyExpenses + workTravelCost)}/mo expenses</div>
            </div>
          </label>
        `;
      }).join('');

      // Clear name input
      document.getElementById('newScenarioName').value = '';

      dialog.showModal();
    }

    /**
     * Close template dialog without creating
     */
    function closeTemplateDialog() {
      document.getElementById('templateSelectDialog').close();
    }

    /**
     * Initialize template dialog event handlers
     * Called on DOMContentLoaded
     */
    function initTemplateDialog() {
      const dialog = document.getElementById('templateSelectDialog');
      if (!dialog) return;

      dialog.addEventListener('close', () => {
        if (dialog.returnValue === 'create') {
          createCustomScenario();
        }
      });
    }

    /**
     * Create a new custom scenario from selected template
     * Called when template dialog closes with 'create' return value
     */
    function createCustomScenario() {
      const name = document.getElementById('newScenarioName').value.trim();
      if (!name) {
        alert('Please enter a name for the scenario');
        return;
      }

      // Get selected template
      const selectedRadio = document.querySelector('#templateOptions input[name="template"]:checked');
      if (!selectedRadio) {
        alert('Please select a template');
        return;
      }

      const templateId = selectedRadio.value;
      const template = scenarioState.scenarios[templateId];
      if (!template) return;

      // Create new scenario from template
      const newScenario = {
        ...structuredClone(template),
        id: crypto.randomUUID(),
        name: name,
        isPreset: false,
        fiscalOverrides: null  // Reset any overrides from template
      };

      // Add to state
      scenarioState.scenarios[newScenario.id] = newScenario;
      scenarioState.customOrder.push(newScenario.id);
      saveScenarioState();
      renderScenarioCards();
      renderComparisonTable();

      // Open edit modal for new scenario
      openEditModal(newScenario.id);
    }

    // Tooltip escape key handler (UI-09, BUG-02)
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        // Close tooltip modal if open (handled natively by dialog)
        // Remove focus from any tooltip trigger
        if (document.activeElement.classList.contains('term-tooltip-trigger')) {
          document.activeElement.blur();
        }
      }
    });

    // ============================================================
    // PHASE 7: COMPLIANCE TAB CONTENT
    // ============================================================

    // ===========================================
    // PHASE 7: COMPLIANCE WARNING BANNER
    // ===========================================

    function getComplianceWarningDismissKey() {
      return 'complianceWarningDismissed_session';
    }

    function isComplianceWarningDismissed() {
      return sessionStorage.getItem(getComplianceWarningDismissKey()) === 'true';
    }

    function dismissComplianceWarning() {
      sessionStorage.setItem(getComplianceWarningDismissKey(), 'true');
      const banner = document.getElementById('complianceWarningBanner');
      if (banner) {
        banner.classList.remove('visible');
      }
    }

    function getBelgiumDayCount() {
      // Uses existing calendarState from Phase 4
      if (typeof calendarState === 'undefined' || !calendarState.days) return 0;
      let count = 0;
      for (const dateKey in calendarState.days) {
        const dayData = calendarState.days[dateKey];
        const status = dayData.status;
        // Count Belgium and Travel days toward threshold (conservative approach)
        if (status === 'belgium' || status === 'travel') {
          count++;
        }
      }
      return count;
    }

    function updateComplianceWarning() {
      const banner = document.getElementById('complianceWarningBanner');
      const textEl = document.getElementById('warningText');
      if (!banner || !textEl) return;

      // Don't show if dismissed this session
      if (isComplianceWarningDismissed()) {
        banner.classList.remove('visible');
        return;
      }

      const belgiumDays = getBelgiumDayCount();

      // Remove previous threshold classes
      banner.classList.remove('threshold-170', 'threshold-180', 'threshold-183');

      if (belgiumDays >= 183) {
        banner.classList.add('visible', 'threshold-183');
        textEl.innerHTML = `<strong>${belgiumDays} Belgium/travel days.</strong> You have exceeded the 183-day threshold. Treaty tie-breaker provisions apply to determine tax residence.`;
      } else if (belgiumDays >= 180) {
        banner.classList.add('visible', 'threshold-180');
        textEl.innerHTML = `<strong>${belgiumDays} Belgium/travel days.</strong> You are approaching the 183-day threshold. Review treaty provisions in the Compliance tab.`;
      } else if (belgiumDays >= 170) {
        banner.classList.add('visible', 'threshold-170');
        textEl.innerHTML = `<strong>${belgiumDays} Belgium/travel days.</strong> Approaching 183-day threshold. Consider reviewing treaty provisions.`;
      } else {
        banner.classList.remove('visible');
      }
    }

    /**
     * Render the Compliance tab content with collapsible sections
     * Two-column layout: Left = Working requirements, Right = Tax residence rules
     */
    function renderComplianceContent() {
      const panel = document.getElementById('compliancePanel');
      if (!panel) return;

      panel.innerHTML = `
        <h2>Compliance Information</h2>

        <div class="compliance-columns">
          <!-- LEFT COLUMN: Working in Belgium -->
          <div class="compliance-col">
            <div class="action-phase">
              <h3>While Working in Belgium</h3>
              <div class="compliance-section">
                <button class="section-header" aria-expanded="false" aria-controls="content-dietas">
                  <span>Dietas Limits</span>
                  <span class="section-icon">&#9654;</span>
                </button>
                <div class="section-content" id="content-dietas" hidden>
                  <table class="fiscal-table">
                    <thead><tr><th>Location</th><th>Overnight</th><th>Day only</th></tr></thead>
                    <tbody>
                      <tr><td>Spain</td><td>${formatEUR(DIETAS_LIMITS.spain.withOvernight)}</td><td>${formatEUR(DIETAS_LIMITS.spain.withoutOvernight)}</td></tr>
                      <tr><td>Belgium</td><td class="highlight">${formatEUR(DIETAS_LIMITS.abroad.withOvernight)}</td><td>${formatEUR(DIETAS_LIMITS.abroad.withoutOvernight)}</td></tr>
                    </tbody>
                  </table>
                  <cite class="source-citation">${renderInlineSource('AEAT_DIETAS', DIETAS_LIMITS.source)} | ${renderInlineSource('BOE_REGLAMENTO_IRPF', 'Reglamento Art. 9')}</cite>
                </div>
              </div>
              <div class="compliance-section">
                <button class="section-header" aria-expanded="false" aria-controls="content-factura">
                  <span>Factura Completa</span>
                  <span class="section-icon">&#9654;</span>
                </button>
                <div class="section-content" id="content-factura" hidden>
                  <p class="plain-summary"><strong>Required for deduction:</strong> complete invoice (not just receipt)</p>
                  <ul class="requirements-list">
                    ${FACTURA_REQUIREMENTS.required.map(r => `<li><span class="field-name">${r.field}</span><span class="field-desc">${r.description}</span></li>`).join('')}
                  </ul>
                  <div class="invalid-list">
                    <h5>NOT Valid:</h5>
                    <ul class="requirements-list">
                      ${FACTURA_REQUIREMENTS.notValid.map(r => `<li><span class="invalid-type">${r.type}</span> - ${r.reason}</li>`).join('')}
                    </ul>
                  </div>
                  <cite class="source-citation">${renderInlineSource('AEAT_FACTURACION', FACTURA_REQUIREMENTS.source)}</cite>
                </div>
              </div>
              <div class="compliance-section">
                <button class="section-header" aria-expanded="false" aria-controls="content-payment">
                  <span>Payment Method</span>
                  <span class="section-icon">&#9654;</span>
                </button>
                <div class="section-content" id="content-payment" hidden>
                  <div class="payment-warning">
                    <strong>Cash = NOT deductible</strong>
                    <p>Use: bank card, transfer, Bizum, or traceable electronic payment</p>
                  </div>
                  <cite class="source-citation">Ley 6/2017 (AEAT)</cite>
                </div>
              </div>
            </div>
          </div>

          <!-- RIGHT COLUMN: Tax Residence -->
          <div class="compliance-col">
            <div class="action-phase">
              <h3>Tax Residence Rules</h3>
              <div class="compliance-section">
                <button class="section-header" aria-expanded="false" aria-controls="content-183">
                  <span>183-Day Threshold</span>
                  <span class="section-icon">&#9654;</span>
                </button>
                <div class="section-content" id="content-183" hidden>
                  <p class="plain-summary">183+ days in Spain = Spanish tax resident (domestic law)</p>
                  <div class="entry-exit-warning">
                    <strong>Entry/exit days count in BOTH countries</strong>
                    <p>Travel day counts in both Spain and Belgium simultaneously</p>
                  </div>
                  <cite class="source-citation">${renderInlineSource('BOE_LIRPF', 'LIRPF Art. 9.1.a')}</cite>
                </div>
              </div>
              <div class="compliance-section">
                <button class="section-header" aria-expanded="false" aria-controls="content-family">
                  <span>Family Presumption</span>
                  <span class="section-icon">&#9654;</span>
                </button>
                <div class="section-content" id="content-family" hidden>
                  <p class="plain-summary"><strong>Art. 9.1.b LIRPF:</strong> ${ARTICLE_9_1_B.plainSummary}</p>
                  <p class="plain-summary"><strong>Implication:</strong> ${ARTICLE_9_1_B.implication}</p>
                  <cite class="source-citation">${renderInlineSource('BOE_LIRPF', ARTICLE_9_1_B.source)}</cite>
                </div>
              </div>
              <div class="compliance-section">
                <button class="section-header" aria-expanded="false" aria-controls="content-tiebreaker">
                  <span>Treaty Tie-Breaker</span>
                  <span class="section-icon">&#9654;</span>
                </button>
                <div class="section-content" id="content-tiebreaker" hidden>
                  <p class="plain-summary">When both countries claim you, treaty resolves via 5-step hierarchy:</p>
                  <ol class="tie-breaker-steps">
                    ${TREATY_ARTICLE_4.steps.map(s => `<li><span class="step-name">${s.name}</span><span class="step-plain">${s.plain}</span></li>`).join('')}
                  </ol>
                  <cite class="source-citation">${renderInlineSource('BOE_TREATY', 'BOE-A-2003-13375')} | ${renderInlineSource('AEAT_TREATY_BELGIUM', 'AEAT Belgium CDI')}</cite>
                </div>
              </div>
              <div class="compliance-section">
                <button class="section-header" aria-expanded="false" aria-controls="content-centro">
                  <span>Vital Interests</span>
                  <span class="section-icon">&#9654;</span>
                </button>
                <div class="section-content" id="content-centro" hidden>
                  <p class="plain-summary"><strong>Personal:</strong> Family, social ties, "where you live your life"</p>
                  <p class="plain-summary"><strong>Economic:</strong> Work, income, property</p>
                  <p class="plain-summary">Family location often tips the balance when combined with maintained home and regular returns.</p>
                  <cite class="source-citation">OECD Model Tax Convention Commentary, Art. 4</cite>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Official Sources Section (Phase 8: ENH-03/04/05) -->
        <div class="sources-section">
          <h3>Official Sources</h3>
          <p style="color: var(--text-muted); font-size: var(--size-small); margin-bottom: var(--spacing-md);">
            All fiscal data in this calculator is sourced from official Spanish government publications.
            Click any link to verify at the original source.
          </p>

          <div class="sources-grid">
            <div class="sources-category">
              <h4>IRPF / Income Tax</h4>
              <div class="sources-category-links" id="sourcesIRPF"></div>
            </div>

            <div class="sources-category">
              <h4>RETA / Social Security</h4>
              <div class="sources-category-links" id="sourcesRETA"></div>
            </div>

            <div class="sources-category">
              <h4>Treaty & Residency</h4>
              <div class="sources-category-links" id="sourcesTreaty"></div>
            </div>

            <div class="sources-category">
              <h4>Expenses & Documentation</h4>
              <div class="sources-category-links" id="sourcesExpenses"></div>
            </div>
          </div>
        </div>
      `;

      // Set up collapsible section event listeners
      panel.querySelectorAll('.compliance-section .section-header').forEach(btn => {
        btn.addEventListener('click', () => {
          const expanded = btn.getAttribute('aria-expanded') === 'true';
          btn.setAttribute('aria-expanded', !expanded);
          const contentId = btn.getAttribute('aria-controls');
          const content = document.getElementById(contentId);
          if (content) {
            content.hidden = expanded;
          }
        });
      });

      // Initialize sources section
      initSourcesSection();
    }

    /**
     * Initialize Official Sources section with categorized links (Phase 8: ENH-03/04/05)
     */
    function initSourcesSection() {
      // IRPF Sources
      const irpfContainer = document.getElementById('sourcesIRPF');
      if (irpfContainer) {
        irpfContainer.innerHTML = [
          renderSourceLink('AEAT_IRPF'),
          renderSourceLink('AEAT_AUTONOMOS'),
          renderSourceLink('AEAT_MINIMO_PERSONAL'),
          renderSourceLink('AEAT_MINIMO_DESCENDIENTES'),
          renderSourceLink('AEAT_ESTIMACION_DIRECTA')
        ].join('');
      }

      // RETA Sources
      const retaContainer = document.getElementById('sourcesRETA');
      if (retaContainer) {
        retaContainer.innerHTML = [
          renderSourceLink('SS_RETA'),
          renderSourceLink('RETA_COTIZACION')
        ].join('');
      }

      // Treaty Sources
      const treatyContainer = document.getElementById('sourcesTreaty');
      if (treatyContainer) {
        treatyContainer.innerHTML = [
          renderSourceLink('BOE_TREATY'),
          renderSourceLink('AEAT_TREATY_BELGIUM'),
          renderSourceLink('BOE_LIRPF')
        ].join('');
      }

      // Expenses Sources
      const expensesContainer = document.getElementById('sourcesExpenses');
      if (expensesContainer) {
        expensesContainer.innerHTML = [
          renderSourceLink('AEAT_DIETAS'),
          renderSourceLink('BOE_REGLAMENTO_IRPF'),
          renderSourceLink('AEAT_FACTURACION')
        ].join('');
      }
    }

    /**
     * Initialize Details tab source hints (Phase 8: ENH-03)
     */
    function initDetailsSourceHints() {
      // RETA source hint
      const retaHint = document.getElementById('retaSourceHint');
      if (retaHint) {
        retaHint.innerHTML = `Fixed from registration ${renderInlineSource('SS_RETA', 'RETA rates')}`;
      }

      // Minimo Personal source hint
      const minimoHint = document.getElementById('minimoSourceHint');
      if (minimoHint) {
        minimoHint.innerHTML = renderInlineSource('AEAT_MINIMO_PERSONAL', 'AEAT source');
      }
    }

    // =====================================================
    // PHASE 12: Data Architecture Foundation
    // =====================================================

    const DB_NAME = 'AutonomoBusinessDB';
    const DB_VERSION = 4;

    class AppDatabase extends Dexie {
      constructor() {
        super(DB_NAME);

        // Version 1: Original schema (keep for upgrade path)
        this.version(1).stores({
          // Business entities (autonomo, SL)
          entities: '++id, type, nif_cif, name, is_active, created_at, deleted_at',

          // Clients
          clients: '++id, entity_id, nif_cif, name, country, category, created_at, deleted_at, [entity_id+deleted_at]',

          // Projects (per client)
          projects: '++id, client_id, entity_id, name, status, rate_cents, created_at, deleted_at',

          // Invoices (VeriFactu compliant)
          invoices: '++id, entity_id, client_id, series, invoice_number, status, date_issued, date_due, subtotal_cents, iva_cents, irpf_cents, total_cents, deleted_at, [entity_id+series+invoice_number], [entity_id+deleted_at], [entity_id+status]',

          // Invoice line items
          invoice_lines: '++id, invoice_id, description, quantity, unit_price_cents, iva_rate, line_total_cents',

          // Invoice sequences (per entity, per series)
          invoice_sequences: '++id, entity_id, series, last_number, [entity_id+series]',

          // Expenses
          expenses: '++id, entity_id, category, subcategory, vendor, date, amount_cents, iva_cents, deductible_amount_cents, description, is_billable, client_id, project_id, receipt_id, created_at, deleted_at, [entity_id+deleted_at], [entity_id+category], [entity_id+date]',

          // Receipts (linked to expenses)
          receipts: '++id, expense_id, file_name, file_type, file_data, ocr_status, ocr_confidence, ocr_extracted, created_at',

          // Calendar days
          calendar_days: '++id, entity_id, date, location, client_id, project_id, notes, created_at, updated_at, [entity_id+date]',

          // Tax calculations (cached results)
          tax_calculations: '++id, entity_id, tax_type, period_start, period_end, calculated_at, input_data, result_data',

          // Sync queue
          sync_queue: '++id, table_name, record_id, operation, data, created_at, retry_count, last_error',

          // App settings
          settings: 'key, value, updated_at'
        });

        // Version 2: Add authentication and permissions tables
        this.version(2).stores({
          // Business entities - now with owner_id for auth
          entities: '++id, type, nif_cif, name, is_active, owner_id, created_at, deleted_at',

          // Existing tables (unchanged indexes)
          clients: '++id, entity_id, nif_cif, name, country, category, created_at, deleted_at, [entity_id+deleted_at]',
          projects: '++id, client_id, entity_id, name, status, rate_cents, created_at, deleted_at',
          invoices: '++id, entity_id, client_id, series, invoice_number, status, date_issued, date_due, subtotal_cents, iva_cents, irpf_cents, total_cents, deleted_at, [entity_id+series+invoice_number], [entity_id+deleted_at], [entity_id+status]',
          invoice_lines: '++id, invoice_id, description, quantity, unit_price_cents, iva_rate, line_total_cents',
          invoice_sequences: '++id, entity_id, series, last_number, [entity_id+series]',
          expenses: '++id, entity_id, category, subcategory, vendor, date, amount_cents, iva_cents, deductible_amount_cents, description, is_billable, client_id, project_id, receipt_id, created_at, deleted_at, [entity_id+deleted_at], [entity_id+category], [entity_id+date]',
          receipts: '++id, expense_id, file_name, file_type, file_data, ocr_status, ocr_confidence, ocr_extracted, created_at',
          calendar_days: '++id, entity_id, date, location, client_id, project_id, notes, created_at, updated_at, [entity_id+date]',
          tax_calculations: '++id, entity_id, tax_type, period_start, period_end, calculated_at, input_data, result_data',
          sync_queue: '++id, table_name, record_id, operation, data, created_at, retry_count, last_error',
          settings: 'key, value, updated_at',

          // NEW: Authentication and permissions tables (Phase 14)
          // User profiles - extends Supabase auth.users
          profiles: 'id, email',  // id is UUID from auth.users (not auto-increment)

          // Entity sharing - junction table for user-entity-role relationships
          entity_shares: '++id, entity_id, user_id, [entity_id+user_id]',

          // Entity invitations - pending invitations with expiry
          entity_invitations: '++id, entity_id, invite_code, email, expires_at',

          // User sessions - tracks active sessions per user
          user_sessions: '++id, user_id, last_active_at'
        }).upgrade(tx => {
          // Migration: Add owner_id to existing entities (nullable until user authenticates)
          return tx.table('entities').toCollection().modify(entity => {
            if (entity.owner_id === undefined) {
              entity.owner_id = null;  // Will be set on first authentication
            }
          });
        });

        // Version 3: Add contacts table (Phase 15)
        this.version(3).stores({
          // All existing tables unchanged
          entities: '++id, type, nif_cif, name, is_active, owner_id, created_at, deleted_at',
          clients: '++id, entity_id, nif_cif, name, country, category, created_at, deleted_at, [entity_id+deleted_at]',
          projects: '++id, client_id, entity_id, name, status, rate_cents, created_at, deleted_at',
          invoices: '++id, entity_id, client_id, series, invoice_number, status, date_issued, date_due, subtotal_cents, iva_cents, irpf_cents, total_cents, deleted_at, [entity_id+series+invoice_number], [entity_id+deleted_at], [entity_id+status]',
          invoice_lines: '++id, invoice_id, description, quantity, unit_price_cents, iva_rate, line_total_cents',
          invoice_sequences: '++id, entity_id, series, last_number, [entity_id+series]',
          expenses: '++id, entity_id, category, subcategory, vendor, date, amount_cents, iva_cents, deductible_amount_cents, description, is_billable, client_id, project_id, receipt_id, created_at, deleted_at, [entity_id+deleted_at], [entity_id+category], [entity_id+date]',
          receipts: '++id, expense_id, file_name, file_type, file_data, ocr_status, ocr_confidence, ocr_extracted, created_at',
          calendar_days: '++id, entity_id, date, location, client_id, project_id, notes, created_at, updated_at, [entity_id+date]',
          tax_calculations: '++id, entity_id, tax_type, period_start, period_end, calculated_at, input_data, result_data',
          sync_queue: '++id, table_name, record_id, operation, data, created_at, retry_count, last_error',
          settings: 'key, value, updated_at',
          profiles: 'id, email',
          entity_shares: '++id, entity_id, user_id, [entity_id+user_id]',
          entity_invitations: '++id, entity_id, invite_code, email, expires_at',
          user_sessions: '++id, user_id, last_active_at',

          // NEW: Contacts table (Phase 15)
          contacts: '++id, client_id, entity_id, name, role, is_primary, created_at, deleted_at, [client_id+deleted_at]'
        });

        // Version 4: Add invoice_payments table (Phase 18)
        this.version(4).stores({
          // All existing tables unchanged
          entities: '++id, type, nif_cif, name, is_active, owner_id, created_at, deleted_at',
          clients: '++id, entity_id, nif_cif, name, country, category, created_at, deleted_at, [entity_id+deleted_at]',
          projects: '++id, client_id, entity_id, name, status, rate_cents, created_at, deleted_at',
          invoices: '++id, entity_id, client_id, series, invoice_number, status, date_issued, date_due, subtotal_cents, iva_cents, irpf_cents, total_cents, deleted_at, [entity_id+series+invoice_number], [entity_id+deleted_at], [entity_id+status]',
          invoice_lines: '++id, invoice_id, description, quantity, unit_price_cents, iva_rate, line_total_cents',
          invoice_sequences: '++id, entity_id, series, last_number, [entity_id+series]',
          expenses: '++id, entity_id, category, subcategory, vendor, date, amount_cents, iva_cents, deductible_amount_cents, description, is_billable, client_id, project_id, receipt_id, created_at, deleted_at, [entity_id+deleted_at], [entity_id+category], [entity_id+date]',
          receipts: '++id, expense_id, file_name, file_type, file_data, ocr_status, ocr_confidence, ocr_extracted, created_at',
          calendar_days: '++id, entity_id, date, location, client_id, project_id, notes, created_at, updated_at, [entity_id+date]',
          tax_calculations: '++id, entity_id, tax_type, period_start, period_end, calculated_at, input_data, result_data',
          sync_queue: '++id, table_name, record_id, operation, data, created_at, retry_count, last_error',
          settings: 'key, value, updated_at',
          profiles: 'id, email',
          entity_shares: '++id, entity_id, user_id, [entity_id+user_id]',
          entity_invitations: '++id, entity_id, invite_code, email, expires_at',
          user_sessions: '++id, user_id, last_active_at',
          contacts: '++id, client_id, entity_id, name, role, is_primary, created_at, deleted_at, [client_id+deleted_at]',

          // NEW: Invoice payments table (Phase 18)
          invoice_payments: '++id, invoice_id, amount_cents, date, method, reference, created_at, [invoice_id]'
        });

        // Define table references
        this.entities = this.table('entities');
        this.clients = this.table('clients');
        this.contacts = this.table('contacts');
        this.projects = this.table('projects');
        this.invoices = this.table('invoices');
        this.invoice_lines = this.table('invoice_lines');
        this.invoice_sequences = this.table('invoice_sequences');
        this.expenses = this.table('expenses');
        this.receipts = this.table('receipts');
        this.calendar_days = this.table('calendar_days');
        this.tax_calculations = this.table('tax_calculations');
        this.sync_queue = this.table('sync_queue');
        this.settings = this.table('settings');

        // NEW: Auth table references (Phase 14)
        this.profiles = this.table('profiles');
        this.entity_shares = this.table('entity_shares');
        this.entity_invitations = this.table('entity_invitations');
        this.user_sessions = this.table('user_sessions');

        // NEW: Invoice payments table reference (Phase 18)
        this.invoice_payments = this.table('invoice_payments');
      }
    }

    const db = new AppDatabase();

    // =====================================================
    // PHASE 14: Authentication & Permissions Helpers
    // =====================================================

    /**
     * ProfileManager - User profile CRUD operations
     * Profiles extend Supabase auth.users with additional fields
     */
    const ProfileManager = {
      /**
       * Get user profile by ID
       * @param {string} userId - UUID from auth.users
       * @returns {Promise<Object|undefined>} Profile object or undefined
       */
      async getProfile(userId) {
        return await db.profiles.get(userId);
      },

      /**
       * Create or update user profile
       * @param {string} userId - UUID from auth.users
       * @param {Object} data - Profile data (name, email, nif_cif, phone, address)
       * @returns {Promise<Object>} Updated profile
       */
      async upsertProfile(userId, data) {
        const existing = await db.profiles.get(userId);
        const now = new Date().toISOString();

        if (existing) {
          await db.profiles.update(userId, {
            ...data,
            updated_at: now
          });
        } else {
          await db.profiles.add({
            id: userId,
            name: data.name || null,
            email: data.email || null,
            nif_cif: data.nif_cif || null,
            phone: data.phone || null,
            address: data.address || null,
            created_at: now,
            updated_at: now
          });
        }
        return await db.profiles.get(userId);
      },

      /**
       * Delete user profile
       * @param {string} userId - UUID from auth.users
       */
      async deleteProfile(userId) {
        await db.profiles.delete(userId);
      }
    };

    /**
     * EntityShareManager - Entity sharing and permissions
     * Manages user-entity-role relationships for multi-user access
     */
    const EntityShareManager = {
      // Role constants with descriptions
      ROLES: Object.freeze({
        GESTOR: 'gestor',        // Read-only access (fiscal advisor view)
        ACCOUNTANT: 'accountant', // Read-write, no delete (bookkeeper)
        PARTNER: 'partner'        // Full admin minus entity deletion (business partner)
      }),

      /**
       * Get all shares for an entity
       * @param {number} entityId - Entity ID
       * @returns {Promise<Array>} Array of share objects
       */
      async getShares(entityId) {
        return await db.entity_shares
          .where('entity_id').equals(entityId)
          .toArray();
      },

      /**
       * Get all entities a user has access to (accepted shares only)
       * @param {string} userId - UUID from auth.users
       * @returns {Promise<Array>} Array of share objects
       */
      async getUserShares(userId) {
        return await db.entity_shares
          .where('user_id').equals(userId)
          .filter(share => share.accepted_at !== null)
          .toArray();
      },

      /**
       * Add share for user on entity
       * @param {number} entityId - Entity ID
       * @param {string} userId - UUID from auth.users
       * @param {string} role - One of ROLES values
       * @param {string} invitedBy - UUID of user who invited
       * @returns {Promise<number>} New share ID
       */
      async addShare(entityId, userId, role, invitedBy) {
        if (!Object.values(this.ROLES).includes(role)) {
          throw new Error(`Invalid role: ${role}. Must be one of: ${Object.values(this.ROLES).join(', ')}`);
        }

        // Check for existing share
        const existing = await db.entity_shares
          .where('[entity_id+user_id]').equals([entityId, userId])
          .first();

        if (existing) {
          throw new Error('User already has access to this entity');
        }

        const now = new Date().toISOString();
        return await db.entity_shares.add({
          entity_id: entityId,
          user_id: userId,
          role,
          invited_by: invitedBy,
          invited_at: now,
          accepted_at: now  // Local shares are immediately accepted
        });
      },

      /**
       * Remove share for user on entity
       * @param {number} entityId - Entity ID
       * @param {string} userId - UUID from auth.users
       * @returns {Promise<number>} Number of records deleted (0 or 1)
       */
      async removeShare(entityId, userId) {
        return await db.entity_shares
          .where('[entity_id+user_id]').equals([entityId, userId])
          .delete();
      },

      /**
       * Get user's role for an entity
       * @param {number} entityId - Entity ID
       * @param {string} userId - UUID from auth.users
       * @returns {Promise<string|null>} Role string or null if no access
       */
      async getRole(entityId, userId) {
        const share = await db.entity_shares
          .where('[entity_id+user_id]').equals([entityId, userId])
          .first();
        return share?.role || null;
      },

      /**
       * Update user's role for an entity
       * @param {number} entityId - Entity ID
       * @param {string} userId - UUID from auth.users
       * @param {string} newRole - New role to assign
       */
      async updateRole(entityId, userId, newRole) {
        if (!Object.values(this.ROLES).includes(newRole)) {
          throw new Error(`Invalid role: ${newRole}. Must be one of: ${Object.values(this.ROLES).join(', ')}`);
        }

        const count = await db.entity_shares
          .where('[entity_id+user_id]').equals([entityId, userId])
          .modify({ role: newRole });

        if (count === 0) {
          throw new Error('Share not found');
        }
      }
    };

    /**
     * InvitationManager - Entity invitation management
     * Handles pending invitations with expiry and invite codes
     */
    const InvitationManager = {
      EXPIRY_DAYS: 7,  // Invitations expire after 7 days

      /**
       * Create a new invitation
       * @param {number} entityId - Entity ID to invite to
       * @param {string} role - Role to assign on acceptance
       * @param {string} invitedBy - UUID of inviting user
       * @param {string|null} email - Optional email for directed invitation
       * @returns {Promise<Object>} Invitation with invite code
       */
      async createInvitation(entityId, role, invitedBy, email = null) {
        const inviteCode = crypto.randomUUID();
        const now = new Date();
        const expiresAt = new Date(now.getTime() + this.EXPIRY_DAYS * 24 * 60 * 60 * 1000);

        const invitation = {
          entity_id: entityId,
          email: email,
          invite_code: inviteCode,
          role,
          invited_by: invitedBy,
          created_at: now.toISOString(),
          expires_at: expiresAt.toISOString(),
          used_at: null,
          used_by: null
        };

        await db.entity_invitations.add(invitation);
        return { ...invitation, inviteCode };
      },

      /**
       * Get valid invitation by code (not expired, not used)
       * @param {string} inviteCode - Invitation code
       * @returns {Promise<Object|null>} Invitation or null if invalid/expired
       */
      async getInvitation(inviteCode) {
        const invitation = await db.entity_invitations
          .where('invite_code').equals(inviteCode)
          .first();

        if (!invitation) return null;
        if (invitation.used_at) return null;
        if (new Date(invitation.expires_at) < new Date()) return null;

        return invitation;
      },

      /**
       * Accept an invitation
       * @param {string} inviteCode - Invitation code
       * @param {string} userId - UUID of accepting user
       * @returns {Promise<Object>} Accepted invitation
       */
      async acceptInvitation(inviteCode, userId) {
        const invitation = await this.getInvitation(inviteCode);
        if (!invitation) {
          throw new Error('Invalid or expired invitation');
        }

        // Mark invitation as used
        await db.entity_invitations.update(invitation.id, {
          used_at: new Date().toISOString(),
          used_by: userId
        });

        // Create entity share
        await EntityShareManager.addShare(
          invitation.entity_id,
          userId,
          invitation.role,
          invitation.invited_by
        );

        return invitation;
      },

      /**
       * Get pending (valid) invitations for an entity
       * @param {number} entityId - Entity ID
       * @returns {Promise<Array>} Array of pending invitations
       */
      async getPendingInvitations(entityId) {
        const now = new Date().toISOString();
        return await db.entity_invitations
          .where('entity_id').equals(entityId)
          .filter(inv => inv.used_at === null && inv.expires_at > now)
          .toArray();
      },

      /**
       * Revoke (delete) a pending invitation
       * @param {number} invitationId - Invitation ID
       */
      async revokeInvitation(invitationId) {
        await db.entity_invitations.delete(invitationId);
      },

      /**
       * Check if an email has a pending invitation for an entity
       * @param {number} entityId - Entity ID
       * @param {string} email - Email to check
       * @returns {Promise<Object|null>} Pending invitation or null
       */
      async getPendingInvitationByEmail(entityId, email) {
        const now = new Date().toISOString();
        return await db.entity_invitations
          .where('entity_id').equals(entityId)
          .filter(inv =>
            inv.email === email &&
            inv.used_at === null &&
            inv.expires_at > now
          )
          .first();
      }
    };

    /**
     * SessionManager - User session tracking
     * Tracks active sessions per user for security monitoring
     */
    const SessionManager = {
      /**
       * Record a new session
       * @param {string} userId - UUID from auth.users
       * @param {Object} metadata - Optional session metadata
       * @returns {Promise<string>} Session ID
       */
      async recordSession(userId, metadata = {}) {
        const now = new Date().toISOString();
        const sessionId = crypto.randomUUID();

        await db.user_sessions.add({
          id: sessionId,
          user_id: userId,
          device_name: metadata.deviceName || this.detectDeviceName(),
          user_agent: navigator.userAgent,
          ip_address: null,   // Can only be set server-side
          location: null,     // Can only be set server-side
          last_active_at: now,
          created_at: now
        });

        return sessionId;
      },

      /**
       * Detect device name from user agent
       * @returns {string} Device name
       */
      detectDeviceName() {
        const ua = navigator.userAgent;
        if (/iPhone/.test(ua)) return 'iPhone';
        if (/iPad/.test(ua)) return 'iPad';
        if (/Android/.test(ua)) return 'Android Device';
        if (/Mac/.test(ua)) return 'Mac';
        if (/Windows/.test(ua)) return 'Windows PC';
        if (/Linux/.test(ua)) return 'Linux';
        return 'Unknown Device';
      },

      /**
       * Update last active timestamp for session
       * @param {string} sessionId - Session ID
       */
      async updateLastActive(sessionId) {
        await db.user_sessions.update(sessionId, {
          last_active_at: new Date().toISOString()
        });
      },

      /**
       * Get all sessions for a user (sorted by last active, newest first)
       * @param {string} userId - UUID from auth.users
       * @returns {Promise<Array>} Array of sessions
       */
      async getSessions(userId) {
        return await db.user_sessions
          .where('user_id').equals(userId)
          .reverse()
          .sortBy('last_active_at');
      },

      /**
       * Revoke (delete) a session
       * @param {string} sessionId - Session ID
       */
      async revokeSession(sessionId) {
        await db.user_sessions.delete(sessionId);
      },

      /**
       * Revoke all sessions except current
       * @param {string} userId - UUID from auth.users
       * @param {string} currentSessionId - Session ID to keep
       */
      async revokeOtherSessions(userId, currentSessionId) {
        const sessions = await this.getSessions(userId);
        for (const session of sessions) {
          if (session.id !== currentSessionId) {
            await this.revokeSession(session.id);
          }
        }
      },

      /**
       * Get session by ID
       * @param {string} sessionId - Session ID
       * @returns {Promise<Object|undefined>} Session object
       */
      async getSession(sessionId) {
        return await db.user_sessions.get(sessionId);
      }
    };

    // =====================================================
    // PHASE 14: Supabase Configuration & Authentication
    // =====================================================

    /**
     * Supabase Configuration
     * These values should be set from environment or config.
     * For local development/single-file HTML, they can be hardcoded temporarily.
     *
     * Get these values from:
     * - url: Supabase Dashboard > Project Settings > API > Project URL
     * - anonKey: Supabase Dashboard > Project Settings > API > anon public key
     */
    const SUPABASE_CONFIG = {
      url: '',      // Set from Supabase Dashboard
      anonKey: ''   // Set from Supabase Dashboard
    };

    // Supabase client instance (null if not configured)
    // Note: Using 'supabaseClient' to avoid conflict with global 'supabase' from CDN
    let supabaseClient = null;

    /**
     * Phase 16-06: Google Calendar Configuration
     * For Google Calendar sync, set CLIENT_ID from Google Cloud Console:
     * 1. Go to Google Cloud Console > APIs & Services > Credentials
     * 2. Create an OAuth 2.0 Client ID (Web application type)
     * 3. Add authorized JavaScript origins (localhost:3013 for dev, production URL)
     * 4. Enable Google Calendar API in APIs & Services > Library
     */
    const GCAL_CONFIG = Object.freeze({
      CLIENT_ID: '', // Set from Google Cloud Console > OAuth 2.0 Client IDs
      SCOPES: 'https://www.googleapis.com/auth/calendar.events',
      DISCOVERY_DOC: 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest',
      CALENDAR_ID: 'primary'  // User's primary calendar
    });

    /**
     * Phase 16-06: Google Calendar Sync Module
     * Handles OAuth authorization and bidirectional sync with Google Calendar
     */
    const GCalSync = {
      tokenClient: null,
      accessToken: null,
      gapiInitialized: false,
      gisInitialized: false,
      isAuthorized: false,

      /**
       * Authorize with Google Calendar
       * Opens OAuth consent screen if not already authorized
       */
      authorize() {
        if (!this.tokenClient) {
          showNotification('Google Calendar not configured. Set CLIENT_ID in GCAL_CONFIG.', 'error');
          return;
        }

        // Request access token (prompts user consent)
        this.tokenClient.requestAccessToken();
      },

      /**
       * Revoke Google Calendar access
       * Clears authorization state and updates UI
       */
      revoke() {
        if (this.accessToken) {
          google.accounts.oauth2.revoke(this.accessToken, () => {
            this.accessToken = null;
            this.isAuthorized = false;
            updateGCalUI();
            showNotification('Disconnected from Google Calendar', 'info');
          });
        }
      },

      /**
       * Push a single day entry to Google Calendar
       * Creates or updates a calendar event for the work day
       * @param {Object} day - Calendar day record from IndexedDB
       * @param {string|null} clientName - Client name for event summary
       * @param {string|null} projectName - Project name for event summary
       */
      async pushToGCal(day, clientName, projectName) {
        if (!this.isAuthorized) throw new Error('Not authorized');

        const locationText = {
          belgium: 'Belgium Work Day',
          spain: 'Spain',
          travel: 'Travel Day',
          other: 'Other'
        }[day.location] || day.location;

        // Build event summary with client/project info
        let summary = locationText;
        if (clientName) summary += ` - ${clientName}`;
        if (projectName) summary += ` (${projectName})`;

        // Calculate end date (next day for all-day events)
        const startDate = new Date(day.date);
        const endDate = new Date(startDate);
        endDate.setDate(endDate.getDate() + 1);
        const endDateStr = toISODateKey(endDate);

        const event = {
          summary,
          description: day.notes || '',
          start: { date: day.date },
          end: { date: endDateStr }
        };

        // Check if event already exists (update vs create)
        if (day.gcal_event_id) {
          // Update existing event
          await gapi.client.calendar.events.update({
            calendarId: GCAL_CONFIG.CALENDAR_ID,
            eventId: day.gcal_event_id,
            resource: event
          });
        } else {
          // Create new event
          const response = await gapi.client.calendar.events.insert({
            calendarId: GCAL_CONFIG.CALENDAR_ID,
            resource: event
          });

          // Store event ID for future updates
          if (day.id) {
            await db.calendar_days.update(day.id, {
              gcal_event_id: response.result.id,
              gcal_sync_status: 'synced'
            });
          }
        }
      },

      /**
       * Pull events from Google Calendar
       * Retrieves events in date range for read-only display
       * @param {string} startDate - Start date (YYYY-MM-DD)
       * @param {string} endDate - End date (YYYY-MM-DD)
       * @returns {Promise<Array>} Array of Google Calendar events
       */
      async pullFromGCal(startDate, endDate) {
        if (!this.isAuthorized) throw new Error('Not authorized');

        const response = await gapi.client.calendar.events.list({
          calendarId: GCAL_CONFIG.CALENDAR_ID,
          timeMin: `${startDate}T00:00:00Z`,
          timeMax: `${endDate}T23:59:59Z`,
          singleEvents: true,
          orderBy: 'startTime'
        });

        return response.result.items || [];
      },

      /**
       * Main sync function - push local calendar to Google Calendar
       * Per CALENDAR-16: app calendar entries win, external events shown read-only
       * @returns {Promise<Object>} Sync result with pushed/pulled counts
       */
      async sync() {
        if (!this.isAuthorized) {
          this.authorize();
          return { pushed: 0, pulled: 0 };
        }

        const year = calendarState.currentYear;
        const startDate = `${year}-01-01`;
        const endDate = `${year}-12-31`;

        // Get local days from IndexedDB
        const localDays = await CalendarManager.getDaysForYear(year);

        // Get client lookup for names
        const clients = await ClientManager.getClients({});
        const clientMap = new Map(clients.map(c => [c.id, c.name]));

        // Get project lookup for names
        const projects = await db.projects
          .where('entity_id').equals(EntityContext.entityId)
          .toArray();
        const projectMap = new Map(projects.map(p => [p.id, p.name]));

        // Push local changes to GCal
        let pushed = 0;
        for (const day of localDays) {
          // Skip days without a location set
          if (!day.location || day.location === 'unset') continue;

          try {
            const clientName = day.client_id ? clientMap.get(day.client_id) : null;
            const projectName = day.project_id ? projectMap.get(day.project_id) : null;
            await this.pushToGCal(day, clientName, projectName);
            pushed++;
          } catch (e) {
            console.warn(`Failed to sync day ${day.date}:`, e);
          }
        }

        // Pull GCal events (for read-only display)
        let pulled = 0;
        try {
          const gcalEvents = await this.pullFromGCal(startDate, endDate);
          // Per CALENDAR-16: external events shown as read-only suggestions
          // We don't overwrite local data, just count for display
          pulled = gcalEvents.length;
        } catch (e) {
          console.warn('Failed to pull GCal events:', e);
        }

        showNotification(`Synced ${pushed} days to Google Calendar`, 'success');
        return { pushed, pulled };
      }
    };

    /**
     * Phase 16-06: Initialize Google API client library
     * Loads the discovery document for Calendar API
     */
    async function initGapi() {
      try {
        await new Promise((resolve, reject) => {
          gapi.load('client', { callback: resolve, onerror: reject });
        });

        await gapi.client.init({
          discoveryDocs: [GCAL_CONFIG.DISCOVERY_DOC]
        });

        GCalSync.gapiInitialized = true;
        DEBUG && console.log('Google API client initialized');
        maybeEnableGCalSync();
      } catch (err) {
        console.error('Failed to initialize Google API client:', err);
      }
    }

    /**
     * Phase 16-06: Initialize Google Identity Services
     * Sets up OAuth token client for authorization flow
     */
    function initGis() {
      if (!GCAL_CONFIG.CLIENT_ID) {
        DEBUG && console.log('GCal sync disabled: CLIENT_ID not configured');
        updateGCalUI();
        return;
      }

      try {
        GCalSync.tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: GCAL_CONFIG.CLIENT_ID,
          scope: GCAL_CONFIG.SCOPES,
          callback: handleGCalTokenResponse
        });

        GCalSync.gisInitialized = true;
        DEBUG && console.log('Google Identity Services initialized');
        maybeEnableGCalSync();
      } catch (err) {
        console.error('Failed to initialize Google Identity Services:', err);
      }
    }

    /**
     * Phase 16-06: Enable sync UI once both Google libraries loaded
     */
    function maybeEnableGCalSync() {
      if (GCalSync.gapiInitialized && GCalSync.gisInitialized) {
        const connectBtn = document.getElementById('gcalConnectBtn');
        if (connectBtn) {
          connectBtn.removeAttribute('disabled');
        }
        updateGCalUI();
      }
    }

    /**
     * Phase 16-06: Handle OAuth token response
     * @param {Object} response - Token response from Google
     */
    function handleGCalTokenResponse(response) {
      if (response.error) {
        console.error('GCal OAuth error:', response.error);
        showNotification('Google Calendar authorization failed', 'error');
        return;
      }

      GCalSync.accessToken = response.access_token;
      GCalSync.isAuthorized = true;
      updateGCalUI();
      showNotification('Connected to Google Calendar', 'success');
    }

    /**
     * Phase 16-06: Update Google Calendar UI based on connection state
     */
    function updateGCalUI() {
      const notConfigured = document.getElementById('gcalNotConfigured');
      const disconnected = document.getElementById('gcalDisconnected');
      const connected = document.getElementById('gcalConnected');

      if (!notConfigured || !disconnected || !connected) return;

      if (!GCAL_CONFIG.CLIENT_ID) {
        notConfigured.style.display = 'block';
        disconnected.style.display = 'none';
        connected.style.display = 'none';
        return;
      }

      notConfigured.style.display = 'none';

      if (GCalSync.isAuthorized) {
        disconnected.style.display = 'none';
        connected.style.display = 'flex';
      } else {
        disconnected.style.display = 'block';
        connected.style.display = 'none';
      }
    }

    /**
     * Phase 16-06: Handle sync button click with progress indicator
     * Shows visual feedback during sync operation
     */
    async function syncToGCal() {
      const syncBtn = document.getElementById('gcalSyncBtn');
      if (!syncBtn) return;

      const originalText = syncBtn.textContent;

      try {
        syncBtn.textContent = 'Syncing...';
        syncBtn.disabled = true;

        const result = await GCalSync.sync();

        syncBtn.textContent = 'Synced!';
        setTimeout(() => {
          syncBtn.textContent = originalText;
          syncBtn.disabled = false;
        }, 2000);

      } catch (e) {
        console.error('Sync failed:', e);
        showNotification('Sync failed: ' + e.message, 'error');
        syncBtn.textContent = originalText;
        syncBtn.disabled = false;
      }
    }

    /**
     * Initialize Supabase client
     * @returns {boolean} True if initialized, false if config missing
     */
    function initializeSupabase() {
      if (SUPABASE_CONFIG.url && SUPABASE_CONFIG.anonKey) {
        supabaseClient = window.supabase.createClient(
          SUPABASE_CONFIG.url,
          SUPABASE_CONFIG.anonKey
        );
        DEBUG && console.log('Supabase client initialized');
        return true;
      } else {
        console.warn('Supabase config not set - auth features disabled. Running in offline-only mode.');
        return false;
      }
    }

    /**
     * AuthManager - Handles all authentication flows
     * Supports magic link (passwordless), Google OAuth, password reset, and session management
     */
    const AuthManager = {
      currentUser: null,
      currentSession: null,
      authStateListeners: [],
      localSessionId: null,
      pendingMFAFactorId: null,

      /**
       * Initialize auth state
       * Checks for OAuth callback, restores session, and sets up auth state listener
       * @returns {Promise<Object|null>} Current session or null
       */
      async initialize() {
        if (!supabaseClient) {
          DEBUG && console.log('AuthManager: Running in offline mode (no Supabase)');
          return null;
        }

        // Check for OAuth callback (code in URL)
        const url = new URL(window.location.href);
        const code = url.searchParams.get('code');
        if (code) {
          await this.handleOAuthCallback(code);
          // Clean URL
          window.history.replaceState({}, document.title, window.location.pathname);
        }

        // Get current session
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        if (error) {
          console.error('Auth session error:', error);
          return null;
        }

        if (session) {
          this.currentSession = session;
          this.currentUser = session.user;
          await this.onAuthSuccess(session);

          // Check if MFA verification is needed (Phase 14-04)
          const mfaCheck = await MFAManager.checkMFARequired();
          if (mfaCheck.required) {
            const factors = await MFAManager.getFactors();
            if (factors.length > 0) {
              this.pendingMFAFactorId = factors[0].id;
              // MFAUI will show MFA challenge when AuthUI.updateAuthState() is called
            }
          }
        }

        // Listen for auth state changes
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
          DEBUG && console.log('Auth state change:', event);
          this.currentSession = session;
          this.currentUser = session?.user || null;

          if (event === 'SIGNED_IN' && session) {
            await this.onAuthSuccess(session);
          } else if (event === 'SIGNED_OUT') {
            await this.onSignOut();
          }

          // Notify listeners
          this.authStateListeners.forEach(listener => listener(event, session));
        });

        return session;
      },

      /**
       * Sign in with magic link (passwordless email) - AUTH-01, AUTH-02
       * @param {string} email - User's email address
       * @returns {Promise<Object>} Success object with message
       */
      async signInWithMagicLink(email) {
        if (!supabaseClient) {
          throw new Error('Supabase not configured. Please set SUPABASE_CONFIG.');
        }

        const redirectTo = `${window.location.origin}${window.location.pathname}`;
        const { data, error } = await supabaseClient.auth.signInWithOtp({
          email,
          options: {
            shouldCreateUser: true,
            emailRedirectTo: redirectTo
          }
        });

        if (error) throw error;
        return { success: true, message: 'Check your email for the login link' };
      },

      /**
       * Sign in with Google OAuth
       * User will be redirected to Google, then back to the app
       */
      async signInWithGoogle() {
        if (!supabaseClient) {
          throw new Error('Supabase not configured. Please set SUPABASE_CONFIG.');
        }

        const redirectTo = `${window.location.origin}${window.location.pathname}`;
        const { data, error } = await supabaseClient.auth.signInWithOAuth({
          provider: 'google',
          options: {
            redirectTo
          }
        });

        if (error) throw error;
        // User will be redirected to Google
      },

      /**
       * Handle OAuth callback (code exchange)
       * @param {string} code - Authorization code from URL
       * @returns {Promise<Object|null>} Session object or null
       */
      async handleOAuthCallback(code) {
        if (!supabaseClient) return null;

        // Check if this is a recovery flow
        const url = new URL(window.location.href);
        const type = url.searchParams.get('type');

        const { data, error } = await supabaseClient.auth.exchangeCodeForSession(code);
        if (error) {
          console.error('OAuth callback error:', error);
          throw error;
        }

        // If recovery, don't auto-redirect - let UI handle password update
        if (type === 'recovery') {
          DEBUG && console.log('Password recovery session detected');
          // UI should show password update form
        }

        return data.session;
      },

      /**
       * Request password reset email - AUTH-03
       * @param {string} email - User's email address
       * @returns {Promise<Object>} Success object with message
       */
      async requestPasswordReset(email) {
        if (!supabaseClient) {
          throw new Error('Supabase not configured');
        }

        const redirectTo = `${window.location.origin}${window.location.pathname}`;
        const { data, error } = await supabaseClient.auth.resetPasswordForEmail(email, {
          redirectTo
        });

        if (error) throw error;
        return { success: true, message: 'Check your email for the password reset link' };
      },

      /**
       * Update password (called after clicking reset link)
       * @param {string} newPassword - New password
       * @returns {Promise<Object>} Success object with message
       */
      async updatePassword(newPassword) {
        if (!supabaseClient) {
          throw new Error('Supabase not configured');
        }

        const { data, error } = await supabaseClient.auth.updateUser({
          password: newPassword
        });

        if (error) throw error;
        return { success: true, message: 'Password updated successfully' };
      },

      /**
       * Check if current session is a password recovery session
       * @returns {boolean} True if recovery session
       */
      isRecoverySession() {
        if (!this.currentSession) return false;
        // Supabase sets this when user clicks password reset link
        const url = new URL(window.location.href);
        return url.searchParams.get('type') === 'recovery';
      },

      /**
       * Called after successful authentication
       * Updates profile, records session, claims orphaned entities
       * @param {Object} session - Supabase session object
       */
      async onAuthSuccess(session) {
        const user = session.user;
        DEBUG && console.log('User authenticated:', user.email);

        // Upsert profile from auth metadata
        await ProfileManager.upsertProfile(user.id, {
          email: user.email,
          name: user.user_metadata?.name || user.user_metadata?.full_name || null
        });

        // Record session
        this.localSessionId = await SessionManager.recordSession(user.id, {
          deviceName: SessionManager.detectDeviceName()
        });

        // Claim ownership of entities without owner
        await this.claimOrphanedEntities(user.id);
      },

      /**
       * Claim entities that don't have an owner (migration from v1)
       * @param {string} userId - User ID to assign as owner
       */
      async claimOrphanedEntities(userId) {
        const entities = await db.entities
          .filter(e => !e.owner_id && !e.deleted_at)
          .toArray();

        for (const entity of entities) {
          await db.entities.update(entity.id, { owner_id: userId });
          DEBUG && console.log(`Claimed entity ${entity.id} for user ${userId}`);
        }
      },

      /**
       * Sign out - AUTH-06
       * @param {string} scope - 'local' (this device), 'global' (all devices), 'others' (other devices)
       */
      async signOut(scope = 'local') {
        if (!supabaseClient) return;

        const { error } = await supabaseClient.auth.signOut({ scope });
        if (error) throw error;
      },

      /**
       * Called after sign out
       * Cleans up local session record
       */
      async onSignOut() {
        // Clean up local session record
        if (this.localSessionId) {
          await SessionManager.revokeSession(this.localSessionId);
          this.localSessionId = null;
        }
        this.currentUser = null;
        this.currentSession = null;
      },

      /**
       * Subscribe to auth state changes
       * @param {Function} listener - Callback (event, session) => void
       * @returns {Function} Unsubscribe function
       */
      onAuthStateChange(listener) {
        this.authStateListeners.push(listener);
        // Return unsubscribe function
        return () => {
          this.authStateListeners = this.authStateListeners.filter(l => l !== listener);
        };
      },

      /**
       * Check if user is authenticated
       * @returns {boolean} True if authenticated
       */
      isAuthenticated() {
        return !!this.currentUser;
      },

      /**
       * Get current user
       * @returns {Object|null} Current user or null
       */
      getUser() {
        return this.currentUser;
      },

      /**
       * Get current session
       * @returns {Object|null} Current session or null
       */
      getSession() {
        return this.currentSession;
      },

      /**
       * Check if running in offline mode (no Supabase)
       * @returns {boolean} True if offline mode
       */
      isOfflineMode() {
        return !supabaseClient || this._offlineMode === true;
      },

      // Force offline mode (for demo/testing)
      _offlineMode: false
    };

    /**
     * MFAManager - Handles TOTP Two-Factor Authentication
     * Phase 14-04 - AUTH-05
     */
    const MFAManager = {
      /**
       * Check if MFA is required for current session
       * @returns {Promise<Object>} { required, currentLevel, nextLevel, error? }
       */
      async checkMFARequired() {
        if (!supabaseClient) return { required: false };

        try {
          const { data: { currentLevel, nextLevel }, error } =
            await supabaseClient.auth.mfa.getAuthenticatorAssuranceLevel();

          if (error) throw error;

          // MFA required if enrolled (nextLevel=aal2) but session is aal1
          const required = currentLevel === 'aal1' && nextLevel === 'aal2';
          return { required, currentLevel, nextLevel };
        } catch (error) {
          console.error('MFA check error:', error);
          return { required: false, error };
        }
      },

      /**
       * Get enrolled MFA factors
       * @returns {Promise<Array>} Array of TOTP factors
       */
      async getFactors() {
        if (!supabaseClient) return [];

        try {
          const { data, error } = await supabaseClient.auth.mfa.listFactors();
          if (error) throw error;
          return data.totp || [];
        } catch (error) {
          console.error('List factors error:', error);
          return [];
        }
      },

      /**
       * Check if user has MFA enabled
       * @returns {Promise<boolean>} True if MFA is enabled
       */
      async isMFAEnabled() {
        const factors = await this.getFactors();
        return factors.length > 0;
      },

      /**
       * Start MFA enrollment (AUTH-05)
       * @returns {Promise<Object>} { factorId, qrCode, secret, uri }
       */
      async enroll() {
        if (!supabaseClient) {
          throw new Error('Supabase not configured');
        }

        const { data, error } = await supabaseClient.auth.mfa.enroll({
          factorType: 'totp',
          friendlyName: 'Authenticator App'
        });

        if (error) throw error;

        return {
          factorId: data.id,
          qrCode: data.totp.qr_code,  // SVG data URI
          secret: data.totp.secret,   // For manual entry
          uri: data.totp.uri
        };
      },

      /**
       * Verify enrollment with TOTP code
       * @param {string} factorId - Factor ID from enrollment
       * @param {string} code - 6-digit TOTP code
       * @returns {Promise<boolean>} True if verified
       */
      async verifyEnrollment(factorId, code) {
        if (!supabaseClient) {
          throw new Error('Supabase not configured');
        }

        const { data, error } = await supabaseClient.auth.mfa.challengeAndVerify({
          factorId,
          code
        });

        if (error) throw error;

        DEBUG && console.log('MFA enrollment verified');
        return true;
      },

      /**
       * Verify MFA challenge during login
       * @param {string} factorId - Factor ID
       * @param {string} code - 6-digit TOTP code
       * @returns {Promise<boolean>} True if verified
       */
      async verifyChallenge(factorId, code) {
        if (!supabaseClient) {
          throw new Error('Supabase not configured');
        }

        const { data, error } = await supabaseClient.auth.mfa.challengeAndVerify({
          factorId,
          code
        });

        if (error) throw error;

        DEBUG && console.log('MFA challenge verified, session upgraded to AAL2');
        return true;
      },

      /**
       * Unenroll MFA factor (disable 2FA)
       * @param {string} factorId - Factor ID to unenroll
       * @returns {Promise<boolean>} True if unenrolled
       */
      async unenroll(factorId) {
        if (!supabaseClient) {
          throw new Error('Supabase not configured');
        }

        const { data, error } = await supabaseClient.auth.mfa.unenroll({
          factorId
        });

        if (error) throw error;

        DEBUG && console.log('MFA factor unenrolled');
        return true;
      }
    };

    /**
     * AuthUI - Handles authentication UI state and form interactions
     * Phase 14-03
     */
    const AuthUI = {
      /**
       * Show/hide auth screen based on auth state
       */
      updateAuthState() {
        const authScreen = document.getElementById('auth-screen');
        const dashboard = document.querySelector('.dashboard');
        const loadingScreen = document.getElementById('loading-screen');

        if (AuthManager.isOfflineMode()) {
          // Show offline notice
          const notice = document.getElementById('auth-offline-notice');
          if (notice) notice.style.display = 'block';
        }

        if (AuthManager.isAuthenticated() || AuthManager.isOfflineMode()) {
          // Check for pending MFA challenge (Phase 14-04)
          if (AuthManager.pendingMFAFactorId) {
            MFAUI.showChallenge(AuthManager.pendingMFAFactorId);
            return; // Don't show main app until MFA verified
          }

          // User authenticated or offline mode - show main app
          if (authScreen) authScreen.classList.add('hidden');
          if (dashboard) dashboard.style.display = '';
        } else {
          // Not authenticated - show login
          if (authScreen) authScreen.classList.remove('hidden');
          if (dashboard) dashboard.style.display = 'none';
          if (loadingScreen) loadingScreen.style.display = 'none';
        }

        // Check for recovery session
        if (AuthManager.isRecoverySession && AuthManager.isRecoverySession()) {
          this.showView('new-password');
        }
      },

      /**
       * Show specific auth view (main, reset, new-password)
       * @param {string} view - View name
       */
      showView(view) {
        const container = document.querySelector('.auth-container');
        if (container) {
          container.setAttribute('data-view', view);
        }
        // Clear messages
        this.clearMessages();
      },

      /**
       * Clear all message elements
       */
      clearMessages() {
        document.querySelectorAll('.auth-message').forEach(el => {
          el.style.display = 'none';
          el.textContent = '';
          el.className = 'auth-message';
        });
      },

      /**
       * Show message in a specific element
       * @param {string} elementId - Target element ID
       * @param {string} message - Message text
       * @param {string} type - 'success' or 'error'
       */
      showMessage(elementId, message, type = 'success') {
        const el = document.getElementById(elementId);
        if (el) {
          el.textContent = message;
          el.className = `auth-message ${type}`;
          el.style.display = 'block';
        }
      },

      /**
       * Handle magic link form submission
       * @param {Event} event - Form submit event
       */
      async handleMagicLink(event) {
        event.preventDefault();
        const email = document.getElementById('auth-email').value.trim();
        const submitBtn = document.getElementById('auth-submit-btn');

        if (!email) return;

        try {
          submitBtn.disabled = true;
          submitBtn.textContent = 'Sending...';

          const result = await AuthManager.signInWithMagicLink(email);
          this.showMessage('auth-message', result.message, 'success');

        } catch (error) {
          console.error('Magic link error:', error);
          this.showMessage('auth-message', error.message || 'Failed to send magic link', 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Continue with Email';
        }
      },

      /**
       * Handle Google sign in button click
       */
      async handleGoogle() {
        try {
          await AuthManager.signInWithGoogle();
          // User will be redirected to Google
        } catch (error) {
          console.error('Google sign in error:', error);
          this.showMessage('auth-message', error.message || 'Google sign in failed', 'error');
        }
      },

      /**
       * Handle password reset form submission
       * @param {Event} event - Form submit event
       */
      async handlePasswordReset(event) {
        event.preventDefault();
        const email = document.getElementById('auth-reset-email').value.trim();

        if (!email) return;

        try {
          const result = await AuthManager.requestPasswordReset(email);
          this.showMessage('auth-reset-message', result.message, 'success');
        } catch (error) {
          console.error('Password reset error:', error);
          this.showMessage('auth-reset-message', error.message || 'Failed to send reset link', 'error');
        }
      },

      /**
       * Handle new password form submission
       * @param {Event} event - Form submit event
       */
      async handleNewPassword(event) {
        event.preventDefault();
        const password = document.getElementById('auth-new-password').value;
        const confirm = document.getElementById('auth-confirm-password').value;

        if (password !== confirm) {
          this.showMessage('auth-password-message', 'Passwords do not match', 'error');
          return;
        }

        if (password.length < 8) {
          this.showMessage('auth-password-message', 'Password must be at least 8 characters', 'error');
          return;
        }

        try {
          const result = await AuthManager.updatePassword(password);
          this.showMessage('auth-password-message', result.message, 'success');

          // Redirect to main app after short delay
          setTimeout(() => {
            this.showView('main');
            this.updateAuthState();
          }, 2000);

        } catch (error) {
          console.error('Password update error:', error);
          this.showMessage('auth-password-message', error.message || 'Failed to update password', 'error');
        }
      },

      /**
       * Continue in offline mode (skip auth)
       */
      continueOffline() {
        const authScreen = document.getElementById('auth-screen');
        if (authScreen) authScreen.classList.add('hidden');

        const dashboard = document.querySelector('.dashboard');
        if (dashboard) dashboard.style.display = '';
      },

      /**
       * Enter demo mode for testing
       * Bypasses authentication and creates a demo entity if needed
       */
      async enterDemoMode() {
        DEBUG && console.log('[DEMO] Starting demo mode...');

        try {
          // Step 1: Set offline mode flag
          DEBUG && console.log('[DEMO] Step 1: Setting offline mode');
          AuthManager._offlineMode = true;

          // Step 2: Hide loading and auth screens, show dashboard
          DEBUG && console.log('[DEMO] Step 2: Showing dashboard');
          const loadingScreen = document.getElementById('loading-screen');
          const authScreen = document.getElementById('auth-screen');
          const container = document.querySelector('.container');
          const dashboard = document.querySelector('.dashboard');

          if (loadingScreen) loadingScreen.style.display = 'none';
          if (authScreen) authScreen.classList.add('hidden');
          if (container) container.style.display = '';
          if (dashboard) dashboard.style.display = '';

          // Step 3: Ensure database is ready
          DEBUG && console.log('[DEMO] Step 3: Checking database');
          if (typeof db === 'undefined' || !db) {
            console.error('[DEMO] Database not available!');
            alert('Database not ready. Please refresh and try again.');
            return;
          }

          // Make sure db is open
          if (!db.isOpen()) {
            DEBUG && console.log('[DEMO] Opening database...');
            await db.open();
          }
          DEBUG && console.log('[DEMO] Database ready:', db.name);

          // Step 4: Clear ALL existing entities for clean demo state
          DEBUG && console.log('[DEMO] Step 4: Clearing database for clean demo');

          // Delete ALL entities for a completely clean demo
          const existingEntities = await db.entities.toArray();
          DEBUG && console.log('[DEMO] Found existing entities:', existingEntities.length);
          for (const ent of existingEntities) {
            DEBUG && console.log('[DEMO] Deleting entity:', ent.id, ent.name);
            await db.entities.delete(ent.id);
          }

          // Also clear the current entity setting
          try {
            await db.settings.delete('current_entity_id');
          } catch (e) { /* ignore */ }
          EntityContext.clear();

          // Create new demo entity
          const demoEntity = {
            type: 'autonomo',
            name: 'Demo Business',
            nif_cif: '12345678Z',
            domicilio_fiscal: 'Demo Street 123, Madrid',
            owner_id: null,
            is_active: true,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
            deleted_at: null
          };

          const demoEntityId = await db.entities.add(demoEntity);
          DEBUG && console.log('[DEMO] Created demo entity ID:', demoEntityId);

          // Verify entity was created
          const verifyEntity = await db.entities.get(demoEntityId);
          DEBUG && console.log('[DEMO] Verify entity:', verifyEntity);

          if (!verifyEntity) {
            console.error('[DEMO] Entity creation failed!');
            alert('Failed to create demo entity. Please refresh and try again.');
            return;
          }

          // Step 5: Force recreate entity switcher for clean state
          DEBUG && console.log('[DEMO] Step 5: Setting up entity switcher');
          const switcherContainer = document.getElementById('entity-switcher-container');
          DEBUG && console.log('[DEMO] Switcher container exists:', !!switcherContainer);

          if (switcherContainer) {
            // Clear and recreate for clean state
            switcherContainer.innerHTML = '';
            DEBUG && console.log('[DEMO] Creating fresh entity switcher');
            entitySwitcher = createEntitySwitcher('entity-switcher-container');
          }
          DEBUG && console.log('[DEMO] Entity switcher exists:', !!entitySwitcher);

          // Step 6: Set entity in context (directly set the current entity)
          DEBUG && console.log('[DEMO] Step 6: Setting entity context');

          // Directly set the entity in EntityContext to bypass validation issues
          try {
            // Store in settings
            await db.settings.put({
              key: 'current_entity_id',
              value: demoEntityId,
              updated_at: new Date().toISOString()
            });

            // Call setEntity
            await EntityContext.setEntity(demoEntityId);
            DEBUG && console.log('[DEMO] EntityContext.entityId:', EntityContext.entityId);
            DEBUG && console.log('[DEMO] EntityContext.current:', EntityContext.current);
          } catch (err) {
            console.error('[DEMO] EntityContext.setEntity failed:', err);
          }

          // Step 7: Refresh UI components
          DEBUG && console.log('[DEMO] Step 7: Refreshing UI');

          if (entitySwitcher && entitySwitcher.refresh) {
            await entitySwitcher.refresh();
            DEBUG && console.log('[DEMO] Entity switcher refreshed');
          }

          if (typeof ClientListUI !== 'undefined' && ClientListUI.refresh) {
            await ClientListUI.refresh();
          }

          if (typeof UserMenuUI !== 'undefined' && UserMenuUI.update) {
            UserMenuUI.update();
          }

          // Step 8: Final auth state update
          DEBUG && console.log('[DEMO] Step 8: Final state update');
          this.updateAuthState();

          DEBUG && console.log('[DEMO] Demo mode complete! Entity:', EntityContext.current?.name);

        } catch (err) {
          console.error('[DEMO] Fatal error:', err);
          alert('Error entering demo mode: ' + err.message);

          // Still try to show dashboard
          const authScreen = document.getElementById('auth-screen');
          const dashboard = document.querySelector('.dashboard');
          if (authScreen) authScreen.classList.add('hidden');
          if (dashboard) dashboard.style.display = '';
        }
      },

      /**
       * Initialize auth UI
       */
      init() {
        // Listen for auth state changes
        if (!AuthManager.isOfflineMode()) {
          AuthManager.onAuthStateChange((event, session) => {
            this.updateAuthState();
          });
        }

        // Demo mode button
        const demoBtn = document.getElementById('demo-mode-btn');
        if (demoBtn) {
          demoBtn.addEventListener('click', () => {
            DEBUG && console.log('Demo button clicked');
            this.enterDemoMode();
          });
        }

        // Initial state check
        this.updateAuthState();
      }
    };

    /**
     * UserMenuUI - User menu dropdown interactions
     * Phase 14-03
     */
    const UserMenuUI = {
      /**
       * Toggle dropdown visibility
       */
      toggle() {
        const dropdown = document.getElementById('user-menu-dropdown');
        if (dropdown) {
          dropdown.classList.toggle('open');
        }
      },

      /**
       * Close dropdown
       */
      close() {
        const dropdown = document.getElementById('user-menu-dropdown');
        if (dropdown) {
          dropdown.classList.remove('open');
        }
      },

      /**
       * Update user menu with current user info
       */
      update() {
        const user = AuthManager.getUser();
        const menu = document.getElementById('user-menu');

        if (!menu) return;

        if (user) {
          menu.style.display = '';
          const name = user.user_metadata?.name || user.user_metadata?.full_name || user.email?.split('@')[0] || 'User';
          const initial = name.charAt(0).toUpperCase();

          document.getElementById('user-avatar-initial').textContent = initial;
          document.getElementById('user-menu-name').textContent = name;
        } else if (AuthManager.isOfflineMode()) {
          // Show simplified menu in offline mode
          menu.style.display = '';
          document.getElementById('user-avatar-initial').textContent = 'O';
          document.getElementById('user-menu-name').textContent = 'Offline';
        } else {
          menu.style.display = 'none';
        }
      },

      /**
       * Navigate to profile section
       */
      showProfile() {
        this.close();
        // Hide tab panels, show profile
        document.querySelector('.tab-panels').style.display = 'none';
        document.querySelector('.tab-nav').style.display = 'none';
        const profileTab = document.getElementById('profile-tab');
        if (profileTab) {
          profileTab.classList.add('active');
          profileTab.style.display = 'block';
        }
        ProfileUI.load();
      },

      /**
       * Return from profile to main dashboard
       */
      hideProfile() {
        document.querySelector('.tab-panels').style.display = '';
        document.querySelector('.tab-nav').style.display = '';
        const profileTab = document.getElementById('profile-tab');
        if (profileTab) {
          profileTab.classList.remove('active');
          profileTab.style.display = 'none';
        }
      },

      /**
       * Show sessions modal (Phase 14-04)
       */
      showSessions() {
        this.close();
        SessionsUI.open();
      },

      /**
       * Sign out
       */
      async signOut() {
        this.close();
        try {
          await AuthManager.signOut('local');
        } catch (error) {
          console.error('Sign out error:', error);
        }
        // AuthUI will handle showing login screen
      },

      /**
       * Initialize user menu
       */
      init() {
        // Update menu when auth state changes
        AuthManager.onAuthStateChange(() => {
          this.update();
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          const menu = document.getElementById('user-menu');
          if (menu && !menu.contains(e.target)) {
            this.close();
          }
        });

        // Initial update
        this.update();
      }
    };

    /**
     * ProfileUI - Profile page interactions
     * Phase 14-03
     */
    const ProfileUI = {
      /**
       * Load profile data into form
       */
      async load() {
        const user = AuthManager.getUser();
        if (!user && !AuthManager.isOfflineMode()) return;

        let profile = null;
        if (user) {
          profile = await ProfileManager.getProfile(user.id);
        }

        // Update header
        const name = profile?.name || user?.user_metadata?.name || user?.email?.split('@')[0] || 'Offline User';
        document.getElementById('profile-display-name').textContent = name;
        document.getElementById('profile-email').textContent = user?.email || 'Offline mode';
        document.getElementById('profile-avatar').textContent = name.charAt(0).toUpperCase();

        // Fill form
        document.getElementById('profile-name').value = profile?.name || '';
        document.getElementById('profile-nif').value = profile?.nif_cif || '';
        document.getElementById('profile-phone').value = profile?.phone || '';
        document.getElementById('profile-address').value = profile?.address || '';

        // Update 2FA status (Phase 14-04)
        await this.update2FAStatus();

        // Show sharing section if authenticated and entity selected (Phase 14-05)
        const sharingSection = document.getElementById('sharing-section');
        if (sharingSection) {
          if (EntityContext.current && AuthManager.isAuthenticated()) {
            sharingSection.style.display = '';
            await SharingUI.load();
          } else {
            sharingSection.style.display = 'none';
          }
        }
      },

      /**
       * Save profile changes
       * @param {Event} event - Form submit event
       */
      async save(event) {
        event.preventDefault();
        const user = AuthManager.getUser();
        if (!user) {
          this.showMessage('Profile cannot be saved in offline mode', 'error');
          return;
        }

        const data = {
          name: document.getElementById('profile-name').value.trim(),
          nif_cif: document.getElementById('profile-nif').value.trim(),
          phone: document.getElementById('profile-phone').value.trim(),
          address: document.getElementById('profile-address').value.trim()
        };

        // Validate NIF/CIF if provided
        if (data.nif_cif) {
          const validation = SpanishTaxIdValidator.validate(data.nif_cif);
          if (!validation.valid) {
            this.showMessage(validation.error, 'error');
            return;
          }
          data.nif_cif = validation.normalized;
        }

        try {
          await ProfileManager.upsertProfile(user.id, data);
          this.showMessage('Profile updated successfully', 'success');

          // Update user menu
          UserMenuUI.update();

          // Update display name
          document.getElementById('profile-display-name').textContent = data.name || user.email?.split('@')[0] || 'User';
        } catch (error) {
          console.error('Profile save error:', error);
          this.showMessage('Failed to save profile', 'error');
        }
      },

      /**
       * Show message in profile form
       * @param {string} message - Message text
       * @param {string} type - 'success' or 'error'
       */
      showMessage(message, type) {
        const el = document.getElementById('profile-message');
        if (el) {
          el.textContent = message;
          el.className = `auth-message ${type}`;
          el.style.display = 'block';

          // Auto-hide success messages
          if (type === 'success') {
            setTimeout(() => {
              el.style.display = 'none';
            }, 3000);
          }
        }
      },

      /**
       * Update 2FA status display - Phase 14-04
       */
      async update2FAStatus() {
        const statusEl = document.getElementById('profile-2fa-text');
        const btnEl = document.getElementById('profile-2fa-btn');
        const sectionEl = document.getElementById('profile-2fa-section');

        if (AuthManager.isOfflineMode()) {
          if (sectionEl) sectionEl.style.display = 'none';
          return;
        }

        const enabled = await MFAManager.isMFAEnabled();

        if (statusEl) {
          statusEl.textContent = enabled ? 'Enabled' : 'Disabled';
          statusEl.style.color = enabled ? '#22c55e' : 'var(--text-secondary)';
        }

        if (btnEl) {
          btnEl.textContent = enabled ? 'Disable' : 'Enable';
        }
      },

      /**
       * Toggle 2FA - Phase 14-04
       */
      async toggle2FA() {
        const enabled = await MFAManager.isMFAEnabled();
        if (enabled) {
          await MFAUI.disable();
        } else {
          await MFAUI.startEnrollment();
        }
        // Refresh status after modal closes
        setTimeout(() => this.update2FAStatus(), 500);
      }
    };

    /**
     * MFAUI - MFA enrollment and challenge UI controller
     * Phase 14-04 - AUTH-05, AUTH-06
     */
    const MFAUI = {
      enrollmentData: null,

      /**
       * Setup code input auto-advance behavior
       * @param {string} containerId - Container element ID
       */
      initCodeInputs(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const inputs = container.querySelectorAll('input');
        inputs.forEach((input, index) => {
          // Auto-advance on input
          input.addEventListener('input', (e) => {
            const value = e.target.value;
            if (value && index < inputs.length - 1) {
              inputs[index + 1].focus();
            }
          });

          // Handle backspace
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
              inputs[index - 1].focus();
            }
          });

          // Handle paste
          input.addEventListener('paste', (e) => {
            e.preventDefault();
            const paste = (e.clipboardData || window.clipboardData).getData('text');
            const digits = paste.replace(/\D/g, '').split('');
            digits.slice(0, 6).forEach((digit, i) => {
              if (inputs[i]) inputs[i].value = digit;
            });
            // Focus last filled or next empty
            const lastIndex = Math.min(digits.length - 1, 5);
            inputs[lastIndex]?.focus();
          });
        });
      },

      /**
       * Get code from inputs
       * @param {string} containerId - Container element ID
       * @returns {string} 6-digit code
       */
      getCode(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return '';
        return Array.from(container.querySelectorAll('input'))
          .map(i => i.value)
          .join('');
      },

      /**
       * Clear code inputs
       * @param {string} containerId - Container element ID
       */
      clearCode(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.querySelectorAll('input').forEach(i => {
          i.value = '';
        });
        container.querySelector('input')?.focus();
      },

      /**
       * Show message in modal
       * @param {string} elementId - Message element ID
       * @param {string} message - Message text
       * @param {string} type - 'success' or 'error'
       */
      showMessage(elementId, message, type) {
        const el = document.getElementById(elementId);
        if (el) {
          el.textContent = message;
          el.className = `auth-message ${type}`;
          el.style.display = 'block';
        }
      },

      /**
       * Start enrollment flow (AUTH-05)
       */
      async startEnrollment() {
        if (AuthManager.isOfflineMode()) {
          alert('2FA requires online mode with Supabase configured.');
          return;
        }

        try {
          this.enrollmentData = await MFAManager.enroll();

          // Show QR code
          const qrContainer = document.getElementById('mfa-qr-container');
          if (qrContainer && this.enrollmentData.qrCode) {
            qrContainer.innerHTML = `<img src="${this.enrollmentData.qrCode}" alt="QR Code">`;
          }

          // Show secret for manual entry
          const secretEl = document.getElementById('mfa-secret-code');
          if (secretEl) {
            secretEl.textContent = this.enrollmentData.secret;
          }

          // Show modal
          const modal = document.getElementById('mfa-enroll-modal');
          if (modal) modal.classList.remove('hidden');

          // Init code inputs
          this.initCodeInputs('mfa-enroll-code');
          this.clearCode('mfa-enroll-code');

        } catch (error) {
          console.error('MFA enrollment error:', error);
          alert('Failed to start 2FA setup: ' + error.message);
        }
      },

      /**
       * Complete enrollment
       */
      async completeEnrollment() {
        const code = this.getCode('mfa-enroll-code');
        if (code.length !== 6) {
          this.showMessage('mfa-enroll-message', 'Please enter all 6 digits', 'error');
          return;
        }

        try {
          await MFAManager.verifyEnrollment(this.enrollmentData.factorId, code);

          this.showMessage('mfa-enroll-message', '2FA enabled successfully!', 'success');

          // Close modal after delay
          setTimeout(() => {
            this.closeEnrollmentModal();
          }, 1500);

        } catch (error) {
          console.error('MFA verify error:', error);
          this.showMessage('mfa-enroll-message', 'Invalid code. Please try again.', 'error');
          this.clearCode('mfa-enroll-code');
        }
      },

      /**
       * Cancel enrollment
       */
      cancelEnrollment() {
        this.enrollmentData = null;
        this.closeEnrollmentModal();
      },

      /**
       * Close enrollment modal
       */
      closeEnrollmentModal() {
        const modal = document.getElementById('mfa-enroll-modal');
        if (modal) modal.classList.add('hidden');
        this.enrollmentData = null;
      },

      /**
       * Show MFA challenge (during login)
       * @param {string} factorId - Factor ID to challenge
       */
      showChallenge(factorId) {
        AuthManager.pendingMFAFactorId = factorId;
        const modal = document.getElementById('mfa-challenge-modal');
        if (modal) modal.classList.remove('hidden');

        this.initCodeInputs('mfa-challenge-code');
        this.clearCode('mfa-challenge-code');
      },

      /**
       * Verify challenge
       */
      async verifyChallenge() {
        const code = this.getCode('mfa-challenge-code');
        if (code.length !== 6) {
          this.showMessage('mfa-challenge-message', 'Please enter all 6 digits', 'error');
          return;
        }

        try {
          await MFAManager.verifyChallenge(AuthManager.pendingMFAFactorId, code);

          // Close modal and proceed to app
          this.closeChallengeModal();
          AuthUI.updateAuthState();

        } catch (error) {
          console.error('MFA challenge error:', error);
          this.showMessage('mfa-challenge-message', 'Invalid code. Please try again.', 'error');
          this.clearCode('mfa-challenge-code');
        }
      },

      /**
       * Cancel challenge (sign out)
       */
      async cancelChallenge() {
        await AuthManager.signOut();
        this.closeChallengeModal();
      },

      /**
       * Close challenge modal
       */
      closeChallengeModal() {
        const modal = document.getElementById('mfa-challenge-modal');
        if (modal) modal.classList.add('hidden');
        AuthManager.pendingMFAFactorId = null;
      },

      /**
       * Disable 2FA
       */
      async disable() {
        if (!confirm('Are you sure you want to disable 2FA? This will make your account less secure.')) {
          return;
        }

        try {
          const factors = await MFAManager.getFactors();
          if (factors.length > 0) {
            await MFAManager.unenroll(factors[0].id);
            alert('2FA has been disabled.');
          }
        } catch (error) {
          console.error('MFA disable error:', error);
          alert('Failed to disable 2FA: ' + error.message);
        }
      }
    };

    /**
     * SessionsUI - Active sessions list UI controller
     * Phase 14-04 - AUTH-06
     */
    const SessionsUI = {
      /**
       * Open sessions modal
       */
      async open() {
        const modal = document.getElementById('sessions-modal');
        if (modal) modal.classList.remove('hidden');
        await this.load();
      },

      /**
       * Close modal
       */
      close() {
        const modal = document.getElementById('sessions-modal');
        if (modal) modal.classList.add('hidden');
      },

      /**
       * Load sessions list
       */
      async load() {
        const container = document.getElementById('sessions-list');
        if (!container) return;

        const user = AuthManager.getUser();
        if (!user) {
          container.innerHTML = '<div class="sessions-empty">Please sign in to view sessions.</div>';
          return;
        }

        const sessions = await SessionManager.getSessions(user.id);
        const currentSessionId = AuthManager.localSessionId;

        if (sessions.length === 0) {
          container.innerHTML = '<div class="sessions-empty">No active sessions found.</div>';
          return;
        }

        container.innerHTML = sessions.map(session => {
          const isCurrent = session.id === currentSessionId;
          const lastActive = this.formatLastActive(session.last_active_at);

          return `
            <div class="session-item ${isCurrent ? 'current' : ''}">
              <div class="session-info">
                <div class="session-device">
                  ${this.escapeHtml(session.device_name || 'Unknown Device')}
                  ${isCurrent ? '<span class="session-current-badge">Current</span>' : ''}
                </div>
                <div class="session-details">
                  Last active: ${lastActive}
                  ${session.location ? ` &bull; ${this.escapeHtml(session.location)}` : ''}
                </div>
              </div>
              ${!isCurrent ? `
                <button class="session-revoke" onclick="SessionsUI.revoke('${session.id}')">
                  Revoke
                </button>
              ` : ''}
            </div>
          `;
        }).join('');
      },

      /**
       * Revoke individual session
       * @param {string} sessionId - Session ID to revoke
       */
      async revoke(sessionId) {
        if (!confirm('Are you sure you want to revoke this session?')) {
          return;
        }

        try {
          await SessionManager.revokeSession(sessionId);
          await this.load(); // Refresh list
        } catch (error) {
          console.error('Revoke session error:', error);
          alert('Failed to revoke session');
        }
      },

      /**
       * Sign out all other devices
       */
      async signOutOthers() {
        if (!confirm('This will sign out all other devices. Continue?')) {
          return;
        }

        try {
          const user = AuthManager.getUser();
          if (!user) return;

          await SessionManager.revokeOtherSessions(user.id, AuthManager.localSessionId);

          // Also sign out via Supabase if available
          if (!AuthManager.isOfflineMode()) {
            await AuthManager.signOut('others');
          }

          await this.load(); // Refresh list
          alert('All other sessions have been revoked.');
        } catch (error) {
          console.error('Sign out others error:', error);
          alert('Failed to sign out other devices');
        }
      },

      /**
       * Format last active time
       * @param {string} isoString - ISO timestamp
       * @returns {string} Formatted time
       */
      formatLastActive(isoString) {
        if (!isoString) return 'Unknown';

        const date = new Date(isoString);
        const now = new Date();
        const diff = now - date;

        const minutes = Math.floor(diff / (1000 * 60));
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));

        if (minutes < 1) return 'Just now';
        if (minutes < 60) return `${minutes}m ago`;
        if (hours < 24) return `${hours}h ago`;
        if (days < 7) return `${days}d ago`;

        return date.toLocaleDateString('es-ES', {
          day: 'numeric',
          month: 'short',
          year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
        });
      },

      /**
       * Escape HTML to prevent XSS
       * @param {string} str - String to escape
       * @returns {string} Escaped string
       */
      escapeHtml(str) {
        if (!str) return '';
        return str.replace(/[&<>"']/g, char => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[char]));
      }
    };

    /**
     * InviteUI - Invitation modal and acceptance controller
     * Phase 14-05 - PERM-01, PERM-02, PERM-03
     */
    const InviteUI = {
      pendingInviteCode: null,
      pendingInviteData: null,

      /**
       * Open invite modal for current entity
       */
      openModal() {
        const modal = document.getElementById('invite-modal');
        if (modal) modal.classList.remove('hidden');

        // Reset form
        const form = document.getElementById('invite-form');
        if (form) {
          form.reset();
          form.style.display = '';
        }
        const result = document.getElementById('invite-result');
        if (result) result.style.display = 'none';
        const message = document.getElementById('invite-message');
        if (message) message.style.display = 'none';

        // Update role help text
        this.updateRoleHelp();
      },

      /**
       * Close modal
       */
      closeModal() {
        const modal = document.getElementById('invite-modal');
        if (modal) modal.classList.add('hidden');
      },

      /**
       * Update role description based on selection
       */
      updateRoleHelp() {
        const role = document.getElementById('invite-role')?.value;
        const helpEl = document.getElementById('invite-role-help');

        const descriptions = {
          gestor: 'Can view and export data, but cannot make changes',
          accountant: 'Can view, edit, and categorize expenses. Cannot delete or create invoices',
          partner: 'Full access except deleting the entity. Can invite other users'
        };

        if (helpEl && role) {
          helpEl.textContent = descriptions[role] || '';
        }
      },

      /**
       * Create invitation (PERM-01, PERM-02)
       * @param {Event} event - Form submit event
       */
      async create(event) {
        event.preventDefault();

        const email = document.getElementById('invite-email')?.value.trim();
        const role = document.getElementById('invite-role')?.value;
        const submitBtn = document.getElementById('invite-submit-btn');

        const currentEntity = EntityContext.current;
        if (!currentEntity) {
          this.showMessage('Please select an entity first', 'error');
          return;
        }

        const user = AuthManager.getUser();
        if (!user) {
          this.showMessage('Please sign in first', 'error');
          return;
        }

        // Check permission
        const canInvite = await EntityAccessManager.canPerformAction(currentEntity.id, 'invite');
        if (!canInvite) {
          this.showMessage('You do not have permission to invite users', 'error');
          return;
        }

        try {
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';
          }

          const invitation = await InvitationManager.createInvitation(
            currentEntity.id,
            role,
            user.id,
            email || null
          );

          // Show result
          const baseUrl = `${window.location.origin}${window.location.pathname}`;
          const inviteLink = `${baseUrl}?invite=${invitation.inviteCode}`;

          const linkInput = document.getElementById('invite-result-link');
          const codeInput = document.getElementById('invite-result-code');
          const resultDiv = document.getElementById('invite-result');
          const formEl = document.getElementById('invite-form');

          if (linkInput) linkInput.value = inviteLink;
          if (codeInput) codeInput.value = invitation.inviteCode;
          if (resultDiv) resultDiv.style.display = 'block';
          if (formEl) formEl.style.display = 'none';

          // Log email sending (would be handled by Supabase Edge Function in production)
          if (email) {
            DEBUG && console.log('Email invitation would be sent to:', email);
          }

        } catch (error) {
          console.error('Create invitation error:', error);
          this.showMessage(error.message || 'Failed to create invitation', 'error');
        } finally {
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Create Invitation';
          }
        }
      },

      /**
       * Copy invite link to clipboard
       */
      copyLink() {
        const input = document.getElementById('invite-result-link');
        if (input) {
          input.select();
          navigator.clipboard.writeText(input.value);
          this.showCopyFeedback('Link copied!');
        }
      },

      /**
       * Copy invite code to clipboard
       */
      copyCode() {
        const input = document.getElementById('invite-result-code');
        if (input) {
          input.select();
          navigator.clipboard.writeText(input.value);
          this.showCopyFeedback('Code copied!');
        }
      },

      /**
       * Show copy feedback in notification
       * @param {string} message - Feedback message
       */
      showCopyFeedback(message) {
        const notification = document.getElementById('notification');
        if (notification) {
          notification.textContent = message;
          notification.classList.remove('hidden');
          setTimeout(() => notification.classList.add('hidden'), 2000);
        }
      },

      /**
       * Show message in modal
       * @param {string} message - Message text
       * @param {string} type - 'error' or 'success'
       */
      showMessage(message, type) {
        const el = document.getElementById('invite-message');
        if (el) {
          el.textContent = message;
          el.className = `auth-message ${type}`;
          el.style.display = 'block';
        }
      },

      /**
       * Check URL for invite parameter (PERM-03)
       */
      async checkURLInvite() {
        const url = new URL(window.location.href);
        const inviteCode = url.searchParams.get('invite');

        if (!inviteCode) return;

        // Clean URL
        url.searchParams.delete('invite');
        window.history.replaceState({}, document.title, url.pathname + url.search);

        // Get invitation details
        const invitation = await InvitationManager.getInvitation(inviteCode);
        if (!invitation) {
          alert('This invitation is invalid or has expired.');
          return;
        }

        // Get entity name
        const entity = await db.entities.get(invitation.entity_id);
        const entityName = entity?.name || 'Unknown Entity';

        // Store for later
        this.pendingInviteCode = inviteCode;
        this.pendingInviteData = invitation;

        // Show accept banner
        const banner = document.getElementById('invite-accept-banner');
        const title = document.getElementById('invite-accept-title');
        const desc = document.getElementById('invite-accept-desc');

        if (banner && title && desc) {
          title.textContent = `You've been invited to ${this.escapeHtml(entityName)}`;
          desc.textContent = `Role: ${this.formatRole(invitation.role)}`;
          banner.classList.remove('hidden');
        }
      },

      /**
       * Accept invitation from banner
       */
      async acceptFromBanner() {
        if (!this.pendingInviteCode) return;

        const user = AuthManager.getUser();
        if (!user) {
          alert('Please sign in first to accept this invitation.');
          return;
        }

        try {
          await InvitationManager.acceptInvitation(this.pendingInviteCode, user.id);
          alert('Invitation accepted! You now have access to this entity.');

          // Hide banner
          this.hideBanner();

          // Refresh entity list if switcher exists
          if (typeof entitySwitcher !== 'undefined' && entitySwitcher) {
            const container = document.getElementById('entity-switcher-container');
            if (container) {
              container.innerHTML = '';
              entitySwitcher = createEntitySwitcher('entity-switcher-container');
            }
          }

        } catch (error) {
          console.error('Accept invitation error:', error);
          alert('Failed to accept invitation: ' + error.message);
        }
      },

      /**
       * Decline invitation from banner
       */
      declineBanner() {
        this.pendingInviteCode = null;
        this.pendingInviteData = null;
        this.hideBanner();
      },

      /**
       * Hide accept banner
       */
      hideBanner() {
        const banner = document.getElementById('invite-accept-banner');
        if (banner) banner.classList.add('hidden');
      },

      /**
       * Format role for display
       * @param {string} role - Role key
       * @returns {string} Formatted role name
       */
      formatRole(role) {
        const names = {
          gestor: 'Gestor (View Only)',
          accountant: 'Accountant (View & Edit)',
          partner: 'Partner (Full Access)'
        };
        return names[role] || role;
      },

      /**
       * Escape HTML to prevent XSS
       * @param {string} str - String to escape
       * @returns {string} Escaped string
       */
      escapeHtml(str) {
        if (!str) return '';
        return str.replace(/[&<>"']/g, char => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[char]));
      },

      /**
       * Initialize InviteUI
       */
      init() {
        // Check for invite in URL after auth
        if (!AuthManager.isOfflineMode()) {
          AuthManager.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN') {
              this.checkURLInvite();
            }
          });
        }

        // Also check on initial load if already authenticated
        if (AuthManager.isAuthenticated()) {
          this.checkURLInvite();
        }

        // Role select change handler
        const roleSelect = document.getElementById('invite-role');
        if (roleSelect) {
          roleSelect.addEventListener('change', () => this.updateRoleHelp());
        }
      }
    };

    /**
     * SharingUI - Entity sharing management UI controller
     * Phase 14-05 - PERM-05 (revoke access)
     */
    const SharingUI = {
      /**
       * Load sharing section for current entity
       */
      async load() {
        const container = document.getElementById('sharing-list');
        if (!container) return;

        const currentEntity = EntityContext.current;
        if (!currentEntity) {
          container.innerHTML = '<div class="sharing-empty">Select an entity to manage sharing.</div>';
          return;
        }

        const user = AuthManager.getUser();
        const userRole = await EntityAccessManager.getRole(currentEntity.id, user?.id);

        // Get shares and pending invitations
        const shares = await EntityShareManager.getShares(currentEntity.id);
        const pendingInvites = await InvitationManager.getPendingInvitations(currentEntity.id);

        // Check if user can manage sharing
        const canManage = userRole === 'owner' || userRole === 'partner';

        // Build HTML
        let html = '';

        // Show owner first
        if (currentEntity.owner_id) {
          const ownerProfile = await ProfileManager.getProfile(currentEntity.owner_id);
          const isCurrentUser = currentEntity.owner_id === user?.id;

          html += `
            <div class="sharing-item">
              <div class="sharing-user">
                <div class="sharing-user-name">
                  ${this.escapeHtml(ownerProfile?.name || ownerProfile?.email?.split('@')[0] || 'Owner')}
                  ${isCurrentUser ? ' (you)' : ''}
                </div>
                <div class="sharing-user-email">${this.escapeHtml(ownerProfile?.email || '')}</div>
              </div>
              <div class="sharing-role">
                <span class="sharing-role-badge owner">Owner</span>
              </div>
            </div>
          `;
        }

        // Show active shares
        for (const share of shares) {
          if (share.accepted_at) {
            const profile = await ProfileManager.getProfile(share.user_id);
            const isCurrentUser = share.user_id === user?.id;

            html += `
              <div class="sharing-item">
                <div class="sharing-user">
                  <div class="sharing-user-name">
                    ${this.escapeHtml(profile?.name || profile?.email?.split('@')[0] || 'User')}
                    ${isCurrentUser ? ' (you)' : ''}
                  </div>
                  <div class="sharing-user-email">${this.escapeHtml(profile?.email || '')}</div>
                </div>
                <div class="sharing-role">
                  <span class="sharing-role-badge ${share.role}">${this.formatRole(share.role)}</span>
                  ${canManage && !isCurrentUser ? `
                    <button class="sharing-revoke" onclick="SharingUI.revoke(${currentEntity.id}, '${share.user_id}')">
                      Revoke
                    </button>
                  ` : ''}
                </div>
              </div>
            `;
          }
        }

        // Show pending invitations
        for (const invite of pendingInvites) {
          const expiresIn = this.formatExpiresIn(invite.expires_at);

          html += `
            <div class="sharing-item pending">
              <div class="sharing-user">
                <div class="sharing-user-name">${this.escapeHtml(invite.email || 'Invite Link')}</div>
                <div class="sharing-user-status">Pending - Expires ${expiresIn}</div>
              </div>
              <div class="sharing-role">
                <span class="sharing-role-badge ${invite.role}">${this.formatRole(invite.role)}</span>
                ${canManage ? `
                  <button class="sharing-revoke" onclick="SharingUI.cancelInvite(${invite.id})">
                    Cancel
                  </button>
                ` : ''}
              </div>
            </div>
          `;
        }

        if (!html) {
          html = '<div class="sharing-empty">No users have access to this entity.</div>';
        }

        container.innerHTML = html;

        // Show/hide invite button based on permission
        const inviteBtn = document.getElementById('sharing-invite-btn');
        if (inviteBtn) {
          inviteBtn.style.display = canManage ? '' : 'none';
        }
      },

      /**
       * Revoke user access (PERM-05)
       * @param {number} entityId - Entity ID
       * @param {string} userId - User ID to revoke
       */
      async revoke(entityId, userId) {
        if (!confirm('Are you sure you want to revoke this user\'s access?')) {
          return;
        }

        try {
          await EntityShareManager.removeShare(entityId, userId);
          await this.load(); // Refresh list
        } catch (error) {
          console.error('Revoke access error:', error);
          alert('Failed to revoke access: ' + error.message);
        }
      },

      /**
       * Cancel pending invitation
       * @param {number} inviteId - Invitation ID to cancel
       */
      async cancelInvite(inviteId) {
        if (!confirm('Cancel this invitation?')) {
          return;
        }

        try {
          await db.entity_invitations.update(inviteId, {
            used_at: new Date().toISOString(),
            used_by: null // Cancelled, not used
          });
          await this.load(); // Refresh list
        } catch (error) {
          console.error('Cancel invite error:', error);
          alert('Failed to cancel invitation');
        }
      },

      /**
       * Format role for display
       * @param {string} role - Role key
       * @returns {string} Formatted role name
       */
      formatRole(role) {
        const names = {
          owner: 'Owner',
          gestor: 'Gestor',
          accountant: 'Accountant',
          partner: 'Partner'
        };
        return names[role] || role;
      },

      /**
       * Format expiration time
       * @param {string} isoString - ISO timestamp
       * @returns {string} Human-readable expiry
       */
      formatExpiresIn(isoString) {
        const expires = new Date(isoString);
        const now = new Date();
        const diff = expires - now;

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor(diff / (1000 * 60 * 60));

        if (days > 1) return `in ${days} days`;
        if (days === 1) return 'tomorrow';
        if (hours > 0) return `in ${hours} hours`;
        return 'soon';
      },

      /**
       * Escape HTML to prevent XSS
       * @param {string} str - String to escape
       * @returns {string} Escaped string
       */
      escapeHtml(str) {
        if (!str) return '';
        return str.replace(/[&<>"']/g, char => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[char]));
      }
    };

    /**
     * EntityAccessManager - Entity ownership and permission checks
     * Handles access control for multi-user entity sharing
     */
    const EntityAccessManager = {
      /**
       * Check if user can access entity (owner or has accepted share)
       * @param {number} entityId - Entity ID
       * @param {string} userId - User ID (defaults to current user)
       * @returns {Promise<boolean>} True if user can access
       */
      async canAccess(entityId, userId = null) {
        const uid = userId || AuthManager.getUser()?.id;
        if (!uid) return false;

        // Check ownership
        const entity = await db.entities.get(entityId);
        if (!entity) return false;
        if (entity.owner_id === uid) return true;

        // Check shares
        const share = await db.entity_shares
          .where('[entity_id+user_id]').equals([entityId, uid])
          .filter(s => s.accepted_at !== null)
          .first();

        return !!share;
      },

      /**
       * Get user's role for entity
       * @param {number} entityId - Entity ID
       * @param {string} userId - User ID (defaults to current user)
       * @returns {Promise<string|null>} Role ('owner', 'partner', 'accountant', 'gestor') or null
       */
      async getRole(entityId, userId = null) {
        const uid = userId || AuthManager.getUser()?.id;
        if (!uid) return null;

        // Check ownership
        const entity = await db.entities.get(entityId);
        if (!entity) return null;
        if (entity.owner_id === uid) return 'owner';

        // Check shares
        const share = await db.entity_shares
          .where('[entity_id+user_id]').equals([entityId, uid])
          .filter(s => s.accepted_at !== null)
          .first();

        return share?.role || null;
      },

      /**
       * Check if user can perform specific action on entity
       * @param {number} entityId - Entity ID
       * @param {string} action - Action to check ('view', 'edit', 'create', 'delete', 'invite', 'manage', 'archive_entity', 'delete_entity', 'export')
       * @param {string} userId - User ID (defaults to current user)
       * @returns {Promise<boolean>} True if action allowed
       */
      async canPerformAction(entityId, action, userId = null) {
        const role = await this.getRole(entityId, userId);
        if (!role) return false;

        // Permission matrix by role
        const permissions = {
          owner: ['view', 'edit', 'create', 'delete', 'invite', 'manage', 'archive_entity', 'delete_entity', 'export'],
          partner: ['view', 'edit', 'create', 'delete', 'invite', 'manage', 'archive_entity', 'export'],
          accountant: ['view', 'edit', 'create', 'export'], // No delete, no invite
          gestor: ['view', 'export'] // Read-only
        };

        return permissions[role]?.includes(action) || false;
      },

      /**
       * Get all entities user can access (owned + shared)
       * @param {string} userId - User ID (defaults to current user)
       * @returns {Promise<Array>} Array of entity objects
       */
      async getAccessibleEntities(userId = null) {
        const uid = userId || AuthManager.getUser()?.id;
        if (!uid) return [];

        // Get owned entities
        const ownedEntities = await db.entities
          .filter(e => e.owner_id === uid && !e.deleted_at)
          .toArray();

        // Get shared entities
        const shares = await db.entity_shares
          .where('user_id').equals(uid)
          .filter(s => s.accepted_at !== null)
          .toArray();

        const sharedEntityIds = shares.map(s => s.entity_id);
        const sharedEntities = await db.entities
          .where('id').anyOf(sharedEntityIds)
          .filter(e => !e.deleted_at)
          .toArray();

        // Merge and deduplicate
        const all = [...ownedEntities, ...sharedEntities];
        const seen = new Set();
        return all.filter(e => {
          if (seen.has(e.id)) return false;
          seen.add(e.id);
          return true;
        });
      },

      /**
       * Transfer entity ownership to another user
       * @param {number} entityId - Entity ID
       * @param {string} newOwnerId - User ID of new owner
       * @throws {Error} If entity not found or caller is not owner
       */
      async transferOwnership(entityId, newOwnerId) {
        const entity = await db.entities.get(entityId);
        if (!entity) throw new Error('Entity not found');

        const currentUserId = AuthManager.getUser()?.id;
        if (entity.owner_id !== currentUserId) {
          throw new Error('Only the owner can transfer ownership');
        }

        await db.entities.update(entityId, { owner_id: newOwnerId });
        DEBUG && console.log(`Ownership of entity ${entityId} transferred to ${newOwnerId}`);
      },

      /**
       * Get entities user owns (not shared access)
       * @param {string} userId - User ID (defaults to current user)
       * @returns {Promise<Array>} Array of owned entity objects
       */
      async getOwnedEntities(userId = null) {
        const uid = userId || AuthManager.getUser()?.id;
        if (!uid) return [];

        return await db.entities
          .filter(e => e.owner_id === uid && !e.deleted_at)
          .toArray();
      },

      /**
       * Check if user is entity owner
       * @param {number} entityId - Entity ID
       * @param {string} userId - User ID (defaults to current user)
       * @returns {Promise<boolean>} True if user owns entity
       */
      async isOwner(entityId, userId = null) {
        const uid = userId || AuthManager.getUser()?.id;
        if (!uid) return false;

        const entity = await db.entities.get(entityId);
        return entity?.owner_id === uid;
      }
    };

    /**
     * PermissionUI - Centralized permission checking and UI updates
     * Phase 14-06: PERM-04, PERM-06, PERM-07
     */
    const PermissionUI = {
      // Cache current role to avoid repeated DB queries
      currentEntityRole: null,

      // Permission map: role -> allowed actions
      PERMISSIONS: {
        owner: ['view', 'edit', 'create', 'delete', 'invite', 'manage', 'export', 'archive_entity', 'delete_entity', 'transfer_ownership'],
        partner: ['view', 'edit', 'create', 'delete', 'invite', 'manage', 'export', 'archive_entity'],
        accountant: ['view', 'edit', 'create', 'export'], // Can edit/create expenses, but see restriction checks below
        gestor: ['view', 'export']
      },

      // Additional restrictions for accountant
      ACCOUNTANT_RESTRICTIONS: {
        // Cannot delete anything
        canDelete: false,
        // Cannot create/edit invoices
        canCreateInvoice: false,
        canEditInvoice: false,
        // Cannot create/edit clients
        canCreateClient: false,
        canEditClient: false,
        // CAN edit expenses (their primary function)
        canEditExpense: true,
        canCreateExpense: true
      },

      /**
       * Update role cache when entity changes
       * @returns {Promise<string|null>} Current role
       */
      async updateRoleCache() {
        const currentEntity = EntityContext.current;
        if (!currentEntity) {
          this.currentEntityRole = null;
          return null;
        }

        const user = AuthManager.getUser();
        if (!user) {
          // In offline mode, treat as owner
          if (AuthManager.isOfflineMode()) {
            this.currentEntityRole = 'owner';
            return 'owner';
          }
          this.currentEntityRole = null;
          return null;
        }

        this.currentEntityRole = await EntityAccessManager.getRole(currentEntity.id, user.id);
        return this.currentEntityRole;
      },

      /**
       * Get current role (use cache if available)
       * @returns {Promise<string|null>} Current role
       */
      async getRole() {
        if (this.currentEntityRole === null) {
          await this.updateRoleCache();
        }
        return this.currentEntityRole;
      },

      /**
       * Check if current user can perform action
       * @param {string} action - Action to check
       * @param {Object} context - Context with optional 'type' property
       * @returns {Promise<boolean>} True if allowed
       */
      async canPerform(action, context = {}) {
        const role = await this.getRole();
        if (!role) return false;

        // Base permission check
        const allowed = this.PERMISSIONS[role]?.includes(action);
        if (!allowed) return false;

        // Additional checks for accountant
        if (role === 'accountant') {
          // Check specific restrictions
          if (action === 'delete') return false;

          if (context.type === 'invoice') {
            if (action === 'create' || action === 'edit') return false;
          }

          if (context.type === 'client') {
            if (action === 'create' || action === 'edit') return false;
          }
        }

        return true;
      },

      /**
       * Quick check methods for common actions
       */
      async canView() {
        return await this.canPerform('view');
      },

      async canEdit(type) {
        return await this.canPerform('edit', { type });
      },

      async canCreate(type) {
        return await this.canPerform('create', { type });
      },

      async canDelete(type) {
        return await this.canPerform('delete', { type });
      },

      async canExport() {
        return await this.canPerform('export');
      },

      async canInvite() {
        return await this.canPerform('invite');
      },

      async canManage() {
        return await this.canPerform('manage');
      },

      /**
       * Apply permissions to UI elements
       */
      async applyToUI() {
        const role = await this.getRole();
        const isOffline = AuthManager.isOfflineMode();

        // In offline mode, allow full access (local data only)
        if (isOffline) {
          document.querySelectorAll('[data-permission]').forEach(el => {
            el.style.display = '';
            el.disabled = false;
            el.classList.remove('permission-disabled');
          });
          // Hide read-only banner in offline mode
          const readOnlyBanner = document.getElementById('read-only-banner');
          if (readOnlyBanner) readOnlyBanner.classList.remove('visible');
          return;
        }

        if (!role) {
          // No access - hide all permission-gated elements
          document.querySelectorAll('[data-permission]').forEach(el => {
            el.style.display = 'none';
          });
          return;
        }

        // Apply permission checks to each element
        const elements = document.querySelectorAll('[data-permission]');
        for (const el of elements) {
          const requiredAction = el.getAttribute('data-permission');
          const contextType = el.getAttribute('data-permission-type');

          const allowed = await this.canPerform(requiredAction, { type: contextType });

          if (el.tagName === 'BUTTON' || el.tagName === 'INPUT' || el.tagName === 'SELECT') {
            // For interactive elements, disable instead of hide
            el.disabled = !allowed;
            if (!allowed) {
              el.classList.add('permission-disabled');
              el.title = `Requires ${requiredAction} permission`;
            } else {
              el.classList.remove('permission-disabled');
              el.title = '';
            }
          } else {
            // For containers/divs, hide entirely
            el.style.display = allowed ? '' : 'none';
          }
        }

        // Show read-only banner for gestors
        const readOnlyBanner = document.getElementById('read-only-banner');
        if (readOnlyBanner) {
          readOnlyBanner.classList.toggle('visible', role === 'gestor');
        }

        // Update role indicator if exists
        this.updateRoleIndicator(role);
      },

      /**
       * Show role indicator in header/entity area
       * @param {string} role - Current role
       */
      updateRoleIndicator(role) {
        const indicator = document.getElementById('current-role-indicator');
        if (!indicator) return;

        if (!role) {
          indicator.style.display = 'none';
          return;
        }

        const roleLabels = {
          owner: 'Owner',
          partner: 'Partner',
          accountant: 'Accountant',
          gestor: 'Gestor (View Only)'
        };

        indicator.textContent = roleLabels[role] || role;
        indicator.className = `role-indicator role-${role}`;
        indicator.style.display = '';
      },

      /**
       * Show permission denied message
       * @param {string} action - Denied action description
       * @returns {boolean} Always returns false for convenience
       */
      showDenied(action) {
        const role = this.currentEntityRole;
        const roleLabel = {
          gestor: 'Gestor (view only)',
          accountant: 'Accountant',
          partner: 'Partner',
          owner: 'Owner'
        }[role] || role;

        const message = `Permission denied: Your role (${roleLabel}) cannot ${action}.`;
        alert(message);
        return false;
      },

      /**
       * Initialize - subscribe to entity and auth changes
       */
      init() {
        // Update role when entity changes
        EntityContext.subscribe(async () => {
          await this.updateRoleCache();
          await this.applyToUI();
        });

        // Update role when auth changes
        if (!AuthManager.isOfflineMode()) {
          AuthManager.onAuthStateChange(async () => {
            await this.updateRoleCache();
            await this.applyToUI();
          });
        }
      }
    };

    /**
     * Wrapper to check permission before executing action
     * @param {string} action - Action to check
     * @param {string} type - Context type (optional)
     * @param {Function} callback - Function to execute if allowed
     * @returns {Promise<any>} Result of callback or false if denied
     */
    async function withPermission(action, type, callback) {
      const allowed = await PermissionUI.canPerform(action, { type });
      if (!allowed) {
        PermissionUI.showDenied(action);
        return false;
      }
      return await callback();
    }

    // =====================================================
    // Money Utilities (Integer Cents)
    // =====================================================

    const MoneyUtils = {
      // Convert user input (euros) to storage (cents)
      eurosToCents(euroValue) {
        if (euroValue === null || euroValue === undefined || euroValue === '') {
          return 0;
        }
        if (typeof euroValue === 'string') {
          // Handle comma as decimal separator (European format)
          euroValue = euroValue.replace(/\s/g, '').replace(',', '.');
        }
        return currency(euroValue, { precision: 2 }).intValue;
      },

      // Convert storage (cents) to numeric euros
      centsToEuros(cents) {
        if (cents === null || cents === undefined) return 0;
        return currency(cents, { fromCents: true, precision: 2 }).value;
      },

      // Format for display with currency symbol (Spanish locale)
      formatEuros(cents, locale = 'es-ES') {
        const euros = this.centsToEuros(cents);
        return new Intl.NumberFormat(locale, {
          style: 'currency',
          currency: 'EUR',
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }).format(euros);
      },

      // Format without symbol (for input fields)
      formatEurosPlain(cents) {
        const euros = this.centsToEuros(cents);
        return euros.toFixed(2);
      },

      // Banker's rounding for tax calculations
      roundCents(cents) {
        if (cents % 1 === 0.5 || cents % 1 === -0.5) {
          const floor = Math.floor(cents);
          return floor % 2 === 0 ? floor : Math.ceil(cents);
        }
        return Math.round(cents);
      },

      // Calculate IVA amount from base
      calculateIVA(baseCents, rate = 0.21) {
        return this.roundCents(baseCents * rate);
      },

      // Add amounts safely (all in cents)
      add(...centAmounts) {
        return centAmounts.reduce((sum, amt) => sum + (amt || 0), 0);
      },

      // Subtract amounts safely (all in cents)
      subtract(fromCents, ...subtractCents) {
        return subtractCents.reduce((result, amt) => result - (amt || 0), fromCents || 0);
      }
    };

    // =====================================================
    // Audit Fields Helper
    // =====================================================

    function auditFields(isCreate = true) {
      const now = new Date().toISOString();
      const userId = getCurrentUserId();

      if (isCreate) {
        return {
          created_at: now,
          updated_at: now,
          created_by: userId,
          updated_by: userId
        };
      }
      return {
        updated_at: now,
        updated_by: userId
      };
    }

    function getCurrentUserId() {
      // Will be implemented in Phase 14 (Auth)
      // For now, return placeholder
      return 'local-user';
    }

    // =====================================================
    // Sync Queue (Offline-First) - Phase 12
    // =====================================================

    const SyncQueue = {
      // Warning thresholds
      WARN_THRESHOLD: 100,
      ALERT_THRESHOLD: 500,
      CRITICAL_THRESHOLD: 1000,

      /**
       * Queue a data change for eventual sync
       * @param {string} tableName - Table that changed
       * @param {number} recordId - Record ID
       * @param {string} operation - 'CREATE', 'UPDATE', 'DELETE'
       * @param {object} data - Changed data
       * @returns {Promise<number>} Queue entry ID
       */
      async queueChange(tableName, recordId, operation, data) {
        const entry = {
          table_name: tableName,
          record_id: recordId,
          operation: operation,
          data: JSON.stringify(data),
          created_at: new Date().toISOString(),
          retry_count: 0,
          last_error: null
        };

        const id = await db.sync_queue.add(entry);
        await this.updateIndicator();

        DEBUG && console.log(`Queued: ${operation} ${tableName}/${recordId}`);
        return id;
      },

      /**
       * Get pending sync queue count
       * @returns {Promise<number>} Count
       */
      async getPendingCount() {
        return db.sync_queue.count();
      },

      /**
       * Get all pending queue entries
       * @returns {Promise<Array>} Queue entries
       */
      async getPending() {
        return db.sync_queue.orderBy('created_at').toArray();
      },

      /**
       * Update the sync status indicator in UI
       */
      async updateIndicator() {
        const count = await this.getPendingCount();
        let indicator = document.getElementById('sync-indicator');

        // Create indicator if it doesn't exist
        if (!indicator) {
          indicator = this.createIndicator();
        }

        // Update status
        const statusEl = indicator.querySelector('.sync-status-text');
        const badgeEl = indicator.querySelector('.sync-badge');

        if (count === 0) {
          statusEl.textContent = 'Synced';
          indicator.className = 'sync-indicator synced';
          badgeEl.style.display = 'none';
        } else {
          statusEl.textContent = `${count} pending`;
          indicator.className = 'sync-indicator pending';
          badgeEl.textContent = count > 99 ? '99+' : count;
          badgeEl.style.display = 'flex';

          // Check thresholds and show warnings
          if (count >= this.CRITICAL_THRESHOLD) {
            indicator.classList.add('critical');
            this.showWarning('critical', count);
          } else if (count >= this.ALERT_THRESHOLD) {
            indicator.classList.add('alert');
            this.showWarning('alert', count);
          } else if (count >= this.WARN_THRESHOLD) {
            this.showWarning('warn', count);
          }
        }
      },

      /**
       * Create the sync indicator UI element
       * @returns {HTMLElement} Indicator element
       */
      createIndicator() {
        const indicator = document.createElement('div');
        indicator.id = 'sync-indicator';
        indicator.className = 'sync-indicator synced';
        indicator.innerHTML = `
          <svg class="sync-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12a9 9 0 11-9-9 9.75 9.75 0 016.74 2.74"/>
            <path d="M21 3v9h-9"/>
          </svg>
          <span class="sync-status-text">Synced</span>
          <span class="sync-badge" style="display: none;">0</span>
        `;

        // Add click handler to show queue details
        indicator.addEventListener('click', () => this.showQueueDetails());

        // Insert into page (top-right corner)
        document.body.appendChild(indicator);
        return indicator;
      },

      /**
       * Show warning notification for large queue
       * @param {string} level - 'warn', 'alert', 'critical'
       * @param {number} count - Queue count
       */
      showWarning(level, count) {
        // Avoid repeated warnings (only show once per session per threshold)
        const key = `sync_warning_${level}`;
        if (sessionStorage.getItem(key)) return;
        sessionStorage.setItem(key, 'shown');

        const messages = {
          warn: `You have ${count} unsynced changes. Consider connecting to sync.`,
          alert: `Warning: ${count} unsynced changes. Connect to sync soon to avoid data loss.`,
          critical: `Critical: ${count} unsynced changes! Connect immediately to sync your data.`
        };

        console.warn(`[SyncQueue] ${messages[level]}`);

        // Show UI notification if available (Phase 5 notification system)
        if (typeof showNotification === 'function') {
          showNotification({
            type: level === 'critical' ? 'error' : 'warning',
            message: messages[level],
            duration: level === 'critical' ? 0 : 10000 // Critical stays until dismissed
          });
        }
      },

      /**
       * Show queue details modal/panel
       */
      async showQueueDetails() {
        const entries = await this.getPending();
        DEBUG && console.log('Sync queue entries:', entries);

        // Group by table
        const byTable = {};
        for (const entry of entries) {
          if (!byTable[entry.table_name]) {
            byTable[entry.table_name] = { CREATE: 0, UPDATE: 0, DELETE: 0 };
          }
          byTable[entry.table_name][entry.operation]++;
        }

        console.table(byTable);

        // Simple alert for now (replace with modal in UI phase)
        if (entries.length > 0) {
          const summary = Object.entries(byTable)
            .map(([table, ops]) => `${table}: ${ops.CREATE}C/${ops.UPDATE}U/${ops.DELETE}D`)
            .join('\n');
          alert(`Sync Queue (${entries.length} items)\n\n${summary}\n\nCloud sync coming in Phase 27.`);
        } else {
          alert('All data is synced!');
        }
      },

      /**
       * Clear sync queue (for testing or after successful sync)
       * @param {number[]} ids - Specific IDs to clear (optional, clears all if not provided)
       */
      async clearQueue(ids = null) {
        if (ids) {
          await db.sync_queue.bulkDelete(ids);
        } else {
          await db.sync_queue.clear();
        }
        await this.updateIndicator();
      }
    };

    // =====================================================
    // Data Manager (Soft Delete & Retention) - Phase 12
    // =====================================================

    const DataManager = {
      // Tables that support soft delete (financial records)
      SOFT_DELETE_TABLES: ['invoices', 'expenses', 'receipts', 'clients', 'entities', 'projects'],

      // Retention period in years (Spanish tax audit statute of limitations)
      RETENTION_YEARS: 4,

      // Restore window in days
      RESTORE_WINDOW_DAYS: 30,

      /**
       * Soft delete a record (set deleted_at, queue for sync)
       * @param {string} tableName - Table to delete from
       * @param {number} id - Record ID
       * @returns {Promise<boolean>} Success status
       */
      async softDelete(tableName, id) {
        if (!this.SOFT_DELETE_TABLES.includes(tableName)) {
          throw new Error(`Table ${tableName} does not support soft delete`);
        }

        const record = await db[tableName].get(id);
        if (!record) {
          throw new Error(`Record not found: ${tableName}/${id}`);
        }

        if (record.deleted_at) {
          throw new Error('Record already deleted');
        }

        const now = new Date().toISOString();
        const changes = {
          deleted_at: now,
          ...auditFields(false)
        };

        await db[tableName].update(id, changes);
        await SyncQueue.queueChange(tableName, id, 'UPDATE', changes);

        DEBUG && console.log(`Soft deleted: ${tableName}/${id}`);
        return true;
      },

      /**
       * Restore a soft-deleted record (within 30-day window)
       * @param {string} tableName - Table to restore from
       * @param {number} id - Record ID
       * @returns {Promise<boolean>} Success status
       */
      async restore(tableName, id) {
        const record = await db[tableName].get(id);
        if (!record) {
          throw new Error(`Record not found: ${tableName}/${id}`);
        }

        if (!record.deleted_at) {
          throw new Error('Record is not deleted');
        }

        // Check restore window
        const deletedDate = new Date(record.deleted_at);
        const daysSinceDeleted = (Date.now() - deletedDate.getTime()) / (1000 * 60 * 60 * 24);

        if (daysSinceDeleted > this.RESTORE_WINDOW_DAYS) {
          throw new Error(`Cannot restore: Record deleted more than ${this.RESTORE_WINDOW_DAYS} days ago. ` +
            `Record will be retained for audit until ${this.RETENTION_YEARS}-year purge.`);
        }

        const changes = {
          deleted_at: null,
          ...auditFields(false)
        };

        await db[tableName].update(id, changes);
        await SyncQueue.queueChange(tableName, id, 'UPDATE', changes);

        DEBUG && console.log(`Restored: ${tableName}/${id}`);
        return true;
      },

      /**
       * Get active records (not deleted)
       * @param {string} tableName - Table to query
       * @param {number} entityId - Entity filter (optional)
       * @returns {Promise<Array>} Active records
       */
      async getActive(tableName, entityId = null) {
        let query = db[tableName];

        if (entityId && db[tableName].schema.indexes.some(i => i.name === '[entity_id+deleted_at]')) {
          // Use compound index if available
          return query.where('[entity_id+deleted_at]').equals([entityId, null]).toArray();
        }

        // Fallback to filter
        let results = await query.toArray();
        results = results.filter(r => r.deleted_at === null || r.deleted_at === undefined);

        if (entityId) {
          results = results.filter(r => r.entity_id === entityId);
        }

        return results;
      },

      /**
       * Get deleted records (for "Deleted Items" view)
       * @param {string} tableName - Table to query
       * @param {number} entityId - Entity filter (optional)
       * @returns {Promise<Array>} Deleted records with metadata
       */
      async getDeleted(tableName, entityId = null) {
        let results = await db[tableName].toArray();
        results = results.filter(r => r.deleted_at !== null && r.deleted_at !== undefined);

        if (entityId) {
          results = results.filter(r => r.entity_id === entityId);
        }

        // Add metadata for UI
        const now = Date.now();
        return results.map(r => {
          const deletedDate = new Date(r.deleted_at);
          const daysSinceDeleted = Math.floor((now - deletedDate.getTime()) / (1000 * 60 * 60 * 24));
          const canRestore = daysSinceDeleted <= this.RESTORE_WINDOW_DAYS;

          return {
            ...r,
            _daysSinceDeleted: daysSinceDeleted,
            _canRestore: canRestore,
            _restoreDeadline: canRestore
              ? new Date(deletedDate.getTime() + (this.RESTORE_WINDOW_DAYS * 24 * 60 * 60 * 1000)).toISOString()
              : null
          };
        });
      },

      /**
       * Auto-purge records deleted more than RETENTION_YEARS ago
       * Called on app initialization
       * @returns {Promise<{table: string, count: number}[]>} Purge results
       */
      async autoPurgeOldRecords() {
        const cutoffDate = new Date();
        cutoffDate.setFullYear(cutoffDate.getFullYear() - this.RETENTION_YEARS);
        const cutoff = cutoffDate.toISOString();

        const results = [];

        for (const tableName of this.SOFT_DELETE_TABLES) {
          try {
            const oldRecords = await db[tableName]
              .filter(r => r.deleted_at && r.deleted_at < cutoff)
              .toArray();

            if (oldRecords.length > 0) {
              const ids = oldRecords.map(r => r.id);
              await db[tableName].bulkDelete(ids);

              // Queue hard deletes for sync
              for (const record of oldRecords) {
                await SyncQueue.queueChange(tableName, record.id, 'DELETE', { id: record.id });
              }

              results.push({ table: tableName, count: oldRecords.length });
              DEBUG && console.log(`Auto-purged ${oldRecords.length} records from ${tableName} (deleted before ${cutoff})`);
            }
          } catch (error) {
            console.error(`Error purging ${tableName}:`, error);
          }
        }

        return results;
      },

      /**
       * Check if record is within restore window
       * @param {object} record - Record with deleted_at field
       * @returns {boolean} Can restore
       */
      canRestore(record) {
        if (!record.deleted_at) return false;
        const deletedDate = new Date(record.deleted_at);
        const daysSinceDeleted = (Date.now() - deletedDate.getTime()) / (1000 * 60 * 60 * 24);
        return daysSinceDeleted <= this.RESTORE_WINDOW_DAYS;
      }
    };

    // =====================================================
    // Invoice Manager (VeriFactu Compliance) - Phase 12
    // =====================================================

    const InvoiceManager = {
      // Invoice series types
      SERIES: {
        F: 'F', // Factura ordinaria (regular invoice)
        R: 'R', // Factura rectificativa (correcting invoice)
        S: 'S'  // Factura simplificada (simplified invoice, <400 EUR)
      },

      // Invoice statuses
      STATUS: {
        DRAFT: 'draft',
        SENT: 'sent',
        PAID: 'paid',
        OVERDUE: 'overdue',
        ARCHIVED: 'archived'
      },

      /**
       * Get next invoice number in sequence (thread-safe via transaction)
       * Format: F-2026-0001, R-2026-0001, etc.
       * @param {number} entityId - Entity ID
       * @param {string} series - Invoice series (F, R, S)
       * @returns {Promise<string>} Invoice number
       */
      async getNextInvoiceNumber(entityId, series = 'F') {
        if (!Object.values(this.SERIES).includes(series)) {
          throw new Error(`Invalid invoice series: ${series}. Must be F, R, or S.`);
        }

        return db.transaction('rw', db.invoice_sequences, async () => {
          // Find or create sequence for this entity+series
          let seq = await db.invoice_sequences
            .where('[entity_id+series]')
            .equals([entityId, series])
            .first();

          if (!seq) {
            // First invoice in this series for this entity
            seq = {
              entity_id: entityId,
              series: series,
              last_number: 0
            };
            seq.id = await db.invoice_sequences.add(seq);
          }

          // Increment sequence
          seq.last_number++;
          await db.invoice_sequences.update(seq.id, { last_number: seq.last_number });

          // Format: {series}-{year}-{4-digit-padded-number}
          const year = new Date().getFullYear();
          const paddedNum = String(seq.last_number).padStart(4, '0');
          return `${series}-${year}-${paddedNum}`;
        });
      },

      /**
       * Get current sequence number (without incrementing)
       * @param {number} entityId - Entity ID
       * @param {string} series - Invoice series
       * @returns {Promise<number>} Current last number
       */
      async getCurrentNumber(entityId, series = 'F') {
        const seq = await db.invoice_sequences
          .where('[entity_id+series]')
          .equals([entityId, series])
          .first();

        return seq ? seq.last_number : 0;
      },

      /**
       * Archive an invoice (soft delete for drafts only)
       * VeriFactu requires: sent/paid invoices CANNOT be deleted
       * @param {number} invoiceId - Invoice ID
       * @returns {Promise<boolean>} Success
       */
      async archiveInvoice(invoiceId) {
        const invoice = await db.invoices.get(invoiceId);

        if (!invoice) {
          throw new Error(`Invoice not found: ${invoiceId}`);
        }

        if (invoice.deleted_at) {
          throw new Error('Invoice already archived');
        }

        // CRITICAL: Only draft invoices can be archived
        if (invoice.status !== this.STATUS.DRAFT) {
          throw new Error(
            `Cannot archive ${invoice.status} invoice. ` +
            `VeriFactu requires sent/paid invoices to remain in sequence. ` +
            `To correct errors, create a factura rectificativa (series R). ` +
            `To cancel the operation, issue a credit note.`
          );
        }

        // Archive (soft delete) the draft
        const now = new Date().toISOString();
        const changes = {
          deleted_at: now,
          status: this.STATUS.ARCHIVED,
          ...auditFields(false)
        };

        await db.invoices.update(invoiceId, changes);
        await SyncQueue.queueChange('invoices', invoiceId, 'UPDATE', changes);

        DEBUG && console.log(`Archived draft invoice: ${invoice.invoice_number}`);
        return true;
      },

      /**
       * Create a rectifying invoice (factura rectificativa)
       * Links to original invoice and uses series 'R'
       * @param {number} originalInvoiceId - Original invoice to correct
       * @param {object} corrections - Correction data
       * @returns {Promise<{id: number, invoice_number: string}>}
       */
      async createRectifyingInvoice(originalInvoiceId, corrections) {
        const original = await db.invoices.get(originalInvoiceId);

        if (!original) {
          throw new Error(`Original invoice not found: ${originalInvoiceId}`);
        }

        if (original.status === this.STATUS.DRAFT) {
          throw new Error('Cannot create rectificativa for draft invoice. Edit the draft directly.');
        }

        if (original.deleted_at) {
          throw new Error('Cannot create rectificativa for archived invoice.');
        }

        // Valid correction reasons (per Real Decreto 1619/2012 Art. 15)
        const validReasons = [
          'error_datos_fiscales',     // Error in fiscal data (NIF, name, address)
          'modificacion_base',        // Modification of taxable base
          'descuento_posterior',      // Subsequent discount
          'devolucion_envases',       // Return of packaging
          'impago_concurso',          // Non-payment in insolvency proceedings
          'otros'                     // Other (requires description)
        ];

        if (!corrections.reason || !validReasons.includes(corrections.reason)) {
          throw new Error(`Invalid correction reason. Must be one of: ${validReasons.join(', ')}`);
        }

        // Get next R-series number
        const invoiceNumber = await this.getNextInvoiceNumber(original.entity_id, this.SERIES.R);

        const rectifying = {
          entity_id: original.entity_id,
          client_id: original.client_id,
          series: this.SERIES.R,
          invoice_number: invoiceNumber,
          status: this.STATUS.DRAFT,
          date_issued: new Date().toISOString().split('T')[0],
          date_due: null,

          // Link to original
          original_invoice_id: original.id,
          original_invoice_number: original.invoice_number,
          correction_reason: corrections.reason,
          correction_description: corrections.description || null,

          // Amounts (negative for credit, positive for debit)
          subtotal_cents: corrections.subtotal_cents || 0,
          iva_cents: corrections.iva_cents || 0,
          irpf_cents: corrections.irpf_cents || 0,
          total_cents: corrections.total_cents || 0,

          deleted_at: null,
          ...auditFields(true)
        };

        const id = await db.invoices.add(rectifying);
        await SyncQueue.queueChange('invoices', id, 'CREATE', rectifying);

        DEBUG && console.log(`Created rectifying invoice: ${invoiceNumber} for original: ${original.invoice_number}`);
        return { id, invoice_number: invoiceNumber };
      },

      /**
       * Get all invoices for an entity (active only by default)
       * @param {number} entityId - Entity ID
       * @param {object} options - Query options
       * @returns {Promise<Array>} Invoices
       */
      async getInvoices(entityId, options = {}) {
        const { includeArchived = false, status = null, series = null } = options;

        let query = db.invoices.where('entity_id').equals(entityId);
        let results = await query.toArray();

        // Filter archived unless requested
        if (!includeArchived) {
          results = results.filter(inv => !inv.deleted_at);
        }

        // Filter by status if specified
        if (status) {
          results = results.filter(inv => inv.status === status);
        }

        // Filter by series if specified
        if (series) {
          results = results.filter(inv => inv.series === series);
        }

        // Sort by date descending (null-safe)
        return results.sort((a, b) => (b.date_issued || '').localeCompare(a.date_issued || ''));
      },

      /**
       * Validate invoice number format
       * @param {string} invoiceNumber - Number to validate
       * @returns {boolean} Is valid
       */
      isValidInvoiceNumber(invoiceNumber) {
        // Format: {series}-{year}-{number}
        const pattern = /^[FRS]-\d{4}-\d{4,}$/;
        return pattern.test(invoiceNumber);
      },

      /**
       * Parse invoice number components
       * @param {string} invoiceNumber - Number to parse
       * @returns {{series: string, year: number, number: number}|null}
       */
      parseInvoiceNumber(invoiceNumber) {
        if (!this.isValidInvoiceNumber(invoiceNumber)) return null;

        const [series, year, num] = invoiceNumber.split('-');
        return {
          series,
          year: parseInt(year, 10),
          number: parseInt(num, 10)
        };
      },

      // =================================================
      // Phase 18: Full CRUD, Line Items, Status, Payments
      // =================================================

      // --- CRUD Operations ---

      /**
       * Create a new draft invoice
       * @param {Object} invoiceData - Invoice fields
       * @param {number} invoiceData.client_id - Client ID (required)
       * @param {string} [invoiceData.date_issued] - Issue date (default: today)
       * @param {string} [invoiceData.date_due] - Due date (default: 30 days from issue)
       * @param {string} [invoiceData.currency] - Currency code (default: 'EUR')
       * @param {number} [invoiceData.exchange_rate] - Exchange rate to EUR (default: 1)
       * @param {string} [invoiceData.notes] - Invoice notes
       * @returns {Promise<{id: number, invoice_number: string}>}
       */
      async createInvoice(invoiceData) {
        const entityId = EntityContext.entityId;
        if (!entityId) throw new Error('No entity selected');

        if (!invoiceData.client_id) {
          throw new Error('Client is required for invoice creation');
        }

        // Validate client exists
        const client = await db.clients.get(invoiceData.client_id);
        if (!client || client.deleted_at) {
          throw new Error('Client not found or archived');
        }

        // Look up IVA treatment for this client category
        const treatment = IVA_TREATMENT[client.category];
        if (!treatment) {
          throw new Error(`Unknown IVA treatment for category: ${client.category}`);
        }

        // Get next sequential invoice number
        const invoiceNumber = await this.getNextInvoiceNumber(entityId, this.SERIES.F);

        // Calculate dates
        const dateIssued = invoiceData.date_issued || new Date().toISOString().split('T')[0];
        const dateDue = invoiceData.date_due || (() => {
          const due = new Date(dateIssued);
          due.setDate(due.getDate() + 30);
          return due.toISOString().split('T')[0];
        })();

        const invoice = {
          entity_id: entityId,
          client_id: invoiceData.client_id,
          series: this.SERIES.F,
          invoice_number: invoiceNumber,
          status: this.STATUS.DRAFT,
          date_issued: dateIssued,
          date_due: dateDue,
          currency: invoiceData.currency || INVOICE_CURRENCY.EUR,
          exchange_rate: invoiceData.exchange_rate || 1,
          discount_type: null,
          discount_value: 0,
          irpf_rate: 0,
          subtotal_cents: 0,
          iva_cents: 0,
          irpf_cents: 0,
          total_cents: 0,
          paid_cents: 0,
          notes: invoiceData.notes || '',
          date_sent: null,
          deleted_at: null,
          ...auditFields(true)
        };

        const id = await db.invoices.add(invoice);
        await SyncQueue.queueChange('invoices', id, 'CREATE', invoice);

        DEBUG && console.log(`Created draft invoice: ${invoiceNumber}`);
        return { id, invoice_number: invoiceNumber };
      },

      /**
       * Update a draft invoice (sent/paid invoices are immutable)
       * @param {number} id - Invoice ID
       * @param {Object} changes - Fields to update
       * @returns {Promise<Object>} Updated invoice
       */
      async updateInvoice(id, changes) {
        const invoice = await db.invoices.get(id);
        if (!invoice) throw new Error('Invoice not found');
        if (invoice.deleted_at) throw new Error('Invoice is archived');

        if (invoice.status !== this.STATUS.DRAFT) {
          throw new Error(`Cannot edit ${invoice.status} invoice. Only draft invoices can be modified.`);
        }

        const updates = {
          ...changes,
          ...auditFields(false)
        };

        // Don't allow changing protected fields
        delete updates.entity_id;
        delete updates.invoice_number;
        delete updates.series;
        delete updates.status;
        delete updates.paid_cents;

        await db.invoices.update(id, updates);
        await SyncQueue.queueChange('invoices', id, 'UPDATE', updates);

        // Recalculate totals if line-item-affecting fields changed
        const affectsTotal = changes.discount_type !== undefined ||
                             changes.discount_value !== undefined ||
                             changes.irpf_rate !== undefined;
        if (affectsTotal) {
          await this.calculateInvoiceTotals(id);
        }

        return await db.invoices.get(id);
      },

      /**
       * Get single invoice with its line items
       * @param {number} id - Invoice ID
       * @returns {Promise<Object|null>} Invoice with lines array
       */
      async getInvoice(id) {
        const invoice = await db.invoices.get(id);
        if (!invoice) return null;

        const lines = await db.invoice_lines
          .where('invoice_id').equals(id)
          .toArray();

        // Sort lines by sort_order then by id
        lines.sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0) || a.id - b.id);

        return { ...invoice, lines };
      },

      // --- Line Item Operations ---

      /**
       * Add a line item to a draft invoice
       * @param {number} invoiceId - Invoice ID
       * @param {Object} item - Line item data
       * @param {string} item.description - Description
       * @param {number} item.quantity - Quantity
       * @param {number} item.unit_price_cents - Unit price in cents
       * @param {number} [item.iva_rate] - IVA rate (default from client category)
       * @param {number} [item.project_id] - Optional project ID
       * @param {number} [item.sort_order] - Sort order (default: 0)
       * @returns {Promise<number>} Line item ID
       */
      async addLineItem(invoiceId, item) {
        const invoice = await db.invoices.get(invoiceId);
        if (!invoice) throw new Error('Invoice not found');
        if (invoice.status !== this.STATUS.DRAFT) {
          throw new Error(`Cannot add lines to ${invoice.status} invoice`);
        }

        if (!item.description || !item.quantity || !item.unit_price_cents) {
          throw new Error('Line item requires description, quantity, and unit_price_cents');
        }

        const lineTotalCents = MoneyUtils.roundCents(item.quantity * item.unit_price_cents);

        const lineItem = {
          invoice_id: invoiceId,
          description: item.description.trim(),
          quantity: item.quantity,
          unit_price_cents: item.unit_price_cents,
          iva_rate: item.iva_rate !== undefined ? item.iva_rate : null,
          line_total_cents: lineTotalCents,
          project_id: item.project_id || null,
          sort_order: item.sort_order || 0,
          ...auditFields(true)
        };

        const lineId = await db.invoice_lines.add(lineItem);
        await SyncQueue.queueChange('invoice_lines', lineId, 'CREATE', lineItem);

        // Recalculate invoice totals
        await this.calculateInvoiceTotals(invoiceId);

        return lineId;
      },

      /**
       * Update a line item on a draft invoice
       * @param {number} lineId - Line item ID
       * @param {Object} changes - Fields to update
       * @returns {Promise<Object>} Updated line item
       */
      async updateLineItem(lineId, changes) {
        const line = await db.invoice_lines.get(lineId);
        if (!line) throw new Error('Line item not found');

        const invoice = await db.invoices.get(line.invoice_id);
        if (!invoice) throw new Error('Parent invoice not found');
        if (invoice.status !== this.STATUS.DRAFT) {
          throw new Error(`Cannot edit lines on ${invoice.status} invoice`);
        }

        // Recalculate line total if quantity or price changed
        const newQty = changes.quantity !== undefined ? changes.quantity : line.quantity;
        const newPrice = changes.unit_price_cents !== undefined ? changes.unit_price_cents : line.unit_price_cents;

        if (changes.quantity !== undefined || changes.unit_price_cents !== undefined) {
          changes.line_total_cents = MoneyUtils.roundCents(newQty * newPrice);
        }

        const updates = {
          ...changes,
          ...auditFields(false)
        };

        await db.invoice_lines.update(lineId, updates);
        await SyncQueue.queueChange('invoice_lines', lineId, 'UPDATE', updates);

        // Recalculate invoice totals
        await this.calculateInvoiceTotals(line.invoice_id);

        return await db.invoice_lines.get(lineId);
      },

      /**
       * Remove a line item from a draft invoice
       * @param {number} lineId - Line item ID
       * @returns {Promise<void>}
       */
      async removeLineItem(lineId) {
        const line = await db.invoice_lines.get(lineId);
        if (!line) throw new Error('Line item not found');

        const invoice = await db.invoices.get(line.invoice_id);
        if (!invoice) throw new Error('Parent invoice not found');
        if (invoice.status !== this.STATUS.DRAFT) {
          throw new Error(`Cannot remove lines from ${invoice.status} invoice`);
        }

        await db.invoice_lines.delete(lineId);
        await SyncQueue.queueChange('invoice_lines', lineId, 'DELETE', { id: lineId });

        // Recalculate invoice totals
        await this.calculateInvoiceTotals(line.invoice_id);
      },

      /**
       * Get all line items for an invoice, sorted by sort_order then id
       * @param {number} invoiceId - Invoice ID
       * @returns {Promise<Array>} Sorted line items
       */
      async getLineItems(invoiceId) {
        const lines = await db.invoice_lines
          .where('invoice_id').equals(invoiceId)
          .toArray();

        return lines.sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0) || a.id - b.id);
      },

      // --- Calculations ---

      /**
       * Recalculate and store invoice totals from line items
       * Applies: subtotal -> discount -> IVA -> IRPF -> total
       * All arithmetic in integer cents via MoneyUtils
       * @param {number} invoiceId - Invoice ID
       * @returns {Promise<{subtotalCents, discountCents, ivaCents, irpfCents, totalCents}>}
       */
      async calculateInvoiceTotals(invoiceId) {
        const invoice = await db.invoices.get(invoiceId);
        if (!invoice) throw new Error('Invoice not found');

        // Get all line items
        const lines = await db.invoice_lines
          .where('invoice_id').equals(invoiceId)
          .toArray();

        // Sum line totals = subtotal
        const subtotalCents = lines.reduce((sum, line) => sum + (line.line_total_cents || 0), 0);

        // Apply discount
        let discountCents = 0;
        if (invoice.discount_type === 'percentage' && invoice.discount_value > 0) {
          discountCents = MoneyUtils.roundCents(subtotalCents * invoice.discount_value / 100);
        } else if (invoice.discount_type === 'fixed' && invoice.discount_value > 0) {
          discountCents = invoice.discount_value;
        }

        const discountedSubtotal = subtotalCents - discountCents;

        // Get client for IVA treatment
        const client = await db.clients.get(invoice.client_id);
        const treatment = client ? IVA_TREATMENT[client.category] : IVA_TREATMENT[CLIENT_CATEGORY.SPAIN];
        const ivaCents = MoneyUtils.calculateIVA(discountedSubtotal, treatment.rate);

        // IRPF retention (only for autonomo invoicing Spanish clients)
        let irpfCents = 0;
        if (invoice.irpf_rate > 0) {
          irpfCents = MoneyUtils.roundCents(discountedSubtotal * invoice.irpf_rate / 100);
        }

        // Total = discountedSubtotal + IVA - IRPF
        const totalCents = discountedSubtotal + ivaCents - irpfCents;

        // Update invoice record
        const updates = {
          subtotal_cents: subtotalCents,
          iva_cents: ivaCents,
          irpf_cents: irpfCents,
          total_cents: totalCents,
          ...auditFields(false)
        };

        await db.invoices.update(invoiceId, updates);

        return { subtotalCents, discountCents, ivaCents, irpfCents, totalCents };
      },

      /**
       * Get IVA treatment for a client category
       * @param {string} clientCategory - CLIENT_CATEGORY value
       * @returns {Object} { rate, label, legalText }
       */
      getIVATreatment(clientCategory) {
        return IVA_TREATMENT[clientCategory] || IVA_TREATMENT[CLIENT_CATEGORY.SPAIN];
      },

      /**
       * Fetch exchange rate from Frankfurter API
       * @param {string} fromCurrency - Source currency code
       * @param {string} [toCurrency='EUR'] - Target currency code
       * @returns {Promise<number|null>} Exchange rate or null on error
       */
      async fetchExchangeRate(fromCurrency, toCurrency = 'EUR') {
        if (fromCurrency === toCurrency) return 1;

        try {
          const url = `https://api.frankfurter.dev/v1/latest?base=${encodeURIComponent(fromCurrency)}&symbols=${encodeURIComponent(toCurrency)}`;
          const response = await fetch(url);
          if (!response.ok) return null;

          const data = await response.json();
          return data.rates?.[toCurrency] || null;
        } catch (err) {
          console.warn('Failed to fetch exchange rate:', err.message);
          return null;
        }
      },

      // --- Status Workflow ---

      /**
       * Transition invoice from draft to sent
       * Makes invoice immutable (no further edits to lines or amounts)
       * @param {number} invoiceId - Invoice ID
       * @param {string} [dateSent] - Sent date (default: today)
       * @returns {Promise<Object>} Updated invoice
       */
      async markAsSent(invoiceId, dateSent) {
        const invoice = await db.invoices.get(invoiceId);
        if (!invoice) throw new Error('Invoice not found');

        if (invoice.status !== this.STATUS.DRAFT) {
          throw new Error(`Cannot mark ${invoice.status} invoice as sent. Only draft invoices can be sent.`);
        }

        // Validate invoice has at least one line item
        const lineCount = await db.invoice_lines
          .where('invoice_id').equals(invoiceId)
          .count();
        if (lineCount === 0) {
          throw new Error('Cannot send invoice with no line items');
        }

        const updates = {
          status: this.STATUS.SENT,
          date_sent: dateSent || new Date().toISOString().split('T')[0],
          ...auditFields(false)
        };

        await db.invoices.update(invoiceId, updates);
        await SyncQueue.queueChange('invoices', invoiceId, 'UPDATE', updates);

        DEBUG && console.log(`Invoice ${invoice.invoice_number} marked as sent`);
        return await db.invoices.get(invoiceId);
      },

      /**
       * Record a payment against a sent invoice
       * Supports partial payments; auto-transitions to 'paid' when fully paid
       * @param {number} invoiceId - Invoice ID
       * @param {Object} paymentData - Payment details
       * @param {number} paymentData.amount_cents - Payment amount in cents
       * @param {string} paymentData.date - Payment date (YYYY-MM-DD)
       * @param {string} paymentData.method - Payment method ('transfer'|'card'|'cash'|'other')
       * @param {string} [paymentData.reference] - Payment reference/ID
       * @returns {Promise<number>} Payment record ID
       */
      async recordPayment(invoiceId, paymentData) {
        const invoice = await db.invoices.get(invoiceId);
        if (!invoice) throw new Error('Invoice not found');

        // Allow payments on sent invoices (or those already partially paid)
        if (invoice.status !== this.STATUS.SENT && invoice.status !== this.STATUS.PAID) {
          throw new Error(`Cannot record payment on ${invoice.status} invoice. Invoice must be sent first.`);
        }

        if (!paymentData.amount_cents || paymentData.amount_cents <= 0) {
          throw new Error('Payment amount must be greater than zero');
        }

        if (!paymentData.date) {
          throw new Error('Payment date is required');
        }

        const validMethods = ['transfer', 'card', 'cash', 'other'];
        if (!paymentData.method || !validMethods.includes(paymentData.method)) {
          throw new Error(`Payment method must be one of: ${validMethods.join(', ')}`);
        }

        // Create payment record
        const payment = {
          invoice_id: invoiceId,
          amount_cents: paymentData.amount_cents,
          date: paymentData.date,
          method: paymentData.method,
          reference: paymentData.reference || null,
          created_at: new Date().toISOString()
        };

        const paymentId = await db.invoice_payments.add(payment);
        await SyncQueue.queueChange('invoice_payments', paymentId, 'CREATE', payment);

        // Update invoice paid_cents
        const newPaidCents = (invoice.paid_cents || 0) + paymentData.amount_cents;
        const invoiceUpdates = {
          paid_cents: newPaidCents,
          ...auditFields(false)
        };

        // Auto-transition to paid if fully paid
        if (newPaidCents >= invoice.total_cents) {
          invoiceUpdates.status = this.STATUS.PAID;
        }

        await db.invoices.update(invoiceId, invoiceUpdates);
        await SyncQueue.queueChange('invoices', invoiceId, 'UPDATE', invoiceUpdates);

        DEBUG && console.log(`Payment of ${MoneyUtils.formatEuros(paymentData.amount_cents)} recorded for invoice ${invoice.invoice_number}`);
        return paymentId;
      },

      /**
       * Get all payment records for an invoice
       * @param {number} invoiceId - Invoice ID
       * @returns {Promise<Array>} Payment records sorted by date descending
       */
      async getPayments(invoiceId) {
        const payments = await db.invoice_payments
          .where('invoice_id').equals(invoiceId)
          .toArray();

        // Sort by date descending (null-safe)
        return payments.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
      },

      /**
       * Check if an invoice is overdue (synchronous)
       * @param {Object} invoice - Invoice object
       * @returns {boolean} True if sent, past due date, and not fully paid
       */
      isOverdue(invoice) {
        if (!invoice || invoice.status !== this.STATUS.SENT) return false;
        if (!invoice.date_due) return false;

        const today = new Date().toISOString().split('T')[0];
        return today > invoice.date_due && (invoice.paid_cents || 0) < invoice.total_cents;
      },

      /**
       * Get all overdue invoices for an entity
       * @param {number} entityId - Entity ID
       * @returns {Promise<Array>} Overdue invoices
       */
      async getOverdueInvoices(entityId) {
        const sentInvoices = await this.getInvoices(entityId, { status: this.STATUS.SENT });
        return sentInvoices.filter(inv => this.isOverdue(inv));
      },

      // --- VeriFactu ---

      /**
       * Generate AEAT VeriFactu QR validation URL
       * Per Real Decreto 1007/2023 (Reglamento VeriFactu)
       * @param {Object} invoice - Invoice object
       * @param {Object} entity - Entity object (needs nif_cif)
       * @returns {string} Full AEAT QR validation URL
       */
      generateVeriFactuQRUrl(invoice, entity) {
        const baseUrl = 'https://www2.agenciatributaria.gob.es/wlpl/TIKE-CONT/ValidarQR';
        const fecha = this._formatDateDDMMYYYY(invoice.date_issued);
        const importe = MoneyUtils.centsToEuros(invoice.total_cents).toFixed(2);

        const params = new URLSearchParams({
          nif: entity.nif_cif,
          numserie: invoice.invoice_number,
          fecha: fecha,
          importe: importe
        });

        return `${baseUrl}?${params.toString()}`;
      },

      /**
       * Convert ISO date (YYYY-MM-DD) to Spanish format (DD-MM-YYYY)
       * @param {string} isoDate - Date in YYYY-MM-DD format
       * @returns {string} Date in DD-MM-YYYY format
       */
      _formatDateDDMMYYYY(isoDate) {
        if (!isoDate) return '';
        const [year, month, day] = isoDate.split('-');
        return `${day}-${month}-${year}`;
      },

      // --- Income Tracking ---

      /**
       * Sum total income from paid invoices for an entity
       * @param {number} entityId - Entity ID
       * @param {Object} [options] - Filter options
       * @param {string} [options.startDate] - Start date (YYYY-MM-DD, inclusive)
       * @param {string} [options.endDate] - End date (YYYY-MM-DD, inclusive)
       * @param {number} [options.clientId] - Filter by client ID
       * @returns {Promise<{totalCents: number, count: number}>}
       */
      async getTotalIncome(entityId, options = {}) {
        let invoices = await this.getInvoices(entityId, { status: this.STATUS.PAID });

        // Filter by date range
        if (options.startDate) {
          invoices = invoices.filter(inv => inv.date_issued >= options.startDate);
        }
        if (options.endDate) {
          invoices = invoices.filter(inv => inv.date_issued <= options.endDate);
        }

        // Filter by client
        if (options.clientId) {
          invoices = invoices.filter(inv => inv.client_id === options.clientId);
        }

        const totalCents = invoices.reduce((sum, inv) => sum + (inv.total_cents || 0), 0);
        return { totalCents, count: invoices.length };
      }

    };

    // =====================================================
    // PHASE 13: Multi-Entity Architecture
    // =====================================================

    /**
     * Entity type constants for type-safe entity handling
     * Used throughout the multi-entity architecture
     */
    const ENTITY_TYPE = Object.freeze({
      AUTONOMO: 'autonomo',
      SOCIEDAD_LIMITADA: 'sociedad_limitada'
    });

    // =====================================================
    // Expense Category Configuration - Phase 17
    // Entity-type-aware deduction rules per category
    // Sources: AEAT Estimacion Directa Simplificada,
    //   AEAT Manual IRPF, LIS Art. 10-15, Ley 6/2017
    // =====================================================

    /**
     * Frozen configuration object defining all expense categories
     * with entity-type-specific deduction rules.
     *
     * Each category has:
     * - key: machine-readable identifier
     * - label: human-readable display name
     * - subcategories: optional array of sub-types
     * - sl_only: optional boolean (true = only relevant for SL entities)
     * - rules: object keyed by ENTITY_TYPE values with deduction logic
     *
     * Deduction methods:
     * - 'full': 100% deductible
     * - 'percentage': fixed percentage (default_percentage field)
     * - 'proportional': base * business_proportion * max_proportion
     * - 'dietas_limit': capped per-day amounts (AEAT Art. 9 RD 439/2007)
     * - 'full_if_justified': 100% if properly documented
     * - 'amortization_table': per LIS depreciation tables (SL only)
     *
     * NOTE: "Gastos de dificil justificacion" (5% automatic IRPF deduction,
     * max 2,000 EUR/year) is NOT an expense category. It is an automatic
     * deduction already handled in the IRPF tax calculation engine (Phase 1).
     */
    const EXPENSE_CATEGORY = Object.freeze({
      HOME_OFFICE: {
        key: 'home_office',
        label: 'Home Office',
        subcategories: ['rent', 'electricity', 'water', 'gas', 'internet'],
        rules: {
          [ENTITY_TYPE.AUTONOMO]: {
            deduction_method: 'proportional',
            max_proportion: 0.30,
            requires_modelo_036: true,
            iva_deductible: false
          },
          [ENTITY_TYPE.SOCIEDAD_LIMITADA]: {
            deduction_method: 'full_if_justified',
            max_proportion: 1.0,
            requires_modelo_036: false,
            iva_deductible: true
          }
        }
      },
      GSM: {
        key: 'gsm',
        label: 'Mobile / Telephone',
        rules: {
          [ENTITY_TYPE.AUTONOMO]: {
            deduction_method: 'percentage',
            default_percentage: 50,
            requires_separate_line: false,
            iva_deductible_pct: 50
          },
          [ENTITY_TYPE.SOCIEDAD_LIMITADA]: {
            deduction_method: 'percentage',
            default_percentage: 100,
            requires_separate_line: false,
            iva_deductible_pct: 100
          }
        }
      },
      VEHICLE: {
        key: 'vehicle',
        label: 'Vehicle',
        subcategories: ['fuel', 'insurance', 'maintenance', 'parking', 'tolls', 'depreciation'],
        rules: {
          [ENTITY_TYPE.AUTONOMO]: {
            deduction_method: 'percentage',
            default_percentage: 0,
            iva_deductible_pct: 50,
            note: 'Must prove exclusive business use for IRPF deduction'
          },
          [ENTITY_TYPE.SOCIEDAD_LIMITADA]: {
            deduction_method: 'full_if_justified',
            default_percentage: 100,
            iva_deductible_pct: 100,
            note: 'Must be in company name. Mixed use = retribucion en especie'
          }
        }
      },
      MEALS_DIETAS: {
        key: 'meals_dietas',
        label: 'Meals / Dietas',
        rules: {
          [ENTITY_TYPE.AUTONOMO]: {
            deduction_method: 'dietas_limit',
            limits: {
              spain_no_overnight: 2667,
              spain_with_overnight: 5334,
              abroad_no_overnight: 4808,
              abroad_with_overnight: 9135
            },
            requires_electronic_payment: true,
            requires_different_municipality: true,
            max_continuous_months: 9
          },
          [ENTITY_TYPE.SOCIEDAD_LIMITADA]: {
            deduction_method: 'full_if_justified',
            default_percentage: 100,
            representation_limit_pct: 1,
            requires_electronic_payment: false
          }
        }
      },
      TRAVEL: {
        key: 'travel',
        label: 'Travel (Flights, Hotels, Transport)',
        subcategories: ['flights', 'hotels', 'local_transport', 'mileage'],
        rules: {
          [ENTITY_TYPE.AUTONOMO]: {
            deduction_method: 'full_if_justified',
            default_percentage: 100,
            hotel_iva_recovery: 'modelo_360',
            flight_iva: 'exempt',
            mileage_rate_cents: 26
          },
          [ENTITY_TYPE.SOCIEDAD_LIMITADA]: {
            deduction_method: 'full_if_justified',
            default_percentage: 100,
            hotel_iva_recovery: 'modelo_360',
            flight_iva: 'exempt',
            mileage_rate_cents: 26
          }
        }
      },
      IT_SOFTWARE: {
        key: 'it_software',
        label: 'IT / Software / Equipment',
        subcategories: ['software_subscriptions', 'hardware', 'cloud_hosting', 'domains'],
        rules: {
          [ENTITY_TYPE.AUTONOMO]: {
            deduction_method: 'full',
            default_percentage: 100,
            depreciation_group: 5,
            depreciation_rate: 26
          },
          [ENTITY_TYPE.SOCIEDAD_LIMITADA]: {
            deduction_method: 'full',
            default_percentage: 100,
            depreciation_group: 5,
            depreciation_rate: 26
          }
        }
      },
      OFFICE_SUPPLIES: {
        key: 'office_supplies',
        label: 'Office Supplies',
        rules: {
          [ENTITY_TYPE.AUTONOMO]: {
            deduction_method: 'full',
            default_percentage: 100
          },
          [ENTITY_TYPE.SOCIEDAD_LIMITADA]: {
            deduction_method: 'full',
            default_percentage: 100
          }
        }
      },
      PROFESSIONAL_SERVICES: {
        key: 'professional_services',
        label: 'Professional Services (Gestor, Lawyer)',
        rules: {
          [ENTITY_TYPE.AUTONOMO]: {
            deduction_method: 'full',
            default_percentage: 100
          },
          [ENTITY_TYPE.SOCIEDAD_LIMITADA]: {
            deduction_method: 'full',
            default_percentage: 100
          }
        }
      },
      TRAINING: {
        key: 'training',
        label: 'Training / Education',
        rules: {
          [ENTITY_TYPE.AUTONOMO]: {
            deduction_method: 'full',
            default_percentage: 100
          },
          [ENTITY_TYPE.SOCIEDAD_LIMITADA]: {
            deduction_method: 'full',
            default_percentage: 100
          }
        }
      },
      DEPRECIATION: {
        key: 'depreciation',
        label: 'Asset Depreciation',
        sl_only: true,
        rules: {
          [ENTITY_TYPE.AUTONOMO]: {
            note: 'Use simplified amortization table (Grupo 1-10). Applied per-asset, not as separate expense.'
          },
          [ENTITY_TYPE.SOCIEDAD_LIMITADA]: {
            deduction_method: 'amortization_table',
            tables: 'LIS Art. 12 tables',
            note: 'Use IS amortization tables. Accelerated amortization available for PYME.'
          }
        }
      }
    });

    /**
     * Spanish Tax ID Validator
     * Validates NIF, CIF, and NIE with official check digit algorithms
     *
     * NIF (Numero de Identificacion Fiscal): For individual persons
     *   Format: 8 digits + 1 control letter
     *   Algorithm: letter = NIF_LETTERS[number % 23]
     *
     * NIE (Numero de Identity de Extranjero): For foreign residents
     *   Format: X/Y/Z + 7 digits + 1 control letter
     *   Algorithm: Replace prefix (X=0, Y=1, Z=2), then NIF algorithm
     *
     * CIF (Codigo de Identificacion Fiscal): For legal entities
     *   Format: 1 letter (org type) + 7 digits + 1 control (letter or digit)
     *   Algorithm: Sum with odd/even position weighting, control varies by org type
     */
    const SpanishTaxIdValidator = {
      // NIF check letter lookup table (official AEAT sequence)
      NIF_LETTERS: 'TRWAGMYFPDXBNJZSQVHLCKE',

      // CIF control letter lookup (for letter-control types)
      CIF_CONTROL_LETTERS: 'JABCDEFGHI',

      // CIF organization types that MUST use letter control
      CIF_LETTER_CONTROL: ['K', 'P', 'Q', 'S'],

      // CIF organization types that MUST use number control
      CIF_NUMBER_CONTROL: ['A', 'B', 'E', 'H'],

      // Organization type descriptions
      ORG_TYPES: {
        'A': 'Sociedad Anonima',
        'B': 'Sociedad de Responsabilidad Limitada',
        'C': 'Sociedad Colectiva',
        'D': 'Sociedad Comanditaria',
        'E': 'Comunidad de Bienes',
        'F': 'Sociedad Cooperativa',
        'G': 'Asociacion o Fundacion',
        'H': 'Comunidad de Propietarios',
        'J': 'Sociedad Civil',
        'K': 'Entity Extranjera (Spain)',
        'L': 'Entity Extranjera (Sin Establecimiento)',
        'M': 'Entity Extranjera (Con Establecimiento)',
        'N': 'Entity Extranjera',
        'P': 'Corporacion Local',
        'Q': 'Organismo Publico',
        'R': 'Congregacion o Institucion Religiosa',
        'S': 'Organo de la Administracion del Estado',
        'U': 'Union Temporal de Empresas',
        'V': 'Otros tipos no definidos',
        'W': 'Establecimientos permanentes de entityes no residentes'
      },

      /**
       * Clean input: trim, uppercase, remove spaces and hyphens
       * @param {string} input - Raw input
       * @returns {string} Cleaned input
       */
      _clean(input) {
        if (!input) return '';
        return input.toString().trim().toUpperCase().replace(/[\s-]/g, '');
      },

      /**
       * Get organization type description from CIF letter
       * @param {string} letter - First letter of CIF
       * @returns {string} Organization type description
       */
      getOrganizationType(letter) {
        return this.ORG_TYPES[letter] || 'Tipo desconocido';
      },

      /**
       * Validate NIF (Spanish personal tax ID)
       * Format: 8 digits + 1 letter
       * @param {string} nif - NIF to validate
       * @returns {{valid: boolean, error?: string, formatted?: string}}
       */
      validateNIF(nif) {
        const cleaned = this._clean(nif);

        if (!cleaned) {
          return { valid: false, error: 'NIF required' };
        }

        // Format: 8 digits + 1 letter
        const match = cleaned.match(/^(\d{8})([A-Z])$/);

        if (!match) {
          return { valid: false, error: 'Invalid NIF format (8 digits + letter)' };
        }

        const [, digits, letter] = match;
        const expectedLetter = this.NIF_LETTERS[parseInt(digits, 10) % 23];

        if (letter !== expectedLetter) {
          return {
            valid: false,
            error: `Incorrect control letter (expected: ${expectedLetter})`
          };
        }

        return { valid: true, formatted: cleaned };
      },

      /**
       * Validate NIE (Foreign resident tax ID)
       * Format: X/Y/Z + 7 digits + 1 letter
       * @param {string} nie - NIE to validate
       * @returns {{valid: boolean, error?: string, formatted?: string}}
       */
      validateNIE(nie) {
        const cleaned = this._clean(nie);

        if (!cleaned) {
          return { valid: false, error: 'NIE required' };
        }

        // Format: X/Y/Z + 7 digits + 1 letter
        const match = cleaned.match(/^([XYZ])(\d{7})([A-Z])$/);

        if (!match) {
          return { valid: false, error: 'Invalid NIE format (X/Y/Z + 7 digits + letter)' };
        }

        const [, prefix, digits, letter] = match;

        // Convert prefix to number: X=0, Y=1, Z=2
        const prefixValue = { 'X': '0', 'Y': '1', 'Z': '2' }[prefix];
        const fullNumber = parseInt(prefixValue + digits, 10);
        const expectedLetter = this.NIF_LETTERS[fullNumber % 23];

        if (letter !== expectedLetter) {
          return {
            valid: false,
            error: `Incorrect control letter (expected: ${expectedLetter})`
          };
        }

        return { valid: true, formatted: cleaned };
      },

      /**
       * Validate CIF (Legal entity tax ID)
       * Format: 1 org type letter + 7 digits + 1 control (letter or digit)
       * @param {string} cif - CIF to validate
       * @returns {{valid: boolean, error?: string, formatted?: string, organizationType?: string}}
       */
      validateCIF(cif) {
        const cleaned = this._clean(cif);

        if (!cleaned) {
          return { valid: false, error: 'CIF required' };
        }

        // Format: org letter + 7 digits + control (letter or digit)
        const match = cleaned.match(/^([ABCDEFGHJKLMNPQRSUVW])(\d{7})([0-9A-J])$/);

        if (!match) {
          return { valid: false, error: 'Invalid CIF format (letter + 7 digits + control)' };
        }

        const [, orgLetter, digits, control] = match;

        // Calculate control digit/letter using official algorithm
        let sumEven = 0;
        let sumOdd = 0;

        for (let i = 0; i < 7; i++) {
          const digit = parseInt(digits[i], 10);

          if (i % 2 === 0) {
            // Odd positions (1st, 3rd, 5th, 7th): multiply by 2, sum digits if > 9
            const doubled = digit * 2;
            sumOdd += doubled > 9 ? doubled - 9 : doubled;
          } else {
            // Even positions (2nd, 4th, 6th): just sum
            sumEven += digit;
          }
        }

        const total = sumOdd + sumEven;
        const controlNumber = (10 - (total % 10)) % 10;
        const controlLetter = this.CIF_CONTROL_LETTERS[controlNumber];

        // Determine expected control based on organization type
        let expectedControl;
        let isValid = false;

        if (this.CIF_LETTER_CONTROL.includes(orgLetter)) {
          // These types MUST use letter control
          expectedControl = controlLetter;
          isValid = control === controlLetter;
        } else if (this.CIF_NUMBER_CONTROL.includes(orgLetter)) {
          // These types MUST use number control
          expectedControl = controlNumber.toString();
          isValid = control === controlNumber.toString();
        } else {
          // Other types can use either letter or number
          expectedControl = `${controlNumber} o ${controlLetter}`;
          isValid = control === controlNumber.toString() || control === controlLetter;
        }

        if (!isValid) {
          return {
            valid: false,
            error: `Incorrect control digit (expected: ${expectedControl})`
          };
        }

        return {
          valid: true,
          formatted: cleaned,
          organizationType: this.getOrganizationType(orgLetter)
        };
      },

      /**
       * Auto-detect and validate any Spanish tax ID
       * @param {string} taxId - Tax ID to validate
       * @returns {{valid: boolean, error?: string, formatted?: string, type?: string, organizationType?: string}}
       */
      validate(taxId) {
        const cleaned = this._clean(taxId);

        if (!cleaned) {
          return { valid: false, error: 'Tax ID required' };
        }

        // Detect type by format
        // NIE: starts with X, Y, or Z
        if (/^[XYZ]/.test(cleaned)) {
          const result = this.validateNIE(cleaned);
          return { ...result, type: 'NIE' };
        }

        // CIF: starts with organization letter (not X/Y/Z, not digit)
        if (/^[ABCDEFGHJKLMNPQRSUVW]/.test(cleaned)) {
          const result = this.validateCIF(cleaned);
          return { ...result, type: 'CIF' };
        }

        // NIF: starts with digit
        if (/^\d/.test(cleaned)) {
          const result = this.validateNIF(cleaned);
          return { ...result, type: 'NIF' };
        }

        return { valid: false, error: 'Unrecognized tax ID format' };
      }
    };

    // =====================================================
    // EU VAT Validation and Country Utilities
    // =====================================================

    /**
     * EU VAT Number Format Patterns
     * Based on European Commission VIES specification
     * https://ec.europa.eu/taxation_customs/vies/
     *
     * All 27 EU member states plus XI (Northern Ireland)
     * Note: Greece uses 'EL' country code, not 'GR' per EU VIES
     */
    const EU_VAT_PATTERNS = Object.freeze({
      AT: /^ATU\d{8}$/,                              // Austria
      BE: /^BE[01]\d{9}$/,                           // Belgium
      BG: /^BG\d{9,10}$/,                            // Bulgaria
      CY: /^CY\d{8}[A-Z]$/,                          // Cyprus
      CZ: /^CZ\d{8,10}$/,                            // Czech Republic
      DE: /^DE\d{9}$/,                               // Germany
      DK: /^DK\d{8}$/,                               // Denmark
      EE: /^EE\d{9}$/,                               // Estonia
      EL: /^EL\d{9}$/,                               // Greece (EL not GR!)
      ES: /^ES[A-Z0-9]\d{7}[A-Z0-9]$/,               // Spain
      FI: /^FI\d{8}$/,                               // Finland
      FR: /^FR[A-Z0-9]{2}\d{9}$/,                    // France
      HR: /^HR\d{11}$/,                              // Croatia
      HU: /^HU\d{8}$/,                               // Hungary
      IE: /^IE(\d{7}[A-Z]{1,2}|\d[A-Z+*]\d{5}[A-Z])$/, // Ireland
      IT: /^IT\d{11}$/,                              // Italy
      LT: /^LT(\d{9}|\d{12})$/,                      // Lithuania
      LU: /^LU\d{8}$/,                               // Luxembourg
      LV: /^LV\d{11}$/,                              // Latvia
      MT: /^MT\d{8}$/,                               // Malta
      NL: /^NL\d{9}B\d{2}$/,                         // Netherlands
      PL: /^PL\d{10}$/,                              // Poland
      PT: /^PT\d{9}$/,                               // Portugal
      RO: /^RO\d{2,10}$/,                            // Romania
      SE: /^SE\d{12}$/,                              // Sweden
      SI: /^SI\d{8}$/,                               // Slovenia
      SK: /^SK\d{10}$/,                              // Slovakia
      XI: /^XI\d{9}(\d{3})?$/                        // Northern Ireland
    });

    /**
     * Convert ISO 3166-1 alpha-2 country code to flag emoji
     * Uses Unicode regional indicator symbols
     * @param {string} countryCode - Two-letter ISO country code
     * @returns {string} Flag emoji or empty string if invalid
     */
    function getFlagEmoji(countryCode) {
      if (!countryCode || countryCode.length !== 2) return '';
      // Regional indicator symbols start at U+1F1E6 (A)
      // 127397 = 0x1F1E6 - 65 (ASCII 'A')
      const codePoints = countryCode
        .toUpperCase()
        .split('')
        .map(char => 127397 + char.charCodeAt(0));
      return String.fromCodePoint(...codePoints);
    }

    // =====================================================
    // Client Category Constants
    // =====================================================

    /**
     * Client tax treatment categories
     * Determines IVA treatment and invoicing requirements
     * Per Spanish AEAT regulations and EU VAT Directive
     */
    const CLIENT_CATEGORY = Object.freeze({
      SPAIN: 'spain',                 // Spanish domestic client - IVA applies
      EU_B2B: 'eu_b2b',               // EU business - inversion sujeto pasivo (no IVA)
      EU_B2C: 'eu_b2c',               // EU consumer - IVA applies (OSS possible)
      UK: 'uk',                       // UK post-Brexit - third country rules
      THIRD_COUNTRY: 'third_country'  // US, CA, AU, etc. - export (no IVA)
    });

    /**
     * Map ISO country codes to client categories
     * EU countries return 'eu' - caller must specify B2B/B2C
     * Non-listed countries fall back to _default (third_country)
     */
    const CATEGORY_BY_COUNTRY = Object.freeze({
      // Spain
      ES: CLIENT_CATEGORY.SPAIN,

      // EU Member States (26 countries, excluding Spain)
      // Return 'eu' - user must specify B2B or B2C
      AT: 'eu', BE: 'eu', BG: 'eu', CY: 'eu', CZ: 'eu',
      DE: 'eu', DK: 'eu', EE: 'eu', EL: 'eu', FI: 'eu',
      FR: 'eu', HR: 'eu', HU: 'eu', IE: 'eu', IT: 'eu',
      LT: 'eu', LU: 'eu', LV: 'eu', MT: 'eu', NL: 'eu',
      PL: 'eu', PT: 'eu', RO: 'eu', SE: 'eu', SI: 'eu', SK: 'eu',

      // UK post-Brexit (including Northern Ireland for services)
      GB: CLIENT_CATEGORY.UK,
      XI: CLIENT_CATEGORY.UK,  // Northern Ireland: goods with EU rules, services with UK rules

      // Default for all other countries (US, CA, AU, etc.)
      _default: CLIENT_CATEGORY.THIRD_COUNTRY
    });

    /**
     * All EU country codes for UI dropdowns
     * Includes EL (Greece) per VIES specification
     * Sorted alphabetically
     */
    const EU_COUNTRY_CODES = Object.freeze([
      'AT', 'BE', 'BG', 'CY', 'CZ', 'DE', 'DK', 'EE', 'EL', 'ES',
      'FI', 'FR', 'HR', 'HU', 'IE', 'IT', 'LT', 'LU', 'LV', 'MT',
      'NL', 'PL', 'PT', 'RO', 'SE', 'SI', 'SK'
    ]);

    /**
     * Get client category from country code
     * Resolves 'eu' to EU_B2B or EU_B2C based on isB2B flag
     * @param {string} countryCode - ISO 3166-1 alpha-2 country code
     * @param {boolean} isB2B - True if business-to-business (default: true)
     * @returns {string} Client category constant
     */
    function getClientCategoryByCountry(countryCode, isB2B = true) {
      const mapping = CATEGORY_BY_COUNTRY[countryCode?.toUpperCase()];
      if (mapping === 'eu') {
        return isB2B ? CLIENT_CATEGORY.EU_B2B : CLIENT_CATEGORY.EU_B2C;
      }
      return mapping || CATEGORY_BY_COUNTRY._default;
    }

    // =====================================================
    // IVA Treatment Configuration - Phase 18
    // Maps CLIENT_CATEGORY to IVA rate, label, and legal text
    // Sources: Ley 37/1992 del IVA, Directiva 2006/112/CE
    // =====================================================

    /**
     * IVA treatment rules per client category
     * - spain: Standard 21% IVA
     * - eu_b2b: Reverse charge (inversion del sujeto pasivo)
     * - eu_b2c: Standard 21% IVA (OSS possible)
     * - uk: Export, no IVA (post-Brexit)
     * - third_country: Export, no IVA
     */
    const IVA_TREATMENT = Object.freeze({
      [CLIENT_CATEGORY.SPAIN]: Object.freeze({
        rate: 0.21,
        label: 'IVA 21%',
        legalText: null
      }),
      [CLIENT_CATEGORY.EU_B2B]: Object.freeze({
        rate: 0,
        label: 'Exempt - Reverse charge',
        legalText: 'Inversion del sujeto pasivo - Art. 84.Uno.2 Ley 37/1992 del IVA. Art. 196 Directiva 2006/112/CE.'
      }),
      [CLIENT_CATEGORY.EU_B2C]: Object.freeze({
        rate: 0.21,
        label: 'IVA 21%',
        legalText: null
      }),
      [CLIENT_CATEGORY.UK]: Object.freeze({
        rate: 0,
        label: 'Export - No IVA',
        legalText: 'Exportacion de servicios. Operacion no sujeta a IVA. Art. 69 Ley 37/1992.'
      }),
      [CLIENT_CATEGORY.THIRD_COUNTRY]: Object.freeze({
        rate: 0,
        label: 'Export - No IVA',
        legalText: 'Exportacion de servicios. Operacion no sujeta a IVA. Art. 69 Ley 37/1992.'
      })
    });

    /**
     * IRPF retention rates for Spanish invoices
     * Only applies when: entity_type === 'autonomo' AND client.category === 'spain'
     * Source: AEAT - Reglamento IRPF Art. 101
     */
    const IRPF_RETENTION = Object.freeze({
      STANDARD: 15,  // Established autonomo (>3 years)
      REDUCED: 7,    // First 3 years of activity
      NONE: 0        // Default: SL entities, foreign clients
    });

    /**
     * Supported invoice currencies
     * EUR is default; others require exchange rate
     */
    const INVOICE_CURRENCY = Object.freeze({
      EUR: 'EUR',
      USD: 'USD',
      GBP: 'GBP'
    });

    // =====================================================
    // VIES VAT Validation Module
    // =====================================================

    /**
     * VIESValidator provides EU VAT number validation
     * - Format validation: offline-safe, always works
     * - VIES API validation: requires Edge Function, falls back gracefully
     */
    const VIESValidator = {
      /**
       * Format-only validation (offline-safe, always works)
       * @param {string} countryCode - ISO country code (e.g., 'BE')
       * @param {string} vatNumber - VAT number without country prefix
       * @returns {{ valid: boolean, error?: string, formatted?: string }}
       */
      validateFormat(countryCode, vatNumber) {
        if (!countryCode || !vatNumber) {
          return { valid: false, error: 'Country code and VAT number required' };
        }

        const code = countryCode.toUpperCase();
        const normalized = vatNumber.toUpperCase().replace(/[\s\-\.]/g, '');

        // Map GR to EL for Greece per VIES specification
        const lookupCode = code === 'GR' ? 'EL' : code;

        const pattern = EU_VAT_PATTERNS[lookupCode];
        if (!pattern) {
          return { valid: false, error: 'Country not supported for VIES validation' };
        }

        // Construct full VAT number with country prefix
        const fullVat = lookupCode + normalized;

        if (!pattern.test(fullVat)) {
          return {
            valid: false,
            error: `Invalid VAT format for ${lookupCode}`
          };
        }

        return {
          valid: true,
          formatted: fullVat,
          formatOnly: true
        };
      },

      /**
       * Full VIES validation via Edge Function
       * Falls back to format-only when offline
       * @param {string} countryCode - ISO country code
       * @param {string} vatNumber - VAT number without country prefix
       * @returns {Promise<{ valid: boolean, error?: string, name?: string, address?: string, warning?: string }>}
       */
      async validateWithVIES(countryCode, vatNumber) {
        // First, format validation
        const formatResult = this.validateFormat(countryCode, vatNumber);
        if (!formatResult.valid) {
          return formatResult;
        }

        // Check if Supabase is available
        if (!supabaseClient || AuthManager.isOfflineMode()) {
          return {
            ...formatResult,
            warning: 'Validacion VIES no disponible en modo offline. Solo se valido el formato.'
          };
        }

        try {
          // Map GR to EL for VIES API
          const viesCountry = countryCode.toUpperCase() === 'GR' ? 'EL' : countryCode.toUpperCase();
          const viesNumber = vatNumber.toUpperCase().replace(/[\s\-\.]/g, '');

          const { data, error } = await supabaseClient.functions.invoke('vies-validate', {
            body: {
              countryCode: viesCountry,
              vatNumber: viesNumber
            }
          });

          if (error) throw error;

          // Handle service unavailability
          if (data.error === 'SERVICE_UNAVAILABLE') {
            return {
              ...formatResult,
              warning: 'VIES service temporarily unavailable. Format verified.'
            };
          }

          if (data.error) {
            return {
              valid: false,
              error: data.message || 'VIES validation error'
            };
          }

          return {
            valid: data.valid,
            formatted: formatResult.formatted,
            name: data.name,
            address: data.address,
            validatedAt: data.requestDate
          };

        } catch (err) {
          console.warn('VIES validation failed:', err);
          return {
            ...formatResult,
            warning: 'Could not connect to VIES. Solo se valido el formato.'
          };
        }
      },

      /**
       * Check if country supports VIES validation
       * @param {string} countryCode - ISO country code
       * @returns {boolean}
       */
      isVIESCountry(countryCode) {
        const code = countryCode?.toUpperCase();
        const lookupCode = code === 'GR' ? 'EL' : code;
        return !!EU_VAT_PATTERNS[lookupCode];
      }
    };

    // =====================================================
    // Client Manager Module (CRUD Operations)
    // =====================================================

    /**
     * ClientManager provides CRUD operations for clients
     * - Validates tax IDs based on country (Spanish, EU, third country)
     * - Sets category automatically from country code
     * - Queues all changes to SyncQueue for cloud sync
     */
    const ClientManager = {
      /**
       * Create a new client
       * Validates tax ID based on country, categorizes automatically
       * @param {Object} clientData - Client data
       * @returns {Promise<number>} - Created client ID
       */
      async createClient(clientData) {
        const entityId = EntityContext.entityId;
        if (!entityId) {
          throw new Error('No entity selected');
        }

        // Normalize input
        const normalized = {
          entity_id: entityId,
          name: clientData.name?.trim(),
          email: clientData.email?.trim() || null,
          phone: clientData.phone?.trim() || null,
          address: clientData.address?.trim() || null,
          country_code: clientData.country_code?.toUpperCase() || 'ES',
          is_b2b: clientData.is_b2b !== false, // Default true for businesses
          w8ben_uploaded: false,
          w8ben_uploaded_at: null
        };

        if (!normalized.name) {
          throw new Error('Client name is required');
        }

        // Tax ID validation based on country
        if (clientData.tax_id) {
          const taxId = clientData.tax_id.trim();

          if (normalized.country_code === 'ES') {
            // Spanish client: use SpanishTaxIdValidator
            const validation = SpanishTaxIdValidator.validate(taxId);
            if (!validation.valid) {
              throw new Error(validation.error);
            }
            normalized.tax_id = validation.normalized;
            normalized.tax_id_type = validation.type.toLowerCase(); // 'nif', 'cif', 'nie'
            normalized.tax_id_validated = true;
            normalized.tax_id_validated_at = new Date().toISOString();
          } else if (VIESValidator.isVIESCountry(normalized.country_code)) {
            // EU client: format validation (VIES checked separately via UI button)
            const formatResult = VIESValidator.validateFormat(normalized.country_code, taxId);
            if (!formatResult.valid) {
              throw new Error(formatResult.error);
            }
            normalized.tax_id = formatResult.formatted;
            normalized.tax_id_type = 'eu_vat';
            normalized.tax_id_validated = false; // Not VIES validated yet
            normalized.tax_id_validated_at = null;
          } else {
            // Third country: store as-is
            normalized.tax_id = taxId.toUpperCase().replace(/[\s\-]/g, '');
            normalized.tax_id_type = 'third_country';
            normalized.tax_id_validated = true; // No external validation needed
            normalized.tax_id_validated_at = new Date().toISOString();
          }
        } else {
          normalized.tax_id = null;
          normalized.tax_id_type = null;
          normalized.tax_id_validated = false;
          normalized.tax_id_validated_at = null;
        }

        // Set category based on country and B2B flag
        normalized.category = getClientCategoryByCountry(normalized.country_code, normalized.is_b2b);

        // Add audit fields
        const client = {
          ...normalized,
          deleted_at: null,
          ...auditFields(true) // created_at, updated_at
        };

        const id = await db.clients.add(client);

        // Queue for sync
        await SyncQueue.queueChange('clients', id, 'CREATE', client);

        return id;
      },

      /**
       * Get all clients for current entity
       * @param {Object} options - Filter options
       * @returns {Promise<Array>}
       */
      async getClients(options = {}) {
        const entityId = EntityContext.entityId;
        if (!entityId) return [];

        let clients = await db.clients
          .where('entity_id')
          .equals(entityId)
          .filter(c => c.deleted_at === null)
          .toArray();

        // Apply filters
        if (options.search) {
          const term = options.search.toLowerCase();
          clients = clients.filter(c =>
            c.name?.toLowerCase().includes(term) ||
            c.tax_id?.toLowerCase().includes(term) ||
            c.email?.toLowerCase().includes(term)
          );
        }

        if (options.country_code) {
          clients = clients.filter(c => c.country_code === options.country_code);
        }

        if (options.category) {
          clients = clients.filter(c => c.category === options.category);
        }

        // Sort alphabetically by name (per CONTEXT.md)
        clients.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'es'));

        return clients;
      },

      /**
       * Get single client by ID
       * @param {number} clientId
       * @returns {Promise<Object|null>}
       */
      async getClient(clientId) {
        const client = await db.clients.get(clientId);
        if (!client || client.deleted_at) return null;

        // Verify entity access
        if (client.entity_id !== EntityContext.entityId) {
          return null;
        }

        return client;
      },

      /**
       * Update client
       * @param {number} clientId
       * @param {Object} updates
       * @returns {Promise<void>}
       */
      async updateClient(clientId, updates) {
        const client = await this.getClient(clientId);
        if (!client) {
          throw new Error('Client not found');
        }

        // If tax_id changed, revalidate
        if (updates.tax_id !== undefined && updates.tax_id !== client.tax_id) {
          const countryCode = updates.country_code || client.country_code;

          if (updates.tax_id) {
            if (countryCode === 'ES') {
              const validation = SpanishTaxIdValidator.validate(updates.tax_id);
              if (!validation.valid) throw new Error(validation.error);
              updates.tax_id = validation.normalized;
              updates.tax_id_type = validation.type.toLowerCase();
              updates.tax_id_validated = true;
              updates.tax_id_validated_at = new Date().toISOString();
            } else if (VIESValidator.isVIESCountry(countryCode)) {
              const formatResult = VIESValidator.validateFormat(countryCode, updates.tax_id);
              if (!formatResult.valid) throw new Error(formatResult.error);
              updates.tax_id = formatResult.formatted;
              updates.tax_id_type = 'eu_vat';
              updates.tax_id_validated = false; // Requires VIES re-validation
              updates.tax_id_validated_at = null;
            } else {
              updates.tax_id = updates.tax_id.toUpperCase().replace(/[\s\-]/g, '');
              updates.tax_id_type = 'third_country';
              updates.tax_id_validated = true;
              updates.tax_id_validated_at = new Date().toISOString();
            }
          } else {
            updates.tax_id = null;
            updates.tax_id_type = null;
            updates.tax_id_validated = false;
            updates.tax_id_validated_at = null;
          }
        }

        // Recalculate category if country or B2B changed
        if (updates.country_code !== undefined || updates.is_b2b !== undefined) {
          const countryCode = updates.country_code || client.country_code;
          const isB2B = updates.is_b2b !== undefined ? updates.is_b2b : client.is_b2b;
          updates.category = getClientCategoryByCountry(countryCode, isB2B);
        }

        // Add update timestamp
        updates.updated_at = new Date().toISOString();

        await db.clients.update(clientId, updates);
        await SyncQueue.queueChange('clients', clientId, 'UPDATE', updates);
      },

      /**
       * Mark VIES validation result on client
       * @param {number} clientId
       * @param {Object} viesResult - Result from VIESValidator.validateWithVIES
       * @returns {Promise<void>}
       */
      async setVIESValidation(clientId, viesResult) {
        const updates = {
          tax_id_validated: viesResult.valid === true,
          tax_id_validated_at: viesResult.validatedAt || new Date().toISOString(),
          updated_at: new Date().toISOString()
        };
        await db.clients.update(clientId, updates);
        await SyncQueue.queueChange('clients', clientId, 'UPDATE', updates);
      },

      /**
       * Archive (soft delete) client
       * @param {number} clientId
       * @returns {Promise<void>}
       */
      async archiveClient(clientId) {
        return DataManager.softDelete('clients', clientId);
      },

      /**
       * Restore archived client
       * @param {number} clientId
       * @returns {Promise<void>}
       */
      async restoreClient(clientId) {
        return DataManager.restore('clients', clientId);
      }
    };

    // =====================================================
    // Contact Role Constants
    // =====================================================

    const CONTACT_ROLE = Object.freeze({
      BILLING: 'billing',
      PROJECT_MANAGER: 'project_manager',
      TECHNICAL: 'technical',
      GENERAL: 'general'
    });

    const CONTACT_ROLE_LABELS = Object.freeze({
      [CONTACT_ROLE.BILLING]: 'Billing',
      [CONTACT_ROLE.PROJECT_MANAGER]: 'Project Manager',
      [CONTACT_ROLE.TECHNICAL]: 'Technical',
      [CONTACT_ROLE.GENERAL]: 'General'
    });

    // =====================================================
    // Contact Manager Module
    // =====================================================

    /**
     * ContactManager - CRUD operations for client contacts
     * Supports multiple contacts per client with roles and primary designation
     */
    const ContactManager = {
      /**
       * Create a contact for a client
       * @param {number} clientId
       * @param {Object} contactData
       * @returns {Promise<number>} - Created contact ID
       */
      async createContact(clientId, contactData) {
        // Verify client exists and belongs to current entity
        const client = await ClientManager.getClient(clientId);
        if (!client) {
          throw new Error('Client not found');
        }

        const normalized = {
          client_id: clientId,
          entity_id: client.entity_id,  // Denormalize for faster entity-scoped queries
          name: contactData.name?.trim(),
          email: contactData.email?.trim() || null,
          phone: contactData.phone?.trim() || null,
          role: contactData.role || CONTACT_ROLE.GENERAL,
          is_primary: !!contactData.is_primary,
          ...auditFields(true)
        };

        if (!normalized.name) {
          throw new Error('Contact name is required');
        }

        // If marking as primary, unset other primaries for this client
        if (normalized.is_primary) {
          await this._clearPrimaryContact(clientId);
        }

        const id = await db.contacts.add(normalized);
        await SyncQueue.queueChange('contacts', id, 'CREATE', normalized);

        return id;
      },

      /**
       * Get all contacts for a client
       * @param {number} clientId
       * @returns {Promise<Array>}
       */
      async getContacts(clientId) {
        const contacts = await db.contacts
          .where('client_id')
          .equals(clientId)
          .toArray();

        // Sort: primary first, then by name
        contacts.sort((a, b) => {
          if (a.is_primary && !b.is_primary) return -1;
          if (!a.is_primary && b.is_primary) return 1;
          return (a.name || '').localeCompare(b.name || '', 'es');
        });

        return contacts;
      },

      /**
       * Get primary contact for a client
       * @param {number} clientId
       * @returns {Promise<Object|null>}
       */
      async getPrimaryContact(clientId) {
        const contacts = await this.getContacts(clientId);
        return contacts.find(c => c.is_primary) || contacts[0] || null;
      },

      /**
       * Update a contact
       * @param {number} contactId
       * @param {Object} updates
       * @returns {Promise<void>}
       */
      async updateContact(contactId, updates) {
        const contact = await db.contacts.get(contactId);
        if (!contact) {
          throw new Error('Contact not found');
        }

        // Verify client access
        const client = await ClientManager.getClient(contact.client_id);
        if (!client) {
          throw new Error('Access denied');
        }

        // If marking as primary, unset other primaries
        if (updates.is_primary && !contact.is_primary) {
          await this._clearPrimaryContact(contact.client_id);
        }

        updates.updated_at = new Date().toISOString();

        await db.contacts.update(contactId, updates);
        await SyncQueue.queueChange('contacts', contactId, 'UPDATE', updates);
      },

      /**
       * Delete a contact
       * @param {number} contactId
       * @returns {Promise<void>}
       */
      async deleteContact(contactId) {
        const contact = await db.contacts.get(contactId);
        if (!contact) return;

        // Verify client access
        const client = await ClientManager.getClient(contact.client_id);
        if (!client) {
          throw new Error('Access denied');
        }

        await db.contacts.delete(contactId);
        await SyncQueue.queueChange('contacts', contactId, 'DELETE', null);
      },

      /**
       * Set a contact as primary (unsets others)
       * @param {number} contactId
       * @returns {Promise<void>}
       */
      async setPrimaryContact(contactId) {
        await this.updateContact(contactId, { is_primary: true });
      },

      /**
       * Clear primary flag from all contacts for a client
       * @private
       */
      async _clearPrimaryContact(clientId) {
        const contacts = await db.contacts
          .where('client_id')
          .equals(clientId)
          .filter(c => c.is_primary)
          .toArray();

        for (const contact of contacts) {
          await db.contacts.update(contact.id, {
            is_primary: false,
            updated_at: new Date().toISOString()
          });
        }
      }
    };

    // =====================================================
    // Project Constants
    // =====================================================

    const RATE_TYPE = Object.freeze({
      DAILY: 'daily',
      HOURLY: 'hourly',
      FIXED: 'fixed',
      MONTHLY_RETAINER: 'monthly_retainer'
    });

    const RATE_TYPE_LABELS = Object.freeze({
      [RATE_TYPE.DAILY]: 'Daily',
      [RATE_TYPE.HOURLY]: 'Hourly',
      [RATE_TYPE.FIXED]: 'Fixed price',
      [RATE_TYPE.MONTHLY_RETAINER]: 'Monthly retainer'
    });

    const PROJECT_STATUS = Object.freeze({
      UPCOMING: 'upcoming',
      ACTIVE: 'active',
      COMPLETED: 'completed',
      CANCELLED: 'cancelled'
    });

    const PROJECT_STATUS_LABELS = Object.freeze({
      [PROJECT_STATUS.UPCOMING]: 'Upcoming',
      [PROJECT_STATUS.ACTIVE]: 'Active',
      [PROJECT_STATUS.COMPLETED]: 'Completed',
      [PROJECT_STATUS.CANCELLED]: 'Cancelled'
    });

    // =====================================================
    // Project Manager Module
    // =====================================================

    /**
     * ProjectManager - CRUD operations for client projects
     * Projects have rate types, auto-calculated status from dates,
     * and optional manual status override
     */
    const ProjectManager = {
      /**
       * Create a project for a client
       * @param {number} clientId
       * @param {Object} projectData
       * @returns {Promise<number>} - Created project ID
       */
      async createProject(clientId, projectData) {
        // Verify client exists
        const client = await ClientManager.getClient(clientId);
        if (!client) {
          throw new Error('Client not found');
        }

        const entityId = EntityContext.entityId;

        const normalized = {
          client_id: clientId,
          entity_id: entityId, // Denormalized for faster queries
          name: projectData.name?.trim(),
          rate_type: projectData.rate_type || RATE_TYPE.DAILY,
          rate_cents: projectData.rate_cents || 0,
          start_date: projectData.start_date || null,
          end_date: projectData.end_date || null,
          status_override: projectData.status_override || null,
          notes: projectData.notes?.trim() || null,
          deleted_at: null,
          ...auditFields(true)
        };

        if (!normalized.name) {
          throw new Error('Project name is required');
        }

        // Validate rate_type
        if (!Object.values(RATE_TYPE).includes(normalized.rate_type)) {
          throw new Error('Invalid rate type');
        }

        // Validate dates
        if (normalized.start_date && normalized.end_date) {
          if (normalized.end_date < normalized.start_date) {
            throw new Error('End date cannot be before start date');
          }
        }

        const id = await db.projects.add(normalized);
        await SyncQueue.queueChange('projects', id, 'CREATE', normalized);

        return id;
      },

      /**
       * Get all projects for a client
       * @param {number} clientId
       * @param {Object} options
       * @returns {Promise<Array>}
       */
      async getProjectsByClient(clientId, options = {}) {
        let projects = await db.projects
          .where('client_id')
          .equals(clientId)
          .filter(p => p.deleted_at === null)
          .toArray();

        // Calculate status for each project
        projects = projects.map(p => ({
          ...p,
          status: this.calculateStatus(p)
        }));

        // Filter by status if specified
        if (options.status) {
          projects = projects.filter(p => p.status === options.status);
        }

        // Sort by start date (most recent first)
        projects.sort((a, b) => {
          if (!a.start_date) return 1;
          if (!b.start_date) return -1;
          return b.start_date.localeCompare(a.start_date);
        });

        return projects;
      },

      /**
       * Get all projects for current entity
       * @param {Object} options
       * @returns {Promise<Array>}
       */
      async getProjects(options = {}) {
        const entityId = EntityContext.entityId;
        if (!entityId) return [];

        let projects = await db.projects
          .where('entity_id')
          .equals(entityId)
          .filter(p => p.deleted_at === null)
          .toArray();

        // Calculate status for each
        projects = projects.map(p => ({
          ...p,
          status: this.calculateStatus(p)
        }));

        // Filter by status if specified
        if (options.status) {
          projects = projects.filter(p => p.status === options.status);
        }

        return projects;
      },

      /**
       * Get active projects for a client (for display)
       * @param {number} clientId
       * @returns {Promise<Array>}
       */
      async getActiveProjects(clientId) {
        return this.getProjectsByClient(clientId, { status: PROJECT_STATUS.ACTIVE });
      },

      /**
       * Get single project by ID
       * @param {number} projectId
       * @returns {Promise<Object|null>}
       */
      async getProject(projectId) {
        const project = await db.projects.get(projectId);
        if (!project || project.deleted_at) return null;

        // Verify entity access
        if (project.entity_id !== EntityContext.entityId) {
          return null;
        }

        return {
          ...project,
          status: this.calculateStatus(project)
        };
      },

      /**
       * Update a project
       * @param {number} projectId
       * @param {Object} updates
       * @returns {Promise<void>}
       */
      async updateProject(projectId, updates) {
        const project = await this.getProject(projectId);
        if (!project) {
          throw new Error('Project not found');
        }

        // Validate dates if both are being set
        const startDate = updates.start_date !== undefined ? updates.start_date : project.start_date;
        const endDate = updates.end_date !== undefined ? updates.end_date : project.end_date;

        if (startDate && endDate && endDate < startDate) {
          throw new Error('End date cannot be before start date');
        }

        // Validate rate_type if changing
        if (updates.rate_type !== undefined) {
          if (!Object.values(RATE_TYPE).includes(updates.rate_type)) {
            throw new Error('Invalid rate type');
          }
        }

        updates.updated_at = new Date().toISOString();

        await db.projects.update(projectId, updates);
        await SyncQueue.queueChange('projects', projectId, 'UPDATE', updates);
      },

      /**
       * Archive (soft delete) project
       * @param {number} projectId
       * @returns {Promise<void>}
       */
      async archiveProject(projectId) {
        return DataManager.softDelete('projects', projectId);
      },

      /**
       * Calculate project status based on dates
       * @param {Object} project
       * @returns {string}
       */
      calculateStatus(project) {
        // Manual override takes precedence
        if (project.status_override) {
          return project.status_override;
        }

        const today = new Date().toISOString().split('T')[0];

        // No start date = upcoming
        if (!project.start_date) {
          return PROJECT_STATUS.UPCOMING;
        }

        // Start date in future = upcoming
        if (project.start_date > today) {
          return PROJECT_STATUS.UPCOMING;
        }

        // No end date or end date in future = active
        if (!project.end_date || project.end_date >= today) {
          return PROJECT_STATUS.ACTIVE;
        }

        // End date in past = completed
        return PROJECT_STATUS.COMPLETED;
      },

      /**
       * Format rate for display
       * @param {Object} project
       * @returns {string}
       */
      formatRate(project) {
        const amount = MoneyUtils.formatEuros(project.rate_cents);
        const suffix = {
          [RATE_TYPE.DAILY]: '/dia',
          [RATE_TYPE.HOURLY]: '/hora',
          [RATE_TYPE.FIXED]: ' (fijo)',
          [RATE_TYPE.MONTHLY_RETAINER]: '/mes'
        }[project.rate_type] || '';

        return amount + suffix;
      },

      /**
       * Count active projects for a client (for list display)
       * @param {number} clientId
       * @returns {Promise<number>}
       */
      async countActiveProjects(clientId) {
        const projects = await this.getActiveProjects(clientId);
        return projects.length;
      }
    };

    // =====================================================
    // Expense Manager - Phase 17
    // CRUD operations for expenses with entity-type-aware
    // deduction calculation. Follows ProjectManager pattern.
    // =====================================================

    /**
     * ExpenseManager - Manages expense CRUD operations with entity scoping
     * and fiscal deduction calculation based on entity type.
     *
     * All monetary values are stored as integer cents (decision [12-01]).
     * Entity scoping via EntityContext ensures data isolation between entities.
     * SyncQueue integration ensures offline-first with eventual cloud sync.
     *
     * Deduction calculation delegates to EXPENSE_CATEGORY rules based on
     * the current entity type (autonomo vs sociedad_limitada).
     */
    const ExpenseManager = {
      /**
       * Create an expense for the current entity
       * @param {Object} expenseData - Expense fields
       * @returns {Promise<number>} - Created expense ID
       */
      async createExpense(expenseData) {
        const entityId = EntityContext.entityId;
        if (!entityId) throw new Error('No entity selected');

        const entity = EntityContext.current;

        // Validate required fields
        if (!expenseData.amount_cents || expenseData.amount_cents <= 0) {
          throw new Error('Amount must be greater than zero');
        }
        if (!expenseData.category || !EXPENSE_CATEGORY[expenseData.category]) {
          throw new Error('Invalid expense category');
        }
        if (!expenseData.date) {
          throw new Error('Expense date is required');
        }

        // Calculate deductible amount based on category rules and entity type
        const deductibleCents = this.calculateDeductible(
          expenseData.amount_cents,
          expenseData.category,
          entity.type,
          {
            business_proportion: expenseData.business_proportion,
            destination: expenseData.destination,
            has_overnight: expenseData.has_overnight
          }
        );

        const normalized = {
          entity_id: entityId,
          category: expenseData.category,
          subcategory: expenseData.subcategory || null,
          vendor: expenseData.vendor?.trim() || null,
          date: expenseData.date,
          amount_cents: expenseData.amount_cents,
          iva_cents: expenseData.iva_cents || 0,
          deductible_amount_cents: deductibleCents,
          description: expenseData.description?.trim() || null,
          is_billable: expenseData.is_billable || false,
          client_id: expenseData.client_id || null,
          project_id: expenseData.project_id || null,
          receipt_id: expenseData.receipt_id || null,
          destination: expenseData.destination || null,
          trip_start_date: expenseData.trip_start_date || null,
          trip_end_date: expenseData.trip_end_date || null,
          has_overnight: expenseData.has_overnight || false,
          payment_method: expenseData.payment_method || null,
          deleted_at: null,
          ...auditFields(true)
        };

        const id = await db.expenses.add(normalized);
        await SyncQueue.queueChange('expenses', id, 'CREATE', normalized);

        return id;
      },

      /**
       * Get all expenses for the current entity with optional filters
       * @param {Object} options - Filter options
       * @param {string} options.category - Filter by category key
       * @param {number} options.client_id - Filter by client ID
       * @param {number} options.project_id - Filter by project ID
       * @param {string} options.date_from - Filter from date (YYYY-MM-DD, inclusive)
       * @param {string} options.date_to - Filter to date (YYYY-MM-DD, inclusive)
       * @param {boolean} options.is_billable - Filter by billable status
       * @returns {Promise<Array>} - Array of expense objects
       */
      async getExpenses(options = {}) {
        const entityId = EntityContext.entityId;
        if (!entityId) return [];

        let expenses = await db.expenses
          .where('entity_id').equals(entityId)
          .filter(e => e.deleted_at === null)
          .toArray();

        // Apply filters
        if (options.category) {
          expenses = expenses.filter(e => e.category === options.category);
        }
        if (options.client_id) {
          expenses = expenses.filter(e => e.client_id === options.client_id);
        }
        if (options.project_id) {
          expenses = expenses.filter(e => e.project_id === options.project_id);
        }
        if (options.date_from) {
          expenses = expenses.filter(e => e.date >= options.date_from);
        }
        if (options.date_to) {
          expenses = expenses.filter(e => e.date <= options.date_to);
        }
        if (options.is_billable !== undefined) {
          expenses = expenses.filter(e => e.is_billable === options.is_billable);
        }

        // Sort by date descending (most recent first)
        expenses.sort((a, b) => b.date.localeCompare(a.date));

        return expenses;
      },

      /**
       * Get a single expense by ID (with entity access check)
       * @param {number} id - Expense ID
       * @returns {Promise<Object|null>} - Expense object or null
       */
      async getExpense(id) {
        const entityId = EntityContext.entityId;
        if (!entityId) return null;

        const expense = await db.expenses.get(id);
        if (!expense || expense.deleted_at) return null;

        // Verify entity access
        if (expense.entity_id !== entityId) {
          return null;
        }

        return expense;
      },

      /**
       * Update an expense by ID
       * Recalculates deductible_amount_cents if amount or category changed
       * @param {number} id - Expense ID
       * @param {Object} changes - Fields to update
       * @returns {Promise<Object>} - Updated expense record
       */
      async updateExpense(id, changes) {
        const expense = await this.getExpense(id);
        if (!expense) {
          throw new Error('Expense not found');
        }

        // Recalculate deductible if amount, category, or metadata changed
        const amountChanged = changes.amount_cents !== undefined && changes.amount_cents !== expense.amount_cents;
        const categoryChanged = changes.category !== undefined && changes.category !== expense.category;
        const metadataChanged = changes.destination !== undefined || changes.has_overnight !== undefined || changes.business_proportion !== undefined;

        if (amountChanged || categoryChanged || metadataChanged) {
          const entity = EntityContext.current;
          const newAmount = changes.amount_cents !== undefined ? changes.amount_cents : expense.amount_cents;
          const newCategory = changes.category !== undefined ? changes.category : expense.category;
          const newDestination = changes.destination !== undefined ? changes.destination : expense.destination;
          const newOvernight = changes.has_overnight !== undefined ? changes.has_overnight : expense.has_overnight;
          const newProportion = changes.business_proportion !== undefined ? changes.business_proportion : expense.business_proportion;

          // Validate category if changed
          if (categoryChanged && !EXPENSE_CATEGORY[newCategory]) {
            throw new Error('Invalid expense category');
          }

          changes.deductible_amount_cents = this.calculateDeductible(
            newAmount,
            newCategory,
            entity.type,
            {
              business_proportion: newProportion,
              destination: newDestination,
              has_overnight: newOvernight
            }
          );
        }

        // Add audit fields
        const updates = {
          ...changes,
          ...auditFields(false)
        };

        await db.expenses.update(id, updates);
        await SyncQueue.queueChange('expenses', id, 'UPDATE', updates);

        // Return updated record
        return await db.expenses.get(id);
      },

      /**
       * Archive (soft delete) an expense
       * EXPENSE-15: If expense has a linked receipt, soft delete preserves both
       * @param {number} id - Expense ID
       * @returns {Promise<boolean>} - Success status
       */
      async archiveExpense(id) {
        const expense = await this.getExpense(id);
        if (!expense) {
          throw new Error('Expense not found');
        }

        return DataManager.softDelete('expenses', id);
      },

      /**
       * Calculate deductible amount based on category rules and entity type
       * @param {number} amountCents - Gross expense amount in cents
       * @param {string} category - EXPENSE_CATEGORY key
       * @param {string} entityType - ENTITY_TYPE value
       * @param {Object} metadata - Additional context for calculation
       * @param {number} metadata.business_proportion - Business use proportion (0-1)
       * @param {string} metadata.destination - Location code ('ES', 'BE', etc.)
       * @param {boolean} metadata.has_overnight - Whether overnight stay
       * @returns {number} - Deductible amount in cents
       */
      calculateDeductible(amountCents, category, entityType, metadata = {}) {
        const rules = EXPENSE_CATEGORY[category]?.rules[entityType];
        if (!rules) return amountCents;

        switch (rules.deduction_method) {
          case 'full':
            return amountCents;

          case 'percentage':
            return MoneyUtils.roundCents(amountCents * (rules.default_percentage / 100));

          case 'proportional': {
            // Use provided proportion (already capped by form) or max_proportion as default
            const proportion = metadata.business_proportion != null
              ? Math.min(metadata.business_proportion, rules.max_proportion)
              : rules.max_proportion;
            return MoneyUtils.roundCents(amountCents * proportion);
          }

          case 'dietas_limit':
            return this.calculateDietasDeductible(amountCents, rules, metadata);

          case 'full_if_justified':
            return amountCents;

          default:
            return amountCents;
        }
      },

      /**
       * Calculate dietas deductible amount with AEAT daily limits
       * Source: AEAT Reglamento IRPF Art. 9 (RD 439/2007)
       *
       * Limits (per day):
       * - Spain without overnight: 26.67 EUR (2667 cents)
       * - Spain with overnight: 53.34 EUR (5334 cents)
       * - Abroad without overnight: 48.08 EUR (4808 cents)
       * - Abroad with overnight: 91.35 EUR (9135 cents)
       *
       * @param {number} amountCents - Expense amount in cents
       * @param {Object} rules - Category rules with limits object
       * @param {Object} metadata - Contains destination and has_overnight
       * @returns {number} - Deductible amount in cents (capped at limit)
       */
      calculateDietasDeductible(amountCents, rules, metadata) {
        const isAbroad = metadata.destination && metadata.destination !== 'ES';
        const hasOvernight = metadata.has_overnight;

        let limitCents;
        if (isAbroad) {
          limitCents = hasOvernight ? rules.limits.abroad_with_overnight : rules.limits.abroad_no_overnight;
        } else {
          limitCents = hasOvernight ? rules.limits.spain_with_overnight : rules.limits.spain_no_overnight;
        }

        return Math.min(amountCents, limitCents);
      },

      /**
       * Get expenses for a specific date (for calendar linking)
       * Uses [entity_id+date] compound index for efficient lookup
       * @param {string} dateKey - Date in YYYY-MM-DD format
       * @returns {Promise<Array>} - Array of expenses for that date
       */
      async getExpensesByDate(dateKey) {
        const entityId = EntityContext.entityId;
        if (!entityId) return [];

        return db.expenses
          .where('[entity_id+date]').equals([entityId, dateKey])
          .filter(e => e.deleted_at === null)
          .toArray();
      },

      /**
       * Get expenses whose trip date range overlaps with the given date range
       * Used by the day editor to show travel expenses spanning multiple days.
       * Returns expenses where trip_start_date <= endDate AND trip_end_date >= startDate.
       * @param {string} startDate - Start date in YYYY-MM-DD format
       * @param {string} endDate - End date in YYYY-MM-DD format
       * @returns {Promise<Array>} - Array of travel expenses with overlapping trip dates
       */
      async getExpensesForDateRange(startDate, endDate) {
        const entityId = EntityContext.entityId;
        if (!entityId) return [];

        try {
          const expenses = await db.expenses
            .where('entity_id').equals(entityId)
            .filter(e =>
              e.deleted_at === null &&
              e.trip_start_date && e.trip_end_date &&
              e.trip_start_date <= endDate &&
              e.trip_end_date >= startDate
            )
            .toArray();

          return expenses;
        } catch (e) {
          DEBUG && console.debug('ExpenseManager.getExpensesForDateRange: error', e);
          return [];
        }
      },

      /**
       * Get expense summary totals for reporting
       * @param {Object} options - Same filter options as getExpenses
       * @param {boolean} options.group_by_category - Include per-category breakdown
       * @returns {Promise<Object>} - Summary with totals and optional category breakdown
       */
      async getExpenseSummary(options = {}) {
        const expenses = await this.getExpenses(options);

        const summary = {
          total_cents: 0,
          deductible_cents: 0,
          count: expenses.length,
          by_category: {}
        };

        for (const expense of expenses) {
          summary.total_cents += expense.amount_cents;
          summary.deductible_cents += expense.deductible_amount_cents;

          if (options.group_by_category) {
            if (!summary.by_category[expense.category]) {
              summary.by_category[expense.category] = {
                total_cents: 0,
                deductible_cents: 0,
                count: 0,
                label: EXPENSE_CATEGORY[expense.category]?.label || expense.category
              };
            }
            summary.by_category[expense.category].total_cents += expense.amount_cents;
            summary.by_category[expense.category].deductible_cents += expense.deductible_amount_cents;
            summary.by_category[expense.category].count += 1;
          }
        }

        return summary;
      }
    };

    // =====================================================
    // Dietas Validation (Phase 17-06, EXPENSE-08)
    // =====================================================

    /**
     * validateDietas - Validate autonomo dietas expense for fiscal compliance
     * Checks AEAT rules: electronic payment, destination, daily limits.
     *
     * Source: AEAT Reglamento IRPF Art. 9 (RD 439/2007)
     * Limits per day:
     *   Spain no overnight: 26.67 EUR (2667 cents)
     *   Spain with overnight: 53.34 EUR (5334 cents)
     *   Abroad no overnight: 48.08 EUR (4808 cents)
     *   Abroad with overnight: 91.35 EUR (9135 cents)
     *
     * @param {Object} expenseData - Expense form data
     * @param {number} expenseData.amount_cents - Amount in cents
     * @param {string} expenseData.payment_method - Payment method
     * @param {string} expenseData.destination - Destination code
     * @param {boolean} expenseData.has_overnight - Overnight stay
     * @param {string} entityType - ENTITY_TYPE value
     * @returns {Object} { valid, warnings, deductible_limit_cents }
     */
    function validateDietas(expenseData, entityType) {
      if (entityType !== ENTITY_TYPE.AUTONOMO) {
        return { valid: true, warnings: [], deductible_limit_cents: null };
      }

      const warnings = [];

      // a. Cash payment: NOT deductible since 2018
      if (expenseData.payment_method === 'cash') {
        warnings.push({
          level: 'error',
          message: 'Dietas paid in cash are NOT deductible since 2018 (Ley 6/2017). Use card, transfer, or Bizum.'
        });
      }

      // b. No destination provided
      if (!expenseData.destination || expenseData.destination.trim() === '') {
        warnings.push({
          level: 'warning',
          message: 'Destination required for dietas deduction. AEAT requires municipality/country of work.'
        });
      }

      // c. Same municipality (home location)
      const dest = (expenseData.destination || '').trim().toUpperCase();
      if (dest === 'HOME' || dest === 'LOCAL') {
        warnings.push({
          level: 'warning',
          message: 'Dietas in your municipality of residence are NOT deductible (Art. 9 RD 439/2007).'
        });
      }

      // d. Daily limit calculation
      const isAbroad = dest && dest !== 'ES' && dest !== '' && dest !== 'HOME' && dest !== 'LOCAL';
      const hasOvernight = expenseData.has_overnight === true;

      let limitCents;
      if (isAbroad) {
        limitCents = hasOvernight ? 9135 : 4808;
      } else {
        limitCents = hasOvernight ? 5334 : 2667;
      }

      const amountCents = expenseData.amount_cents || 0;
      if (amountCents > limitCents) {
        const limitEuros = (limitCents / 100).toFixed(2);
        const overnightLabel = hasOvernight ? 'with overnight' : 'without overnight';
        const locationLabel = isAbroad ? 'abroad' : 'Spain';
        warnings.push({
          level: 'warning',
          message: `Amount exceeds daily dietas limit: ${limitEuros} EUR/day (${locationLabel}, ${overnightLabel}). Only ${limitEuros} EUR is deductible per day.`
        });
      }

      // e. Electronic payment reminder (only if not set)
      if (!expenseData.payment_method) {
        warnings.push({
          level: 'info',
          message: 'Remember: electronic payment required for dietas deduction (card, transfer, Bizum).'
        });
      }

      return {
        valid: warnings.filter(w => w.level === 'error').length === 0,
        warnings,
        deductible_limit_cents: limitCents
      };
    }

    /**
     * _renderDietasWarnings - Render warnings into the form container
     * @param {Array<{level,message}>} warnings
     */
    function _renderDietasWarnings(warnings) {
      const container = document.getElementById('efDietasWarnings');
      if (!container) return;

      if (!warnings || warnings.length === 0) {
        container.innerHTML = '';
        return;
      }

      const icons = { error: '!', warning: '!', info: 'i' };
      container.innerHTML = warnings.map(w => {
        const icon = icons[w.level] || 'i';
        return `<div class="dietas-warning-item level-${w.level}">
          <span class="warning-icon">${icon}</span>
          <span>${_escapeHtml(w.message)}</span>
        </div>`;
      }).join('');
    }

    /**
     * _triggerDietasValidation - Gather form values and run validation
     * Called on input changes within the meals/dietas fields
     */
    function _triggerDietasValidation() {
      const entity = EntityContext.current;
      const entityType = entity?.type || ENTITY_TYPE.AUTONOMO;
      const categoryVal = document.getElementById('efCategory')?.value;

      // Only validate for MEALS_DIETAS category
      if (categoryVal !== 'MEALS_DIETAS') {
        const container = document.getElementById('efDietasWarnings');
        if (container) container.innerHTML = '';
        return;
      }

      const amountStr = document.getElementById('efAmount')?.value || '0';
      const amountEur = parseFloat(amountStr);
      const amountCents = isNaN(amountEur) ? 0 : Math.round(amountEur * 100);

      const destination = document.getElementById('efMealsDestination')?.value?.trim() || '';
      const hasOvernight = !!document.getElementById('efMealsHasOvernight')?.checked;
      const paymentMethod = document.getElementById('efPaymentMethod')?.value || null;

      const result = validateDietas({
        amount_cents: amountCents,
        payment_method: paymentMethod,
        destination: destination,
        has_overnight: hasOvernight
      }, entityType);

      _renderDietasWarnings(result.warnings);

      // Highlight cash payment select with red tint
      const paySelect = document.getElementById('efPaymentMethod');
      if (paySelect) {
        if (paymentMethod === 'cash' && entityType === ENTITY_TYPE.AUTONOMO) {
          paySelect.classList.add('cash-warning-highlight');
        } else {
          paySelect.classList.remove('cash-warning-highlight');
        }
      }
    }

    // =====================================================
    // Receipt Manager (Phase 17)
    // =====================================================

    /**
     * compressImage - Compress an image file for storage
     * Scales down to maxWidth preserving aspect ratio, converts to JPEG.
     * @param {File} file - Image file from input[type=file]
     * @param {number} maxWidth - Maximum width in pixels (default 1024)
     * @param {number} quality - JPEG quality 0-1 (default 0.7)
     * @returns {Promise<Blob>} - Compressed JPEG blob
     */
    function compressImage(file, maxWidth = 1024, quality = 0.7) {
      return new Promise((resolve) => {
        try {
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
              try {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                // Scale down only if image is wider than maxWidth
                if (width > maxWidth) {
                  height = Math.round((height * maxWidth) / width);
                  width = maxWidth;
                }

                canvas.width = width;
                canvas.height = height;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                canvas.toBlob(
                  function(blob) {
                    if (blob) {
                      resolve(blob);
                    } else {
                      // toBlob failed, return original file
                      resolve(file);
                    }
                  },
                  'image/jpeg',
                  quality
                );
              } catch (err) {
                console.warn('compressImage: canvas error, returning original file', err);
                resolve(file);
              }
            };
            img.onerror = function() {
              console.warn('compressImage: image load error, returning original file');
              resolve(file);
            };
            img.src = e.target.result;
          };
          reader.onerror = function() {
            console.warn('compressImage: FileReader error, returning original file');
            resolve(file);
          };
          reader.readAsDataURL(file);
        } catch (err) {
          console.warn('compressImage: unexpected error, returning original file', err);
          resolve(file);
        }
      });
    }

    /**
     * ReceiptManager - Receipt storage, OCR scanning, and CRUD operations
     * Stores compressed receipt images in IndexedDB (db.receipts).
     * Lazy-loads Tesseract.js for OCR only when scanReceipt is called.
     */
    const ReceiptManager = {
      /** @private Cached Tesseract worker instance */
      _worker: null,

      /**
       * _loadScript - Dynamically load a script tag
       * @private
       * @param {string} src - Script URL
       * @returns {Promise<void>}
       */
      _loadScript(src) {
        return new Promise((resolve, reject) => {
          // Check if script already loaded
          const existing = document.querySelector(`script[src="${src}"]`);
          if (existing) {
            resolve();
            return;
          }
          const script = document.createElement('script');
          script.src = src;
          script.async = true;
          script.onload = () => resolve();
          script.onerror = () => reject(new Error(`Failed to load script: ${src}`));
          document.head.appendChild(script);
        });
      },

      /**
       * getWorker - Lazy-load Tesseract.js and create/return a worker
       * @returns {Promise<Object>} - Tesseract worker instance
       */
      async getWorker() {
        if (this._worker) {
          return this._worker;
        }

        // Lazy-load Tesseract.js from CDN if not already present
        if (!window.Tesseract) {
          await this._loadScript('https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js');
        }

        if (!window.Tesseract) {
          throw new Error('Tesseract.js failed to load');
        }

        // Create worker with English + Spanish language support
        this._worker = await Tesseract.createWorker('eng+spa');
        return this._worker;
      },

      /**
       * scanReceipt - Perform OCR on a receipt image
       * @param {File|Blob} imageFile - Image to scan
       * @returns {Promise<Object>} - { vendor, date, amount_euros, raw_text, confidence }
       */
      async scanReceipt(imageFile) {
        const worker = await this.getWorker();
        const result = await worker.recognize(imageFile);
        const parsed = this.parseReceiptText(result.data.text);
        return {
          vendor: parsed.vendor,
          date: parsed.date,
          amount_euros: parsed.amount_euros,
          raw_text: parsed.raw_text,
          confidence: result.data.confidence
        };
      },

      /**
       * parseReceiptText - Extract structured data from OCR text
       * Extracts vendor name, date, and total amount from raw text.
       * @param {string} text - Raw OCR text
       * @returns {Object} - { vendor, date, amount_euros, raw_text }
       */
      parseReceiptText(text) {
        const lines = (text || '').split('\n').map(l => l.trim()).filter(l => l.length > 0);

        // Vendor: first non-empty line
        const vendor = lines.length > 0 ? lines[0] : null;

        // Date: look for DD/MM/YYYY, DD.MM.YYYY, or DD-MM-YYYY patterns
        let date = null;
        const dateRegex = /(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2,4})/;
        for (const line of lines) {
          const match = line.match(dateRegex);
          if (match) {
            const day = match[1].padStart(2, '0');
            const month = match[2].padStart(2, '0');
            let year = match[3];
            // Handle 2-digit year
            if (year.length === 2) {
              const yearNum = parseInt(year, 10);
              year = yearNum >= 70 ? '19' + year : '20' + year;
            }
            // Validate date components
            const dayNum = parseInt(day, 10);
            const monthNum = parseInt(month, 10);
            const yearNum = parseInt(year, 10);
            if (dayNum >= 1 && dayNum <= 31 && monthNum >= 1 && monthNum <= 12 && yearNum >= 1970 && yearNum <= 2099) {
              date = `${year}-${month}-${day}`;
            }
            break;
          }
        }

        // Amount: look for total/importe/amount patterns
        let amount_euros = null;
        const amountRegex = /(?:total|importe|amount|suma|a\s*pagar)[:\s]*[$]?\s*([\d.,]+)/i;
        for (const line of lines) {
          const match = line.match(amountRegex);
          if (match) {
            // Normalize: replace comma with dot for decimal parsing
            // Handle European format: "1.234,56" -> "1234.56"
            let amountStr = match[1];
            if (amountStr.includes(',') && amountStr.includes('.')) {
              // European thousands separator: 1.234,56
              amountStr = amountStr.replace(/\./g, '').replace(',', '.');
            } else if (amountStr.includes(',')) {
              // Simple comma decimal: 12,50
              amountStr = amountStr.replace(',', '.');
            }
            const parsed = parseFloat(amountStr);
            if (!isNaN(parsed) && parsed > 0) {
              amount_euros = parsed;
            }
            break;
          }
        }

        return { vendor, date, amount_euros, raw_text: text };
      },

      /**
       * storeReceipt - Compress and store a receipt image in IndexedDB
       * @param {number} expenseId - Linked expense ID
       * @param {File} file - Original image file
       * @returns {Promise<number>} - Receipt ID
       */
      async storeReceipt(expenseId, file) {
        // Compress image before storage
        const compressed = await compressImage(file);

        // Convert to base64 data URL
        const base64DataUrl = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject(new Error('Failed to read compressed image'));
          reader.readAsDataURL(compressed);
        });

        // Store in IndexedDB
        const receiptId = await db.receipts.add({
          expense_id: expenseId,
          file_name: file.name,
          file_type: 'image/jpeg',
          file_data: base64DataUrl,
          ocr_status: 'pending',
          ocr_confidence: null,
          ocr_extracted: null,
          created_at: new Date().toISOString()
        });

        return receiptId;
      },

      /**
       * getReceipt - Get a receipt by its ID
       * @param {number} receiptId
       * @returns {Promise<Object|undefined>}
       */
      async getReceipt(receiptId) {
        return await db.receipts.get(receiptId);
      },

      /**
       * getReceiptByExpense - Get receipt linked to an expense
       * @param {number} expenseId
       * @returns {Promise<Object|undefined>}
       */
      async getReceiptByExpense(expenseId) {
        return await db.receipts.where('expense_id').equals(expenseId).first();
      },

      /**
       * updateOcrResult - Update receipt with OCR extraction results
       * @param {number} receiptId
       * @param {Object} extracted - Parsed OCR data (vendor, date, amount)
       * @param {number} confidence - OCR confidence score
       * @returns {Promise<number>} - Number of records updated
       */
      async updateOcrResult(receiptId, extracted, confidence) {
        return await db.receipts.update(receiptId, {
          ocr_status: 'completed',
          ocr_confidence: confidence,
          ocr_extracted: JSON.stringify(extracted)
        });
      },

      /**
       * terminateWorker - Clean up the Tesseract worker
       * Call when OCR is no longer needed to free memory.
       */
      async terminateWorker() {
        if (this._worker) {
          await this._worker.terminate();
          this._worker = null;
        }
      }
    };

    // =====================================================
    // Phase 17: Expense Form Dialog Handlers
    // =====================================================

    /** @type {File|null} Cached receipt file for upload on form submit */
    let _pendingReceiptFile = null;
    /** @type {boolean} Prevent double submission */
    let _expenseFormSubmitting = false;

    /**
     * openExpenseFormDialog - Open the expense form for creating or editing an expense
     * @param {number|null} editId - Expense ID to edit (null for create mode)
     */
    async function openExpenseFormDialog(editId = null) {
      const dialog = document.getElementById('expenseFormDialog');
      const form = document.getElementById('expenseForm');
      const titleEl = document.getElementById('expenseFormTitle');
      if (!dialog || !form) return;

      // Reset state
      form.reset();
      dialog.dataset.editId = '';
      _pendingReceiptFile = null;
      _expenseFormSubmitting = false;

      // Set default date to today
      const dateInput = document.getElementById('efDate');
      if (dateInput) {
        dateInput.value = new Date().toISOString().split('T')[0];
      }

      // Reset IVA default
      const ivaInput = document.getElementById('efIva');
      if (ivaInput) ivaInput.value = '0';

      // Reset conditional fields
      _hideAllConditionalFields();

      // Reset OCR status
      const ocrStatus = document.getElementById('efOcrStatus');
      if (ocrStatus) {
        ocrStatus.className = 'ocr-status';
        ocrStatus.innerHTML = '';
      }

      // Hide project and billable by default
      const projectGroup = document.getElementById('efProjectGroup');
      const billableGroup = document.getElementById('efBillableGroup');
      if (projectGroup) projectGroup.style.display = 'none';
      if (billableGroup) billableGroup.style.display = 'none';

      // Populate category select filtered by entity type
      const categorySelect = document.getElementById('efCategory');
      if (categorySelect) {
        const entity = EntityContext.current;
        const entityType = entity?.type || ENTITY_TYPE.AUTONOMO;
        categorySelect.innerHTML = '<option value="">-- Select --</option>';

        for (const [key, cat] of Object.entries(EXPENSE_CATEGORY)) {
          // Filter out sl_only categories when entity is autonomo
          if (cat.sl_only && entityType === ENTITY_TYPE.AUTONOMO) continue;
          const option = document.createElement('option');
          option.value = key;
          option.textContent = cat.label;
          categorySelect.appendChild(option);
        }
      }

      // Populate client select
      const clientSelect = document.getElementById('efClient');
      if (clientSelect) {
        clientSelect.innerHTML = '<option value="">-- None --</option>';
        try {
          const clients = await ClientManager.getClients({});
          for (const client of clients) {
            const option = document.createElement('option');
            option.value = client.id;
            option.textContent = client.name;
            clientSelect.appendChild(option);
          }
        } catch (e) {
          console.warn('Could not load clients for expense form:', e);
        }
      }

      // Edit mode: pre-fill form with existing expense data
      if (editId) {
        try {
          const expense = await ExpenseManager.getExpense(editId);
          if (expense) {
            dialog.dataset.editId = String(editId);
            titleEl.textContent = 'Edit Expense';

            // Pre-fill basic fields
            if (dateInput) dateInput.value = expense.date || '';
            const vendorInput = document.getElementById('efVendor');
            if (vendorInput) vendorInput.value = expense.vendor || '';
            const amountInput = document.getElementById('efAmount');
            if (amountInput) amountInput.value = MoneyUtils.centsToEuros(expense.amount_cents);
            if (ivaInput) ivaInput.value = MoneyUtils.centsToEuros(expense.iva_cents || 0);
            if (categorySelect) {
              categorySelect.value = expense.category || '';
              // Trigger conditional fields
              onExpenseCategoryChange(categorySelect);
            }
            const descInput = document.getElementById('efDescription');
            if (descInput) descInput.value = expense.description || '';

            // Pre-fill subcategory
            const subSelect = document.getElementById('efSubcategory');
            if (subSelect && expense.subcategory) {
              // Delay to let subcategory options populate from onExpenseCategoryChange
              setTimeout(() => { subSelect.value = expense.subcategory || ''; }, 50);
            }

            // Pre-fill travel fields
            const destInput = document.getElementById('efDestination');
            if (destInput) destInput.value = expense.destination || '';
            const tripStartInput = document.getElementById('efTripStartDate');
            if (tripStartInput) tripStartInput.value = expense.trip_start_date || '';
            const tripEndInput = document.getElementById('efTripEndDate');
            if (tripEndInput) tripEndInput.value = expense.trip_end_date || '';
            const overnightCheck = document.getElementById('efHasOvernight');
            if (overnightCheck) overnightCheck.checked = !!expense.has_overnight;

            // Pre-fill meals fields
            const mealsDestInput = document.getElementById('efMealsDestination');
            if (mealsDestInput) mealsDestInput.value = expense.destination || '';
            const mealsOvernightCheck = document.getElementById('efMealsHasOvernight');
            if (mealsOvernightCheck) mealsOvernightCheck.checked = !!expense.has_overnight;
            const payMethodSelect = document.getElementById('efPaymentMethod');
            if (payMethodSelect) payMethodSelect.value = expense.payment_method || 'card';

            // Pre-fill home office deductible %
            const deductPctInput = document.getElementById('efDeductiblePct');
            if (deductPctInput && expense.business_proportion !== undefined) {
              deductPctInput.value = Math.round((expense.business_proportion || 0.30) * 100);
            }

            // Pre-fill client/project/billable
            if (clientSelect && expense.client_id) {
              clientSelect.value = String(expense.client_id);
              await onExpenseClientChange(clientSelect);
              const projectSelect = document.getElementById('efProject');
              if (projectSelect && expense.project_id) {
                setTimeout(() => { projectSelect.value = String(expense.project_id); }, 50);
              }
            }
            const billableCheck = document.getElementById('efBillable');
            if (billableCheck) billableCheck.checked = !!expense.is_billable;
          }
        } catch (e) {
          console.error('Error loading expense for edit:', e);
        }
      } else {
        titleEl.textContent = 'Add Expense';
      }

      dialog.showModal();
    }

    /**
     * closeExpenseFormDialog - Close the expense form dialog and reset state
     */
    function closeExpenseFormDialog() {
      const dialog = document.getElementById('expenseFormDialog');
      if (dialog) {
        dialog.close();
        dialog.dataset.editId = '';
        _pendingReceiptFile = null;
        _expenseFormSubmitting = false;
      }
    }

    /**
     * _hideAllConditionalFields - Hide all conditional field groups
     * @private
     */
    function _hideAllConditionalFields() {
      const travelFields = document.getElementById('efTravelFields');
      const mealsFields = document.getElementById('efMealsFields');
      const homeOfficeFields = document.getElementById('efHomeOfficeFields');
      if (travelFields) travelFields.className = 'conditional-fields';
      if (mealsFields) mealsFields.className = 'conditional-fields';
      if (homeOfficeFields) homeOfficeFields.className = 'conditional-fields';
    }

    /**
     * onExpenseCategoryChange - Show/hide conditional fields based on selected category
     * Also populates subcategory select when category has subcategories
     * @param {HTMLSelectElement} selectElement
     */
    function onExpenseCategoryChange(selectElement) {
      const categoryKey = selectElement.value;
      const categoryConfig = EXPENSE_CATEGORY[categoryKey];

      // Hide all conditional fields first
      _hideAllConditionalFields();

      // Show conditional fields based on category
      if (categoryKey === 'TRAVEL') {
        const travelFields = document.getElementById('efTravelFields');
        if (travelFields) travelFields.className = 'conditional-fields visible';
      } else if (categoryKey === 'MEALS_DIETAS') {
        const mealsFields = document.getElementById('efMealsFields');
        if (mealsFields) mealsFields.className = 'conditional-fields visible';
      } else if (categoryKey === 'HOME_OFFICE') {
        const entity = EntityContext.current;
        const entityType = entity?.type || ENTITY_TYPE.AUTONOMO;
        if (entityType === ENTITY_TYPE.AUTONOMO) {
          const homeOfficeFields = document.getElementById('efHomeOfficeFields');
          if (homeOfficeFields) homeOfficeFields.className = 'conditional-fields visible';
        }
      }

      // Show category-specific deduction hint (Phase 17-05)
      const hintEl = document.getElementById('efCategoryDeductionHint');
      if (hintEl) {
        const hint = _getCategoryDeductionHint(categoryKey);
        if (hint) {
          hintEl.textContent = hint;
          hintEl.style.display = '';
        } else {
          hintEl.style.display = 'none';
          hintEl.textContent = '';
        }
      }

      // Handle subcategory select
      const subcategoryGroup = document.getElementById('efSubcategoryGroup');
      const subcategorySelect = document.getElementById('efSubcategory');
      if (subcategoryGroup && subcategorySelect) {
        if (categoryConfig && categoryConfig.subcategories && categoryConfig.subcategories.length > 0) {
          subcategorySelect.innerHTML = '<option value="">-- None --</option>';
          for (const sub of categoryConfig.subcategories) {
            const option = document.createElement('option');
            option.value = sub;
            // Capitalize and replace underscores with spaces
            option.textContent = sub.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
            subcategorySelect.appendChild(option);
          }
          subcategoryGroup.style.display = '';
        } else {
          subcategoryGroup.style.display = 'none';
          subcategorySelect.innerHTML = '<option value="">-- None --</option>';
        }
      }

      // Phase 17-06: Trigger dietas validation when category changes
      _triggerDietasValidation();
    }

    /**
     * _getCategoryDeductionHint - Get entity-type-aware deduction hint text for a category
     * Shows the deduction rules for the selected category based on the current entity type.
     * @param {string} categoryKey - EXPENSE_CATEGORY key
     * @returns {string|null} - Hint text or null if no hint
     */
    function _getCategoryDeductionHint(categoryKey) {
      if (!categoryKey) return null;

      const entity = EntityContext.current;
      const entityType = entity?.type || ENTITY_TYPE.AUTONOMO;
      const isAutonomo = entityType === ENTITY_TYPE.AUTONOMO;

      switch (categoryKey) {
        case 'HOME_OFFICE':
          return isAutonomo
            ? 'Deduction: max 30% of home expenses (Autonomo). Requires Modelo 036.'
            : 'Deduction: 100% if justified as business space (SL).';
        case 'GSM':
          return isAutonomo
            ? 'Deduction: 50% IRPF + 50% IVA (Autonomo).'
            : 'Deduction: 100% if company line (SL).';
        case 'VEHICLE':
          return isAutonomo
            ? 'Deduction: 0% IRPF, 50% IVA only (Autonomo). Must prove exclusive business use for IRPF.'
            : 'Deduction: 100% if company asset (SL). Mixed use = retribucion en especie.';
        case 'MEALS_DIETAS':
          return isAutonomo
            ? 'Limit: 91.35 EUR/day abroad w/ overnight, 48.08 EUR without. Requires electronic payment.'
            : 'Deduction: 100% if justified (SL). Representation limit 1% of revenue.';
        case 'TRAVEL':
          return 'Deduction: 100% if justified as business travel. Hotel IVA via Modelo 360 (Belgium).';
        case 'IT_SOFTWARE':
          return 'Deduction: 100%. Hardware > 300 EUR may require depreciation (26%/year).';
        case 'OFFICE_SUPPLIES':
          return 'Deduction: 100% deductible.';
        case 'PROFESSIONAL_SERVICES':
          return 'Deduction: 100% deductible (gestor, lawyer, notary).';
        case 'TRAINING':
          return 'Deduction: 100% if related to business activity.';
        case 'DEPRECIATION':
          return isAutonomo
            ? 'Use simplified amortization table (Grupo 1-10). Applied per-asset.'
            : 'Use IS amortization tables (LIS Art. 12). Accelerated for PYME.';
        default:
          return null;
      }
    }

    /**
     * onExpenseClientChange - Load projects for selected client, show billable checkbox
     * @param {HTMLSelectElement} selectElement
     */
    async function onExpenseClientChange(selectElement) {
      const clientId = selectElement.value ? parseInt(selectElement.value, 10) : null;
      const projectGroup = document.getElementById('efProjectGroup');
      const projectSelect = document.getElementById('efProject');
      const billableGroup = document.getElementById('efBillableGroup');

      if (clientId && projectGroup && projectSelect) {
        projectSelect.innerHTML = '<option value="">-- None --</option>';
        try {
          const projects = await ProjectManager.getProjectsByClient(clientId);
          for (const project of projects) {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = project.name;
            projectSelect.appendChild(option);
          }
        } catch (e) {
          console.warn('Could not load projects for expense form:', e);
        }
        projectGroup.style.display = '';
        if (billableGroup) billableGroup.style.display = '';
      } else {
        if (projectGroup) projectGroup.style.display = 'none';
        if (projectSelect) projectSelect.innerHTML = '<option value="">-- None --</option>';
        if (billableGroup) billableGroup.style.display = 'none';
      }
    }

    /**
     * handleReceiptUpload - Process receipt file, trigger OCR, and auto-fill form fields
     * @param {HTMLInputElement} fileInput
     */
    async function handleReceiptUpload(fileInput) {
      const file = fileInput.files?.[0];
      if (!file) return;

      const ocrStatus = document.getElementById('efOcrStatus');
      if (!ocrStatus) return;

      // Store file reference for later storeReceipt() call
      _pendingReceiptFile = file;

      // Show scanning indicator
      ocrStatus.className = 'ocr-status scanning';
      ocrStatus.innerHTML = 'Scanning receipt... (this may take a moment)';

      try {
        const result = await ReceiptManager.scanReceipt(file);

        // Auto-fill fields from OCR result
        if (result.vendor) {
          const vendorInput = document.getElementById('efVendor');
          if (vendorInput && !vendorInput.value) vendorInput.value = result.vendor;
        }
        if (result.date) {
          const dateInput = document.getElementById('efDate');
          if (dateInput) dateInput.value = result.date;
        }
        if (result.amount_euros !== null && result.amount_euros !== undefined) {
          const amountInput = document.getElementById('efAmount');
          if (amountInput && (!amountInput.value || amountInput.value === '0')) {
            amountInput.value = result.amount_euros.toFixed(2);
          }
        }

        // Determine confidence class
        const confidence = result.confidence || 0;
        let confClass = 'low';
        let confLabel = 'Low';
        if (confidence >= 85) {
          confClass = 'high';
          confLabel = 'High';
        } else if (confidence >= 60) {
          confClass = 'medium';
          confLabel = 'Medium';
        }

        // Show success with confidence badge and extracted data
        ocrStatus.className = 'ocr-status success';
        ocrStatus.innerHTML = `
          OCR Complete <span class="ocr-confidence ${confClass}">${confLabel} (${Math.round(confidence)}%)</span>
          <div style="margin-top: 0.25rem; font-size: 0.8rem; opacity: 0.7;">
            ${result.vendor ? 'Vendor: ' + _escapeHtml(result.vendor) : ''}
            ${result.date ? ' | Date: ' + result.date : ''}
            ${result.amount_euros ? ' | Amount: ' + result.amount_euros.toFixed(2) + ' EUR' : ''}
          </div>
          <details class="ocr-raw-text">
            <summary>View raw OCR text</summary>
            <pre>${_escapeHtml(result.raw_text || '')}</pre>
          </details>
        `;
      } catch (err) {
        console.error('OCR error:', err);
        ocrStatus.className = 'ocr-status error';
        ocrStatus.innerHTML = 'OCR failed: ' + _escapeHtml(err.message || 'Unknown error') + '. You can still fill in the fields manually.';
        // Keep the file reference even if OCR fails (receipt image still useful)
      }
    }

    /**
     * _escapeHtml - Escape HTML entities for safe display
     * @param {string} text
     * @returns {string}
     * @private
     */
    function _escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    /**
     * submitExpenseForm - Validate, convert, and save the expense form data
     * Creates or updates an expense in IndexedDB via ExpenseManager
     */
    async function submitExpenseForm() {
      if (_expenseFormSubmitting) return;
      _expenseFormSubmitting = true;

      const dialog = document.getElementById('expenseFormDialog');
      const editId = dialog?.dataset.editId ? parseInt(dialog.dataset.editId, 10) : null;

      try {
        // Gather form values
        const dateVal = document.getElementById('efDate')?.value;
        const vendorVal = document.getElementById('efVendor')?.value?.trim() || null;
        const amountEur = parseFloat(document.getElementById('efAmount')?.value || '0');
        const ivaEur = parseFloat(document.getElementById('efIva')?.value || '0');
        const categoryVal = document.getElementById('efCategory')?.value;
        const subcategoryVal = document.getElementById('efSubcategory')?.value || null;
        const descriptionVal = document.getElementById('efDescription')?.value?.trim() || null;

        // Validate required fields
        if (!dateVal) {
          alert('Please enter a date.');
          _expenseFormSubmitting = false;
          return;
        }
        if (!amountEur || amountEur <= 0) {
          alert('Please enter a valid amount greater than zero.');
          _expenseFormSubmitting = false;
          return;
        }
        if (!categoryVal) {
          alert('Please select a category.');
          _expenseFormSubmitting = false;
          return;
        }

        // Convert EUR to cents
        const amountCents = MoneyUtils.eurosToCents(amountEur);
        const ivaCents = MoneyUtils.eurosToCents(ivaEur);

        // Build expense data
        const expenseData = {
          date: dateVal,
          vendor: vendorVal,
          amount_cents: amountCents,
          iva_cents: ivaCents,
          category: categoryVal,
          subcategory: subcategoryVal,
          description: descriptionVal,
          is_billable: false,
          client_id: null,
          project_id: null,
          destination: null,
          trip_start_date: null,
          trip_end_date: null,
          has_overnight: false,
          payment_method: null,
          business_proportion: null
        };

        // Add conditional fields based on category
        if (categoryVal === 'TRAVEL') {
          expenseData.destination = document.getElementById('efDestination')?.value?.trim() || null;
          expenseData.trip_start_date = document.getElementById('efTripStartDate')?.value || null;
          expenseData.trip_end_date = document.getElementById('efTripEndDate')?.value || null;
          expenseData.has_overnight = !!document.getElementById('efHasOvernight')?.checked;
        } else if (categoryVal === 'MEALS_DIETAS') {
          expenseData.destination = document.getElementById('efMealsDestination')?.value?.trim() || null;
          expenseData.has_overnight = !!document.getElementById('efMealsHasOvernight')?.checked;
          expenseData.payment_method = document.getElementById('efPaymentMethod')?.value || null;
        } else if (categoryVal === 'HOME_OFFICE') {
          const entity = EntityContext.current;
          if (entity?.type === ENTITY_TYPE.AUTONOMO) {
            const pctVal = parseInt(document.getElementById('efDeductiblePct')?.value || '30', 10);
            // Clamp to 0-30 for autonomo
            expenseData.business_proportion = Math.min(Math.max(pctVal, 0), 30) / 100;
          }
        }

        // Client/project/billable
        const clientId = document.getElementById('efClient')?.value;
        if (clientId) {
          expenseData.client_id = parseInt(clientId, 10);
          const projectId = document.getElementById('efProject')?.value;
          if (projectId) {
            expenseData.project_id = parseInt(projectId, 10);
          }
          expenseData.is_billable = !!document.getElementById('efBillable')?.checked;
        }

        // Phase 17-06: Billable validation - client required when billable checked
        if (expenseData.is_billable && !expenseData.client_id) {
          alert('A client must be selected when marking an expense as billable.');
          _expenseFormSubmitting = false;
          return;
        }

        // Phase 17-06: Pre-submit dietas validation (EXPENSE-08)
        if (categoryVal === 'MEALS_DIETAS') {
          const entity = EntityContext.current;
          const entityType = entity?.type || ENTITY_TYPE.AUTONOMO;
          const dietasResult = validateDietas({
            amount_cents: amountCents,
            payment_method: expenseData.payment_method,
            destination: expenseData.destination,
            has_overnight: expenseData.has_overnight
          }, entityType);

          if (dietasResult.warnings.length > 0) {
            const warningMessages = dietasResult.warnings.map(w => {
              const prefix = w.level === 'error' ? '[!] ' : w.level === 'warning' ? '[!] ' : '[i] ';
              return prefix + w.message;
            }).join('\n');

            const proceed = confirm('Dietas warnings:\n\n' + warningMessages + '\n\nSave anyway?');
            if (!proceed) {
              _expenseFormSubmitting = false;
              return;
            }
          }

          // Store warnings as metadata for list display
          expenseData._dietas_warnings = dietasResult.warnings;
        }

        let expenseId;

        if (editId) {
          // Update existing expense
          await ExpenseManager.updateExpense(editId, expenseData);
          expenseId = editId;
        } else {
          // Create new expense
          expenseId = await ExpenseManager.createExpense(expenseData);
        }

        // Store receipt if file was uploaded
        if (_pendingReceiptFile && expenseId) {
          try {
            const receiptId = await ReceiptManager.storeReceipt(expenseId, _pendingReceiptFile);
            // Update expense with receipt_id
            await ExpenseManager.updateExpense(expenseId, { receipt_id: receiptId });
          } catch (receiptErr) {
            console.warn('Receipt storage failed, expense saved without receipt:', receiptErr);
            showToast('Expense saved, but receipt could not be stored.', 'warning');
          }
        }

        // Close dialog
        closeExpenseFormDialog();

        // Refresh expense list
        if (typeof renderExpenseList === 'function') {
          await renderExpenseList();
        }

        DEBUG && console.log(editId ? 'Expense updated:' : 'Expense created:', expenseId);

      } catch (err) {
        console.error('Error saving expense:', err);
        alert('Error saving expense: ' + (err.message || 'Unknown error'));
      } finally {
        _expenseFormSubmitting = false;
      }
    }

    // =====================================================
    // Expense List Rendering (Phase 17-04)
    // =====================================================

    /**
     * formatDateEU - Convert YYYY-MM-DD to DD/MM/YYYY for European display
     * @param {string} dateString - Date in YYYY-MM-DD format
     * @returns {string} Date in DD/MM/YYYY format, or original string if invalid
     */
    function formatDateEU(dateString) {
      if (!dateString || typeof dateString !== 'string') return '';
      const parts = dateString.split('-');
      if (parts.length !== 3) return dateString;
      return `${parts[2]}/${parts[1]}/${parts[0]}`;
    }

    /** Client name cache for expense list rendering (avoids N+1 queries) */
    let _expenseClientNameCache = new Map();
    let _expenseClientCacheEntityId = null;

    /**
     * _loadClientNameCache - Batch-load client names for expense rendering
     * Rebuilds cache when entity changes. Avoids N+1 queries.
     * @returns {Promise<Map<number, string>>}
     */
    async function _loadClientNameCache() {
      const currentEntityId = EntityContext.entityId;
      if (_expenseClientCacheEntityId === currentEntityId && _expenseClientNameCache.size > 0) {
        return _expenseClientNameCache;
      }
      try {
        const clients = await ClientManager.getClients({});
        _expenseClientNameCache = new Map(clients.map(c => [c.id, c.name]));
        _expenseClientCacheEntityId = currentEntityId;
      } catch (err) {
        console.warn('Failed to load client names for expense list:', err);
        _expenseClientNameCache = new Map();
      }
      return _expenseClientNameCache;
    }

    /**
     * populateExpenseFilters - Populate category and client filter selects
     * Called on entity change and on tab activation.
     */
    async function populateExpenseFilters() {
      // Populate category filter
      const categorySelect = document.getElementById('expFilterCategory');
      if (categorySelect) {
        const currentValue = categorySelect.value;
        const entity = EntityContext.current;
        const entityType = entity?.type || ENTITY_TYPE.AUTONOMO;

        // Keep the "All categories" option, replace the rest
        let optionsHtml = '<option value="">All categories</option>';
        for (const [key, config] of Object.entries(EXPENSE_CATEGORY)) {
          // Skip categories that are SL-only for autonomo entities
          if (config.sl_only && entityType === ENTITY_TYPE.AUTONOMO) continue;
          optionsHtml += `<option value="${key}">${_escapeHtml(config.label)}</option>`;
        }
        categorySelect.innerHTML = optionsHtml;
        // Restore selection if still valid
        if (currentValue) {
          categorySelect.value = currentValue;
        }
      }

      // Populate client filter
      const clientSelect = document.getElementById('expFilterClient');
      if (clientSelect) {
        const currentValue = clientSelect.value;
        let optionsHtml = '<option value="">All clients</option>';
        try {
          const clients = await ClientManager.getClients({});
          for (const client of clients) {
            optionsHtml += `<option value="${client.id}">${_escapeHtml(client.name)}</option>`;
          }
        } catch (err) {
          console.warn('Failed to load clients for expense filter:', err);
        }
        clientSelect.innerHTML = optionsHtml;
        if (currentValue) {
          clientSelect.value = currentValue;
        }
      }
    }

    /**
     * renderExpenseList - Full expense list rendering with filters and summary
     * Reads filter values, queries ExpenseManager, renders table + cards + summary.
     * Fulfills EXPENSE-12 (list with all fields) and EXPENSE-13 (filtering).
     */
    async function renderExpenseList() {
      const container = document.getElementById('expenseListContainer');
      if (!container) return;

      const summaryTotal = document.getElementById('expSummaryTotal');
      const summaryDeductible = document.getElementById('expSummaryDeductible');
      const summaryCount = document.getElementById('expSummaryCount');

      try {
        // Build filter options from inputs
        const options = {};

        const dateFrom = document.getElementById('expFilterDateFrom')?.value;
        const dateTo = document.getElementById('expFilterDateTo')?.value;
        const category = document.getElementById('expFilterCategory')?.value;
        const clientId = document.getElementById('expFilterClient')?.value;
        const billable = document.getElementById('expFilterBillable')?.value;

        if (dateFrom) options.date_from = dateFrom;
        if (dateTo) options.date_to = dateTo;
        if (category) options.category = category;
        if (clientId) options.client_id = parseInt(clientId, 10);
        if (billable === 'true') options.is_billable = true;
        else if (billable === 'false') options.is_billable = false;

        // Fetch filtered expenses
        const expenses = await ExpenseManager.getExpenses(options);

        // Check if any filters are active (to differentiate empty states)
        const hasActiveFilters = dateFrom || dateTo || category || clientId || billable;

        // Batch-load client names (avoids N+1 queries)
        const clientNameMap = await _loadClientNameCache();

        // Calculate summary totals
        let totalCents = 0;
        let deductibleCents = 0;
        for (const exp of expenses) {
          totalCents += exp.amount_cents || 0;
          deductibleCents += exp.deductible_amount_cents || 0;
        }

        // Update summary bar
        if (summaryTotal) summaryTotal.textContent = MoneyUtils.formatEuros(totalCents);
        if (summaryDeductible) summaryDeductible.textContent = MoneyUtils.formatEuros(deductibleCents);
        if (summaryCount) {
          summaryCount.textContent = expenses.length.toString();
          // Phase 17-06: Show billable detail when billable filter active
          const billableFilter = document.getElementById('expFilterBillable')?.value;
          if (billableFilter === 'true') {
            const clientIds = new Set(expenses.filter(e => e.client_id).map(e => e.client_id));
            const billableDetailEl = summaryCount.parentElement?.querySelector('.billable-detail');
            if (billableDetailEl) {
              billableDetailEl.textContent = `${expenses.length} expenses for ${clientIds.size} client${clientIds.size !== 1 ? 's' : ''}`;
            } else {
              const detail = document.createElement('div');
              detail.className = 'billable-detail';
              detail.textContent = `${expenses.length} expenses for ${clientIds.size} client${clientIds.size !== 1 ? 's' : ''}`;
              summaryCount.parentElement?.appendChild(detail);
            }
          } else {
            const existingDetail = summaryCount.parentElement?.querySelector('.billable-detail');
            if (existingDetail) existingDetail.remove();
          }
        }

        // Empty state
        if (!expenses || expenses.length === 0) {
          if (hasActiveFilters) {
            container.innerHTML = `
              <div class="expense-list-empty">
                No expenses match the current filters.
                <div class="empty-hint">Try adjusting your date range, category, or client filter.</div>
              </div>`;
          } else {
            container.innerHTML = `
              <div class="expense-list-empty">
                No expenses tracked yet.
                <div class="empty-hint">Click "+ Add Expense" above to record your first expense.</div>
              </div>`;
          }
          return;
        }

        // Build table rows (desktop) and cards (mobile) simultaneously
        let tableRows = '';
        let cards = '';

        for (const exp of expenses) {
          const catConfig = EXPENSE_CATEGORY[exp.category];
          const catLabel = catConfig?.label || exp.category;
          const dateDisplay = formatDateEU(exp.date);
          const amountCents = exp.amount_cents || 0;
          const deductCents = exp.deductible_amount_cents || 0;
          const amountDisplay = MoneyUtils.formatEuros(amountCents);
          const deductDisplay = MoneyUtils.formatEuros(deductCents);
          const vendorDisplay = _escapeHtml(exp.vendor || '');
          const vendorTruncated = vendorDisplay.length > 30
            ? vendorDisplay.substring(0, 30) + '...'
            : vendorDisplay;
          const clientName = exp.client_id ? (_escapeHtml(clientNameMap.get(exp.client_id) || '')) : '';
          const billableBadge = exp.is_billable
            ? '<span class="expense-billable-badge">Billable</span>'
            : '';

          // Phase 17-06: Dietas badges for expense list
          let dietasBadge = '';
          if (exp.category === 'MEALS_DIETAS') {
            const entity = EntityContext.current;
            const entityType = entity?.type || ENTITY_TYPE.AUTONOMO;
            if (entityType === ENTITY_TYPE.AUTONOMO) {
              if (exp.payment_method === 'cash') {
                dietasBadge = '<span class="expense-cash-badge">Cash - Not deductible</span>';
              } else {
                // Quick check for limit exceeded
                const dietasCheck = validateDietas({
                  amount_cents: exp.amount_cents || 0,
                  payment_method: exp.payment_method,
                  destination: exp.destination,
                  has_overnight: exp.has_overnight
                }, entityType);
                const hasWarns = dietasCheck.warnings.filter(w => w.level !== 'info').length > 0;
                if (hasWarns) {
                  const warnTitles = dietasCheck.warnings.filter(w => w.level !== 'info').map(w => w.message).join(' | ');
                  dietasBadge = `<span class="expense-dietas-warn-icon" title="${_escapeHtml(warnTitles)}">!</span>`;
                }
              }
            }
          }

          // Phase 17-06: Receipt icon
          const receiptIcon = exp.receipt_id
            ? `<span class="expense-receipt-icon" title="Has receipt attached" onclick="event.stopPropagation(); openReceiptPreview(${exp.id})">&#128206;</span>`
            : '';

          // Deduction indicator: full (100%), partial, or zero
          let deductIndicator = '';
          let deductClass = 'deduction-full';
          if (amountCents > 0 && deductCents === 0) {
            deductIndicator = '<span class="deduction-zero-badge">Not deductible</span>';
            deductClass = '';
          } else if (amountCents > 0 && deductCents < amountCents) {
            const pct = Math.round((deductCents / amountCents) * 100);
            deductIndicator = `<span class="deduction-pct-badge">${pct}%</span>`;
            deductClass = 'deduction-partial';
          }

          // Table row (desktop)
          tableRows += `
            <tr class="expense-row">
              <td class="col-date">${dateDisplay}</td>
              <td class="col-vendor" title="${vendorDisplay}">${vendorTruncated}${receiptIcon}</td>
              <td><span class="expense-category-badge">${_escapeHtml(catLabel)}</span>${billableBadge}${dietasBadge}</td>
              <td class="col-amount">${amountDisplay}</td>
              <td class="col-deductible ${deductClass}">${deductDisplay}${deductIndicator}</td>
              <td class="col-client">${clientName || '&mdash;'}</td>
              <td class="col-actions">
                <div class="expense-actions">
                  <button type="button" onclick="openExpenseFormDialog(${exp.id})" title="Edit expense">Edit</button>
                  <button type="button" class="archive-btn" onclick="archiveExpenseConfirm(${exp.id})" title="Archive expense">Del</button>
                </div>
              </td>
            </tr>`;

          // Card (mobile)
          cards += `
            <div class="expense-card">
              <div class="expense-card-header">
                <span class="card-vendor" title="${vendorDisplay}">${vendorTruncated || _escapeHtml(catLabel)}</span>
                <span class="card-amount">${amountDisplay}</span>
              </div>
              <div class="expense-card-meta">
                <span>${dateDisplay}</span>
                <span class="expense-category-badge">${_escapeHtml(catLabel)}</span>
                ${billableBadge}${dietasBadge}${receiptIcon}
                ${clientName ? '<span>' + clientName + '</span>' : ''}
              </div>
              <div class="expense-card-footer">
                <span class="card-deductible ${deductClass}">Deductible: ${deductDisplay}${deductIndicator}</span>
                <div class="expense-actions">
                  <button type="button" onclick="openExpenseFormDialog(${exp.id})" title="Edit">Edit</button>
                  <button type="button" class="archive-btn" onclick="archiveExpenseConfirm(${exp.id})" title="Archive">Del</button>
                </div>
              </div>
            </div>`;
        }

        // Build deduction summary by category
        const deductionSummaryHtml = await _buildDeductionSummary(expenses);

        // Render both layouts (CSS handles visibility)
        container.innerHTML = `
          <div class="expense-list-container">
            <table class="expense-list-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Vendor</th>
                  <th>Category</th>
                  <th class="col-amount">Amount</th>
                  <th class="col-deductible">Deductible</th>
                  <th>Client</th>
                  <th class="col-actions">Actions</th>
                </tr>
              </thead>
              <tbody>${tableRows}</tbody>
            </table>
          </div>
          <div class="expense-list-cards">${cards}</div>
          ${deductionSummaryHtml}`;

      } catch (err) {
        console.error('Error rendering expense list:', err);
        container.innerHTML = `<div style="padding: 1rem; color: #fca5a5;">Error loading expenses: ${_escapeHtml(err.message)}</div>`;

        // Reset summary on error
        if (summaryTotal) summaryTotal.textContent = '--';
        if (summaryDeductible) summaryDeductible.textContent = '--';
        if (summaryCount) summaryCount.textContent = '0';
      }
    }

    /**
     * _buildDeductionSummary - Build collapsible deduction summary by category
     * Groups total expenses and deductible amounts by category.
     * @param {Array} expenses - Array of expense objects
     * @returns {string} - HTML string for deduction summary section
     */
    function _buildDeductionSummary(expenses) {
      if (!expenses || expenses.length === 0) return '';

      // Group by category
      const groups = {};
      let grandTotal = 0;
      let grandDeductible = 0;

      for (const exp of expenses) {
        const cat = exp.category || 'OTHER';
        if (!groups[cat]) {
          const catConfig = EXPENSE_CATEGORY[cat];
          groups[cat] = {
            label: catConfig?.label || cat,
            total_cents: 0,
            deductible_cents: 0,
            count: 0
          };
        }
        groups[cat].total_cents += exp.amount_cents || 0;
        groups[cat].deductible_cents += exp.deductible_amount_cents || 0;
        groups[cat].count += 1;
        grandTotal += exp.amount_cents || 0;
        grandDeductible += exp.deductible_amount_cents || 0;
      }

      // Build table rows
      let rows = '';
      for (const [cat, data] of Object.entries(groups).sort((a, b) => b[1].total_cents - a[1].total_cents)) {
        const rate = data.total_cents > 0 ? Math.round((data.deductible_cents / data.total_cents) * 100) : 0;
        const rateLabel = rate === 100 ? '100%' : (rate === 0 ? '0%' : rate + '%');
        rows += `<tr>
          <td>${_escapeHtml(data.label)}</td>
          <td>${MoneyUtils.formatEuros(data.total_cents)}</td>
          <td>${MoneyUtils.formatEuros(data.deductible_cents)}</td>
          <td>${rateLabel}</td>
        </tr>`;
      }

      const grandRate = grandTotal > 0 ? Math.round((grandDeductible / grandTotal) * 100) : 0;
      rows += `<tr class="summary-total-row">
        <td>Total</td>
        <td>${MoneyUtils.formatEuros(grandTotal)}</td>
        <td>${MoneyUtils.formatEuros(grandDeductible)}</td>
        <td>${grandRate}%</td>
      </tr>`;

      return `
        <div class="deduction-summary" id="deductionSummary">
          <div class="deduction-summary-header" onclick="toggleDeductionSummary()">
            <h4>Deduction Summary by Category</h4>
            <span class="toggle-icon">&#9660;</span>
          </div>
          <div class="deduction-summary-body">
            <table class="deduction-summary-table">
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Total</th>
                  <th>Deductible</th>
                  <th>Rate</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        </div>`;
    }

    /**
     * toggleDeductionSummary - Toggle the expanded/collapsed state of the deduction summary
     */
    function toggleDeductionSummary() {
      const el = document.getElementById('deductionSummary');
      if (el) el.classList.toggle('expanded');
    }

    /**
     * archiveExpenseConfirm - Archive (soft delete) an expense with confirmation
     * @param {number} expenseId - Expense ID to archive
     */
    async function archiveExpenseConfirm(expenseId) {
      if (!expenseId) return;

      // Phase 17-06: Receipt-linked deletion protection (EXPENSE-15)
      // Check if expense has a linked receipt and show appropriate message
      let confirmMsg = 'Archive this expense? It can be restored within 30 days.';
      try {
        const expense = await ExpenseManager.getExpense(expenseId);
        if (expense && expense.receipt_id) {
          confirmMsg = 'This expense has a linked receipt. It will be archived (soft deleted) and can be restored within 30 days. The receipt will be preserved.';
        }
      } catch (e) {
        // Continue with default message if lookup fails
      }

      const confirmed = confirm(confirmMsg);
      if (!confirmed) return;

      try {
        // Always soft delete via DataManager.softDelete (never hard delete)
        await ExpenseManager.archiveExpense(expenseId);
        await renderExpenseList();
        DEBUG && console.log('Expense archived:', expenseId);
      } catch (err) {
        console.error('Error archiving expense:', err);
        alert('Error archiving expense: ' + (err.message || 'Unknown error'));
      }
    }

    // =====================================================
    // Phase 17-06: Receipt Preview, Enhanced Archive, Restore
    // =====================================================

    /**
     * openReceiptPreview - Open a mini-modal showing receipt image for an expense
     * Loads receipt data from ReceiptManager.getReceiptByExpense
     * @param {number} expenseId - Expense ID to load receipt for
     */
    async function openReceiptPreview(expenseId) {
      if (!expenseId) return;

      try {
        const receipt = await ReceiptManager.getReceiptByExpense(expenseId);
        if (!receipt || !receipt.file_data) {
          alert('No receipt image found for this expense.');
          return;
        }

        // Create overlay
        const overlay = document.createElement('div');
        overlay.className = 'receipt-preview-overlay';
        overlay.onclick = function(e) {
          if (e.target === overlay) overlay.remove();
        };

        const fileName = _escapeHtml(receipt.file_name || 'Receipt');

        overlay.innerHTML = `
          <div class="receipt-preview-modal">
            <div class="preview-header">
              <h3>${fileName}</h3>
              <button onclick="this.closest('.receipt-preview-overlay').remove()" title="Close">x</button>
            </div>
            <div class="preview-image-container">
              <img src="${receipt.file_data}" alt="Receipt: ${fileName}">
            </div>
            <div class="preview-footer">
              <button onclick="window.open(this.closest('.receipt-preview-modal').querySelector('img').src, '_blank')">View Full Size</button>
              <button onclick="this.closest('.receipt-preview-overlay').remove()">Close</button>
            </div>
          </div>
        `;

        document.body.appendChild(overlay);
      } catch (err) {
        console.error('Error loading receipt preview:', err);
        alert('Error loading receipt: ' + (err.message || 'Unknown error'));
      }
    }

    /**
     * renderArchivedExpenses - Show/hide archived (soft-deleted) expenses
     * Uses DataManager.getDeleted to fetch soft-deleted records.
     * Provides restore button for restorable items.
     */
    async function renderArchivedExpenses(forceShow) {
      const container = document.getElementById('expenseArchivedContainer');
      if (!container) return;

      const isVisible = container.style.display !== 'none';
      if (isVisible && !forceShow) {
        container.style.display = 'none';
        const toggleBtn = document.getElementById('expenseArchivedToggle');
        if (toggleBtn) toggleBtn.textContent = 'Show Archived';
        return;
      }

      try {
        const entityId = EntityContext.entityId;
        if (!entityId) return;

        const deleted = await DataManager.getDeleted('expenses', entityId);

        if (deleted.length === 0) {
          container.innerHTML = '<div class="expense-archived-list"><div style="text-align:center;color:var(--text-muted);padding:0.5rem;">No archived expenses.</div></div>';
        } else {
          let items = '';
          for (const exp of deleted) {
            const dateStr = formatDateEU(exp.date);
            const vendor = _escapeHtml(exp.vendor || 'Unknown');
            const amount = MoneyUtils.formatEuros(exp.amount_cents || 0);
            const daysAgo = exp._daysSinceDeleted;
            const canRestore = exp._canRestore;
            const restoreLabel = canRestore
              ? `Restore (${30 - daysAgo}d left)`
              : 'Expired';

            items += `
              <div class="expense-archived-item">
                <div class="archived-info">
                  <span>${dateStr}</span>
                  <span>${vendor}</span>
                  <span>${amount}</span>
                  <span style="opacity:0.5;">Deleted ${daysAgo}d ago</span>
                </div>
                <button class="restore-btn" ${canRestore ? '' : 'disabled'} onclick="restoreArchivedExpense(${exp.id})">${restoreLabel}</button>
              </div>`;
          }
          container.innerHTML = `<div class="expense-archived-list">${items}</div>`;
        }

        container.style.display = '';
        const toggleBtn = document.getElementById('expenseArchivedToggle');
        if (toggleBtn) toggleBtn.textContent = 'Hide Archived';
      } catch (err) {
        console.error('Error loading archived expenses:', err);
        container.innerHTML = '<div style="color:#fca5a5;padding:0.5rem;">Error loading archived expenses.</div>';
        container.style.display = '';
      }
    }

    /**
     * restoreArchivedExpense - Restore a soft-deleted expense
     * Uses DataManager.restore which checks the 30-day window
     * @param {number} expenseId - Expense ID to restore
     */
    async function restoreArchivedExpense(expenseId) {
      if (!expenseId) return;

      const confirmed = confirm('Restore this expense?');
      if (!confirmed) return;

      try {
        await DataManager.restore('expenses', expenseId);
        // Re-render archived list (force show to keep it visible after restore)
        await renderArchivedExpenses(true);
        // Refresh main expense list to show restored expense
        await renderExpenseList();
        DEBUG && console.log('Expense restored:', expenseId);
      } catch (err) {
        console.error('Error restoring expense:', err);
        alert('Error restoring expense: ' + (err.message || 'Unknown error'));
      }
    }

    /**
     * _initExpenseListListeners - Initialize expense list event listeners
     * Subscribes to EntityContext changes and tab activation.
     */
    function _initExpenseListListeners() {
      // Subscribe to entity changes: re-populate filters and re-render list
      EntityContext.subscribe(async () => {
        // Invalidate client cache on entity change
        _expenseClientCacheEntityId = null;
        _expenseClientNameCache = new Map();

        await populateExpenseFilters();
        await renderExpenseList();
      });

      // Listen for tab-expenses radio change to trigger load on activation
      const tabExpenses = document.getElementById('tab-expenses');
      if (tabExpenses) {
        tabExpenses.addEventListener('change', async () => {
          if (tabExpenses.checked) {
            await populateExpenseFilters();
            await renderExpenseList();
          }
        });
      }
    }

    // =====================================================
    // Client List UI Module
    // =====================================================

    /**
     * Debounce helper for search input
     * @param {Function} fn - Function to debounce
     * @param {number} delay - Delay in milliseconds
     * @returns {Function}
     */
    function debounce(fn, delay) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    /**
     * ClientListUI - Displays client list with search and filters
     * Subscribes to EntityContext for automatic refresh on entity change
     */
    const ClientListUI = {
      container: null,
      emptyState: null,
      searchInput: null,
      countryFilter: null,
      activeFilter: null,

      init() {
        this.container = document.getElementById('client-list');
        this.emptyState = document.getElementById('client-empty-state');
        this.searchInput = document.getElementById('client-search');
        this.countryFilter = document.getElementById('client-country-filter');
        this.activeFilter = document.getElementById('client-active-filter');

        if (!this.container) return;

        // Bind filter events
        if (this.searchInput) {
          this.searchInput.addEventListener('input', debounce(() => this.refresh(), 300));
        }
        if (this.countryFilter) {
          this.countryFilter.addEventListener('change', () => this.refresh());
        }
        if (this.activeFilter) {
          this.activeFilter.addEventListener('change', () => this.refresh());
        }

        // Event delegation for client row clicks (registered once, handles all re-renders)
        this.container.addEventListener('click', (e) => {
          const row = e.target.closest('.client-row');
          if (row) {
            const clientId = parseInt(row.dataset.clientId, 10);
            ClientDetailUI.open(clientId);
          }
        });

        // Add client button
        const addBtn = document.getElementById('add-client-btn');
        if (addBtn) {
          addBtn.addEventListener('click', () => {
            ClientFormUI.openCreate();
          });
        }

        // Subscribe to entity changes
        EntityContext.subscribe(() => this.refresh());
      },

      async refresh() {
        if (!this.container) return;

        const entityId = EntityContext.entityId;
        if (!entityId) {
          this.render([]);
          return;
        }

        const filters = {
          search: this.searchInput?.value || '',
          country_code: this.countryFilter?.value || null
        };

        try {
          const clients = await ClientManager.getClients(filters);

          // Enrich with project counts and invoice data (async)
          const enriched = await Promise.all(clients.map(async (client) => {
            const activeCount = await ProjectManager.countActiveProjects(client.id);

            // Query invoice data for this client
            let totalInvoicedCents = 0;
            let lastInvoiceDate = null;
            try {
              const clientInvoices = await db.invoices
                .where('client_id').equals(client.id)
                .filter(inv => !inv.deleted_at && inv.status !== 'draft')
                .toArray();
              for (const inv of clientInvoices) {
                totalInvoicedCents += inv.total_cents || 0;
              }
              if (clientInvoices.length > 0) {
                // Sort descending by date_issued to get most recent
                clientInvoices.sort((a, b) => (b.date_issued || '').localeCompare(a.date_issued || ''));
                lastInvoiceDate = formatDateEU(clientInvoices[0].date_issued);
              }
            } catch (e) {
              DEBUG && console.debug('ClientListUI: invoice query error for client', client.id, e);
            }

            return {
              ...client,
              _activeProjectCount: activeCount,
              _totalInvoicedCents: totalInvoicedCents,
              _lastInvoiceDate: lastInvoiceDate
            };
          }));

          // Apply active project filter after enrichment
          let filtered = enriched;
          if (this.activeFilter?.checked) {
            filtered = enriched.filter(c => c._activeProjectCount > 0);
          }

          this.render(filtered);
        } catch (err) {
          console.error('Error loading clients:', err);
          this.render([]);
        }
      },

      render(clients) {
        if (clients.length === 0) {
          this.container.innerHTML = '';
          this.emptyState?.classList.remove('hidden');
          return;
        }

        this.emptyState?.classList.add('hidden');

        this.container.innerHTML = clients.map(client => `
          <div class="client-row" data-client-id="${client.id}">
            <span class="client-flag">${getFlagEmoji(client.country_code)}</span>
            <span class="client-name">${escapeHtml(client.name)}</span>
            <span class="client-projects">${client._activeProjectCount} project${client._activeProjectCount !== 1 ? 's' : ''}</span>
            <span class="client-invoiced">${MoneyUtils.formatEuros(client._totalInvoicedCents || 0)}</span>
            <span class="client-last-invoice">${client._lastInvoiceDate || '\u2014'}</span>
          </div>
        `).join('');
      }
    };

    // =====================================================
    // =====================================================
    // Client Form UI Module
    // =====================================================

    /**
     * ClientFormUI - Create/Edit client modal
     * Handles tax ID validation based on country:
     * - Spanish: uses SpanishTaxIdValidator on blur
     * - EU: format validation + VIES button
     * - Third country: stores as-is
     */
    const ClientFormUI = {
      modal: null,
      form: null,
      editingId: null,
      viesValidated: false,

      init() {
        this.modal = document.getElementById('client-modal');
        this.form = document.getElementById('client-form');

        if (!this.form) return;

        // Country change handler
        const countrySelect = document.getElementById('client-country');
        if (countrySelect) {
          countrySelect.addEventListener('change', () => {
            this.updateCountryDependentFields();
            this.clearValidation();
          });
        }

        // Tax ID blur validation
        const taxIdInput = document.getElementById('client-tax-id');
        if (taxIdInput) {
          taxIdInput.addEventListener('blur', () => {
            this.validateTaxId();
          });
        }

        // VIES verify button
        const viesBtn = document.getElementById('vies-verify-btn');
        if (viesBtn) {
          viesBtn.addEventListener('click', () => {
            this.verifyVIES();
          });
        }
      },

      openCreate() {
        this.editingId = null;
        this.viesValidated = false;
        this.form?.reset();
        document.getElementById('client-modal-title').textContent = 'New Client';
        document.getElementById('client-submit-btn').textContent = 'Create Client';
        this.updateCountryDependentFields();
        this.clearValidation();
        this.modal?.classList.remove('hidden');
        document.getElementById('client-name')?.focus();
      },

      async openEdit(clientId) {
        const client = await ClientManager.getClient(clientId);
        if (!client) return;

        this.editingId = clientId;
        this.viesValidated = client.tax_id_validated;

        document.getElementById('client-modal-title').textContent = 'Edit Client';
        document.getElementById('client-submit-btn').textContent = 'Save Changes';

        // Populate form
        document.getElementById('client-name').value = client.name || '';
        document.getElementById('client-country').value = client.country_code || 'ES';
        document.getElementById('client-tax-id').value = client.tax_id || '';
        document.getElementById('client-email').value = client.email || '';
        document.getElementById('client-phone').value = client.phone || '';
        document.getElementById('client-address').value = client.address || '';
        document.getElementById('client-is-b2b').checked = client.is_b2b !== false;
        document.getElementById('client-w8ben').checked = client.w8ben_uploaded;

        this.updateCountryDependentFields();

        if (client.tax_id_validated) {
          this.showValidation('VAT verified with VIES', 'valid');
        }

        this.modal?.classList.remove('hidden');
      },

      close() {
        this.modal?.classList.add('hidden');
        this.editingId = null;
        this.viesValidated = false;
      },

      updateCountryDependentFields() {
        const country = document.getElementById('client-country')?.value;
        const euB2BSection = document.getElementById('eu-b2b-section');
        const w8benSection = document.getElementById('w8ben-section');
        const viesBtn = document.getElementById('vies-verify-btn');

        // Show B2B toggle for EU countries (not Spain)
        const isEU = VIESValidator.isVIESCountry(country) && country !== 'ES';
        euB2BSection?.classList.toggle('hidden', !isEU);

        // Show W-8BEN for US
        w8benSection?.classList.toggle('hidden', country !== 'US');

        // Show VIES button for EU countries (not Spain)
        viesBtn?.classList.toggle('hidden', !isEU);
      },

      validateTaxId() {
        const country = document.getElementById('client-country')?.value;
        const taxId = document.getElementById('client-tax-id')?.value?.trim();

        if (!taxId) {
          this.clearValidation();
          return { valid: true, empty: true };
        }

        if (country === 'ES') {
          // Spanish validation
          const result = SpanishTaxIdValidator.validate(taxId);
          if (result.valid) {
            this.showValidation(`${result.type} valido`, 'valid');
          } else {
            this.showValidation(result.error, 'invalid');
          }
          return result;
        } else if (VIESValidator.isVIESCountry(country)) {
          // EU format validation
          const result = VIESValidator.validateFormat(country, taxId);
          if (result.valid) {
            this.showValidation('Valid format. Verify with VIES to confirm.', 'warning');
            this.viesValidated = false;
          } else {
            this.showValidation(result.error, 'invalid');
          }
          return result;
        }

        // Third country - no validation
        this.clearValidation();
        return { valid: true };
      },

      async verifyVIES() {
        const country = document.getElementById('client-country')?.value;
        const taxId = document.getElementById('client-tax-id')?.value?.trim();

        if (!taxId || !VIESValidator.isVIESCountry(country)) return;

        const viesBtn = document.getElementById('vies-verify-btn');
        viesBtn.disabled = true;
        viesBtn.textContent = 'Verifying...';

        try {
          const result = await VIESValidator.validateWithVIES(country, taxId);

          if (result.valid === true) {
            this.showValidation(`VIES valid: ${result.name || 'Verified'}`, 'valid');
            this.viesValidated = true;
          } else if (result.valid === false) {
            this.showValidation(result.error || 'VAT number not valid in VIES', 'invalid');
            this.viesValidated = false;
          } else if (result.warning) {
            this.showValidation(result.warning, 'warning');
            this.viesValidated = false;
          }
        } catch (err) {
          this.showValidation('Error connecting to VIES', 'warning');
        } finally {
          viesBtn.disabled = false;
          viesBtn.textContent = 'Verify VIES';
        }
      },

      showValidation(message, type) {
        const el = document.getElementById('tax-id-validation');
        if (el) {
          // Add checkmark icon for valid status
          if (type === 'valid') {
            el.innerHTML = `<span style="font-weight: bold;">&#10003;</span> ${escapeHtml(message)}`;
          } else {
            el.textContent = message;
          }
          el.className = `validation-message ${type}`;
        }
      },

      clearValidation() {
        const el = document.getElementById('tax-id-validation');
        if (el) {
          el.textContent = '';
          el.className = 'validation-message';
        }
      },

      async handleSubmit(e) {
        if (e) e.preventDefault();

        const country = document.getElementById('client-country')?.value;
        const taxId = document.getElementById('client-tax-id')?.value?.trim();
        const isB2B = document.getElementById('client-is-b2b')?.checked;
        const name = document.getElementById('client-name')?.value?.trim();

        // Validate required fields
        if (!name) {
          alert('Client name is required');
          return;
        }

        // For EU B2B clients, require VIES validation
        const isEUB2B = VIESValidator.isVIESCountry(country) && country !== 'ES' && isB2B;
        if (isEUB2B && taxId && !this.viesValidated) {
          // Check if format at least valid
          const formatResult = VIESValidator.validateFormat(country, taxId);
          if (!formatResult.valid) {
            alert(formatResult.error);
            return;
          }

          // Warn about VIES
          const proceed = confirm(
            'The VAT number has not been verified with VIES. ' +
            'To apply reverse charge, VIES verification is required. ' +
            'Do you want to continue without verification?'
          );
          if (!proceed) return;
        }

        const clientData = {
          name: name,
          country_code: country,
          tax_id: taxId || null,
          email: document.getElementById('client-email')?.value?.trim() || null,
          phone: document.getElementById('client-phone')?.value?.trim() || null,
          address: document.getElementById('client-address')?.value?.trim() || null,
          is_b2b: isB2B,
          w8ben_uploaded: document.getElementById('client-w8ben')?.checked || false
        };

        try {
          if (this.editingId) {
            await ClientManager.updateClient(this.editingId, clientData);

            // Update VIES validation status
            if (this.viesValidated && VIESValidator.isVIESCountry(country)) {
              await ClientManager.setVIESValidation(this.editingId, {
                valid: true,
                validatedAt: new Date().toISOString()
              });
            }
          } else {
            const id = await ClientManager.createClient(clientData);

            // If VIES validated during creation, update status
            if (this.viesValidated) {
              await ClientManager.setVIESValidation(id, {
                valid: true,
                validatedAt: new Date().toISOString()
              });
            }
          }

          this.close();
          await ClientListUI.refresh();
          // Refresh detail view if open
          if (ClientDetailUI.clientId === this.editingId) {
            await ClientDetailUI.refresh();
          }
        } catch (err) {
          alert(err.message);
        }
      }
    };

    // =====================================================
    // Client Detail UI (Client Detail Page with Tabs)
    // =====================================================

    /**
     * ClientDetailUI - Displays detailed client view with tabs for contacts,
     * projects, invoices, expenses, and calendar
     */
    const ClientDetailUI = {
      clientId: null,
      client: null,
      detailView: null,
      clientsHeader: null,
      clientsFilters: null,
      clientList: null,
      clientEmptyState: null,

      init() {
        this.detailView = document.getElementById('client-detail-view');
        this.clientsHeader = document.querySelector('.panel-clients .clients-header');
        this.clientsFilters = document.querySelector('.panel-clients .clients-filters');
        this.clientList = document.getElementById('client-list');
        this.clientEmptyState = document.getElementById('client-empty-state');

        if (!this.detailView) return;

        // Back button
        document.getElementById('client-back-btn')?.addEventListener('click', () => this.close());

        // Edit button
        document.getElementById('edit-client-btn')?.addEventListener('click', () => {
          if (this.clientId) ClientFormUI.openEdit(this.clientId);
        });

        // Archive button
        document.getElementById('archive-client-btn')?.addEventListener('click', () => {
          this.archiveClient();
        });

        // Tab switching
        this.detailView.querySelectorAll('.detail-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            this.switchTab(tab.dataset.detailTab);
          });
        });

        // Add contact button
        document.getElementById('add-contact-btn')?.addEventListener('click', () => {
          ContactFormUI.openCreate(this.clientId);
        });

        // Add project button
        document.getElementById('add-project-btn')?.addEventListener('click', () => {
          ProjectFormUI.openCreate(this.clientId);
        });
      },

      async open(clientId) {
        this.clientId = clientId;
        this.client = await ClientManager.getClient(clientId);

        if (!this.client) {
          alert('Client not found');
          return;
        }

        // Hide list, show detail
        this.clientsHeader?.classList.add('hidden');
        this.clientsFilters?.classList.add('hidden');
        this.clientList?.classList.add('hidden');
        this.clientEmptyState?.classList.add('hidden');
        this.detailView?.classList.remove('hidden');

        // Render header
        await this.renderHeader();

        // Switch to contacts tab and load
        this.switchTab('contacts');
      },

      close() {
        this.clientId = null;
        this.client = null;

        // Show list, hide detail
        this.detailView?.classList.add('hidden');
        this.clientsHeader?.classList.remove('hidden');
        this.clientsFilters?.classList.remove('hidden');
        this.clientList?.classList.remove('hidden');

        ClientListUI.refresh();
      },

      async renderHeader() {
        const client = this.client;
        if (!client) return;

        document.getElementById('detail-flag').textContent = getFlagEmoji(client.country_code);
        document.getElementById('detail-name').textContent = client.name;
        document.getElementById('detail-tax-id').textContent = client.tax_id || 'No tax ID';

        // Category badge
        const categoryEl = document.getElementById('detail-category');
        const categoryLabels = {
          spain: 'Spain',
          eu_b2b: 'EU B2B',
          eu_b2c: 'EU B2C',
          uk: 'United Kingdom',
          third_country: 'Tercer pais'
        };
        categoryEl.textContent = categoryLabels[client.category] || client.category;

        // VIES status
        const viesEl = document.getElementById('detail-vies-status');
        if (client.tax_id_type === 'eu_vat') {
          viesEl.classList.remove('hidden');
          viesEl.textContent = client.tax_id_validated ? 'VIES OK' : 'VIES pending';
          viesEl.className = `vies-badge ${client.tax_id_validated ? 'valid' : 'invalid'}`;
        } else {
          viesEl.classList.add('hidden');
        }

        // Calculate summary values (placeholders until invoices/expenses exist)
        const totals = await this.calculateTotals(client.id);
        document.getElementById('detail-total-invoiced').textContent = MoneyUtils.formatEuros(totals.invoiced);
        document.getElementById('detail-outstanding').textContent = MoneyUtils.formatEuros(totals.outstanding);
        document.getElementById('detail-profit').textContent = MoneyUtils.formatEuros(totals.profit);

        // Apply permission UI
        if (typeof PermissionUI !== 'undefined' && PermissionUI.applyPermissions) {
          PermissionUI.applyPermissions();
        }
      },

      async calculateTotals(clientId) {
        let invoiced = 0;
        let paid = 0;

        // Query real invoice data (Phase 18 integration)
        try {
          const invoices = await db.invoices
            .where('client_id').equals(clientId)
            .filter(inv => !inv.deleted_at && inv.status !== 'draft')
            .toArray();

          for (const inv of invoices) {
            invoiced += inv.total_cents || 0;
            paid += inv.paid_cents || 0;
          }
        } catch (e) {
          DEBUG && console.debug('calculateTotals: invoice query error', e);
        }

        // Sum billable expenses for this client (Phase 17)
        let expensesTotal = 0;
        try {
          const clientExpenses = await ExpenseManager.getExpenses({ client_id: clientId });
          for (const exp of clientExpenses) {
            expensesTotal += exp.amount_cents || 0;
          }
        } catch (e) {
          DEBUG && console.debug('calculateTotals: expense query error', e);
        }

        return {
          invoiced,
          outstanding: invoiced - paid,
          profit: invoiced - expensesTotal
        };
      },

      switchTab(tabName) {
        // Update tab buttons
        this.detailView.querySelectorAll('.detail-tab').forEach(tab => {
          tab.classList.toggle('active', tab.dataset.detailTab === tabName);
        });

        // Update panels
        this.detailView.querySelectorAll('.detail-panel').forEach(panel => {
          panel.classList.toggle('hidden', !panel.id.includes(tabName));
        });

        // Load content for selected tab
        switch (tabName) {
          case 'contacts':
            this.renderContacts();
            break;
          case 'projects':
            this.renderProjects();
            break;
          case 'invoices':
            this.renderInvoicesTab();
            break;
          case 'expenses':
            this.renderExpensesTab();
            break;
          case 'calendar':
            // Phase 16
            break;
        }
      },

      async renderContacts() {
        if (!this.clientId) return;

        const contacts = await ContactManager.getContacts(this.clientId);
        const container = document.getElementById('contacts-list');
        const emptyState = document.getElementById('contacts-empty');

        if (contacts.length === 0) {
          container.innerHTML = '';
          emptyState?.classList.remove('hidden');
          return;
        }

        emptyState?.classList.add('hidden');

        container.innerHTML = contacts.map(contact => `
          <div class="contact-item ${contact.is_primary ? 'primary' : ''}" data-contact-id="${contact.id}">
            <span class="contact-role">${escapeHtml(CONTACT_ROLE_LABELS[contact.role] || contact.role)}</span>
            <div>
              <div class="contact-name">${escapeHtml(contact.name)}</div>
              <div class="contact-details">
                ${contact.email ? `<a href="mailto:${escapeHtml(contact.email)}">${escapeHtml(contact.email)}</a>` : ''}
                ${contact.email && contact.phone ? ' &middot; ' : ''}
                ${contact.phone ? escapeHtml(contact.phone) : ''}
              </div>
            </div>
            <button class="btn btn-icon" onclick="ContactFormUI.openEdit(${contact.id})" data-permission="edit" title="Edit">&#9998;</button>
            <button class="btn btn-icon btn-danger" onclick="ClientDetailUI.deleteContact(${contact.id})" data-permission="delete" title="Delete">&times;</button>
          </div>
        `).join('');

        if (typeof PermissionUI !== 'undefined' && PermissionUI.applyPermissions) {
          PermissionUI.applyPermissions();
        }
      },

      async renderProjects() {
        if (!this.clientId) return;

        const projects = await ProjectManager.getProjectsByClient(this.clientId);
        const container = document.getElementById('projects-list');
        const emptyState = document.getElementById('projects-empty');

        if (projects.length === 0) {
          container.innerHTML = '';
          emptyState?.classList.remove('hidden');
          return;
        }

        emptyState?.classList.add('hidden');

        container.innerHTML = projects.map(project => `
          <div class="project-item" data-project-id="${project.id}">
            <div class="project-name">${escapeHtml(project.name)}</div>
            <span class="project-rate">${ProjectManager.formatRate(project)}</span>
            <span class="project-dates">
              ${project.start_date || '?'} - ${project.end_date || '?'}
            </span>
            <span class="status-badge ${project.status}">${PROJECT_STATUS_LABELS[project.status]}</span>
            <button class="btn btn-icon" onclick="ProjectFormUI.openEdit(${project.id})" data-permission="edit" title="Edit">&#9998;</button>
          </div>
        `).join('');

        if (typeof PermissionUI !== 'undefined' && PermissionUI.applyPermissions) {
          PermissionUI.applyPermissions();
        }
      },

      /**
       * Render the expenses tab in client detail view
       * Shows billable expenses linked to this client (EXPENSE-09 integration)
       */
      async renderExpensesTab() {
        if (!this.clientId) return;

        const container = document.getElementById('expenses-list');
        if (!container) return;

        try {
          const expenses = await ExpenseManager.getExpenses({ client_id: this.clientId });

          if (!expenses || expenses.length === 0) {
            container.innerHTML = '<p class="coming-soon">No expenses linked to this client yet.</p>';
            return;
          }

          // Calculate summary
          let totalCents = 0;
          let billableCents = 0;
          for (const exp of expenses) {
            totalCents += exp.amount_cents || 0;
            if (exp.is_billable) {
              billableCents += exp.amount_cents || 0;
            }
          }

          // Build summary + list
          let html = `<div class="client-expenses-summary">
            <div><span class="ces-label">Total: </span><span class="ces-value">${MoneyUtils.formatEuros(totalCents)}</span></div>
            <div><span class="ces-label">Billable: </span><span class="ces-value">${MoneyUtils.formatEuros(billableCents)}</span></div>
            <div><span class="ces-label">Count: </span><span class="ces-value">${expenses.length}</span></div>
          </div>`;

          html += '<div class="client-expenses-list">';
          // Show most recent 20 expenses
          const recentExpenses = expenses.slice(0, 20);
          for (const exp of recentExpenses) {
            const catConfig = EXPENSE_CATEGORY[exp.category];
            const catLabel = catConfig?.label || exp.category;
            const vendor = _escapeHtml(exp.vendor || catLabel);
            const amount = MoneyUtils.formatEuros(exp.amount_cents || 0);
            const dateStr = formatDateEU(exp.date);
            const billBadge = exp.is_billable ? '<span class="expense-billable-badge">Billable</span>' : '';

            html += `<div class="client-expense-item">
              <div class="ce-meta">
                <span class="ce-date">${dateStr}</span>
                <span class="ce-vendor" title="${vendor}">${vendor}</span>
                ${billBadge}
              </div>
              <span class="ce-amount">${amount}</span>
            </div>`;
          }

          if (expenses.length > 20) {
            html += `<div style="text-align: center; font-size: 0.78rem; color: var(--text-muted); padding: 0.5rem;">... and ${expenses.length - 20} more</div>`;
          }

          html += '</div>';
          container.innerHTML = html;
        } catch (err) {
          console.error('Error rendering client expenses tab:', err);
          container.innerHTML = '<p class="coming-soon">Error loading expenses.</p>';
        }
      },

      /**
       * Render the invoices tab in client detail view
       * Shows invoices linked to this client (Phase 18 integration)
       */
      async renderInvoicesTab() {
        if (!this.clientId) return;

        const container = document.getElementById('client-invoices-list');
        const emptyState = document.getElementById('client-invoices-empty');
        const countEl = document.getElementById('client-invoices-count');
        if (!container) return;

        try {
          const invoices = await db.invoices
            .where('client_id').equals(this.clientId)
            .filter(inv => !inv.deleted_at)
            .toArray();

          // Sort by date_issued descending
          invoices.sort((a, b) => (b.date_issued || '').localeCompare(a.date_issued || ''));

          if (countEl) {
            countEl.textContent = `${invoices.length} invoice${invoices.length !== 1 ? 's' : ''}`;
          }

          if (invoices.length === 0) {
            container.innerHTML = '';
            if (emptyState) emptyState.classList.remove('hidden');
            return;
          }

          if (emptyState) emptyState.classList.add('hidden');

          let html = '';
          for (const inv of invoices) {
            const invNumber = _escapeHtml(inv.invoice_number || '');
            const dateStr = formatDateEU(inv.date_issued);
            const total = MoneyUtils.formatEuros(inv.total_cents || 0);

            // Status badge
            const isOverdue = inv.status === 'sent' && InvoiceManager.isOverdue(inv);
            let badgeClass = 'badge-draft';
            let badgeText = 'Draft';
            if (inv.status === 'sent') {
              badgeClass = isOverdue ? 'badge-overdue' : 'badge-sent';
              badgeText = isOverdue ? 'Overdue' : 'Sent';
            } else if (inv.status === 'paid') {
              badgeClass = 'badge-paid';
              badgeText = 'Paid';
            } else if (inv.status === 'archived') {
              badgeClass = 'badge-draft';
              badgeText = 'Archived';
            }

            html += `<div class="client-invoice-item" onclick="navigateToInvoiceDetail(${inv.id})" style="cursor: pointer;">
              <div class="ce-meta">
                <span class="ce-date mono">${invNumber}</span>
                <span class="ce-vendor">${dateStr}</span>
                <span class="invoice-status-badge ${badgeClass}" style="font-size: 0.7rem;">${badgeText}</span>
              </div>
              <span class="ce-amount mono">${total}</span>
            </div>`;
          }

          container.innerHTML = html;

          if (typeof PermissionUI !== 'undefined' && PermissionUI.applyPermissions) {
            PermissionUI.applyPermissions();
          }
        } catch (err) {
          console.error('Error rendering client invoices tab:', err);
          container.innerHTML = '<p class="coming-soon">Error loading invoices.</p>';
        }
      },

      async deleteContact(contactId) {
        if (!confirm('Delete this contact?')) return;

        try {
          await ContactManager.deleteContact(contactId);
          await this.renderContacts();
        } catch (err) {
          alert(err.message);
        }
      },

      async archiveClient() {
        if (!confirm('Archive this client? The client will be hidden but their data is preserved.')) return;

        try {
          await ClientManager.archiveClient(this.clientId);
          this.close();
        } catch (err) {
          alert(err.message);
        }
      },

      async refresh() {
        if (this.clientId) {
          this.client = await ClientManager.getClient(this.clientId);
          await this.renderHeader();
          // Refresh current tab
          const activeTab = this.detailView.querySelector('.detail-tab.active')?.dataset.detailTab;
          if (activeTab) this.switchTab(activeTab);
        }
      }
    };

    // =====================================================
    // Contact Form UI Module
    // =====================================================

    /**
     * ContactFormUI - Create/Edit contact modal
     * Handles contact creation and editing for clients
     */
    const ContactFormUI = {
      modal: null,
      form: null,
      editingId: null,

      init() {
        this.modal = document.getElementById('contact-modal');
        this.form = document.getElementById('contact-form');

        // Form submission via button (form doesn't have submit event since button is outside)
        document.getElementById('contact-submit-btn')?.addEventListener('click', (e) => this.handleSubmit(e));
      },

      openCreate(clientId) {
        this.editingId = null;
        this.form?.reset();
        document.getElementById('contact-client-id').value = clientId;
        document.getElementById('contact-modal-title').textContent = 'New Contact';
        document.getElementById('contact-submit-btn').textContent = 'Create';
        this.modal?.classList.remove('hidden');
        document.getElementById('contact-name')?.focus();
      },

      async openEdit(contactId) {
        const contact = await db.contacts.get(contactId);
        if (!contact) return;

        this.editingId = contactId;
        document.getElementById('contact-client-id').value = contact.client_id;
        document.getElementById('contact-modal-title').textContent = 'Edit Contact';
        document.getElementById('contact-submit-btn').textContent = 'Save';

        document.getElementById('contact-name').value = contact.name || '';
        document.getElementById('contact-email').value = contact.email || '';
        document.getElementById('contact-phone').value = contact.phone || '';
        document.getElementById('contact-role').value = contact.role || 'general';
        document.getElementById('contact-primary').checked = contact.is_primary || false;

        this.modal?.classList.remove('hidden');
        document.getElementById('contact-name')?.focus();
      },

      close() {
        this.modal?.classList.add('hidden');
        this.editingId = null;
      },

      async handleSubmit(e) {
        if (e) e.preventDefault();

        const clientId = parseInt(document.getElementById('contact-client-id').value, 10);
        const name = document.getElementById('contact-name')?.value?.trim();

        if (!name) {
          alert('Contact name is required');
          return;
        }

        const contactData = {
          name: name,
          email: document.getElementById('contact-email')?.value?.trim() || null,
          phone: document.getElementById('contact-phone')?.value?.trim() || null,
          role: document.getElementById('contact-role')?.value || 'general',
          is_primary: document.getElementById('contact-primary')?.checked || false
        };

        try {
          if (this.editingId) {
            await ContactManager.updateContact(this.editingId, contactData);
          } else {
            await ContactManager.createContact(clientId, contactData);
          }

          this.close();
          await ClientDetailUI.renderContacts();
        } catch (err) {
          alert(err.message);
        }
      }
    };

    // =====================================================
    // Project Form UI Module
    // =====================================================

    /**
     * ProjectFormUI - Create/Edit project modal
     * Handles project creation and editing for clients
     */
    const ProjectFormUI = {
      modal: null,
      form: null,
      editingId: null,

      init() {
        this.modal = document.getElementById('project-modal');
        this.form = document.getElementById('project-form');

        // Form submission via button
        document.getElementById('project-submit-btn')?.addEventListener('click', (e) => this.handleSubmit(e));

        // Phase 16-03: Toggle work pattern fields visibility
        document.getElementById('projectPatternActive')?.addEventListener('change', function() {
          document.getElementById('projectPatternFields').style.display = this.checked ? 'block' : 'none';
        });
      },

      /**
       * Reset work pattern form fields to default state
       */
      resetPatternFields() {
        const activeCheckbox = document.getElementById('projectPatternActive');
        const fieldsContainer = document.getElementById('projectPatternFields');

        if (activeCheckbox) activeCheckbox.checked = false;
        if (fieldsContainer) fieldsContainer.style.display = 'none';

        // Uncheck all day checkboxes
        document.querySelectorAll('input[name="patternDay"]').forEach(cb => cb.checked = false);
        document.querySelectorAll('input[name="patternFirstWeek"]').forEach(cb => cb.checked = false);

        // Reset location to default
        const locationSelect = document.getElementById('projectPatternLocation');
        if (locationSelect) locationSelect.value = 'belgium';
      },

      /**
       * Populate work pattern fields from project data
       * @param {Object} project - Project with work_pattern field
       */
      populatePatternFields(project) {
        this.resetPatternFields();

        const pattern = project?.work_pattern;
        if (!pattern) return;

        const activeCheckbox = document.getElementById('projectPatternActive');
        const fieldsContainer = document.getElementById('projectPatternFields');

        if (pattern.active) {
          if (activeCheckbox) activeCheckbox.checked = true;
          if (fieldsContainer) fieldsContainer.style.display = 'block';

          // Check pattern days
          if (pattern.days && Array.isArray(pattern.days)) {
            pattern.days.forEach(day => {
              const cb = document.querySelector(`input[name="patternDay"][value="${day}"]`);
              if (cb) cb.checked = true;
            });
          }

          // Check first week extra days
          if (pattern.first_week_extra && Array.isArray(pattern.first_week_extra)) {
            pattern.first_week_extra.forEach(day => {
              const cb = document.querySelector(`input[name="patternFirstWeek"][value="${day}"]`);
              if (cb) cb.checked = true;
            });
          }

          // Set location
          const locationSelect = document.getElementById('projectPatternLocation');
          if (locationSelect && pattern.location) {
            locationSelect.value = pattern.location;
          }
        }
      },

      /**
       * Collect work pattern data from form fields
       * @returns {Object|null} Pattern object or null if not active
       */
      collectPatternData() {
        const activeCheckbox = document.getElementById('projectPatternActive');
        const isActive = activeCheckbox?.checked || false;

        // Collect selected days
        const days = [];
        document.querySelectorAll('input[name="patternDay"]:checked').forEach(cb => {
          days.push(parseInt(cb.value, 10));
        });

        // Collect first week extra days
        const firstWeekExtra = [];
        document.querySelectorAll('input[name="patternFirstWeek"]:checked').forEach(cb => {
          firstWeekExtra.push(parseInt(cb.value, 10));
        });

        // Get location
        const locationSelect = document.getElementById('projectPatternLocation');
        const location = locationSelect?.value || 'belgium';

        return {
          type: WORK_PATTERN_TYPE.WEEKLY,
          days: days,
          first_week_extra: firstWeekExtra,
          location: location,
          active: isActive
        };
      },

      openCreate(clientId) {
        this.editingId = null;
        this.form?.reset();
        this.resetPatternFields();
        document.getElementById('project-client-id').value = clientId;
        document.getElementById('project-modal-title').textContent = 'New Project';
        document.getElementById('project-submit-btn').textContent = 'Create';
        this.modal?.classList.remove('hidden');
        document.getElementById('project-name')?.focus();
      },

      async openEdit(projectId) {
        const project = await ProjectManager.getProject(projectId);
        if (!project) return;

        this.editingId = projectId;
        document.getElementById('project-client-id').value = project.client_id;
        document.getElementById('project-modal-title').textContent = 'Edit Project';
        document.getElementById('project-submit-btn').textContent = 'Save';

        document.getElementById('project-name').value = project.name || '';
        document.getElementById('project-rate-type').value = project.rate_type || 'daily';
        document.getElementById('project-rate').value = project.rate_cents ? (project.rate_cents / 100).toFixed(2) : '';
        document.getElementById('project-start').value = project.start_date || '';
        document.getElementById('project-end').value = project.end_date || '';
        document.getElementById('project-status-override').value = project.status_override || '';
        document.getElementById('project-notes').value = project.notes || '';

        // Phase 16-03: Populate work pattern fields
        this.populatePatternFields(project);

        this.modal?.classList.remove('hidden');
        document.getElementById('project-name')?.focus();
      },

      close() {
        this.modal?.classList.add('hidden');
        this.editingId = null;
      },

      async handleSubmit(e) {
        if (e) e.preventDefault();

        const clientId = parseInt(document.getElementById('project-client-id').value, 10);
        const name = document.getElementById('project-name')?.value?.trim();

        if (!name) {
          alert('Project name is required');
          return;
        }

        const rateValue = document.getElementById('project-rate')?.value;

        // Phase 16-03: Collect work pattern data
        const workPattern = this.collectPatternData();

        const projectData = {
          name: name,
          rate_type: document.getElementById('project-rate-type')?.value || 'daily',
          rate_cents: rateValue ? MoneyUtils.eurosToCents(parseFloat(rateValue)) : 0,
          start_date: document.getElementById('project-start')?.value || null,
          end_date: document.getElementById('project-end')?.value || null,
          status_override: document.getElementById('project-status-override')?.value || null,
          notes: document.getElementById('project-notes')?.value?.trim() || null,
          work_pattern: workPattern
        };

        try {
          if (this.editingId) {
            await ProjectManager.updateProject(this.editingId, projectData);
          } else {
            await ProjectManager.createProject(clientId, projectData);
          }

          this.close();
          await ClientDetailUI.renderProjects();
        } catch (err) {
          alert(err.message);
        }
      }
    };

    // =====================================================
    // Entity Context (Current Entity State Management)
    // =====================================================

    const EntityContext = (() => {
      let currentEntity = null;
      const observers = new Set();

      return {
        // Get current entity object
        get current() {
          return currentEntity;
        },

        // Get current entity ID (convenience)
        get entityId() {
          return currentEntity?.id ?? null;
        },

        // Set current entity and notify observers
        async setEntity(entityId) {
          DEBUG && console.log('[EntityContext] setEntity called with:', entityId);

          // Skip if already selected
          if (entityId === currentEntity?.id) {
            DEBUG && console.log('[EntityContext] Already selected, skipping');
            return;
          }

          // Fetch entity from database
          const entity = await db.entities.get(entityId);
          DEBUG && console.log('[EntityContext] Fetched entity:', entity);

          if (!entity) {
            throw new Error(`Entity ${entityId} not found`);
          }
          if (entity.deleted_at) {
            throw new Error(`Entity ${entityId} is deleted`);
          }
          if (!entity.is_active) {
            DEBUG && console.log('[EntityContext] Entity is_active:', entity.is_active);
            throw new Error(`Entity ${entityId} is archived`);
          }

          currentEntity = entity;
          DEBUG && console.log('[EntityContext] Set currentEntity to:', currentEntity.name);

          // Persist selection to settings
          await db.settings.put({
            key: 'current_entity_id',
            value: entityId,
            updated_at: new Date().toISOString()
          });

          // Notify all observers
          DEBUG && console.log('[EntityContext] Notifying', observers.size, 'observers');
          this.notify();
        },

        // Clear entity (logout/no entity state)
        clear() {
          currentEntity = null;
          this.notify();
        },

        // Subscribe to entity changes
        subscribe(callback) {
          observers.add(callback);
          // Return unsubscribe function
          return () => observers.delete(callback);
        },

        // Notify all observers of entity change
        notify() {
          observers.forEach(callback => {
            try {
              callback(currentEntity);
            } catch (error) {
              console.error('EntityContext observer error:', error);
            }
          });
        },

        // Initialize from persisted selection (call on app startup)
        async initialize() {
          try {
            const setting = await db.settings.get('current_entity_id');
            if (setting?.value) {
              await this.setEntity(setting.value);
              return true;
            }
          } catch (error) {
            console.warn('Could not restore entity selection:', error);
          }
          return false;
        },

        // Get count of observers (for debugging)
        get observerCount() {
          return observers.size;
        }
      };
    })();

    // =====================================================
    // PHASE 16: Calendar Manager (IndexedDB CRUD Operations)
    // =====================================================

    /**
     * LOCATION_TYPE - Replaces DAY_STATUS for Phase 16 calendar
     * Defines possible location values for calendar days
     */
    const LOCATION_TYPE = Object.freeze({
      BELGIUM: 'belgium',
      SPAIN: 'spain',
      TRAVEL: 'travel',
      OTHER: 'other',
      UNSET: 'unset'  // Keep for v1 compatibility during migration
    });

    /**
     * CalendarManager - IndexedDB CRUD operations for calendar days
     * All methods are entity-scoped via EntityContext.entityId
     *
     * Schema: calendar_days table with compound index [entity_id+date]
     * Fields: id, entity_id, date, location, client_id, project_id, notes, created_at, updated_at
     */
    const CalendarManager = {
      /**
       * Get single day by ISO date key for current entity
       * @param {string} dateKey - ISO date string (YYYY-MM-DD)
       * @returns {Promise<Object|undefined>} Day record or undefined
       */
      async getDay(dateKey) {
        const entityId = EntityContext.entityId;
        if (!entityId) {
          console.warn('CalendarManager.getDay: No entity selected');
          return undefined;
        }

        return await db.calendar_days
          .where('[entity_id+date]')
          .equals([entityId, dateKey])
          .first();
      },

      /**
       * Upsert day record with location, client_id, project_id, notes
       * @param {string} dateKey - ISO date string (YYYY-MM-DD)
       * @param {Object} data - Day data { location, client_id?, project_id?, notes? }
       * @returns {Promise<number>} Record ID (new or existing)
       */
      async saveDay(dateKey, data) {
        const entityId = EntityContext.entityId;
        if (!entityId) {
          throw new Error('CalendarManager.saveDay: No entity selected');
        }

        const now = new Date().toISOString();
        const existing = await this.getDay(dateKey);

        if (existing) {
          // Update existing record
          await db.calendar_days.update(existing.id, {
            location: data.location ?? existing.location,
            client_id: data.client_id !== undefined ? data.client_id : existing.client_id,
            project_id: data.project_id !== undefined ? data.project_id : existing.project_id,
            notes: data.notes !== undefined ? data.notes : existing.notes,
            updated_at: now
          });
          return existing.id;
        } else {
          // Create new record
          return await db.calendar_days.add({
            entity_id: entityId,
            date: dateKey,
            location: data.location || null,
            client_id: data.client_id || null,
            project_id: data.project_id || null,
            notes: data.notes || null,
            created_at: now,
            updated_at: now
          });
        }
      },

      /**
       * Get all days for a month (0-indexed month)
       * @param {number} year - Year (e.g., 2026)
       * @param {number} month - Month (0-indexed, 0=January)
       * @returns {Promise<Array>} Array of day records
       */
      async getDaysForMonth(year, month) {
        const entityId = EntityContext.entityId;
        if (!entityId) {
          console.warn('CalendarManager.getDaysForMonth: No entity selected');
          return [];
        }

        // Build start and end date keys for the month
        const monthStr = String(month + 1).padStart(2, '0');
        const startKey = `${year}-${monthStr}-01`;
        const lastDay = new Date(year, month + 1, 0).getDate();
        const endKey = `${year}-${monthStr}-${String(lastDay).padStart(2, '0')}`;

        return await db.calendar_days
          .where('entity_id').equals(entityId)
          .filter(day => day.date >= startKey && day.date <= endKey)
          .toArray();
      },

      /**
       * Get all days for a year (for 183-day calculation)
       * @param {number} year - Year (e.g., 2026)
       * @returns {Promise<Array>} Array of day records
       */
      async getDaysForYear(year) {
        const entityId = EntityContext.entityId;
        if (!entityId) {
          console.warn('CalendarManager.getDaysForYear: No entity selected');
          return [];
        }

        const startKey = `${year}-01-01`;
        const endKey = `${year}-12-31`;

        return await db.calendar_days
          .where('entity_id').equals(entityId)
          .filter(day => day.date >= startKey && day.date <= endKey)
          .toArray();
      },

      /**
       * Get days between two ISO date keys (inclusive)
       * @param {string} startDate - Start date (YYYY-MM-DD)
       * @param {string} endDate - End date (YYYY-MM-DD)
       * @returns {Promise<Array>} Array of day records
       */
      async getDaysInRange(startDate, endDate) {
        const entityId = EntityContext.entityId;
        if (!entityId) {
          console.warn('CalendarManager.getDaysInRange: No entity selected');
          return [];
        }

        return await db.calendar_days
          .where('entity_id').equals(entityId)
          .filter(day => day.date >= startDate && day.date <= endDate)
          .toArray();
      },

      /**
       * Bulk delete days by date keys
       * @param {Array<string>} dateKeys - Array of ISO date strings
       * @returns {Promise<number>} Number of deleted records
       */
      async deleteDays(dateKeys) {
        const entityId = EntityContext.entityId;
        if (!entityId) {
          throw new Error('CalendarManager.deleteDays: No entity selected');
        }

        if (!dateKeys || dateKeys.length === 0) {
          return 0;
        }

        // Get IDs of records to delete
        const records = await db.calendar_days
          .where('entity_id').equals(entityId)
          .filter(day => dateKeys.includes(day.date))
          .toArray();

        const ids = records.map(r => r.id);
        if (ids.length > 0) {
          await db.calendar_days.bulkDelete(ids);
        }

        return ids.length;
      },

      /**
       * Get count of expenses linked to a calendar day
       * Queries db.expenses by entity_id and date
       * @param {string} dateKey - ISO date string (YYYY-MM-DD)
       * @returns {Promise<number>} Number of linked expenses (0 until Phase 17 populates expenses table)
       */
      async getLinkedExpenseCount(dateKey) {
        const entityId = EntityContext.entityId;
        if (!entityId) return 0;

        try {
          // Check if expenses table has the required index
          const count = await db.expenses
            .where('[entity_id+date]')
            .equals([entityId, dateKey])
            .filter(e => e.deleted_at === null)
            .count();
          return count;
        } catch (e) {
          // Table may not have index or expenses feature not ready
          // Fallback: try without compound index
          try {
            const count = await db.expenses
              .where('entity_id').equals(entityId)
              .filter(exp => exp.date === dateKey && exp.deleted_at === null)
              .count();
            return count;
          } catch (e2) {
            // Expenses table doesn't exist yet or has no data
            return 0;
          }
        }
      },

      /**
       * Get expense counts for multiple days in batch (efficient for month rendering)
       * @param {string[]} dateKeys - Array of ISO date strings (YYYY-MM-DD)
       * @returns {Promise<Object>} Map of dateKey -> count
       */
      async getLinkedExpenseCounts(dateKeys) {
        const entityId = EntityContext.entityId;
        const counts = {};

        // Initialize all to 0
        dateKeys.forEach(key => counts[key] = 0);

        if (!entityId || !dateKeys || dateKeys.length === 0) {
          return counts;
        }

        try {
          // Try to get all expenses for this entity matching any of the dates
          const expenses = await db.expenses
            .where('entity_id').equals(entityId)
            .filter(e => e.deleted_at === null && dateKeys.includes(e.date))
            .toArray();

          // Count by date
          expenses.forEach(e => {
            if (counts[e.date] !== undefined) {
              counts[e.date]++;
            }
          });
        } catch (e) {
          // Expenses table doesn't exist yet - return all zeros
          DEBUG && console.debug('CalendarManager.getLinkedExpenseCounts: expenses table not ready');
        }

        return counts;
      },

      /**
       * Get statistics for Belgium days in a year (for 183-day rule)
       * @param {number} year - Year (e.g., 2026)
       * @returns {Promise<Object>} Statistics { total, belgium, spain, travel, other }
       */
      async getYearStatistics(year) {
        const days = await this.getDaysForYear(year);

        const stats = {
          total: days.length,
          belgium: 0,
          spain: 0,
          travel: 0,
          other: 0
        };

        for (const day of days) {
          switch (day.location) {
            case LOCATION_TYPE.BELGIUM:
              stats.belgium++;
              break;
            case LOCATION_TYPE.SPAIN:
              stats.spain++;
              break;
            case LOCATION_TYPE.TRAVEL:
              stats.travel++;
              break;
            case LOCATION_TYPE.OTHER:
              stats.other++;
              break;
          }
        }

        return stats;
      }
    };

    /**
     * Migrate localStorage calendar data to IndexedDB
     * Runs once per entity on first access
     *
     * v1 localStorage format: { version: 1, days: { "YYYY-MM-DD": { status: "belgium", contracted: true } } }
     * v2 IndexedDB format: { entity_id, date, location, client_id, project_id, notes, created_at, updated_at }
     */
    async function migrateCalendarToIndexedDB() {
      const entityId = EntityContext.entityId;
      if (!entityId) {
        DEBUG && console.log('Calendar migration: No entity selected, skipping');
        return;
      }

      // Check if already migrated for this entity
      const migrationKey = `calendar_migrated_v2_entity_${entityId}`;
      if (localStorage.getItem(migrationKey)) {
        DEBUG && console.log(`Calendar migration: Already migrated for entity ${entityId}`);
        return;
      }

      try {
        // Read v1 calendar data from localStorage
        const stored = localStorage.getItem(CALENDAR_STORAGE_KEY);
        if (!stored) {
          // No v1 data to migrate - mark as complete
          localStorage.setItem(migrationKey, new Date().toISOString());
          DEBUG && console.log('Calendar migration: No v1 data found, marking complete');
          return;
        }

        const parsed = JSON.parse(stored);
        if (!parsed || !parsed.days || typeof parsed.days !== 'object') {
          localStorage.setItem(migrationKey, new Date().toISOString());
          DEBUG && console.log('Calendar migration: Invalid v1 format, marking complete');
          return;
        }

        // Migrate each day
        const now = new Date().toISOString();
        const records = [];

        for (const [dateKey, dayData] of Object.entries(parsed.days)) {
          // Skip if no meaningful data
          if (!dayData || dayData.status === 'unset' && !dayData.contracted) {
            continue;
          }

          records.push({
            entity_id: entityId,
            date: dateKey,
            location: dayData.status === 'unset' ? null : dayData.status,
            client_id: null,  // v1 had no client data
            project_id: null,
            notes: dayData.contracted ? 'Contracted day (migrated from v1)' : null,
            created_at: now,
            updated_at: now
          });
        }

        // Bulk insert into IndexedDB
        if (records.length > 0) {
          await db.calendar_days.bulkPut(records);
        }

        // Mark migration complete for this entity
        localStorage.setItem(migrationKey, new Date().toISOString());
        DEBUG && console.log(`Calendar migration complete: ${records.length} days migrated for entity ${entityId}`);

      } catch (error) {
        console.warn('Calendar migration failed (non-blocking):', error.message);
        // Don't mark as complete - will retry on next load
      }
    }

    // =====================================================
    // PHASE 16-03: Work Pattern Manager
    // =====================================================

    /**
     * WORK_PATTERN_TYPE - Types of recurring work patterns
     */
    const WORK_PATTERN_TYPE = Object.freeze({
      WEEKLY: 'weekly',       // Same days every week
      FIRST_WEEK: 'first_week', // Extra days in first week of month
      CUSTOM: 'custom'        // User-defined pattern
    });

    /**
     * DEFAULT_WORK_PATTERN - Default pattern structure for projects
     */
    const DEFAULT_WORK_PATTERN = {
      type: 'weekly',
      days: [],              // Array of day numbers (1=Mon, 2=Tue, ..., 7=Sun)
      first_week_extra: [],  // Extra days for first week of month
      location: 'belgium',   // Default location for pattern days
      active: false          // Must be explicitly activated
    };

    /**
     * WorkPatternManager - Work pattern validation, storage, and application
     * Allows users to define recurring schedules on projects and auto-apply to calendar
     */
    const WorkPatternManager = {
      /**
       * Check if a date matches the pattern criteria
       * @param {Date} date - JavaScript Date object
       * @param {Object} pattern - Pattern object with days and first_week_extra arrays
       * @returns {boolean} True if date matches pattern
       */
      matchesPattern(date, pattern) {
        const dayOfWeek = date.getDay();
        // Convert JS day (0=Sun) to ISO day (1=Mon, 7=Sun)
        const isoDay = dayOfWeek === 0 ? 7 : dayOfWeek;

        // Check regular weekly days
        if (pattern.days && pattern.days.includes(isoDay)) return true;

        // Check first-week extra days (date <= 7 means first 7 days of month)
        if (date.getDate() <= 7 && pattern.first_week_extra && pattern.first_week_extra.includes(isoDay)) {
          return true;
        }

        return false;
      },

      /**
       * Validate a work pattern object
       * @param {Object} pattern - Pattern to validate
       * @returns {Object} { valid: boolean, errors: string[] }
       */
      validatePattern(pattern) {
        const errors = [];

        if (!pattern) {
          return { valid: false, errors: ['Pattern is required'] };
        }

        // Validate type
        if (pattern.type && !Object.values(WORK_PATTERN_TYPE).includes(pattern.type)) {
          errors.push(`Invalid pattern type: ${pattern.type}`);
        }

        // Validate days array (should contain 1-7)
        if (pattern.days && Array.isArray(pattern.days)) {
          for (const day of pattern.days) {
            if (typeof day !== 'number' || day < 1 || day > 7) {
              errors.push(`Invalid day number: ${day} (must be 1-7)`);
            }
          }
        }

        // Validate first_week_extra array (should contain 1-7)
        if (pattern.first_week_extra && Array.isArray(pattern.first_week_extra)) {
          for (const day of pattern.first_week_extra) {
            if (typeof day !== 'number' || day < 1 || day > 7) {
              errors.push(`Invalid first_week_extra day: ${day} (must be 1-7)`);
            }
          }
        }

        // Validate location
        const validLocations = Object.values(LOCATION_TYPE).filter(l => l !== 'unset');
        if (pattern.location && !validLocations.includes(pattern.location)) {
          errors.push(`Invalid location: ${pattern.location}`);
        }

        return {
          valid: errors.length === 0,
          errors
        };
      },

      /**
       * Save work pattern to a project
       * @param {number} projectId - Project ID
       * @param {Object} pattern - Pattern to save
       * @returns {Promise<void>}
       */
      async savePatternToProject(projectId, pattern) {
        const validation = this.validatePattern(pattern);
        if (!validation.valid) {
          throw new Error(`Invalid pattern: ${validation.errors.join(', ')}`);
        }

        const project = await ProjectManager.getProject(projectId);
        if (!project) {
          throw new Error('Project not found');
        }

        await db.projects.update(projectId, {
          work_pattern: pattern,
          updated_at: new Date().toISOString()
        });

        await SyncQueue.queueChange('projects', projectId, 'UPDATE', { work_pattern: pattern });
      },

      /**
       * Get work pattern from a project
       * @param {number} projectId - Project ID
       * @returns {Promise<Object|null>} Pattern or null
       */
      async getPatternFromProject(projectId) {
        const project = await ProjectManager.getProject(projectId);
        return project?.work_pattern || null;
      },

      /**
       * Preview which dates would be filled by a pattern
       * Does NOT check existing calendar data
       * @param {Object} pattern - Pattern to preview
       * @param {string} startDate - Start date (YYYY-MM-DD)
       * @param {string} endDate - End date (YYYY-MM-DD)
       * @returns {Array<string>} Array of ISO date keys
       */
      previewPattern(pattern, startDate, endDate) {
        const dates = [];

        if (!pattern || (!pattern.days?.length && !pattern.first_week_extra?.length)) {
          return dates;
        }

        const start = new Date(startDate + 'T00:00:00');
        const end = new Date(endDate + 'T00:00:00');

        if (isNaN(start.getTime()) || isNaN(end.getTime())) {
          console.warn('WorkPatternManager.previewPattern: Invalid dates');
          return dates;
        }

        const current = new Date(start);
        while (current <= end) {
          if (this.matchesPattern(current, pattern)) {
            const dateKey = current.toISOString().split('T')[0];
            dates.push(dateKey);
          }
          current.setDate(current.getDate() + 1);
        }

        return dates;
      },

      /**
       * Apply a project's work pattern to the calendar for a date range
       * Respects existing manual edits (only fills days without location set)
       * @param {number} projectId - Project ID with pattern
       * @param {string} startDate - Start date (YYYY-MM-DD)
       * @param {string} endDate - End date (YYYY-MM-DD)
       * @returns {Promise<Object>} { applied: number, skipped: number }
       */
      async applyPattern(projectId, startDate, endDate) {
        const project = await ProjectManager.getProject(projectId);
        if (!project) {
          throw new Error('Project not found');
        }

        const pattern = project.work_pattern;
        if (!pattern || !pattern.active) {
          throw new Error('Project does not have an active work pattern');
        }

        // Get dates that match the pattern
        const matchingDates = this.previewPattern(pattern, startDate, endDate);

        let applied = 0;
        let skipped = 0;

        for (const dateKey of matchingDates) {
          // Check if day already has data
          const existingDay = await CalendarManager.getDay(dateKey);

          // Skip if day has a location set (respect manual edits)
          if (existingDay && existingDay.location && existingDay.location !== 'unset' && existingDay.location !== null) {
            skipped++;
            continue;
          }

          // Create new calendar entry with pattern's settings
          await CalendarManager.saveDay(dateKey, {
            location: pattern.location,
            client_id: project.client_id,
            project_id: project.id,
            notes: existingDay?.notes || null // Preserve any existing notes
          });

          applied++;
        }

        return { applied, skipped };
      },

      /**
       * Get all projects with active work patterns for current entity
       * @returns {Promise<Array>} Projects with work_pattern.active === true
       */
      async getProjectsWithPatterns() {
        const projects = await ProjectManager.getProjects();
        return projects.filter(p => p.work_pattern?.active === true);
      },

      /**
       * Get projects with active patterns for a specific client
       * @param {number} clientId - Client ID
       * @returns {Promise<Array>} Projects with work_pattern.active === true
       */
      async getClientProjectsWithPatterns(clientId) {
        const projects = await ProjectManager.getProjectsByClient(clientId);
        return projects.filter(p => p.work_pattern?.active === true);
      }
    };

    // =====================================================
    // PHASE 16-03: Apply Work Pattern Modal Functions
    // =====================================================

    // Store selected project pattern for preview
    let selectedPatternProject = null;

    /**
     * Open the Apply Work Pattern modal
     * Populates client dropdown with clients that have projects with patterns
     */
    async function openApplyPatternModal() {
      const modal = document.getElementById('applyPatternModal');
      if (!modal) return;

      // Reset form
      const form = document.getElementById('applyPatternForm');
      if (form) form.reset();

      selectedPatternProject = null;

      // Reset preview
      const preview = document.getElementById('applyPatternPreview');
      if (preview) {
        preview.innerHTML = '<p class="preview-text">Select a project to see preview</p>';
      }

      // Disable submit button
      const submitBtn = document.getElementById('applyPatternSubmitBtn');
      if (submitBtn) submitBtn.disabled = true;

      // Reset project dropdown
      const projectSelect = document.getElementById('applyPatternProject');
      if (projectSelect) {
        projectSelect.innerHTML = '<option value="">-- Select client first --</option>';
        projectSelect.disabled = true;
      }

      // Populate client dropdown with clients that have projects with patterns
      const clientSelect = document.getElementById('applyPatternClient');
      if (clientSelect) {
        clientSelect.innerHTML = '<option value="">-- Select client --</option>';

        try {
          const clients = await ClientManager.getClients({});
          let hasClientsWithPatterns = false;

          for (const client of clients) {
            const projectsWithPatterns = await WorkPatternManager.getClientProjectsWithPatterns(client.id);
            if (projectsWithPatterns.length > 0) {
              hasClientsWithPatterns = true;
              const option = document.createElement('option');
              option.value = client.id;
              option.textContent = client.name;
              clientSelect.appendChild(option);
            }
          }

          if (!hasClientsWithPatterns) {
            clientSelect.innerHTML = '<option value="">No clients with patterns</option>';
          }
        } catch (error) {
          console.error('Error loading clients for pattern modal:', error);
        }
      }

      // Set default date range to current month
      const now = new Date();
      const year = calendarState?.year || now.getFullYear();
      const month = calendarState?.currentMonth ?? now.getMonth();

      const startDate = new Date(year, month, 1);
      const endDate = new Date(year, month + 1, 0);

      const startInput = document.getElementById('applyPatternStart');
      const endInput = document.getElementById('applyPatternEnd');

      if (startInput) startInput.value = startDate.toISOString().split('T')[0];
      if (endInput) endInput.value = endDate.toISOString().split('T')[0];

      // Show modal
      modal.classList.remove('hidden');
    }

    /**
     * Close the Apply Work Pattern modal
     */
    function closeApplyPatternModal() {
      const modal = document.getElementById('applyPatternModal');
      if (modal) modal.classList.add('hidden');
      selectedPatternProject = null;
    }

    /**
     * Load projects for selected client (only those with active patterns)
     */
    async function loadClientProjectsForPattern() {
      const clientSelect = document.getElementById('applyPatternClient');
      const projectSelect = document.getElementById('applyPatternProject');

      if (!clientSelect || !projectSelect) return;

      const clientId = parseInt(clientSelect.value, 10);

      if (!clientId) {
        projectSelect.innerHTML = '<option value="">-- Select client first --</option>';
        projectSelect.disabled = true;
        selectedPatternProject = null;
        previewApplyPattern();
        return;
      }

      try {
        const projects = await WorkPatternManager.getClientProjectsWithPatterns(clientId);

        projectSelect.innerHTML = '<option value="">-- Select project --</option>';

        if (projects.length === 0) {
          projectSelect.innerHTML = '<option value="">No projects with patterns</option>';
          projectSelect.disabled = true;
          selectedPatternProject = null;
        } else {
          projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = project.name;
            projectSelect.appendChild(option);
          });
          projectSelect.disabled = false;

          // Auto-select if only one project
          if (projects.length === 1) {
            projectSelect.value = projects[0].id;
            selectedPatternProject = projects[0];
            previewApplyPattern();
          }
        }
      } catch (error) {
        console.error('Error loading projects for pattern:', error);
        projectSelect.innerHTML = '<option value="">Error loading projects</option>';
        projectSelect.disabled = true;
      }
    }

    /**
     * Preview which dates would be filled by the selected pattern
     */
    async function previewApplyPattern() {
      const preview = document.getElementById('applyPatternPreview');
      const submitBtn = document.getElementById('applyPatternSubmitBtn');

      if (!preview) return;

      const projectSelect = document.getElementById('applyPatternProject');
      const startInput = document.getElementById('applyPatternStart');
      const endInput = document.getElementById('applyPatternEnd');

      const projectId = projectSelect?.value ? parseInt(projectSelect.value, 10) : null;
      const startDate = startInput?.value;
      const endDate = endInput?.value;

      // Validate inputs
      if (!projectId || !startDate || !endDate) {
        preview.innerHTML = '<p class="preview-text">Select a project and date range to see preview</p>';
        if (submitBtn) submitBtn.disabled = true;
        selectedPatternProject = null;
        return;
      }

      try {
        // Get project and its pattern
        const project = await ProjectManager.getProject(projectId);
        if (!project || !project.work_pattern) {
          preview.innerHTML = '<p class="preview-text">Project has no pattern</p>';
          if (submitBtn) submitBtn.disabled = true;
          selectedPatternProject = null;
          return;
        }

        selectedPatternProject = project;
        const pattern = project.work_pattern;

        // Get preview dates
        const dates = WorkPatternManager.previewPattern(pattern, startDate, endDate);

        if (dates.length === 0) {
          preview.innerHTML = '<p class="preview-text">No matching days in selected range</p>';
          if (submitBtn) submitBtn.disabled = true;
          return;
        }

        // Format preview
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const dateList = dates.slice(0, 15).map(d => {
          const date = new Date(d + 'T12:00:00');
          return `${dayNames[date.getDay()]} ${date.getDate()}/${date.getMonth() + 1}`;
        }).join(', ');

        const moreText = dates.length > 15 ? `... and ${dates.length - 15} more` : '';

        preview.innerHTML = `
          <div class="preview-count">${dates.length} days will be tagged</div>
          <div class="preview-dates">${dateList}${moreText}</div>
          <p class="preview-warning">Note: Days with existing location tags will be skipped</p>
        `;

        if (submitBtn) submitBtn.disabled = false;

      } catch (error) {
        console.error('Error previewing pattern:', error);
        preview.innerHTML = '<p class="preview-text">Error generating preview</p>';
        if (submitBtn) submitBtn.disabled = true;
      }
    }

    /**
     * Execute the pattern application
     * @param {Event} event - Form submit event
     */
    async function executeApplyPattern(event) {
      if (event) event.preventDefault();

      const projectSelect = document.getElementById('applyPatternProject');
      const startInput = document.getElementById('applyPatternStart');
      const endInput = document.getElementById('applyPatternEnd');
      const submitBtn = document.getElementById('applyPatternSubmitBtn');

      const projectId = projectSelect?.value ? parseInt(projectSelect.value, 10) : null;
      const startDate = startInput?.value;
      const endDate = endInput?.value;

      if (!projectId || !startDate || !endDate) {
        alert('Please select a project and date range');
        return;
      }

      try {
        // Disable button during operation
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = 'Applying...';
        }

        // Apply the pattern
        const result = await WorkPatternManager.applyPattern(projectId, startDate, endDate);

        // Show result
        let message = `Applied pattern to ${result.applied} days.`;
        if (result.skipped > 0) {
          message += ` Skipped ${result.skipped} days with existing entries.`;
        }
        alert(message);

        // Close modal
        closeApplyPatternModal();

        // Refresh calendar display
        if (typeof renderCalendar === 'function') {
          renderCalendar();
        }
        if (typeof updateCountDisplays === 'function') {
          updateCountDisplays();
        }

      } catch (error) {
        console.error('Error applying pattern:', error);
        alert('Error applying pattern: ' + error.message);
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Apply Pattern';
        }
      }
    }

    // =====================================================
    // PHASE 16-02: Day Editor Functions
    // =====================================================

    /**
     * Open day editor modal for a specific date
     * @param {string} dateKey - ISO date string (YYYY-MM-DD)
     */
    async function openDayEditor(dateKey) {
      const modal = document.getElementById('dayEditorModal');
      if (!modal) return;

      // Set modal title to formatted date
      const date = new Date(dateKey + 'T12:00:00');  // Add time to avoid timezone issues
      const formattedDate = new Intl.DateTimeFormat('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      }).format(date);
      document.getElementById('dayEditorTitle').textContent = formattedDate;

      // Store dateKey in hidden input
      document.getElementById('dayEditorDate').value = dateKey;

      // Load existing day data
      const dayData = await CalendarManager.getDay(dateKey);

      // Pre-select location radio
      const location = dayData?.location || 'unset';
      const radios = document.querySelectorAll('input[name="dayLocation"]');
      radios.forEach(radio => {
        radio.checked = radio.value === location;
      });

      // Populate client dropdown
      const clientSelect = document.getElementById('dayEditorClient');
      const clients = await ClientManager.getClients({ archived: false });
      clientSelect.innerHTML = '<option value="">-- No client --</option>';
      clients.forEach(client => {
        const option = document.createElement('option');
        option.value = client.id;
        option.textContent = client.name;
        if (dayData?.client_id === client.id) {
          option.selected = true;
        }
        clientSelect.appendChild(option);
      });

      // Load projects if client is selected
      const projectSelect = document.getElementById('dayEditorProject');
      if (dayData?.client_id) {
        const projects = await ProjectManager.getProjectsByClient(dayData.client_id);
        projectSelect.innerHTML = '<option value="">-- No project --</option>';
        projectSelect.disabled = false;
        projects.forEach(project => {
          const option = document.createElement('option');
          option.value = project.id;
          option.textContent = project.name;
          if (dayData?.project_id === project.id) {
            option.selected = true;
          }
          projectSelect.appendChild(option);
        });
      } else {
        projectSelect.innerHTML = '<option value="">-- Select client first --</option>';
        projectSelect.disabled = true;
      }

      // Set notes
      document.getElementById('dayEditorNotes').value = dayData?.notes || '';

      // Show expenses linked to this day (Phase 17-05)
      const expenseInfo = document.getElementById('dayEditorExpensesInfo');
      const expenseCountEl = document.getElementById('dayEditorExpensesCount');
      const expenseListEl = document.getElementById('dayEditorExpensesList');

      try {
        // Get expenses for this exact date
        const dayExpenses = await ExpenseManager.getExpensesByDate(dateKey);

        // Get travel expenses whose trip range spans this date (but receipt date differs)
        const tripExpenses = await ExpenseManager.getExpensesForDateRange(dateKey, dateKey);
        // Avoid duplicates: filter out trip expenses already in dayExpenses
        const dayExpenseIds = new Set(dayExpenses.map(e => e.id));
        const extraTripExpenses = tripExpenses.filter(e => !dayExpenseIds.has(e.id));

        const allExpenses = [...dayExpenses, ...extraTripExpenses];
        const totalCount = allExpenses.length;

        // Always show the expenses section (with "Add Expense" button even if empty)
        expenseInfo.style.display = 'block';
        expenseCountEl.textContent = totalCount;

        if (totalCount > 0) {
          let html = '';
          for (const exp of allExpenses) {
            const catConfig = EXPENSE_CATEGORY[exp.category];
            const catLabel = catConfig?.label || exp.category;
            const vendor = _escapeHtml(exp.vendor || 'No vendor');
            const amount = MoneyUtils.formatEuros(exp.amount_cents || 0);
            const deductible = MoneyUtils.formatEuros(exp.deductible_amount_cents || 0);
            const isTrip = extraTripExpenses.includes(exp);
            const tripBadge = isTrip ? '<span class="de-trip-badge">trip</span>' : '';

            html += `<div class="day-expense-item">
              <span class="de-cat">${_escapeHtml(catLabel)}</span>
              <span class="de-vendor" title="${vendor}">${vendor}</span>
              ${tripBadge}
              <span class="de-amount">${amount}</span>
              <span class="de-deductible">${deductible}</span>
            </div>`;
          }
          expenseListEl.innerHTML = html;
        } else {
          expenseListEl.innerHTML = '<div class="day-editor-expenses-empty">No expenses for this day.</div>';
        }
      } catch (err) {
        DEBUG && console.debug('Day editor expense load error:', err);
        expenseInfo.style.display = 'block';
        expenseCountEl.textContent = '0';
        expenseListEl.innerHTML = '<div class="day-editor-expenses-empty">No expenses for this day.</div>';
      }

      // Show modal
      modal.classList.remove('hidden');
    }

    /**
     * Close day editor modal
     */
    function closeDayEditor() {
      const modal = document.getElementById('dayEditorModal');
      if (modal) {
        modal.classList.add('hidden');
      }
      // Reset form
      document.getElementById('dayEditorForm').reset();
    }

    /**
     * Open expense form with the current day editor date pre-filled
     * Closes the day editor and opens the expense form dialog.
     */
    function addExpenseForDay() {
      const dateKey = document.getElementById('dayEditorDate')?.value;
      closeDayEditor();
      openExpenseFormDialog(null);
      // Pre-fill the date after the form opens (setTimeout to let form populate)
      if (dateKey) {
        setTimeout(() => {
          const dateInput = document.getElementById('efDate');
          if (dateInput) dateInput.value = dateKey;
        }, 50);
      }
    }

    /**
     * Update project dropdown when client selection changes
     */
    async function updateDayEditorProjectDropdown() {
      const clientSelect = document.getElementById('dayEditorClient');
      const projectSelect = document.getElementById('dayEditorProject');
      const clientId = clientSelect.value;

      if (!clientId) {
        projectSelect.innerHTML = '<option value="">-- Select client first --</option>';
        projectSelect.disabled = true;
        return;
      }

      // Fetch projects for this client
      const projects = await ProjectManager.getProjectsByClient(parseInt(clientId));
      projectSelect.innerHTML = '<option value="">-- No project --</option>';

      projects.forEach(project => {
        const option = document.createElement('option');
        option.value = project.id;
        option.textContent = project.name;
        projectSelect.appendChild(option);
      });

      projectSelect.disabled = false;
    }

    /**
     * Save day editor data to IndexedDB
     * @param {Event} event - Form submit event
     */
    async function saveDayEditor(event) {
      event.preventDefault();

      const dateKey = document.getElementById('dayEditorDate').value;
      if (!dateKey) return;

      // Get selected location
      const locationRadio = document.querySelector('input[name="dayLocation"]:checked');
      const location = locationRadio?.value || 'unset';

      // Get client and project IDs
      const clientId = document.getElementById('dayEditorClient').value;
      const projectId = document.getElementById('dayEditorProject').value;

      // Get notes
      const notes = document.getElementById('dayEditorNotes').value.trim();

      // Save to IndexedDB
      await CalendarManager.saveDay(dateKey, {
        location: location,
        client_id: clientId ? parseInt(clientId) : null,
        project_id: projectId ? parseInt(projectId) : null,
        notes: notes || null
      });

      // Close modal
      closeDayEditor();

      // Re-render calendar
      await renderCalendarAsync();

      // Update count displays (async to read from IndexedDB)
      await updateCountDisplaysAsync();

      // Show brief success feedback
      showNotification('Day saved');
    }

    /**
     * Clear all data for the current day
     */
    async function clearDayEditor() {
      const dateKey = document.getElementById('dayEditorDate').value;
      if (!dateKey) return;

      if (confirm('Clear all data for this day?')) {
        await CalendarManager.deleteDays([dateKey]);
        closeDayEditor();
        await renderCalendarAsync();
        await updateCountDisplaysAsync();
        showNotification('Day cleared');
      }
    }

    // =====================================================
    // PHASE 16-02: Bulk Tag Functions
    // =====================================================

    /**
     * Open bulk tag modal for selected days
     */
    async function openBulkTagModal() {
      if (selectedDates.size === 0) {
        alert('Select days first (use shift+click or week selectors)');
        return;
      }

      const modal = document.getElementById('bulkTagModal');
      if (!modal) return;

      // Set count
      document.getElementById('bulkTagCount').textContent = selectedDates.size;

      // Populate client dropdown
      const clientSelect = document.getElementById('bulkTagClient');
      const clients = await ClientManager.getClients({ archived: false });
      clientSelect.innerHTML = '<option value="">-- Select client --</option>';
      clients.forEach(client => {
        const option = document.createElement('option');
        option.value = client.id;
        option.textContent = client.name;
        clientSelect.appendChild(option);
      });

      // Reset project dropdown
      const projectSelect = document.getElementById('bulkTagProject');
      projectSelect.innerHTML = '<option value="">-- Select client first --</option>';
      projectSelect.disabled = true;

      // Reset overwrite checkbox
      document.getElementById('bulkTagOverwrite').checked = false;

      // Show modal
      modal.classList.remove('hidden');
    }

    /**
     * Close bulk tag modal
     */
    function closeBulkTagModal() {
      const modal = document.getElementById('bulkTagModal');
      if (modal) {
        modal.classList.add('hidden');
      }
      // Reset form
      document.getElementById('bulkTagForm').reset();
    }

    /**
     * Update project dropdown in bulk tag modal when client changes
     */
    async function updateBulkTagProjects() {
      const clientSelect = document.getElementById('bulkTagClient');
      const projectSelect = document.getElementById('bulkTagProject');
      const clientId = clientSelect.value;

      if (!clientId) {
        projectSelect.innerHTML = '<option value="">-- Select client first --</option>';
        projectSelect.disabled = true;
        return;
      }

      // Fetch projects for this client
      const projects = await ProjectManager.getProjectsByClient(parseInt(clientId));
      projectSelect.innerHTML = '<option value="">-- No project --</option>';

      projects.forEach(project => {
        const option = document.createElement('option');
        option.value = project.id;
        option.textContent = project.name;
        projectSelect.appendChild(option);
      });

      projectSelect.disabled = false;
    }

    /**
     * Execute bulk tagging of selected days
     * @param {Event} event - Form submit event
     */
    async function executeBulkTag(event) {
      event.preventDefault();

      const clientId = document.getElementById('bulkTagClient').value;
      if (!clientId) {
        alert('Please select a client');
        return;
      }

      const projectId = document.getElementById('bulkTagProject').value;
      const overwrite = document.getElementById('bulkTagOverwrite').checked;

      let tagged = 0;
      let skipped = 0;

      // Process each selected date
      for (const dateKey of selectedDates) {
        const existingDay = await CalendarManager.getDay(dateKey);

        // Skip if has client and overwrite is false
        if (!overwrite && existingDay?.client_id) {
          skipped++;
          continue;
        }

        // Update the day with client/project
        await CalendarManager.saveDay(dateKey, {
          client_id: parseInt(clientId),
          project_id: projectId ? parseInt(projectId) : null
        });
        tagged++;
      }

      // Close modal
      closeBulkTagModal();

      // Clear selection
      selectedDates.clear();
      updateSelectionCount();

      // Re-render calendar
      await renderCalendarAsync();

      // Show feedback
      let message = `Tagged ${tagged} day(s)`;
      if (skipped > 0) {
        message += ` (skipped ${skipped} existing)`;
      }
      showNotification(message);
    }

    /**
     * Async version of renderCalendar that loads data from IndexedDB
     */
    async function renderCalendarAsync() {
      const container = document.getElementById('calendarContainer');
      if (!container) return;

      const year = calendarState.currentYear || calendarState.year;
      const month = calendarState.currentMonth;

      // Load days data from IndexedDB for this month
      const monthDays = await CalendarManager.getDaysForMonth(year, month);
      const daysMap = new Map(monthDays.map(d => [d.date, d]));

      // Load clients for abbreviations
      const clients = await ClientManager.getClients({ archived: false });
      const clientMap = new Map(clients.map(c => [c.id, c.name]));

      // Build list of date keys for expense count lookup
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const dateKeys = [];
      for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
        dateKeys.push(toISODateKey(new Date(d)));
      }

      // Load expense counts in batch (efficient for Phase 17)
      const expenseCounts = await CalendarManager.getLinkedExpenseCounts(dateKeys);

      // Get month name (without year - year shown separately)
      const monthName = new Intl.DateTimeFormat('en-US', { month: 'long' })
        .format(new Date(year, month, 1));

      // Check navigation bounds using helper functions
      const canPrev = canNavigatePrev();
      const canNext = canNavigateNext();

      // Build year quick-jump buttons
      const yearButtons = Object.keys(CALENDAR_RANGE).map(y => {
        const isActive = parseInt(y) === year;
        return `<button type="button" class="year-jump-btn ${isActive ? 'active' : ''}" onclick="jumpToYear(${y})">${y}</button>`;
      }).join('');

      // Build header with Select All button and year display
      const headerHtml = `
        <div class="calendar-header">
          <button class="nav-btn" onclick="navigateMonth(-1)" ${canPrev ? '' : 'disabled'}>
            &larr; Prev
          </button>
          <div style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
            <div class="year-nav">${yearButtons}</div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <h3 style="margin: 0;">${monthName} ${year}</h3>
              <button type="button" class="month-select-all" onclick="selectMonth(${month})" title="Select all days in ${monthName}">Select All</button>
            </div>
          </div>
          <button class="nav-btn" onclick="navigateMonth(1)" ${canNext ? '' : 'disabled'}>
            Next &rarr;
          </button>
        </div>
      `;

      // Build grid with week selectors
      const weeks = getMonthGrid(year, month);
      const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

      let gridHtml = '<div class="calendar-grid-with-weeks">';

      // Day headers (empty cell for week selector column)
      gridHtml += '<div class="day-header"></div>';
      dayNames.forEach(name => {
        gridHtml += `<div class="day-header">${name}</div>`;
      });

      // Day cells with week selectors
      weeks.forEach((week, weekIndex) => {
        // Find first non-null date in this week to calculate Monday
        const firstDateInWeek = week.find(d => d !== null);
        let weekStartKey = null;

        if (firstDateInWeek) {
          // Calculate the Monday of this week
          const monday = new Date(firstDateInWeek);
          const dayOfWeek = monday.getDay();
          // Adjust to Monday (0=Sunday, so Sunday needs -6, others need 1-dayOfWeek)
          const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
          monday.setDate(monday.getDate() - daysToSubtract);
          weekStartKey = toISODateKey(monday);
        }

        // Week selector button
        if (weekStartKey) {
          gridHtml += `<div class="week-selector-cell"><button type="button" class="week-selector" onclick="selectWeek('${weekStartKey}')" title="Select entire week" aria-label="Select week starting ${weekStartKey}">W</button></div>`;
        } else {
          gridHtml += '<div class="week-selector-cell"></div>';
        }

        // Day cells for this week
        week.forEach(date => {
          if (date === null) {
            gridHtml += '<div class="day-cell empty"></div>';
          } else {
            const dateKey = toISODateKey(date);

            // Get data from IndexedDB map or fall back to localStorage state
            const dbDay = daysMap.get(dateKey);
            const localDay = calendarState.days[dateKey] || {};

            // Prefer IndexedDB data for location, fall back to localStorage
            const status = dbDay?.location || localDay.status || 'unset';
            const isContracted = localDay.contracted === true;
            const emoji = getStatusEmoji(status);

            // Client abbreviation (first 3 letters)
            let clientAbbrev = '';
            if (dbDay?.client_id) {
              const clientName = clientMap.get(dbDay.client_id);
              if (clientName) {
                clientAbbrev = clientName.substring(0, 3).toUpperCase();
              }
            }

            // Expense count from batch lookup (will show badge when Phase 17 populates expenses)
            const expenseCount = expenseCounts[dateKey] || 0;

            const isSelected = selectedDates.has(dateKey);
            gridHtml += `
              <div class="day-cell ${status} ${isSelected ? 'selected' : ''}" data-date="${dateKey}" onclick="handleDayClick('${dateKey}', event)">
                <div class="day-cell-header">
                  <input type="checkbox" class="day-checkbox"
                    ${isSelected ? 'checked' : ''}
                    onchange="toggleDaySelection('${dateKey}', this.checked)"
                    onclick="event.stopPropagation()"
                    aria-label="Select ${date.getDate()}">
                  <span class="day-number">${date.getDate()}</span>
                  ${isContracted ? '<span class="contracted-badge">C</span>' : ''}
                </div>
                <div class="day-status-display">
                  ${emoji ? `<span class="status-emoji">${emoji}</span>` : '<span class="status-empty">-</span>'}
                </div>
                ${clientAbbrev ? `<span class="day-client">${clientAbbrev}</span>` : ''}
                ${expenseCount > 0 ? `<span class="day-expense-badge">${expenseCount}</span>` : ''}
              </div>
            `;
          }
        });
      });

      gridHtml += '</div>';

      container.innerHTML = headerHtml + gridHtml;
    }

    // =====================================================
    // Entity Manager (CRUD Operations)
    // =====================================================

    const EntityManager = {
      // Create new entity (Autonomo or SL)
      async createEntity(entityData) {
        const { type, ...data } = entityData;

        // Validate entity type
        if (!Object.values(ENTITY_TYPE).includes(type)) {
          throw new Error(`Invalid entity type: ${type}`);
        }

        // Validate tax ID based on type
        let taxIdField, validatedTaxId;
        if (type === ENTITY_TYPE.AUTONOMO) {
          const result = SpanishTaxIdValidator.validateNIF(data.nif);
          if (!result.valid) {
            throw new Error(`NIF invalid: ${result.error}`);
          }
          validatedTaxId = result.formatted;
          taxIdField = 'nif';
        } else {
          const result = SpanishTaxIdValidator.validateCIF(data.cif);
          if (!result.valid) {
            throw new Error(`CIF invalid: ${result.error}`);
          }
          validatedTaxId = result.formatted;
          taxIdField = 'cif';
        }

        // Check for duplicate tax ID
        const existing = await db.entities
          .where('nif_cif')
          .equals(validatedTaxId)
          .filter(e => !e.deleted_at)
          .first();

        if (existing) {
          throw new Error(`An entity with this ${taxIdField.toUpperCase()} already exists`);
        }

        // Build entity record
        const entity = {
          type,
          nif_cif: validatedTaxId,
          name: data.name?.trim(),
          owner_id: AuthManager.getUser()?.id || null, // Set owner to current user (Phase 14)
          is_active: true,
          deleted_at: null,
          ...auditFields(true)
        };

        // Add type-specific fields
        if (type === ENTITY_TYPE.AUTONOMO) {
          entity.domicilio_fiscal = data.domicilio_fiscal?.trim() || '';
          entity.iae_codes = data.iae_codes || [];
          entity.iae_primary = data.iae_primary?.trim() || '';
          entity.fecha_alta = data.fecha_alta || null;
        } else {
          entity.domicilio_social = data.domicilio_social?.trim() || '';
          entity.registro_mercantil = {
            provincia: data.registro_mercantil?.provincia?.trim() || '',
            tomo: data.registro_mercantil?.tomo?.trim() || '',
            libro: data.registro_mercantil?.libro?.trim() || '',
            folio: data.registro_mercantil?.folio?.trim() || '',
            seccion: data.registro_mercantil?.seccion?.trim() || '',
            hoja: data.registro_mercantil?.hoja?.trim() || '',
            inscripcion: data.registro_mercantil?.inscripcion?.trim() || ''
          };
          entity.fecha_constitucion = data.fecha_constitucion || null;
          entity.capital_social_cents = data.capital_social_cents || 300000; // 3000 EUR minimum
        }

        // Logo data (shared by both entity types)
        if (data.logo_data) {
          entity.logo_data = data.logo_data;
        }

        // Insert entity
        const id = await db.entities.add(entity);

        // Queue for sync
        await SyncQueue.queueChange('entities', id, 'CREATE', entity);

        // Auto-select if first entity
        const entityCount = await db.entities
          .filter(e => !e.deleted_at && e.is_active)
          .count();

        if (entityCount === 1) {
          await EntityContext.setEntity(id);
        }

        // Check for dual activity after creation (Phase 13-05)
        setTimeout(() => DualActivityDetector.checkAndWarn(), 100);

        return id;
      },

      // Get entity by ID
      async getEntity(entityId) {
        return db.entities.get(entityId);
      },

      // Get all entities (including archived, excluding deleted)
      async getAllEntities() {
        return db.entities
          .filter(e => !e.deleted_at)
          .toArray();
      },

      // Get only active (non-archived) entities
      async getActiveEntities() {
        return db.entities
          .filter(e => !e.deleted_at && e.is_active === true)
          .toArray();
      },

      // Get archived entities
      async getArchivedEntities() {
        return db.entities
          .filter(e => !e.deleted_at && !e.is_active)
          .toArray();
      },

      // Update entity
      async updateEntity(entityId, updates) {
        const entity = await this.getEntity(entityId);
        if (!entity) throw new Error('Entity not found');
        if (entity.deleted_at) throw new Error('Entity is deleted');

        // If updating tax ID, validate it
        if (updates.nif || updates.cif) {
          const taxId = updates.nif || updates.cif;
          const result = SpanishTaxIdValidator.validate(taxId);
          if (!result.valid) {
            throw new Error(`Invalid tax ID: ${result.error}`);
          }
          updates.nif_cif = result.formatted;
        }

        // Apply updates
        const updatedFields = {
          ...updates,
          updated_at: new Date().toISOString()
        };

        await db.entities.update(entityId, updatedFields);
        await SyncQueue.queueChange('entities', entityId, 'UPDATE', updatedFields);

        // Refresh EntityContext if this is the current entity
        if (EntityContext.entityId === entityId) {
          const refreshed = await this.getEntity(entityId);
          // Force notify observers with updated data
          await EntityContext.setEntity(entityId);
        }

        return true;
      },

      // Archive entity (soft deactivate)
      async archiveEntity(entityId) {
        const entity = await this.getEntity(entityId);
        if (!entity) throw new Error('Entity not found');
        if (!entity.is_active) throw new Error('Entity already archived');

        // If archiving current entity, switch to another
        if (EntityContext.entityId === entityId) {
          const otherEntity = await db.entities
            .filter(e => e.id !== entityId && !e.deleted_at && e.is_active)
            .first();

          if (otherEntity) {
            await EntityContext.setEntity(otherEntity.id);
          } else {
            EntityContext.clear();
          }
        }

        await db.entities.update(entityId, {
          is_active: false,
          updated_at: new Date().toISOString()
        });

        await SyncQueue.queueChange('entities', entityId, 'UPDATE', { is_active: false });

        // Check dual activity (archiving may hide warning) - Phase 13-05
        setTimeout(() => DualActivityDetector.checkAndWarn(), 100);

        return true;
      },

      // Restore archived entity
      async restoreEntity(entityId) {
        const entity = await this.getEntity(entityId);
        if (!entity) throw new Error('Entity not found');
        if (entity.is_active) throw new Error('Entity is already active');
        if (entity.deleted_at) throw new Error('Entity is deleted and cannot be restored');

        await db.entities.update(entityId, {
          is_active: true,
          updated_at: new Date().toISOString()
        });

        await SyncQueue.queueChange('entities', entityId, 'UPDATE', { is_active: true });

        // Check dual activity (restoration may trigger it) - Phase 13-05
        setTimeout(() => DualActivityDetector.checkAndWarn(), 100);

        return true;
      },

      // Permanently delete (only if within soft delete window - handled by DataManager)
      async deleteEntity(entityId) {
        return DataManager.softDelete('entities', entityId);
      }
    };

    // =====================================================
    // Entity Modal Controller
    // =====================================================

    const EntityModal = {
      selectedType: null,
      _logoData: null, // Compressed base64 logo data URL

      open() {
        this.reset();
        document.getElementById('entity-modal-overlay').classList.add('active');
        // Prevent body scroll when modal is open
        document.body.style.overflow = 'hidden';
      },

      close() {
        document.getElementById('entity-modal-overlay').classList.remove('active');
        document.body.style.overflow = '';
        this.reset();
      },

      reset() {
        this.selectedType = null;
        this._logoData = null;
        document.getElementById('entity-form-fields').style.display = 'none';
        document.getElementById('autonomo-fields').style.display = 'none';
        document.getElementById('sl-fields').style.display = 'none';
        document.getElementById('entity-modal-submit').disabled = true;

        // Reset type selector
        document.querySelectorAll('.entity-type-option').forEach(opt => {
          opt.classList.remove('selected');
        });

        // Reset form
        document.getElementById('entity-form').reset();

        // Clear validation states
        document.querySelectorAll('.entity-form__input').forEach(input => {
          input.classList.remove('valid', 'invalid');
        });
        document.querySelectorAll('.entity-form__error').forEach(err => {
          err.style.display = 'none';
        });

        // Reset logo upload
        const logoSection = document.getElementById('entity-logo-section');
        if (logoSection) logoSection.style.display = 'none';
        const logoImg = document.getElementById('entity-logo-img');
        if (logoImg) { logoImg.src = ''; logoImg.style.display = 'none'; }
        const logoPlaceholder = document.getElementById('entity-logo-placeholder');
        if (logoPlaceholder) logoPlaceholder.style.display = '';
        const logoRemoveBtn = document.getElementById('entity-logo-remove-btn');
        if (logoRemoveBtn) logoRemoveBtn.style.display = 'none';
      },

      selectType(type) {
        this.selectedType = type;

        // Update type selector UI
        document.querySelectorAll('.entity-type-option').forEach(opt => {
          opt.classList.toggle('selected', opt.dataset.type === type);
        });

        // Show form fields
        document.getElementById('entity-form-fields').style.display = 'block';
        document.getElementById('autonomo-fields').style.display = type === 'autonomo' ? 'block' : 'none';
        document.getElementById('sl-fields').style.display = type === 'sociedad_limitada' ? 'block' : 'none';

        // Show logo upload section
        const logoSection = document.getElementById('entity-logo-section');
        if (logoSection) logoSection.style.display = 'block';

        // Enable submit button
        document.getElementById('entity-modal-submit').disabled = false;

        // Focus first input
        if (type === 'autonomo') {
          document.getElementById('entity-nif').focus();
        } else {
          document.getElementById('entity-cif').focus();
        }
      },

      validateNIF() {
        const input = document.getElementById('entity-nif');
        const errorEl = document.getElementById('entity-nif-error');
        const value = input.value.trim();

        if (!value) {
          input.classList.remove('valid', 'invalid');
          errorEl.style.display = 'none';
          return false;
        }

        const result = SpanishTaxIdValidator.validateNIF(value);
        input.classList.toggle('valid', result.valid);
        input.classList.toggle('invalid', !result.valid);

        if (!result.valid) {
          errorEl.textContent = result.error;
          errorEl.style.display = 'block';
        } else {
          errorEl.style.display = 'none';
        }

        return result.valid;
      },

      validateCIF() {
        const input = document.getElementById('entity-cif');
        const errorEl = document.getElementById('entity-cif-error');
        const value = input.value.trim();

        if (!value) {
          input.classList.remove('valid', 'invalid');
          errorEl.style.display = 'none';
          return false;
        }

        const result = SpanishTaxIdValidator.validateCIF(value);
        input.classList.toggle('valid', result.valid);
        input.classList.toggle('invalid', !result.valid);

        if (!result.valid) {
          errorEl.textContent = result.error;
          errorEl.style.display = 'block';
        } else {
          errorEl.style.display = 'none';
        }

        return result.valid;
      },

      async submit() {
        if (!this.selectedType) return;

        try {
          let entityData;

          if (this.selectedType === 'autonomo') {
            // Validate required fields
            const nif = document.getElementById('entity-nif').value.trim();
            const nombre = document.getElementById('entity-nombre').value.trim();
            const domicilio = document.getElementById('entity-domicilio-fiscal').value.trim();

            if (!nif || !nombre || !domicilio) {
              alert('Please complete all required fields.');
              return;
            }

            if (!this.validateNIF()) {
              document.getElementById('entity-nif').focus();
              return;
            }

            entityData = {
              type: ENTITY_TYPE.AUTONOMO,
              nif,
              name: nombre,
              domicilio_fiscal: domicilio,
              iae_primary: document.getElementById('entity-iae').value.trim(),
              iae_codes: document.getElementById('entity-iae').value.trim() ?
                [document.getElementById('entity-iae').value.trim()] : [],
              fecha_alta: document.getElementById('entity-fecha-alta').value || null
            };
          } else {
            // SL
            const cif = document.getElementById('entity-cif').value.trim();
            const razonSocial = document.getElementById('entity-razon-social').value.trim();
            const domicilio = document.getElementById('entity-domicilio-social').value.trim();

            if (!cif || !razonSocial || !domicilio) {
              alert('Please complete all required fields.');
              return;
            }

            if (!this.validateCIF()) {
              document.getElementById('entity-cif').focus();
              return;
            }

            const capitalInput = document.getElementById('entity-capital-social').value;
            const capitalEuros = parseFloat(capitalInput) || 3000;

            entityData = {
              type: ENTITY_TYPE.SOCIEDAD_LIMITADA,
              cif,
              name: razonSocial,
              domicilio_social: domicilio,
              registro_mercantil: {
                provincia: document.getElementById('entity-rm-provincia').value.trim(),
                tomo: document.getElementById('entity-rm-tomo').value.trim(),
                libro: '',
                folio: document.getElementById('entity-rm-folio').value.trim(),
                seccion: document.getElementById('entity-rm-seccion').value.trim(),
                hoja: document.getElementById('entity-rm-hoja').value.trim(),
                inscripcion: document.getElementById('entity-rm-inscripcion').value.trim()
              },
              fecha_constitucion: document.getElementById('entity-fecha-constitucion').value || null,
              capital_social_cents: MoneyUtils.eurosToCents(capitalEuros)
            };
          }

          // Add logo if uploaded
          if (this._logoData) {
            entityData.logo_data = this._logoData;
          }

          const entityId = await EntityManager.createEntity(entityData);
          DEBUG && console.log('Entity created:', entityId);

          this.close();

          // Refresh entity switcher
          if (entitySwitcher) {
            entitySwitcher.refresh();
          }

          // Show success notification
          showNotification(`Entity "${entityData.name}" creada correctamente.`, 'success');

        } catch (error) {
          console.error('Error creating entity:', error);
          alert(`Error: ${error.message}`);
        }
      },

      /**
       * handleLogoUpload - Process logo file selection, compress and preview
       * @param {HTMLInputElement} input - File input element
       */
      async handleLogoUpload(input) {
        const file = input.files?.[0];
        if (!file) return;

        try {
          const compressed = await compressLogoImage(file);
          this._logoData = compressed;

          // Show preview
          const logoImg = document.getElementById('entity-logo-img');
          const logoPlaceholder = document.getElementById('entity-logo-placeholder');
          const logoRemoveBtn = document.getElementById('entity-logo-remove-btn');

          if (logoImg) {
            logoImg.src = compressed;
            logoImg.style.display = 'block';
          }
          if (logoPlaceholder) logoPlaceholder.style.display = 'none';
          if (logoRemoveBtn) logoRemoveBtn.style.display = '';
        } catch (err) {
          console.error('Logo upload failed:', err);
          showNotification('Failed to process logo image', 'error');
        }
      },

      /**
       * removeLogo - Clear logo data and reset preview
       */
      removeLogo() {
        this._logoData = null;

        const logoImg = document.getElementById('entity-logo-img');
        const logoPlaceholder = document.getElementById('entity-logo-placeholder');
        const logoRemoveBtn = document.getElementById('entity-logo-remove-btn');
        const fileInput = document.getElementById('entityLogoUpload');

        if (logoImg) { logoImg.src = ''; logoImg.style.display = 'none'; }
        if (logoPlaceholder) logoPlaceholder.style.display = '';
        if (logoRemoveBtn) logoRemoveBtn.style.display = 'none';
        if (fileInput) fileInput.value = '';
      },

      // Initialize event listeners
      init() {
        // NIF validation on blur
        const nifInput = document.getElementById('entity-nif');
        if (nifInput) {
          nifInput.addEventListener('blur', () => this.validateNIF());
        }

        // CIF validation on blur
        const cifInput = document.getElementById('entity-cif');
        if (cifInput) {
          cifInput.addEventListener('blur', () => this.validateCIF());
        }

        // Close on overlay click
        const overlay = document.getElementById('entity-modal-overlay');
        if (overlay) {
          overlay.addEventListener('click', (e) => {
            if (e.target.id === 'entity-modal-overlay') {
              this.close();
            }
          });
        }

        // Close on Escape key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && document.getElementById('entity-modal-overlay')?.classList.contains('active')) {
            this.close();
          }
        });
      }
    };

    // =====================================================
    // Entity Switcher Component (Phase 13-04)
    // =====================================================

    // AbortController for entity switcher document-level listeners
    let _entitySwitcherAbort = null;

    function createEntitySwitcher(containerId) {
      const container = document.getElementById(containerId);
      if (!container) {
        console.warn('Entity switcher container not found:', containerId);
        return null;
      }

      // Abort previous document-level listeners to prevent accumulation
      if (_entitySwitcherAbort) {
        _entitySwitcherAbort.abort();
      }
      _entitySwitcherAbort = new AbortController();

      // Create HTML structure
      container.innerHTML = `
        <div class="entity-switcher" role="combobox" aria-expanded="false"
             aria-haspopup="listbox" aria-labelledby="entity-switcher-label">
          <span id="entity-switcher-label" class="visually-hidden">Select entity</span>

          <button class="entity-switcher__trigger"
                  aria-describedby="entity-switcher-label"
                  type="button">
            <span class="entity-switcher__icon" aria-hidden="true">&#128203;</span>
            <span class="entity-switcher__name">Select entity...</span>
            <span class="entity-switcher__type"></span>
            <svg class="entity-switcher__chevron" aria-hidden="true"
                 viewBox="0 0 24 24" width="16" height="16">
              <path d="M7 10l5 5 5-5z" fill="currentColor"/>
            </svg>
          </button>

          <ul class="entity-switcher__menu" role="listbox"
              aria-labelledby="entity-switcher-label" hidden>
          </ul>
        </div>
      `;

      const trigger = container.querySelector('.entity-switcher__trigger');
      const menu = container.querySelector('.entity-switcher__menu');
      const nameEl = container.querySelector('.entity-switcher__name');
      const typeEl = container.querySelector('.entity-switcher__type');
      const iconEl = container.querySelector('.entity-switcher__icon');
      const wrapper = container.querySelector('.entity-switcher');

      let entities = [];
      let isOpen = false;

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Entity roles cache for display
      let entityRoles = {};

      // Load entities from database (Phase 14-06: filter by accessible entities)
      async function loadEntities() {
        DEBUG && console.log('[EntitySwitcher] loadEntities called, offlineMode:', AuthManager.isOfflineMode());
        // In offline mode or unauthenticated, show all local entities
        if (AuthManager.isOfflineMode() || !AuthManager.isAuthenticated()) {
          entities = await EntityManager.getActiveEntities();
          DEBUG && console.log('[EntitySwitcher] Got entities:', entities.length, entities);
          // In offline mode, treat all as owned
          entityRoles = {};
          entities.forEach(e => entityRoles[e.id] = 'owner');
        } else {
          // Online: filter to accessible entities only (PERM-04)
          entities = await EntityAccessManager.getAccessibleEntities();
          // Cache roles for display
          entityRoles = {};
          for (const entity of entities) {
            const role = await EntityAccessManager.getRole(entity.id);
            entityRoles[entity.id] = role || 'owner';
          }
        }
        DEBUG && console.log('[EntitySwitcher] Rendering menu with', entities.length, 'entities');
        renderMenu();
      }

      // Get role badge HTML for non-owner roles
      function getRoleBadgeHtml(entityId) {
        const role = entityRoles[entityId];
        if (!role || role === 'owner') return '';

        const labels = {
          partner: 'Partner',
          accountant: 'Accountant',
          gestor: 'Gestor'
        };

        return `<span class="entity-switcher__option-role role-${escapeHtml(role)}">${escapeHtml(labels[role] || role)}</span>`;
      }

      // Render menu options
      function renderMenu() {
        const currentId = EntityContext.entityId;

        if (entities.length === 0) {
          menu.innerHTML = `
            <li class="entity-switcher__empty">
              No entities created
            </li>
            <li class="entity-switcher__divider" role="separator"></li>
            <li class="entity-switcher__option entity-switcher__option--action"
                role="option"
                data-action="create"
                tabindex="-1">
              <span class="entity-switcher__option-icon" aria-hidden="true">&#10133;</span>
              <span class="entity-switcher__option-name">Create new entity</span>
            </li>
          `;
          return;
        }

        menu.innerHTML = entities.map(entity => `
          <li class="entity-switcher__option ${entity.id === currentId ? 'entity-switcher__option--active' : ''}"
              role="option"
              data-entity-id="${entity.id}"
              aria-selected="${entity.id === currentId}"
              tabindex="-1">
            <span class="entity-switcher__option-icon" aria-hidden="true">
              ${entity.type === 'autonomo' ? '&#128100;' : '&#127970;'}
            </span>
            <span class="entity-switcher__option-name">${escapeHtml(entity.name)}</span>
            <span class="entity-switcher__option-type">
              ${entity.type === 'autonomo' ? 'Autonomo' : 'S.L.'}
            </span>
            ${getRoleBadgeHtml(entity.id)}
            ${entity.id === currentId ? '<span class="entity-switcher__check" aria-hidden="true">&#10003;</span>' : ''}
          </li>
        `).join('');

        // Add "Create entity" option
        menu.innerHTML += `
          <li class="entity-switcher__divider" role="separator"></li>
          <li class="entity-switcher__option entity-switcher__option--action"
              role="option"
              data-action="create"
              tabindex="-1">
            <span class="entity-switcher__option-icon" aria-hidden="true">&#10133;</span>
            <span class="entity-switcher__option-name">Create new entity</span>
          </li>
        `;

      }

      // Update trigger display
      function updateTrigger(entity) {
        DEBUG && console.log('[EntitySwitcher] updateTrigger called with:', entity?.name || 'null');
        if (entity) {
          nameEl.textContent = entity.name;
          typeEl.textContent = entity.type === 'autonomo' ? 'Autonomo' : 'S.L.';
          iconEl.innerHTML = entity.type === 'autonomo' ? '&#128100;' : '&#127970;';
          DEBUG && console.log('[EntitySwitcher] Set trigger to:', entity.name);
        } else {
          nameEl.textContent = 'Select entity...';
          typeEl.textContent = '';
          iconEl.innerHTML = '&#128203;';
          DEBUG && console.log('[EntitySwitcher] Set trigger to: Select entity...');
        }
        // Re-render menu to update active state
        renderMenu();
      }

      // Toggle menu open/closed
      function toggleMenu(open) {
        isOpen = open !== undefined ? open : !isOpen;
        wrapper.setAttribute('aria-expanded', isOpen);
        menu.hidden = !isOpen;

        if (isOpen) {
          // Focus active or first option
          const activeOption = menu.querySelector('.entity-switcher__option--active') ||
                               menu.querySelector('.entity-switcher__option');
          if (activeOption) activeOption.focus();
        }
      }

      // Handle entity selection
      async function selectEntity(entityId) {
        toggleMenu(false);
        trigger.focus();

        if (entityId && entityId !== EntityContext.entityId) {
          try {
            await EntityContext.setEntity(entityId);
          } catch (error) {
            console.error('Failed to switch entity:', error);
            alert(`Error switching entity: ${error.message}`);
          }
        }
      }

      // Event: Trigger click
      trigger.addEventListener('click', () => toggleMenu());

      // Event: Trigger keyboard
      trigger.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowDown') {
          e.preventDefault();
          toggleMenu(true);
        }
      });

      // Event: Menu click
      menu.addEventListener('click', async (e) => {
        const option = e.target.closest('[role="option"]');
        if (!option) return;

        const action = option.dataset.action;
        if (action === 'create') {
          toggleMenu(false);
          EntityModal.open();
          return;
        }

        const entityId = parseInt(option.dataset.entityId);
        if (!isNaN(entityId)) {
          await selectEntity(entityId);
        }
      });

      // Event: Menu keyboard navigation
      menu.addEventListener('keydown', async (e) => {
        const options = Array.from(menu.querySelectorAll('[role="option"]'));
        const currentIndex = options.indexOf(document.activeElement);

        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault();
            const nextIndex = Math.min(currentIndex + 1, options.length - 1);
            if (options[nextIndex]) options[nextIndex].focus();
            break;
          case 'ArrowUp':
            e.preventDefault();
            const prevIndex = Math.max(currentIndex - 1, 0);
            if (options[prevIndex]) options[prevIndex].focus();
            break;
          case 'Enter':
          case ' ':
            e.preventDefault();
            if (document.activeElement) document.activeElement.click();
            break;
          case 'Escape':
            e.preventDefault();
            toggleMenu(false);
            trigger.focus();
            break;
          case 'Tab':
            toggleMenu(false);
            break;
        }
      });

      // Event: Close on outside click (uses AbortController for cleanup on re-creation)
      document.addEventListener('click', (e) => {
        if (isOpen && !container.contains(e.target)) {
          toggleMenu(false);
        }
      }, { signal: _entitySwitcherAbort.signal });

      // Subscribe to EntityContext changes
      EntityContext.subscribe((entity) => {
        updateTrigger(entity);
      });

      // Initialize
      loadEntities();
      updateTrigger(EntityContext.current);

      // Return public API
      return {
        refresh: loadEntities,
        open: () => toggleMenu(true),
        close: () => toggleMenu(false)
      };
    }

    // Global reference for the entity switcher
    let entitySwitcher = null;

    // =====================================================
    // Dual Activity Detection (Phase 13-05)
    // =====================================================

    const DualActivityDetector = {
      // Detect if user has both Autonomo and SL entities
      async detect() {
        const entities = await EntityManager.getActiveEntities();

        const autonomoEntities = entities.filter(e => e.type === ENTITY_TYPE.AUTONOMO);
        const slEntities = entities.filter(e => e.type === ENTITY_TYPE.SOCIEDAD_LIMITADA);

        const hasAutonomo = autonomoEntities.length > 0;
        const hasSL = slEntities.length > 0;

        if (hasAutonomo && hasSL) {
          return {
            isDualActivity: true,
            autonomoEntities,
            slEntities,
            totalEntities: entities.length,
            message: 'Dual activity detected',
            explanation: 'As an autonomo who also manages a Sociedad Limitada, ' +
                         'you are considered an "autonomo societario". This means a minimum ' +
                         'contribution base of 1,000 EUR/month (quota ~315 EUR/month) instead of ' +
                         'the base according to your actual income.',
            impact: {
              minimumBaseCents: 100000,     // 1000 EUR
              minimumCuotaCents: 31500,     // 315 EUR (31.5% of 1000)
              note: 'The exact quota depends on the additional contribution type chosen.'
            }
          };
        }

        return {
          isDualActivity: false,
          autonomoEntities,
          slEntities,
          totalEntities: entities.length
        };
      },

      // Check and show warning if dual activity detected
      async checkAndWarn() {
        const result = await this.detect();

        if (result.isDualActivity) {
          this.showWarningBanner(result);
        } else {
          this.hideWarningBanner();
        }

        return result;
      },

      // Show warning banner in UI
      showWarningBanner(detectionResult) {
        // Remove existing banner if any
        this.hideWarningBanner();

        const banner = document.createElement('div');
        banner.id = 'dual-activity-warning';
        banner.className = 'dual-activity-warning';
        banner.setAttribute('role', 'alert');
        banner.innerHTML = `
          <div class="dual-activity-warning__icon">&#9888;</div>
          <div class="dual-activity-warning__content">
            <div class="dual-activity-warning__title">${escapeHtml(detectionResult.message)}</div>
            <div class="dual-activity-warning__text">${escapeHtml(detectionResult.explanation)}</div>
            <div class="dual-activity-warning__entities">
              <span class="dual-activity-warning__entity-count">
                &#128100; ${detectionResult.autonomoEntities.length} Autonomo${detectionResult.autonomoEntities.length > 1 ? 's' : ''} +
                &#127970; ${detectionResult.slEntities.length} S.L.${detectionResult.slEntities.length > 1 ? 's' : ''}
              </span>
            </div>
          </div>
          <button class="dual-activity-warning__dismiss" onclick="DualActivityDetector.dismissBanner()" aria-label="Close notice">
            &#10005;
          </button>
        `;

        // Insert after header or at top of content
        const header = document.querySelector('.dashboard-header') ||
                       document.querySelector('.entity-switcher-container')?.parentElement;
        if (header?.parentElement) {
          header.parentElement.insertBefore(banner, header.nextSibling);
        } else {
          document.body.insertBefore(banner, document.body.firstChild);
        }
      },

      // Hide warning banner
      hideWarningBanner() {
        const existing = document.getElementById('dual-activity-warning');
        if (existing) {
          existing.remove();
        }
      },

      // Dismiss banner (user action) - persists for session
      dismissBanner() {
        this.hideWarningBanner();
        sessionStorage.setItem('dual_activity_warning_dismissed', 'true');
      },

      // Check if banner was dismissed this session
      wasDismissed() {
        return sessionStorage.getItem('dual_activity_warning_dismissed') === 'true';
      },

      // Initialize on app load (respects dismissal)
      async initialize() {
        if (this.wasDismissed()) {
          return { isDualActivity: false, dismissed: true };
        }
        return this.checkAndWarn();
      }
    };

    // =====================================================
    // Database Initialization
    // =====================================================

    async function initializeDatabase() {
      const loadingScreen = document.getElementById('loading-screen');
      const loadingStatus = document.getElementById('loading-status');

      try {
        loadingScreen.classList.add('visible');

        // Step 0: Initialize Supabase (if configured)
        loadingStatus.textContent = 'Checking authentication...';
        const supabaseReady = initializeSupabase();
        if (supabaseReady) {
          await AuthManager.initialize();
        }

        // Step 1: Open database (triggers migrations if needed)
        loadingStatus.textContent = 'Opening database...';
        await db.open();
        DEBUG && console.log('Database opened:', db.name, 'version:', db.verno);

        // Step 2: Run maintenance (auto-purge old soft-deleted records)
        loadingStatus.textContent = 'Running maintenance...';
        const purged = await DataManager.autoPurgeOldRecords();
        if (purged.length > 0) {
          DEBUG && console.log('Auto-purge results:', purged);
        }

        // Step 3: Check sync status and create indicator
        loadingStatus.textContent = 'Checking sync status...';
        await SyncQueue.updateIndicator();

        // Step 4: Verify tables exist
        loadingStatus.textContent = 'Verifying schema...';
        const tables = db.tables.map(t => t.name);
        DEBUG && console.log('Database tables:', tables);

        // Step 5: Initialize entity context from persisted selection
        loadingStatus.textContent = 'Restoring session...';
        const entityRestored = await EntityContext.initialize();
        if (entityRestored) {
          DEBUG && console.log('Restored entity:', EntityContext.current?.name);
        }

        // Step 5.5: Migrate localStorage calendar to IndexedDB (Phase 16)
        // Only runs if entity is selected (migration is entity-scoped)
        if (EntityContext.entityId) {
          loadingStatus.textContent = 'Migrating calendar data...';
          await migrateCalendarToIndexedDB();
        }

        // Step 6: Check for dual activity on startup (Phase 13-05)
        loadingStatus.textContent = 'Checking entity configuration...';
        await DualActivityDetector.initialize();

        // Success
        loadingScreen.classList.remove('visible');
        DEBUG && console.log('Database initialized successfully');
        return true;

      } catch (error) {
        console.error('Database initialization failed:', error);
        loadingStatus.textContent = `Error: ${error.message}`;
        loadingStatus.classList.add('error');
        return false;
      }
    }

    // Initialize on page load
    let _appInitialized = false;
    document.addEventListener('DOMContentLoaded', async () => {
      // Guard against redundant initialization (multiple DOMContentLoaded or re-entry)
      if (_appInitialized) {
        console.warn('[INIT] Already initialized, skipping redundant init cycle');
        return;
      }
      _appInitialized = true;

      // Phase 12: Initialize database first
      const dbSuccess = await initializeDatabase();
      if (!dbSuccess) {
        console.warn('Database initialization failed, continuing with limited functionality');
      }

      // Phase 13: Initialize entity modal
      EntityModal.init();

      // Phase 14-03: Initialize Auth UI
      AuthUI.init();

      // Phase 14-03: Initialize User Menu
      UserMenuUI.init();

      // Phase 14-05: Initialize Invite UI
      InviteUI.init();

      // Phase 14-06: Initialize Permission UI
      PermissionUI.init();

      // Phase 17-04: Initialize expense list listeners and populate filters
      _initExpenseListListeners();
      await populateExpenseFilters();

      // Phase 18-04: Initialize invoice list listeners
      _initInvoiceListListeners();

      // Phase 15: Initialize Client UI
      ClientListUI.init();
      ClientFormUI.init();
      ClientDetailUI.init();
      ContactFormUI.init();
      ProjectFormUI.init();

      // Phase 14-05: Subscribe to entity changes for sharing section
      EntityContext.subscribe(async (entity) => {
        const sharingSection = document.getElementById('sharing-section');
        if (sharingSection) {
          if (entity && AuthManager.isAuthenticated()) {
            sharingSection.style.display = '';
            await SharingUI.load();
          } else {
            sharingSection.style.display = 'none';
          }
        }
      });

      // Phase 13-04: Initialize entity switcher
      const switcherContainer = document.getElementById('entity-switcher-container');
      if (switcherContainer) {
        entitySwitcher = createEntitySwitcher('entity-switcher-container');
      }

      // Auto-create demo entity if in offline mode with no entities
      if (AuthManager.isOfflineMode() && db) {
        const entities = await EntityManager.getActiveEntities();
        if (entities.length === 0) {
          DEBUG && console.log('[INIT] No entities found in offline mode, creating demo entity...');
          try {
            const demoEntityId = await db.entities.add({
              type: 'autonomo',
              name: 'Demo Business',
              nif_cif: '12345678Z',
              domicilio_fiscal: 'Demo Street 123, Madrid',
              owner_id: null,
              is_active: true,
              created_at: new Date().toISOString(),
              updated_at: new Date().toISOString(),
              deleted_at: null
            });
            DEBUG && console.log('[INIT] Demo entity created:', demoEntityId);
            await EntityContext.setEntity(demoEntityId);
            if (entitySwitcher && entitySwitcher.refresh) {
              await entitySwitcher.refresh();
            }
          } catch (err) {
            console.error('[INIT] Failed to create demo entity:', err);
          }
        }
      }

      // Initialize scenario state
      scenarioState = initScenarioState();

      // Existing Phase 2 initialization
      renderAllSections();
      recalculateTotals();

      // Phase 3 initialization
      renderScenarioCards();
      renderComparisonTable();
      initEditDialog();
      initTemplateDialog();

      // Phase 4 initialization - Calendar
      renderCalendar();
      updateCountDisplays();  // Initialize count displays
      showContractedWizard(); // Show wizard if not yet applied

      // Phase 7 initialization - Compliance
      renderComplianceContent();
      updateComplianceWarning();

      // Phase 8 initialization - Income
      renderIncomeList();

      // Phase 17-04: Initial expense list render
      renderExpenseList();

      // Phase 8 initialization - Details tab source hints (ENH-03)
      initDetailsSourceHints();

      // Phase 8 - Income dialog: close on backdrop click
      const incomeDialog = document.getElementById('incomeDialog');
      if (incomeDialog) {
        incomeDialog.addEventListener('click', (e) => {
          if (e.target === incomeDialog) {
            closeIncomeDialog();
          }
        });
      }

      // Phase 7.1 - Tooltip modal: close on backdrop click
      const tooltipModal = document.getElementById('tooltipModal');
      if (tooltipModal) {
        tooltipModal.addEventListener('click', (e) => {
          if (e.target === tooltipModal) {
            tooltipModal.close();
          }
        });
      }

      // Phase 7.2 - Expense dialog: close on backdrop click
      const expenseDialog = document.getElementById('addExpenseDialog');
      if (expenseDialog) {
        expenseDialog.addEventListener('click', (e) => {
          if (e.target === expenseDialog) {
            hideAddForm();
          }
        });
      }

      // Phase 16-06: Initialize Google Calendar sync
      // Check if Google API library is loaded, then initialize
      if (typeof gapi !== 'undefined') {
        initGapi();
      } else {
        // Wait for async script to load
        window.addEventListener('load', () => {
          if (typeof gapi !== 'undefined') {
            initGapi();
          }
        });
      }

      // Check if Google Identity Services is loaded
      if (typeof google !== 'undefined' && google.accounts) {
        initGis();
      } else {
        // Wait for async script to load
        window.addEventListener('load', () => {
          if (typeof google !== 'undefined' && google.accounts) {
            initGis();
          }
        });
      }

      // Initialize GCal UI state (shows "not configured" if CLIENT_ID missing)
      updateGCalUI();
    });

    // ============================================================
    // =====================================================
    // PHASE 18: Invoice Form Handlers
    // =====================================================

    /**
     * createInvoiceForClient - Open invoice form pre-populated with current client
     * Called from the client detail invoices tab "+ Invoice" button.
     */
    async function createInvoiceForClient() {
      const clientId = ClientDetailUI.clientId;
      if (!clientId) {
        showNotification('No client selected', 'error');
        return;
      }

      // Switch to invoices tab
      const tabInvoices = document.getElementById('tab-invoices');
      if (tabInvoices) {
        tabInvoices.checked = true;
        tabInvoices.dispatchEvent(new Event('change'));
      }

      // Open the invoice form - it will be populated below
      await openInvoiceForm(null);

      // Pre-select this client in the form
      const clientSelect = document.getElementById('invoiceClient');
      if (clientSelect) {
        clientSelect.value = String(clientId);
        // Trigger client change to update IVA treatment, IRPF, etc.
        await handleInvoiceClientChange();
      }
    }

    /**
     * navigateToInvoiceDetail - Navigate from client detail to invoice detail view
     * Switches to invoices tab and shows the invoice detail.
     * @param {number} invoiceId - Invoice ID to display
     */
    async function navigateToInvoiceDetail(invoiceId) {
      // Switch to invoices tab
      const tabInvoices = document.getElementById('tab-invoices');
      if (tabInvoices) {
        tabInvoices.checked = true;
        tabInvoices.dispatchEvent(new Event('change'));
      }

      // Small delay to ensure invoices tab is active
      await new Promise(resolve => setTimeout(resolve, 100));

      // Show the invoice detail
      await showInvoiceDetail(invoiceId);
    }

    /**
     * Open invoice form dialog in create or edit mode.
     * Populates client dropdown from current entity's active clients.
     * @param {number|null} invoiceId - Invoice ID for edit mode, null for create
     */
    async function openInvoiceForm(invoiceId = null) {
      const dialog = document.getElementById('invoiceDialog');
      if (!dialog) return;

      const titleEl = document.getElementById('invoiceDialogTitle');
      const clientSelect = document.getElementById('invoiceClient');
      const dateInput = document.getElementById('invoiceDate');
      const dueDateInput = document.getElementById('invoiceDueDate');
      const currencySelect = document.getElementById('invoiceCurrency');
      const exchangeRateGroup = document.getElementById('exchangeRateGroup');
      const exchangeRateInput = document.getElementById('invoiceExchangeRate');
      const irpfGroup = document.getElementById('irpfGroup');
      const irpfSelect = document.getElementById('invoiceIrpf');
      const discountTypeSelect = document.getElementById('invoiceDiscountType');
      const discountValueInput = document.getElementById('invoiceDiscountValue');
      const notesTextarea = document.getElementById('invoiceNotes');
      const lineItemsBody = document.getElementById('invoiceLineItemsBody');
      const ivaTreatmentDiv = document.getElementById('invoiceIvaTreatment');
      const calPopSection = document.getElementById('calendarPopulateSection');
      const addFromProjectBtn = document.getElementById('addFromProjectBtn');
      const addFromExpenseBtn = document.getElementById('addFromExpenseBtn');

      // Populate client dropdown from current entity's active clients
      try {
        const clients = await ClientManager.getClients();
        clientSelect.innerHTML = '<option value="">Select client...</option>';
        clients.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = _escapeHtml(c.name);
          clientSelect.appendChild(opt);
        });
      } catch (err) {
        console.error('Failed to load clients for invoice form:', err);
      }

      if (invoiceId) {
        // Edit mode
        dialog.dataset.editId = String(invoiceId);
        await populateInvoiceFormForEdit(invoiceId);
      } else {
        // Create mode - reset all fields
        dialog.dataset.editId = '';
        titleEl.textContent = 'New Invoice';
        clientSelect.value = '';

        // Set dates: today + 30 days
        const today = new Date();
        dateInput.value = today.toISOString().split('T')[0];
        const dueDate = new Date(today);
        dueDate.setDate(dueDate.getDate() + 30);
        dueDateInput.value = dueDate.toISOString().split('T')[0];

        // Reset currency
        currencySelect.value = 'EUR';
        exchangeRateGroup.style.display = 'none';
        exchangeRateInput.value = '1';

        // Reset IRPF
        irpfGroup.style.display = 'none';
        irpfSelect.value = '0';

        // Reset discount
        discountTypeSelect.value = '';
        discountValueInput.value = '0';
        discountValueInput.style.display = 'none';

        // Reset notes
        notesTextarea.value = '';

        // Clear line items
        lineItemsBody.innerHTML = '';

        // Reset IVA treatment info
        ivaTreatmentDiv.style.display = 'none';
        ivaTreatmentDiv.innerHTML = '';

        // Hide calendar/project/expense buttons
        if (calPopSection) calPopSection.style.display = 'none';
        if (addFromProjectBtn) addFromProjectBtn.style.display = 'none';
        if (addFromExpenseBtn) addFromExpenseBtn.style.display = 'none';

        // Reset totals display
        document.getElementById('invoiceFormSubtotal').textContent = '0.00';
        document.getElementById('invoiceFormDiscount').textContent = '-0.00';
        document.getElementById('invoiceFormIva').textContent = '0.00';
        document.getElementById('invoiceFormIrpf').textContent = '-0.00';
        document.getElementById('invoiceFormTotal').textContent = '0.00';
        document.getElementById('discountRow').style.display = 'none';
        document.getElementById('irpfRow').style.display = 'none';
        document.getElementById('invoiceIvaLabel').textContent = 'IVA (21%):';
      }

      dialog.showModal();
    }

    /**
     * Close invoice form dialog and clear edit state.
     */
    function closeInvoiceForm() {
      const dialog = document.getElementById('invoiceDialog');
      if (dialog && dialog.open) dialog.close();
      dialog.dataset.editId = '';
    }

    // =====================================================
    // PHASE 18: Invoice List & Detail Handlers (18-04)
    // =====================================================

    /** Invoice client name cache (avoids N+1 queries) */
    let _invoiceClientNameCache = new Map();
    let _invoiceClientCacheEntityId = null;

    /**
     * _loadInvoiceClientNameCache - Batch-load client names for invoice rendering
     * Rebuilds cache when entity changes. Avoids N+1 queries.
     * @returns {Promise<Map<number, Object>>}
     */
    async function _loadInvoiceClientNameCache() {
      const currentEntityId = EntityContext.entityId;
      if (_invoiceClientCacheEntityId === currentEntityId && _invoiceClientNameCache.size > 0) {
        return _invoiceClientNameCache;
      }
      try {
        const clients = await ClientManager.getClients({});
        _invoiceClientNameCache = new Map(clients.map(c => [c.id, { name: c.name, country_code: c.country_code }]));
        _invoiceClientCacheEntityId = currentEntityId;
      } catch (err) {
        console.warn('Failed to load client names for invoice list:', err);
        _invoiceClientNameCache = new Map();
      }
      return _invoiceClientNameCache;
    }

    /**
     * renderInvoiceList - Full invoice list rendering with filters and summary
     * Renders desktop table + mobile cards, applies filters, updates summary bar.
     */
    async function renderInvoiceList() {
      const tableBody = document.getElementById('invoiceTableBody');
      const cardsContainer = document.getElementById('invoiceCards');
      const emptyState = document.getElementById('invoiceEmptyState');
      const emptyText = document.getElementById('invoiceEmptyText');
      const table = document.getElementById('invoiceTable');

      if (!tableBody) return;

      const entityId = EntityContext.entityId;
      if (!entityId) {
        tableBody.innerHTML = '';
        if (cardsContainer) cardsContainer.innerHTML = '';
        if (emptyState) {
          emptyState.style.display = '';
          emptyText.textContent = 'Select an entity to view invoices.';
        }
        if (table) table.style.display = 'none';
        renderInvoiceSummary([]);
        renderOverdueAlert([]);
        return;
      }

      try {
        // Get all invoices for entity (unfiltered for summary)
        const allInvoices = await InvoiceManager.getInvoices(entityId);

        // Read filter values
        const filterClient = document.getElementById('invoiceFilterClient')?.value || '';
        const filterStatus = document.getElementById('invoiceFilterStatus')?.value || '';
        const filterMonth = document.getElementById('invoiceFilterMonth')?.value || '';
        const filterProject = document.getElementById('invoiceFilterProject')?.value || '';
        const hasActiveFilters = filterClient || filterStatus || filterMonth || filterProject;

        // Apply filters
        let filtered = allInvoices;

        if (filterClient) {
          const clientId = parseInt(filterClient, 10);
          filtered = filtered.filter(inv => inv.client_id === clientId);
        }

        if (filterStatus) {
          if (filterStatus === 'overdue') {
            filtered = filtered.filter(inv => inv.status === 'sent' && InvoiceManager.isOverdue(inv));
          } else {
            filtered = filtered.filter(inv => inv.status === filterStatus);
          }
        }

        if (filterMonth) {
          filtered = filtered.filter(inv => inv.date_issued && inv.date_issued.substring(0, 7) === filterMonth);
        }

        if (filterProject) {
          const projectId = parseInt(filterProject, 10);
          const filteredWithLines = [];
          for (const inv of filtered) {
            const lines = await InvoiceManager.getLineItems(inv.id);
            if (lines.some(line => line.project_id === projectId)) {
              filteredWithLines.push(inv);
            }
          }
          filtered = filteredWithLines;
        }

        // Load client names for display
        const clientCache = await _loadInvoiceClientNameCache();

        // Render summary and overdue alert with ALL invoices (unfiltered)
        renderInvoiceSummary(allInvoices);
        renderOverdueAlert(allInvoices);

        // Handle empty state
        if (filtered.length === 0) {
          tableBody.innerHTML = '';
          if (cardsContainer) cardsContainer.innerHTML = '';
          if (table) table.style.display = 'none';
          if (emptyState) {
            emptyState.style.display = '';
            emptyText.textContent = hasActiveFilters
              ? 'No invoices match the current filters.'
              : 'No invoices yet. Create your first invoice.';
          }
          return;
        }

        // Show table, hide empty state
        if (table) table.style.display = '';
        if (emptyState) emptyState.style.display = 'none';

        // Build table rows (desktop) and cards (mobile)
        let tableRows = '';
        let cards = '';

        for (const inv of filtered) {
          const clientInfo = clientCache.get(inv.client_id);
          const clientName = clientInfo ? _escapeHtml(clientInfo.name) : 'Unknown';
          const dateDisplay = formatDateEU(inv.date_issued);
          const dueDateDisplay = inv.date_due ? formatDateEU(inv.date_due) : '-';
          const totalDisplay = MoneyUtils.formatEuros(inv.total_cents || 0);
          const invNumber = _escapeHtml(inv.invoice_number || '');

          // Determine badge class
          const isOverdue = inv.status === 'sent' && InvoiceManager.isOverdue(inv);
          let badgeClass = 'badge-draft';
          let badgeText = 'Draft';
          if (inv.status === 'sent') {
            if (isOverdue) {
              badgeClass = 'badge-overdue';
              badgeText = 'Overdue';
            } else {
              badgeClass = 'badge-sent';
              badgeText = 'Sent';
            }
          } else if (inv.status === 'paid') {
            badgeClass = 'badge-paid';
            badgeText = 'Paid';
          } else if (inv.status === 'archived') {
            badgeClass = 'badge-draft';
            badgeText = 'Archived';
          }

          // Action buttons based on status
          let actionsHtml = `<button onclick="event.stopPropagation(); showInvoiceDetail(${inv.id})" title="View">View</button>`;
          if (inv.status === 'draft') {
            actionsHtml += ` <button data-permission="edit" onclick="event.stopPropagation(); openInvoiceForm(${inv.id})" title="Edit">Edit</button>`;
            actionsHtml += ` <button data-permission="delete" onclick="event.stopPropagation(); handleArchiveInvoice(${inv.id})" title="Archive" style="color: var(--negative);">Del</button>`;
          }

          // Table row (desktop)
          tableRows += `
            <tr onclick="showInvoiceDetail(${inv.id})">
              <td class="mono">${invNumber}</td>
              <td>${clientName}</td>
              <td>${dateDisplay}</td>
              <td>${dueDateDisplay}</td>
              <td class="text-right mono">${totalDisplay}</td>
              <td><span class="invoice-status-badge ${badgeClass}">${badgeText}</span></td>
              <td><div class="invoice-actions">${actionsHtml}</div></td>
            </tr>`;

          // Mobile card
          cards += `
            <div class="invoice-card" onclick="showInvoiceDetail(${inv.id})">
              <div class="invoice-card-header">
                <span class="invoice-card-number">${invNumber}</span>
                <span class="invoice-status-badge ${badgeClass}">${badgeText}</span>
              </div>
              <div class="invoice-card-client">${clientName}</div>
              <div class="invoice-card-footer">
                <span class="invoice-card-total">${totalDisplay}</span>
                <span class="invoice-card-date">${dateDisplay}</span>
              </div>
            </div>`;
        }

        tableBody.innerHTML = tableRows;
        if (cardsContainer) cardsContainer.innerHTML = cards;

        // Apply permission enforcement after rendering invoice actions
        if (typeof PermissionUI !== 'undefined' && PermissionUI.applyPermissions) {
          PermissionUI.applyPermissions();
        }

      } catch (err) {
        console.error('Failed to render invoice list:', err);
        tableBody.innerHTML = '';
        if (cardsContainer) cardsContainer.innerHTML = '';
      }
    }

    /**
     * renderInvoiceSummary - Updates the summary bar with invoice totals
     * @param {Array} invoices - ALL invoices (unfiltered) for current entity
     */
    function renderInvoiceSummary(invoices) {
      const totalEl = document.getElementById('invoiceSummaryTotal');
      const outstandingEl = document.getElementById('invoiceSummaryOutstanding');
      const overdueEl = document.getElementById('invoiceSummaryOverdue');
      const paidEl = document.getElementById('invoiceSummaryPaid');

      if (!totalEl) return;

      let totalCents = 0;
      let outstandingCents = 0;
      let overdueCents = 0;
      let overdueCount = 0;
      let paidCents = 0;

      for (const inv of invoices) {
        if (inv.status === 'archived') continue;

        totalCents += inv.total_cents || 0;

        if (inv.status === 'sent') {
          outstandingCents += (inv.total_cents || 0) - (inv.paid_cents || 0);
          if (InvoiceManager.isOverdue(inv)) {
            overdueCount++;
            overdueCents += (inv.total_cents || 0) - (inv.paid_cents || 0);
          }
        }

        if (inv.status === 'paid') {
          paidCents += inv.total_cents || 0;
        }
      }

      totalEl.textContent = MoneyUtils.formatEuros(totalCents);
      outstandingEl.textContent = MoneyUtils.formatEuros(outstandingCents);
      paidEl.textContent = MoneyUtils.formatEuros(paidCents);

      if (overdueCount > 0) {
        overdueEl.textContent = `${overdueCount} (${MoneyUtils.formatEuros(overdueCents)})`;
      } else {
        overdueEl.textContent = MoneyUtils.formatEuros(0);
      }
    }

    /**
     * renderOverdueAlert - Shows/hides the overdue alert banner
     * @param {Array} invoices - ALL invoices (unfiltered) for current entity
     */
    function renderOverdueAlert(invoices) {
      const alertDiv = document.getElementById('overdue-alert');
      const alertText = document.getElementById('overdue-alert-text');
      if (!alertDiv) return;

      const overdueInvoices = invoices.filter(inv =>
        inv.status === 'sent' && InvoiceManager.isOverdue(inv)
      );

      if (overdueInvoices.length > 0) {
        const totalOverdueCents = overdueInvoices.reduce(
          (sum, inv) => sum + ((inv.total_cents || 0) - (inv.paid_cents || 0)), 0
        );
        alertText.textContent = `${overdueInvoices.length} overdue invoice${overdueInvoices.length > 1 ? 's' : ''} totalling ${MoneyUtils.formatEuros(totalOverdueCents)}`;
        alertDiv.style.display = '';
      } else {
        alertDiv.style.display = 'none';
      }
    }

    /**
     * populateInvoiceFilters - Populate client and project filter dropdowns
     * Called when invoices tab is activated and on entity change.
     */
    async function populateInvoiceFilters() {
      // Populate client filter
      const clientSelect = document.getElementById('invoiceFilterClient');
      if (clientSelect) {
        const currentValue = clientSelect.value;
        let optionsHtml = '<option value="">All Clients</option>';
        try {
          const clients = await ClientManager.getClients({});
          for (const client of clients) {
            optionsHtml += `<option value="${client.id}">${_escapeHtml(client.name)}</option>`;
          }
        } catch (err) {
          console.warn('Failed to load clients for invoice filter:', err);
        }
        clientSelect.innerHTML = optionsHtml;
        if (currentValue) clientSelect.value = currentValue;
      }

      // Populate project filter
      const projectSelect = document.getElementById('invoiceFilterProject');
      if (projectSelect) {
        const currentValue = projectSelect.value;
        let optionsHtml = '<option value="">All Projects</option>';
        try {
          const projects = await ProjectManager.getProjects({});
          for (const project of projects) {
            optionsHtml += `<option value="${project.id}">${_escapeHtml(project.name)}</option>`;
          }
        } catch (err) {
          console.warn('Failed to load projects for invoice filter:', err);
        }
        projectSelect.innerHTML = optionsHtml;
        if (currentValue) projectSelect.value = currentValue;
      }
    }

    /**
     * showInvoiceList - Returns to invoice list view from detail view
     * Hides detail view, shows list view, and re-renders the list.
     */
    function showInvoiceList() {
      const listView = document.getElementById('invoice-list-view');
      const detailView = document.getElementById('invoice-detail-view');
      if (listView) listView.style.display = '';
      if (detailView) detailView.style.display = 'none';
      renderInvoiceList();
    }

    /**
     * _initInvoiceListListeners - Initialize invoice list event listeners
     * Subscribes to EntityContext changes and tab activation.
     */
    function _initInvoiceListListeners() {
      // Subscribe to entity changes: invalidate cache and re-render
      EntityContext.subscribe(async () => {
        _invoiceClientCacheEntityId = null;
        _invoiceClientNameCache = new Map();
        // Only re-render if invoice tab is active
        const tabInvoices = document.getElementById('tab-invoices');
        if (tabInvoices && tabInvoices.checked) {
          await populateInvoiceFilters();
          await renderInvoiceList();
        }
      });

      // Listen for tab-invoices radio change to trigger load on activation
      const tabInvoices = document.getElementById('tab-invoices');
      if (tabInvoices) {
        tabInvoices.addEventListener('change', async () => {
          if (tabInvoices.checked) {
            await populateInvoiceFilters();
            await renderInvoiceList();
          }
        });
      }

      // Keyboard shortcut: Escape in detail view returns to list (if no dialog open)
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          const detailView = document.getElementById('invoice-detail-view');
          if (detailView && detailView.style.display !== 'none') {
            const openDialogs = document.querySelectorAll('dialog[open]');
            if (openDialogs.length === 0) {
              showInvoiceList();
            }
          }
        }
      });
    }

    /**
     * Handle client selection change in invoice form.
     * Auto-sets IVA treatment, shows/hides IRPF, populates project/calendar buttons.
     */
    async function handleInvoiceClientChange() {
      const clientSelect = document.getElementById('invoiceClient');
      const clientId = parseInt(clientSelect.value, 10);
      const ivaTreatmentDiv = document.getElementById('invoiceIvaTreatment');
      const irpfGroup = document.getElementById('irpfGroup');
      const irpfSelect = document.getElementById('invoiceIrpf');
      const calPopSection = document.getElementById('calendarPopulateSection');
      const calPopInfo = document.getElementById('calendarPopulateInfo');
      const addFromProjectBtn = document.getElementById('addFromProjectBtn');
      const addFromExpenseBtn = document.getElementById('addFromExpenseBtn');

      if (!clientId || isNaN(clientId)) {
        // No client selected - hide everything
        ivaTreatmentDiv.style.display = 'none';
        irpfGroup.style.display = 'none';
        if (calPopSection) calPopSection.style.display = 'none';
        if (addFromProjectBtn) addFromProjectBtn.style.display = 'none';
        if (addFromExpenseBtn) addFromExpenseBtn.style.display = 'none';
        recalculateInvoiceFormTotals();
        return;
      }

      try {
        const client = await ClientManager.getClient(clientId);
        if (!client) return;

        // IVA treatment lookup
        const treatment = IVA_TREATMENT[client.category];
        if (treatment) {
          let html = '<strong>' + _escapeHtml(treatment.label) + '</strong>';
          if (treatment.legalText) {
            html += '<br><small>' + _escapeHtml(treatment.legalText) + '</small>';
          }
          ivaTreatmentDiv.innerHTML = html;
          ivaTreatmentDiv.style.display = '';

          // Update all existing line item IVA rate inputs
          const lineItemsBody = document.getElementById('invoiceLineItemsBody');
          const rows = lineItemsBody ? lineItemsBody.querySelectorAll('tr') : [];
          rows.forEach(row => {
            const ivaInput = row.querySelector('.line-iva-rate');
            if (ivaInput) {
              ivaInput.value = (treatment.rate * 100).toFixed(0);
            }
          });
        }

        // IRPF: only if entity is autonomo AND client is Spanish
        const entity = EntityContext.current;
        const isAutonomo = entity && entity.type === 'autonomo';
        const isSpanishClient = client.category === CLIENT_CATEGORY.SPAIN;

        if (isAutonomo && isSpanishClient) {
          irpfGroup.style.display = '';
        } else {
          irpfGroup.style.display = 'none';
          irpfSelect.value = '0';
        }

        // Check for client projects
        const projects = await ProjectManager.getProjectsByClient(clientId);
        if (addFromProjectBtn) {
          addFromProjectBtn.style.display = projects.length > 0 ? '' : 'none';
        }

        // Check for calendar days for this client
        const entityId = EntityContext.entityId;
        if (entityId && calPopSection) {
          const calDays = await db.calendar_days
            .where('entity_id').equals(entityId)
            .filter(d => d.client_id === clientId)
            .count();
          if (calDays > 0) {
            calPopSection.style.display = '';
            if (calPopInfo) calPopInfo.textContent = calDays + ' calendar day' + (calDays !== 1 ? 's' : '') + ' found';
          } else {
            calPopSection.style.display = 'none';
          }
        }

        // Show expense button if client has billable expenses
        if (addFromExpenseBtn) {
          try {
            const billableExpenses = await db.expenses
              .where('entity_id').equals(EntityContext.entityId)
              .filter(e => e.client_id === clientId && e.is_billable && !e.deleted_at)
              .count();
            addFromExpenseBtn.style.display = billableExpenses > 0 ? '' : 'none';
          } catch (e) {
            addFromExpenseBtn.style.display = 'none';
          }
        }

        recalculateInvoiceFormTotals();
      } catch (err) {
        console.error('Error handling client change:', err);
      }
    }

    /**
     * Handle currency selection change.
     * Shows/hides exchange rate field and auto-fetches rate for non-EUR currencies.
     */
    function handleInvoiceCurrencyChange() {
      const currencySelect = document.getElementById('invoiceCurrency');
      const currency = currencySelect.value;
      const exchangeGroup = document.getElementById('exchangeRateGroup');
      const exchangeRateInput = document.getElementById('invoiceExchangeRate');

      if (currency !== 'EUR') {
        exchangeGroup.style.display = '';
        // Auto-fetch exchange rate
        fetchExchangeRateForInvoice();
      } else {
        exchangeGroup.style.display = 'none';
        exchangeRateInput.value = '1';
      }
      recalculateInvoiceFormTotals();
    }

    /**
     * Fetch exchange rate from API for the selected currency.
     * Falls back to manual entry if API unavailable.
     */
    async function fetchExchangeRateForInvoice() {
      const currencySelect = document.getElementById('invoiceCurrency');
      const exchangeRateInput = document.getElementById('invoiceExchangeRate');
      const currency = currencySelect.value;

      if (currency === 'EUR') {
        exchangeRateInput.value = '1';
        return;
      }

      try {
        const rate = await InvoiceManager.fetchExchangeRate(currency, 'EUR');
        if (rate !== null) {
          exchangeRateInput.value = rate.toFixed(4);
        } else {
          // API failed - notify user to enter manually
          exchangeRateInput.placeholder = 'Enter rate manually';
          console.warn('Exchange rate API unavailable. Please enter rate manually.');
        }
      } catch (err) {
        console.warn('Failed to fetch exchange rate:', err.message);
        exchangeRateInput.placeholder = 'Enter rate manually';
      }
    }

    /**
     * Add a line item row to the invoice form.
     * @param {Object|null} prefill - Optional prefill data
     * @param {string} [prefill.description] - Line item description
     * @param {number} [prefill.quantity] - Quantity (default 1)
     * @param {number} [prefill.unit_price] - Unit price in euros (default 0)
     * @param {number} [prefill.project_id] - Associated project ID
     */
    function addInvoiceLineItem(prefill = null) {
      const lineItemsBody = document.getElementById('invoiceLineItemsBody');
      if (!lineItemsBody) return;

      // Determine IVA rate from currently selected client
      let ivaRateDisplay = 21; // default
      const clientSelect = document.getElementById('invoiceClient');
      const clientId = parseInt(clientSelect.value, 10);
      if (clientId && !isNaN(clientId)) {
        // Synchronous lookup from existing IVA treatment display
        const ivaTreatmentDiv = document.getElementById('invoiceIvaTreatment');
        if (ivaTreatmentDiv && ivaTreatmentDiv.style.display !== 'none') {
          // Extract rate from stored treatment - we need async lookup
          // Instead, parse from the IVA label if available
          const ivaLabel = document.getElementById('invoiceIvaLabel');
          if (ivaLabel) {
            const match = ivaLabel.textContent.match(/(\d+)%/);
            if (match) ivaRateDisplay = parseInt(match[1], 10);
          }
        }
      }

      const tr = document.createElement('tr');
      tr.className = 'line-item-row';
      if (prefill && prefill.project_id) {
        tr.dataset.projectId = prefill.project_id;
      }

      const desc = prefill && prefill.description ? _escapeHtml(prefill.description) : '';
      const qty = prefill && prefill.quantity != null ? prefill.quantity : 1;
      const unitPrice = prefill && prefill.unit_price != null ? Number(prefill.unit_price).toFixed(2) : '0.00';

      tr.innerHTML = `
        <td><input type="text" class="line-description" value="${desc}" placeholder="Service description..." oninput="recalculateInvoiceFormTotals()"></td>
        <td><input type="number" class="line-quantity text-right" value="${qty}" step="0.5" min="0" oninput="recalculateInvoiceFormTotals()"></td>
        <td><input type="number" class="line-unit-price text-right" value="${unitPrice}" step="0.01" min="0" oninput="recalculateInvoiceFormTotals()"></td>
        <td><input type="number" class="line-iva-rate text-right" value="${ivaRateDisplay}" readonly tabindex="-1"></td>
        <td><span class="line-total text-right mono">0.00</span></td>
        <td><button type="button" class="btn-remove-line" onclick="removeInvoiceLineItem(this.closest('tr'))" title="Remove line">&times;</button></td>
      `;

      lineItemsBody.appendChild(tr);
      recalculateInvoiceFormTotals();

      // Focus the description field of the new row
      const descInput = tr.querySelector('.line-description');
      if (descInput) descInput.focus();
    }

    /**
     * Remove a line item row from the invoice form.
     * @param {HTMLElement} rowElement - The tr element to remove
     */
    function removeInvoiceLineItem(rowElement) {
      if (rowElement && rowElement.parentNode) {
        rowElement.parentNode.removeChild(rowElement);
        recalculateInvoiceFormTotals();
      }
    }

    /**
     * Recalculate all invoice form totals live.
     * Iterates line items, applies discount, IVA, IRPF.
     * Updates all display spans.
     */
    function recalculateInvoiceFormTotals() {
      const lineItemsBody = document.getElementById('invoiceLineItemsBody');
      const rows = lineItemsBody ? lineItemsBody.querySelectorAll('tr.line-item-row') : [];

      let subtotalCents = 0;
      let ivaRateDecimal = 0.21; // Default

      // Read IVA rate from first line item (all should be the same)
      if (rows.length > 0) {
        const firstIva = rows[0].querySelector('.line-iva-rate');
        if (firstIva) {
          ivaRateDecimal = parseFloat(firstIva.value) / 100 || 0;
        }
      }

      // Calculate each line total and sum subtotal
      rows.forEach(row => {
        const qtyInput = row.querySelector('.line-quantity');
        const priceInput = row.querySelector('.line-unit-price');
        const totalSpan = row.querySelector('.line-total');

        const qty = parseFloat(qtyInput?.value) || 0;
        const price = parseFloat(priceInput?.value) || 0;

        // Convert to cents for calculation
        const priceCents = MoneyUtils.eurosToCents(price);
        const lineTotalCents = MoneyUtils.roundCents(qty * priceCents);

        // Display line total in euros
        if (totalSpan) {
          totalSpan.textContent = MoneyUtils.centsToEuros(lineTotalCents).toFixed(2);
        }

        subtotalCents += lineTotalCents;
      });

      // Read discount
      const discountType = document.getElementById('invoiceDiscountType')?.value || '';
      const discountValueInput = document.getElementById('invoiceDiscountValue');
      const discountValue = parseFloat(discountValueInput?.value) || 0;

      // Show/hide discount value input based on type
      if (discountValueInput) {
        if (discountType === '') {
          discountValueInput.style.display = 'none';
        } else {
          discountValueInput.style.display = '';
          discountValueInput.placeholder = discountType === 'percentage' ? '%' : 'EUR';
        }
      }

      let discountCents = 0;
      if (discountType === 'percentage' && discountValue > 0) {
        discountCents = MoneyUtils.roundCents(subtotalCents * discountValue / 100);
      } else if (discountType === 'fixed' && discountValue > 0) {
        discountCents = MoneyUtils.eurosToCents(discountValue);
      }

      const discountedSubtotalCents = subtotalCents - discountCents;

      // Calculate IVA
      const ivaCents = MoneyUtils.calculateIVA(discountedSubtotalCents, ivaRateDecimal);

      // Calculate IRPF
      const irpfSelect = document.getElementById('invoiceIrpf');
      const irpfRate = parseFloat(irpfSelect?.value) || 0;
      let irpfCents = 0;
      if (irpfRate > 0) {
        irpfCents = MoneyUtils.roundCents(discountedSubtotalCents * irpfRate / 100);
      }

      // Total = discounted subtotal + IVA - IRPF
      const totalCents = discountedSubtotalCents + ivaCents - irpfCents;

      // Update display spans
      document.getElementById('invoiceFormSubtotal').textContent = MoneyUtils.centsToEuros(subtotalCents).toFixed(2);
      document.getElementById('invoiceFormDiscount').textContent = '-' + MoneyUtils.centsToEuros(discountCents).toFixed(2);
      document.getElementById('invoiceFormIva').textContent = MoneyUtils.centsToEuros(ivaCents).toFixed(2);
      document.getElementById('invoiceFormIrpf').textContent = '-' + MoneyUtils.centsToEuros(irpfCents).toFixed(2);
      document.getElementById('invoiceFormTotal').textContent = MoneyUtils.centsToEuros(totalCents).toFixed(2);

      // Show/hide discount row
      const discountRow = document.getElementById('discountRow');
      if (discountRow) {
        discountRow.style.display = (discountType !== '' && discountCents > 0) ? '' : 'none';
      }

      // Show/hide IRPF row
      const irpfRow = document.getElementById('irpfRow');
      if (irpfRow) {
        irpfRow.style.display = irpfRate > 0 ? '' : 'none';
      }

      // Update IVA label with actual rate
      const ivaLabel = document.getElementById('invoiceIvaLabel');
      if (ivaLabel) {
        ivaLabel.textContent = 'IVA (' + (ivaRateDecimal * 100).toFixed(0) + '%):';
      }

      // Update IRPF label with actual rate
      const irpfLabel = document.getElementById('invoiceIrpfLabel');
      if (irpfLabel && irpfRate > 0) {
        irpfLabel.textContent = 'IRPF (' + irpfRate + '%):';
      }
    }

    /**
     * Handle discount type change - show/hide value input with appropriate placeholder.
     */
    function handleDiscountTypeChange() {
      const discountType = document.getElementById('invoiceDiscountType')?.value || '';
      const discountValueInput = document.getElementById('invoiceDiscountValue');

      if (discountValueInput) {
        if (discountType === '') {
          discountValueInput.style.display = 'none';
          discountValueInput.value = '0';
        } else {
          discountValueInput.style.display = '';
          discountValueInput.placeholder = discountType === 'percentage' ? '% off' : 'Amount in EUR';
        }
      }

      recalculateInvoiceFormTotals();
    }

    // =====================================================
    // PHASE 18: Invoice Save/Edit/Populate Handlers
    // =====================================================

    /**
     * Save or update an invoice from the form.
     * Creates new draft or updates existing draft. Validates required fields.
     * Persists line items to IndexedDB via InvoiceManager.
     */
    async function handleSaveInvoice() {
      const dialog = document.getElementById('invoiceDialog');
      const editId = dialog.dataset.editId ? parseInt(dialog.dataset.editId, 10) : null;

      // Read form values
      const clientSelect = document.getElementById('invoiceClient');
      const clientId = parseInt(clientSelect.value, 10);
      const dateIssued = document.getElementById('invoiceDate').value;
      const dateDue = document.getElementById('invoiceDueDate').value;
      const currency = document.getElementById('invoiceCurrency').value;
      const exchangeRate = parseFloat(document.getElementById('invoiceExchangeRate').value) || 1;
      const discountType = document.getElementById('invoiceDiscountType').value || null;
      const discountValue = parseFloat(document.getElementById('invoiceDiscountValue').value) || 0;
      const irpfRate = parseFloat(document.getElementById('invoiceIrpf').value) || 0;
      const notes = document.getElementById('invoiceNotes').value.trim();

      // Validation
      if (!clientId || isNaN(clientId)) {
        alert('Please select a client.');
        return;
      }

      // Collect line items from the form
      const lineItemsBody = document.getElementById('invoiceLineItemsBody');
      const rows = lineItemsBody ? lineItemsBody.querySelectorAll('tr.line-item-row') : [];

      if (rows.length === 0) {
        alert('Please add at least one line item.');
        return;
      }

      // Validate line items have required data
      const lineItems = [];
      let hasEmptyLine = false;
      rows.forEach((row, idx) => {
        const desc = row.querySelector('.line-description')?.value.trim() || '';
        const qty = parseFloat(row.querySelector('.line-quantity')?.value) || 0;
        const unitPriceEuros = parseFloat(row.querySelector('.line-unit-price')?.value) || 0;
        const ivaRate = parseFloat(row.querySelector('.line-iva-rate')?.value) || 0;
        const projectId = row.dataset.projectId ? parseInt(row.dataset.projectId, 10) : null;

        if (!desc || qty <= 0 || unitPriceEuros <= 0) {
          hasEmptyLine = true;
          return;
        }

        lineItems.push({
          description: desc,
          quantity: qty,
          unit_price_cents: MoneyUtils.eurosToCents(unitPriceEuros),
          iva_rate: ivaRate / 100, // Convert display % back to decimal
          project_id: projectId,
          sort_order: idx
        });
      });

      if (lineItems.length === 0) {
        alert('Line items must have a description, quantity > 0, and unit price > 0.');
        return;
      }

      if (hasEmptyLine && lineItems.length < rows.length) {
        const proceed = confirm('Some line items are incomplete and will be skipped. Continue?');
        if (!proceed) return;
      }

      try {
        let invoiceId;
        let invoiceNumber;

        if (editId) {
          // --- Edit mode: update existing draft ---
          invoiceId = editId;

          // Update invoice header fields
          await InvoiceManager.updateInvoice(invoiceId, {
            client_id: clientId,
            date_issued: dateIssued,
            date_due: dateDue || null,
            currency: currency,
            exchange_rate: exchangeRate,
            discount_type: discountType,
            discount_value: discountType === 'percentage' ? discountValue : (discountType === 'fixed' ? MoneyUtils.eurosToCents(discountValue) : 0),
            irpf_rate: irpfRate,
            notes: notes
          });

          // Delete existing line items and recreate (simpler than diffing)
          const existingLines = await InvoiceManager.getLineItems(invoiceId);
          for (const line of existingLines) {
            await db.invoice_lines.delete(line.id);
            await SyncQueue.queueChange('invoice_lines', line.id, 'DELETE', { id: line.id });
          }

          // Add all line items from form
          for (const item of lineItems) {
            await InvoiceManager.addLineItem(invoiceId, item);
          }

          const updated = await db.invoices.get(invoiceId);
          invoiceNumber = updated.invoice_number;
          DEBUG && console.log('Updated invoice:', invoiceNumber);

        } else {
          // --- Create mode: new draft invoice ---
          const result = await InvoiceManager.createInvoice({
            client_id: clientId,
            date_issued: dateIssued,
            date_due: dateDue || undefined,
            currency: currency,
            exchange_rate: exchangeRate,
            notes: notes
          });

          invoiceId = result.id;
          invoiceNumber = result.invoice_number;

          // Set discount and IRPF on the newly created invoice
          if (discountType || irpfRate > 0) {
            await InvoiceManager.updateInvoice(invoiceId, {
              discount_type: discountType,
              discount_value: discountType === 'percentage' ? discountValue : (discountType === 'fixed' ? MoneyUtils.eurosToCents(discountValue) : 0),
              irpf_rate: irpfRate
            });
          }

          // Add all line items from form
          for (const item of lineItems) {
            await InvoiceManager.addLineItem(invoiceId, item);
          }

          DEBUG && console.log('Created invoice:', invoiceNumber);
        }

        // Close dialog and refresh list
        closeInvoiceForm();
        renderInvoiceList();

        // Success notification
        showNotification(editId ? 'Invoice ' + invoiceNumber + ' updated' : 'Invoice ' + invoiceNumber + ' created', 'success');

      } catch (err) {
        console.error('Failed to save invoice:', err);
        showToast('Error saving invoice: ' + err.message, 'error');
      }
    }

    /**
     * Populate the invoice form for editing an existing invoice.
     * Loads invoice data and line items from IndexedDB.
     * @param {number} invoiceId - Invoice ID to edit
     */
    async function populateInvoiceFormForEdit(invoiceId) {
      try {
        const invoice = await InvoiceManager.getInvoice(invoiceId);
        if (!invoice) {
          alert('Invoice not found.');
          return;
        }

        // Check if invoice is editable (draft only)
        if (invoice.status !== InvoiceManager.STATUS.DRAFT) {
          alert('Only draft invoices can be edited. This invoice is ' + invoice.status + '.');
          closeInvoiceForm();
          return;
        }

        const titleEl = document.getElementById('invoiceDialogTitle');
        titleEl.textContent = 'Edit Invoice #' + _escapeHtml(invoice.invoice_number);

        // Populate form fields
        document.getElementById('invoiceClient').value = invoice.client_id;
        document.getElementById('invoiceDate').value = invoice.date_issued || '';
        document.getElementById('invoiceDueDate').value = invoice.date_due || '';
        document.getElementById('invoiceCurrency').value = invoice.currency || 'EUR';
        document.getElementById('invoiceExchangeRate').value = invoice.exchange_rate || 1;
        document.getElementById('invoiceNotes').value = invoice.notes || '';

        // Exchange rate group visibility
        const exchangeGroup = document.getElementById('exchangeRateGroup');
        exchangeGroup.style.display = invoice.currency !== 'EUR' ? '' : 'none';

        // Discount
        const discountType = invoice.discount_type || '';
        document.getElementById('invoiceDiscountType').value = discountType;
        const discountValueInput = document.getElementById('invoiceDiscountValue');
        if (discountType === 'percentage') {
          discountValueInput.value = invoice.discount_value || 0;
          discountValueInput.style.display = '';
        } else if (discountType === 'fixed') {
          discountValueInput.value = MoneyUtils.centsToEuros(invoice.discount_value || 0);
          discountValueInput.style.display = '';
        } else {
          discountValueInput.value = '0';
          discountValueInput.style.display = 'none';
        }

        // IRPF
        const irpfSelect = document.getElementById('invoiceIrpf');
        irpfSelect.value = String(invoice.irpf_rate || 0);

        // Trigger client change to set IVA treatment display
        await handleInvoiceClientChange();

        // Clear and populate line items
        const lineItemsBody = document.getElementById('invoiceLineItemsBody');
        lineItemsBody.innerHTML = '';

        if (invoice.lines && invoice.lines.length > 0) {
          invoice.lines.forEach(line => {
            addInvoiceLineItem({
              description: line.description,
              quantity: line.quantity,
              unit_price: MoneyUtils.centsToEuros(line.unit_price_cents),
              project_id: line.project_id
            });
          });
        }

        // Recalculate totals
        recalculateInvoiceFormTotals();

      } catch (err) {
        console.error('Failed to load invoice for editing:', err);
        alert('Error loading invoice: ' + err.message);
      }
    }

    /**
     * Add a line item from a client's project.
     * Auto-selects if only one project, shows quick selection for multiple.
     */
    async function addLineFromProject() {
      const clientSelect = document.getElementById('invoiceClient');
      const clientId = parseInt(clientSelect.value, 10);

      if (!clientId || isNaN(clientId)) {
        alert('Please select a client first.');
        return;
      }

      try {
        const projects = await ProjectManager.getProjectsByClient(clientId);
        if (projects.length === 0) {
          alert('No projects found for this client.');
          return;
        }

        let selectedProject;

        if (projects.length === 1) {
          // Auto-select the only project
          selectedProject = projects[0];
        } else {
          // Show quick selection dialog
          const names = projects.map((p, i) => (i + 1) + '. ' + p.name + ' (' + MoneyUtils.formatEuros(p.rate_cents) + ')');
          const choice = prompt(
            'Select a project:\n\n' + names.join('\n') + '\n\nEnter number (1-' + projects.length + '):'
          );

          if (!choice) return;
          const idx = parseInt(choice, 10) - 1;
          if (isNaN(idx) || idx < 0 || idx >= projects.length) {
            alert('Invalid selection.');
            return;
          }
          selectedProject = projects[idx];
        }

        // Add line item from project
        addInvoiceLineItem({
          description: selectedProject.name,
          quantity: 1,
          unit_price: MoneyUtils.centsToEuros(selectedProject.rate_cents),
          project_id: selectedProject.id
        });

      } catch (err) {
        console.error('Failed to add line from project:', err);
        alert('Error loading projects: ' + err.message);
      }
    }

    /**
     * Open the calendar populate dialog.
     * Pre-fills project dropdown and default date range (current month).
     */
    async function openCalendarPopulate() {
      const clientSelect = document.getElementById('invoiceClient');
      const clientId = parseInt(clientSelect.value, 10);

      if (!clientId || isNaN(clientId)) {
        alert('Please select a client first.');
        return;
      }

      try {
        // Populate project dropdown
        const projectSelect = document.getElementById('calPopProject');
        const projects = await ProjectManager.getProjectsByClient(clientId);

        projectSelect.innerHTML = '';
        if (projects.length === 0) {
          projectSelect.innerHTML = '<option value="">No projects available</option>';
        } else {
          projects.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = _escapeHtml(p.name) + ' (' + MoneyUtils.formatEuros(p.rate_cents) + ')';
            projectSelect.appendChild(opt);
          });
        }

        // Set default date range to current month
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        document.getElementById('calPopStartDate').value = firstDay.toISOString().split('T')[0];
        document.getElementById('calPopEndDate').value = lastDay.toISOString().split('T')[0];

        // Clear preview
        document.getElementById('calPopPreview').innerHTML = '';

        const dialog = document.getElementById('calendarPopulateDialog');
        if (dialog) dialog.showModal();

      } catch (err) {
        console.error('Failed to open calendar populate:', err);
        alert('Error: ' + err.message);
      }
    }

    /**
     * Populate a line item from calendar days.
     * Counts matching days for the selected client in the date range.
     */
    async function handleCalendarPopulate() {
      const clientSelect = document.getElementById('invoiceClient');
      const clientId = parseInt(clientSelect.value, 10);
      const projectSelect = document.getElementById('calPopProject');
      const projectId = parseInt(projectSelect.value, 10);
      const startDate = document.getElementById('calPopStartDate').value;
      const endDate = document.getElementById('calPopEndDate').value;

      if (!clientId || !startDate || !endDate) {
        alert('Please fill in all fields.');
        return;
      }

      try {
        const entityId = EntityContext.entityId;
        if (!entityId) {
          alert('No entity selected.');
          return;
        }

        // Query calendar_days for this client in date range
        const allDays = await db.calendar_days
          .where('entity_id').equals(entityId)
          .filter(d => d.client_id === clientId && d.date >= startDate && d.date <= endDate)
          .toArray();

        if (allDays.length === 0) {
          alert('No calendar days found for this client in the selected date range.');
          return;
        }

        // Get project details for description and rate
        let projectName = 'Work days';
        let rateCentsPerUnit = 0;

        if (projectId && !isNaN(projectId)) {
          const project = await ProjectManager.getProject(projectId);
          if (project) {
            projectName = project.name;
            rateCentsPerUnit = project.rate_cents || 0;
          }
        }

        // Build description
        const dayCount = allDays.length;
        const description = projectName + ' - ' + startDate + ' to ' + endDate + ' (' + dayCount + ' day' + (dayCount !== 1 ? 's' : '') + ')';

        // Add line item
        addInvoiceLineItem({
          description: description,
          quantity: dayCount,
          unit_price: MoneyUtils.centsToEuros(rateCentsPerUnit),
          project_id: projectId || null
        });

        // Close calendar populate dialog
        const dialog = document.getElementById('calendarPopulateDialog');
        if (dialog && dialog.open) dialog.close();

      } catch (err) {
        console.error('Failed to populate from calendar:', err);
        alert('Error: ' + err.message);
      }
    }

    /**
     * Open expense selector to add billable expenses as line items.
     * Queries expenses for current client that are marked as billable.
     */
    async function openExpenseSelector() {
      const clientSelect = document.getElementById('invoiceClient');
      const clientId = parseInt(clientSelect.value, 10);

      if (!clientId || isNaN(clientId)) {
        alert('Please select a client first.');
        return;
      }

      try {
        const entityId = EntityContext.entityId;
        if (!entityId) return;

        // Get billable expenses for this client
        const expenses = await db.expenses
          .where('entity_id').equals(entityId)
          .filter(e => e.client_id === clientId && e.is_billable && !e.deleted_at)
          .toArray();

        if (expenses.length === 0) {
          alert('No billable expenses found for this client.');
          return;
        }

        // Show selection list
        const lines = expenses.map((exp, i) => {
          const date = exp.date || 'No date';
          const vendor = exp.vendor || 'Unknown vendor';
          const amount = MoneyUtils.formatEuros(exp.amount_cents || 0);
          return (i + 1) + '. ' + vendor + ' (' + date + ') - ' + amount;
        });

        const choice = prompt(
          'Select billable expenses to add (comma-separated numbers):\n\n' +
          lines.join('\n') +
          '\n\nEnter numbers (e.g., 1,3,5) or "all":'
        );

        if (!choice) return;

        let selectedIndices;
        if (choice.trim().toLowerCase() === 'all') {
          selectedIndices = expenses.map((_, i) => i);
        } else {
          selectedIndices = choice.split(',')
            .map(s => parseInt(s.trim(), 10) - 1)
            .filter(i => !isNaN(i) && i >= 0 && i < expenses.length);
        }

        if (selectedIndices.length === 0) {
          alert('No valid expenses selected.');
          return;
        }

        // Add each selected expense as a line item
        selectedIndices.forEach(idx => {
          const exp = expenses[idx];
          const vendor = exp.vendor || 'Expense';
          const date = exp.date || '';
          const description = vendor + (date ? ' (' + date + ')' : '');
          const amountEuros = MoneyUtils.centsToEuros(exp.amount_cents || 0);

          addInvoiceLineItem({
            description: description,
            quantity: 1,
            unit_price: amountEuros
          });
        });

      } catch (err) {
        console.error('Failed to load billable expenses:', err);
        alert('Error loading expenses: ' + err.message);
      }
    }

    // =====================================================
    // PHASE 18: Invoice Detail View & Status/Payment (18-04)
    // =====================================================

    /** Currently displayed invoice ID in detail view */
    let _currentDetailInvoiceId = null;

    /**
     * showInvoiceDetail - Display detailed view of a single invoice
     * @param {number} invoiceId - Invoice ID to display
     */
    async function showInvoiceDetail(invoiceId) {
      const listView = document.getElementById('invoice-list-view');
      const detailView = document.getElementById('invoice-detail-view');
      if (!detailView) return;

      // Hide list, show detail
      if (listView) listView.style.display = 'none';
      detailView.style.display = '';

      _currentDetailInvoiceId = invoiceId;

      try {
        const invoice = await InvoiceManager.getInvoice(invoiceId);
        if (!invoice) {
          showNotification('Invoice not found', 'error');
          showInvoiceList();
          return;
        }

        const entity = await EntityManager.getEntity(invoice.entity_id);
        const client = await db.clients.get(invoice.client_id);

        // Header: invoice number
        document.getElementById('detail-invoice-number').textContent = invoice.invoice_number || '';

        // Status badge
        const statusEl = document.getElementById('detail-invoice-status');
        const isOverdue = invoice.status === 'sent' && InvoiceManager.isOverdue(invoice);
        if (isOverdue) {
          statusEl.className = 'invoice-status-badge badge-overdue';
          statusEl.textContent = 'OVERDUE';
        } else if (invoice.status === 'draft') {
          statusEl.className = 'invoice-status-badge badge-draft';
          statusEl.textContent = 'DRAFT';
        } else if (invoice.status === 'sent') {
          statusEl.className = 'invoice-status-badge badge-sent';
          statusEl.textContent = 'SENT';
        } else if (invoice.status === 'paid') {
          statusEl.className = 'invoice-status-badge badge-paid';
          statusEl.textContent = 'PAID';
        } else if (invoice.status === 'archived') {
          statusEl.className = 'invoice-status-badge badge-draft';
          statusEl.textContent = 'ARCHIVED';
        }

        // Dates
        document.getElementById('detail-invoice-date').textContent = formatDateEU(invoice.date_issued);
        const dueEl = document.getElementById('detail-invoice-due');
        if (invoice.date_due) {
          let dueText = formatDateEU(invoice.date_due);
          if (isOverdue) dueText += ' - OVERDUE';
          dueEl.textContent = dueText;
          dueEl.style.color = isOverdue ? 'var(--negative)' : '';
        } else {
          dueEl.textContent = '-';
          dueEl.style.color = '';
        }

        // Currency info
        const currencyInfoEl = document.getElementById('detail-invoice-currency-info');
        if (currencyInfoEl) {
          if (invoice.currency && invoice.currency !== 'EUR') {
            currencyInfoEl.textContent = `Currency: ${_escapeHtml(invoice.currency)} (Rate: ${invoice.exchange_rate || 1})`;
            currencyInfoEl.style.display = '';
          } else {
            currencyInfoEl.style.display = 'none';
          }
        }

        // Entity info (From)
        const entityInfoEl = document.getElementById('detail-entity-info');
        if (entityInfoEl && entity) {
          const entityName = _escapeHtml(entity.name || '');
          const entityNif = _escapeHtml(entity.nif_cif || '');
          const entityAddress = entity.type === ENTITY_TYPE.SOCIEDAD_LIMITADA
            ? _escapeHtml(entity.domicilio_social || '')
            : _escapeHtml(entity.domicilio_fiscal || '');
          const entityLabel = entity.type === ENTITY_TYPE.SOCIEDAD_LIMITADA ? 'CIF' : 'NIF';
          let entityHtml = `
            <strong>From</strong>
            ${entityName}<br>
            ${entityLabel}: ${entityNif}<br>
            ${entityAddress}`;
          // Add Registro Mercantil for SL entities (INVOICE-04)
          if (entity.type === ENTITY_TYPE.SOCIEDAD_LIMITADA) {
            const rm = entity.registro_mercantil || {};
            if (rm.tomo || rm.folio || rm.hoja) {
              let rmText = 'Reg. Mercantil:';
              if (rm.provincia) rmText += ' ' + _escapeHtml(rm.provincia) + ' -';
              if (rm.tomo) rmText += ' Tomo ' + _escapeHtml(rm.tomo);
              if (rm.folio) rmText += ', Folio ' + _escapeHtml(rm.folio);
              if (rm.hoja) rmText += ', Hoja ' + _escapeHtml(rm.hoja);
              entityHtml += '<br><span style="font-size: 0.8rem; color: var(--text-muted);">' + rmText + '</span>';
            }
          }
          entityInfoEl.innerHTML = entityHtml;
        }

        // Client info (To)
        const clientInfoEl = document.getElementById('detail-client-info');
        if (clientInfoEl && client) {
          const clientName = _escapeHtml(client.name || '');
          const clientTaxId = client.tax_id ? _escapeHtml(client.tax_id) : '';
          const clientAddress = client.address ? _escapeHtml(client.address) : '';
          const clientFlag = client.country_code ? getFlagEmoji(client.country_code) : '';
          let clientHtml = `<strong>To ${clientFlag}</strong>\n${clientName}`;
          if (clientTaxId) clientHtml += `<br>Tax ID: ${clientTaxId}`;
          if (clientAddress) clientHtml += `<br>${clientAddress}`;
          clientInfoEl.innerHTML = clientHtml;
        } else if (clientInfoEl) {
          clientInfoEl.innerHTML = '<strong>To</strong>\nUnknown client';
        }

        // Line items table
        const lineItemsBody = document.getElementById('detail-line-items');
        if (lineItemsBody) {
          const lines = invoice.lines || [];
          if (lines.length === 0) {
            lineItemsBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-muted);">No line items</td></tr>';
          } else {
            let linesHtml = '';
            for (const line of lines) {
              const desc = _escapeHtml(line.description || '');
              const qty = line.quantity || 0;
              const unitPrice = MoneyUtils.formatEuros(line.unit_price_cents || 0);
              const ivaRate = line.iva_rate !== null && line.iva_rate !== undefined
                ? (line.iva_rate * 100).toFixed(0) + '%'
                : '-';
              const lineTotal = MoneyUtils.formatEuros(line.line_total_cents || 0);
              linesHtml += `
                <tr>
                  <td>${desc}</td>
                  <td class="text-right">${qty}</td>
                  <td class="text-right">${unitPrice}</td>
                  <td class="text-right">${ivaRate}</td>
                  <td class="text-right">${lineTotal}</td>
                </tr>`;
            }
            lineItemsBody.innerHTML = linesHtml;
          }
        }

        // Totals section
        const totalsEl = document.getElementById('detail-totals');
        if (totalsEl) {
          let totalsHtml = '';
          const subtotalCents = invoice.subtotal_cents || 0;
          totalsHtml += `<div class="totals-row"><span>Subtotal</span><span class="mono">${MoneyUtils.formatEuros(subtotalCents)}</span></div>`;

          // Discount (if any)
          if (invoice.discount_type && invoice.discount_value > 0) {
            const discountLabel = invoice.discount_type === 'percentage'
              ? `Discount (${invoice.discount_value}%)`
              : 'Discount';
            let discountCents = 0;
            if (invoice.discount_type === 'percentage') {
              discountCents = MoneyUtils.roundCents(subtotalCents * invoice.discount_value / 100);
            } else {
              discountCents = invoice.discount_value;
            }
            totalsHtml += `<div class="totals-row"><span>${_escapeHtml(discountLabel)}</span><span class="mono" style="color: var(--negative);">-${MoneyUtils.formatEuros(discountCents)}</span></div>`;
          }

          // IVA
          const ivaCents = invoice.iva_cents || 0;
          const treatment = client ? IVA_TREATMENT[client.category] : null;
          const ivaLabel = treatment ? treatment.label : 'IVA';
          totalsHtml += `<div class="totals-row"><span>${_escapeHtml(ivaLabel)}</span><span class="mono">${MoneyUtils.formatEuros(ivaCents)}</span></div>`;

          // IRPF (if any)
          if (invoice.irpf_rate && invoice.irpf_rate > 0) {
            const irpfCents = invoice.irpf_cents || 0;
            totalsHtml += `<div class="totals-row"><span>IRPF (${invoice.irpf_rate}%)</span><span class="mono" style="color: var(--negative);">-${MoneyUtils.formatEuros(irpfCents)}</span></div>`;
          }

          // Total
          totalsHtml += `<div class="totals-row totals-total"><span>Total</span><span class="mono">${MoneyUtils.formatEuros(invoice.total_cents || 0)}</span></div>`;

          // Paid so far (if partially paid sent invoice)
          if ((invoice.paid_cents || 0) > 0 && invoice.status !== 'paid') {
            totalsHtml += `<div class="totals-row" style="margin-top: 0.5rem;"><span>Paid</span><span class="mono" style="color: var(--positive);">${MoneyUtils.formatEuros(invoice.paid_cents)}</span></div>`;
            const remaining = (invoice.total_cents || 0) - (invoice.paid_cents || 0);
            totalsHtml += `<div class="totals-row"><span>Remaining</span><span class="mono" style="color: var(--warning);">${MoneyUtils.formatEuros(remaining)}</span></div>`;
          }

          totalsEl.innerHTML = totalsHtml;
        }

        // Legal text (EU B2B, export, etc.)
        const legalTextEl = document.getElementById('detail-legal-text');
        if (legalTextEl) {
          const legalTreatment = client ? IVA_TREATMENT[client.category] : null;
          if (legalTreatment && legalTreatment.legalText) {
            legalTextEl.textContent = legalTreatment.legalText;
            legalTextEl.style.display = '';
          } else {
            legalTextEl.style.display = 'none';
          }
        }

        // Rectificativa reference
        const rectRefEl = document.getElementById('detail-rectificativa-ref');
        if (rectRefEl) {
          if (invoice.original_invoice_id) {
            const origNum = _escapeHtml(invoice.original_invoice_number || '');
            const reason = _escapeHtml(invoice.correction_reason || '');
            const desc = invoice.correction_description ? ': ' + _escapeHtml(invoice.correction_description) : '';
            rectRefEl.innerHTML = `Factura rectificativa of <strong>${origNum}</strong> - Reason: ${reason}${desc}`;
            rectRefEl.style.display = '';
          } else {
            rectRefEl.style.display = 'none';
          }
        }

        // Notes
        const notesEl = document.getElementById('detail-notes');
        if (notesEl) {
          if (invoice.notes && invoice.notes.trim()) {
            notesEl.textContent = invoice.notes;
            notesEl.style.display = '';
          } else {
            notesEl.style.display = 'none';
          }
        }

        // Render payment history and form
        await renderPaymentHistory(invoiceId);

        // Render contextual action buttons
        renderInvoiceDetailActions(invoice);

      } catch (err) {
        console.error('Failed to load invoice detail:', err);
        showNotification('Failed to load invoice details: ' + err.message, 'error');
      }
    }

    /**
     * renderInvoiceDetailActions - Render contextual action buttons based on invoice status
     * @param {Object} invoice - Invoice object
     */
    function renderInvoiceDetailActions(invoice) {
      const actionsEl = document.getElementById('detail-invoice-actions');
      if (!actionsEl) return;

      let html = '';

      // Status-specific workflow actions
      if (invoice.status === 'draft') {
        html += `<button class="btn btn-small" data-permission="edit" onclick="openInvoiceForm(${invoice.id})">Edit</button>`;
        html += `<button class="btn btn-small btn-primary" data-permission="edit" onclick="handleMarkAsSent(${invoice.id})">Mark Sent</button>`;
        html += `<button class="btn btn-small" data-permission="delete" onclick="handleArchiveInvoice(${invoice.id})" style="color: var(--negative);">Archive</button>`;
      } else if (invoice.status === 'sent') {
        html += `<button class="btn btn-small btn-primary" data-permission="edit" onclick="scrollToPaymentForm()">Record Payment</button>`;
        html += `<button class="btn btn-small" data-permission="create" onclick="handleCreateRectificativa(${invoice.id})">Rectificativa</button>`;
      } else if (invoice.status === 'paid') {
        html += `<button class="btn btn-small" data-permission="create" onclick="handleCreateRectificativa(${invoice.id})">Rectificativa</button>`;
      }

      // Separator between workflow and delivery actions
      html += `<span style="display:inline-block; width:1px; height:20px; background:var(--border); margin:0 4px; vertical-align:middle;"></span>`;

      // Delivery actions (always available for all statuses)
      html += `<button class="btn btn-small" onclick="handleDownloadInvoice(${invoice.id})" title="Download PDF file">Download PDF</button>`;
      html += `<button class="btn btn-small" onclick="handlePrintInvoice(${invoice.id})" title="Print invoice">Print</button>`;

      // Email button with graceful degradation
      const emailConfigured = typeof _isSupabaseConfigured === 'function' && _isSupabaseConfigured();
      const emailTitle = emailConfigured
        ? 'Email invoice to client'
        : 'Email invoice (configure Supabase for delivery)';
      html += `<button class="btn btn-small" onclick="handleEmailInvoice(${invoice.id})" title="${emailTitle}"`;
      if (!emailConfigured) {
        html += ` style="opacity: 0.7;"`;
      }
      html += `>Email</button>`;

      actionsEl.innerHTML = html;

      // Apply permission enforcement after rendering action buttons
      if (typeof PermissionUI !== 'undefined' && PermissionUI.applyPermissions) {
        PermissionUI.applyPermissions();
      }
    }

    /**
     * scrollToPaymentForm - Scroll to the payment form in detail view
     */
    function scrollToPaymentForm() {
      const formContainer = document.getElementById('payment-form-container');
      if (formContainer) {
        formContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    /**
     * handleMarkAsSent - Mark a draft invoice as sent (locks for editing)
     * @param {number} invoiceId - Invoice ID
     */
    async function handleMarkAsSent(invoiceId) {
      try {
        const invoice = await db.invoices.get(invoiceId);
        if (!invoice) {
          showNotification('Invoice not found', 'error');
          return;
        }

        if (!confirm(`Mark invoice ${invoice.invoice_number} as sent?\n\nThis will lock the invoice for editing.`)) {
          return;
        }

        await InvoiceManager.markAsSent(invoiceId);
        showNotification(`Invoice ${invoice.invoice_number} marked as sent`, 'success');
        await showInvoiceDetail(invoiceId);
      } catch (err) {
        console.error('Failed to mark invoice as sent:', err);
        showNotification('Failed to send invoice: ' + err.message, 'error');
      }
    }

    /**
     * handleRecordPayment - Record a payment against the currently viewed invoice
     * Reads values from the payment form, validates, and calls InvoiceManager.
     */
    async function handleRecordPayment() {
      const invoiceId = _currentDetailInvoiceId;
      if (!invoiceId) {
        showNotification('No invoice selected', 'error');
        return;
      }

      const amountInput = document.getElementById('paymentAmount');
      const dateInput = document.getElementById('paymentDate');
      const methodSelect = document.getElementById('paymentMethod');
      const referenceInput = document.getElementById('paymentReference');

      const amountStr = amountInput?.value || '';
      const amount = parseFloat(amountStr);
      const date = dateInput?.value || '';
      const method = methodSelect?.value || 'transfer';
      const reference = referenceInput?.value?.trim() || '';

      if (!amount || amount <= 0) {
        showNotification('Please enter a valid payment amount', 'error');
        return;
      }
      if (!date) {
        showNotification('Please enter a payment date', 'error');
        return;
      }

      try {
        const amountCents = MoneyUtils.eurosToCents(amount);
        await InvoiceManager.recordPayment(invoiceId, {
          amount_cents: amountCents,
          date: date,
          method: method,
          reference: reference || null
        });

        // Clear form
        if (amountInput) amountInput.value = '';
        if (referenceInput) referenceInput.value = '';

        showNotification(`Payment of ${MoneyUtils.formatEuros(amountCents)} recorded`, 'success');
        await showInvoiceDetail(invoiceId);
      } catch (err) {
        console.error('Failed to record payment:', err);
        showNotification('Failed to record payment: ' + err.message, 'error');
      }
    }

    /**
     * renderPaymentHistory - Render payment records and payment form for an invoice
     * @param {number} invoiceId - Invoice ID
     */
    async function renderPaymentHistory(invoiceId) {
      const historyEl = document.getElementById('payment-history');
      const formContainer = document.getElementById('payment-form-container');
      if (!historyEl) return;

      try {
        const payments = await InvoiceManager.getPayments(invoiceId);
        const invoice = await db.invoices.get(invoiceId);

        if (payments.length === 0) {
          historyEl.innerHTML = '<p style="color: var(--text-muted); font-size: 0.85rem;">No payments recorded yet.</p>';
        } else {
          const methodLabels = { transfer: 'Bank Transfer', card: 'Card', cash: 'Cash', other: 'Other' };
          let html = '';
          for (const payment of payments) {
            html += `
              <div class="payment-record">
                <span class="payment-amount">${MoneyUtils.formatEuros(payment.amount_cents)}</span>
                <span class="payment-date">${formatDateEU(payment.date)}</span>
                <span class="payment-method">${_escapeHtml(methodLabels[payment.method] || payment.method)}</span>
                ${payment.reference ? `<span style="color: var(--text-muted); font-size: 0.8rem;">${_escapeHtml(payment.reference)}</span>` : ''}
              </div>`;
          }

          // Show remaining balance
          if (invoice) {
            const remaining = (invoice.total_cents || 0) - (invoice.paid_cents || 0);
            if (remaining > 0) {
              html += `<div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.08); font-size: 0.85rem;">
                <span style="color: var(--text-muted);">Remaining:</span>
                <span class="mono" style="color: var(--warning); font-weight: 600;">${MoneyUtils.formatEuros(remaining)}</span>
              </div>`;
            }
          }

          historyEl.innerHTML = html;
        }

        // Show/hide payment form based on status
        if (formContainer && invoice) {
          if (invoice.status === 'sent') {
            formContainer.style.display = '';
            const remaining = (invoice.total_cents || 0) - (invoice.paid_cents || 0);
            const amountInput = document.getElementById('paymentAmount');
            if (amountInput) {
              amountInput.max = MoneyUtils.centsToEuros(remaining).toFixed(2);
              amountInput.placeholder = `Max ${MoneyUtils.formatEuros(remaining)}`;
            }
            const dateInput = document.getElementById('paymentDate');
            if (dateInput && !dateInput.value) {
              dateInput.value = new Date().toISOString().split('T')[0];
            }
          } else {
            formContainer.style.display = 'none';
          }
        }
      } catch (err) {
        console.error('Failed to render payment history:', err);
        historyEl.innerHTML = '<p style="color: var(--negative);">Failed to load payments.</p>';
      }
    }

    /**
     * handleArchiveInvoice - Archive a draft invoice (soft delete)
     * @param {number} invoiceId - Invoice ID
     */
    async function handleArchiveInvoice(invoiceId) {
      try {
        const invoice = await db.invoices.get(invoiceId);
        if (!invoice) {
          showNotification('Invoice not found', 'error');
          return;
        }

        // Enforce: only draft invoices can be archived (INVOICE-20)
        if (invoice.status !== 'draft') {
          showNotification(
            `Cannot archive a ${invoice.status} invoice. ` +
            `Sent/paid invoices must remain in the numbering sequence per VeriFactu. ` +
            `To correct errors, create a factura rectificativa.`,
            'error'
          );
          return;
        }

        if (!confirm(
          `Archive invoice ${invoice.invoice_number}?\n\n` +
          `The invoice number will be consumed and cannot be reused.\n` +
          `Note: Archived invoices are retained for 4 years per Spanish tax law.`
        )) {
          return;
        }

        await InvoiceManager.archiveInvoice(invoiceId);
        showNotification(`Invoice ${invoice.invoice_number} archived`, 'success');
        showInvoiceList();
      } catch (err) {
        console.error('Failed to archive invoice:', err);
        showNotification('Failed to archive: ' + err.message, 'error');
      }
    }

    /**
     * getEntityIncomeSummary - Income tracking per entity from paid invoices (INVOICE-23)
     * Aggregates paid invoice totals by month/year for reporting.
     * @param {number} entityId - Entity ID
     * @returns {Promise<{total: number, byMonth: Array<{year: number, month: number, total: number}>, count: number}>}
     */
    async function getEntityIncomeSummary(entityId) {
      try {
        const invoices = await db.invoices
          .where('entity_id').equals(entityId)
          .filter(inv => !inv.deleted_at && inv.status === 'paid')
          .toArray();

        let total = 0;
        const monthMap = new Map(); // 'YYYY-MM' -> totalCents

        for (const inv of invoices) {
          total += inv.total_cents || 0;

          // Group by month using date_issued
          if (inv.date_issued) {
            const parts = inv.date_issued.split('-');
            if (parts.length >= 2) {
              const key = `${parts[0]}-${parts[1]}`;
              monthMap.set(key, (monthMap.get(key) || 0) + (inv.total_cents || 0));
            }
          }
        }

        // Convert map to sorted array
        const byMonth = [];
        for (const [key, monthTotal] of monthMap.entries()) {
          const [yearStr, monthStr] = key.split('-');
          byMonth.push({
            year: parseInt(yearStr, 10),
            month: parseInt(monthStr, 10),
            total: monthTotal
          });
        }
        byMonth.sort((a, b) => a.year === b.year ? a.month - b.month : a.year - b.year);

        return { total, byMonth, count: invoices.length };
      } catch (err) {
        console.error('getEntityIncomeSummary error:', err);
        return { total: 0, byMonth: [], count: 0 };
      }
    }

    /**
     * handleCreateRectificativa - Opens rectificativa dialog for an invoice
     * @param {number} [invoiceId] - Invoice ID (defaults to current detail view)
     */
    async function handleCreateRectificativa(invoiceId) {
      const id = invoiceId || _currentDetailInvoiceId;
      if (!id) {
        showNotification('No invoice selected', 'error');
        return;
      }

      try {
        const invoice = await db.invoices.get(id);
        if (!invoice) {
          showNotification('Invoice not found', 'error');
          return;
        }

        // Set reference text
        const refEl = document.getElementById('rectOriginalRef');
        if (refEl) {
          refEl.textContent = `Correcting invoice: ${invoice.invoice_number}`;
        }

        // Reset form
        const reasonSelect = document.getElementById('rectReason');
        const descTextarea = document.getElementById('rectDescription');
        if (reasonSelect) reasonSelect.value = '';
        if (descTextarea) descTextarea.value = '';

        // Store original invoice id on dialog
        const dialog = document.getElementById('rectificativaDialog');
        if (dialog) {
          dialog.dataset.originalInvoiceId = String(id);
          dialog.showModal();
        }
      } catch (err) {
        console.error('Failed to open rectificativa dialog:', err);
        showNotification('Error: ' + err.message, 'error');
      }
    }

    /**
     * handleSubmitRectificativa - Creates a rectificativa invoice from the dialog form
     */
    async function handleSubmitRectificativa() {
      const dialog = document.getElementById('rectificativaDialog');
      if (!dialog) return;

      const originalId = parseInt(dialog.dataset.originalInvoiceId, 10);
      if (!originalId) {
        showNotification('No original invoice selected', 'error');
        return;
      }

      const reason = document.getElementById('rectReason')?.value || '';
      const description = document.getElementById('rectDescription')?.value?.trim() || '';

      if (!reason) {
        showNotification('Please select a correction reason', 'error');
        return;
      }

      try {
        const result = await InvoiceManager.createRectifyingInvoice(originalId, {
          reason: reason,
          description: description
        });

        dialog.close();
        showNotification(`Rectificativa ${result.invoice_number} created`, 'success');

        // Open the new rectificativa in edit mode
        openInvoiceForm(result.id);
      } catch (err) {
        console.error('Failed to create rectificativa:', err);
        showNotification('Failed to create rectificativa: ' + err.message, 'error');
      }
    }

    // =====================================================
    // PHASE 18: Logo Image Compression (18-05)
    // =====================================================

    /**
     * compressLogoImage - Compress an image file to max 200x200px JPEG
     * Used for entity logo storage (kept small for IndexedDB + PDF embedding).
     * @param {File} file - Image file from file input
     * @returns {Promise<string>} Compressed image as data URL
     */
    async function compressLogoImage(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            try {
              const maxSize = 200;
              let width = img.width;
              let height = img.height;

              // Scale down maintaining aspect ratio
              if (width > maxSize || height > maxSize) {
                if (width > height) {
                  height = Math.round(height * maxSize / width);
                  width = maxSize;
                } else {
                  width = Math.round(width * maxSize / height);
                  height = maxSize;
                }
              }

              const canvas = document.createElement('canvas');
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);

              const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
              resolve(dataUrl);
            } catch (err) {
              // Graceful fallback: use original data URL
              console.warn('Logo compression failed, using original:', err);
              resolve(e.target.result);
            }
          };
          img.onerror = () => reject(new Error('Failed to load image'));
          img.src = e.target.result;
        };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    // =====================================================
    // PHASE 18: Invoice PDF Generator (18-05)
    // =====================================================

    /**
     * InvoicePDFGenerator - Generates professional A4 PDF invoices
     * using jsPDF + AutoTable with VeriFactu QR code.
     *
     * Features:
     * - Lazy-loads jsPDF, AutoTable, and QRCode.js from CDN
     * - Entity-type-specific headers (Autonomo NIF vs SL CIF + Registro Mercantil)
     * - Line items table with AutoTable for proper formatting
     * - Totals with IVA/IRPF breakdown
     * - Legal text for EU B2B and export invoices
     * - VeriFactu QR code per Real Decreto 1007/2023
     * - Logo support (from entity record)
     *
     * Font strategy: jsPDF built-in fonts only (Helvetica, Courier)
     * No custom font embedding to avoid 300-500KB bloat.
     */
    const InvoicePDFGenerator = {

      // Page constants (A4 = 210mm x 297mm)
      PAGE_WIDTH: 210,
      PAGE_HEIGHT: 297,
      MARGIN_TOP: 15,
      MARGIN_LEFT: 20,
      MARGIN_RIGHT: 20,
      MARGIN_BOTTOM: 20,
      CONTENT_WIDTH: 170, // 210 - 20 - 20

      // Colors
      ACCENT_COLOR: [59, 130, 246],    // #3b82f6
      TEXT_COLOR: [40, 40, 40],
      TEXT_MUTED: [120, 120, 120],
      LINE_COLOR: [200, 200, 200],
      BG_LIGHT: [245, 245, 250],

      /**
       * _loadScript - Dynamically load a script tag (mirrors ReceiptManager pattern)
       * @param {string} src - Script URL
       * @returns {Promise<void>}
       */
      _loadScript(src) {
        return new Promise((resolve, reject) => {
          const existing = document.querySelector(`script[src="${src}"]`);
          if (existing) {
            resolve();
            return;
          }
          const script = document.createElement('script');
          script.src = src;
          script.async = true;
          script.onload = () => resolve();
          script.onerror = () => reject(new Error(`Failed to load script: ${src}`));
          document.head.appendChild(script);
        });
      },

      /**
       * _ensureLibraries - Lazy-load jsPDF, AutoTable plugin, and QRCode.js
       * Only loads what is not already present in window scope.
       */
      async _ensureLibraries() {
        // 1. jsPDF core
        if (!window.jspdf) {
          await this._loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
        }
        if (!window.jspdf) {
          throw new Error('jsPDF failed to load');
        }

        // 2. AutoTable plugin
        if (!window.jspdf?.jsPDF?.API?.autoTable) {
          await this._loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js');
        }

        // 3. QRCode.js
        if (!window.QRCode) {
          await this._loadScript('https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js');
        }
      },

      /**
       * generatePDF - Main entry point: generates and downloads a PDF for an invoice
       * @param {number} invoiceId - Invoice ID
       * @param {Object} [options] - Output options
       * @param {boolean} [options.returnBase64=false] - Return base64 data URI instead of saving
       * @param {boolean} [options.returnBlobUrl=false] - Return blob URL instead of saving
       * @returns {Promise<boolean|string>} true on save, or base64/bloburl string
       */
      async generatePDF(invoiceId, options = {}) {
        await this._ensureLibraries();

        const invoice = await InvoiceManager.getInvoice(invoiceId);
        if (!invoice) throw new Error('Invoice not found');

        const entity = await EntityManager.getEntity(invoice.entity_id);
        if (!entity) throw new Error('Entity not found');

        const client = await db.clients.get(invoice.client_id);
        if (!client) throw new Error('Client not found');

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'mm', format: 'a4' });

        // Draw sections in order
        let y = this._drawHeader(doc, invoice, entity);
        const clientEndY = this._drawClientBlock(doc, client, invoice, y);
        this._drawInvoiceMeta(doc, invoice, y);
        const afterClientMetaY = clientEndY + 5;
        const afterTableY = this._drawLineItems(doc, invoice.lines || [], afterClientMetaY);
        const afterTotalsY = this._drawTotals(doc, invoice, afterTableY);
        const afterLegalY = this._drawLegalText(doc, invoice, client, afterTotalsY);
        this._drawNotes(doc, invoice, afterLegalY);
        await this._drawVeriFactuQR(doc, invoice, entity);
        this._drawFooter(doc, invoice);

        // Return in requested format
        if (options.returnBase64) {
          // Return base64-encoded PDF (without data URI prefix for email attachment)
          const dataUri = doc.output('datauristring');
          // Strip the data URI prefix to get raw base64
          return dataUri.split(',')[1] || dataUri;
        }
        if (options.returnBlobUrl) {
          return doc.output('bloburl');
        }

        // Default: save with invoice number as filename
        doc.save(`${invoice.invoice_number}.pdf`);
        return true;
      },

      /**
       * _drawHeader - Branded header with accent bar, entity name, fiscal info, invoice number
       * @param {Object} doc - jsPDF instance
       * @param {Object} invoice - Invoice object
       * @param {Object} entity - Entity object
       * @returns {number} Y position after header
       */
      _drawHeader(doc, invoice, entity) {
        // Blue accent bar at top
        doc.setFillColor(...this.ACCENT_COLOR);
        doc.rect(0, 0, this.PAGE_WIDTH, 4, 'F');

        let textStartX = this.MARGIN_LEFT;
        let y = 12;

        // Logo (if entity has logo_data)
        if (entity.logo_data) {
          try {
            doc.addImage(entity.logo_data, 'JPEG', this.MARGIN_LEFT, 8, 25, 25);
            textStartX = 50; // Shift text right of logo
          } catch (e) {
            console.warn('Failed to add logo to PDF:', e);
          }
        }

        // Entity name (large, bold)
        doc.setFont('Helvetica', 'bold');
        doc.setFontSize(16);
        doc.setTextColor(...this.TEXT_COLOR);
        doc.text(entity.name || '', textStartX, y);
        y += 6;

        // Entity-type-specific fiscal info
        doc.setFont('Helvetica', 'normal');
        doc.setFontSize(9);
        doc.setTextColor(...this.TEXT_MUTED);

        if (entity.type === ENTITY_TYPE.AUTONOMO) {
          doc.text(`NIF: ${entity.nif_cif || ''}`, textStartX, y);
          y += 4;
          doc.text(`Domicilio fiscal: ${entity.domicilio_fiscal || ''}`, textStartX, y);
          y += 4;
        } else if (entity.type === ENTITY_TYPE.SOCIEDAD_LIMITADA) {
          doc.text(`CIF: ${entity.nif_cif || ''}`, textStartX, y);
          y += 4;
          const rm = entity.registro_mercantil || {};
          if (rm.tomo || rm.folio || rm.hoja) {
            let rmText = 'Registro Mercantil:';
            if (rm.provincia) rmText += ` ${rm.provincia} -`;
            if (rm.tomo) rmText += ` Tomo ${rm.tomo}`;
            if (rm.folio) rmText += `, Folio ${rm.folio}`;
            if (rm.hoja) rmText += `, Hoja ${rm.hoja}`;
            if (rm.inscripcion) rmText += `, Inscripcion ${rm.inscripcion}`;
            doc.text(rmText, textStartX, y);
            y += 4;
          }
          doc.text(`Domicilio social: ${entity.domicilio_social || ''}`, textStartX, y);
          y += 4;
        }

        // Invoice number on the RIGHT side
        const rightX = this.PAGE_WIDTH - this.MARGIN_RIGHT;
        doc.setFont('Helvetica', 'bold');
        doc.setFontSize(10);
        doc.setTextColor(...this.ACCENT_COLOR);
        doc.text('INVOICE', rightX, 12, { align: 'right' });

        doc.setFont('Helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(...this.TEXT_COLOR);
        doc.text(invoice.invoice_number || '', rightX, 18, { align: 'right' });

        // Series label if rectificativa
        if (invoice.series === 'R') {
          doc.setFont('Helvetica', 'normal');
          doc.setFontSize(8);
          doc.setTextColor(220, 60, 60);
          doc.text('RECTIFICATIVA', rightX, 23, { align: 'right' });
        }

        // Separator line below header
        const headerEndY = Math.max(y + 2, 36);
        doc.setDrawColor(...this.LINE_COLOR);
        doc.setLineWidth(0.3);
        doc.line(this.MARGIN_LEFT, headerEndY, this.PAGE_WIDTH - this.MARGIN_RIGHT, headerEndY);

        return headerEndY + 5;
      },

      /**
       * _drawClientBlock - Client information block (left side)
       * @param {Object} doc - jsPDF instance
       * @param {Object} client - Client object
       * @param {Object} invoice - Invoice object
       * @param {number} startY - Y start position
       * @returns {number} Y position after client block
       */
      _drawClientBlock(doc, client, invoice, startY) {
        let y = startY;

        doc.setFont('Helvetica', 'bold');
        doc.setFontSize(9);
        doc.setTextColor(...this.ACCENT_COLOR);
        doc.text('Bill To:', this.MARGIN_LEFT, y);
        y += 5;

        doc.setFont('Helvetica', 'bold');
        doc.setFontSize(10);
        doc.setTextColor(...this.TEXT_COLOR);
        doc.text(client.name || '', this.MARGIN_LEFT, y);
        y += 5;

        doc.setFont('Helvetica', 'normal');
        doc.setFontSize(9);
        doc.setTextColor(...this.TEXT_MUTED);

        if (client.tax_id) {
          doc.text(`Tax ID: ${client.tax_id}`, this.MARGIN_LEFT, y);
          y += 4;
        }
        if (client.address) {
          const addressLines = doc.splitTextToSize(client.address, 80);
          doc.text(addressLines, this.MARGIN_LEFT, y);
          y += addressLines.length * 4;
        }
        if (client.country_code) {
          const countryName = client.country || client.country_code;
          doc.text(countryName, this.MARGIN_LEFT, y);
          y += 4;
        }

        return y;
      },

      /**
       * _drawInvoiceMeta - Invoice metadata on right side (date, due date, currency)
       * @param {Object} doc - jsPDF instance
       * @param {Object} invoice - Invoice object
       * @param {number} startY - Y start position
       */
      _drawInvoiceMeta(doc, invoice, startY) {
        const rightX = this.PAGE_WIDTH - this.MARGIN_RIGHT;
        const labelX = rightX - 55;
        let y = startY;

        doc.setFont('Helvetica', 'bold');
        doc.setFontSize(9);
        doc.setTextColor(...this.ACCENT_COLOR);
        doc.text('Invoice Details', rightX, y, { align: 'right' });
        y += 5;

        const rows = [
          ['Date:', this._formatDate(invoice.date_issued)],
          ['Due Date:', invoice.date_due ? this._formatDate(invoice.date_due) : '-']
        ];

        if (invoice.currency && invoice.currency !== 'EUR') {
          rows.push(['Currency:', `${invoice.currency} (Rate: ${invoice.exchange_rate || 1})`]);
        }

        doc.setFontSize(9);
        for (const [label, value] of rows) {
          doc.setFont('Helvetica', 'normal');
          doc.setTextColor(...this.TEXT_MUTED);
          doc.text(label, labelX, y);
          doc.setFont('Helvetica', 'bold');
          doc.setTextColor(...this.TEXT_COLOR);
          doc.text(value, rightX, y, { align: 'right' });
          y += 5;
        }
      },

      /**
       * _drawLineItems - Line items table using AutoTable
       * @param {Object} doc - jsPDF instance
       * @param {Array} lines - Array of line item objects
       * @param {number} startY - Y start position
       * @returns {number} Y position after table
       */
      _drawLineItems(doc, lines, startY) {
        if (!lines || lines.length === 0) {
          doc.setFont('Helvetica', 'italic');
          doc.setFontSize(9);
          doc.setTextColor(...this.TEXT_MUTED);
          doc.text('No line items', this.MARGIN_LEFT, startY + 5);
          return startY + 10;
        }

        const body = lines.map(line => [
          line.description || '',
          String(line.quantity || 0),
          MoneyUtils.formatEuros(line.unit_price_cents || 0),
          line.iva_rate !== null && line.iva_rate !== undefined
            ? (line.iva_rate * 100).toFixed(0) + '%'
            : '-',
          MoneyUtils.formatEuros(line.line_total_cents || 0)
        ]);

        doc.autoTable({
          startY: startY,
          head: [['Description', 'Qty', 'Unit Price', 'IVA %', 'Total']],
          body: body,
          styles: {
            fontSize: 9,
            cellPadding: 3,
            textColor: [60, 60, 60],
            lineColor: [220, 220, 220],
            lineWidth: 0.2
          },
          headStyles: {
            fillColor: [...this.ACCENT_COLOR],
            textColor: [255, 255, 255],
            fontStyle: 'bold',
            halign: 'left'
          },
          alternateRowStyles: {
            fillColor: [245, 245, 250]
          },
          columnStyles: {
            0: { cellWidth: 'auto' },
            1: { halign: 'right', cellWidth: 15 },
            2: { halign: 'right', cellWidth: 28 },
            3: { halign: 'right', cellWidth: 18 },
            4: { halign: 'right', cellWidth: 28 }
          },
          margin: { left: this.MARGIN_LEFT, right: this.MARGIN_RIGHT },
          theme: 'grid'
        });

        return doc.lastAutoTable.finalY + 5;
      },

      /**
       * _drawTotals - Totals breakdown section (right-aligned)
       * @param {Object} doc - jsPDF instance
       * @param {Object} invoice - Invoice object
       * @param {number} startY - Y start position
       * @returns {number} Y position after totals
       */
      _drawTotals(doc, invoice, startY) {
        const labelX = 130;
        const valueX = this.PAGE_WIDTH - this.MARGIN_RIGHT;
        let y = startY + 3;

        const subtotalCents = invoice.subtotal_cents || 0;

        // Subtotal
        doc.setFont('Helvetica', 'normal');
        doc.setFontSize(9);
        doc.setTextColor(...this.TEXT_MUTED);
        doc.text('Subtotal', labelX, y);
        doc.setFont('Courier', 'normal');
        doc.setTextColor(...this.TEXT_COLOR);
        doc.text(MoneyUtils.formatEuros(subtotalCents), valueX, y, { align: 'right' });
        y += 5;

        // Discount (if any)
        if (invoice.discount_type && invoice.discount_value > 0) {
          const discountLabel = invoice.discount_type === 'percentage'
            ? `Discount (${invoice.discount_value}%)`
            : 'Discount';
          let discountCents = 0;
          if (invoice.discount_type === 'percentage') {
            discountCents = MoneyUtils.roundCents(subtotalCents * invoice.discount_value / 100);
          } else {
            discountCents = invoice.discount_value;
          }
          doc.setFont('Helvetica', 'normal');
          doc.setTextColor(...this.TEXT_MUTED);
          doc.text(discountLabel, labelX, y);
          doc.setFont('Courier', 'normal');
          doc.setTextColor(220, 60, 60);
          doc.text('-' + MoneyUtils.formatEuros(discountCents), valueX, y, { align: 'right' });
          y += 5;
        }

        // IVA
        const ivaCents = invoice.iva_cents || 0;
        const ivaRateLabel = (invoice.lines && invoice.lines.length > 0 && invoice.lines[0].iva_rate !== null)
          ? `IVA (${(invoice.lines[0].iva_rate * 100).toFixed(0)}%)`
          : 'IVA';
        doc.setFont('Helvetica', 'normal');
        doc.setTextColor(...this.TEXT_MUTED);
        doc.text(ivaRateLabel, labelX, y);
        doc.setFont('Courier', 'normal');
        doc.setTextColor(...this.TEXT_COLOR);
        doc.text(MoneyUtils.formatEuros(ivaCents), valueX, y, { align: 'right' });
        y += 5;

        // IRPF (if any)
        if (invoice.irpf_rate && invoice.irpf_rate > 0) {
          const irpfCents = invoice.irpf_cents || 0;
          doc.setFont('Helvetica', 'normal');
          doc.setTextColor(...this.TEXT_MUTED);
          doc.text(`IRPF (${invoice.irpf_rate}%)`, labelX, y);
          doc.setFont('Courier', 'normal');
          doc.setTextColor(220, 60, 60);
          doc.text('-' + MoneyUtils.formatEuros(irpfCents), valueX, y, { align: 'right' });
          y += 5;
        }

        // Separator line
        doc.setDrawColor(...this.LINE_COLOR);
        doc.setLineWidth(0.5);
        doc.line(labelX, y, valueX, y);
        y += 5;

        // TOTAL (bold, larger)
        doc.setFont('Helvetica', 'bold');
        doc.setFontSize(12);
        doc.setTextColor(...this.TEXT_COLOR);
        doc.text('TOTAL', labelX, y);
        doc.setFont('Courier', 'bold');
        doc.setFontSize(12);
        doc.text(MoneyUtils.formatEuros(invoice.total_cents || 0), valueX, y, { align: 'right' });
        y += 6;

        // If non-EUR, show EUR equivalent
        if (invoice.currency && invoice.currency !== 'EUR' && invoice.exchange_rate) {
          doc.setFont('Helvetica', 'normal');
          doc.setFontSize(8);
          doc.setTextColor(...this.TEXT_MUTED);
          const eurEquiv = MoneyUtils.roundCents((invoice.total_cents || 0) * (invoice.exchange_rate || 1));
          doc.text(`EUR equivalent: ${MoneyUtils.formatEuros(eurEquiv)}`, valueX, y, { align: 'right' });
          y += 4;
        }

        return y + 3;
      },

      /**
       * _drawLegalText - Legal text for IVA treatment and rectificativa reference
       * @param {Object} doc - jsPDF instance
       * @param {Object} invoice - Invoice object
       * @param {Object} client - Client object
       * @param {number} startY - Y start position
       * @returns {number} Y position after legal text
       */
      _drawLegalText(doc, invoice, client, startY) {
        let y = startY;
        let hasContent = false;

        // IVA treatment legal text
        const treatment = client ? IVA_TREATMENT[client.category] : null;
        if (treatment && treatment.legalText) {
          doc.setFont('Helvetica', 'italic');
          doc.setFontSize(8);
          doc.setTextColor(...this.TEXT_MUTED);
          const legalLines = doc.splitTextToSize(treatment.legalText, this.CONTENT_WIDTH);
          doc.text(legalLines, this.MARGIN_LEFT, y);
          y += legalLines.length * 3.5;
          hasContent = true;
        }

        // Rectificativa reference
        if (invoice.original_invoice_id && invoice.original_invoice_number) {
          if (hasContent) y += 2;
          doc.setFont('Helvetica', 'italic');
          doc.setFontSize(8);
          doc.setTextColor(220, 60, 60);
          let rectText = `Factura rectificativa de: ${invoice.original_invoice_number}.`;
          if (invoice.correction_reason) {
            rectText += ` Motivo: ${invoice.correction_reason}`;
          }
          if (invoice.correction_description) {
            rectText += ` - ${invoice.correction_description}`;
          }
          const rectLines = doc.splitTextToSize(rectText, this.CONTENT_WIDTH);
          doc.text(rectLines, this.MARGIN_LEFT, y);
          y += rectLines.length * 3.5;
          hasContent = true;
        }

        return hasContent ? y + 3 : y;
      },

      /**
       * _drawNotes - Notes / payment terms in a light box
       * @param {Object} doc - jsPDF instance
       * @param {Object} invoice - Invoice object
       * @param {number} startY - Y start position
       * @returns {number} Y position after notes
       */
      _drawNotes(doc, invoice, startY) {
        if (!invoice.notes || !invoice.notes.trim()) {
          return startY;
        }

        let y = startY;

        const noteLines = doc.splitTextToSize(invoice.notes.trim(), this.CONTENT_WIDTH - 8);
        const boxHeight = 8 + noteLines.length * 3.5;

        // Ensure notes don't overlap with QR area (bottom-right)
        if (y + boxHeight > 248) {
          return startY;
        }

        doc.setFillColor(248, 248, 252);
        doc.setDrawColor(...this.LINE_COLOR);
        doc.setLineWidth(0.2);
        doc.roundedRect(this.MARGIN_LEFT, y, this.CONTENT_WIDTH, boxHeight, 2, 2, 'FD');

        y += 5;
        doc.setFont('Helvetica', 'bold');
        doc.setFontSize(8);
        doc.setTextColor(...this.TEXT_COLOR);
        doc.text('Notes / Payment Terms', this.MARGIN_LEFT + 4, y);
        y += 4;

        doc.setFont('Helvetica', 'normal');
        doc.setFontSize(8);
        doc.setTextColor(...this.TEXT_MUTED);
        doc.text(noteLines, this.MARGIN_LEFT + 4, y);
        y += noteLines.length * 3.5;

        return y + 3;
      },

      /**
       * _drawVeriFactuQR - VeriFactu QR code in bottom-right corner
       * Per Real Decreto 1007/2023 (Reglamento VeriFactu)
       * @param {Object} doc - jsPDF instance
       * @param {Object} invoice - Invoice object
       * @param {Object} entity - Entity object
       */
      async _drawVeriFactuQR(doc, invoice, entity) {
        try {
          const qrUrl = InvoiceManager.generateVeriFactuQRUrl(invoice, entity);

          // Create temporary hidden container for QR rendering
          const tempDiv = document.createElement('div');
          tempDiv.style.cssText = 'position:absolute;left:-9999px;top:-9999px;';
          document.body.appendChild(tempDiv);

          // Render QR code
          new QRCode(tempDiv, {
            text: qrUrl,
            width: 128,
            height: 128,
            correctLevel: QRCode.CorrectLevel.H
          });

          // Wait for render
          await new Promise(resolve => setTimeout(resolve, 200));

          // Extract canvas data URL
          const canvas = tempDiv.querySelector('canvas');
          if (canvas) {
            const dataUrl = canvas.toDataURL('image/png');

            // Draw QR in bottom-right corner
            const qrX = 158;
            const qrY = 252;
            const qrSize = 32;

            doc.addImage(dataUrl, 'PNG', qrX, qrY, qrSize, qrSize);

            // Label above QR
            doc.setFont('Helvetica', 'normal');
            doc.setFontSize(7);
            doc.setTextColor(...this.TEXT_MUTED);
            doc.text('QR tributario', qrX + qrSize / 2, qrY - 2, { align: 'center' });

            // VERI*FACTU label below QR
            doc.setFont('Helvetica', 'bold');
            doc.setFontSize(6);
            doc.setTextColor(...this.ACCENT_COLOR);
            doc.text('VERI*FACTU', qrX + qrSize / 2, qrY + qrSize + 3, { align: 'center' });
          }

          // Cleanup
          document.body.removeChild(tempDiv);
        } catch (e) {
          console.warn('Failed to generate VeriFactu QR code:', e);
        }
      },

      /**
       * _drawFooter - Page footer with separator, page number, and generation date
       * @param {Object} doc - jsPDF instance
       * @param {Object} invoice - Invoice object
       */
      _drawFooter(doc, invoice) {
        const totalPages = doc.internal.getNumberOfPages();

        for (let i = 1; i <= totalPages; i++) {
          doc.setPage(i);

          // Separator line
          doc.setDrawColor(...this.LINE_COLOR);
          doc.setLineWidth(0.3);
          doc.line(this.MARGIN_LEFT, 287, this.PAGE_WIDTH - this.MARGIN_RIGHT, 287);

          // Page number
          doc.setFont('Helvetica', 'normal');
          doc.setFontSize(7);
          doc.setTextColor(...this.TEXT_MUTED);
          doc.text(`Page ${i} of ${totalPages}`, this.MARGIN_LEFT, 291);

          // Generated date
          const today = new Date().toLocaleDateString('en-GB', {
            day: 'numeric', month: 'long', year: 'numeric'
          });
          doc.text(`Generated: ${today}`, this.PAGE_WIDTH - this.MARGIN_RIGHT, 291, { align: 'right' });
        }
      },

      /**
       * _formatDate - Format ISO date to human-readable format
       * @param {string} isoDate - Date in YYYY-MM-DD format
       * @returns {string} Formatted date (e.g., "23 April 2026")
       */
      _formatDate(isoDate) {
        if (!isoDate) return '-';
        try {
          const [year, month, day] = isoDate.split('-').map(Number);
          const date = new Date(year, month - 1, day);
          return date.toLocaleDateString('en-GB', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
          });
        } catch (e) {
          return isoDate;
        }
      }
    };

    /**
     * handleGeneratePDF - Wire PDF generation to invoice detail view button
     * Handles button state (disabled + text) during generation.
     * @param {number} invoiceId - Invoice ID
     */
    async function handleGeneratePDF(invoiceId) {
      const btn = event ? event.target : null;
      try {
        if (btn) {
          btn.disabled = true;
          btn.textContent = 'Generating...';
        }
        await InvoicePDFGenerator.generatePDF(invoiceId);
        if (btn) {
          btn.textContent = 'PDF Downloaded';
          setTimeout(() => {
            btn.disabled = false;
            btn.textContent = 'PDF';
          }, 2000);
        }
      } catch (err) {
        console.error('PDF generation failed:', err);
        showNotification('PDF generation failed: ' + err.message, 'error');
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'PDF';
        }
      }
    }

    // =====================================================
    // PHASE 18-07: Invoice Delivery (Download, Print, Email)
    // =====================================================

    /*
     * OPTIONAL: Email delivery via Supabase Edge Function + Resend API
     *
     * To enable email sending, deploy this Edge Function to Supabase:
     *
     * File: supabase/functions/send-invoice/index.ts
     * ------------------------------------------------
     * import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
     * import { Resend } from "npm:resend"
     *
     * const corsHeaders = {
     *   'Access-Control-Allow-Origin': '*',
     *   'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
     * }
     *
     * serve(async (req) => {
     *   if (req.method === 'OPTIONS') {
     *     return new Response('ok', { headers: corsHeaders })
     *   }
     *
     *   try {
     *     const resend = new Resend(Deno.env.get('RESEND_API_KEY'))
     *     const { to, cc, subject, html, attachments } = await req.json()
     *
     *     const { data, error } = await resend.emails.send({
     *       from: Deno.env.get('FROM_EMAIL') || 'invoices@yourdomain.com',
     *       to: Array.isArray(to) ? to : [to],
     *       cc: cc ? (Array.isArray(cc) ? cc : [cc]) : undefined,
     *       subject,
     *       html,
     *       attachments: attachments?.map(a => ({
     *         filename: a.filename,
     *         content: a.content  // base64 encoded
     *       }))
     *     })
     *
     *     if (error) {
     *       return new Response(JSON.stringify({ error }), {
     *         status: 400,
     *         headers: { ...corsHeaders, 'Content-Type': 'application/json' }
     *       })
     *     }
     *
     *     return new Response(JSON.stringify({ data }), {
     *       headers: { ...corsHeaders, 'Content-Type': 'application/json' }
     *     })
     *   } catch (err) {
     *     return new Response(JSON.stringify({ error: err.message }), {
     *       status: 500,
     *       headers: { ...corsHeaders, 'Content-Type': 'application/json' }
     *     })
     *   }
     * })
     * ------------------------------------------------
     *
     * Setup steps:
     * 1. Create account at https://resend.com/signup
     * 2. Get API key from Resend Dashboard -> API Keys
     * 3. Deploy: supabase functions deploy send-invoice
     * 4. Set secret: supabase secrets set RESEND_API_KEY=re_xxxxx
     * 5. Optionally set: supabase secrets set FROM_EMAIL=invoices@yourdomain.com
     *
     * Without this Edge Function, email button shows a helpful setup message.
     * Download and Print always work regardless of email configuration.
     */

    /** Track which invoice the email dialog is for */
    let _emailInvoiceId = null;

    /**
     * _isSupabaseConfigured - Check if Supabase client is available for email sending
     * @returns {boolean}
     */
    function _isSupabaseConfigured() {
      return !!(SUPABASE_CONFIG.url && SUPABASE_CONFIG.anonKey && supabaseClient);
    }

    /**
     * handleDownloadInvoice - Download invoice as PDF file
     * Delegates to InvoicePDFGenerator which handles doc.save()
     * @param {number} invoiceId - Invoice ID
     */
    async function handleDownloadInvoice(invoiceId) {
      const btn = event ? event.target : null;
      try {
        if (btn) {
          btn.disabled = true;
          btn.textContent = 'Downloading...';
        }
        await InvoicePDFGenerator.generatePDF(invoiceId);
        showNotification('PDF downloaded', 'success');
        if (btn) {
          btn.textContent = 'Downloaded';
          setTimeout(() => {
            btn.disabled = false;
            btn.textContent = 'Download PDF';
          }, 2000);
        }
      } catch (err) {
        console.error('PDF download failed:', err);
        showNotification('PDF download failed: ' + err.message, 'error');
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Download PDF';
        }
      }
    }

    /**
     * handlePrintInvoice - Open invoice PDF in a new window for printing
     * Uses blob URL output from jsPDF for cross-browser print support
     * @param {number} invoiceId - Invoice ID
     */
    async function handlePrintInvoice(invoiceId) {
      const btn = event ? event.target : null;
      try {
        if (btn) {
          btn.disabled = true;
          btn.textContent = 'Preparing...';
        }
        const blobUrl = await InvoicePDFGenerator.generatePDF(invoiceId, { returnBlobUrl: true });
        const printWindow = window.open(blobUrl, '_blank');
        if (printWindow) {
          printWindow.addEventListener('load', () => {
            printWindow.print();
          });
        } else {
          showNotification('Pop-up blocked. Please allow pop-ups to print invoices.', 'error');
        }
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Print';
        }
      } catch (err) {
        console.error('Print failed:', err);
        showNotification('Print failed: ' + err.message, 'error');
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Print';
        }
      }
    }

    /**
     * handleEmailInvoice - Open email dialog pre-filled with invoice and client data
     * Fetches client/contact info for the To field and builds a professional email body.
     * @param {number} invoiceId - Invoice ID
     */
    async function handleEmailInvoice(invoiceId) {
      try {
        _emailInvoiceId = invoiceId;

        const invoice = await InvoiceManager.getInvoice(invoiceId);
        if (!invoice) {
          showNotification('Invoice not found', 'error');
          return;
        }

        const entity = await EntityManager.getEntity(invoice.entity_id);
        const client = await db.clients.get(invoice.client_id);
        if (!client) {
          showNotification('Client not found', 'error');
          return;
        }

        // Get client email: prefer billing contact, fall back to primary contact, then client email
        let toEmail = '';
        let clientDisplayName = client.name || 'Client';
        try {
          if (typeof ContactManager !== 'undefined') {
            const contacts = await ContactManager.getContacts(client.id);
            const billingContact = contacts.find(c => c.role === 'billing');
            const primaryContact = contacts.find(c => c.is_primary);
            const firstWithEmail = contacts.find(c => c.email);
            if (billingContact && billingContact.email) {
              toEmail = billingContact.email;
              clientDisplayName = billingContact.name || clientDisplayName;
            } else if (primaryContact && primaryContact.email) {
              toEmail = primaryContact.email;
            } else if (firstWithEmail) {
              toEmail = firstWithEmail.email;
            }
          }
        } catch (contactErr) {
          console.warn('Could not fetch contacts for email pre-fill:', contactErr);
        }

        // Fall back to client-level email
        if (!toEmail && client.email) {
          toEmail = client.email;
        }

        const entityName = entity ? entity.name : 'Your Company';
        const totalFormatted = MoneyUtils.formatEuros(invoice.total_cents);
        const invoiceDate = invoice.date_issued || '';
        const dueDate = invoice.date_due || '';

        // Pre-fill form fields
        document.getElementById('emailTo').value = toEmail;
        document.getElementById('emailCc').value = '';
        document.getElementById('emailSubject').value = `Invoice ${invoice.invoice_number} from ${entityName}`;

        // Build professional email body
        let body = `Dear ${escapeHtml(clientDisplayName)},\n\n`;
        body += `Please find attached invoice ${invoice.invoice_number}`;
        if (invoiceDate) body += ` dated ${invoiceDate}`;
        body += ` for the amount of ${totalFormatted}.\n\n`;
        if (dueDate) body += `Due date: ${dueDate}\n\n`;
        if (invoice.notes) body += `Payment terms: ${invoice.notes}\n\n`;
        body += `Best regards,\n${entityName}`;

        document.getElementById('emailBody').value = body;

        // Reset status message
        const statusEl = document.getElementById('emailStatusMsg');
        if (statusEl) {
          statusEl.style.display = 'none';
          statusEl.textContent = '';
        }

        // Reset send button
        const sendBtn = document.getElementById('sendEmailBtn');
        if (sendBtn) {
          sendBtn.disabled = false;
          sendBtn.textContent = 'Send Email';
        }

        // Open dialog
        document.getElementById('emailInvoiceDialog').showModal();
      } catch (err) {
        console.error('Failed to open email dialog:', err);
        showNotification('Failed to prepare email: ' + err.message, 'error');
      }
    }

    /**
     * handleSendInvoiceEmail - Send the invoice email via Supabase Edge Function
     * Generates PDF as base64, sends via send-invoice function, updates date_sent.
     */
    async function handleSendInvoiceEmail() {
      const invoiceId = _emailInvoiceId;
      if (!invoiceId) {
        showNotification('No invoice selected for email', 'error');
        return;
      }

      const toField = document.getElementById('emailTo');
      const ccField = document.getElementById('emailCc');
      const subjectField = document.getElementById('emailSubject');
      const bodyField = document.getElementById('emailBody');
      const sendBtn = document.getElementById('sendEmailBtn');
      const statusEl = document.getElementById('emailStatusMsg');

      const emailTo = toField?.value?.trim();
      const emailCc = ccField?.value?.trim();
      const emailSubject = subjectField?.value?.trim();
      const emailBody = bodyField?.value?.trim();

      // Validate required field
      if (!emailTo) {
        if (statusEl) {
          statusEl.style.display = 'block';
          statusEl.style.background = 'rgba(239, 68, 68, 0.15)';
          statusEl.style.color = 'var(--negative)';
          statusEl.textContent = 'Recipient email address is required.';
        }
        toField?.focus();
        return;
      }

      // Check Supabase availability
      if (!_isSupabaseConfigured()) {
        if (statusEl) {
          statusEl.style.display = 'block';
          statusEl.style.background = 'rgba(245, 158, 11, 0.15)';
          statusEl.style.color = 'var(--warning, #f59e0b)';
          statusEl.innerHTML = '<strong>Email sending requires Supabase configuration.</strong><br>' +
            'To enable email delivery:<br>' +
            '1. Configure SUPABASE_CONFIG in the dashboard<br>' +
            '2. Deploy the send-invoice Edge Function<br>' +
            '3. Set up a Resend API key<br><br>' +
            'In the meantime, use the <strong>Download PDF</strong> button to save and send manually.';
        }
        return;
      }

      try {
        // Disable button and show progress
        if (sendBtn) {
          sendBtn.disabled = true;
          sendBtn.textContent = 'Generating PDF...';
        }

        // Generate PDF as base64
        const invoice = await InvoiceManager.getInvoice(invoiceId);
        if (!invoice) throw new Error('Invoice not found');

        const pdfBase64 = await InvoicePDFGenerator.generatePDF(invoiceId, { returnBase64: true });

        if (sendBtn) sendBtn.textContent = 'Sending...';

        // Convert body text to simple HTML (preserve newlines)
        const emailHtml = '<div style="font-family: Arial, sans-serif; font-size: 14px; line-height: 1.6; color: #333;">' +
          emailBody.split('\n').map(line => line ? `<p style="margin: 0 0 8px;">${escapeHtml(line)}</p>` : '<br>').join('') +
          '</div>';

        // Call Supabase Edge Function
        const { data, error } = await supabaseClient.functions.invoke('send-invoice', {
          body: {
            to: emailTo,
            cc: emailCc || undefined,
            subject: emailSubject,
            html: emailHtml,
            attachments: [{
              filename: `${invoice.invoice_number}.pdf`,
              content: pdfBase64
            }]
          }
        });

        if (error) {
          throw new Error(error.message || 'Edge Function returned an error');
        }

        // Update date_sent if not already set
        if (!invoice.date_sent) {
          try {
            const today = new Date().toISOString().split('T')[0];
            await db.invoices.update(invoiceId, {
              date_sent: today,
              ...auditFields(false)
            });
          } catch (updateErr) {
            console.warn('Could not update date_sent:', updateErr);
          }
        }

        // Success
        showNotification('Invoice emailed successfully', 'success');
        document.getElementById('emailInvoiceDialog').close();

        // Refresh detail view to reflect any status changes
        if (_currentDetailInvoiceId === invoiceId) {
          await showInvoiceDetail(invoiceId);
        }
      } catch (err) {
        console.error('Email send failed:', err);
        if (statusEl) {
          statusEl.style.display = 'block';
          statusEl.style.background = 'rgba(239, 68, 68, 0.15)';
          statusEl.style.color = 'var(--negative)';
          statusEl.textContent = 'Failed to send email: ' + err.message;
        }
        if (sendBtn) {
          sendBtn.disabled = false;
          sendBtn.textContent = 'Retry Send';
        }
      }
    }
  </script>

  <!-- Phase 13: Entity Creation Modal -->
  <div id="entity-modal-overlay" class="entity-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="entity-modal-title">
    <div class="entity-modal">
      <div class="entity-modal__header">
        <h2 id="entity-modal-title" class="entity-modal__title">Create New Entity</h2>
        <button class="entity-modal__close" aria-label="Close" onclick="EntityModal.close()">&times;</button>
      </div>

      <div class="entity-modal__body">
        <!-- Entity Type Selection -->
        <div class="entity-modal__section">
          <div class="entity-modal__section-title">Entity Type</div>
          <div class="entity-type-selector">
            <div class="entity-type-option" data-type="autonomo" onclick="EntityModal.selectType('autonomo')">
              <div class="entity-type-option__icon">&#128100;</div>
              <div class="entity-type-option__name">Autonomo</div>
              <div class="entity-type-option__desc">Individual / Sole trader</div>
            </div>
            <div class="entity-type-option" data-type="sociedad_limitada" onclick="EntityModal.selectType('sociedad_limitada')">
              <div class="entity-type-option__icon">&#127970;</div>
              <div class="entity-type-option__name">Sociedad Limitada</div>
              <div class="entity-type-option__desc">Limited company</div>
            </div>
          </div>
        </div>

        <!-- Form Fields Container -->
        <div id="entity-form-fields" class="entity-modal__section" style="display: none;">
          <form id="entity-form" onsubmit="return false;">
            <!-- Autonomo Fields -->
            <div id="autonomo-fields" style="display: none;">
              <div class="entity-form__group">
                <label class="entity-form__label entity-form__label--required" for="entity-nif">NIF</label>
                <input type="text" id="entity-nif" class="entity-form__input" placeholder="12345678Z" maxlength="9">
                <div id="entity-nif-error" class="entity-form__error" style="display: none;"></div>
              </div>
              <div class="entity-form__group">
                <label class="entity-form__label entity-form__label--required" for="entity-nombre">Full Name</label>
                <input type="text" id="entity-nombre" class="entity-form__input" placeholder="Juan Garcia Lopez">
              </div>
              <div class="entity-form__group">
                <label class="entity-form__label entity-form__label--required" for="entity-domicilio-fiscal">Tax Address</label>
                <input type="text" id="entity-domicilio-fiscal" class="entity-form__input" placeholder="Calle Mayor 1, 28001 Madrid">
              </div>
              <div class="entity-form__row">
                <div class="entity-form__group">
                  <label class="entity-form__label" for="entity-iae">Main IAE Code</label>
                  <input type="text" id="entity-iae" class="entity-form__input" placeholder="841">
                  <div class="entity-form__hint">Economic activity code</div>
                </div>
                <div class="entity-form__group">
                  <label class="entity-form__label" for="entity-fecha-alta">Registration Date</label>
                  <input type="date" id="entity-fecha-alta" class="entity-form__input">
                </div>
              </div>
            </div>

            <!-- SL Fields -->
            <div id="sl-fields" style="display: none;">
              <div class="entity-form__group">
                <label class="entity-form__label entity-form__label--required" for="entity-cif">CIF</label>
                <input type="text" id="entity-cif" class="entity-form__input" placeholder="B12345678" maxlength="9">
                <div id="entity-cif-error" class="entity-form__error" style="display: none;"></div>
              </div>
              <div class="entity-form__group">
                <label class="entity-form__label entity-form__label--required" for="entity-razon-social">Company Name</label>
                <input type="text" id="entity-razon-social" class="entity-form__input" placeholder="Empresa Ejemplo SL">
              </div>
              <div class="entity-form__group">
                <label class="entity-form__label entity-form__label--required" for="entity-domicilio-social">Registered Address</label>
                <input type="text" id="entity-domicilio-social" class="entity-form__input" placeholder="Paseo de la Castellana 100, 28046 Madrid">
              </div>
              <div class="entity-form__group">
                <label class="entity-form__label">Registro Mercantil</label>
                <div class="registro-mercantil-fields">
                  <div class="entity-form__row entity-form__row--3">
                    <div class="entity-form__group">
                      <label class="entity-form__label" for="entity-rm-provincia">Provincia</label>
                      <input type="text" id="entity-rm-provincia" class="entity-form__input" placeholder="Madrid">
                    </div>
                    <div class="entity-form__group">
                      <label class="entity-form__label" for="entity-rm-tomo">Tomo</label>
                      <input type="text" id="entity-rm-tomo" class="entity-form__input" placeholder="45097">
                    </div>
                    <div class="entity-form__group">
                      <label class="entity-form__label" for="entity-rm-folio">Folio</label>
                      <input type="text" id="entity-rm-folio" class="entity-form__input" placeholder="195">
                    </div>
                  </div>
                  <div class="entity-form__row entity-form__row--3">
                    <div class="entity-form__group">
                      <label class="entity-form__label" for="entity-rm-seccion">Seccion</label>
                      <input type="text" id="entity-rm-seccion" class="entity-form__input" placeholder="8">
                    </div>
                    <div class="entity-form__group">
                      <label class="entity-form__label" for="entity-rm-hoja">Hoja</label>
                      <input type="text" id="entity-rm-hoja" class="entity-form__input" placeholder="M-452031">
                    </div>
                    <div class="entity-form__group">
                      <label class="entity-form__label" for="entity-rm-inscripcion">Inscripcion</label>
                      <input type="text" id="entity-rm-inscripcion" class="entity-form__input" placeholder="1">
                    </div>
                  </div>
                </div>
              </div>
              <div class="entity-form__row">
                <div class="entity-form__group">
                  <label class="entity-form__label" for="entity-fecha-constitucion">Date of Incorporation</label>
                  <input type="date" id="entity-fecha-constitucion" class="entity-form__input">
                </div>
                <div class="entity-form__group">
                  <label class="entity-form__label" for="entity-capital-social">Share Capital (EUR)</label>
                  <input type="number" id="entity-capital-social" class="entity-form__input" placeholder="3000" min="3000" step="1" value="3000">
                  <div class="entity-form__hint">Minimum 3,000 EUR for SL</div>
                </div>
              </div>
            </div>

            <!-- Logo Upload (shared by both entity types) -->
            <div id="entity-logo-section" class="entity-form__group" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
              <label class="entity-form__label" for="entityLogoUpload">Company Logo (optional)</label>
              <div class="entity-form__hint" style="margin-bottom: 0.5rem;">Logo appears on PDF invoices. Max 200x200px, auto-compressed.</div>
              <div style="display: flex; gap: 1rem; align-items: flex-start;">
                <div id="entity-logo-preview" style="width: 80px; height: 80px; border: 2px dashed var(--border); border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; background: var(--bg-secondary);">
                  <span id="entity-logo-placeholder" style="color: var(--text-muted); font-size: 0.75rem; text-align: center;">No logo</span>
                  <img id="entity-logo-img" style="max-width: 100%; max-height: 100%; display: none;" alt="Entity logo preview">
                </div>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                  <input type="file" id="entityLogoUpload" accept="image/*" style="font-size: 0.85rem;" onchange="EntityModal.handleLogoUpload(this)">
                  <button type="button" id="entity-logo-remove-btn" class="entity-modal__btn entity-modal__btn--secondary" style="display: none; padding: 0.25rem 0.75rem; font-size: 0.8rem;" onclick="EntityModal.removeLogo()">Remove Logo</button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="entity-modal__footer">
        <button class="entity-modal__btn entity-modal__btn--secondary" onclick="EntityModal.close()">Cancel</button>
        <button id="entity-modal-submit" class="entity-modal__btn entity-modal__btn--primary" onclick="EntityModal.submit()" disabled>Create Entity</button>
      </div>
    </div>
  </div>
  <div id="toast-container" aria-live="polite" aria-atomic="true"></div>
</body>
</html>
