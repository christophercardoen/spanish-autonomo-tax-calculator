<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Autonomo Tax Calculator - 2025/2026</title>
  <style>
    /* Minimal styling for now - Phase 5 adds full dashboard */
    :root {
      --bg: #1a1a2e;
      --text: #eaeaea;
      --accent: #4ade80;
    }
    body {
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 2rem;
    }
    .container { max-width: 800px; margin: 0 auto; }
    input[type="number"] { padding: 0.5rem; font-size: 1rem; width: 150px; }
    input[type="checkbox"] { width: auto; }
    button { padding: 0.5rem 1rem; cursor: pointer; }
    .result { margin-top: 1rem; font-family: monospace; }
    .breakdown { margin-left: 1rem; font-size: 0.9rem; opacity: 0.8; }
    .input-section {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .input-section label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    h2 { color: var(--accent); margin-top: 2rem; }
    h3 { margin-top: 1.5rem; margin-bottom: 0.5rem; opacity: 0.9; }
    hr { border: none; border-top: 1px solid rgba(255,255,255,0.2); margin: 0.5rem 0; }

    /* Source citation styling */
    .source-hint {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      margin-left: 4px;
      background: rgba(74, 222, 128, 0.2);
      border: 1px solid var(--accent);
      border-radius: 50%;
      font-size: 10px;
      color: var(--accent);
      cursor: help;
      position: relative;
      vertical-align: middle;
    }

    .source-hint:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #2d2d44;
      border: 1px solid var(--accent);
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      font-size: 11px;
      white-space: normal;
      max-width: 300px;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      margin-bottom: 8px;
    }

    .source-hint:hover::before {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--accent);
      z-index: 101;
    }

    /* Footnotes section */
    .footnotes {
      margin-top: 3rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .footnotes h4 {
      margin-bottom: 1rem;
      color: var(--accent);
    }

    .footnotes ul {
      list-style: none;
      padding: 0;
    }

    .footnotes li {
      margin-bottom: 0.5rem;
    }

    .footnotes a {
      color: var(--accent);
      text-decoration: none;
    }

    .footnotes a:hover {
      text-decoration: underline;
    }

    .confidence-high { color: #4ade80; }
    .confidence-medium { color: #facc15; }

    /* Belgium Pattern Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
      position: absolute;
    }

    .toggle-switch .slider {
      position: relative;
      width: 50px;
      height: 26px;
      background: #444;
      border-radius: 13px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle-switch .slider::before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      left: 3px;
      top: 3px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }

    .toggle-switch input:checked + .slider {
      background: var(--accent);
    }

    .toggle-switch input:checked + .slider::before {
      transform: translateX(24px);
    }

    .toggle-switch input:focus + .slider {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .toggle-label {
      font-size: 0.9rem;
      opacity: 0.7;
    }

    .toggle-label.active {
      opacity: 1;
      font-weight: 600;
    }

    /* Expense Sections */
    .expenses-container {
      margin-top: 2rem;
    }

    .expense-section {
      margin-bottom: 2rem;
      padding: 1rem;
      border-radius: 8px;
      background: rgba(255,255,255,0.03);
    }

    .expense-section.spain-deductible {
      border-left: 3px solid #4ade80;  /* Green - deductible */
    }

    .expense-section.belgium-costs {
      border-left: 3px solid #60a5fa;  /* Blue - Belgium */
    }

    .expense-section.private {
      border-left: 3px solid #f87171;  /* Red - not deductible */
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .section-title {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-total {
      font-family: 'JetBrains Mono', monospace;
      opacity: 0.8;
    }

    .expense-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .expense-row:last-child {
      border-bottom: none;
    }

    .expense-name {
      font-weight: 500;
      min-width: 150px;
    }

    .expense-formula {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      opacity: 0.7;
      flex: 1;
      text-align: center;
    }

    .expense-value {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      min-width: 200px;
      text-align: right;
    }

    .expense-actions {
      display: flex;
      gap: 0.25rem;
    }

    .delete-btn {
      background: transparent;
      border: 1px solid #f87171;
      color: #f87171;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      padding: 0;
    }

    .delete-btn:hover {
      background: #f87171;
      color: var(--bg);
    }

    /* Add Expense Form */
    .add-expense-btn {
      background: transparent;
      border: 1px dashed rgba(255,255,255,0.3);
      color: var(--text);
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 0.5rem;
      width: 100%;
    }

    .add-expense-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .add-form {
      background: rgba(0,0,0,0.2);
      padding: 1rem;
      border-radius: 4px;
      margin-top: 0.5rem;
    }

    .add-form.hidden {
      display: none;
    }

    .add-form h4 {
      margin: 0 0 1rem 0;
      color: var(--accent);
    }

    .form-row {
      margin-bottom: 0.75rem;
    }

    .form-row label {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.9rem;
    }

    .form-row input,
    .form-row select {
      padding: 0.5rem;
      background: var(--bg);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      color: var(--text);
    }

    .form-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .form-actions button {
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
    }

    .form-actions button:first-child {
      background: var(--accent);
      border: none;
      color: var(--bg);
    }

    .form-actions button:last-child {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.3);
      color: var(--text);
    }

    /* Belgium breakdown formula */
    .belgium-breakdown {
      font-size: 0.8rem;
      opacity: 0.6;
      margin-top: 0.25rem;
      font-style: italic;
    }

    /* Reset button */
    .reset-btn {
      background: transparent;
      border: 1px solid #f87171;
      color: #f87171;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .reset-btn:hover {
      background: #f87171;
      color: var(--bg);
    }

    /* Scenario Cards Section */
    .scenario-section {
      margin-top: 2rem;
    }

    .scenario-cards {
      display: flex;
      gap: 1rem;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      scroll-padding: 1rem;
      padding: 1rem 0;
      -webkit-overflow-scrolling: touch;
    }

    .scenario-card {
      flex: 0 0 280px;
      scroll-snap-align: start;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 1rem;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .scenario-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    /* Optimal scenario indicator */
    .scenario-card.optimal {
      background: rgba(74, 222, 128, 0.08);
      border-color: rgba(74, 222, 128, 0.3);
    }

    /* Custom scenario visual distinction */
    .scenario-card.custom {
      border-left: 3px solid #60a5fa;
    }

    /* Selected scenario */
    .scenario-card.selected {
      border: 2px solid var(--accent);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .card-header input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    .card-header h3 {
      margin: 0;
      font-size: 1.1rem;
      flex: 1;
    }

    .optimal-badge {
      background: var(--accent);
      color: var(--bg);
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-weight: 600;
    }

    .card-metrics {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .metric {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
    }

    .metric .label {
      opacity: 0.7;
    }

    .metric .value {
      font-family: 'JetBrains Mono', monospace;
    }

    .metric.highlight .value {
      color: var(--accent);
      font-weight: 600;
    }

    .edit-btn {
      margin-top: 1rem;
      width: 100%;
      padding: 0.5rem;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text);
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
    }

    .edit-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Scrollbar styling */
    .scenario-cards::-webkit-scrollbar {
      height: 8px;
    }

    .scenario-cards::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
    }

    .scenario-cards::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
    }

    /* Edit Modal Dialog */
    dialog {
      background: var(--bg);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 0;
      max-width: 900px;
      width: 90vw;
      max-height: 90vh;
    }

    dialog::backdrop {
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
    }

    .dialog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .dialog-header h2 {
      margin: 0;
      color: var(--accent);
    }

    .dialog-close {
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      opacity: 0.7;
    }

    .dialog-close:hover {
      opacity: 1;
    }

    .dialog-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      padding: 1.5rem;
      max-height: 60vh;
      overflow-y: auto;
    }

    .input-pane, .results-pane {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .input-pane h3, .results-pane h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
      opacity: 0.8;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 0.5rem;
    }

    .results-pane {
      background: rgba(255,255,255,0.03);
      padding: 1rem;
      border-radius: 8px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .form-group label {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .form-group input,
    .form-group select {
      padding: 0.5rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .checkbox-group {
      flex-direction: row;
      align-items: center;
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    .fiscal-overrides {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .fiscal-overrides summary {
      cursor: pointer;
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .fiscal-overrides[open] summary {
      margin-bottom: 1rem;
    }

    /* Live results display */
    .live-result-row {
      display: flex;
      justify-content: space-between;
      padding: 0.4rem 0;
      font-size: 0.9rem;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .live-result-row:last-child {
      border-bottom: none;
    }

    .live-result-row .label {
      opacity: 0.7;
    }

    .live-result-row .value {
      font-family: 'JetBrains Mono', monospace;
    }

    .live-result-row.highlight {
      padding: 0.6rem 0;
      margin-top: 0.5rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .live-result-row.highlight .value {
      color: var(--accent);
      font-weight: 600;
      font-size: 1rem;
    }

    .dialog-footer {
      display: flex;
      gap: 1rem;
      padding: 1rem 1.5rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .dialog-footer .spacer {
      flex: 1;
    }

    .dialog-footer button {
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .primary-btn {
      background: var(--accent);
      color: var(--bg);
      border: none;
      font-weight: 600;
    }

    .primary-btn:hover {
      opacity: 0.9;
    }

    .secondary-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text);
    }

    .secondary-btn:hover {
      border-color: rgba(255,255,255,0.4);
    }

    .danger-btn {
      background: transparent;
      border: 1px solid #f87171;
      color: #f87171;
    }

    .danger-btn:hover {
      background: #f87171;
      color: var(--bg);
    }

    /* Responsive: stack on mobile */
    @media (max-width: 700px) {
      .dialog-body {
        grid-template-columns: 1fr;
      }
    }

    /* Comparison Table */
    .comparison-container {
      margin-top: 2rem;
      max-height: 500px;
      overflow-y: auto;
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .comparison-table thead th {
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 10;
      border-bottom: 2px solid var(--accent);
      padding: 0.75rem 1rem;
      text-align: right;
      font-weight: 600;
    }

    .comparison-table thead th:first-child {
      text-align: left;
    }

    .comparison-table tbody td {
      padding: 0.5rem 1rem;
      text-align: right;
      font-family: 'JetBrains Mono', monospace;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .comparison-table tbody td:first-child {
      text-align: left;
      font-family: inherit;
      opacity: 0.8;
    }

    /* Divider row */
    .comparison-table tr.divider td {
      padding: 0.25rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.15);
    }

    /* Highlight row (leefgeld) */
    .comparison-table tr.highlight-row td {
      padding: 0.75rem 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
      font-weight: 600;
    }

    /* Optimal value cell */
    .comparison-table td.optimal {
      color: var(--accent);
      font-weight: 700;
    }

    /* Empty state */
    .comparison-empty {
      text-align: center;
      padding: 2rem;
      opacity: 0.6;
    }

    .comparison-empty p {
      margin: 0;
    }

    /* New Scenario Button */
    .new-scenario-btn {
      background: transparent;
      border: 2px dashed rgba(255,255,255,0.2);
      color: var(--text);
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      margin-left: 1rem;
      flex-shrink: 0;
      transition: border-color 0.2s, color 0.2s;
    }

    .new-scenario-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Template Selection Dialog */
    #templateSelectDialog {
      max-width: 400px;
    }

    .template-options {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin: 1rem 0;
    }

    .template-option {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .template-option:hover {
      border-color: var(--accent);
    }

    .template-option input[type="radio"] {
      accent-color: var(--accent);
    }

    .template-option .template-info {
      flex: 1;
    }

    .template-option .template-name {
      font-weight: 600;
    }

    .template-option .template-desc {
      font-size: 0.85rem;
      opacity: 0.7;
    }

    /* Calendar Section */
    .calendar-section {
      margin-top: 2rem;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding: 0 0.5rem;
    }

    .calendar-header h3 {
      margin: 0;
      flex: 1;
      text-align: center;
      font-size: 1.2rem;
    }

    .nav-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text);
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      transition: border-color 0.2s, color 0.2s;
    }

    .nav-btn:hover:not(:disabled) {
      border-color: var(--accent);
      color: var(--accent);
    }

    .nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 0.5rem;
    }

    .day-header {
      text-align: center;
      padding: 0.5rem;
      font-size: 0.85rem;
      font-weight: 600;
      opacity: 0.6;
    }

    .day-cell {
      min-height: 60px;
      background: rgba(255,255,255,0.03);
      border-radius: 4px;
      padding: 0.25rem;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }

    .day-cell:hover:not(.empty) {
      background: rgba(255,255,255,0.08);
    }

    .day-cell.empty {
      background: transparent;
      cursor: default;
    }

    .day-cell.belgium {
      background: rgba(59, 130, 246, 0.15);
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .day-cell.spain {
      background: rgba(74, 222, 128, 0.15);
      border: 1px solid rgba(74, 222, 128, 0.3);
    }

    .day-cell.travel {
      background: rgba(251, 146, 60, 0.15);
      border: 1px solid rgba(251, 146, 60, 0.3);
    }

    .day-number {
      font-size: 0.85rem;
      font-weight: 500;
    }

    .status-emoji {
      display: block;
      text-align: center;
      font-size: 1.2rem;
      margin-top: 0.25rem;
    }

    .contracted-badge {
      position: absolute;
      top: 2px;
      right: 4px;
      font-size: 10px;
      opacity: 0.7;
      font-weight: 600;
      color: var(--accent);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Autonomo Tax Calculator 2025/2026</h1>
    <p>Calculate your IRPF liability as a Spanish autonomo</p>

    <div class="input-section">
      <label>
        Monthly Revenue (EUR):
        <input type="number" id="monthlyRevenue" value="6000" min="0" step="100" oninput="recalculateTotals()">
      </label>
      <label>
        <input type="checkbox" id="hasDescendant" checked onchange="recalculateTotals()">
        1 Dependent Child (adds 2,400 EUR minimo)
      </label>
    </div>

    <div class="expenses-container">
      <h2>Expense Tracking</h2>
      <div id="spainSection"></div>
      <div id="belgiumSection"></div>
      <div id="privateSection"></div>
      <div style="margin-top: 1rem; display: flex; justify-content: flex-end;">
        <button class="reset-btn" onclick="resetToDefaults()">Reset to Defaults</button>
      </div>

      <!-- Add Expense Form (global, one for all sections) -->
      <div id="addExpenseForm" class="add-form hidden">
        <h4>Add New Expense</h4>
        <div class="form-row">
          <label>Name: <input type="text" id="newExpName" placeholder="e.g., Software subscription" required></label>
        </div>
        <div class="form-row">
          <label>Amount (EUR/month): <input type="number" id="newExpAmount" min="0" step="0.01" required></label>
        </div>
        <div class="form-row">
          <label>Category:
            <select id="newExpCategory" onchange="toggleDeductionField()">
              <option value="spainDeductible">Spain Deductible</option>
              <option value="belgiumCosts">Belgium Travel</option>
              <option value="private">Private</option>
            </select>
          </label>
        </div>
        <div class="form-row" id="deductionRow">
          <label>Deduction %: <input type="number" id="newExpDeduction" min="0" max="100" value="100"></label>
        </div>
        <div class="form-actions">
          <button onclick="submitNewExpense()">Add</button>
          <button onclick="hideAddForm()">Cancel</button>
        </div>
      </div>
    </div>

    <div class="scenario-section">
      <h2>Scenario Comparison</h2>
      <div id="scenarioCards" class="scenario-cards">
        <!-- Populated by renderScenarioCards() -->
      </div>
      <div id="comparisonTable">
        <!-- Populated by renderComparisonTable() in Plan 03 -->
      </div>
    </div>

    <div class="calendar-section">
      <h2>Belgium Calendar 2026</h2>
      <div id="calendarContainer">
        <!-- Populated by renderCalendar() -->
      </div>
    </div>

    <!-- Edit Scenario Modal -->
    <dialog id="editScenarioDialog" aria-labelledby="dialogTitle">
      <form method="dialog" class="edit-form">
        <header class="dialog-header">
          <h2 id="dialogTitle">Edit Scenario</h2>
          <button type="button" class="dialog-close" aria-label="Close" onclick="closeEditModal()">x</button>
        </header>

        <div class="dialog-body">
          <!-- Input pane (left) -->
          <div class="input-pane">
            <div class="form-group">
              <label for="editScenarioName">Scenario Name</label>
              <input type="text" id="editScenarioName" required autofocus>
            </div>

            <h3>Income & Expenses</h3>
            <div class="form-group">
              <label for="editMonthlyRevenue">Monthly Revenue (EUR)</label>
              <input type="number" id="editMonthlyRevenue" min="0" step="100">
            </div>
            <div class="form-group">
              <label for="editMonthlyExpenses">Monthly Expenses (EUR)</label>
              <input type="number" id="editMonthlyExpenses" min="0" step="100">
            </div>
            <div class="form-group">
              <label for="editBelgiumPattern">Belgium Work Pattern</label>
              <select id="editBelgiumPattern">
                <option value="low">Low (1,000 EUR/month)</option>
                <option value="high">High (2,500 EUR/month)</option>
              </select>
            </div>
            <div class="form-group checkbox-group">
              <input type="checkbox" id="editHasDescendant">
              <label for="editHasDescendant">1 Dependent Child (adds 2,400 EUR minimo)</label>
            </div>

            <details class="fiscal-overrides">
              <summary>Fiscal Overrides (What-If Analysis)</summary>
              <div class="form-group">
                <label for="editRetaOverride">RETA Monthly (EUR)</label>
                <input type="number" id="editRetaOverride" placeholder="428.40" min="0" step="0.01">
              </div>
              <div class="form-group">
                <label for="editMinimoPersonalOverride">Minimo Personal (EUR)</label>
                <input type="number" id="editMinimoPersonalOverride" placeholder="5550" min="0" step="1">
              </div>
              <div class="form-group">
                <label for="editMinimoDescOverride">Minimo Descendientes (EUR)</label>
                <input type="number" id="editMinimoDescOverride" placeholder="2400" min="0" step="1">
              </div>
            </details>
          </div>

          <!-- Results pane (right) - live updating -->
          <div class="results-pane">
            <h3>Calculated Results</h3>
            <div id="liveEditResults">
              <!-- Populated by updateLiveResults() -->
            </div>
          </div>
        </div>

        <footer class="dialog-footer">
          <button type="button" id="deleteScenarioBtn" class="danger-btn" onclick="confirmDeleteScenario()">Delete</button>
          <div class="spacer"></div>
          <button type="button" class="secondary-btn" onclick="closeEditModal()">Cancel</button>
          <button type="submit" value="save" class="primary-btn">Save Changes</button>
        </footer>
      </form>
    </dialog>

    <!-- Template Selection Dialog for New Scenario -->
    <dialog id="templateSelectDialog" aria-labelledby="templateDialogTitle">
      <form method="dialog">
        <header class="dialog-header">
          <h2 id="templateDialogTitle">Create New Scenario</h2>
          <button type="button" class="dialog-close" aria-label="Close" onclick="closeTemplateDialog()">x</button>
        </header>

        <div style="padding: 1.5rem;">
          <div class="form-group">
            <label for="newScenarioName">Scenario Name (required)</label>
            <input type="text" id="newScenarioName" required placeholder="e.g., Aggressive Growth">
          </div>

          <h3 style="margin-top: 1rem; font-size: 0.95rem;">Copy values from:</h3>
          <div class="template-options" id="templateOptions">
            <!-- Populated by showTemplateDialog() -->
          </div>
        </div>

        <footer class="dialog-footer">
          <div class="spacer"></div>
          <button type="button" class="secondary-btn" onclick="closeTemplateDialog()">Cancel</button>
          <button type="submit" value="create" class="primary-btn">Create Scenario</button>
        </footer>
      </form>
    </dialog>

    <div id="results" class="result"></div>
  </div>
  <script>
    // ============================================================
    // FISCAL_2025 CONSTANTS
    // ============================================================
    // All fiscal data verified from official AEAT/BOE sources
    // See: .planning/research/FISCAL_DATA.md for full citations
    // ============================================================

    const FISCAL_2025 = Object.freeze({
      // IRPF Brackets - Combined estatal + autonomica rates
      // Source: Wolters Kluwer, AEAT - unchanged from 2024
      // https://www.wolterskluwer.com/es-es/expert-insights/tramos-retenciones-irpf-2025-novedades
      //
      // baseTax = cumulative tax from all lower brackets
      // prevLimit = upper boundary of previous bracket
      IRPF_BRACKETS: Object.freeze([
        { upTo: 12450, rate: 0.19, baseTax: 0, prevLimit: 0 },
        { upTo: 20200, rate: 0.24, baseTax: 2365.50, prevLimit: 12450 },
        { upTo: 35200, rate: 0.30, baseTax: 4225.50, prevLimit: 20200 },
        { upTo: 60000, rate: 0.37, baseTax: 8725.50, prevLimit: 35200 },
        { upTo: 300000, rate: 0.45, baseTax: 17901.50, prevLimit: 60000 },
        { upTo: Infinity, rate: 0.47, baseTax: 125901.50, prevLimit: 300000 }
      ]),

      // Personal/Family minimums
      // Source: AEAT Manual Practico IRPF 2024
      // https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2024/c14-adecuacion-impuesto-circunstancias-personales/cuadro-resumen-minimo-personal-familiar.html
      MINIMO_PERSONAL: 5550,
      MINIMO_DESCENDIENTES_PRIMERO: 2400,

      // Fixed RETA from user registration
      // This is the actual cuota paid, not a calculated value
      // Source: User's Seguridad Social registration document
      RETA_MONTHLY: 428.40,
      RETA_ANNUAL: 5140.80,

      // Gastos dificil justificacion (Estimacion Directa Simplificada)
      // Source: AEAT Estimacion Directa Simplificada
      // https://sede.agenciatributaria.gob.es/Sede/irpf/empresarios-individuales-profesionales/regimenes-determinar-rendimiento-actividad/estimacion-directa-simplificada.html
      // Note: Was 7% in 2023, reverted to 5% for 2024 onwards
      GASTOS_DIFICIL_RATE: 0.05,
      GASTOS_DIFICIL_MAX: 2000,

      // Private costs (fixed, not deductible)
      // Breakdown: Rent 70% (808.50) + GSM 50% (27.50) + Electricity 91% (91) + Auto (600) + Insurance (200)
      PRIVATE_COSTS_MONTHLY: 1727
    });

    // ============================================================
    // OFFICIAL SOURCE CITATIONS
    // ============================================================
    // All fiscal data traced to official AEAT/BOE/Seguridad Social sources
    // ============================================================

    // ============================================================
    // CALENDAR CONSTANTS
    // ============================================================
    // Data structures for Belgium presence calendar (Feb-Dec 2026)
    // ============================================================

    const CALENDAR_STORAGE_KEY = 'autonomo_calendar_v1';

    const DAY_STATUS = Object.freeze({
      UNSET: 'unset',
      BELGIUM: 'belgium',
      SPAIN: 'spain',
      TRAVEL: 'travel'
    });

    const DEFAULT_CALENDAR_STATE = Object.freeze({
      version: 1,
      year: 2026,
      startMonth: 1,  // February (0-indexed)
      endMonth: 11,   // December (0-indexed)
      days: {},       // { "2026-02-15": { status: "belgium", contracted: true } }
      contractedPatternApplied: false,
      lastModified: null,
      currentMonth: 1  // February (0-indexed) - for navigation
    });

    // ============================================================
    // CALENDAR STATE MANAGEMENT
    // ============================================================
    // localStorage persistence for calendar state
    // ============================================================

    /**
     * Convert Date to ISO date key string (YYYY-MM-DD)
     * @param {Date} date - Date object
     * @returns {string} - ISO date string like "2026-02-15"
     */
    function toISODateKey(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    /**
     * Load calendar state from localStorage
     * Falls back to DEFAULT_CALENDAR_STATE on error or invalid data
     * @returns {object} - Calendar state object (mutable clone)
     */
    function loadCalendarState() {
      try {
        const stored = localStorage.getItem(CALENDAR_STORAGE_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);
          // Version check for future migration support
          if (parsed && parsed.version === 1) {
            return parsed;
          }
        }
      } catch (e) {
        console.warn('localStorage calendar load failed:', e.message);
      }
      // Return mutable clone of defaults
      return structuredClone(DEFAULT_CALENDAR_STATE);
    }

    /**
     * Save calendar state to localStorage
     * Updates lastModified timestamp
     * @returns {boolean} - True if save succeeded
     */
    function saveCalendarState() {
      try {
        calendarState.lastModified = new Date().toISOString();
        localStorage.setItem(CALENDAR_STORAGE_KEY, JSON.stringify(calendarState));
        return true;
      } catch (e) {
        if (e.name === 'QuotaExceededError') {
          console.warn('localStorage quota exceeded - calendar state not persisted');
        } else {
          console.warn('localStorage calendar save failed:', e.message);
        }
        return false;
      }
    }

    // Global calendar state - initialized from localStorage or defaults
    let calendarState = loadCalendarState();

    // ============================================================
    // CALENDAR RENDERING FUNCTIONS
    // ============================================================
    // Month grid rendering with navigation for Feb-Dec 2026
    // ============================================================

    /**
     * Get month grid as 2D array of weeks
     * Each week is 7 cells (Date or null for empty padding)
     * Uses Monday-start week alignment
     *
     * @param {number} year - Year (e.g., 2026)
     * @param {number} month - Month (0-indexed, 0=January)
     * @returns {array} - Array of weeks, each week is array of 7 elements
     */
    function getMonthGrid(year, month) {
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const totalDays = lastDay.getDate();

      // Monday-start: convert Sunday=0 to 6, Mon=1 to 0, etc.
      const startOffset = (firstDay.getDay() + 6) % 7;

      const weeks = [];
      let currentWeek = [];

      // Add empty cells for days before month starts
      for (let i = 0; i < startOffset; i++) {
        currentWeek.push(null);
      }

      // Add days of month
      for (let day = 1; day <= totalDays; day++) {
        currentWeek.push(new Date(year, month, day));

        if (currentWeek.length === 7) {
          weeks.push(currentWeek);
          currentWeek = [];
        }
      }

      // Add empty cells to complete last week
      while (currentWeek.length > 0 && currentWeek.length < 7) {
        currentWeek.push(null);
      }
      if (currentWeek.length > 0) {
        weeks.push(currentWeek);
      }

      return weeks;
    }

    /**
     * Get status emoji for a day status
     * @param {string} status - Day status from DAY_STATUS
     * @returns {string} - Emoji character
     */
    function getStatusEmoji(status) {
      switch (status) {
        case DAY_STATUS.BELGIUM: return '\u{1F1E7}\u{1F1EA}'; // Flag Belgium
        case DAY_STATUS.SPAIN: return '\u{1F1EA}\u{1F1F8}'; // Flag Spain
        case DAY_STATUS.TRAVEL: return '\u{2708}\u{FE0F}'; // Airplane
        default: return '';
      }
    }

    /**
     * Navigate to different month
     * Updates currentMonth within bounds [startMonth, endMonth]
     *
     * @param {number} delta - Direction (-1 for prev, +1 for next)
     */
    function navigateMonth(delta) {
      const newMonth = calendarState.currentMonth + delta;
      if (newMonth >= calendarState.startMonth && newMonth <= calendarState.endMonth) {
        calendarState.currentMonth = newMonth;
        saveCalendarState();
        renderCalendar();
      }
    }

    /**
     * Render calendar for current month
     * Shows month header with navigation and day grid
     */
    function renderCalendar() {
      const container = document.getElementById('calendarContainer');
      if (!container) return;

      const year = calendarState.year;
      const month = calendarState.currentMonth;

      // Get month name
      const monthName = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' })
        .format(new Date(year, month, 1));

      // Check navigation bounds
      const canPrev = month > calendarState.startMonth;
      const canNext = month < calendarState.endMonth;

      // Build header
      const headerHtml = `
        <div class="calendar-header">
          <button class="nav-btn" onclick="navigateMonth(-1)" ${canPrev ? '' : 'disabled'}>
            &larr; Prev
          </button>
          <h3>${monthName}</h3>
          <button class="nav-btn" onclick="navigateMonth(1)" ${canNext ? '' : 'disabled'}>
            Next &rarr;
          </button>
        </div>
      `;

      // Build grid
      const weeks = getMonthGrid(year, month);
      const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

      let gridHtml = '<div class="calendar-grid">';

      // Day headers
      dayNames.forEach(name => {
        gridHtml += `<div class="day-header">${name}</div>`;
      });

      // Day cells
      weeks.forEach(week => {
        week.forEach(date => {
          if (date === null) {
            gridHtml += '<div class="day-cell empty"></div>';
          } else {
            const dateKey = toISODateKey(date);
            const dayData = calendarState.days[dateKey] || {};
            const status = dayData.status || DAY_STATUS.UNSET;
            const isContracted = dayData.contracted === true;
            const emoji = getStatusEmoji(status);

            gridHtml += `
              <div class="day-cell ${status}" data-date="${dateKey}">
                <span class="day-number">${date.getDate()}</span>
                ${isContracted ? '<span class="contracted-badge">C</span>' : ''}
                <span class="status-emoji">${emoji}</span>
              </div>
            `;
          }
        });
      });

      gridHtml += '</div>';

      container.innerHTML = headerHtml + gridHtml;
    }

    const SOURCES = Object.freeze({
      IRPF_BRACKETS: {
        name: "IRPF Tramos 2025",
        source: "AEAT / Wolters Kluwer",
        url: "https://www.wolterskluwer.com/es-es/expert-insights/tramos-retenciones-irpf-2025-novedades",
        note: "Unchanged from 2024. Combined estatal + autonomica rates.",
        confidence: "HIGH"
      },
      MINIMO_PERSONAL: {
        name: "Minimo del Contribuyente",
        source: "AEAT Manual Practico IRPF 2024",
        url: "https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2024/c14-adecuacion-impuesto-circunstancias-personales/cuadro-resumen-minimo-personal-familiar.html",
        note: "5,550 EUR for all taxpayers regardless of age.",
        confidence: "HIGH"
      },
      MINIMO_DESCENDIENTES: {
        name: "Minimo por Descendientes",
        source: "AEAT",
        url: "https://sede.agenciatributaria.gob.es/Sede/ciudadanos-familias-personas-discapacidad/minimo-personal-familiar/minimo-descendientes.html",
        note: "2,400 EUR for first child. Add 2,800 EUR if under 3 years old.",
        confidence: "HIGH"
      },
      RETA: {
        name: "Cuota RETA",
        source: "User registration document / BOE",
        url: "https://www.boe.es/diario_boe/txt.php?id=BOE-A-2025-3780",
        note: "Fixed cuota 428.40 EUR/month from autonomo registration.",
        confidence: "HIGH"
      },
      GASTOS_DIFICIL: {
        name: "Gastos de Dificil Justificacion",
        source: "AEAT Estimacion Directa Simplificada",
        url: "https://sede.agenciatributaria.gob.es/Sede/irpf/empresarios-individuales-profesionales/regimenes-determinar-rendimiento-actividad/estimacion-directa-simplificada.html",
        note: "5% of rendimiento neto, maximum 2,000 EUR/year. Was 7% only in 2023.",
        confidence: "HIGH"
      },
      MINIMO_APPLICATION: {
        name: "4-Phase Minimo Method",
        source: "AEAT Cuotas Integras Example",
        url: "https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2022/c15-calculo-impuesto-determinacion-cuotas-integras/ejemplo-practico-calculo-cuotas-integras-autonomica.html",
        note: "Minimos reduce TAX LIABILITY, not taxable base. Tax on minimo is subtracted from tax on full base.",
        confidence: "HIGH"
      },
      DIETAS: {
        name: "Dietas y Asignaciones para Gastos de Viaje",
        source: "Reglamento IRPF Art. 9",
        url: "https://www.boe.es/buscar/act.php?id=BOE-A-2007-6820&tn=1&p=20231228#a9",
        note: "Abroad: 91.35 EUR/day with overnight, 48.08 EUR without. Spain: 53.34 EUR/day with overnight, 26.67 EUR without.",
        confidence: "HIGH"
      }
    });

    // ============================================================
    // EXPENSE DATA CONSTANTS
    // ============================================================
    // Pre-filled expense data for Spain deductible, Belgium costs, and private
    // All amounts from CLAUDE.md Fixed Costs section
    // ============================================================

    const DEFAULT_EXPENSES = Object.freeze({
      version: 1,
      belgiumPattern: 'high',  // 'low' (1000) or 'high' (2500)
      categories: Object.freeze({
        spainDeductible: Object.freeze([
          Object.freeze({ id: 'huur', name: 'Huur (Rent)', baseAmount: 1155, deductionPct: 30, deletable: true }),
          Object.freeze({ id: 'gsm', name: 'GSM (Mobile)', baseAmount: 55, deductionPct: 50, deletable: true }),
          Object.freeze({ id: 'elektriciteit', name: 'Elektriciteit', baseAmount: 100, deductionPct: 9, deletable: true })
        ]),
        belgiumCosts: Object.freeze([
          Object.freeze({ id: 'belgium-travel', name: 'Belgium Work Costs', amount: 2500, isPatternLinked: true, deletable: true })
        ]),
        private: Object.freeze([
          Object.freeze({ id: 'huur-private', name: 'Huur 70%', amount: 808.50, deletable: true }),
          Object.freeze({ id: 'gsm-private', name: 'GSM 50%', amount: 27.50, deletable: true }),
          Object.freeze({ id: 'elektriciteit-private', name: 'Elektriciteit 91%', amount: 91, deletable: true }),
          Object.freeze({ id: 'auto', name: 'Auto', amount: 600, deletable: true }),
          Object.freeze({ id: 'verzekeringen', name: 'Verzekeringen', amount: 200, deletable: true })
        ])
      })
    });

    // ============================================================
    // LOCALSTORAGE PERSISTENCE
    // ============================================================
    // Expense data persists between browser sessions
    // Graceful fallback for Safari private mode and quota errors
    // ============================================================

    const STORAGE_KEY = 'autonomo_expenses_v1';

    /**
     * Load expenses from localStorage
     * Falls back to DEFAULT_EXPENSES on error or invalid data
     * @returns {object} - Expense data object (mutable clone)
     */
    function loadExpenses() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);
          // Version check for future migration support
          if (parsed && parsed.version === 1) {
            return parsed;
          }
        }
      } catch (e) {
        console.warn('localStorage load failed (Safari private mode?):', e.message);
      }
      // Return mutable clone of defaults
      return structuredClone(DEFAULT_EXPENSES);
    }

    /**
     * Save expenses to localStorage
     * Handles QuotaExceededError gracefully
     * @returns {boolean} - True if save succeeded
     */
    function saveExpenses() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(expenseData));
        return true;
      } catch (e) {
        if (e.name === 'QuotaExceededError') {
          console.warn('localStorage quota exceeded - changes not persisted');
        } else {
          console.warn('localStorage save failed:', e.message);
        }
        return false;
      }
    }

    // Global expense data - initialized from localStorage or defaults
    let expenseData = loadExpenses();

    // ============================================================
    // SCENARIO PRESETS
    // ============================================================
    // Pre-configured scenarios (A-E) from CLAUDE.md
    // Values: A(3K), B(6K), C(9K), D(12K), E(18K)
    // Belgium patterns: A/B use 'low' (1K), C/D/E use 'high' (2.5K)
    // ============================================================

    const SCENARIO_PRESETS = Object.freeze({
      'A': Object.freeze({
        id: 'A',
        name: 'Scenario A',
        isPreset: true,
        monthlyRevenue: 3000,
        monthlyExpenses: 750,
        belgiumPattern: 'low',  // 1000 EUR
        hasDescendant: true,
        fiscalOverrides: null
      }),
      'B': Object.freeze({
        id: 'B',
        name: 'Scenario B',
        isPreset: true,
        monthlyRevenue: 6000,
        monthlyExpenses: 1500,
        belgiumPattern: 'low',
        hasDescendant: true,
        fiscalOverrides: null
      }),
      'C': Object.freeze({
        id: 'C',
        name: 'Scenario C',
        isPreset: true,
        monthlyRevenue: 9000,
        monthlyExpenses: 3000,
        belgiumPattern: 'high',  // 2500 EUR
        hasDescendant: true,
        fiscalOverrides: null
      }),
      'D': Object.freeze({
        id: 'D',
        name: 'Scenario D',
        isPreset: true,
        monthlyRevenue: 12000,
        monthlyExpenses: 5000,
        belgiumPattern: 'high',
        hasDescendant: true,
        fiscalOverrides: null
      }),
      'E': Object.freeze({
        id: 'E',
        name: 'Scenario E',
        isPreset: true,
        monthlyRevenue: 18000,
        monthlyExpenses: 8000,
        belgiumPattern: 'high',
        hasDescendant: true,
        fiscalOverrides: null
      })
    });

    // ============================================================
    // SCENARIO STATE MANAGEMENT
    // ============================================================
    // Centralized state with localStorage persistence
    // ============================================================

    const SCENARIO_STORAGE_KEY = 'autonomo_scenarios_v1';

    // Scenario state - initialized on DOMContentLoaded
    let scenarioState = null;

    /**
     * Initialize scenario state from localStorage or defaults
     * @returns {object} - Scenario state object
     */
    function initScenarioState() {
      try {
        const stored = localStorage.getItem(SCENARIO_STORAGE_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);
          if (parsed.version === 1) {
            return parsed;
          }
        }
      } catch (e) {
        console.warn('Failed to load scenarios:', e.message);
      }
      // Return default state with presets
      return {
        version: 1,
        scenarios: structuredClone(SCENARIO_PRESETS),
        selected: [],
        customOrder: []
      };
    }

    /**
     * Save scenario state to localStorage
     * @returns {boolean} - True if save succeeded
     */
    function saveScenarioState() {
      try {
        localStorage.setItem(SCENARIO_STORAGE_KEY, JSON.stringify(scenarioState));
        return true;
      } catch (e) {
        console.warn('Failed to save scenarios:', e.message);
        return false;
      }
    }

    // ============================================================
    // SCENARIO CALCULATION FUNCTIONS
    // ============================================================
    // Extends Phase 1 calculateFullIRPF with fiscal override support
    // ============================================================

    /**
     * Calculate full IRPF with optional fiscal configuration overrides
     * This is a copy of Phase 1's calculateFullIRPF but accepts a fiscal parameter
     * for what-if analysis (scenarios can override RETA, minimos, brackets)
     *
     * @param {number} monthlyRevenue - Gross monthly revenue in EUR
     * @param {number} monthlyDeductibleExpenses - Monthly deductible business expenses in EUR
     * @param {boolean} hasDescendant - Whether user has 1 dependent child
     * @param {object|null} fiscal - Optional fiscal config overrides (defaults to FISCAL_2025)
     * @returns {object} - Complete calculation breakdown
     */
    function calculateFullIRPFWithFiscal(monthlyRevenue, monthlyDeductibleExpenses = 0, hasDescendant = true, fiscal = null) {
      // Use provided fiscal config or default to FISCAL_2025
      const config = fiscal || FISCAL_2025;

      // Step 1: Annualize inputs
      const annualRevenue = monthlyRevenue * 12;
      const annualExpenses = monthlyDeductibleExpenses * 12;

      // Step 2: Total deductible = expenses + RETA
      const retaAnnual = config.RETA_ANNUAL || FISCAL_2025.RETA_ANNUAL;
      const totalDeductible = annualExpenses + retaAnnual;

      // Step 3: Rendimiento Neto Previo (before gastos dificil)
      const rendimientoNetoPrevio = annualRevenue - totalDeductible;

      // Step 4: Gastos dificil justificacion (use FISCAL_2025 rates - these don't change)
      const gastosDificil = calculateGastosDificil(rendimientoNetoPrevio);

      // Step 5: Rendimiento Neto = Base Liquidable (for autonomo)
      const rendimientoNeto = rendimientoNetoPrevio - gastosDificil;
      const baseLiquidable = Math.max(0, rendimientoNeto);

      // Step 6: Calculate minimos (can be overridden)
      const minimoPersonal = config.MINIMO_PERSONAL || FISCAL_2025.MINIMO_PERSONAL;
      const minimoDescendientes = hasDescendant
        ? (config.MINIMO_DESCENDIENTES_PRIMERO || FISCAL_2025.MINIMO_DESCENDIENTES_PRIMERO)
        : 0;
      const minimoTotal = minimoPersonal + minimoDescendientes;

      // Step 7: Cuota Integra using 4-phase method
      const cuotaIntegra = calculateCuotaIntegra(baseLiquidable, minimoTotal);

      // Step 8: Effective tax rate
      const effectiveRate = rendimientoNeto > 0 ? (cuotaIntegra / rendimientoNeto) : 0;

      // Step 9: Net income calculations
      const netAnnual = annualRevenue - totalDeductible - gastosDificil - cuotaIntegra;
      const netMonthly = netAnnual / 12;

      // Step 10: Leefgeld (after private costs)
      const privateCostsMonthly = config.PRIVATE_COSTS_MONTHLY || FISCAL_2025.PRIVATE_COSTS_MONTHLY;
      const leefgeld = netMonthly - privateCostsMonthly;

      const retaMonthly = config.RETA_MONTHLY || FISCAL_2025.RETA_MONTHLY;

      // Return all values matching Phase 1's calculateFullIRPF return structure
      return {
        // Inputs
        monthlyRevenue,
        annualRevenue,
        monthlyExpenses: monthlyDeductibleExpenses,
        annualExpenses,

        // Deductions
        retaMonthly,
        retaAnnual,
        totalDeductible,

        // Calculation chain
        rendimientoNetoPrevio,
        gastosDificil,
        rendimientoNeto,
        baseLiquidable,

        // Minimos (for display)
        minimoPersonal,
        minimoDescendientes,
        minimoTotal,

        // Tax
        cuotaIntegra,
        effectiveRate,

        // Net income
        netAnnual,
        netMonthly,
        leefgeld,

        // Private costs (for reference)
        privateCostsMonthly
      };
    }

    /**
     * Calculate results for a scenario
     * Wraps calculateFullIRPFWithFiscal with scenario-specific inputs
     *
     * @param {object} scenario - Scenario object
     * @returns {object} - Complete calculation results
     */
    function calculateScenarioResults(scenario) {
      const belgiumCost = scenario.belgiumPattern === 'high' ? 2500 : 1000;
      const totalDeductible = scenario.monthlyExpenses + belgiumCost;

      // Allow fiscal overrides for what-if analysis
      const fiscal = scenario.fiscalOverrides
        ? { ...FISCAL_2025, ...scenario.fiscalOverrides }
        : FISCAL_2025;

      // Call calculateFullIRPFWithFiscal (derived from Phase 1's calculateFullIRPF)
      return calculateFullIRPFWithFiscal(
        scenario.monthlyRevenue,
        totalDeductible,
        scenario.hasDescendant,
        fiscal
      );
    }

    /**
     * Get all scenarios sorted by leefgeld (highest first)
     * Each scenario includes its calculated results
     *
     * @returns {array} - Array of scenarios with results, sorted by leefgeld descending
     */
    function getSortedScenarios() {
      const scenarios = Object.values(scenarioState.scenarios);
      return scenarios
        .map(s => ({
          ...s,
          results: calculateScenarioResults(s)
        }))
        .sort((a, b) => b.results.leefgeld - a.results.leefgeld);
    }

    // ============================================================
    // BELGIUM PATTERN TOGGLE
    // ============================================================
    // Toggle between low-travel (1K/month) and high-travel (2.5K/month)
    // Pattern affects Belgium costs breakdown and formula display
    // ============================================================

    /**
     * Update Belgium cost based on current pattern
     * Finds expense with isPatternLinked: true and updates amount
     */
    function updateBelgiumCost() {
      const belgiumExpense = expenseData.categories.belgiumCosts.find(e => e.isPatternLinked);
      if (belgiumExpense) {
        belgiumExpense.amount = expenseData.belgiumPattern === 'high' ? 2500 : 1000;
      }
    }

    /**
     * Initialize Belgium toggle switch
     * Sets initial state and adds change event listener
     */
    function initBelgiumToggle() {
      const toggle = document.getElementById('belgiumToggle');
      if (!toggle) return;  // Toggle not yet in DOM

      // Set initial state based on expenseData
      toggle.checked = expenseData.belgiumPattern === 'high';

      // Update label active states
      updateToggleLabels(toggle.checked);

      // Add change event listener
      toggle.addEventListener('change', (e) => {
        expenseData.belgiumPattern = e.target.checked ? 'high' : 'low';
        updateBelgiumCost();
        saveExpenses();
        updateToggleLabels(e.target.checked);
        renderAllSections();
        recalculateTotals();
      });
    }

    /**
     * Update toggle label active states
     * @param {boolean} isHigh - True if high pattern selected
     */
    function updateToggleLabels(isHigh) {
      const lowLabel = document.querySelector('.toggle-label.low');
      const highLabel = document.querySelector('.toggle-label.high');

      if (lowLabel) {
        lowLabel.classList.toggle('active', !isHigh);
      }
      if (highLabel) {
        highLabel.classList.toggle('active', isHigh);
      }
    }

    /**
     * Get Belgium breakdown formula for current pattern
     * Shows transparent calculation: days x dietas + flights x cost
     * @returns {string} - Formatted formula string
     */
    function getBelgiumBreakdownFormula() {
      const pattern = expenseData.belgiumPattern;

      if (pattern === 'high') {
        // High travel: ~17 days, 4 flights per month
        return `~17 days x ${formatEUR(91.35)} dietas + 4 flights x ${formatEUR(250)} = ~${formatEUR(2500)}`;
      } else {
        // Low travel: ~3 days, 1 flight per month
        return `~3 days x ${formatEUR(91.35)} dietas + 1 flight x ${formatEUR(250)} = ~${formatEUR(1000)}`;
      }
    }

    // ============================================================
    // EXPENSE DATA MANAGEMENT
    // ============================================================
    // Reset, calculation helpers, and totals for expense tracking
    // ============================================================

    /**
     * Reset all expenses to default values with confirmation
     * @returns {boolean} - True if reset occurred
     */
    function resetToDefaults() {
      if (confirm('Reset all expenses to default values? This cannot be undone.')) {
        expenseData = structuredClone(DEFAULT_EXPENSES);
        saveExpenses();
        renderAllSections();
        recalculateTotals();
        return true;
      }
      return false;
    }

    /**
     * Calculate deductible amount for an expense
     * Spain expenses have baseAmount * deductionPct; others use amount directly
     * @param {object} expense - Expense object
     * @returns {number} - Monthly deductible amount (rounded to 2 decimals)
     */
    function calculateDeductible(expense) {
      if (expense.baseAmount !== undefined && expense.deductionPct !== undefined) {
        return Math.round(expense.baseAmount * (expense.deductionPct / 100) * 100) / 100;
      }
      return Math.round((expense.amount || 0) * 100) / 100;
    }

    /**
     * Calculate total deductible for a category
     * @param {string} categoryKey - Key in expenseData.categories
     * @returns {number} - Total monthly amount (rounded to 2 decimals)
     */
    function calculateCategoryTotal(categoryKey) {
      const category = expenseData.categories[categoryKey];
      if (!category) return 0;

      const total = category.reduce((sum, exp) => sum + calculateDeductible(exp), 0);
      return Math.round(total * 100) / 100;
    }

    /**
     * Get all expense totals for integration with IRPF calculation
     * @returns {object} - Monthly and annual totals per category
     */
    function getExpenseTotals() {
      const spainMonthly = calculateCategoryTotal('spainDeductible');
      const belgiumMonthly = calculateCategoryTotal('belgiumCosts');
      const privateMonthly = calculateCategoryTotal('private');

      return {
        spainDeductible: {
          monthly: spainMonthly,
          annual: Math.round(spainMonthly * 12 * 100) / 100
        },
        belgiumCosts: {
          monthly: belgiumMonthly,
          annual: Math.round(belgiumMonthly * 12 * 100) / 100
        },
        private: {
          monthly: privateMonthly,
          annual: Math.round(privateMonthly * 12 * 100) / 100
        },
        totalDeductible: {
          monthly: Math.round((spainMonthly + belgiumMonthly) * 100) / 100,
          annual: Math.round((spainMonthly + belgiumMonthly) * 12 * 100) / 100
        }
      };
    }

    // ============================================================
    // EXPENSE SECTION RENDERING
    // ============================================================
    // Render expense sections with formulas, delete buttons, and totals
    // ============================================================

    /**
     * Format expense calculation formula for display
     * Shows transparent calculation: BASE x PERCENT% = RESULT
     * @param {object} expense - Expense object
     * @param {string} categoryKey - Category key for context
     * @returns {string} - Formatted formula string
     */
    function formatFormula(expense, categoryKey) {
      if (expense.baseAmount !== undefined && expense.deductionPct !== undefined) {
        // Spain deductible: show base x percent
        const result = expense.baseAmount * (expense.deductionPct / 100);
        return `${formatEUR(expense.baseAmount)} x ${expense.deductionPct}% = ${formatEUR(result)}`;
      } else if (categoryKey === 'private') {
        // Private: 0% deductible
        return `${formatEUR(expense.amount)} x 0% = ${formatEUR(0)}`;
      } else {
        // Belgium costs: 100% deductible
        return `${formatEUR(expense.amount)} x 100% = ${formatEUR(expense.amount)}`;
      }
    }

    /**
     * Render a single expense row with formula and delete button
     * @param {object} expense - Expense object
     * @param {string} categoryKey - Category key
     * @returns {string} - HTML string for expense row
     */
    function renderExpenseRow(expense, categoryKey) {
      const monthly = calculateDeductible(expense);
      const annual = Math.round(monthly * 12 * 100) / 100;

      return `
        <div class="expense-row" data-id="${expense.id}" data-category="${categoryKey}">
          <span class="expense-name">${expense.name}</span>
          <span class="expense-formula">${formatFormula(expense, categoryKey)}</span>
          <span class="expense-value">${formatEUR(monthly)}/month (${formatEUR(annual)}/year)</span>
          <div class="expense-actions">
            <button class="delete-btn" onclick="deleteExpense('${categoryKey}', '${expense.id}')" title="Delete">x</button>
          </div>
        </div>
      `;
    }

    /**
     * Render a complete expense section with header, rows, and add button
     * @param {string} categoryKey - Category key in expenseData.categories
     * @param {string} sectionClass - CSS class for section styling
     * @param {string} title - Section title
     * @returns {string} - HTML string for section
     */
    function renderExpenseSection(categoryKey, sectionClass, title) {
      const expenses = expenseData.categories[categoryKey] || [];
      const total = calculateCategoryTotal(categoryKey);
      const annual = Math.round(total * 12 * 100) / 100;

      let headerExtra = '';
      let breakdownHtml = '';

      // Belgium section has toggle and breakdown formula
      if (categoryKey === 'belgiumCosts') {
        const isHigh = expenseData.belgiumPattern === 'high';
        headerExtra = `
          <div class="toggle-switch">
            <span class="toggle-label low ${!isHigh ? 'active' : ''}">Low (1K)</span>
            <label>
              <input type="checkbox" id="belgiumToggle" ${isHigh ? 'checked' : ''}>
              <span class="slider"></span>
            </label>
            <span class="toggle-label high ${isHigh ? 'active' : ''}">High (2.5K)</span>
          </div>
        `;
        breakdownHtml = `<div class="belgium-breakdown">${getBelgiumBreakdownFormula()} ${sourceHint('DIETAS')}</div>`;
      }

      // Render expense rows
      const rowsHtml = expenses.map(exp => renderExpenseRow(exp, categoryKey)).join('');

      return `
        <div class="expense-section ${sectionClass}">
          <div class="section-header">
            <span class="section-title">${title}</span>
            ${headerExtra}
            <span class="section-total">Total: ${formatEUR(total)}/month (${formatEUR(annual)}/year)</span>
          </div>
          ${breakdownHtml}
          <div class="expense-rows">
            ${rowsHtml}
          </div>
          <button class="add-expense-btn" onclick="showAddForm('${categoryKey}')">+ Add Expense</button>
        </div>
      `;
    }

    /**
     * Render all expense sections
     * Updates the DOM with current expense data
     */
    function renderAllSections() {
      const spainEl = document.getElementById('spainSection');
      const belgiumEl = document.getElementById('belgiumSection');
      const privateEl = document.getElementById('privateSection');

      if (spainEl) {
        spainEl.innerHTML = renderExpenseSection('spainDeductible', 'spain-deductible', 'Spain Deductible Expenses');
      }
      if (belgiumEl) {
        belgiumEl.innerHTML = renderExpenseSection('belgiumCosts', 'belgium-costs', 'Belgium Work Costs');
        // Re-attach Belgium toggle listener after rendering
        initBelgiumToggle();
      }
      if (privateEl) {
        privateEl.innerHTML = renderExpenseSection('private', 'private', 'Private Expenses (Not Deductible)');
      }
    }

    // ============================================================
    // ADD/DELETE EXPENSE FUNCTIONALITY
    // ============================================================
    // User can add new expenses and delete existing ones
    // Changes trigger IRPF recalculation
    // ============================================================

    /**
     * Add a new expense to a category
     * @param {string} categoryKey - Category key in expenseData.categories
     * @param {object} expense - Expense object to add
     */
    function addExpense(categoryKey, expense) {
      expense.id = expense.id || crypto.randomUUID();
      expense.deletable = true;
      expenseData.categories[categoryKey].push(expense);
      saveExpenses();
      renderAllSections();
      recalculateTotals();
    }

    /**
     * Delete an expense from a category
     * @param {string} categoryKey - Category key in expenseData.categories
     * @param {string} expenseId - ID of expense to delete
     */
    function deleteExpense(categoryKey, expenseId) {
      const category = expenseData.categories[categoryKey];
      const index = category.findIndex(e => e.id === expenseId);
      if (index !== -1) {
        category.splice(index, 1);
        saveExpenses();
        renderAllSections();
        recalculateTotals();
      }
    }

    /**
     * Show the add expense form
     * @param {string} categoryKey - Category to pre-select
     */
    function showAddForm(categoryKey) {
      const form = document.getElementById('addExpenseForm');
      if (form) {
        form.classList.remove('hidden');
        const categorySelect = document.getElementById('newExpCategory');
        if (categorySelect) {
          categorySelect.value = categoryKey;
          toggleDeductionField();
        }
      }
    }

    /**
     * Hide the add expense form and clear values
     */
    function hideAddForm() {
      const form = document.getElementById('addExpenseForm');
      if (form) {
        form.classList.add('hidden');
        document.getElementById('newExpName').value = '';
        document.getElementById('newExpAmount').value = '';
        document.getElementById('newExpDeduction').value = '100';
      }
    }

    /**
     * Toggle visibility of deduction percentage field
     * Only shown for Spain Deductible expenses
     */
    function toggleDeductionField() {
      const category = document.getElementById('newExpCategory').value;
      const deductionRow = document.getElementById('deductionRow');
      if (deductionRow) {
        deductionRow.style.display = category === 'spainDeductible' ? 'block' : 'none';
      }
    }

    /**
     * Submit new expense from form
     * Validates input and adds to appropriate category
     */
    function submitNewExpense() {
      const name = document.getElementById('newExpName').value.trim();
      const amount = parseFloat(document.getElementById('newExpAmount').value) || 0;
      const category = document.getElementById('newExpCategory').value;
      const deduction = parseFloat(document.getElementById('newExpDeduction').value) || 100;

      // Validate
      if (!name) {
        alert('Please enter a name for the expense.');
        return;
      }
      if (amount < 0) {
        alert('Amount cannot be negative.');
        return;
      }

      let expense;
      if (category === 'spainDeductible') {
        expense = {
          name,
          baseAmount: amount,
          deductionPct: Math.min(100, Math.max(0, deduction))
        };
      } else {
        expense = { name, amount };
      }

      addExpense(category, expense);
      hideAddForm();
    }

    /**
     * Recalculate totals and update IRPF results
     * KEY INTEGRATION: Expense changes trigger full IRPF recalculation
     */
    function recalculateTotals() {
      const totals = getExpenseTotals();
      const monthlyRevenue = parseFloat(document.getElementById('monthlyRevenue').value) || 0;
      const hasDescendant = document.getElementById('hasDescendant').checked;

      // totalDeductible = Spain + Belgium (private is not deductible)
      const totalDeductible = totals.totalDeductible.monthly;

      // Calculate IRPF with expense totals
      const r = calculateFullIRPF(monthlyRevenue, totalDeductible, hasDescendant);

      // Get private costs from expense data (dynamic, not fixed)
      const privateCostsMonthly = totals.private.monthly;
      const leefgeld = r.netMonthly - privateCostsMonthly;

      const html = `
        <h2>Results</h2>

        <h3>Income</h3>
        <div class="breakdown">
          Monthly Revenue: ${formatEUR(r.monthlyRevenue)}<br>
          Annual Revenue: ${formatEUR(r.annualRevenue)}
        </div>

        <h3>Deductions</h3>
        <div class="breakdown">
          RETA (Seguridad Social): ${formatEUR(r.retaAnnual)} (${formatEUR(r.retaMonthly)}/month) ${sourceHint('RETA')}<br>
          Spain Deductible: ${formatEUR(totals.spainDeductible.annual)} (${formatEUR(totals.spainDeductible.monthly)}/month)<br>
          Belgium Work Costs: ${formatEUR(totals.belgiumCosts.annual)} (${formatEUR(totals.belgiumCosts.monthly)}/month)<br>
          <strong>Total Deductible: ${formatEUR(r.totalDeductible)}</strong>
        </div>

        <h3>IRPF Calculation ${sourceHint('IRPF_BRACKETS')}</h3>
        <div class="breakdown">
          Rendimiento Neto Previo: ${formatEUR(r.rendimientoNetoPrevio)}<br>
          Gastos Dificil Justificacion (5%, max 2000): ${formatEUR(r.gastosDificil)} ${sourceHint('GASTOS_DIFICIL')}<br>
          <strong>Rendimiento Neto / Base Liquidable: ${formatEUR(r.baseLiquidable)}</strong>
        </div>

        <h3>Minimos (reduce tax, not base) ${sourceHint('MINIMO_APPLICATION')}</h3>
        <div class="breakdown">
          Minimo Personal: ${formatEUR(r.minimoPersonal)} ${sourceHint('MINIMO_PERSONAL')}<br>
          Minimo por Descendientes: ${formatEUR(r.minimoDescendientes)} ${sourceHint('MINIMO_DESCENDIENTES')}<br>
          <strong>Total Minimos: ${formatEUR(r.minimoTotal)}</strong>
        </div>

        <h3>Tax</h3>
        <div class="breakdown">
          <strong>Cuota Integra (Annual IRPF): ${formatEUR(r.cuotaIntegra)}</strong><br>
          Effective Tax Rate: ${formatPercent(r.effectiveRate)}
        </div>

        <h3>Net Income</h3>
        <div class="breakdown">
          Annual Net: ${formatEUR(r.netAnnual)}<br>
          <strong>Monthly Net: ${formatEUR(r.netMonthly)}</strong><br>
          <hr>
          Private Costs: ${formatEUR(privateCostsMonthly)}/month (${formatEUR(privateCostsMonthly * 12)}/year)<br>
          <strong style="color: var(--accent);">Leefgeld (after all costs): ${formatEUR(leefgeld)}/month</strong>
        </div>

        ${createFootnotes()}
      `;

      document.getElementById('results').innerHTML = html;
    }

    // ============================================================
    // CALCULATION FUNCTIONS
    // ============================================================
    // Implements official AEAT IRPF calculation methodology
    // CRITICAL: Uses 4-phase method where minimos reduce TAX, not BASE
    // ============================================================

    /**
     * Apply progressive IRPF brackets to any amount
     * Uses cumulative baseTax approach for accuracy at bracket boundaries
     * @param {number} amount - Taxable amount in EUR
     * @returns {number} - Tax amount in EUR (rounded to 2 decimals)
     */
    function applyBrackets(amount) {
      if (amount <= 0) return 0;

      for (const bracket of FISCAL_2025.IRPF_BRACKETS) {
        if (amount <= bracket.upTo) {
          return Math.round((bracket.baseTax + (amount - bracket.prevLimit) * bracket.rate) * 100) / 100;
        }
      }
      // Fallback (should never reach with Infinity bound)
      const last = FISCAL_2025.IRPF_BRACKETS[FISCAL_2025.IRPF_BRACKETS.length - 1];
      return Math.round((last.baseTax + (amount - last.prevLimit) * last.rate) * 100) / 100;
    }

    /**
     * Calculate Cuota Integra using 4-phase AEAT method
     * CRITICAL: Minimos reduce TAX liability, NOT taxable base
     *
     * Method:
     * 1. Calculate tax on full base liquidable
     * 2. Calculate tax on minimo amount (capped at base liquidable)
     * 3. Subtract #2 from #1 to get cuota integra
     *
     * Source: AEAT practical examples
     * https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2022/c15-calculo-impuesto-determinacion-cuotas-integras/ejemplo-practico-calculo-cuotas-integras-autonomica.html
     *
     * @param {number} baseLiquidable - Taxable base after all deductions
     * @param {number} minimoTotal - Sum of minimo personal + descendientes
     * @returns {number} - Cuota integra (tax liability) in EUR
     */
    function calculateCuotaIntegra(baseLiquidable, minimoTotal) {
      const cuota1 = applyBrackets(baseLiquidable);
      const minimoApplicable = Math.min(minimoTotal, baseLiquidable);
      const cuota3 = applyBrackets(minimoApplicable);
      return Math.max(0, Math.round((cuota1 - cuota3) * 100) / 100);
    }

    /**
     * Calculate Gastos de Dificil Justificacion
     * For Estimacion Directa Simplificada: 5% with 2000 EUR annual cap
     *
     * Source: AEAT Estimacion Directa Simplificada
     * Note: Was 7% in 2023, reverted to 5% for 2024 onwards
     *
     * @param {number} rendimientoNetoPrevio - Net income before gastos dificil
     * @returns {number} - Deductible amount in EUR
     */
    function calculateGastosDificil(rendimientoNetoPrevio) {
      if (rendimientoNetoPrevio <= 0) return 0;
      const calculated = rendimientoNetoPrevio * FISCAL_2025.GASTOS_DIFICIL_RATE;
      return Math.round(Math.min(calculated, FISCAL_2025.GASTOS_DIFICIL_MAX) * 100) / 100;
    }

    /**
     * Main IRPF calculation function - returns all intermediate values
     *
     * CALC-05 Clarification:
     * The 7% reduccion rendimientos applies only when calculating the RETA base
     * for Social Security purposes. For IRPF, the actual RETA cuota paid
     * (428.40 EUR/month) is deducted as an expense. Since the user has a fixed
     * RETA cuota from registration, we simply deduct it as a business expense.
     *
     * @param {number} monthlyRevenue - Gross monthly revenue in EUR
     * @param {number} monthlyDeductibleExpenses - Monthly deductible business expenses in EUR
     * @param {boolean} hasDescendant - Whether user has 1 dependent child
     * @returns {object} - Complete calculation breakdown
     */
    function calculateFullIRPF(monthlyRevenue, monthlyDeductibleExpenses = 0, hasDescendant = true) {
      // Step 1: Annualize inputs
      const annualRevenue = monthlyRevenue * 12;
      const annualExpenses = monthlyDeductibleExpenses * 12;

      // Step 2: Total deductible = expenses + RETA (fixed cuota, not calculated)
      // CALC-05: RETA cuota is deducted as expense. The 7% reduccion is for SS, not IRPF.
      const totalDeductible = annualExpenses + FISCAL_2025.RETA_ANNUAL;

      // Step 3: Rendimiento Neto Previo (before gastos dificil)
      const rendimientoNetoPrevio = annualRevenue - totalDeductible;

      // Step 4: Gastos dificil justificacion
      const gastosDificil = calculateGastosDificil(rendimientoNetoPrevio);

      // Step 5: Rendimiento Neto = Base Liquidable (for autonomo)
      const rendimientoNeto = rendimientoNetoPrevio - gastosDificil;
      const baseLiquidable = Math.max(0, rendimientoNeto);

      // Step 6: Calculate minimos
      const minimoPersonal = FISCAL_2025.MINIMO_PERSONAL;
      const minimoDescendientes = hasDescendant ? FISCAL_2025.MINIMO_DESCENDIENTES_PRIMERO : 0;
      const minimoTotal = minimoPersonal + minimoDescendientes;

      // Step 7: Cuota Integra using 4-phase method
      const cuotaIntegra = calculateCuotaIntegra(baseLiquidable, minimoTotal);

      // Step 8: Effective tax rate
      const effectiveRate = rendimientoNeto > 0 ? (cuotaIntegra / rendimientoNeto) : 0;

      // Step 9: Net income calculations
      const netAnnual = annualRevenue - totalDeductible - gastosDificil - cuotaIntegra;
      const netMonthly = netAnnual / 12;

      // Step 10: Leefgeld (after private costs)
      const leefgeld = netMonthly - FISCAL_2025.PRIVATE_COSTS_MONTHLY;

      return {
        // Inputs
        monthlyRevenue,
        annualRevenue,
        monthlyExpenses: monthlyDeductibleExpenses,
        annualExpenses,

        // Deductions
        retaMonthly: FISCAL_2025.RETA_MONTHLY,
        retaAnnual: FISCAL_2025.RETA_ANNUAL,
        totalDeductible,

        // Calculation chain
        rendimientoNetoPrevio,
        gastosDificil,
        rendimientoNeto,
        baseLiquidable,

        // Minimos (for display)
        minimoPersonal,
        minimoDescendientes,
        minimoTotal,

        // Tax
        cuotaIntegra,
        effectiveRate,

        // Net income
        netAnnual,
        netMonthly,
        leefgeld,

        // Private costs (for reference)
        privateCostsMonthly: FISCAL_2025.PRIVATE_COSTS_MONTHLY
      };
    }

    // ============================================================
    // FORMATTING UTILITIES
    // ============================================================

    /**
     * Format amount as EUR currency (Spanish locale)
     * @param {number} amount - Amount in EUR
     * @returns {string} - Formatted string like "5.550,00 EUR"
     */
    function formatEUR(amount) {
      return new Intl.NumberFormat('es-ES', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(amount);
    }

    /**
     * Format decimal as percentage
     * @param {number} decimal - Decimal value (0.25 = 25%)
     * @returns {string} - Formatted percentage like "25,00 %"
     */
    function formatPercent(decimal) {
      return new Intl.NumberFormat('es-ES', {
        style: 'percent',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(decimal);
    }

    // ============================================================
    // SOURCE CITATION UTILITIES
    // ============================================================

    /**
     * Create source hint HTML for inline citations
     * @param {string} sourceKey - Key from SOURCES constant
     * @returns {string} - HTML string with tooltip
     */
    function sourceHint(sourceKey) {
      const s = SOURCES[sourceKey];
      if (!s) return '';
      const tooltip = `${s.source}: ${s.note}`;
      return `<span class="source-hint" data-tooltip="${tooltip.replace(/"/g, '&quot;')}" data-source="${sourceKey}">i</span>`;
    }

    /**
     * Create footnotes section HTML listing all sources
     * @returns {string} - HTML string with sources list
     */
    function createFootnotes() {
      let html = '<div class="footnotes"><h4>Sources</h4><ul>';
      for (const [key, s] of Object.entries(SOURCES)) {
        html += `<li>
          <strong>${s.name}</strong> -
          <a href="${s.url}" target="_blank" rel="noopener">${s.source}</a>
          <span class="confidence-${s.confidence.toLowerCase()}">[${s.confidence}]</span>
        </li>`;
      }
      html += '</ul></div>';
      return html;
    }

    // ============================================================
    // UI FUNCTIONS
    // ============================================================

    /**
     * Legacy calculate function - kept for compatibility
     * Now redirects to recalculateTotals()
     */
    function calculate() {
      recalculateTotals();
    }

    // ============================================================
    // SCENARIO CARD RENDERING
    // ============================================================
    // Renders scenario cards sorted by leefgeld (highest first)
    // ============================================================

    /**
     * Render all scenario cards sorted by leefgeld (highest first)
     * First card (optimal) shows "Highest Leefgeld" badge
     * Includes "+ New Scenario" button at the end
     */
    function renderScenarioCards() {
      const container = document.getElementById('scenarioCards');
      if (!container) return;

      const sorted = getSortedScenarios();

      const cardsHtml = sorted.map((scenario, index) => {
        const isOptimal = index === 0;
        const isSelected = scenarioState.selected.includes(scenario.id);
        const isCustom = !scenario.isPreset;
        const belgiumCost = scenario.belgiumPattern === 'high' ? 2500 : 1000;
        const totalExpenses = scenario.monthlyExpenses + belgiumCost;

        const classes = [
          'scenario-card',
          isOptimal ? 'optimal' : '',
          isSelected ? 'selected' : '',
          isCustom ? 'custom' : ''
        ].filter(Boolean).join(' ');

        return `
          <div class="${classes}" data-id="${scenario.id}">
            <div class="card-header">
              <input type="checkbox"
                     ${isSelected ? 'checked' : ''}
                     onchange="toggleScenarioSelection('${scenario.id}')"
                     aria-label="Select ${scenario.name} for comparison">
              <h3>${scenario.name}</h3>
              ${isOptimal ? '<span class="optimal-badge">Highest Leefgeld</span>' : ''}
            </div>

            <div class="card-metrics">
              <div class="metric">
                <span class="label">Revenue</span>
                <span class="value">${formatEUR(scenario.monthlyRevenue)}/mo</span>
              </div>
              <div class="metric">
                <span class="label">Expenses</span>
                <span class="value">${formatEUR(totalExpenses)}/mo</span>
              </div>
              <div class="metric">
                <span class="label">IRPF</span>
                <span class="value">${formatEUR(scenario.results.cuotaIntegra / 12)}/mo</span>
              </div>
              <div class="metric">
                <span class="label">RETA</span>
                <span class="value">${formatEUR(scenario.results.retaMonthly)}/mo</span>
              </div>
              <div class="metric highlight">
                <span class="label">Leefgeld</span>
                <span class="value">${formatEUR(scenario.results.leefgeld)}/mo</span>
              </div>
            </div>

            <button class="edit-btn" onclick="openEditModal('${scenario.id}')">
              Edit
            </button>
          </div>
        `;
      }).join('');

      // Add "+ New" button at end
      const newButtonHtml = `
        <button class="new-scenario-btn" onclick="showTemplateDialog()">+ New Scenario</button>
      `;

      container.innerHTML = cardsHtml + newButtonHtml;
    }

    /**
     * Toggle scenario selection for comparison
     * Updates state, saves to localStorage, and re-renders
     *
     * @param {string} scenarioId - ID of scenario to toggle
     */
    function toggleScenarioSelection(scenarioId) {
      const idx = scenarioState.selected.indexOf(scenarioId);
      if (idx === -1) {
        scenarioState.selected.push(scenarioId);
      } else {
        scenarioState.selected.splice(idx, 1);
      }
      saveScenarioState();
      renderScenarioCards();
      renderComparisonTable();
    }

    // ============================================================
    // COMPARISON TABLE RENDERING
    // ============================================================
    // Renders side-by-side comparison table for selected scenarios
    // ============================================================

    /**
     * Render comparison table for selected scenarios
     * Shows full calculation breakdown with sticky header and optimal highlighting
     */
    function renderComparisonTable() {
      const container = document.getElementById('comparisonTable');
      if (!container) return;

      const selectedIds = scenarioState.selected;

      // Empty state
      if (selectedIds.length === 0) {
        container.innerHTML = `
          <div class="comparison-empty">
            <p>Select scenarios using checkboxes to compare them side-by-side</p>
          </div>
        `;
        return;
      }

      // Get selected scenarios with results
      const scenarios = selectedIds
        .map(id => scenarioState.scenarios[id])
        .filter(Boolean)
        .map(s => ({
          ...s,
          results: calculateScenarioResults(s)
        }));

      // Verify all required properties exist on first results object (defensive check)
      if (scenarios.length > 0) {
        const requiredProps = [
          'annualRevenue', 'annualExpenses', 'retaAnnual', 'totalDeductible',
          'rendimientoNetoPrevio', 'gastosDificil', 'baseLiquidable',
          'minimoPersonal', 'minimoDescendientes', 'minimoTotal',
          'cuotaIntegra', 'effectiveRate', 'netAnnual', 'netMonthly',
          'leefgeld', 'privateCostsMonthly'
        ];
        const firstResults = scenarios[0].results;
        for (const prop of requiredProps) {
          if (firstResults[prop] === undefined) {
            console.error(`renderComparisonTable: missing property '${prop}' in results object. Check calculateFullIRPFWithFiscal return value in Plan 03-01.`);
          }
        }
      }

      // Find optimal values for highlighting
      const optimalLeefgeld = Math.max(...scenarios.map(s => s.results.leefgeld));
      const optimalEffRate = Math.min(...scenarios.map(s => s.results.effectiveRate));
      const optimalNetMonthly = Math.max(...scenarios.map(s => s.results.netMonthly));

      // Define metric rows (full breakdown per CONTEXT.md)
      const metrics = [
        { label: 'Monthly Revenue', getValue: (s) => s.monthlyRevenue, format: formatEUR },
        { label: 'Monthly Expenses', getValue: (s) => s.monthlyExpenses, format: formatEUR },
        { label: 'Belgium Work Costs', getValue: (s) => s.belgiumPattern === 'high' ? 2500 : 1000, format: formatEUR },
        { label: 'Total Monthly Expenses', getValue: (s) => s.monthlyExpenses + (s.belgiumPattern === 'high' ? 2500 : 1000), format: formatEUR },
        { divider: true },
        { label: 'Annual Revenue', getValue: (s) => s.results.annualRevenue, format: formatEUR },
        { label: 'RETA (Annual)', getValue: (s) => s.results.retaAnnual, format: formatEUR },
        { label: 'Annual Expenses', getValue: (s) => s.results.annualExpenses, format: formatEUR },
        { label: 'Total Deductible', getValue: (s) => s.results.totalDeductible, format: formatEUR },
        { divider: true },
        { label: 'Rendimiento Neto Previo', getValue: (s) => s.results.rendimientoNetoPrevio, format: formatEUR },
        { label: 'Gastos Dificil (5%)', getValue: (s) => s.results.gastosDificil, format: formatEUR },
        { label: 'Base Liquidable', getValue: (s) => s.results.baseLiquidable, format: formatEUR },
        { divider: true },
        { label: 'Minimo Personal', getValue: (s) => s.results.minimoPersonal, format: formatEUR },
        { label: 'Minimo Descendientes', getValue: (s) => s.results.minimoDescendientes, format: formatEUR },
        { label: 'Total Minimos', getValue: (s) => s.results.minimoTotal, format: formatEUR },
        { divider: true },
        { label: 'Cuota Integra (Annual IRPF)', getValue: (s) => s.results.cuotaIntegra, format: formatEUR },
        { label: 'Effective Tax Rate', getValue: (s) => s.results.effectiveRate, format: formatPercent, optimalMin: true },
        { divider: true },
        { label: 'Net Annual', getValue: (s) => s.results.netAnnual, format: formatEUR },
        { label: 'Net Monthly', getValue: (s) => s.results.netMonthly, format: formatEUR, optimalMax: optimalNetMonthly },
        { label: 'Private Costs', getValue: (s) => s.results.privateCostsMonthly, format: formatEUR },
        { label: 'Leefgeld', getValue: (s) => s.results.leefgeld, format: formatEUR, optimalMax: optimalLeefgeld, highlight: true }
      ];

      // Build table HTML
      let tableHtml = `
        <div class="comparison-container">
          <table class="comparison-table">
            <thead>
              <tr>
                <th>Metric</th>
                ${scenarios.map(s => `<th>${s.name}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
      `;

      metrics.forEach(metric => {
        if (metric.divider) {
          tableHtml += `<tr class="divider"><td colspan="${scenarios.length + 1}"></td></tr>`;
        } else {
          const rowClass = metric.highlight ? 'highlight-row' : '';
          tableHtml += `<tr class="${rowClass}">`;
          tableHtml += `<td>${metric.label}</td>`;

          scenarios.forEach(s => {
            const value = metric.getValue(s);
            let cellClass = '';

            // Determine if this value is optimal
            if (metric.optimalMax !== undefined && value === metric.optimalMax) {
              cellClass = 'optimal';
            }
            if (metric.optimalMin && value === optimalEffRate) {
              cellClass = 'optimal';
            }

            tableHtml += `<td class="${cellClass}">${metric.format(value)}</td>`;
          });

          tableHtml += '</tr>';
        }
      });

      tableHtml += `
            </tbody>
          </table>
        </div>
      `;

      container.innerHTML = tableHtml;
    }

    // ============================================================
    // EDIT MODAL FUNCTIONALITY
    // ============================================================
    // Modal for editing scenario values with live results preview
    // ============================================================

    let currentEditScenarioId = null;

    /**
     * Open edit modal for a scenario
     * Populates form with scenario values and shows modal
     *
     * @param {string} scenarioId - ID of scenario to edit
     */
    function openEditModal(scenarioId) {
      const scenario = scenarioState.scenarios[scenarioId];
      if (!scenario) return;

      currentEditScenarioId = scenarioId;
      const dialog = document.getElementById('editScenarioDialog');

      // Populate form fields
      document.getElementById('editScenarioName').value = scenario.name;
      document.getElementById('editMonthlyRevenue').value = scenario.monthlyRevenue;
      document.getElementById('editMonthlyExpenses').value = scenario.monthlyExpenses;
      document.getElementById('editBelgiumPattern').value = scenario.belgiumPattern;
      document.getElementById('editHasDescendant').checked = scenario.hasDescendant;

      // Populate fiscal overrides (empty means use default)
      const overrides = scenario.fiscalOverrides || {};
      document.getElementById('editRetaOverride').value = overrides.RETA_MONTHLY || '';
      document.getElementById('editMinimoPersonalOverride').value = overrides.MINIMO_PERSONAL || '';
      document.getElementById('editMinimoDescOverride').value = overrides.MINIMO_DESCENDIENTES_PRIMERO || '';

      // Show/hide delete button based on preset status
      const deleteBtn = document.getElementById('deleteScenarioBtn');
      deleteBtn.style.display = scenario.isPreset ? 'none' : 'block';

      // Update dialog title
      document.getElementById('dialogTitle').textContent = `Edit ${scenario.name}`;

      // Calculate and show initial results
      updateLiveResults();

      // Open modal
      dialog.showModal();
    }

    /**
     * Close edit modal without saving
     */
    function closeEditModal() {
      const dialog = document.getElementById('editScenarioDialog');
      dialog.close();
      currentEditScenarioId = null;
    }

    // ============================================================
    // LIVE RECALCULATION
    // ============================================================
    // requestAnimationFrame-debounced live recalculation on input
    // ============================================================

    let liveCalcRafId = null;

    /**
     * Handle input change in edit modal
     * Uses requestAnimationFrame for debouncing
     */
    function onScenarioInputChange() {
      // Cancel any pending recalculation
      if (liveCalcRafId) {
        cancelAnimationFrame(liveCalcRafId);
      }

      // Schedule recalculation for next frame
      liveCalcRafId = requestAnimationFrame(() => {
        updateLiveResults();
        liveCalcRafId = null;
      });
    }

    /**
     * Get current values from edit form
     * @returns {object} - Form values with fiscalOverrides if any
     */
    function getEditFormValues() {
      const monthlyRevenue = parseFloat(document.getElementById('editMonthlyRevenue').value) || 0;
      const monthlyExpenses = parseFloat(document.getElementById('editMonthlyExpenses').value) || 0;
      const belgiumPattern = document.getElementById('editBelgiumPattern').value;
      const hasDescendant = document.getElementById('editHasDescendant').checked;

      // Fiscal overrides (empty string = use default)
      const retaOverride = document.getElementById('editRetaOverride').value;
      const minimoPersonalOverride = document.getElementById('editMinimoPersonalOverride').value;
      const minimoDescOverride = document.getElementById('editMinimoDescOverride').value;

      let fiscalOverrides = null;
      if (retaOverride || minimoPersonalOverride || minimoDescOverride) {
        fiscalOverrides = {};
        if (retaOverride) {
          fiscalOverrides.RETA_MONTHLY = parseFloat(retaOverride);
          fiscalOverrides.RETA_ANNUAL = parseFloat(retaOverride) * 12;
        }
        if (minimoPersonalOverride) {
          fiscalOverrides.MINIMO_PERSONAL = parseFloat(minimoPersonalOverride);
        }
        if (minimoDescOverride) {
          fiscalOverrides.MINIMO_DESCENDIENTES_PRIMERO = parseFloat(minimoDescOverride);
        }
      }

      return {
        name: document.getElementById('editScenarioName').value.trim(),
        monthlyRevenue,
        monthlyExpenses,
        belgiumPattern,
        hasDescendant,
        fiscalOverrides
      };
    }

    /**
     * Update live results pane with calculated values
     * Called on every input change (debounced)
     */
    function updateLiveResults() {
      const values = getEditFormValues();
      const results = calculateScenarioResults(values);

      // Verify results object has all expected properties (defensive programming)
      // These properties are guaranteed by calculateFullIRPFWithFiscal in Plan 03-01
      const requiredProps = [
        'annualRevenue', 'totalDeductible', 'rendimientoNeto', 'gastosDificil',
        'baseLiquidable', 'minimoTotal', 'cuotaIntegra', 'effectiveRate',
        'retaAnnual', 'netMonthly', 'leefgeld'
      ];
      for (const prop of requiredProps) {
        if (results[prop] === undefined) {
          console.error(`updateLiveResults: missing property '${prop}' in results object`);
        }
      }

      const container = document.getElementById('liveEditResults');
      container.innerHTML = `
        <div class="live-result-row">
          <span class="label">Annual Revenue</span>
          <span class="value">${formatEUR(results.annualRevenue)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Total Deductible</span>
          <span class="value">${formatEUR(results.totalDeductible)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Rendimiento Neto</span>
          <span class="value">${formatEUR(results.rendimientoNeto)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Gastos Dificil (5%)</span>
          <span class="value">${formatEUR(results.gastosDificil)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Base Liquidable</span>
          <span class="value">${formatEUR(results.baseLiquidable)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Total Minimos</span>
          <span class="value">${formatEUR(results.minimoTotal)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Cuota Integra (IRPF)</span>
          <span class="value">${formatEUR(results.cuotaIntegra)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Effective Tax Rate</span>
          <span class="value">${formatPercent(results.effectiveRate)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">RETA Annual</span>
          <span class="value">${formatEUR(results.retaAnnual)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Net Monthly</span>
          <span class="value">${formatEUR(results.netMonthly)}</span>
        </div>
        <div class="live-result-row highlight">
          <span class="label">Leefgeld</span>
          <span class="value">${formatEUR(results.leefgeld)}/mo</span>
        </div>
      `;
    }

    // ============================================================
    // SAVE AND DELETE FUNCTIONALITY
    // ============================================================

    /**
     * Save changes from edit form to scenario state
     * Called when dialog closes with 'save' return value
     */
    function saveScenarioChanges() {
      if (!currentEditScenarioId) return;

      const values = getEditFormValues();

      // Validate name
      if (!values.name) {
        alert('Please enter a scenario name');
        return;
      }

      const scenario = scenarioState.scenarios[currentEditScenarioId];
      if (!scenario) return;

      // Update scenario (keep id and isPreset)
      Object.assign(scenario, {
        name: values.name,
        monthlyRevenue: values.monthlyRevenue,
        monthlyExpenses: values.monthlyExpenses,
        belgiumPattern: values.belgiumPattern,
        hasDescendant: values.hasDescendant,
        fiscalOverrides: values.fiscalOverrides
      });

      saveScenarioState();
      renderScenarioCards();
      renderComparisonTable();
    }

    /**
     * Confirm and delete current scenario
     * Only works for custom scenarios (not presets A-E)
     */
    function confirmDeleteScenario() {
      if (!currentEditScenarioId) return;

      const scenario = scenarioState.scenarios[currentEditScenarioId];
      if (!scenario) return;

      if (scenario.isPreset) {
        alert('Cannot delete preset scenarios (A-E). You can only delete custom scenarios.');
        return;
      }

      if (confirm(`Delete "${scenario.name}"? This cannot be undone.`)) {
        delete scenarioState.scenarios[currentEditScenarioId];
        scenarioState.customOrder = scenarioState.customOrder.filter(id => id !== currentEditScenarioId);
        scenarioState.selected = scenarioState.selected.filter(id => id !== currentEditScenarioId);
        saveScenarioState();
        closeEditModal();
        renderScenarioCards();
        renderComparisonTable();
      }
    }

    /**
     * Initialize edit dialog event handlers
     * Called on DOMContentLoaded
     */
    function initEditDialog() {
      const dialog = document.getElementById('editScenarioDialog');
      if (!dialog) return;

      // Handle form submit (Save button)
      dialog.addEventListener('close', () => {
        if (dialog.returnValue === 'save') {
          saveScenarioChanges();
        }
      });

      // Prevent Esc from saving (cancel event)
      dialog.addEventListener('cancel', (e) => {
        // Default behavior is fine - just closes without saving
      });

      // Attach input change handlers for live recalculation
      const inputs = dialog.querySelectorAll('input, select');
      inputs.forEach(input => {
        input.addEventListener('input', onScenarioInputChange);
        input.addEventListener('change', onScenarioInputChange); // For checkboxes and selects
      });
    }

    // ============================================================
    // TEMPLATE DIALOG / CUSTOM SCENARIO CREATION
    // ============================================================
    // Create new scenarios from existing scenario templates
    // ============================================================

    let selectedTemplateId = null;

    /**
     * Show template selection dialog for creating new scenario
     */
    function showTemplateDialog() {
      const dialog = document.getElementById('templateSelectDialog');
      const optionsContainer = document.getElementById('templateOptions');

      // Build template options from all scenarios
      const allScenarios = Object.values(scenarioState.scenarios);

      optionsContainer.innerHTML = allScenarios.map((s, index) => {
        const belgiumCost = s.belgiumPattern === 'high' ? 2500 : 1000;
        const checked = index === 0 ? 'checked' : '';

        return `
          <label class="template-option">
            <input type="radio" name="template" value="${s.id}" ${checked}>
            <div class="template-info">
              <div class="template-name">${s.name}</div>
              <div class="template-desc">${formatEUR(s.monthlyRevenue)}/mo revenue, ${formatEUR(s.monthlyExpenses + belgiumCost)}/mo expenses</div>
            </div>
          </label>
        `;
      }).join('');

      // Clear name input
      document.getElementById('newScenarioName').value = '';

      dialog.showModal();
    }

    /**
     * Close template dialog without creating
     */
    function closeTemplateDialog() {
      document.getElementById('templateSelectDialog').close();
    }

    /**
     * Initialize template dialog event handlers
     * Called on DOMContentLoaded
     */
    function initTemplateDialog() {
      const dialog = document.getElementById('templateSelectDialog');
      if (!dialog) return;

      dialog.addEventListener('close', () => {
        if (dialog.returnValue === 'create') {
          createCustomScenario();
        }
      });
    }

    /**
     * Create a new custom scenario from selected template
     * Called when template dialog closes with 'create' return value
     */
    function createCustomScenario() {
      const name = document.getElementById('newScenarioName').value.trim();
      if (!name) {
        alert('Please enter a name for the scenario');
        return;
      }

      // Get selected template
      const selectedRadio = document.querySelector('#templateOptions input[name="template"]:checked');
      if (!selectedRadio) {
        alert('Please select a template');
        return;
      }

      const templateId = selectedRadio.value;
      const template = scenarioState.scenarios[templateId];
      if (!template) return;

      // Create new scenario from template
      const newScenario = {
        ...structuredClone(template),
        id: crypto.randomUUID(),
        name: name,
        isPreset: false,
        fiscalOverrides: null  // Reset any overrides from template
      };

      // Add to state
      scenarioState.scenarios[newScenario.id] = newScenario;
      scenarioState.customOrder.push(newScenario.id);
      saveScenarioState();
      renderScenarioCards();
      renderComparisonTable();

      // Open edit modal for new scenario
      openEditModal(newScenario.id);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize scenario state
      scenarioState = initScenarioState();

      // Existing Phase 2 initialization
      renderAllSections();
      recalculateTotals();

      // Phase 3 initialization
      renderScenarioCards();
      renderComparisonTable();
      initEditDialog();
      initTemplateDialog();

      // Phase 4 initialization - Calendar
      renderCalendar();
    });
  </script>
</body>
</html>
