<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Autonomo Tax Calculator - 2025/2026</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ===========================================
       PHASE 5: DASHBOARD UI
       =========================================== */

    :root {
      /* Updated theme colors per CONTEXT.md */
      --bg: #1a1a1a;           /* Charcoal (was #1a1a2e) */
      --bg-surface: #242424;   /* Slightly lighter for cards */
      --bg-elevated: #2d2d44;  /* For modals, tooltips */
      --text: #eaeaea;
      --text-muted: #a0a0a0;
      --accent: #4ade80;

      /* Semantic colors per UI-07 */
      --positive: #4ade80;     /* green - income/positive values */
      --negative: #f87171;     /* red - expenses/negative values */
      --warning: #fb923c;      /* orange - threshold warnings */
      --belgium: #60a5fa;      /* blue - Belgium related */

      /* Typography per CONTEXT.md and UI-11 */
      --font-ui: 'DM Sans', system-ui, sans-serif;
      --font-mono: 'JetBrains Mono', 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Mono', 'Droid Sans Mono', 'Source Code Pro', monospace;
      --size-header: 20px;
      --size-numbers: 18px;
      --size-labels: 14px;
      --size-small: 12px;

      /* Spacing scale (Phase 7.2) */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      --spacing-2xl: 48px;

      /* Border radius tokens (Phase 7.2) */
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
    }
    body {
      font-family: var(--font-ui);
      background: var(--bg);
      color: var(--text);
      padding: 2rem;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      box-sizing: border-box;
    }

    /* Prevent horizontal overflow on html/body */
    html, body {
      overflow-x: hidden;
    }

    /* Text overflow handling */
    .expense-name,
    .metric .label,
    .block-row .label,
    .detail-row .label {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Number overflow prevention */
    .metric .value,
    .expense-value,
    .block-row .value,
    .detail-row .value {
      flex-shrink: 0;
    }

    /* ===========================================
       PHASE 7.2: GLOBAL POLISH
       =========================================== */

    /* Cross-browser compatibility */
    * {
      -webkit-tap-highlight-color: transparent; /* Remove tap highlight on iOS */
      -webkit-touch-callout: none; /* Disable long-press context menu on images */
    }

    /* Enable text selection for inputs and text */
    input, textarea, [contenteditable="true"] {
      -webkit-user-select: text;
      user-select: text;
    }

    /* Touch-action for interactive elements (prevents 300ms delay) */
    button, a, .day-cell, .scenario-card, .tab-label {
      touch-action: manipulation;
    }

    /* Safari flexbox fixes */
    .scenario-cards,
    .calendar-grid,
    .export-actions,
    .dialog-footer {
      -webkit-box-pack: start;
    }

    /* Focus-visible styles for keyboard accessibility */
    :focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Fallback for browsers without :focus-visible */
    @supports not selector(:focus-visible) {
      :focus {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
      }
    }

    /* Button consistency */
    button {
      font-family: var(--font-ui);
      font-weight: 500;
      border-radius: var(--radius-md);
      transition: background-color 0.15s ease, transform 0.1s ease;
      -webkit-appearance: none; /* Remove iOS button styling */
      appearance: none;
    }

    button:hover:not(:disabled) {
      transform: scale(1.02);
    }

    button:active:not(:disabled) {
      transform: scale(0.98);
    }

    /* Input cross-browser styling */
    input, select {
      -webkit-appearance: none;
      appearance: none;
    }

    /* Preserve native select dropdown arrow */
    select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a0a0a0' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      padding-right: 2rem;
    }

    /* ===========================================
       PHASE 5: TAB NAVIGATION
       =========================================== */

    /* Dashboard wrapper for relative positioning */
    .dashboard {
      position: relative;  /* For absolute positioned radio inputs */
    }

    /* Dashboard header (Phase 7.2: subtle gradient for depth) */
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-lg);
      padding-bottom: var(--spacing-md);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, transparent 100%);
    }

    .dashboard-title {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text);
    }

    .dashboard-subtitle {
      margin: 0.25rem 0 0 0;
      font-size: var(--size-small);
      color: var(--text-muted);
    }

    /* Hide radio buttons but keep accessible */
    .tab-input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    /* Tab navigation bar */
    .tab-nav {
      display: flex;
      gap: 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 1.5rem;
    }

    /* Tab labels as clickable buttons */
    .tab-label {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      color: var(--text-muted);
      font-weight: 500;
      font-size: var(--size-labels);
      transition: border-color 0.2s, color 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .tab-label:hover {
      color: var(--text);
    }

    /* Active tab styling (Phase 7.2: enhanced letter-spacing) */
    #tab-scenarios:checked ~ .tab-nav .tab-label[for="tab-scenarios"],
    #tab-calendar:checked ~ .tab-nav .tab-label[for="tab-calendar"],
    #tab-expenses:checked ~ .tab-nav .tab-label[for="tab-expenses"],
    #tab-details:checked ~ .tab-nav .tab-label[for="tab-details"],
    #tab-income:checked ~ .tab-nav .tab-label[for="tab-income"],
    #tab-compliance:checked ~ .tab-nav .tab-label[for="tab-compliance"] {
      border-bottom-color: var(--accent);
      color: var(--accent);
      letter-spacing: 0.75px;
    }

    /* Hide all tab content by default */
    .tab-panel {
      display: none;
    }

    /* Show content for checked tab */
    #tab-scenarios:checked ~ .tab-panels .panel-scenarios,
    #tab-calendar:checked ~ .tab-panels .panel-calendar,
    #tab-expenses:checked ~ .tab-panels .panel-expenses,
    #tab-details:checked ~ .tab-panels .panel-details,
    #tab-income:checked ~ .tab-panels .panel-income,
    #tab-compliance:checked ~ .tab-panels .panel-compliance {
      display: block;
    }

    /* ===========================================
       PHASE 8: INCOME TAB STYLES
       =========================================== */

    /* Income panel styles */
    .panel-income {
      padding: var(--spacing-md);
    }

    .income-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
      flex-wrap: wrap;
      gap: var(--spacing-sm);
    }

    .income-header h2 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
    }

    .income-summary {
      display: flex;
      gap: var(--spacing-md);
      align-items: center;
    }

    .income-total {
      font-weight: 600;
      color: var(--accent);
    }

    .income-count {
      color: var(--text-muted);
      font-size: var(--size-small);
    }

    .income-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
      gap: var(--spacing-md);
      flex-wrap: wrap;
    }

    .income-filters {
      display: flex;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
    }

    .income-filters select,
    .income-filters input {
      padding: 8px 12px;
      background: var(--bg-surface);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: var(--size-small);
    }

    .income-filters input {
      min-width: 200px;
    }

    .income-list {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    /* Income entry card */
    .income-entry {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--bg-surface);
      border-radius: var(--radius-md);
      border: 1px solid rgba(255,255,255,0.06);
      align-items: center;
    }

    .income-entry:hover {
      border-color: rgba(255,255,255,0.12);
    }

    .income-entry-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .income-client {
      font-weight: 600;
      color: var(--text);
    }

    .income-details {
      display: flex;
      gap: var(--spacing-md);
      font-size: var(--size-small);
      color: var(--text-muted);
    }

    .income-amount {
      font-family: var(--font-mono);
      font-size: var(--size-numbers);
      color: var(--accent);
      font-weight: 600;
    }

    .income-actions {
      display: flex;
      gap: var(--spacing-xs);
    }

    .income-actions button {
      padding: 6px 10px;
      font-size: var(--size-small);
      background: transparent;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      cursor: pointer;
    }

    .income-actions button:hover {
      background: rgba(255,255,255,0.05);
      color: var(--text);
    }

    .income-actions .delete-btn:hover {
      border-color: var(--negative);
      color: var(--negative);
    }

    /* Empty state */
    .income-empty {
      text-align: center;
      padding: var(--spacing-2xl);
      color: var(--text-muted);
    }

    /* Income dialog */
    #incomeDialog {
      max-width: 500px;
    }

    #incomeDialog .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-md);
    }

    /* Responsive: stack income entry on mobile */
    @media (max-width: 600px) {
      .income-entry {
        grid-template-columns: 1fr;
        gap: var(--spacing-sm);
      }

      .income-amount {
        text-align: left;
      }

      .income-actions {
        justify-content: flex-start;
      }

      .income-filters input {
        min-width: 150px;
      }

      #incomeDialog .form-row {
        grid-template-columns: 1fr;
      }
    }

    /* ===========================================
       PHASE 7: COMPLIANCE TAB STYLES - COMPACT
       =========================================== */

    /* Compliance panel - reduced padding */
    .panel-compliance {
      padding: var(--spacing-md);
    }

    .panel-compliance h2 {
      margin: 0 0 8px 0;
      font-size: 1rem;
      font-weight: 600;
    }

    /* Compliance sections - minimal spacing */
    .compliance-section {
      margin-bottom: 4px;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: var(--radius-sm);
      overflow: hidden;
    }

    .compliance-section:last-child {
      margin-bottom: 0;
    }

    .compliance-section .section-header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(255,255,255,0.02);
      border: none;
      color: var(--text);
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      text-align: left;
      transition: background 0.15s ease;
    }

    .compliance-section .section-header:hover {
      background: rgba(255,255,255,0.05);
    }

    .compliance-section .section-header[aria-expanded="true"] {
      background: rgba(74, 222, 128, 0.08);
    }

    .compliance-section .section-icon {
      font-size: 0.7rem;
      transition: transform 0.15s ease;
      color: var(--text-muted);
      flex-shrink: 0;
    }

    .compliance-section .section-header[aria-expanded="true"] .section-icon {
      transform: rotate(90deg);
      color: var(--accent);
    }

    /* Compact content area */
    .compliance-section .section-content {
      padding: 10px 12px 12px;
      background: rgba(0,0,0,0.15);
      font-size: 0.85rem;
      line-height: 1.5;
    }

    .compliance-section .section-content[hidden] {
      display: none;
    }

    /* Legal text - compact quote style */
    .legal-text {
      background: rgba(255,255,255,0.02);
      border-left: 2px solid var(--accent);
      padding: 8px 12px;
      margin: 0 0 8px 0;
      font-style: italic;
      font-size: 0.8rem;
      line-height: 1.5;
      color: var(--text-muted);
    }

    /* Plain summary - tighter */
    .plain-summary {
      font-size: 0.85rem;
      line-height: 1.5;
      color: var(--text);
      margin: 0 0 8px 0;
      padding: 0;
    }

    .plain-summary:last-child {
      margin-bottom: 0;
    }

    .plain-summary strong {
      color: var(--accent);
    }

    /* Two-column layout for compliance content on wide screens */
    .compliance-columns {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    @media (min-width: 900px) {
      .compliance-columns {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-md);
      }
    }

    .compliance-col {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    /* Action phase grouping - minimal headers */
    .action-phase {
      margin-bottom: 2px;
    }

    .action-phase h3 {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin: 0 0 4px 0;
      padding: 4px 8px;
      background: rgba(255,255,255,0.02);
      border-radius: 4px;
    }

    .compliance-grid {
      display: grid;
      gap: 8px;
    }

    /* Compact fiscal table */
    .fiscal-table {
      width: 100%;
      border-collapse: collapse;
      margin: 6px 0;
      font-size: 0.8rem;
    }

    .fiscal-table th,
    .fiscal-table td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    .fiscal-table th {
      color: var(--text-muted);
      font-weight: 500;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .fiscal-table td.highlight {
      color: var(--accent);
      font-weight: 600;
    }

    .fiscal-table tbody tr:hover {
      background: rgba(255,255,255,0.03);
    }

    /* Source citation - minimal */
    .panel-compliance .source-citation {
      display: block;
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 6px;
      font-style: normal;
      opacity: 0.7;
    }

    /* Official source links (Phase 8: ENH-03/04/05) */
    .official-source-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--belgium);
      text-decoration: none;
      font-size: var(--size-small);
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      background: rgba(96, 165, 250, 0.1);
      border: 1px solid rgba(96, 165, 250, 0.2);
      transition: all 0.15s ease;
    }

    .official-source-link:hover {
      background: rgba(96, 165, 250, 0.2);
      border-color: var(--belgium);
    }

    /* Inline source citation (within text) */
    .inline-source-link {
      color: var(--belgium);
      text-decoration: none;
      border-bottom: 1px dotted var(--belgium);
    }

    .inline-source-link:hover {
      border-bottom-style: solid;
    }

    /* External link icon */
    .external-link-icon {
      font-size: 0.8em;
      opacity: 0.7;
    }

    .official-source-link:hover .external-link-icon,
    .inline-source-link:hover .external-link-icon {
      opacity: 1;
    }

    /* Sources section in Compliance */
    .sources-section {
      margin-top: var(--spacing-lg);
      padding: var(--spacing-md);
      background: var(--bg-surface);
      border-radius: var(--radius-md);
      border: 1px solid rgba(255,255,255,0.06);
    }

    .sources-section h3 {
      margin: 0 0 var(--spacing-md) 0;
      font-size: 1rem;
      color: var(--text);
    }

    .sources-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: var(--spacing-sm);
    }

    .sources-category {
      margin-bottom: var(--spacing-md);
    }

    .sources-category h4 {
      margin: 0 0 var(--spacing-xs) 0;
      font-size: var(--size-small);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .sources-category-links {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }

    /* Requirements list - compact */
    .requirements-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .requirements-list li {
      padding: 3px 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      display: flex;
      gap: 4px;
      font-size: 0.75rem;
      line-height: 1.3;
    }

    .requirements-list li:last-child {
      border-bottom: none;
    }

    .requirements-list .field-name {
      color: var(--accent);
      flex-shrink: 0;
      font-weight: 500;
      min-width: 120px;
    }

    /* Invalid list - compact */
    .invalid-list {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }

    .invalid-list h5 {
      color: var(--negative);
      margin: 0 0 6px 0;
      font-size: 0.8rem;
    }

    .invalid-list li {
      color: var(--text-muted);
    }

    .invalid-list .invalid-type {
      color: var(--negative);
      font-weight: 500;
    }

    /* Tie-breaker steps - ultra-compact numbered list */
    .tie-breaker-steps {
      list-style: none;
      padding: 0;
      margin: 0;
      counter-reset: step;
    }

    .tie-breaker-steps li {
      padding: 4px 4px 4px 24px;
      margin-bottom: 2px;
      counter-increment: step;
      position: relative;
      font-size: 0.75rem;
      line-height: 1.3;
    }

    .tie-breaker-steps li:last-child {
      margin-bottom: 0;
    }

    .tie-breaker-steps li::before {
      content: counter(step);
      position: absolute;
      left: 0;
      top: 4px;
      width: 16px;
      height: 16px;
      background: var(--accent);
      color: var(--bg);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.65rem;
    }

    .tie-breaker-steps .step-name {
      font-weight: 600;
      color: var(--text);
      display: inline;
      font-size: 0.75rem;
    }

    .tie-breaker-steps .step-name::after {
      content: " - ";
      color: var(--text-muted);
    }

    .tie-breaker-steps .step-plain {
      font-size: 0.75rem;
      color: var(--text-muted);
      display: inline;
    }

    /* Payment warning - compact */
    .payment-warning {
      background: rgba(248, 113, 113, 0.1);
      border-left: 2px solid var(--negative);
      padding: 8px 10px;
      margin-top: 8px;
      border-radius: 0 4px 4px 0;
      font-size: 0.8rem;
    }

    .payment-warning strong {
      color: var(--negative);
    }

    .payment-warning p {
      margin: 4px 0 0 0;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Entry/exit warning - similar to payment warning */
    .entry-exit-warning {
      background: rgba(251, 146, 60, 0.1);
      border-left: 2px solid var(--warning);
      padding: 8px 10px;
      margin-top: 8px;
      border-radius: 0 4px 4px 0;
      font-size: 0.8rem;
    }

    .entry-exit-warning strong {
      color: var(--warning);
    }

    .entry-exit-warning p {
      margin: 4px 0 0 0;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Compliance Warning Banner (COMP-01) */
    .compliance-warning-banner {
      display: none;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
      background: rgba(251, 146, 60, 0.15);
      border: 1px solid var(--warning);
      border-radius: 8px;
      color: var(--text);
    }

    .compliance-warning-banner.visible {
      display: flex;
    }

    .compliance-warning-banner.threshold-170 {
      background: rgba(251, 146, 60, 0.1);
    }

    .compliance-warning-banner.threshold-180 {
      background: rgba(251, 146, 60, 0.15);
    }

    .compliance-warning-banner.threshold-183 {
      background: rgba(248, 113, 113, 0.15);
      border-color: var(--negative);
    }

    .compliance-warning-banner .warning-text {
      font-size: 0.9rem;
      flex: 1;
    }

    .compliance-warning-banner .warning-text strong {
      color: var(--warning);
    }

    .compliance-warning-banner.threshold-183 .warning-text strong {
      color: var(--negative);
    }

    .compliance-warning-banner .dismiss-btn {
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 1.25rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      margin-left: 1rem;
      opacity: 0.7;
    }

    .compliance-warning-banner .dismiss-btn:hover {
      opacity: 1;
    }

    /* Global Disclaimer Footer (COMP-08) */
    .global-disclaimer {
      margin-top: 3rem;
      padding: 1rem;
      background: rgba(255,255,255,0.02);
      border-top: 1px solid rgba(255,255,255,0.1);
      text-align: center;
    }

    .global-disclaimer p {
      font-size: 0.8rem;
      color: var(--text-muted);
      line-height: 1.5;
      max-width: 800px;
      margin: 0 auto;
    }

    /* Entry/Exit Day Warning (COMP-10) */
    .entry-exit-warning {
      background: rgba(251, 146, 60, 0.1);
      border-left: 3px solid var(--warning);
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 0 4px 4px 0;
      font-size: 0.9rem;
    }

    .entry-exit-warning strong {
      color: var(--warning);
    }

    input[type="number"] { padding: 0.5rem; font-size: 1rem; width: 150px; }
    input[type="checkbox"] { width: auto; }
    button { padding: 0.5rem 1rem; cursor: pointer; }
    .result { margin-top: 1rem; font-family: monospace; }
    .breakdown { margin-left: 1rem; font-size: 0.9rem; opacity: 0.8; }
    .input-section {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .input-section label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* What-If Calculator Layout */
    .calculator-header {
      margin-bottom: var(--spacing-lg);
    }

    .calculator-header h2 {
      margin: 0 0 var(--spacing-xs) 0;
      color: var(--accent);
    }

    .calculator-subtitle {
      margin: 0;
      color: var(--text-muted);
      font-size: var(--size-labels);
    }

    .calculator-layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: var(--spacing-xl);
      align-items: start;
    }

    .calculator-inputs {
      position: sticky;
      top: var(--spacing-md);
    }

    .input-section {
      background: var(--bg-surface);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    .input-section-title {
      margin: 0 0 var(--spacing-md) 0;
      font-size: var(--size-labels);
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .input-field {
      margin-bottom: var(--spacing-md);
    }

    .input-field:last-child {
      margin-bottom: 0;
    }

    .input-field label {
      display: block;
      font-size: var(--size-small);
      color: var(--text);
      margin-bottom: var(--spacing-xs);
    }

    .input-with-euro {
      display: flex;
      align-items: center;
      background: var(--bg);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: var(--radius-sm);
      overflow: hidden;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .input-with-euro:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(74, 222, 128, 0.2);
    }

    .input-with-euro input {
      flex: 1;
      padding: var(--spacing-sm) var(--spacing-md);
      background: transparent;
      border: none;
      color: var(--text);
      font-family: var(--font-mono);
      font-size: var(--size-numbers);
      text-align: right;
      min-width: 0;
    }

    .input-with-euro input:focus {
      outline: none;
    }

    .input-unit {
      padding: var(--spacing-sm) var(--spacing-md);
      background: rgba(255,255,255,0.05);
      color: var(--text-muted);
      font-size: var(--size-small);
      white-space: nowrap;
    }

    .input-hint {
      display: block;
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
      opacity: 0.8;
    }

    .checkbox-field label {
      margin-bottom: 0;
    }

    .checkbox-inline {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      cursor: pointer;
    }

    .checkbox-inline input {
      width: 16px;
      height: 16px;
      accent-color: var(--accent);
    }

    /* Advanced Options */
    .advanced-section {
      background: var(--bg-surface);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-md);
    }

    .advanced-toggle {
      padding: var(--spacing-md);
      cursor: pointer;
      font-size: var(--size-small);
      color: var(--text-muted);
      list-style: none;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .advanced-toggle::before {
      content: '>';
      font-family: var(--font-mono);
      transition: transform 0.2s ease;
    }

    .advanced-section[open] .advanced-toggle::before {
      transform: rotate(90deg);
    }

    .advanced-toggle:hover {
      color: var(--accent);
    }

    .advanced-content {
      padding: 0 var(--spacing-md) var(--spacing-md);
      border-top: 1px solid rgba(255,255,255,0.1);
      padding-top: var(--spacing-md);
    }

    .calculator-actions {
      display: flex;
      gap: var(--spacing-sm);
    }

    .calculator-actions button {
      flex: 1;
    }

    .calculator-results {
      min-height: 400px;
    }

    /* Mobile responsive for calculator */
    @media (max-width: 900px) {
      .calculator-layout {
        grid-template-columns: 1fr;
      }

      .calculator-inputs {
        position: static;
      }

      .calculator-actions {
        flex-direction: column;
      }
    }

    /* Results Summary Cards */
    .results-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-xl);
    }

    .summary-card {
      background: var(--bg-surface);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      text-align: center;
    }

    .summary-card.highlight {
      background: rgba(74, 222, 128, 0.1);
      border-color: rgba(74, 222, 128, 0.3);
    }

    .summary-label {
      display: block;
      font-size: var(--size-small);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--spacing-xs);
    }

    .summary-value {
      font-family: var(--font-mono);
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text);
    }

    .summary-value.accent {
      color: var(--accent);
    }

    .summary-value.negative {
      color: var(--negative);
    }

    .summary-unit {
      font-size: 0.75rem;
      font-weight: 400;
      color: var(--text-muted);
      margin-left: 2px;
    }

    /* Results Grid */
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--spacing-lg);
    }

    .results-section {
      background: var(--bg-surface);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
    }

    .results-section-title {
      font-size: var(--size-labels);
      font-weight: 600;
      color: var(--accent);
      margin: 0 0 var(--spacing-md) 0;
      padding-bottom: var(--spacing-sm);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .results-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-xs) 0;
      font-size: var(--size-labels);
    }

    .results-row.total {
      border-top: 1px solid rgba(255,255,255,0.1);
      margin-top: var(--spacing-sm);
      padding-top: var(--spacing-sm);
      font-weight: 600;
    }

    .row-label {
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .row-value {
      font-family: var(--font-mono);
      color: var(--text);
    }

    /* Mobile: stack vertically */
    @media (max-width: 768px) {
      .details-layout {
        grid-template-columns: 1fr;
      }

      .details-sidebar {
        position: static;
      }

      .results-summary {
        grid-template-columns: repeat(2, 1fr);
      }

      .results-grid {
        grid-template-columns: 1fr;
      }
    }
    h2 { color: var(--accent); margin-top: 2rem; }
    h3 { margin-top: 1.5rem; margin-bottom: 0.5rem; opacity: 0.9; }
    hr { border: none; border-top: 1px solid rgba(255,255,255,0.2); margin: 0.5rem 0; }

    /* Source citation button styling (click to open modal) */
    .source-hint-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      margin-left: 4px;
      background: rgba(74, 222, 128, 0.2);
      border: 1px solid var(--accent);
      border-radius: 50%;
      font-size: 11px;
      font-weight: 600;
      color: var(--accent);
      cursor: pointer;
      vertical-align: middle;
      padding: 0;
      transition: background 0.15s ease, transform 0.1s ease;
    }

    .source-hint-btn:hover {
      background: var(--accent);
      color: var(--bg);
      transform: scale(1.1);
    }

    .source-hint-btn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Legacy hover tooltip styling (kept for calendar info) */
    .source-hint {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      margin-left: 4px;
      background: rgba(74, 222, 128, 0.2);
      border: 1px solid var(--accent);
      border-radius: 50%;
      font-size: 10px;
      color: var(--accent);
      cursor: help;
      position: relative;
      vertical-align: middle;
    }

    .source-hint:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #2d2d44;
      border: 1px solid var(--accent);
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      font-size: 11px;
      white-space: normal;
      max-width: 300px;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      margin-bottom: 8px;
    }

    .source-hint:hover::before {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--accent);
      z-index: 101;
    }

    /* Footnotes section */
    .footnotes {
      margin-top: 3rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .footnotes h4 {
      margin-bottom: 1rem;
      color: var(--accent);
    }

    .footnotes ul {
      list-style: none;
      padding: 0;
    }

    .footnotes li {
      margin-bottom: 0.5rem;
    }

    .footnotes a {
      color: var(--accent);
      text-decoration: none;
    }

    .footnotes a:hover {
      text-decoration: underline;
    }

    .confidence-high { color: #4ade80; }
    .confidence-medium { color: #facc15; }

    /* Expense Sections */
    .expenses-container {
      margin-top: 2rem;
    }

    .expense-section {
      margin-bottom: 2rem;
      padding: 1rem;
      border-radius: 8px;
      background: rgba(255,255,255,0.03);
    }

    .expense-section.spain-deductible {
      border-left: 3px solid #4ade80;  /* Green - deductible */
    }

    .expense-section.work-travel {
      border-left: 3px solid #60a5fa;  /* Blue - work travel */
    }

    .expense-section.private {
      border-left: 3px solid #f87171;  /* Red - not deductible */
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .section-title {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-total {
      font-family: 'JetBrains Mono', monospace;
      opacity: 0.8;
    }

    .expense-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .expense-row:last-child {
      border-bottom: none;
    }

    .expense-name {
      font-weight: 500;
      min-width: 150px;
    }

    .expense-formula {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      opacity: 0.7;
      flex: 1;
      text-align: center;
    }

    .expense-value {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      min-width: 200px;
      text-align: right;
    }

    .expense-actions {
      display: flex;
      gap: 0.25rem;
    }

    .delete-btn {
      background: transparent;
      border: 1px solid #f87171;
      color: #f87171;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      padding: 0;
    }

    .delete-btn:hover {
      background: #f87171;
      color: var(--bg);
    }

    /* Add Expense Form */
    .add-expense-btn {
      background: transparent;
      border: 1px dashed rgba(255,255,255,0.3);
      color: var(--text);
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 0.5rem;
      width: 100%;
    }

    .add-expense-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Expense Dialog Modal - use margin:auto for reliable centering */
    .expense-dialog {
      max-width: 400px;
      width: 90%;
      padding: 0;
      border: none;
      border-radius: 12px;
      background: var(--bg-surface);
      color: var(--text);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      /* Dialog centering using margin:auto (works with showModal) */
      margin: auto;
      position: fixed;
      inset: 0;
      height: fit-content;
    }

    .expense-dialog::backdrop {
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
    }

    /* Legacy add-form styles (kept for compatibility) */
    .add-form {
      background: rgba(0,0,0,0.2);
      padding: 1rem;
      border-radius: 4px;
      margin-top: 0.5rem;
    }

    .add-form.hidden {
      display: none;
    }

    .add-form h4 {
      margin: 0 0 1rem 0;
      color: var(--accent);
    }

    .form-row {
      margin-bottom: 0.75rem;
    }

    .form-row label {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.9rem;
    }

    .form-row input,
    .form-row select {
      padding: 0.5rem;
      background: var(--bg);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      color: var(--text);
    }

    .form-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .form-actions button {
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
    }

    .form-actions button:first-child {
      background: var(--accent);
      border: none;
      color: var(--bg);
    }

    .form-actions button:last-child {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.3);
      color: var(--text);
    }

    /* Reset button */
    .reset-btn {
      background: transparent;
      border: 1px solid #f87171;
      color: #f87171;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .reset-btn:hover {
      background: #f87171;
      color: var(--bg);
    }

    /* Detection badge for auto-detected expense categories (ENH-01) */
    .detection-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      border-radius: var(--radius-sm);
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }

    .detection-badge.suggested {
      background: rgba(74, 222, 128, 0.2);
      color: var(--accent);
      border: 1px solid var(--accent);
    }

    .detection-badge.medium {
      background: rgba(251, 146, 60, 0.2);
      color: var(--warning);
      border: 1px solid var(--warning);
    }

    .detection-hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
      font-style: italic;
    }

    .deduction-field-wrapper {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
    }

    .deduction-field-wrapper input {
      flex: 1;
      min-width: 80px;
    }

    /* Scenario Cards Section */
    .scenario-section {
      margin-top: 2rem;
    }

    .scenario-cards {
      display: flex;
      gap: 1rem;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      scroll-padding: 1rem;
      padding: 1rem 0 1.5rem 0;  /* Extra bottom padding for scrollbar clearance */
      -webkit-overflow-scrolling: touch;
      margin-bottom: 0.5rem;
    }

    /* Enhanced scenario cards per UI-02, UI-03, Phase 7.2 polish */
    .scenario-card {
      flex: 0 0 320px;           /* Wider for full breakdown */
      scroll-snap-align: start;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      box-shadow: 0 1px 3px rgba(0,0,0,0.3), 0 4px 12px rgba(0,0,0,0.2);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;           /* Indicate clickable */
    }

    .scenario-card:hover {
      transform: translateY(-6px);  /* Enhanced lift effect */
      box-shadow: 0 8px 24px rgba(74, 222, 128, 0.15), 0 4px 12px rgba(0,0,0,0.3);
    }

    /* Optimal scenario indicator - Bloomberg green highlight */
    .scenario-card.optimal {
      background: rgba(74, 222, 128, 0.08);
      border-color: rgba(74, 222, 128, 0.3);
    }

    .scenario-card.optimal:hover {
      box-shadow:
        0 8px 24px rgba(0,0,0,0.4),
        0 0 0 1px rgba(74, 222, 128, 0.4);  /* Stronger glow for optimal */
    }

    /* Custom scenario visual distinction */
    .scenario-card.custom {
      border-left: 3px solid #60a5fa;
    }

    /* Selected scenario */
    .scenario-card.selected {
      border: 2px solid var(--accent);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .card-header input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    .card-header h3 {
      margin: 0;
      font-size: 1.1rem;
      flex: 1;
    }

    .optimal-badge {
      background: var(--accent);
      color: var(--bg);
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-weight: 600;
    }

    /* Full breakdown metrics per CONTEXT.md */
    .card-metrics {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .metric {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      padding: 0.2rem 0;
    }

    .metric .label {
      color: var(--text-muted);
    }

    .metric .value {
      font-family: var(--font-mono);
      font-size: var(--size-labels);
    }

    /* Divider for metric groups */
    .metric.divider {
      padding: 0;
      margin: 0.4rem 0;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    /* Highlight row (leefgeld) */
    .metric.highlight {
      padding: 0.4rem 0;
      margin-top: 0.4rem;
      border-top: 1px solid rgba(255,255,255,0.15);
    }

    .metric.highlight .value {
      color: var(--accent);
      font-weight: 600;
      font-size: var(--size-numbers);
    }

    /* Color-coded values per UI-07 */
    .value-positive { color: var(--positive); }
    .value-negative { color: var(--negative); }
    .value-warning { color: var(--warning); }

    .edit-btn {
      margin-top: 1rem;
      width: 100%;
      padding: 0.5rem;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text);
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
    }

    .edit-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Scrollbar styling */
    .scenario-cards::-webkit-scrollbar {
      height: 8px;
    }

    .scenario-cards::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
    }

    .scenario-cards::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
    }

    /* Edit Modal Dialog - centered using margin:auto */
    dialog {
      background: var(--bg);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 0;
      max-width: 900px;
      width: 90vw;
      max-height: 90vh;
      /* Dialog centering */
      margin: auto;
      position: fixed;
      inset: 0;
      height: fit-content;
    }

    dialog::backdrop {
      background: rgba(0, 0, 0, 0.7);
      -webkit-backdrop-filter: blur(4px);
      backdrop-filter: blur(4px);
    }

    /* Detail modal for scenario breakdown (UI-04) */
    .detail-dialog {
      background: var(--bg);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 0;
      max-width: 500px;
      width: 90%;
      color: var(--text);
      /* Ensure proper centering */
      margin: auto;
      position: fixed;
      inset: 0;
      height: fit-content;
    }

    .detail-dialog::backdrop {
      background: rgba(0,0,0,0.7);
    }

    .detail-content {
      padding: 1.5rem;
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .detail-title {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
    }

    .detail-header .close-btn {
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 1.5rem;
      cursor: pointer;
      opacity: 0.7;
      padding: 0;
    }

    .detail-header .close-btn:hover {
      opacity: 1;
    }

    .detail-body {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .detail-section {
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      padding: 1rem;
    }

    .detail-section h4 {
      margin: 0 0 0.75rem 0;
      font-size: var(--size-labels);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 0.4rem 0;
      font-size: 0.9rem;
    }

    .detail-row .label {
      color: var(--text-muted);
    }

    .detail-row .value {
      font-family: var(--font-mono);
    }

    .detail-row.total {
      border-top: 1px solid rgba(255,255,255,0.1);
      margin-top: 0.5rem;
      padding-top: 0.75rem;
      font-weight: 600;
    }

    .detail-row.total .value {
      color: var(--accent);
    }

    .detail-footer {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .detail-footer button {
      flex: 1;
    }

    .dialog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .dialog-header h2 {
      margin: 0;
      color: var(--accent);
    }

    .dialog-close {
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      opacity: 0.7;
    }

    .dialog-close:hover {
      opacity: 1;
    }

    .dialog-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      padding: 1.5rem;
      max-height: 60vh;
      overflow-y: auto;
    }

    .input-pane, .results-pane {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .input-pane h3, .results-pane h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
      opacity: 0.8;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 0.5rem;
    }

    .results-pane {
      background: rgba(255,255,255,0.03);
      padding: 1rem;
      border-radius: 8px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .form-group label {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .form-group input,
    .form-group select {
      padding: 0.5rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .checkbox-group {
      flex-direction: row;
      align-items: center;
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    .fiscal-overrides {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .fiscal-overrides summary {
      cursor: pointer;
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .fiscal-overrides[open] summary {
      margin-bottom: 1rem;
    }

    /* Live results display */
    .live-result-row {
      display: flex;
      justify-content: space-between;
      padding: 0.4rem 0;
      font-size: 0.9rem;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .live-result-row:last-child {
      border-bottom: none;
    }

    .live-result-row .label {
      opacity: 0.7;
    }

    .live-result-row .value {
      font-family: 'JetBrains Mono', monospace;
    }

    .live-result-row.highlight {
      padding: 0.6rem 0;
      margin-top: 0.5rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .live-result-row.highlight .value {
      color: var(--accent);
      font-weight: 600;
      font-size: 1rem;
    }

    .dialog-footer {
      display: flex;
      gap: 1rem;
      padding: 1rem 1.5rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .dialog-footer .spacer {
      flex: 1;
    }

    .dialog-footer button {
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .primary-btn {
      background: var(--accent);
      color: var(--bg);
      border: none;
      font-weight: 600;
    }

    .primary-btn:hover {
      opacity: 0.9;
    }

    .secondary-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text);
    }

    .secondary-btn:hover {
      border-color: rgba(255,255,255,0.4);
    }

    .danger-btn {
      background: transparent;
      border: 1px solid #f87171;
      color: #f87171;
    }

    .danger-btn:hover {
      background: #f87171;
      color: var(--bg);
    }

    /* Responsive: stack on mobile */
    @media (max-width: 700px) {
      .dialog-body {
        grid-template-columns: 1fr;
      }
    }

    /* Comparison Table with sticky first column (UI-06) */
    .comparison-container {
      margin-top: 2rem;
      overflow-x: auto;      /* Enable horizontal scroll */
      overflow-y: visible;   /* Let content expand vertically */
      max-width: 100%;
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    /* Horizontal scrollbar for comparison */
    .comparison-container::-webkit-scrollbar {
      height: 8px;
    }

    .comparison-container::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
    }

    .comparison-container::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
    }

    .comparison-container::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.3);
    }

    /* Base table */
    .comparison-table {
      width: max-content;    /* Allow table to exceed container */
      min-width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    /* Sticky header row - z-index: 100 */
    .comparison-table thead th {
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 100;
      border-bottom: 2px solid var(--accent);
      padding: 0.75rem 1rem;
      text-align: right;
      font-weight: 600;
      white-space: nowrap;
    }

    /* Sticky first column (metric names) - z-index: 99 */
    .comparison-table tbody td:first-child,
    .comparison-table thead th:first-child {
      position: sticky;
      left: 0;
      z-index: 99;
      background: var(--bg);
      min-width: 180px;
      text-align: left;
    }

    /* Corner cell (sticky both directions) - z-index: 101 */
    .comparison-table thead th:first-child {
      z-index: 101;
    }

    /* Regular cells */
    .comparison-table tbody td {
      padding: 0.5rem 1rem;
      text-align: right;
      font-family: var(--font-mono);
      border-bottom: 1px solid rgba(255,255,255,0.05);
      white-space: nowrap;
    }

    .comparison-table tbody td:first-child {
      font-family: var(--font-ui);
      color: var(--text-muted);
    }

    /* Divider row */
    .comparison-table tr.divider td {
      padding: 0.25rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.15);
    }

    /* Highlight row (leefgeld) */
    .comparison-table tr.highlight-row td {
      padding: 0.75rem 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
      font-weight: 600;
    }

    /* Optimal value cell */
    .comparison-table td.optimal {
      color: var(--accent);
      font-weight: 700;
    }

    /* Color-coded values in comparison table (UI-07) */
    .comparison-table .value-positive { color: var(--positive); }
    .comparison-table .value-negative { color: var(--negative); }
    .comparison-table .value-warning { color: var(--warning); }

    /* Table row hover state (Phase 7.2) */
    .comparison-table tbody tr:hover {
      background: rgba(255,255,255,0.05);
    }

    /* Empty state */
    .comparison-empty {
      text-align: center;
      padding: 2rem;
      opacity: 0.6;
    }

    .comparison-empty p {
      margin: 0;
    }

    /* New Scenario Button */
    .new-scenario-btn {
      background: transparent;
      border: 2px dashed rgba(255,255,255,0.2);
      color: var(--text);
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      margin-left: 1rem;
      flex-shrink: 0;
      transition: border-color 0.2s, color 0.2s;
    }

    .new-scenario-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Template Selection Dialog */
    #templateSelectDialog {
      max-width: 400px;
    }

    .template-options {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin: 1rem 0;
    }

    .template-option {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .template-option:hover {
      border-color: var(--accent);
    }

    .template-option input[type="radio"] {
      accent-color: var(--accent);
    }

    .template-option .template-info {
      flex: 1;
    }

    .template-option .template-name {
      font-weight: 600;
    }

    .template-option .template-desc {
      font-size: 0.85rem;
      opacity: 0.7;
    }

    /* Calendar Section */
    .calendar-section {
      margin-top: 2rem;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding: 0 0.5rem;
    }

    .calendar-header h3 {
      margin: 0;
      flex: 1;
      text-align: center;
      font-size: 1.2rem;
    }

    .nav-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text);
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      transition: border-color 0.2s, color 0.2s;
    }

    .nav-btn:hover:not(:disabled) {
      border-color: var(--accent);
      color: var(--accent);
    }

    .nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 0.5rem;
    }

    .day-header {
      text-align: center;
      padding: 0.5rem;
      font-size: 0.85rem;
      font-weight: 600;
      opacity: 0.6;
    }

    /* Calendar Toolbar */
    .calendar-toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      background: var(--bg-surface);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-md);
    }

    .toolbar-selection {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .toolbar-label {
      font-size: var(--size-small);
      color: var(--text-muted);
    }

    .toolbar-btn {
      padding: 4px 10px;
      font-size: var(--size-small);
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      cursor: pointer;
    }

    .toolbar-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .toolbar-actions {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
    }

    .toolbar-status-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      font-size: var(--size-small);
      font-weight: 500;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: var(--radius-sm);
      color: var(--text);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .toolbar-status-btn:hover {
      background: rgba(255,255,255,0.1);
    }

    .toolbar-status-btn.belgium:hover {
      border-color: var(--belgium);
      background: rgba(59, 130, 246, 0.15);
    }

    .toolbar-status-btn.spain:hover {
      border-color: var(--positive);
      background: rgba(74, 222, 128, 0.15);
    }

    .toolbar-status-btn.travel:hover {
      border-color: var(--warning);
      background: rgba(251, 146, 60, 0.15);
    }

    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 2px;
    }

    .status-indicator.belgium { background: var(--belgium); }
    .status-indicator.spain { background: var(--positive); }
    .status-indicator.travel { background: var(--warning); }

    /* Day Cell - Checkbox-based selection */
    .day-cell {
      min-height: 60px;
      background: rgba(255,255,255,0.03);
      border: 1px solid transparent;
      border-radius: 4px;
      padding: 6px;
      display: flex;
      flex-direction: column;
      transition: all 0.15s ease;
    }

    .day-cell:hover:not(.empty) {
      background: rgba(255,255,255,0.06);
    }

    .day-cell.empty {
      background: transparent;
    }

    .day-cell.selected {
      border-color: var(--accent);
      background: rgba(74, 222, 128, 0.2) !important;
      border: 2px solid var(--accent) !important;
      box-shadow: 0 0 8px rgba(74, 222, 128, 0.3);
    }

    /* Checkbox checked state enhancement */
    .day-cell.selected .day-checkbox {
      accent-color: var(--accent);
    }

    .day-cell.belgium {
      background: rgba(59, 130, 246, 0.15);
      border-color: rgba(59, 130, 246, 0.3);
    }

    .day-cell.spain {
      background: rgba(74, 222, 128, 0.15);
      border-color: rgba(74, 222, 128, 0.3);
    }

    .day-cell.travel {
      background: rgba(251, 146, 60, 0.15);
      border-color: rgba(251, 146, 60, 0.3);
    }

    .day-cell.selected.belgium,
    .day-cell.selected.spain,
    .day-cell.selected.travel {
      box-shadow: 0 0 0 2px var(--accent);
    }

    .day-cell-header {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .day-checkbox {
      width: 14px;
      height: 14px;
      margin: 0;
      cursor: pointer;
      accent-color: var(--accent);
    }

    .day-number {
      font-size: 0.8rem;
      font-weight: 600;
      flex: 1;
    }

    .contracted-badge {
      font-size: 9px;
      font-weight: 600;
      color: var(--accent);
      opacity: 0.8;
    }

    .day-status-display {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 4px;
      margin-top: 4px;
    }

    .day-status-display:hover {
      background: rgba(255,255,255,0.05);
    }

    .status-emoji {
      font-size: 1.4rem;
    }

    .status-empty {
      font-size: 1rem;
      color: var(--text-muted);
      opacity: 0.3;
    }

    /* Day Picker Dialog Status Options */
    .status-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }

    .status-option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .status-option:hover {
      border-color: var(--accent);
    }

    .status-option input[type="radio"] {
      accent-color: var(--accent);
    }

    /* Visual feedback when option is selected */
    .status-option:has(input:checked) {
      border-color: var(--accent);
      background: rgba(74, 222, 128, 0.15);
      box-shadow: 0 0 0 2px rgba(74, 222, 128, 0.2);
    }

    /* Fallback for browsers without :has() support */
    .status-option input[type="radio"]:checked + .status-emoji-large {
      transform: scale(1.1);
      transition: transform 0.15s ease;
    }

    .status-emoji-large {
      font-size: 1.5rem;
    }

    /* Day Picker Dialog - narrower width */
    #dayPickerDialog {
      max-width: 400px;
    }

    #bulkPickerDialog {
      max-width: 400px;
    }

    /* Selected day cells (for bulk selection) - Enhanced visuals (ENH-06) */
    .day-cell.selected {
      background: rgba(74, 222, 128, 0.2) !important;
      border: 2px solid var(--accent) !important;
      box-shadow: 0 0 8px rgba(74, 222, 128, 0.3);
    }

    /* Selection count badge styling (ENH-06) */
    .selection-count-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--accent);
      color: var(--bg);
      padding: 2px 10px;
      border-radius: 999px;
      font-weight: 700;
      font-size: var(--size-small);
      min-width: 24px;
    }

    /* ===========================================
       CALENDAR MULTI-SELECT ENHANCEMENTS (BUG-05)
       =========================================== */

    /* Selection Indicator Bar */
    /* Calendar Help Tip */
    .calendar-help-tip {
      padding: 10px 14px;
      margin-bottom: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      font-size: var(--size-small);
      color: var(--text-muted);
      line-height: 1.5;
    }

    .calendar-help-tip strong {
      color: var(--accent);
    }

    .calendar-help-tip kbd {
      display: inline-block;
      padding: 2px 6px;
      margin: 0 2px;
      background: var(--bg-surface);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 3px;
      font-family: var(--font-mono);
      font-size: 0.85em;
    }

    .selection-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--accent);
      color: var(--bg);
      font-weight: 600;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .selection-indicator.hidden {
      display: none;
    }

    .selection-indicator .clear-btn {
      padding: 6px 12px;
      background: rgba(0, 0, 0, 0.2);
      border: none;
      border-radius: 4px;
      color: var(--bg);
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .selection-indicator .clear-btn:hover {
      background: rgba(0, 0, 0, 0.3);
    }

    /* Week Selector Button */
    .week-selector {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      padding: 0;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--bg-surface);
      color: var(--text-muted);
      font-size: 0.7rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .week-selector:hover {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }

    /* Month Select All Button */
    .month-select-all {
      padding: 4px 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: transparent;
      color: var(--text-muted);
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      margin-left: 12px;
    }

    .month-select-all:hover {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }

    /* Calendar grid with week selectors - 8 columns */
    .calendar-grid-with-weeks {
      display: grid;
      grid-template-columns: 32px repeat(7, 1fr);
      gap: 2px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 0.5rem;
    }

    .calendar-grid-with-weeks .day-header {
      text-align: center;
      padding: 0.5rem;
      font-size: 0.85rem;
      font-weight: 600;
      opacity: 0.6;
    }

    .calendar-grid-with-weeks .week-selector-cell {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Unsaved changes indicator */
    .unsaved-indicator {
      color: #facc15;
      font-size: 0.9rem;
      align-self: center;
    }
    .unsaved-indicator.hidden { display: none; }

    /* Calendar Stats Display */
    .calendar-stats {
      display: flex;
      gap: 2rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .count-display {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .count-label {
      opacity: 0.7;
    }

    .count-value {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      font-size: 1.1rem;
    }

    /* Warning Badge */
    .warning-badge {
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .warning-badge.yellow { background: #facc15; color: #1a1a2e; }
    .warning-badge.orange { background: #fb923c; color: #1a1a2e; }
    .warning-badge.red { background: #f87171; color: #1a1a2e; }

    /* Warning Banner */
    .warning-banner {
      padding: 0.75rem 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      font-weight: 500;
    }

    .warning-banner.yellow { background: rgba(250, 204, 21, 0.15); border: 1px solid #facc15; color: #facc15; }
    .warning-banner.orange { background: rgba(251, 146, 60, 0.15); border: 1px solid #fb923c; color: #fb923c; }
    .warning-banner.red { background: rgba(248, 113, 113, 0.15); border: 1px solid #f87171; color: #f87171; }

    .warning-banner.hidden, .warning-badge.hidden { display: none; }

    /* Export Section */
    .export-section {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .export-buttons {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .export-buttons button {
      display: flex;
      align-items: center;
    }

    /* Notification Toast */
    .notification {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateY(1rem);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .notification.success {
      background: rgba(74, 222, 128, 0.2);
      border: 1px solid var(--accent);
      color: var(--accent);
    }

    .notification.error {
      background: rgba(248, 113, 113, 0.2);
      border: 1px solid #f87171;
      color: #f87171;
    }

    .notification.hidden {
      display: none;
    }

    /* ===========================================
       PHASE 5/7.1: TOOLTIP MODALS (UI-09, BUG-02)
       =========================================== */

    /* Tooltip trigger - clickable info icon */
    .term-tooltip-trigger {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: inherit;
      text-decoration: none;
      border-bottom: 1px dotted var(--text-muted);
    }

    .term-tooltip-trigger:hover,
    .term-tooltip-trigger:focus {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .term-tooltip-trigger:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      font-size: 10px;
      font-weight: 700;
      color: var(--bg);
      background: var(--accent);
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* Tooltip Modal Dialog - use margin:auto for reliable centering */
    .tooltip-modal {
      max-width: 400px;
      width: 90%;
      padding: 0;
      border: none;
      border-radius: 12px;
      background: var(--bg-surface);
      color: var(--text);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      /* Dialog centering using margin:auto (works with showModal) */
      margin: auto;
      position: fixed;
      inset: 0;
      height: fit-content;
    }

    .tooltip-modal::backdrop {
      background: rgba(0, 0, 0, 0.6);
      -webkit-backdrop-filter: blur(4px);
      backdrop-filter: blur(4px);
    }

    .tooltip-modal-content {
      padding: 24px;
    }

    .tooltip-modal-title {
      margin: 0 0 12px 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--accent);
    }

    .tooltip-modal-text {
      margin: 0 0 20px 0;
      font-size: 0.95rem;
      line-height: 1.6;
      color: var(--text);
    }

    .tooltip-modal-close {
      display: block;
      width: 100%;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      background: var(--accent);
      color: var(--bg);
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .tooltip-modal-close:hover {
      opacity: 0.9;
    }

    .tooltip-modal-close:focus-visible {
      outline: 2px solid var(--text);
      outline-offset: 2px;
    }

    /* Ensure tooltips in cards don't get clipped */
    .scenario-card {
      overflow: visible;
    }

    /* ===========================================
       PHASE 5: PRINT STYLES (UI-10)
       =========================================== */

    /* Export actions bar */
    .export-actions {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      justify-content: flex-end;
    }

    .export-actions button {
      font-size: var(--size-small);
      padding: 0.4rem 0.75rem;
    }

    @media print {
      /* Light theme for printing */
      body {
        background: white !important;
        color: black !important;
        font-size: 11pt;
        padding: 0;
      }

      .container {
        max-width: 100%;
      }

      /* Hide interactive elements */
      .tab-nav,
      .tab-input,
      .edit-btn,
      .delete-btn,
      .add-expense-btn,
      .new-scenario-btn,
      .export-actions,
      .nav-btn,
      .reset-btn,
      button:not(.print-include),
      dialog,
      .calendar-section,
      .panel-calendar,
      .panel-expenses,
      .panel-details,
      [role="tooltip"] {
        display: none !important;
      }

      /* Show only scenarios panel */
      .tab-panel {
        display: block !important;
      }

      .panel-scenarios {
        display: block !important;
      }

      /* Dashboard header adjustments */
      .dashboard-header {
        border-bottom: 2px solid #333;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
      }

      .dashboard-title {
        color: black;
        font-size: 16pt;
      }

      .dashboard-subtitle {
        color: #666;
      }

      /* Scenario cards in print grid */
      .scenario-cards {
        display: grid !important;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
        overflow: visible !important;
      }

      .scenario-card {
        background: white !important;
        border: 1px solid #ccc !important;
        color: black !important;
        page-break-inside: avoid;
        padding: 0.75rem;
        flex: none !important;
      }

      .scenario-card.optimal {
        border: 2px solid #333 !important;
        background: #f5f5f5 !important;
      }

      .optimal-badge {
        background: #333 !important;
        color: white !important;
      }

      /* Metrics in print */
      .metric .label,
      .metric .value {
        color: black !important;
      }

      .metric.highlight .value {
        color: black !important;
        font-weight: 700;
      }

      /* Comparison table for print */
      .comparison-container {
        overflow: visible !important;
        border: 1px solid #ccc !important;
      }

      .comparison-table {
        width: 100% !important;
      }

      .comparison-table th,
      .comparison-table td {
        position: static !important;
        background: white !important;
        color: black !important;
        border: 1px solid #ddd !important;
        padding: 0.4rem !important;
        font-size: 9pt;
      }

      .comparison-table thead th {
        background: #f0f0f0 !important;
        font-weight: 700;
      }

      .comparison-table td.optimal {
        background: #e8f5e9 !important;
        font-weight: 700;
      }

      /* Color classes in print */
      .value-positive,
      .value-negative,
      .value-warning {
        color: black !important;
      }

      /* Hide mobile comparison on print */
      .comparison-mobile {
        display: none !important;
      }

      /* Page settings */
      @page {
        margin: 1cm;
        size: landscape;
      }
    }

    /* ===========================================
       PHASE 7.2: DESKTOP LAYOUT POLISH
       =========================================== */

    /* Large desktop (1440px+) */
    @media (min-width: 1440px) {
      .container {
        max-width: 1400px;
      }

      /* More comfortable padding on large screens */
      body {
        padding: 2.5rem;
      }

      /* Scenario cards can be wider */
      .scenario-card {
        flex: 0 0 340px;
      }

      /* Comparison table with more padding */
      .comparison-table tbody td,
      .comparison-table thead th {
        padding: 0.75rem 1.25rem;
      }
    }

    /* Extra large desktop (1920px+) */
    @media (min-width: 1920px) {
      .container {
        max-width: 1600px;
      }

      body {
        padding: 3rem;
      }

      /* Dashboard header enhanced */
      .dashboard-title {
        font-size: 1.75rem;
      }

      /* Wider scenario cards on large displays */
      .scenario-card {
        flex: 0 0 360px;
      }

      /* More spacious metrics */
      .metric {
        padding: 0.3rem 0;
        font-size: 0.9rem;
      }

      /* Calendar day cells larger */
      .day-cell {
        min-height: 70px;
      }
    }

    /* Smooth scrolling for horizontal containers */
    .scenario-cards,
    .comparison-container {
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }

    /* Ensure scrollbar is always visible on desktop for horizontal scroll containers */
    @media (min-width: 769px) {
      .scenario-cards::-webkit-scrollbar,
      .comparison-container::-webkit-scrollbar {
        height: 10px;
      }
    }

    /* ===========================================
       PHASE 5: RESPONSIVE DESIGN (UI-08)
       =========================================== */

    /* Mobile comparison blocks (hidden on desktop) */
    .comparison-mobile {
      display: none;
    }

    .comparison-block {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .comparison-block.optimal {
      border-color: var(--accent);
      background: rgba(74, 222, 128, 0.05);
    }

    .block-title {
      margin: 0 0 1rem 0;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .block-metrics {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .block-row {
      display: flex;
      justify-content: space-between;
      padding: 0.4rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .block-row:last-child {
      border-bottom: none;
    }

    .block-row .label {
      color: var(--text-muted);
    }

    .block-row .value {
      font-family: var(--font-mono);
    }

    .block-row.highlight {
      padding-top: 0.6rem;
      margin-top: 0.4rem;
      border-top: 1px solid rgba(255,255,255,0.1);
      border-bottom: none;
    }

    .block-row.highlight .value {
      color: var(--accent);
      font-weight: 600;
    }

    /* Tablet breakpoint */
    @media (max-width: 900px) {
      .container {
        padding: 1rem;
      }

      .scenario-cards {
        gap: 0.75rem;
      }

      .scenario-card {
        flex: 0 0 280px;
      }

      .dialog-body {
        grid-template-columns: 1fr;
      }
    }

    /* Medium tablet breakpoint */
    @media (max-width: 768px) {
      /* Reduce container padding */
      body {
        padding: 1rem;
      }

      /* Tab nav adjustments */
      .tab-label {
        padding: 0.6rem 1rem;
        font-size: 0.8rem;
      }

      /* Calendar adjustments for tablet */
      .calendar-stats {
        flex-direction: column;
        gap: 0.75rem;
      }

      /* Expense form full width */
      .add-form {
        padding: 1rem;
      }

      .form-row input,
      .form-row select {
        width: 100%;
        min-height: 44px; /* Touch-friendly size */
      }

      /* Dialog adjustments */
      dialog {
        max-width: 95vw;
        width: 95vw;
      }

      /* Compliance sections */
      .requirements-list li {
        flex-direction: column;
        gap: 0.25rem;
      }

      .requirements-list .field-name {
        min-width: unset;
      }
    }

    /* Mobile breakpoint */
    @media (max-width: 600px) {
      body {
        padding: 0.5rem;
      }

      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .dashboard-title {
        font-size: 1.25rem;
      }

      /* Stack tabs in 2x3 grid on mobile */
      .tab-nav {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0;
        border-bottom: none;
      }

      .tab-label {
        padding: 0.75rem 0.5rem;
        font-size: 0.7rem;
        text-align: center;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        border-right: 1px solid rgba(255,255,255,0.1);
        min-height: 44px; /* Touch-friendly size */
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .tab-label:nth-child(3n) {
        border-right: none;
      }

      .tab-label:nth-child(4),
      .tab-label:nth-child(5) {
        border-bottom: none;
      }

      /* Scenario cards full width */
      .scenario-cards {
        flex-direction: column;
        overflow-x: visible;
        gap: 0.75rem;
      }

      .scenario-card {
        flex: none;
        width: 100%;
        padding: var(--spacing-md);
      }

      .card-header {
        flex-wrap: wrap;
      }

      /* Edit button full width */
      .edit-btn {
        min-height: 44px;
      }

      /* Hide horizontal comparison table on mobile */
      .comparison-container {
        display: none;
      }

      /* Show vertical comparison blocks on mobile */
      .comparison-mobile {
        display: block;
      }

      /* Mobile comparison blocks styling */
      .comparison-block {
        padding: var(--spacing-md);
      }

      .block-row {
        padding: 0.5rem 0;
      }

      .block-row .value {
        font-size: 0.9rem;
      }

      /* Export actions stack */
      .export-actions {
        flex-direction: column;
      }

      .export-actions button {
        width: 100%;
        min-height: 44px;
      }

      /* Calendar adjustments */
      .calendar-header {
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0;
      }

      .calendar-header h3 {
        order: 1;
        width: 100%;
        text-align: center;
        font-size: 1rem;
        margin-bottom: 0.5rem;
      }

      .nav-btn {
        order: 2;
        min-height: 44px;
        min-width: 44px;
        flex: 1;
      }

      .calendar-grid {
        gap: 1px;
        padding: 0.25rem;
      }

      .day-header {
        padding: 0.25rem;
        font-size: 0.7rem;
      }

      .day-cell {
        min-height: 48px; /* Touch-friendly minimum */
        padding: 0.2rem;
        font-size: 0.75rem;
      }

      .day-number {
        font-size: 0.75rem;
      }

      .status-emoji {
        font-size: 1.1rem;
      }

      .contracted-badge {
        font-size: 8px;
        top: 1px;
        right: 2px;
      }

      /* Week selector buttons */
      .week-selector {
        min-width: 24px;
        min-height: 24px;
      }

      /* Selection indicator mobile */
      .selection-indicator {
        flex-wrap: wrap;
        padding: 10px 12px;
        font-size: 0.85rem;
      }

      .selection-indicator .clear-btn {
        min-height: 36px;
        padding: 8px 12px;
      }

      /* Calendar stats mobile */
      .calendar-stats {
        flex-direction: column;
        gap: 0.5rem;
      }

      .count-display {
        flex-wrap: wrap;
        font-size: 0.9rem;
      }

      /* Calendar actions */
      .calendar-actions {
        flex-direction: column-reverse !important;
        align-items: stretch !important;
      }

      .calendar-actions .primary-btn {
        width: 100%;
        min-height: 44px;
      }

      /* Export section mobile */
      .export-section {
        margin-top: 1rem;
      }

      .export-buttons {
        flex-direction: column;
      }

      .export-buttons button {
        width: 100%;
        min-height: 44px;
        justify-content: center;
      }

      /* Dialog full width on mobile */
      dialog {
        width: 100vw;
        max-width: 100vw;
        max-height: 100vh;
        margin: 0;
        border-radius: 0;
      }

      .dialog-header {
        padding: 1rem;
      }

      .dialog-header h2 {
        font-size: 1.1rem;
      }

      .dialog-body {
        padding: 1rem;
        max-height: calc(100vh - 140px);
      }

      .dialog-footer {
        padding: 1rem;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .dialog-footer button {
        min-height: 44px;
        flex: 1 1 auto;
      }

      .dialog-footer .spacer {
        display: none;
      }

      /* Form groups on mobile */
      .form-group input,
      .form-group select {
        width: 100%;
        min-height: 44px;
        font-size: 16px; /* Prevents zoom on iOS */
      }

      /* Detail dialog mobile */
      .detail-dialog {
        max-width: 100vw;
        width: 100vw;
        max-height: 100vh;
        border-radius: 0;
      }

      .detail-content {
        padding: 1rem;
        max-height: calc(100vh - 60px);
        overflow-y: auto;
      }

      .detail-footer {
        flex-direction: column;
        gap: 0.5rem;
      }

      .detail-footer button {
        min-height: 44px;
      }

      /* Tooltip modal mobile */
      .tooltip-modal {
        max-width: 95vw;
        width: 95vw;
      }

      /* Status options in day picker */
      .status-options {
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
      }

      .status-option {
        padding: 0.6rem;
        min-height: 60px;
        flex-direction: column;
        justify-content: center;
        text-align: center;
      }

      .status-emoji-large {
        font-size: 1.25rem;
      }

      /* Expense sections mobile */
      .expense-section {
        padding: 0.75rem;
      }

      .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .expense-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
        padding: 0.75rem 0;
      }

      .expense-name {
        min-width: unset;
        width: 100%;
      }

      .expense-formula {
        text-align: left;
        font-size: 0.8rem;
      }

      .expense-value {
        min-width: unset;
        text-align: left;
        display: flex;
        justify-content: space-between;
        width: 100%;
        align-items: center;
      }

      .expense-actions {
        margin-left: auto;
      }

      .delete-btn {
        min-width: 36px;
        min-height: 36px;
      }

      /* Add expense button */
      .add-expense-btn {
        min-height: 44px;
      }

      /* Add form mobile */
      .add-form {
        padding: 0.75rem;
      }

      .form-row input,
      .form-row select {
        width: 100%;
        min-height: 44px;
        font-size: 16px; /* Prevents zoom on iOS */
      }

      .form-actions {
        flex-direction: column;
      }

      .form-actions button {
        min-height: 44px;
      }

      /* Reset button */
      .reset-btn {
        min-height: 44px;
        width: 100%;
      }

      /* Compliance tab mobile */
      .compliance-section .section-header {
        padding: 0.75rem;
      }

      .compliance-section .section-content {
        padding: 0 0.75rem 0.75rem;
      }

      .tie-breaker-steps li {
        padding-left: 2.5rem;
        padding: 0.75rem 0.75rem 0.75rem 2.5rem;
      }

      .tie-breaker-steps li::before {
        left: 0.5rem;
        width: 1.25rem;
        height: 1.25rem;
        font-size: 0.75rem;
      }

      /* Global disclaimer mobile */
      .global-disclaimer {
        padding: 0.75rem;
        margin-top: 2rem;
      }

      .global-disclaimer p {
        font-size: 0.75rem;
      }

      /* Template dialog mobile */
      #templateSelectDialog {
        max-width: 100vw;
        width: 100vw;
      }

      .template-option {
        padding: 0.75rem;
        min-height: 60px;
      }

      /* Warning banner mobile */
      .compliance-warning-banner {
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-start;
      }

      .compliance-warning-banner .dismiss-btn {
        align-self: flex-end;
        margin-left: 0;
      }
    }

    /* Extra small mobile (375px - iPhone SE) */
    @media (max-width: 400px) {
      body {
        padding: 0.25rem;
      }

      .dashboard-title {
        font-size: 1.1rem;
      }

      .tab-label {
        font-size: 0.65rem;
        padding: 0.5rem 0.25rem;
      }

      .day-cell {
        min-height: 44px;
      }

      .day-number {
        font-size: 0.7rem;
      }

      .status-emoji {
        font-size: 1rem;
        margin-top: 0.15rem;
      }

      .metric {
        font-size: 0.8rem;
      }

      .metric .value {
        font-size: 0.8rem;
      }
    }

    /* ===========================================
       PHASE 12: LOADING SCREEN
       =========================================== */

    /* Loading Screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .loading-screen.visible {
      opacity: 1;
      visibility: visible;
    }

    .loading-content {
      text-align: center;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--bg-surface);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto var(--spacing-md);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    #loading-status {
      color: var(--text-muted);
      font-size: var(--size-labels);
    }

    #loading-status.error {
      color: var(--negative);
    }

    /* Sync Indicator (Phase 12) */
    .sync-indicator {
      position: fixed;
      top: var(--spacing-md);
      right: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: var(--spacing-xs) var(--spacing-sm);
      background: var(--bg-surface);
      border-radius: var(--radius-md);
      font-size: var(--size-small);
      cursor: pointer;
      z-index: 1000;
      transition: background 0.2s, box-shadow 0.2s;
    }

    .sync-indicator:hover {
      background: var(--bg-elevated);
    }

    .sync-indicator.synced {
      color: var(--positive);
    }

    .sync-indicator.pending {
      color: var(--warning);
    }

    .sync-indicator.alert {
      color: var(--negative);
      box-shadow: 0 0 0 2px var(--negative);
    }

    .sync-indicator.critical {
      color: var(--negative);
      animation: pulse 1s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 2px var(--negative); }
      50% { box-shadow: 0 0 0 4px var(--negative); }
    }

    .sync-icon {
      flex-shrink: 0;
    }

    .sync-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      background: var(--warning);
      color: var(--bg);
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }

    .sync-indicator.alert .sync-badge,
    .sync-indicator.critical .sync-badge {
      background: var(--negative);
    }

    /* ===========================================
       PHASE 13: ENTITY CREATION MODAL
       =========================================== */

    .entity-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
    }

    .entity-modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .entity-modal {
      background: var(--bg-surface, #242424);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-lg, 12px);
      width: 90%;
      max-width: 560px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(-20px);
      transition: transform 0.2s;
    }

    .entity-modal-overlay.active .entity-modal {
      transform: translateY(0);
    }

    .entity-modal__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-lg, 24px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .entity-modal__title {
      font-size: var(--size-header, 20px);
      font-weight: 600;
      color: var(--text, #eaeaea);
      margin: 0;
    }

    .entity-modal__close {
      background: transparent;
      border: none;
      color: var(--text-muted, #a0a0a0);
      font-size: 24px;
      cursor: pointer;
      padding: var(--spacing-xs, 4px);
      line-height: 1;
    }

    .entity-modal__close:hover {
      color: var(--text, #eaeaea);
    }

    .entity-modal__body {
      padding: var(--spacing-lg, 24px);
    }

    .entity-modal__section {
      margin-bottom: var(--spacing-lg, 24px);
    }

    .entity-modal__section-title {
      font-size: var(--size-small, 12px);
      font-weight: 600;
      color: var(--text-muted, #a0a0a0);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--spacing-md, 16px);
    }

    .entity-type-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-md, 16px);
    }

    .entity-type-option {
      padding: var(--spacing-md, 16px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-md, 8px);
      cursor: pointer;
      transition: border-color 0.15s, background-color 0.15s;
      text-align: center;
    }

    .entity-type-option:hover {
      border-color: var(--accent, #4ade80);
      background: rgba(74, 222, 128, 0.1);
    }

    .entity-type-option.selected {
      border-color: var(--accent, #4ade80);
      background: rgba(74, 222, 128, 0.15);
    }

    .entity-type-option__icon {
      font-size: 32px;
      margin-bottom: var(--spacing-sm, 8px);
    }

    .entity-type-option__name {
      font-weight: 600;
      color: var(--text, #eaeaea);
      margin-bottom: var(--spacing-xs, 4px);
    }

    .entity-type-option__desc {
      font-size: var(--size-small, 12px);
      color: var(--text-muted, #a0a0a0);
    }

    .entity-form__group {
      margin-bottom: var(--spacing-md, 16px);
    }

    .entity-form__label {
      display: block;
      font-size: var(--size-small, 12px);
      font-weight: 500;
      color: var(--text-muted, #a0a0a0);
      margin-bottom: 6px;
    }

    .entity-form__label--required::after {
      content: ' *';
      color: var(--negative, #f87171);
    }

    .entity-form__input,
    .entity-form__select {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg, #1a1a1a);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-sm, 4px);
      color: var(--text, #eaeaea);
      font-size: var(--size-labels, 14px);
      font-family: inherit;
      box-sizing: border-box;
    }

    .entity-form__input:focus,
    .entity-form__select:focus {
      outline: none;
      border-color: var(--accent, #4ade80);
    }

    .entity-form__input.invalid {
      border-color: var(--negative, #f87171);
    }

    .entity-form__input.valid {
      border-color: var(--positive, #4ade80);
    }

    .entity-form__error {
      font-size: var(--size-small, 12px);
      color: var(--negative, #f87171);
      margin-top: var(--spacing-xs, 4px);
    }

    .entity-form__hint {
      font-size: var(--size-small, 12px);
      color: var(--text-muted, #a0a0a0);
      margin-top: var(--spacing-xs, 4px);
      opacity: 0.8;
    }

    .entity-form__row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-md, 16px);
    }

    .entity-form__row--3 {
      grid-template-columns: 1fr 1fr 1fr;
    }

    .entity-modal__footer {
      display: flex;
      justify-content: flex-end;
      gap: var(--spacing-md, 16px);
      padding: var(--spacing-md, 16px) var(--spacing-lg, 24px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .entity-modal__btn {
      padding: 10px 20px;
      border-radius: var(--radius-sm, 4px);
      font-size: var(--size-labels, 14px);
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.15s;
    }

    .entity-modal__btn--secondary {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-muted, #a0a0a0);
    }

    .entity-modal__btn--secondary:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text, #eaeaea);
    }

    .entity-modal__btn--primary {
      background: var(--accent, #4ade80);
      border: none;
      color: var(--bg, #1a1a1a);
    }

    .entity-modal__btn--primary:hover {
      background: #3bc972;
    }

    .entity-modal__btn--primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Registro Mercantil fieldset */
    .registro-mercantil-fields {
      background: var(--bg, #1a1a1a);
      border-radius: var(--radius-md, 8px);
      padding: var(--spacing-md, 16px);
      margin-top: var(--spacing-sm, 8px);
    }

    /* Responsive adjustments for entity modal */
    @media (max-width: 600px) {
      .entity-type-selector {
        grid-template-columns: 1fr;
      }

      .entity-form__row,
      .entity-form__row--3 {
        grid-template-columns: 1fr;
      }

      .entity-modal__footer {
        flex-direction: column-reverse;
      }

      .entity-modal__btn {
        width: 100%;
      }
    }

    /* ===========================================
       Entity Switcher (Phase 13-04)
       =========================================== */
    .entity-switcher-container {
      position: relative;
      margin-right: 16px;
    }

    .entity-switcher {
      position: relative;
      font-family: 'DM Sans', sans-serif;
    }

    .entity-switcher__trigger {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg, #1a1a1a);
      border: 1px solid var(--border-color, #3a3a3a);
      border-radius: 6px;
      color: var(--text-primary, #fff);
      cursor: pointer;
      min-width: 200px;
      transition: border-color 0.15s, background-color 0.15s;
      font-family: inherit;
      font-size: 14px;
    }

    .entity-switcher__trigger:hover {
      background: var(--card-bg, #252525);
      border-color: var(--accent, #3b82f6);
    }

    .entity-switcher__trigger:focus {
      outline: 2px solid var(--accent, #3b82f6);
      outline-offset: 2px;
    }

    .entity-switcher__icon {
      font-size: 18px;
      flex-shrink: 0;
    }

    .entity-switcher__name {
      flex: 1;
      text-align: left;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .entity-switcher__type {
      font-size: 11px;
      color: var(--text-secondary, #888);
      background: var(--card-bg, #333);
      padding: 2px 6px;
      border-radius: 4px;
      flex-shrink: 0;
    }

    .entity-switcher__chevron {
      width: 16px;
      height: 16px;
      transition: transform 0.15s;
      flex-shrink: 0;
    }

    .entity-switcher[aria-expanded="true"] .entity-switcher__chevron {
      transform: rotate(180deg);
    }

    .entity-switcher__menu {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 4px;
      padding: 4px 0;
      background: var(--card-bg, #252525);
      border: 1px solid var(--border-color, #3a3a3a);
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      list-style: none;
      max-height: 300px;
      overflow-y: auto;
    }

    .entity-switcher__option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      cursor: pointer;
      transition: background-color 0.1s;
    }

    .entity-switcher__option:hover,
    .entity-switcher__option:focus {
      background: var(--bg, #1a1a1a);
      outline: none;
    }

    .entity-switcher__option--active {
      background: rgba(59, 130, 246, 0.15);
    }

    .entity-switcher__option--action {
      color: var(--accent, #3b82f6);
    }

    .entity-switcher__option-icon {
      font-size: 16px;
      flex-shrink: 0;
    }

    .entity-switcher__option-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .entity-switcher__option-type {
      font-size: 11px;
      color: var(--text-secondary, #888);
      flex-shrink: 0;
    }

    .entity-switcher__check {
      color: var(--positive, #22c55e);
      flex-shrink: 0;
    }

    .entity-switcher__divider {
      height: 1px;
      margin: 4px 0;
      background: var(--border-color, #3a3a3a);
    }

    .entity-switcher__empty {
      padding: 16px;
      text-align: center;
      color: var(--text-secondary, #888);
      font-size: 13px;
    }

    /* Visually hidden for screen readers */
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* ===========================================
       PHASE 13-05: Dual Activity Warning Banner
       =========================================== */

    .dual-activity-warning {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 16px 20px;
      background: linear-gradient(135deg, rgba(234, 179, 8, 0.15), rgba(234, 179, 8, 0.05));
      border: 1px solid rgba(234, 179, 8, 0.3);
      border-radius: 8px;
      margin: 16px 24px;
    }

    .dual-activity-warning__icon {
      font-size: 24px;
      flex-shrink: 0;
    }

    .dual-activity-warning__content {
      flex: 1;
    }

    .dual-activity-warning__title {
      font-weight: 600;
      color: #eab308;
      margin-bottom: 4px;
    }

    .dual-activity-warning__text {
      font-size: 13px;
      color: var(--text-secondary, #888);
      line-height: 1.5;
      margin-bottom: 8px;
    }

    .dual-activity-warning__entities {
      font-size: 12px;
      color: var(--text-tertiary, #666);
    }

    .dual-activity-warning__entity-count {
      background: rgba(255, 255, 255, 0.05);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .dual-activity-warning__dismiss {
      background: transparent;
      border: none;
      color: var(--text-tertiary, #666);
      font-size: 16px;
      cursor: pointer;
      padding: 4px;
      flex-shrink: 0;
    }

    .dual-activity-warning__dismiss:hover {
      color: var(--text-primary, #fff);
    }
  </style>

  <!-- Phase 12: Dexie.js v4.x for IndexedDB -->
  <script src="https://unpkg.com/dexie@4/dist/dexie.min.js"></script>

  <!-- Phase 12: currency.js for money handling -->
  <script src="https://unpkg.com/currency.js@2.0.4/dist/currency.min.js"></script>
</head>
<body>
  <!-- Phase 12: Loading Screen for Database Initialization -->
  <div id="loading-screen" class="loading-screen">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p id="loading-status">Initializing database...</p>
    </div>
  </div>

  <!-- Notification Toast (used by clipboard copy) -->
  <div id="notification" class="notification hidden"></div>

  <div class="container">
    <div class="dashboard">
      <!-- Dashboard Header -->
      <header class="dashboard-header">
        <div>
          <h1 class="dashboard-title">Autonomo Tax Calculator</h1>
          <p class="dashboard-subtitle">Self-Employed Tax Calculator 2025/2026</p>
        </div>
        <!-- Phase 13-04: Entity Switcher -->
        <div id="entity-switcher-container" class="entity-switcher-container"></div>
      </header>

      <!-- Compliance Warning Banner (COMP-01) -->
      <div id="complianceWarningBanner" class="compliance-warning-banner" role="alert" aria-live="polite">
        <span class="warning-text" id="warningText"></span>
        <button class="dismiss-btn" aria-label="Dismiss warning" onclick="dismissComplianceWarning()">&times;</button>
      </div>

      <!-- Tab radio inputs (hidden) -->
      <input type="radio" name="tabs" id="tab-scenarios" class="tab-input" checked>
      <input type="radio" name="tabs" id="tab-calendar" class="tab-input">
      <input type="radio" name="tabs" id="tab-expenses" class="tab-input">
      <input type="radio" name="tabs" id="tab-details" class="tab-input">
      <input type="radio" name="tabs" id="tab-income" class="tab-input">
      <input type="radio" name="tabs" id="tab-compliance" class="tab-input">

      <!-- Tab navigation -->
      <nav class="tab-nav">
        <label for="tab-scenarios" class="tab-label">Scenarios</label>
        <label for="tab-calendar" class="tab-label">Calendar</label>
        <label for="tab-expenses" class="tab-label">Expenses</label>
        <label for="tab-details" class="tab-label">Details</label>
        <label for="tab-income" class="tab-label">Income</label>
        <label for="tab-compliance" class="tab-label">Compliance</label>
      </nav>

      <!-- Tab panels container -->
      <div class="tab-panels">

        <!-- EXPENSES TAB -->
        <section class="tab-panel panel-expenses">
          <div class="expenses-container">
      <h2>Expense Tracking</h2>
      <div id="spainSection"></div>
      <div id="workTravelSection"></div>
      <div id="privateSection"></div>
      <div style="margin-top: 1rem; display: flex; justify-content: flex-end;">
        <button class="reset-btn" onclick="resetToDefaults()">Reset to Defaults</button>
      </div>

      <!-- Add Expense Dialog (modal for better UX) -->
      <dialog id="addExpenseDialog" class="expense-dialog">
        <div class="dialog-header">
          <h2>Add New Expense</h2>
          <button type="button" class="dialog-close" onclick="hideAddForm()">x</button>
        </div>
        <div style="padding: 1.5rem;">
          <div class="form-row">
            <label>Name:
              <input type="text" id="newExpName" placeholder="e.g., Software subscription" required oninput="handleExpenseNameInput(this.value)">
            </label>
            <span id="detectionBadge" class="detection-badge" style="display: none;"></span>
          </div>
          <div class="form-row">
            <label>Amount (EUR/month):
              <input type="number" id="newExpAmount" min="0" step="0.01" required>
            </label>
          </div>
          <div class="form-row">
            <label>Category:
              <select id="newExpCategory" onchange="toggleDeductionField()">
                <option value="spainDeductible">Spain Deductible</option>
                <option value="workTravel">Work Travel</option>
                <option value="private">Private</option>
              </select>
            </label>
          </div>
          <div class="form-row" id="deductionRow">
            <label>Deduction %:
              <div class="deduction-field-wrapper">
                <input type="number" id="newExpDeduction" min="0" max="100" value="100" onchange="handleDeductionChange(this.value)">
              </div>
            </label>
            <div id="deductionHint" class="detection-hint" style="display: none;"></div>
          </div>
        </div>
        <div class="dialog-footer">
          <div class="spacer"></div>
          <button class="secondary-btn" onclick="hideAddForm()">Cancel</button>
          <button class="primary-btn" onclick="submitNewExpense()">Add Expense</button>
        </div>
      </dialog>
          </div>
        </section>

        <!-- SCENARIOS TAB -->
        <section class="tab-panel panel-scenarios">
          <div class="scenario-section">
            <h2>Scenario Comparison</h2>
            <div id="scenarioCards" class="scenario-cards">
              <!-- Populated by renderScenarioCards() -->
            </div>
            <div class="export-actions">
              <button onclick="resetScenarios()" class="reset-btn">
                Reset to Defaults
              </button>
              <button onclick="copyTableToClipboard()" class="secondary-btn">
                Copy to Clipboard
              </button>
              <button onclick="window.print()" class="secondary-btn">
                Print / PDF
              </button>
            </div>
            <div id="comparisonTable">
              <!-- Populated by renderComparisonTable() -->
            </div>
            <div class="comparison-mobile">
              <!-- Populated by renderMobileComparison() -->
            </div>
          </div>
        </section>

        <!-- CALENDAR TAB -->
        <section class="tab-panel panel-calendar">
          <div class="calendar-section">
      <h2>Belgium Calendar 2026</h2>

      <div class="calendar-info" style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 4px; font-size: 0.9rem;">
        <strong style="color: var(--accent);">How days are counted:</strong>
        <ul style="margin: 0.5rem 0 0 1.5rem; opacity: 0.8; line-height: 1.6;">
          <li><strong>Belgium days</strong> + <strong>Travel days</strong> count toward 183-day threshold</li>
          <li><strong>Spain days</strong> do not count toward threshold</li>
          <li><strong>Travel days:</strong> Use for flight days between countries</li>
        </ul>
      </div>

      <div class="calendar-stats">
        <div class="count-display">
          <span class="count-label">This month:</span>
          <span id="monthBelgiumCount" class="count-value">0</span> Belgium
        </div>
        <div class="count-display">
          <span class="count-label">Annual total:</span>
          <span id="annualBelgiumCount" class="count-value">0</span> Belgium + Travel
          <span class="source-hint" data-tooltip="Entry and exit days (travel days between Belgium and Spain) may be counted by BOTH countries' tax authorities. This calculator counts Travel days toward the 183-day threshold as a conservative approach. Art. 4 Spain-Belgium tax treaty applies for tie-breaker.">?</span>
          <span id="warningBadge" class="warning-badge hidden"></span>
        </div>
      </div>
      <div id="warningBanner" class="warning-banner hidden"></div>

      <!-- Calendar Toolbar - Always visible for bulk operations -->
      <div class="calendar-toolbar">
        <div class="toolbar-selection">
          <span class="toolbar-label">Selected: <span id="selectionCount" class="selection-count-badge">0</span> days</span>
          <button type="button" class="toolbar-btn" onclick="clearSelection()" title="Clear selection">Clear</button>
        </div>
        <div class="toolbar-actions">
          <span class="toolbar-label">Set status:</span>
          <button type="button" class="toolbar-status-btn belgium" onclick="applyStatusToSelected('belgium')">
            <span class="status-indicator belgium"></span> Belgium
          </button>
          <button type="button" class="toolbar-status-btn spain" onclick="applyStatusToSelected('spain')">
            <span class="status-indicator spain"></span> Spain
          </button>
          <button type="button" class="toolbar-status-btn travel" onclick="applyStatusToSelected('travel')">
            <span class="status-indicator travel"></span> Travel
          </button>
          <button type="button" class="toolbar-status-btn clear" onclick="applyStatusToSelected('unset')">
            Clear Status
          </button>
        </div>
      </div>

      <div id="calendarContainer">
        <!-- Populated by renderCalendar() -->
      </div>
      <div class="calendar-actions" style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: flex-end; align-items: center;">
        <button class="reset-btn" onclick="resetCalendar()">Reset Calendar</button>
        <span id="unsavedIndicator" class="unsaved-indicator hidden">Unsaved changes</span>
        <button id="saveCalendarBtn" class="primary-btn" onclick="commitCalendarChanges()" disabled>Save Calendar</button>
      </div>

      <div class="export-section">
        <h4 style="margin: 0 0 0.75rem 0; opacity: 0.8;">Export Calendar</h4>
        <div class="export-buttons">
          <button class="secondary-btn" onclick="downloadICS()">
            <span style="margin-right: 0.5rem;">&#128197;</span>
            Export ICS
          </button>
          <button class="secondary-btn" onclick="downloadCSV()">
            <span style="margin-right: 0.5rem;">&#128196;</span>
            Export CSV
          </button>
          <button class="secondary-btn" onclick="copyToClipboard()">
            <span style="margin-right: 0.5rem;">&#128203;</span>
            Copy Summary
          </button>
        </div>
      </div>

      <details class="holidays-reference" style="margin-top: 1rem;">
        <summary style="cursor: pointer; opacity: 0.8;">Belgian Public Holidays 2026 (Reference)</summary>
        <div style="padding: 1rem 0; font-size: 0.9rem; opacity: 0.8;">
          <p style="margin-bottom: 0.5rem;">These are NOT auto-marked. Mark manually if you are in Belgium:</p>
          <ul style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">
            <li>Apr 6 - Easter Monday</li>
            <li>May 1 - Labour Day</li>
            <li>May 14 - Ascension Day</li>
            <li>May 25 - Whit Monday</li>
            <li>Jul 21 - Belgian National Holiday</li>
            <li>Aug 15 - Assumption Day (Saturday - substitute TBD)</li>
            <li>Nov 1 - All Saints' Day (Sunday - substitute TBD)</li>
            <li>Nov 11 - Armistice Day</li>
            <li>Dec 25 - Christmas Day</li>
          </ul>
          <p style="margin-top: 0.75rem; font-style: italic;">
            If a holiday falls the day before a contracted work day, you may need to be in Belgium.
            These still count toward the 183-day threshold.
          </p>
        </div>
      </details>
          </div>
        </section>

        <!-- DETAILS TAB - What-If Calculator -->
        <section class="tab-panel panel-details">
          <div class="calculator-header">
            <h2>What-If Calculator</h2>
            <p class="calculator-subtitle">Adjust any value to see how it affects your net income</p>
          </div>

          <div class="calculator-layout">
            <!-- Input Panel -->
            <div class="calculator-inputs">
              <!-- Income Section -->
              <div class="input-section">
                <h3 class="input-section-title">Income</h3>
                <div class="input-field">
                  <label for="monthlyRevenue">Monthly Revenue</label>
                  <div class="input-with-euro">
                    <input type="number" id="monthlyRevenue" value="6000" min="0" step="100" oninput="recalculateTotals()">
                    <span class="input-unit">EUR/mo</span>
                  </div>
                </div>
              </div>

              <!-- Expenses Section -->
              <div class="input-section">
                <h3 class="input-section-title">Monthly Expenses</h3>
                <div class="input-field">
                  <label for="calcSpainDeductible">Spain Deductible</label>
                  <div class="input-with-euro">
                    <input type="number" id="calcSpainDeductible" value="383" min="0" step="10" oninput="recalculateTotals()">
                    <span class="input-unit">EUR/mo</span>
                  </div>
                  <span class="input-hint">Home office, phone, utilities</span>
                </div>
                <div class="input-field">
                  <label for="calcWorkTravel">Work Travel (Belgium)</label>
                  <div class="input-with-euro">
                    <input type="number" id="calcWorkTravel" value="1000" min="0" step="100" oninput="recalculateTotals()">
                    <span class="input-unit">EUR/mo</span>
                  </div>
                  <span class="input-hint">Flights, hotels, transport</span>
                </div>
                <div class="input-field">
                  <label for="calcPrivateCosts">Private Costs</label>
                  <div class="input-with-euro">
                    <input type="number" id="calcPrivateCosts" value="1727" min="0" step="50" oninput="recalculateTotals()">
                    <span class="input-unit">EUR/mo</span>
                  </div>
                  <span class="input-hint">Rent, car, insurance (not deductible)</span>
                </div>
              </div>

              <!-- Tax Options Section -->
              <div class="input-section">
                <h3 class="input-section-title">Tax Options</h3>
                <div class="input-field checkbox-field">
                  <label class="checkbox-inline">
                    <input type="checkbox" id="hasDescendant" checked onchange="recalculateTotals()">
                    <span>1 Dependent Child</span>
                  </label>
                  <span class="input-hint">Adds 2,400 EUR minimo</span>
                </div>
              </div>

              <!-- Advanced Options (Collapsible) -->
              <details class="advanced-section">
                <summary class="advanced-toggle">Advanced Options</summary>
                <div class="advanced-content">
                  <div class="input-field">
                    <label for="calcRetaMonthly">RETA (Social Security)</label>
                    <div class="input-with-euro">
                      <input type="number" id="calcRetaMonthly" value="428.40" min="0" step="10" oninput="recalculateTotals()">
                      <span class="input-unit">EUR/mo</span>
                    </div>
                    <span class="input-hint" id="retaSourceHint">Fixed from registration</span>
                  </div>
                  <div class="input-field">
                    <label for="calcMinimoPersonal">Minimo Personal</label>
                    <div class="input-with-euro">
                      <input type="number" id="calcMinimoPersonal" value="5550" min="0" step="100" oninput="recalculateTotals()">
                      <span class="input-unit">EUR/yr</span>
                    </div>
                    <span class="input-hint" id="minimoSourceHint"></span>
                  </div>
                </div>
              </details>

              <!-- Action Buttons -->
              <div class="calculator-actions">
                <button class="secondary-btn" onclick="resetDetailsForm()">Reset to Defaults</button>
                <button class="primary-btn" onclick="saveAsScenario()">Save as Scenario</button>
              </div>
            </div>

            <!-- Results Panel -->
            <div class="calculator-results" id="results">
              <!-- Populated by recalculateTotals() -->
            </div>
          </div>
        </section>

        <!-- INCOME TAB (Phase 8 - ENH-02) -->
        <section class="tab-panel panel-income">
          <div class="income-header">
            <h2>Income Tracking</h2>
            <div class="income-summary">
              <span class="income-total">Total: <span id="incomeTotalDisplay" class="mono">0.00 EUR</span></span>
              <span class="income-count">(<span id="incomeCountDisplay">0</span> entries)</span>
            </div>
          </div>

          <div class="income-controls">
            <div class="income-filters">
              <select id="incomeSortBy" onchange="renderIncomeList()">
                <option value="date-desc">Newest First</option>
                <option value="date-asc">Oldest First</option>
                <option value="amount-desc">Highest Amount</option>
                <option value="amount-asc">Lowest Amount</option>
                <option value="client-asc">Client A-Z</option>
              </select>
              <input type="text" id="incomeFilterText" placeholder="Filter by client or invoice..." oninput="renderIncomeList()">
            </div>
            <button type="button" class="add-btn" onclick="openIncomeDialog()">+ Add Income</button>
          </div>

          <div id="incomeList" class="income-list">
            <!-- Income entries rendered here -->
          </div>
        </section>

        <!-- COMPLIANCE TAB -->
        <section class="tab-panel panel-compliance" id="compliancePanel">
          <!-- Content populated by renderComplianceContent() -->
        </section>

      </div><!-- end .tab-panels -->

      <!-- Global Disclaimer Footer (COMP-08) -->
      <footer class="global-disclaimer" id="globalDisclaimer">
        <p>
          <strong>Disclaimer:</strong> This calculator provides estimates for informational and educational purposes only.
          It does not constitute tax, legal, or financial advice. Tax laws are complex, subject to change, and vary by
          individual circumstances. Your actual tax liability may differ from these estimates. Always consult with a
          qualified tax professional (asesor fiscal, gestor) for guidance specific to your situation before making any
          financial decisions or filing tax returns.
        </p>
      </footer>
    </div><!-- end .dashboard -->

    <!-- Edit Scenario Modal -->
    <dialog id="editScenarioDialog" aria-labelledby="dialogTitle">
      <form method="dialog" class="edit-form">
        <header class="dialog-header">
          <h2 id="dialogTitle">Edit Scenario</h2>
          <button type="button" class="dialog-close" aria-label="Close" onclick="closeEditModal()">x</button>
        </header>

        <div class="dialog-body">
          <!-- Input pane (left) -->
          <div class="input-pane">
            <div class="form-group">
              <label for="editScenarioName">Scenario Name</label>
              <input type="text" id="editScenarioName" required autofocus>
            </div>

            <h3>Income & Expenses</h3>
            <div class="form-group">
              <label for="editMonthlyRevenue">Monthly Revenue (EUR)</label>
              <input type="number" id="editMonthlyRevenue" min="0" step="100">
            </div>
            <div class="form-group">
              <label for="editMonthlyExpenses">Monthly Expenses (EUR)</label>
              <input type="number" id="editMonthlyExpenses" min="0" step="100">
            </div>
            <div class="form-group">
              <label for="editWorkTravelCost">Work Travel Cost (EUR/month)</label>
              <input type="number" id="editWorkTravelCost" min="0" step="100" placeholder="e.g., 1000 or 2500">
            </div>
            <div class="form-group checkbox-group">
              <input type="checkbox" id="editHasDescendant">
              <label for="editHasDescendant">1 Dependent Child (adds 2,400 EUR minimo)</label>
            </div>

            <details class="fiscal-overrides">
              <summary>Fiscal Overrides (What-If Analysis)</summary>
              <div class="form-group">
                <label for="editRetaOverride">RETA Monthly (EUR)</label>
                <input type="number" id="editRetaOverride" placeholder="428.40" min="0" step="0.01">
              </div>
              <div class="form-group">
                <label for="editMinimoPersonalOverride">Minimo Personal (EUR)</label>
                <input type="number" id="editMinimoPersonalOverride" placeholder="5550" min="0" step="1">
              </div>
              <div class="form-group">
                <label for="editMinimoDescOverride">Minimo Descendientes (EUR)</label>
                <input type="number" id="editMinimoDescOverride" placeholder="2400" min="0" step="1">
              </div>
            </details>
          </div>

          <!-- Results pane (right) - live updating -->
          <div class="results-pane">
            <h3>Calculated Results</h3>
            <div id="liveEditResults">
              <!-- Populated by updateLiveResults() -->
            </div>
          </div>
        </div>

        <footer class="dialog-footer">
          <button type="button" id="deleteScenarioBtn" class="danger-btn" onclick="confirmDeleteScenario()">Delete</button>
          <div class="spacer"></div>
          <button type="button" class="secondary-btn" onclick="closeEditModal()">Cancel</button>
          <button type="submit" value="save" class="primary-btn">Save Changes</button>
        </footer>
      </form>
    </dialog>

    <!-- Detail Modal for Scenario Breakdown (UI-04) -->
    <dialog id="detail-modal" class="detail-dialog">
      <div class="detail-content">
        <header class="detail-header">
          <h2 class="detail-title">Scenario Details</h2>
          <button class="close-btn" onclick="closeDetailModal()">&times;</button>
        </header>
        <div class="detail-body" id="detail-body">
          <!-- Populated by openDetailModal() -->
        </div>
        <footer class="detail-footer">
          <button class="secondary-btn" onclick="closeDetailModal()">Close</button>
          <button class="primary-btn" onclick="editFromDetail()">Edit Scenario</button>
        </footer>
      </div>
    </dialog>

    <!-- Template Selection Dialog for New Scenario -->
    <dialog id="templateSelectDialog" aria-labelledby="templateDialogTitle">
      <form method="dialog">
        <header class="dialog-header">
          <h2 id="templateDialogTitle">Create New Scenario</h2>
          <button type="button" class="dialog-close" aria-label="Close" onclick="closeTemplateDialog()">x</button>
        </header>

        <div style="padding: 1.5rem;">
          <div class="form-group">
            <label for="newScenarioName">Scenario Name (required)</label>
            <input type="text" id="newScenarioName" required placeholder="e.g., Aggressive Growth">
          </div>

          <h3 style="margin-top: 1rem; font-size: 0.95rem;">Copy values from:</h3>
          <div class="template-options" id="templateOptions">
            <!-- Populated by showTemplateDialog() -->
          </div>
        </div>

        <footer class="dialog-footer">
          <div class="spacer"></div>
          <button type="button" class="secondary-btn" onclick="closeTemplateDialog()">Cancel</button>
          <button type="submit" value="create" class="primary-btn">Create Scenario</button>
        </footer>
      </form>
    </dialog>

    <!-- Contracted Pattern Wizard Dialog -->
    <dialog id="contractedWizardDialog">
      <div class="dialog-header">
        <h2>Apply Contracted Pattern?</h2>
        <button type="button" class="dialog-close" onclick="declineContractedPattern()">x</button>
      </div>
      <div style="padding: 1.5rem;">
        <p>Pre-fill calendar with your contracted work pattern?</p>
        <ul style="opacity: 0.8; margin: 1rem 0;">
          <li>Monday and Tuesday every week</li>
          <li>Wednesday-Friday of first week each month</li>
        </ul>
        <p style="font-size: 0.9rem; opacity: 0.7;">
          Belgian holidays are NOT auto-filled. You can override any day later.
        </p>
      </div>
      <div class="dialog-footer">
        <div class="spacer"></div>
        <button class="secondary-btn" onclick="declineContractedPattern()">Skip</button>
        <button class="primary-btn" onclick="applyContractedPattern()">Apply Pattern</button>
      </div>
    </dialog>

    <!-- Day Picker Dialog (Single Day Status) -->
    <dialog id="dayPickerDialog">
      <div class="dialog-header">
        <h2 id="pickerDateDisplay">February 15, 2026</h2>
        <button type="button" class="dialog-close" onclick="closeDayPicker()">x</button>
      </div>
      <div style="padding: 1.5rem;">
        <p id="pickerContracted" style="opacity: 0.7; margin-bottom: 1rem;"></p>

        <div class="status-options">
          <label class="status-option">
            <input type="radio" name="dayStatus" value="belgium">
            <span class="status-emoji-large">&#x1F1E7;&#x1F1EA;</span>
            <span>Belgium</span>
          </label>
          <label class="status-option">
            <input type="radio" name="dayStatus" value="spain">
            <span class="status-emoji-large">&#x1F1EA;&#x1F1F8;</span>
            <span>Spain</span>
          </label>
          <label class="status-option">
            <input type="radio" name="dayStatus" value="travel">
            <span class="status-emoji-large">&#x2708;&#xFE0F;</span>
            <span>Travel</span>
          </label>
          <label class="status-option">
            <input type="radio" name="dayStatus" value="unset">
            <span class="status-emoji-large">&#x26AA;</span>
            <span>Unset</span>
          </label>
        </div>

        <div class="picker-counts" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
          <p id="pickerMonthCount" style="opacity: 0.8;"></p>
          <p id="pickerAnnualCount" style="opacity: 0.8;"></p>
        </div>
      </div>
      <div class="dialog-footer">
        <div class="spacer"></div>
        <button class="secondary-btn" onclick="closeDayPicker()">Cancel</button>
        <button class="primary-btn" onclick="saveDayStatus()">Save</button>
      </div>
    </dialog>

    <!-- Bulk Picker Dialog (Multiple Days Status) -->
    <dialog id="bulkPickerDialog">
      <div class="dialog-header">
        <h2>Set Status for <span id="bulkCount">5</span> Days</h2>
        <button type="button" class="dialog-close" onclick="closeBulkPicker()">x</button>
      </div>
      <div style="padding: 1.5rem;">
        <p style="opacity: 0.7; margin-bottom: 1rem;">Apply status to all selected days:</p>
        <div class="status-options">
          <label class="status-option">
            <input type="radio" name="bulkStatus" value="belgium">
            <span class="status-emoji-large">&#x1F1E7;&#x1F1EA;</span>
            <span>Belgium</span>
          </label>
          <label class="status-option">
            <input type="radio" name="bulkStatus" value="spain">
            <span class="status-emoji-large">&#x1F1EA;&#x1F1F8;</span>
            <span>Spain</span>
          </label>
          <label class="status-option">
            <input type="radio" name="bulkStatus" value="travel">
            <span class="status-emoji-large">&#x2708;&#xFE0F;</span>
            <span>Travel</span>
          </label>
          <label class="status-option">
            <input type="radio" name="bulkStatus" value="unset">
            <span class="status-emoji-large">&#x26AA;</span>
            <span>Unset</span>
          </label>
        </div>
      </div>
      <div class="dialog-footer">
        <div class="spacer"></div>
        <button class="secondary-btn" onclick="closeBulkPicker()">Cancel</button>
        <button class="primary-btn" onclick="saveBulkStatus()">Apply to All</button>
      </div>
    </dialog>

    <!-- Income Entry Dialog (Phase 8 - ENH-02) -->
    <dialog id="incomeDialog" class="modal-dialog">
      <form id="incomeForm" onsubmit="saveIncomeEntry(event)">
        <div class="dialog-header">
          <h3 id="incomeDialogTitle">Add Income Entry</h3>
          <button type="button" class="dialog-close" onclick="closeIncomeDialog()">x</button>
        </div>

        <div style="padding: var(--spacing-md);">
          <div class="form-group">
            <label for="incomeClient">Client Name *</label>
            <input type="text" id="incomeClient" name="clientName" required>
          </div>

          <div class="form-group">
            <label for="incomeInvoice">Invoice Number</label>
            <input type="text" id="incomeInvoice" name="invoiceNumber" placeholder="INV-2026-001">
          </div>

          <div class="form-group">
            <label for="incomeAmount">Amount (EUR) *</label>
            <input type="number" id="incomeAmount" name="amount" step="0.01" min="0" required>
          </div>

          <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
            <div class="form-group">
              <label for="incomeDateInvoiced">Date Invoiced</label>
              <input type="date" id="incomeDateInvoiced" name="dateInvoiced">
            </div>
            <div class="form-group">
              <label for="incomeDateReceived">Date Received *</label>
              <input type="date" id="incomeDateReceived" name="dateReceived" required>
            </div>
          </div>

          <div class="form-group">
            <label for="incomeDescription">Description</label>
            <textarea id="incomeDescription" name="description" rows="2" placeholder="IT Consulting - January 2026" style="width: 100%; resize: vertical;"></textarea>
          </div>

          <div class="form-group">
            <label for="incomeStatus">Status</label>
            <select id="incomeStatus" name="status">
              <option value="paid">Paid</option>
              <option value="pending">Pending</option>
              <option value="overdue">Overdue</option>
            </select>
          </div>

          <input type="hidden" id="incomeEditId" name="editId">
        </div>

        <div class="dialog-footer">
          <button type="button" class="secondary-btn" onclick="closeIncomeDialog()">Cancel</button>
          <button type="submit" class="primary-btn">Save</button>
        </div>
      </form>
    </dialog>

    <!-- Tooltip Modal (single instance, reused for all tooltips) -->
    <dialog id="tooltipModal" class="tooltip-modal">
      <div class="tooltip-modal-content">
        <h3 id="tooltipModalTitle" class="tooltip-modal-title"></h3>
        <p id="tooltipModalText" class="tooltip-modal-text"></p>
        <button type="button" class="tooltip-modal-close" autofocus onclick="closeTooltipModal()">Got it</button>
      </div>
    </dialog>
  </div>
  <script>
    // ============================================================
    // BROWSER COMPATIBILITY CHECK
    // ============================================================
    // Check for required browser features
    (function() {
      const requiredFeatures = [
        { name: 'dialog', test: () => typeof HTMLDialogElement !== 'undefined' },
        { name: 'localStorage', test: () => {
          try {
            localStorage.setItem('test', 'test');
            localStorage.removeItem('test');
            return true;
          } catch (e) {
            return false; // Private mode - app still works, just no persistence
          }
        }},
        { name: 'structuredClone', test: () => typeof structuredClone === 'function' }
      ];

      const missing = requiredFeatures.filter(f => !f.test()).map(f => f.name);

      // Dialog is critical - show warning if missing
      if (missing.includes('dialog')) {
        console.warn('Your browser does not support the <dialog> element. Please use a modern browser (Chrome 37+, Firefox 98+, Safari 15.4+, Edge 79+) for the best experience.');
      }

      // Polyfill structuredClone if missing (older Safari)
      if (typeof structuredClone === 'undefined') {
        window.structuredClone = function(obj) {
          return JSON.parse(JSON.stringify(obj));
        };
      }
    })();

    // ============================================================
    // FISCAL_2025 CONSTANTS
    // ============================================================
    // All fiscal data verified from official AEAT/BOE sources
    // See: .planning/research/FISCAL_DATA.md for full citations
    // ============================================================

    const FISCAL_2025 = Object.freeze({
      // IRPF Brackets - Combined estatal + autonomica rates
      // Source: Wolters Kluwer, AEAT - unchanged from 2024
      // https://www.wolterskluwer.com/es-es/expert-insights/tramos-retenciones-irpf-2025-novedades
      //
      // baseTax = cumulative tax from all lower brackets
      // prevLimit = upper boundary of previous bracket
      IRPF_BRACKETS: Object.freeze([
        { upTo: 12450, rate: 0.19, baseTax: 0, prevLimit: 0 },
        { upTo: 20200, rate: 0.24, baseTax: 2365.50, prevLimit: 12450 },
        { upTo: 35200, rate: 0.30, baseTax: 4225.50, prevLimit: 20200 },
        { upTo: 60000, rate: 0.37, baseTax: 8725.50, prevLimit: 35200 },
        { upTo: 300000, rate: 0.45, baseTax: 17901.50, prevLimit: 60000 },
        { upTo: Infinity, rate: 0.47, baseTax: 125901.50, prevLimit: 300000 }
      ]),

      // Personal/Family minimums
      // Source: AEAT Manual Practico IRPF 2024
      // https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2024/c14-adecuacion-impuesto-circunstancias-personales/cuadro-resumen-minimo-personal-familiar.html
      MINIMO_PERSONAL: 5550,
      MINIMO_DESCENDIENTES_PRIMERO: 2400,

      // Fixed RETA from user registration
      // This is the actual cuota paid, not a calculated value
      // Source: User's Seguridad Social registration document
      RETA_MONTHLY: 428.40,
      RETA_ANNUAL: 5140.80,

      // Gastos dificil justificacion (Estimacion Directa Simplificada)
      // Source: AEAT Estimacion Directa Simplificada
      // https://sede.agenciatributaria.gob.es/Sede/irpf/empresarios-individuales-profesionales/regimenes-determinar-rendimiento-actividad/estimacion-directa-simplificada.html
      // Note: Was 7% in 2023, reverted to 5% for 2024 onwards
      GASTOS_DIFICIL_RATE: 0.05,
      GASTOS_DIFICIL_MAX: 2000,

      // Private costs (fixed, not deductible)
      // Breakdown: Rent 70% (808.50) + GSM 50% (27.50) + Electricity 91% (91) + Auto (600) + Insurance (200)
      PRIVATE_COSTS_MONTHLY: 1727
    });

    // ============================================================
    // OFFICIAL SOURCE CITATIONS
    // ============================================================
    // All fiscal data traced to official AEAT/BOE/Seguridad Social sources
    // ============================================================

    // ============================================================
    // CALENDAR CONSTANTS
    // ============================================================
    // Data structures for Belgium presence calendar (Feb-Dec 2026)
    // ============================================================

    const CALENDAR_STORAGE_KEY = 'autonomo_calendar_v1';

    const DAY_STATUS = Object.freeze({
      UNSET: 'unset',
      BELGIUM: 'belgium',
      SPAIN: 'spain',
      TRAVEL: 'travel'
    });

    const DEFAULT_CALENDAR_STATE = Object.freeze({
      version: 1,
      year: 2026,
      startMonth: 1,  // February (0-indexed)
      endMonth: 11,   // December (0-indexed)
      days: {},       // { "2026-02-15": { status: "belgium", contracted: true } }
      contractedPatternApplied: false,
      lastModified: null,
      currentMonth: 1  // February (0-indexed) - for navigation
    });

    // ============================================================
    // CALENDAR STATE MANAGEMENT
    // ============================================================
    // localStorage persistence for calendar state
    // ============================================================

    /**
     * Convert Date to ISO date key string (YYYY-MM-DD)
     * @param {Date} date - Date object
     * @returns {string} - ISO date string like "2026-02-15"
     */
    function toISODateKey(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    /**
     * Load calendar state from localStorage
     * Falls back to DEFAULT_CALENDAR_STATE on error or invalid data
     * @returns {object} - Calendar state object (mutable clone)
     */
    function loadCalendarState() {
      try {
        const stored = localStorage.getItem(CALENDAR_STORAGE_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);
          // Version check for future migration support
          if (parsed && parsed.version === 1) {
            return parsed;
          }
        }
      } catch (e) {
        console.warn('localStorage calendar load failed:', e.message);
      }
      // Return mutable clone of defaults
      return structuredClone(DEFAULT_CALENDAR_STATE);
    }

    /**
     * Save calendar state to localStorage
     * Updates lastModified timestamp
     * @returns {boolean} - True if save succeeded
     */
    function saveCalendarState() {
      try {
        calendarState.lastModified = new Date().toISOString();
        localStorage.setItem(CALENDAR_STORAGE_KEY, JSON.stringify(calendarState));
        return true;
      } catch (e) {
        if (e.name === 'QuotaExceededError') {
          console.warn('localStorage quota exceeded - calendar state not persisted');
        } else {
          console.warn('localStorage calendar save failed:', e.message);
        }
        return false;
      }
    }

    // Global calendar state - initialized from localStorage or defaults
    let calendarState = loadCalendarState();

    // Selection state for bulk operations
    let lastClickedDate = null;
    let selectedDates = new Set();
    let unsavedChanges = false;

    // ============================================================
    // CALENDAR RENDERING FUNCTIONS
    // ============================================================
    // Month grid rendering with navigation for Feb-Dec 2026
    // ============================================================

    /**
     * Get month grid as 2D array of weeks
     * Each week is 7 cells (Date or null for empty padding)
     * Uses Monday-start week alignment
     *
     * @param {number} year - Year (e.g., 2026)
     * @param {number} month - Month (0-indexed, 0=January)
     * @returns {array} - Array of weeks, each week is array of 7 elements
     */
    function getMonthGrid(year, month) {
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const totalDays = lastDay.getDate();

      // Monday-start: convert Sunday=0 to 6, Mon=1 to 0, etc.
      const startOffset = (firstDay.getDay() + 6) % 7;

      const weeks = [];
      let currentWeek = [];

      // Add empty cells for days before month starts
      for (let i = 0; i < startOffset; i++) {
        currentWeek.push(null);
      }

      // Add days of month
      for (let day = 1; day <= totalDays; day++) {
        currentWeek.push(new Date(year, month, day));

        if (currentWeek.length === 7) {
          weeks.push(currentWeek);
          currentWeek = [];
        }
      }

      // Add empty cells to complete last week
      while (currentWeek.length > 0 && currentWeek.length < 7) {
        currentWeek.push(null);
      }
      if (currentWeek.length > 0) {
        weeks.push(currentWeek);
      }

      return weeks;
    }

    /**
     * Get status emoji for a day status
     * @param {string} status - Day status from DAY_STATUS
     * @returns {string} - Emoji character
     */
    function getStatusEmoji(status) {
      switch (status) {
        case DAY_STATUS.BELGIUM: return '\u{1F1E7}\u{1F1EA}'; // Flag Belgium
        case DAY_STATUS.SPAIN: return '\u{1F1EA}\u{1F1F8}'; // Flag Spain
        case DAY_STATUS.TRAVEL: return '\u{2708}\u{FE0F}'; // Airplane
        default: return '';
      }
    }

    /**
     * Navigate to different month
     * Updates currentMonth within bounds [startMonth, endMonth]
     *
     * @param {number} delta - Direction (-1 for prev, +1 for next)
     */
    function navigateMonth(delta) {
      const newMonth = calendarState.currentMonth + delta;
      if (newMonth >= calendarState.startMonth && newMonth <= calendarState.endMonth) {
        calendarState.currentMonth = newMonth;
        saveCalendarState();
        renderCalendar();
        updateCountDisplays();  // Update counts for new month
      }
    }

    /**
     * Render calendar for current month
     * Shows month header with navigation and day grid
     */
    function renderCalendar() {
      const container = document.getElementById('calendarContainer');
      if (!container) return;

      const year = calendarState.year;
      const month = calendarState.currentMonth;

      // Get month name
      const monthName = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' })
        .format(new Date(year, month, 1));

      // Check navigation bounds
      const canPrev = month > calendarState.startMonth;
      const canNext = month < calendarState.endMonth;

      // Build header with Select All button
      const headerHtml = `
        <div class="calendar-header">
          <button class="nav-btn" onclick="navigateMonth(-1)" ${canPrev ? '' : 'disabled'}>
            &larr; Prev
          </button>
          <div style="display: flex; align-items: center; justify-content: center;">
            <h3 style="margin: 0;">${monthName}</h3>
            <button type="button" class="month-select-all" onclick="selectMonth(${month})" title="Select all days in ${monthName}">Select All</button>
          </div>
          <button class="nav-btn" onclick="navigateMonth(1)" ${canNext ? '' : 'disabled'}>
            Next &rarr;
          </button>
        </div>
      `;

      // Build grid with week selectors
      const weeks = getMonthGrid(year, month);
      const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

      let gridHtml = '<div class="calendar-grid-with-weeks">';

      // Day headers (empty cell for week selector column)
      gridHtml += '<div class="day-header"></div>';
      dayNames.forEach(name => {
        gridHtml += `<div class="day-header">${name}</div>`;
      });

      // Day cells with week selectors
      weeks.forEach((week, weekIndex) => {
        // Find first non-null date in this week to calculate Monday
        const firstDateInWeek = week.find(d => d !== null);
        let weekStartKey = null;

        if (firstDateInWeek) {
          // Calculate the Monday of this week
          const monday = new Date(firstDateInWeek);
          const dayOfWeek = monday.getDay();
          // Adjust to Monday (0=Sunday, so Sunday needs -6, others need 1-dayOfWeek)
          const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
          monday.setDate(monday.getDate() - daysToSubtract);
          weekStartKey = toISODateKey(monday);
        }

        // Week selector button
        if (weekStartKey) {
          gridHtml += `<div class="week-selector-cell"><button type="button" class="week-selector" onclick="selectWeek('${weekStartKey}')" title="Select entire week" aria-label="Select week starting ${weekStartKey}">W</button></div>`;
        } else {
          gridHtml += '<div class="week-selector-cell"></div>';
        }

        // Day cells for this week
        week.forEach(date => {
          if (date === null) {
            gridHtml += '<div class="day-cell empty"></div>';
          } else {
            const dateKey = toISODateKey(date);
            const dayData = calendarState.days[dateKey] || {};
            const status = dayData.status || DAY_STATUS.UNSET;
            const isContracted = dayData.contracted === true;
            const emoji = getStatusEmoji(status);

            const isSelected = selectedDates.has(dateKey);
            gridHtml += `
              <div class="day-cell ${status} ${isSelected ? 'selected' : ''}" data-date="${dateKey}">
                <div class="day-cell-header">
                  <input type="checkbox" class="day-checkbox"
                    ${isSelected ? 'checked' : ''}
                    onchange="toggleDaySelection('${dateKey}', this.checked)"
                    aria-label="Select ${date.getDate()}">
                  <span class="day-number">${date.getDate()}</span>
                  ${isContracted ? '<span class="contracted-badge">C</span>' : ''}
                </div>
                <div class="day-status-display" onclick="toggleDaySelection('${dateKey}')">
                  ${emoji ? `<span class="status-emoji">${emoji}</span>` : '<span class="status-empty">-</span>'}
                </div>
              </div>
            `;
          }
        });
      });

      gridHtml += '</div>';

      container.innerHTML = headerHtml + gridHtml;
    }

    // ============================================================
    // CONTRACTED PATTERN FUNCTIONS
    // ============================================================
    // Generate contracted work pattern: Mon-Tue weekly + first-week Wed-Fri
    // ============================================================

    /**
     * Generate contracted work pattern for Feb-Dec 2026
     * Pattern: Monday and Tuesday every week, plus Wed-Fri of first week each month
     *
     * @param {number} year - Year (e.g., 2026)
     * @param {number} startMonth - Start month (0-indexed)
     * @param {number} endMonth - End month (0-indexed)
     * @returns {array} - Array of ISO date strings (contracted days)
     */
    function generateContractedPattern(year, startMonth, endMonth) {
      const contractedDays = [];
      for (let month = startMonth; month <= endMonth; month++) {
        const lastOfMonth = new Date(year, month + 1, 0);
        let isFirstWeek = true;

        for (let day = 1; day <= lastOfMonth.getDate(); day++) {
          const date = new Date(year, month, day);
          const dayOfWeek = date.getDay(); // 0=Sunday, 1=Monday, etc.

          // Monday (1) or Tuesday (2) = always contracted
          if (dayOfWeek === 1 || dayOfWeek === 2) {
            contractedDays.push(toISODateKey(date));
          }

          // First week: Wed(3), Thu(4), Fri(5) also contracted
          if (isFirstWeek && (dayOfWeek === 3 || dayOfWeek === 4 || dayOfWeek === 5)) {
            contractedDays.push(toISODateKey(date));
          }

          // End first week on Sunday (after first full week)
          if (dayOfWeek === 0 && day > 1) {
            isFirstWeek = false;
          }
        }
      }
      return contractedDays;
    }

    /**
     * Show contracted pattern wizard dialog
     * Only shows if contractedPatternApplied is false
     */
    function showContractedWizard() {
      if (calendarState.contractedPatternApplied) {
        return; // Already applied or declined
      }

      const dialog = document.getElementById('contractedWizardDialog');
      if (dialog) {
        dialog.showModal();
      }
    }

    /**
     * Apply contracted pattern to calendar
     * Marks all contracted days as Belgium with contracted flag
     */
    function applyContractedPattern() {
      const contractedDays = generateContractedPattern(
        calendarState.year,
        calendarState.startMonth,
        calendarState.endMonth
      );

      // Mark each contracted day as Belgium + contracted
      contractedDays.forEach(dateKey => {
        calendarState.days[dateKey] = {
          status: DAY_STATUS.BELGIUM,
          contracted: true
        };
      });

      calendarState.contractedPatternApplied = true;
      saveCalendarState();
      renderCalendar();
      updateCountDisplays();  // Update counts after applying pattern

      // Close dialog
      const dialog = document.getElementById('contractedWizardDialog');
      if (dialog) {
        dialog.close();
      }
    }

    /**
     * Decline contracted pattern
     * Sets flag so wizard doesn't appear again
     */
    function declineContractedPattern() {
      calendarState.contractedPatternApplied = true;
      saveCalendarState();

      // Close dialog
      const dialog = document.getElementById('contractedWizardDialog');
      if (dialog) {
        dialog.close();
      }
    }

    /**
     * Toggle selection of a single day
     * @param {string} dateKey - ISO date key (YYYY-MM-DD)
     * @param {boolean} isChecked - Whether checkbox is checked (optional, toggles if not provided)
     */
    function toggleDaySelection(dateKey, isChecked) {
      if (typeof isChecked === 'boolean') {
        if (isChecked) {
          selectedDates.add(dateKey);
        } else {
          selectedDates.delete(dateKey);
        }
      } else {
        // Toggle if no explicit value
        if (selectedDates.has(dateKey)) {
          selectedDates.delete(dateKey);
        } else {
          selectedDates.add(dateKey);
        }
      }
      lastClickedDate = dateKey;
      renderCalendar();
      updateSelectionCount();
    }

    /**
     * Update the selection count display in toolbar
     */
    function updateSelectionCount() {
      const countEl = document.getElementById('selectionCount');
      if (countEl) {
        countEl.textContent = selectedDates.size;
      }
    }

    /**
     * Apply a status to all selected days
     * @param {string} status - Status to apply ('belgium', 'spain', 'travel', 'unset')
     */
    function applyStatusToSelected(status) {
      if (selectedDates.size === 0) {
        return; // Nothing selected
      }

      selectedDates.forEach(dateKey => {
        const existingData = calendarState.days[dateKey] || {};

        if (status === 'unset') {
          if (existingData.contracted) {
            calendarState.days[dateKey] = { status: 'unset', contracted: true };
          } else {
            delete calendarState.days[dateKey];
          }
        } else {
          calendarState.days[dateKey] = {
            status: status,
            contracted: existingData.contracted || false
          };
        }
      });

      // Mark as unsaved, clear selection, update UI
      markUnsaved();
      selectedDates.clear();
      renderCalendar();
      updateSelectionCount();
      updateCountDisplays();
    }

    /**
     * Set day status directly (for single day quick click on status display)
     * @param {string} dateKey - ISO date key (YYYY-MM-DD)
     * @param {string} status - New status
     */
    function setDayStatus(dateKey, status) {
      const existingData = calendarState.days[dateKey] || {};

      if (status === 'unset') {
        if (existingData.contracted) {
          calendarState.days[dateKey] = { status: 'unset', contracted: true };
        } else {
          delete calendarState.days[dateKey];
        }
      } else {
        calendarState.days[dateKey] = {
          status: status,
          contracted: existingData.contracted || false
        };
      }

      markUnsaved();
      renderCalendar();
      updateCountDisplays();
    }

    // ============================================================
    // DAY PICKER DIALOG FUNCTIONS (legacy, kept for bulk operations)
    // ============================================================
    // Open/close day picker and save status for individual days
    // ============================================================

    /**
     * Open day picker dialog for a specific date
     * Shows date info, contracted status, and current status selection
     *
     * @param {string} dateKey - ISO date key (YYYY-MM-DD)
     */
    function openDayPicker(dateKey) {
      const dialog = document.getElementById('dayPickerDialog');
      if (!dialog) return;

      // Store dateKey for save operation
      dialog.dataset.dateKey = dateKey;

      // Format date for display
      const date = new Date(dateKey);
      const dateDisplay = new Intl.DateTimeFormat('en-US', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      }).format(date);
      document.getElementById('pickerDateDisplay').textContent = dateDisplay;

      // Show contracted status
      const dayData = calendarState.days[dateKey] || {};
      const contractedEl = document.getElementById('pickerContracted');
      if (dayData.contracted) {
        contractedEl.textContent = 'Contracted work day';
      } else {
        contractedEl.textContent = '';
      }

      // Set current status radio
      const currentStatus = dayData.status || 'unset';
      const radios = dialog.querySelectorAll('input[name="dayStatus"]');
      radios.forEach(radio => {
        radio.checked = radio.value === currentStatus;
      });

      // Update count displays
      updatePickerCounts();

      dialog.showModal();
    }

    /**
     * Update the count displays in the day picker dialog
     */
    function updatePickerCounts() {
      const counts = calculateCounts();
      const monthCountEl = document.getElementById('pickerMonthCount');
      const annualCountEl = document.getElementById('pickerAnnualCount');

      if (monthCountEl) {
        monthCountEl.textContent = `${counts.monthBelgium} days in Belgium this month`;
      }
      if (annualCountEl) {
        annualCountEl.textContent = `${counts.annualThreshold} days in Belgium (annual total)`;
      }
    }

    /**
     * Save the selected status for the current day
     * Marks state as dirty (unsaved) - requires explicit Save to commit
     */
    function saveDayStatus() {
      const dialog = document.getElementById('dayPickerDialog');
      if (!dialog) return;

      const dateKey = dialog.dataset.dateKey;
      if (!dateKey) return;

      // Get selected status
      const selectedRadio = dialog.querySelector('input[name="dayStatus"]:checked');
      const newStatus = selectedRadio ? selectedRadio.value : 'unset';

      // Update calendarState.days, preserving contracted flag
      const existingData = calendarState.days[dateKey] || {};
      calendarState.days[dateKey] = {
        status: newStatus,
        contracted: existingData.contracted || false
      };

      // Mark as having unsaved changes
      markUnsaved();

      // Close dialog and re-render
      dialog.close();
      renderCalendar();
      updateCountDisplays();
    }

    /**
     * Close day picker dialog without saving
     */
    function closeDayPicker() {
      const dialog = document.getElementById('dayPickerDialog');
      if (dialog) {
        dialog.close();
      }
    }

    /**
     * Handle day cell click
     * Single click opens day picker; Shift+click selects range for bulk operation
     *
     * @param {string} dateKey - ISO date key (YYYY-MM-DD)
     * @param {Event} event - Click event
     */
    function handleDayClick(dateKey, event) {
      if (event.shiftKey && lastClickedDate) {
        // Range selection
        selectDateRange(lastClickedDate, dateKey);
      } else {
        // Single selection
        selectedDates.clear();
        selectedDates.add(dateKey);
        lastClickedDate = dateKey;
        openDayPicker(dateKey);
      }
    }

    /**
     * Select a range of dates between start and end
     * Opens bulk picker after selection
     *
     * @param {string} start - Start date key (YYYY-MM-DD)
     * @param {string} end - End date key (YYYY-MM-DD)
     */
    function selectDateRange(start, end) {
      const startDate = new Date(start);
      const endDate = new Date(end);

      // Ensure start < end
      const [from, to] = startDate <= endDate
        ? [startDate, endDate]
        : [endDate, startDate];

      selectedDates.clear();
      const current = new Date(from);
      while (current <= to) {
        // Only include dates in valid range (Feb-Dec 2026)
        const month = current.getMonth();
        if (current.getFullYear() === 2026 && month >= 1 && month <= 11) {
          selectedDates.add(toISODateKey(current));
        }
        current.setDate(current.getDate() + 1);
      }

      // Re-render to show selection, then open bulk picker
      renderCalendar();
      updateSelectionIndicator();
      openBulkPicker();
    }

    /**
     * Open bulk picker dialog for multiple selected dates
     */
    function openBulkPicker() {
      const dialog = document.getElementById('bulkPickerDialog');
      if (!dialog) return;

      // Update count display
      document.getElementById('bulkCount').textContent = selectedDates.size;

      // Default to belgium selected
      const radios = dialog.querySelectorAll('input[name="bulkStatus"]');
      radios.forEach(radio => {
        radio.checked = radio.value === 'belgium';
      });

      dialog.showModal();
    }

    /**
     * Close bulk picker dialog without saving
     */
    function closeBulkPicker() {
      const dialog = document.getElementById('bulkPickerDialog');
      if (dialog) {
        dialog.close();
      }
      // Clear selection
      selectedDates.clear();
      renderCalendar();
      updateSelectionIndicator();
    }

    /**
     * Save bulk status to all selected dates
     */
    function saveBulkStatus() {
      const dialog = document.getElementById('bulkPickerDialog');
      if (!dialog) return;

      // Get selected status
      const selectedRadio = dialog.querySelector('input[name="bulkStatus"]:checked');
      const newStatus = selectedRadio ? selectedRadio.value : 'unset';

      // Apply status to all selected dates
      selectedDates.forEach(dateKey => {
        const existingData = calendarState.days[dateKey] || {};
        calendarState.days[dateKey] = {
          status: newStatus,
          contracted: existingData.contracted || false
        };
      });

      // Mark as having unsaved changes
      markUnsaved();

      // Close dialog, clear selection, and re-render
      dialog.close();
      selectedDates.clear();
      renderCalendar();
      updateSelectionIndicator();
      updateCountDisplays();
    }

    /**
     * Mark calendar as having unsaved changes
     * Shows indicator and enables save button
     */
    function markUnsaved() {
      unsavedChanges = true;
      const indicator = document.getElementById('unsavedIndicator');
      const saveBtn = document.getElementById('saveCalendarBtn');
      if (indicator) indicator.classList.remove('hidden');
      if (saveBtn) saveBtn.disabled = false;
    }

    // ============================================================
    // MULTI-SELECT ENHANCEMENTS (BUG-05)
    // ============================================================
    // Week and month selection with selection indicator
    // ============================================================

    /**
     * Select all days in a week (adds to existing selection)
     * @param {string} weekStartKey - ISO date key of week's Monday
     */
    function selectWeek(weekStartKey) {
      const start = new Date(weekStartKey);

      for (let i = 0; i < 7; i++) {
        const day = new Date(start);
        day.setDate(start.getDate() + i);

        // Only include valid range (Feb-Dec 2026)
        if (day.getFullYear() === 2026 && day.getMonth() >= 1) {
          selectedDates.add(toISODateKey(day));
        }
      }

      renderCalendar();
      updateSelectionCount();
    }

    /**
     * Select all days in a month (adds to existing selection)
     * @param {number} month - Month index (0-11)
     */
    function selectMonth(month) {
      const year = 2026;
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);

      const current = new Date(firstDay);
      while (current <= lastDay) {
        selectedDates.add(toISODateKey(current));
        current.setDate(current.getDate() + 1);
      }

      renderCalendar();
      updateSelectionCount();
    }

    /**
     * Update selection indicator visibility and count
     * Updated for ENH-06: Uses badge styling in toolbar
     */
    function updateSelectionIndicator() {
      const countEl = document.getElementById('selectionCount');
      if (!countEl) return;

      // Update count with badge styling (ENH-06)
      countEl.textContent = selectedDates.size;
    }

    /**
     * Clear all selected dates
     */
    function clearSelection() {
      selectedDates.clear();
      renderCalendar();
      updateSelectionCount();
    }

    // ============================================================
    // COUNTING SYSTEM AND WARNING THRESHOLDS (Task 2)
    // ============================================================
    // Count Belgium/Spain/Travel days and display warnings
    // ============================================================

    const WARNING_THRESHOLDS = Object.freeze({
      YELLOW: 170,
      ORANGE: 180,
      RED: 183
    });

    /**
     * Calculate all day counts for current month and year
     * @returns {object} - Monthly and annual counts
     */
    function calculateCounts() {
      const days = calendarState.days;
      let monthBelgium = 0, monthTravel = 0, monthSpain = 0;
      let annualBelgium = 0, annualTravel = 0, annualSpain = 0;

      const currentMonth = calendarState.currentMonth;
      const year = calendarState.year;

      Object.entries(days).forEach(([dateKey, data]) => {
        const [y, m] = dateKey.split('-').map(Number);
        if (y !== year) return;

        // Annual counts
        if (data.status === 'belgium') annualBelgium++;
        else if (data.status === 'travel') annualTravel++;
        else if (data.status === 'spain') annualSpain++;

        // Monthly counts (for current displayed month)
        if (m - 1 === currentMonth) {  // m is 1-indexed from ISO string
          if (data.status === 'belgium') monthBelgium++;
          else if (data.status === 'travel') monthTravel++;
          else if (data.status === 'spain') monthSpain++;
        }
      });

      return {
        monthBelgium, monthTravel, monthSpain,
        annualBelgium, annualTravel, annualSpain,
        annualThreshold: annualBelgium + annualTravel  // Conservative: both count
      };
    }

    /**
     * Get warning level based on threshold count
     * @param {number} thresholdCount - Number of Belgium + Travel days
     * @returns {string|null} - 'red', 'orange', 'yellow', or null
     */
    function getWarningLevel(thresholdCount) {
      if (thresholdCount >= WARNING_THRESHOLDS.RED) return 'red';
      if (thresholdCount >= WARNING_THRESHOLDS.ORANGE) return 'orange';
      if (thresholdCount >= WARNING_THRESHOLDS.YELLOW) return 'yellow';
      return null;
    }

    /**
     * Update count displays and warning banners
     * Called after any day status change
     */
    function updateCountDisplays() {
      const counts = calculateCounts();

      const monthCountEl = document.getElementById('monthBelgiumCount');
      const annualCountEl = document.getElementById('annualBelgiumCount');
      if (monthCountEl) monthCountEl.textContent = counts.monthBelgium;
      if (annualCountEl) annualCountEl.textContent = counts.annualThreshold;

      const warningLevel = getWarningLevel(counts.annualThreshold);
      const badge = document.getElementById('warningBadge');
      const banner = document.getElementById('warningBanner');

      // Reset classes
      if (badge) badge.className = 'warning-badge hidden';
      if (banner) banner.className = 'warning-banner hidden';

      if (warningLevel && badge && banner) {
        badge.className = `warning-badge ${warningLevel}`;
        badge.textContent = warningLevel === 'red' ? 'EXCEEDED' : 'WARNING';

        banner.className = `warning-banner ${warningLevel}`;
        const messages = {
          yellow: `Approaching threshold: ${counts.annualThreshold} days in Belgium (183 triggers residency review)`,
          orange: `Very close to threshold: ${counts.annualThreshold} days in Belgium (183 triggers residency review)`,
          red: `Threshold exceeded: ${counts.annualThreshold} days in Belgium (exceeds 183-day limit)`
        };
        banner.textContent = messages[warningLevel];
      }
    }

    /**
     * Commit calendar changes to localStorage
     * Clears unsaved indicator and disables save button
     */
    function commitCalendarChanges() {
      calendarState.lastModified = new Date().toISOString();
      saveCalendarState();
      unsavedChanges = false;
      const indicator = document.getElementById('unsavedIndicator');
      const saveBtn = document.getElementById('saveCalendarBtn');
      if (indicator) indicator.classList.add('hidden');
      if (saveBtn) saveBtn.disabled = true;
      // Update compliance warning banner when calendar changes are saved
      updateComplianceWarning();
    }

    /**
     * Reset calendar to empty state (clears all day statuses)
     * Asks for confirmation before clearing
     */
    function resetCalendar() {
      if (!confirm('Reset calendar? This will clear all day statuses. This action cannot be undone.')) {
        return;
      }

      // Clear all day data but keep structure
      calendarState.days = {};
      calendarState.contractedPatternApplied = false;
      calendarState.lastModified = new Date().toISOString();

      // Clear from localStorage
      localStorage.removeItem('autonomoCalendarState');

      // Clear selection
      selectedDates.clear();
      lastClickedDate = null;

      // Re-render and update displays
      renderCalendar();
      updateSelectionIndicator();
      updateCountDisplays();
      updateComplianceWarning();

      // Mark as clean (no unsaved changes since we just cleared)
      unsavedChanges = false;
      const indicator = document.getElementById('unsavedIndicator');
      const saveBtn = document.getElementById('saveCalendarBtn');
      if (indicator) indicator.classList.add('hidden');
      if (saveBtn) saveBtn.disabled = true;

      // Show wizard again
      showContractedWizard();
    }

    // ============================================================
    // CALENDAR EXPORT FUNCTIONS (Task 1)
    // ============================================================
    // ICS and CSV export with Blob API download
    // ============================================================

    /**
     * Format date for ICS timestamp (YYYYMMDDTHHMMSSZ format)
     * @param {Date} date - Date to format
     * @returns {string} - ICS formatted timestamp
     */
    function formatICSTimestamp(date) {
      return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
    }

    /**
     * Generate ICS (iCalendar) content for all marked days
     * Follows RFC 5545 specification
     * @returns {string} - Valid ICS file content
     */
    function generateICS() {
      const events = Object.entries(calendarState.days)
        .filter(([_, data]) => data.status && data.status !== 'unset')
        .map(([dateKey, data]) => {
          const date = new Date(dateKey);
          const nextDay = new Date(date);
          nextDay.setDate(nextDay.getDate() + 1);

          const statusText = {
            belgium: 'Belgium Work Day',
            spain: 'Spain',
            travel: 'Travel Day'
          }[data.status];

          const contractedNote = data.contracted ? ' (Contracted)' : '';

          // ICS format for all-day events
          return `BEGIN:VEVENT
UID:${dateKey}-autonomo@tax-calculator
DTSTAMP:${formatICSTimestamp(new Date())}
DTSTART;VALUE=DATE:${dateKey.replace(/-/g, '')}
DTEND;VALUE=DATE:${toISODateKey(nextDay).replace(/-/g, '')}
SUMMARY:${statusText}${contractedNote}
DESCRIPTION:${statusText} - Autonomo Tax Calculator Belgium Tracking
END:VEVENT`;
        });

      return `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Autonomo Tax Calculator//Belgium Calendar//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:Belgium Work Calendar 2026
${events.join('\n')}
END:VCALENDAR`;
    }

    /**
     * Download ICS file via Blob API
     * Creates temporary anchor element for download
     */
    function downloadICS() {
      const ics = generateICS();
      const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'belgium-calendar-2026.ics';
      document.body.appendChild(a);
      a.click();

      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    /**
     * Escape a field value for CSV (handles quotes, commas, newlines)
     * @param {any} value - Value to escape
     * @returns {string} - CSV-safe string
     */
    function escapeCSVField(value) {
      if (value == null) return '';
      const str = String(value);
      if (str.search(/("|,|\n)/g) >= 0) {
        return '"' + str.replace(/"/g, '""') + '"';
      }
      return str;
    }

    /**
     * Generate CSV content for all marked days
     * Includes headers, data rows, and summary section
     * @returns {string} - CSV file content
     */
    function generateCSV() {
      const headers = ['Date', 'Day of Week', 'Status', 'Contracted', 'Month'];
      const rows = Object.entries(calendarState.days)
        .filter(([_, data]) => data.status && data.status !== 'unset')
        .sort(([a], [b]) => a.localeCompare(b))
        .map(([dateKey, data]) => {
          const date = new Date(dateKey);
          return [
            dateKey,
            date.toLocaleDateString('en-GB', { weekday: 'long' }),
            data.status,
            data.contracted ? 'Yes' : 'No',
            date.toLocaleDateString('en-GB', { month: 'long' })
          ];
        });

      // Add summary rows at bottom
      const counts = calculateCounts();
      const summaryRows = [
        [],  // Empty row
        ['SUMMARY'],
        ['Total Belgium Days', counts.annualBelgium],
        ['Total Travel Days', counts.annualTravel],
        ['Total Spain Days', counts.annualSpain],
        ['Combined (Belgium + Travel)', counts.annualThreshold],
        ['183-day Threshold', counts.annualThreshold >= 183 ? 'EXCEEDED' : 'OK']
      ];

      const allRows = [headers, ...rows, ...summaryRows];
      return allRows.map(row => row.map(escapeCSVField).join(',')).join('\n');
    }

    /**
     * Download CSV file via Blob API
     * Creates temporary anchor element for download
     */
    function downloadCSV() {
      const csv = generateCSV();
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'belgium-calendar-2026.csv';
      document.body.appendChild(a);
      a.click();

      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ============================================================
    // CLIPBOARD COPY AND NOTIFICATION (Task 2)
    // ============================================================
    // Copy summary to clipboard with visual feedback notification
    // ============================================================

    /**
     * Show notification toast with auto-hide
     * @param {string} message - Message to display
     * @param {string} type - 'success' or 'error'
     */
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type}`;

      // Auto-hide after 3 seconds
      setTimeout(() => {
        notification.classList.add('hidden');
      }, 3000);
    }

    /**
     * Generate monthly breakdown text for summary
     * @returns {string} - Formatted monthly breakdown
     */
    function generateMonthlyBreakdown() {
      const months = ['Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const breakdown = [];

      for (let m = 1; m <= 11; m++) {  // Feb(1) to Dec(11) - 0-indexed months
        let belgium = 0, travel = 0, spain = 0;

        Object.entries(calendarState.days).forEach(([dateKey, data]) => {
          const month = parseInt(dateKey.split('-')[1], 10) - 1;  // Convert to 0-indexed
          if (month === m) {
            if (data.status === 'belgium') belgium++;
            else if (data.status === 'travel') travel++;
            else if (data.status === 'spain') spain++;
          }
        });

        if (belgium + travel + spain > 0) {
          breakdown.push(`  ${months[m - 1]}: ${belgium} BE, ${travel} Travel, ${spain} ES`);
        }
      }

      return breakdown.length > 0 ? breakdown.join('\n') : '  No days marked yet';
    }

    /**
     * Copy calendar summary to clipboard
     * Shows notification on success/failure
     */
    async function copyToClipboard() {
      const counts = calculateCounts();
      const warningLevel = getWarningLevel(counts.annualThreshold);
      const warningText = warningLevel
        ? `\nWARNING: ${counts.annualThreshold >= 183 ? 'THRESHOLD EXCEEDED' : 'Approaching threshold'}`
        : '';

      const summary = `Belgium Calendar 2026 Summary
============================
Total Belgium days: ${counts.annualBelgium}
Total Travel days: ${counts.annualTravel}
Total Spain days: ${counts.annualSpain}
Combined (Belgium + Travel): ${counts.annualThreshold}
183-day threshold status: ${counts.annualThreshold >= 183 ? 'EXCEEDED' : 'OK'}${warningText}

Monthly Breakdown:
${generateMonthlyBreakdown()}

Note: Entry and exit days may count in BOTH Belgium and Spain.
Generated by Autonomo Tax Calculator`;

      try {
        await navigator.clipboard.writeText(summary);
        showNotification('Summary copied to clipboard!');
      } catch (err) {
        console.error('Clipboard write failed:', err);
        showNotification('Copy failed - please try again', 'error');
      }
    }

    const SOURCES = Object.freeze({
      IRPF_BRACKETS: {
        name: "IRPF Tramos 2025",
        source: "AEAT / Wolters Kluwer",
        url: "https://www.wolterskluwer.com/es-es/expert-insights/tramos-retenciones-irpf-2025-novedades",
        note: "Unchanged from 2024. Combined estatal + autonomica rates.",
        confidence: "HIGH"
      },
      MINIMO_PERSONAL: {
        name: "Minimo del Contribuyente",
        source: "AEAT Manual Practico IRPF 2024",
        url: "https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2024/c14-adecuacion-impuesto-circunstancias-personales/cuadro-resumen-minimo-personal-familiar.html",
        note: "5,550 EUR for all taxpayers regardless of age.",
        confidence: "HIGH"
      },
      MINIMO_DESCENDIENTES: {
        name: "Minimo por Descendientes",
        source: "AEAT",
        url: "https://sede.agenciatributaria.gob.es/Sede/ciudadanos-familias-personas-discapacidad/minimo-personal-familiar/minimo-descendientes.html",
        note: "2,400 EUR for first child. Add 2,800 EUR if under 3 years old.",
        confidence: "HIGH"
      },
      RETA: {
        name: "Cuota RETA",
        source: "User registration document / BOE",
        url: "https://www.boe.es/diario_boe/txt.php?id=BOE-A-2025-3780",
        note: "Fixed cuota 428.40 EUR/month from autonomo registration.",
        confidence: "HIGH"
      },
      GASTOS_DIFICIL: {
        name: "Gastos de Dificil Justificacion",
        source: "AEAT Estimacion Directa Simplificada",
        url: "https://sede.agenciatributaria.gob.es/Sede/irpf/empresarios-individuales-profesionales/regimenes-determinar-rendimiento-actividad/estimacion-directa-simplificada.html",
        note: "5% of rendimiento neto, maximum 2,000 EUR/year. Was 7% only in 2023.",
        confidence: "HIGH"
      },
      MINIMO_APPLICATION: {
        name: "4-Phase Minimo Method",
        source: "AEAT Cuotas Integras Example",
        url: "https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2022/c15-calculo-impuesto-determinacion-cuotas-integras/ejemplo-practico-calculo-cuotas-integras-autonomica.html",
        note: "Minimos reduce TAX LIABILITY, not taxable base. Tax on minimo is subtracted from tax on full base.",
        confidence: "HIGH"
      },
      DIETAS: {
        name: "Dietas y Asignaciones para Gastos de Viaje",
        source: "Reglamento IRPF Art. 9",
        url: "https://www.boe.es/buscar/act.php?id=BOE-A-2007-6820&tn=1&p=20231228#a9",
        note: "Abroad: 91.35 EUR/day with overnight, 48.08 EUR without. Spain: 53.34 EUR/day with overnight, 26.67 EUR without.",
        confidence: "HIGH"
      }
    });

    // ===========================================
    // PHASE 8: OFFICIAL SOURCES (ENH-03, ENH-04, ENH-05)
    // ===========================================
    // Verified URLs to official AEAT, BOE, and Seguridad Social pages
    // All links verified 2026-02-02
    // ===========================================

    const OFFICIAL_SOURCES = Object.freeze({
      // IRPF General
      AEAT_IRPF: {
        name: 'IRPF - Agencia Tributaria',
        url: 'https://sede.agenciatributaria.gob.es/Sede/irpf.html',
        description: 'Main IRPF information page'
      },

      // Autonomo Specific
      AEAT_AUTONOMOS: {
        name: 'Empresarios y Profesionales - AEAT',
        url: 'https://sede.agenciatributaria.gob.es/Sede/empresarios-individuales-profesionales.html',
        description: 'Self-employed taxpayer information'
      },

      // Estimation Methods - Gastos Dificil
      AEAT_ESTIMACION_DIRECTA: {
        name: 'Estimacion Directa Simplificada - AEAT',
        url: 'https://sede.agenciatributaria.gob.es/Sede/irpf/empresarios-individuales-profesionales/regimenes-determinar-rendimiento-actividad/estimacion-directa-simplificada.html',
        description: '5% gastos de dificil justificacion, 2000 EUR limit'
      },

      // Minimo Personal
      AEAT_MINIMO_PERSONAL: {
        name: 'Minimo del Contribuyente - AEAT',
        url: 'https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2024/c14-adecuacion-impuesto-circunstancias-personales/cuadro-resumen-minimo-personal-familiar.html',
        description: '5,550 EUR personal allowance'
      },

      // Minimo Descendientes
      AEAT_MINIMO_DESCENDIENTES: {
        name: 'Minimo por Descendientes - AEAT',
        url: 'https://sede.agenciatributaria.gob.es/Sede/ciudadanos-familias-personas-discapacidad/minimo-personal-familiar/minimo-descendientes.html',
        description: '2,400 EUR for first child'
      },

      // RETA Cotizacion
      RETA_COTIZACION: {
        name: 'Sistema de Cotizacion Autonomos - AEAT',
        url: 'https://sede.agenciatributaria.gob.es/Sede/empresarios-individuales-profesionales/nuevo-sistema-cotizacion-autonomos.html',
        description: 'RETA contribution system since 2023'
      },

      // Seguridad Social RETA
      SS_RETA: {
        name: 'Cotizacion Autonomos - Seg. Social',
        url: 'https://www.seg-social.es/wps/portal/wss/internet/Trabajadores/CotizacionRecaudacionTrabajadores/10721/10724/1320',
        description: 'Official RETA contribution rates'
      },

      // Dietas
      AEAT_DIETAS: {
        name: 'Dietas y Gastos de Viaje - AEAT',
        url: 'https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-ayuda-presentacion/irpf-2023/7-cumplimentacion-irpf/7_1-rendimientos-trabajo-personal/7_1_1-rendimientos-integros/7_1_1_2-dietas-gastos-viaje/asignaciones-gastos-manutencion-estancia.html',
        description: '91.35 EUR/day abroad with overnight'
      },

      // Reglamento IRPF - Dietas Article
      BOE_REGLAMENTO_IRPF: {
        name: 'Reglamento IRPF Art. 9 - BOE',
        url: 'https://www.boe.es/buscar/act.php?id=BOE-A-2007-6820&tn=1&p=20231228#a9',
        description: 'Official dietas limits regulation'
      },

      // Spain-Belgium Treaty
      BOE_TREATY: {
        name: 'Convenio Espana-Belgica - BOE',
        url: 'https://www.boe.es/buscar/act.php?id=BOE-A-2003-13375',
        description: 'Double taxation treaty (BOE-A-2003-13375)'
      },

      // AEAT Treaty Page for Belgium
      AEAT_TREATY_BELGIUM: {
        name: 'CDI Belgica - AEAT',
        url: 'https://sede.agenciatributaria.gob.es/Sede/normativa-criterios-interpretativos/fiscalidad-internacional/convenios-doble-imposicion-firmados-espana/belgica.html',
        description: 'AEAT treaty information page for Belgium'
      },

      // LIRPF - Tax Residence Definition
      BOE_LIRPF: {
        name: 'Ley IRPF Art. 9 - BOE',
        url: 'https://www.boe.es/buscar/act.php?id=BOE-A-2006-20764&p=20240101&tn=1#a9',
        description: 'Tax residence definition (183-day rule, family presumption)'
      },

      // Factura Requirements
      AEAT_FACTURACION: {
        name: 'Obligaciones de Facturacion - AEAT',
        url: 'https://sede.agenciatributaria.gob.es/Sede/empresarios-individuales-profesionales/obligacion-facturacion.html',
        description: 'Invoice requirements for autonomos'
      }
    });

    /**
     * Render external link with icon (Phase 8: ENH-03/04/05)
     * @param {string} sourceKey - Key from OFFICIAL_SOURCES
     * @returns {string} - HTML anchor element
     */
    function renderSourceLink(sourceKey) {
      const s = OFFICIAL_SOURCES[sourceKey];
      if (!s) {
        console.warn('Unknown source key:', sourceKey);
        return '';
      }

      return `<a href="${s.url}" target="_blank" rel="noopener noreferrer"
                 class="official-source-link" title="${s.description}">
        ${s.name} <span class="external-link-icon">&#8599;</span>
      </a>`;
    }

    /**
     * Render inline source citation (Phase 8: ENH-03/04/05)
     * @param {string} sourceKey - Key from OFFICIAL_SOURCES
     * @param {string} label - Optional custom label
     * @returns {string} - HTML anchor element for inline use
     */
    function renderInlineSource(sourceKey, label = null) {
      const s = OFFICIAL_SOURCES[sourceKey];
      if (!s) return '';

      const displayLabel = label || s.name;
      return `<a href="${s.url}" target="_blank" rel="noopener noreferrer"
                 class="inline-source-link" title="${s.description}">
        ${displayLabel}<span class="external-link-icon">&#8599;</span>
      </a>`;
    }

    // ===========================================
    // PHASE 8: DEDUCTIBLE EXPENSE AUTO-DETECTION (ENH-01)
    // ===========================================
    // Keyword patterns for detecting 100% deductible IT/consulting expenses
    // HIGH confidence: auto-fill 100%, MEDIUM: suggest but don't auto-fill
    // ===========================================

    const DEDUCTIBLE_100_CATEGORIES = Object.freeze({
      keywords: [
        // Software (HIGH confidence)
        { pattern: /\b(software|licencia|subscription|suscripcion)\b/i, category: 'Software', confidence: 'HIGH' },
        { pattern: /\b(adobe|microsoft 365|google workspace|slack|notion|github|jira|figma|jetbrains)\b/i, category: 'Software', confidence: 'HIGH' },

        // Cloud/Hosting (HIGH confidence)
        { pattern: /\b(hosting|domain|dominio|servidor|server|cloud|aws|azure|gcp|heroku|vercel|netlify)\b/i, category: 'Cloud/Hosting', confidence: 'HIGH' },

        // Equipment (HIGH confidence)
        { pattern: /\b(ordenador|computer|laptop|macbook|monitor|pantalla)\b/i, category: 'Equipment', confidence: 'HIGH' },
        { pattern: /\b(teclado|keyboard|raton|mouse|webcam|camara|microfono|auriculares|headphones)\b/i, category: 'Equipment', confidence: 'HIGH' },

        // Professional Services (HIGH confidence)
        { pattern: /\b(gestor|gestoria|asesor|asesoria|accountant|contable|abogado|lawyer|notario)\b/i, category: 'Professional Services', confidence: 'HIGH' },

        // Training (HIGH confidence)
        { pattern: /\b(curso|course|formacion|training|certificacion|certification|udemy|coursera|pluralsight)\b/i, category: 'Training', confidence: 'HIGH' },

        // Marketing (HIGH confidence)
        { pattern: /\b(marketing|publicidad|advertising|google ads|facebook ads|linkedin)\b/i, category: 'Marketing', confidence: 'HIGH' },

        // Workspace (MEDIUM confidence)
        { pattern: /\b(coworking|oficina|office)\b/i, category: 'Workspace', confidence: 'MEDIUM' }
      ],

      detect(name) {
        for (const rule of this.keywords) {
          if (rule.pattern.test(name)) {
            return { suggested: true, category: rule.category, confidence: rule.confidence };
          }
        }
        return { suggested: false, category: null, confidence: null };
      }
    });

    /**
     * Detect if expense name matches a 100% deductible category (ENH-01)
     * @param {string} name - Expense name to check
     * @returns {object} - Detection result with suggested, category, confidence
     */
    function detectDeductibleCategory(name) {
      return DEDUCTIBLE_100_CATEGORIES.detect(name);
    }

    // ===========================================
    // PHASE 7: COMPLIANCE CONSTANTS
    // ===========================================

    const DIETAS_LIMITS = Object.freeze({
      spain: {
        withOvernight: 53.34,
        withoutOvernight: 26.67
      },
      abroad: {
        withOvernight: 91.35,
        withoutOvernight: 48.08
      },
      source: 'Art. 9 Reglamento IRPF (RD 439/2007)'
    });

    const TREATY_ARTICLE_4 = Object.freeze({
      title: 'Article 4: Tax Residence Tie-Breaker',
      source: 'Spain-Belgium Tax Treaty (BOE-A-2003-13375)',
      steps: [
        {
          name: 'Permanent Home',
          legal: 'vivienda permanente a su disposicion',
          plain: 'The country where you have a permanent home available to you. If only in one country, that country is your tax residence.'
        },
        {
          name: 'Center of Vital Interests',
          legal: 'centro de intereses vitales - relaciones personales y economicas mas estrechas',
          plain: 'If permanent homes in both countries: where your personal ties (family, social life) and economic ties (work, assets) are strongest. Family location receives special weight per OECD Commentary.'
        },
        {
          name: 'Habitual Abode',
          legal: 'viva habitualmente',
          plain: 'If center cannot be determined: the country where you spend more time overall.'
        },
        {
          name: 'Nationality',
          legal: 'nacional',
          plain: 'If habitual abode is equal: the country of your citizenship.'
        },
        {
          name: 'Mutual Agreement',
          legal: 'autoridades competentes resolveran de comun acuerdo',
          plain: 'If dual national or none: tax authorities of both countries negotiate.'
        }
      ]
    });

    const ARTICLE_9_1_B = Object.freeze({
      title: 'Art. 9.1.b LIRPF: Family Presumption',
      source: 'Ley 35/2006, Art. 9.1.b (BOE-A-2006-20764)',
      legalText: 'Se presumira, salvo prueba en contrario, que el contribuyente tiene su residencia habitual en territorio espanol cuando, de acuerdo con los criterios anteriores, resida habitualmente en Espana el conyuge no separado legalmente y los hijos menores de edad que dependan de aquel.',
      plainSummary: 'If your non-legally-separated spouse AND/OR dependent minor children habitually reside in Spain, Spanish law PRESUMES you are also a Spanish tax resident. This presumption is "rebuttable" (can be challenged), but the burden of proof shifts to you to demonstrate your tax residence is elsewhere.',
      implication: 'For a person with family in Spain, this presumption operates in your FAVOR when another country might claim tax residency. Spain starts from the position that you are Spanish resident based on family ties, making it easier to defend Spanish tax residence under treaty tie-breaker rules.'
    });

    const FACTURA_REQUIREMENTS = Object.freeze({
      title: 'Factura Completa Requirements',
      source: 'AEAT - Reglamento de Facturacion',
      required: [
        { field: 'Numero de factura', description: 'Sequential invoice number' },
        { field: 'Fecha de emision', description: 'Issue date' },
        { field: 'NIF del emisor', description: 'Supplier tax ID' },
        { field: 'Nombre/Razon social emisor', description: 'Supplier name or company' },
        { field: 'Domicilio fiscal emisor', description: 'Supplier address' },
        { field: 'NIF del destinatario', description: 'YOUR tax ID (autonomo NIF)' },
        { field: 'Nombre destinatario', description: 'YOUR name' },
        { field: 'Domicilio fiscal destinatario', description: 'YOUR fiscal address' },
        { field: 'Descripcion', description: 'Description of goods/services' },
        { field: 'Base imponible', description: 'Taxable amount before IVA' },
        { field: 'Tipo de IVA', description: 'IVA rate (if applicable)' },
        { field: 'Cuota de IVA', description: 'IVA amount' },
        { field: 'Total', description: 'Total amount' }
      ],
      notValid: [
        { type: 'Ticket/Receipt', reason: 'Missing recipient identification' },
        { type: 'Factura simplificada', reason: 'Lacks full recipient data for IRPF deduction' },
        { type: 'Bank statement alone', reason: 'Not proof of business expense' },
        { type: 'Airbnb confirmation email', reason: 'Not a valid tax invoice' }
      ]
    });

    // ============================================================
    // PHASE 7: DISCLAIMER CONSTANT
    // ============================================================

    const DISCLAIMER = Object.freeze({
      title: 'Disclaimer',
      text: 'This calculator provides estimates for informational and educational purposes only. It does not constitute tax, legal, or financial advice. Tax laws are complex, subject to change, and vary by individual circumstances. Your actual tax liability may differ from these estimates. Always consult with a qualified tax professional (asesor fiscal, gestor) for guidance specific to your situation before making any financial decisions or filing tax returns.',
      shortVersion: 'For informational purposes only. Consult a qualified tax professional for advice specific to your situation.'
    });

    // ============================================================
    // TOOLTIPS (UI-09)
    // ============================================================
    // Accessible tooltip definitions for technical tax terms
    // ============================================================

    const TOOLTIPS = Object.freeze({
      irpf: {
        title: 'IRPF (Impuesto sobre la Renta)',
        text: 'Spanish personal income tax. Progressive rates from 19% to 47% based on taxable income brackets.'
      },
      reta: {
        title: 'RETA (Regimen Especial)',
        text: 'Spanish social security contribution for self-employed. Fixed monthly quota (cuota) based on income tramo.'
      },
      minimo: {
        title: 'Minimo Personal',
        text: 'Tax-free personal allowance (5,550 EUR). Reduces the tax owed, not the taxable base.'
      },
      descendientes: {
        title: 'Minimo por Descendientes',
        text: 'Child allowance (2,400 EUR for first child). Reduces tax liability after rate application.'
      },
      gastos: {
        title: 'Gastos de Dificil Justificacion',
        text: '5% deduction on net income for hard-to-document expenses. Capped at 2,000 EUR annually.'
      },
      leefgeld: {
        title: 'Disposable Income',
        text: 'Money remaining after all taxes AND private living costs. Your true take-home pay.'
      },
      dietas: {
        title: 'Dietas (Per Diem)',
        text: 'Tax-exempt daily allowance for work travel. Belgium: 91.35 EUR with overnight stay.'
      },
      treaty: {
        title: 'Spain-Belgium Tax Treaty',
        text: 'Bilateral agreement preventing double taxation. Article 4 defines tax residency rules.'
      }
    });

    /**
     * Create clickable tooltip trigger that opens modal
     * @param {string} term - Key from TOOLTIPS constant
     * @param {string} displayText - Text to display as trigger
     * @returns {string} - HTML with click trigger or just displayText if term not found
     */
    function createTooltip(term, displayText) {
      const tooltip = TOOLTIPS[term];
      if (!tooltip) return displayText;

      // Escape quotes for inline handlers
      const title = tooltip.title.replace(/'/g, "\\'").replace(/"/g, '&quot;');
      const text = tooltip.text.replace(/'/g, "\\'").replace(/"/g, '&quot;');

      return `<span class="term-tooltip-trigger" tabindex="0"
        onclick="openTooltipModal('${title}', '${text}')"
        onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openTooltipModal('${title}', '${text}')}"
        role="button"
        aria-label="Learn more about ${tooltip.title}">
        ${displayText}<span class="info-icon">i</span>
      </span>`;
    }

    /**
     * Open tooltip modal with title and text
     * @param {string} title - Modal title
     * @param {string} text - Modal body text
     */
    function openTooltipModal(title, text) {
      const dialog = document.getElementById('tooltipModal');
      if (!dialog) return;

      document.getElementById('tooltipModalTitle').textContent = title;
      document.getElementById('tooltipModalText').textContent = text;
      dialog.showModal();
    }

    /**
     * Close tooltip modal
     */
    function closeTooltipModal() {
      const dialog = document.getElementById('tooltipModal');
      if (dialog) dialog.close();
    }

    // ============================================================
    // EXPENSE DATA CONSTANTS
    // ============================================================
    // Pre-filled expense data for Spain deductible, Belgium costs, and private
    // All amounts from CLAUDE.md Fixed Costs section
    // ============================================================

    const DEFAULT_EXPENSES = Object.freeze({
      version: 1,
      categories: Object.freeze({
        spainDeductible: Object.freeze([
          Object.freeze({ id: 'huur', name: 'Rent (30% deductible)', baseAmount: 1155, deductionPct: 30, deletable: true }),
          Object.freeze({ id: 'gsm', name: 'Mobile (50% deductible)', baseAmount: 55, deductionPct: 50, deletable: true }),
          Object.freeze({ id: 'elektriciteit', name: 'Electricity (9% deductible)', baseAmount: 100, deductionPct: 9, deletable: true })
        ]),
        workTravel: Object.freeze([
          Object.freeze({ id: 'belgium-travel-low', name: 'Belgium Travel (Standard)', amount: 1000, description: '3 days, 1 flight (Mon-Wed pattern)', deletable: true }),
          Object.freeze({ id: 'belgium-travel-high', name: 'Belgium Travel (Extended)', amount: 2500, description: '17 days, 4 flights (full week pattern)', deletable: true })
        ]),
        private: Object.freeze([
          Object.freeze({ id: 'huur-private', name: 'Rent (70% private)', amount: 808.50, deletable: true }),
          Object.freeze({ id: 'gsm-private', name: 'Mobile (50% private)', amount: 27.50, deletable: true }),
          Object.freeze({ id: 'elektriciteit-private', name: 'Electricity (91% private)', amount: 91, deletable: true }),
          Object.freeze({ id: 'auto', name: 'Car', amount: 600, deletable: true }),
          Object.freeze({ id: 'verzekeringen', name: 'Insurance', amount: 200, deletable: true })
        ])
      })
    });

    // ============================================================
    // LOCALSTORAGE PERSISTENCE
    // ============================================================
    // Expense data persists between browser sessions
    // Graceful fallback for Safari private mode and quota errors
    // ============================================================

    const STORAGE_KEY = 'autonomo_expenses_v1';

    /**
     * Migrate old expense data format to new work-travel structure
     * Converts belgiumPattern + belgiumCosts to workTravel category
     * @param {object} data - Expense data object
     * @returns {object} - Migrated expense data
     */
    function migrateExpenseData(data) {
      // Migrate old belgiumPattern to new work-travel expenses
      if (data.belgiumPattern !== undefined || data.categories.belgiumCosts !== undefined) {
        const amount = data.belgiumPattern === 'high' ? 2500 : 1000;

        // Create workTravel category from old data
        if (!data.categories.workTravel) {
          data.categories.workTravel = [
            { id: 'belgium-travel-migrated', name: 'Belgium Travel', amount: amount,
              description: 'Migrated from pattern', deletable: true }
          ];
        }

        // Remove old belgiumCosts category and belgiumPattern
        delete data.categories.belgiumCosts;
        delete data.belgiumPattern;

        console.log('Migrated expense data from belgiumPattern to workTravel');
      }

      return data;
    }

    /**
     * Load expenses from localStorage
     * Falls back to DEFAULT_EXPENSES on error or invalid data
     * @returns {object} - Expense data object (mutable clone)
     */
    function loadExpenses() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);
          // Version check for future migration support
          if (parsed && parsed.version === 1) {
            // Apply migration for old data format
            return migrateExpenseData(parsed);
          }
        }
      } catch (e) {
        console.warn('localStorage load failed (Safari private mode?):', e.message);
      }
      // Return mutable clone of defaults
      return structuredClone(DEFAULT_EXPENSES);
    }

    /**
     * Save expenses to localStorage
     * Handles QuotaExceededError gracefully
     * @returns {boolean} - True if save succeeded
     */
    function saveExpenses() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(expenseData));
        return true;
      } catch (e) {
        if (e.name === 'QuotaExceededError') {
          console.warn('localStorage quota exceeded - changes not persisted');
        } else {
          console.warn('localStorage save failed:', e.message);
        }
        return false;
      }
    }

    // Global expense data - initialized from localStorage or defaults
    let expenseData = loadExpenses();

    // ============================================================
    // INCOME DATA MANAGEMENT (Phase 8 - ENH-02)
    // ============================================================
    // Track client income entries with localStorage persistence
    // ============================================================

    const INCOME_STORAGE_KEY = 'autonomo_income_v1';

    const DEFAULT_INCOME = Object.freeze({
      version: 1,
      entries: []
    });

    /**
     * Load income data from localStorage
     * @returns {Array} - Array of income entries
     */
    function loadIncomeData() {
      try {
        const stored = localStorage.getItem(INCOME_STORAGE_KEY);
        if (stored) {
          const data = JSON.parse(stored);
          return data.entries || [];
        }
      } catch (e) {
        console.error('Error loading income data:', e);
      }
      return [];
    }

    /**
     * Save income data to localStorage
     * @param {Array} entries - Array of income entries
     */
    function saveIncomeData(entries) {
      localStorage.setItem(INCOME_STORAGE_KEY, JSON.stringify({
        version: 1,
        entries: entries
      }));
    }

    /**
     * Open income dialog for add or edit
     * @param {string|null} editId - Entry ID to edit, or null for new entry
     */
    function openIncomeDialog(editId = null) {
      const dialog = document.getElementById('incomeDialog');
      const form = document.getElementById('incomeForm');
      const title = document.getElementById('incomeDialogTitle');
      const editIdInput = document.getElementById('incomeEditId');

      form.reset();

      if (editId) {
        title.textContent = 'Edit Income Entry';
        const entries = loadIncomeData();
        const entry = entries.find(e => e.id === editId);
        if (entry) {
          document.getElementById('incomeClient').value = entry.clientName || '';
          document.getElementById('incomeInvoice').value = entry.invoiceNumber || '';
          document.getElementById('incomeAmount').value = entry.amount || '';
          document.getElementById('incomeDateInvoiced').value = entry.dateInvoiced || '';
          document.getElementById('incomeDateReceived').value = entry.dateReceived || '';
          document.getElementById('incomeDescription').value = entry.description || '';
          document.getElementById('incomeStatus').value = entry.status || 'paid';
          editIdInput.value = editId;
        }
      } else {
        title.textContent = 'Add Income Entry';
        editIdInput.value = '';
        // Set default date to today
        document.getElementById('incomeDateReceived').value = new Date().toISOString().split('T')[0];
      }

      dialog.showModal();
    }

    /**
     * Close income dialog
     */
    function closeIncomeDialog() {
      document.getElementById('incomeDialog').close();
    }

    /**
     * Save income entry from form
     * @param {Event} event - Form submit event
     */
    function saveIncomeEntry(event) {
      event.preventDefault();
      const form = event.target;
      const editId = form.editId.value;

      const entry = {
        id: editId || 'income-' + Date.now(),
        clientName: form.clientName.value.trim(),
        invoiceNumber: form.invoiceNumber.value.trim(),
        amount: parseFloat(form.amount.value) || 0,
        dateInvoiced: form.dateInvoiced.value,
        dateReceived: form.dateReceived.value,
        description: form.description.value.trim(),
        status: form.status.value
      };

      let entries = loadIncomeData();

      if (editId) {
        const index = entries.findIndex(e => e.id === editId);
        if (index !== -1) {
          entries[index] = entry;
        }
      } else {
        entries.push(entry);
      }

      saveIncomeData(entries);
      closeIncomeDialog();
      renderIncomeList();
    }

    /**
     * Delete income entry by ID
     * @param {string} id - Entry ID to delete
     */
    function deleteIncomeEntry(id) {
      if (!confirm('Delete this income entry?')) return;

      let entries = loadIncomeData();
      entries = entries.filter(e => e.id !== id);
      saveIncomeData(entries);
      renderIncomeList();
    }

    /**
     * Escape HTML to prevent XSS
     * @param {string} text - Raw text to escape
     * @returns {string} - Escaped HTML
     */
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    /**
     * Render income list with filtering and sorting
     */
    function renderIncomeList() {
      const container = document.getElementById('incomeList');
      const totalDisplay = document.getElementById('incomeTotalDisplay');
      const countDisplay = document.getElementById('incomeCountDisplay');
      const sortBy = document.getElementById('incomeSortBy').value;
      const filterText = document.getElementById('incomeFilterText').value.toLowerCase().trim();

      let entries = loadIncomeData();

      // Calculate total from ALL entries (before filtering)
      const allEntries = loadIncomeData();
      const total = allEntries.reduce((sum, e) => sum + (e.amount || 0), 0);
      totalDisplay.textContent = total.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' EUR';
      countDisplay.textContent = allEntries.length;

      // Filter
      if (filterText) {
        entries = entries.filter(e =>
          (e.clientName && e.clientName.toLowerCase().includes(filterText)) ||
          (e.invoiceNumber && e.invoiceNumber.toLowerCase().includes(filterText))
        );
      }

      // Sort
      entries.sort((a, b) => {
        switch (sortBy) {
          case 'date-desc':
            return new Date(b.dateReceived) - new Date(a.dateReceived);
          case 'date-asc':
            return new Date(a.dateReceived) - new Date(b.dateReceived);
          case 'amount-desc':
            return b.amount - a.amount;
          case 'amount-asc':
            return a.amount - b.amount;
          case 'client-asc':
            return (a.clientName || '').localeCompare(b.clientName || '');
          default:
            return 0;
        }
      });

      // Render empty state
      if (entries.length === 0) {
        if (filterText) {
          container.innerHTML = '<div class="income-empty">No entries match your filter.</div>';
        } else {
          container.innerHTML = '<div class="income-empty">No income entries yet. Click "+ Add Income" to start tracking.</div>';
        }
        return;
      }

      // Status colors
      const statusColors = {
        paid: 'var(--accent)',
        pending: 'var(--warning)',
        overdue: 'var(--negative)'
      };

      // Render entries
      container.innerHTML = entries.map(entry => {
        const dateDisplay = entry.dateReceived ? new Date(entry.dateReceived).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : '-';
        const statusColor = statusColors[entry.status] || 'var(--text-muted)';

        return `
          <div class="income-entry">
            <div class="income-entry-info">
              <span class="income-client">${escapeHtml(entry.clientName)}</span>
              <div class="income-details">
                ${entry.invoiceNumber ? `<span>Invoice: ${escapeHtml(entry.invoiceNumber)}</span>` : ''}
                <span>Received: ${dateDisplay}</span>
                <span style="color: ${statusColor}; text-transform: capitalize;">${entry.status}</span>
              </div>
              ${entry.description ? `<div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">${escapeHtml(entry.description)}</div>` : ''}
            </div>
            <div class="income-amount">${entry.amount.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} EUR</div>
            <div class="income-actions">
              <button type="button" onclick="openIncomeDialog('${entry.id}')">Edit</button>
              <button type="button" class="delete-btn" onclick="deleteIncomeEntry('${entry.id}')">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // ============================================================
    // SCENARIO PRESETS
    // ============================================================
    // Pre-configured scenarios (A-E) from CLAUDE.md
    // Values: A(3K), B(6K), C(9K), D(12K), E(18K)
    // Belgium patterns: A/B use 'low' (1K), C/D/E use 'high' (2.5K)
    // ============================================================

    const SCENARIO_PRESETS = Object.freeze({
      'A': Object.freeze({
        id: 'A',
        name: 'Scenario A',
        isPreset: true,
        monthlyRevenue: 3000,
        monthlyExpenses: 750,
        workTravelCost: 1000,  // Standard pattern: 3 days, 1 flight
        hasDescendant: true,
        fiscalOverrides: null
      }),
      'B': Object.freeze({
        id: 'B',
        name: 'Scenario B',
        isPreset: true,
        monthlyRevenue: 6000,
        monthlyExpenses: 1500,
        workTravelCost: 1000,  // Standard pattern
        hasDescendant: true,
        fiscalOverrides: null
      }),
      'C': Object.freeze({
        id: 'C',
        name: 'Scenario C',
        isPreset: true,
        monthlyRevenue: 9000,
        monthlyExpenses: 3000,
        workTravelCost: 2500,  // Extended pattern: 17 days, 4 flights
        hasDescendant: true,
        fiscalOverrides: null
      }),
      'D': Object.freeze({
        id: 'D',
        name: 'Scenario D',
        isPreset: true,
        monthlyRevenue: 12000,
        monthlyExpenses: 5000,
        workTravelCost: 2500,  // Extended pattern
        hasDescendant: true,
        fiscalOverrides: null
      }),
      'E': Object.freeze({
        id: 'E',
        name: 'Scenario E',
        isPreset: true,
        monthlyRevenue: 18000,
        monthlyExpenses: 8000,
        workTravelCost: 2500,  // Extended pattern
        hasDescendant: true,
        fiscalOverrides: null
      })
    });

    // ============================================================
    // SCENARIO STATE MANAGEMENT
    // ============================================================
    // Centralized state with localStorage persistence
    // ============================================================

    const SCENARIO_STORAGE_KEY = 'autonomo_scenarios_v1';

    // Scenario state - initialized on DOMContentLoaded
    let scenarioState = null;

    /**
     * Initialize scenario state from localStorage or defaults
     * @returns {object} - Scenario state object
     */
    function initScenarioState() {
      try {
        const stored = localStorage.getItem(SCENARIO_STORAGE_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);
          if (parsed.version === 1) {
            return parsed;
          }
        }
      } catch (e) {
        console.warn('Failed to load scenarios:', e.message);
      }
      // Return default state with presets
      return {
        version: 1,
        scenarios: structuredClone(SCENARIO_PRESETS),
        selected: [],
        customOrder: []
      };
    }

    /**
     * Save scenario state to localStorage
     * @returns {boolean} - True if save succeeded
     */
    function saveScenarioState() {
      try {
        localStorage.setItem(SCENARIO_STORAGE_KEY, JSON.stringify(scenarioState));
        return true;
      } catch (e) {
        console.warn('Failed to save scenarios:', e.message);
        return false;
      }
    }

    /**
     * Reset all scenarios to default presets
     * Removes any custom scenarios and restores A-E presets
     */
    function resetScenarios() {
      if (!confirm('Reset all scenarios to defaults? This will remove any custom scenarios and reset edits.')) {
        return;
      }

      // Clear from localStorage
      localStorage.removeItem(SCENARIO_STORAGE_KEY);

      // Reinitialize state from defaults
      scenarioState = {
        version: 1,
        scenarios: structuredClone(SCENARIO_PRESETS),
        selected: [],
        customOrder: []
      };

      // Re-render (recalculation happens automatically via getSortedScenarios())

      renderScenarioCards();
      renderComparisonTable();
    }

    // ============================================================
    // SCENARIO CALCULATION FUNCTIONS
    // ============================================================
    // Extends Phase 1 calculateFullIRPF with fiscal override support
    // ============================================================

    /**
     * Calculate full IRPF with optional fiscal configuration overrides
     * This is a copy of Phase 1's calculateFullIRPF but accepts a fiscal parameter
     * for what-if analysis (scenarios can override RETA, minimos, brackets)
     *
     * @param {number} monthlyRevenue - Gross monthly revenue in EUR
     * @param {number} monthlyDeductibleExpenses - Monthly deductible business expenses in EUR
     * @param {boolean} hasDescendant - Whether user has 1 dependent child
     * @param {object|null} fiscal - Optional fiscal config overrides (defaults to FISCAL_2025)
     * @returns {object} - Complete calculation breakdown
     */
    function calculateFullIRPFWithFiscal(monthlyRevenue, monthlyDeductibleExpenses = 0, hasDescendant = true, fiscal = null) {
      // Use provided fiscal config or default to FISCAL_2025
      const config = fiscal || FISCAL_2025;

      // Step 1: Annualize inputs
      const annualRevenue = monthlyRevenue * 12;
      const annualExpenses = monthlyDeductibleExpenses * 12;

      // Step 2: Total deductible = expenses + RETA
      const retaAnnual = config.RETA_ANNUAL || FISCAL_2025.RETA_ANNUAL;
      const totalDeductible = annualExpenses + retaAnnual;

      // Step 3: Rendimiento Neto Previo (before gastos dificil)
      const rendimientoNetoPrevio = annualRevenue - totalDeductible;

      // Step 4: Gastos dificil justificacion (use FISCAL_2025 rates - these don't change)
      const gastosDificil = calculateGastosDificil(rendimientoNetoPrevio);

      // Step 5: Rendimiento Neto = Base Liquidable (for autonomo)
      const rendimientoNeto = rendimientoNetoPrevio - gastosDificil;
      const baseLiquidable = Math.max(0, rendimientoNeto);

      // Step 6: Calculate minimos (can be overridden)
      const minimoPersonal = config.MINIMO_PERSONAL || FISCAL_2025.MINIMO_PERSONAL;
      const minimoDescendientes = hasDescendant
        ? (config.MINIMO_DESCENDIENTES_PRIMERO || FISCAL_2025.MINIMO_DESCENDIENTES_PRIMERO)
        : 0;
      const minimoTotal = minimoPersonal + minimoDescendientes;

      // Step 7: Cuota Integra using 4-phase method
      const cuotaIntegra = calculateCuotaIntegra(baseLiquidable, minimoTotal);

      // Step 8: Effective tax rate
      const effectiveRate = rendimientoNeto > 0 ? (cuotaIntegra / rendimientoNeto) : 0;

      // Step 9: Net income calculations
      const netAnnual = annualRevenue - totalDeductible - gastosDificil - cuotaIntegra;
      const netMonthly = netAnnual / 12;

      // Step 10: Leefgeld (after private costs)
      const privateCostsMonthly = config.PRIVATE_COSTS_MONTHLY || FISCAL_2025.PRIVATE_COSTS_MONTHLY;
      const leefgeld = netMonthly - privateCostsMonthly;

      const retaMonthly = config.RETA_MONTHLY || FISCAL_2025.RETA_MONTHLY;

      // Return all values matching Phase 1's calculateFullIRPF return structure
      return {
        // Inputs
        monthlyRevenue,
        annualRevenue,
        monthlyExpenses: monthlyDeductibleExpenses,
        annualExpenses,

        // Deductions
        retaMonthly,
        retaAnnual,
        totalDeductible,

        // Calculation chain
        rendimientoNetoPrevio,
        gastosDificil,
        rendimientoNeto,
        baseLiquidable,

        // Minimos (for display)
        minimoPersonal,
        minimoDescendientes,
        minimoTotal,

        // Tax
        cuotaIntegra,
        effectiveRate,

        // Net income
        netAnnual,
        netMonthly,
        leefgeld,

        // Private costs (for reference)
        privateCostsMonthly
      };
    }

    /**
     * Calculate results for a scenario
     * Wraps calculateFullIRPFWithFiscal with scenario-specific inputs
     *
     * @param {object} scenario - Scenario object
     * @returns {object} - Complete calculation results
     */
    function calculateScenarioResults(scenario) {
      const workTravelCost = getWorkTravelCost(scenario);
      const totalDeductible = scenario.monthlyExpenses + workTravelCost;

      // Allow fiscal overrides for what-if analysis
      const fiscal = scenario.fiscalOverrides
        ? { ...FISCAL_2025, ...scenario.fiscalOverrides }
        : FISCAL_2025;

      // Call calculateFullIRPFWithFiscal (derived from Phase 1's calculateFullIRPF)
      return calculateFullIRPFWithFiscal(
        scenario.monthlyRevenue,
        totalDeductible,
        scenario.hasDescendant,
        fiscal
      );
    }

    /**
     * Get work travel cost for a scenario
     * Supports both new workTravelCost property and legacy belgiumPattern
     * @param {object} scenario - Scenario object
     * @returns {number} - Monthly work travel cost
     */
    function getWorkTravelCost(scenario) {
      if (scenario.workTravelCost !== undefined) {
        return scenario.workTravelCost;
      }
      // Legacy support for old belgiumPattern
      return scenario.belgiumPattern === 'high' ? 2500 : 1000;
    }

    /**
     * Get all scenarios sorted by leefgeld (highest first)
     * Each scenario includes its calculated results
     *
     * @returns {array} - Array of scenarios with results, sorted by leefgeld descending
     */
    function getSortedScenarios() {
      const scenarios = Object.values(scenarioState.scenarios);
      return scenarios
        .map(s => ({
          ...s,
          results: calculateScenarioResults(s)
        }))
        .sort((a, b) => b.results.leefgeld - a.results.leefgeld);
    }

    // ============================================================
    // DEPRECATED: Belgium pattern toggle functions removed
    // Work travel expenses are now editable items like other categories
    // Migration function in loadExpenses() handles old localStorage data
    // ============================================================

    // ============================================================
    // EXPENSE DATA MANAGEMENT
    // ============================================================
    // Reset, calculation helpers, and totals for expense tracking
    // ============================================================

    /**
     * Reset all expenses to default values with confirmation
     * @returns {boolean} - True if reset occurred
     */
    function resetToDefaults() {
      if (confirm('Reset all expenses to default values? This cannot be undone.')) {
        expenseData = structuredClone(DEFAULT_EXPENSES);
        saveExpenses();
        renderAllSections();
        recalculateTotals();
        return true;
      }
      return false;
    }

    /**
     * Calculate deductible amount for an expense
     * Spain expenses have baseAmount * deductionPct; others use amount directly
     * @param {object} expense - Expense object
     * @returns {number} - Monthly deductible amount (rounded to 2 decimals)
     */
    function calculateDeductible(expense) {
      if (expense.baseAmount !== undefined && expense.deductionPct !== undefined) {
        return Math.round(expense.baseAmount * (expense.deductionPct / 100) * 100) / 100;
      }
      return Math.round((expense.amount || 0) * 100) / 100;
    }

    /**
     * Calculate total deductible for a category
     * @param {string} categoryKey - Key in expenseData.categories
     * @returns {number} - Total monthly amount (rounded to 2 decimals)
     */
    function calculateCategoryTotal(categoryKey) {
      const category = expenseData.categories[categoryKey];
      if (!category) return 0;

      const total = category.reduce((sum, exp) => sum + calculateDeductible(exp), 0);
      return Math.round(total * 100) / 100;
    }

    /**
     * Get all expense totals for integration with IRPF calculation
     * @returns {object} - Monthly and annual totals per category
     */
    function getExpenseTotals() {
      const spainMonthly = calculateCategoryTotal('spainDeductible');
      const workTravelMonthly = calculateCategoryTotal('workTravel');
      const privateMonthly = calculateCategoryTotal('private');

      return {
        spainDeductible: {
          monthly: spainMonthly,
          annual: Math.round(spainMonthly * 12 * 100) / 100
        },
        workTravel: {
          monthly: workTravelMonthly,
          annual: Math.round(workTravelMonthly * 12 * 100) / 100
        },
        private: {
          monthly: privateMonthly,
          annual: Math.round(privateMonthly * 12 * 100) / 100
        },
        totalDeductible: {
          monthly: Math.round((spainMonthly + workTravelMonthly) * 100) / 100,
          annual: Math.round((spainMonthly + workTravelMonthly) * 12 * 100) / 100
        }
      };
    }

    // ============================================================
    // EXPENSE SECTION RENDERING
    // ============================================================
    // Render expense sections with formulas, delete buttons, and totals
    // ============================================================

    /**
     * Format expense calculation formula for display
     * Shows transparent calculation: BASE x PERCENT% = RESULT
     * @param {object} expense - Expense object
     * @param {string} categoryKey - Category key for context
     * @returns {string} - Formatted formula string
     */
    function formatFormula(expense, categoryKey) {
      if (expense.baseAmount !== undefined && expense.deductionPct !== undefined) {
        // Spain deductible: show base x percent
        const result = expense.baseAmount * (expense.deductionPct / 100);
        return `${formatEUR(expense.baseAmount)} x ${expense.deductionPct}% = ${formatEUR(result)}`;
      } else if (categoryKey === 'private') {
        // Private: 0% deductible
        return `${formatEUR(expense.amount)} x 0% = ${formatEUR(0)}`;
      } else {
        // Belgium costs: 100% deductible
        return `${formatEUR(expense.amount)} x 100% = ${formatEUR(expense.amount)}`;
      }
    }

    /**
     * Render a single expense row with formula and delete button
     * @param {object} expense - Expense object
     * @param {string} categoryKey - Category key
     * @returns {string} - HTML string for expense row
     */
    function renderExpenseRow(expense, categoryKey) {
      const monthly = calculateDeductible(expense);
      const annual = Math.round(monthly * 12 * 100) / 100;

      return `
        <div class="expense-row" data-id="${expense.id}" data-category="${categoryKey}">
          <span class="expense-name">${expense.name}</span>
          <span class="expense-formula">${formatFormula(expense, categoryKey)}</span>
          <span class="expense-value">${formatEUR(monthly)}/month (${formatEUR(annual)}/year)</span>
          <div class="expense-actions">
            <button class="delete-btn" onclick="deleteExpense('${categoryKey}', '${expense.id}')" title="Delete">x</button>
          </div>
        </div>
      `;
    }

    /**
     * Render a complete expense section with header, rows, and add button
     * @param {string} categoryKey - Category key in expenseData.categories
     * @param {string} sectionClass - CSS class for section styling
     * @param {string} title - Section title
     * @returns {string} - HTML string for section
     */
    function renderExpenseSection(categoryKey, sectionClass, title) {
      const expenses = expenseData.categories[categoryKey] || [];
      const total = calculateCategoryTotal(categoryKey);
      const annual = Math.round(total * 12 * 100) / 100;

      // Render expense rows
      const rowsHtml = expenses.map(exp => renderExpenseRow(exp, categoryKey)).join('');

      return `
        <div class="expense-section ${sectionClass}">
          <div class="section-header">
            <span class="section-title">${title}</span>
            <span class="section-total">Total: ${formatEUR(total)}/month (${formatEUR(annual)}/year)</span>
          </div>
          <div class="expense-rows">
            ${rowsHtml}
          </div>
          <button class="add-expense-btn" onclick="showAddForm('${categoryKey}')">+ Add Expense</button>
        </div>
      `;
    }

    /**
     * Render all expense sections
     * Updates the DOM with current expense data
     */
    function renderAllSections() {
      const spainEl = document.getElementById('spainSection');
      const workTravelEl = document.getElementById('workTravelSection');
      const privateEl = document.getElementById('privateSection');

      if (spainEl) {
        spainEl.innerHTML = renderExpenseSection('spainDeductible', 'spain-deductible', 'Spain Deductible Expenses');
      }
      if (workTravelEl) {
        workTravelEl.innerHTML = renderExpenseSection('workTravel', 'work-travel', 'Work Travel Expenses');
      }
      if (privateEl) {
        privateEl.innerHTML = renderExpenseSection('private', 'private', 'Private Expenses (Not Deductible)');
      }
    }

    // ============================================================
    // ADD/DELETE EXPENSE FUNCTIONALITY
    // ============================================================
    // User can add new expenses and delete existing ones
    // Changes trigger IRPF recalculation
    // ============================================================

    /**
     * Add a new expense to a category
     * @param {string} categoryKey - Category key in expenseData.categories
     * @param {object} expense - Expense object to add
     */
    function addExpense(categoryKey, expense) {
      expense.id = expense.id || crypto.randomUUID();
      expense.deletable = true;
      expenseData.categories[categoryKey].push(expense);
      saveExpenses();
      renderAllSections();
      recalculateTotals();
    }

    /**
     * Delete an expense from a category
     * @param {string} categoryKey - Category key in expenseData.categories
     * @param {string} expenseId - ID of expense to delete
     */
    function deleteExpense(categoryKey, expenseId) {
      const category = expenseData.categories[categoryKey];
      const index = category.findIndex(e => e.id === expenseId);
      if (index !== -1) {
        category.splice(index, 1);
        saveExpenses();
        renderAllSections();
        recalculateTotals();
      }
    }

    /**
     * Show the add expense dialog as modal
     * @param {string} categoryKey - Category to pre-select
     */
    function showAddForm(categoryKey) {
      const dialog = document.getElementById('addExpenseDialog');
      if (dialog) {
        const categorySelect = document.getElementById('newExpCategory');
        if (categorySelect) {
          categorySelect.value = categoryKey;
          toggleDeductionField();
        }
        // Focus on name input after opening
        dialog.showModal();
        setTimeout(() => document.getElementById('newExpName').focus(), 50);
      }
    }

    /**
     * Hide the add expense dialog and clear values
     */
    function hideAddForm() {
      const dialog = document.getElementById('addExpenseDialog');
      if (dialog) {
        dialog.close();
        document.getElementById('newExpName').value = '';
        document.getElementById('newExpAmount').value = '';
        document.getElementById('newExpDeduction').value = '100';
        // Clear detection state (ENH-01)
        clearExpenseDetection();
      }
    }

    /**
     * Toggle visibility of deduction percentage field
     * Only shown for Spain Deductible expenses
     */
    function toggleDeductionField() {
      const category = document.getElementById('newExpCategory').value;
      const deductionRow = document.getElementById('deductionRow');
      if (deductionRow) {
        deductionRow.style.display = category === 'spainDeductible' ? 'block' : 'none';
      }
      // Clear detection when category changes (ENH-01)
      clearExpenseDetection();
      // Re-detect if name has content and switching to spainDeductible
      if (category === 'spainDeductible') {
        const name = document.getElementById('newExpName').value.trim();
        if (name) {
          handleExpenseNameInput(name);
        }
      }
    }

    // Track current detection state for expense form (ENH-01)
    let currentDetection = { suggested: false, category: null, confidence: null };
    let userOverrodeDetection = false;

    /**
     * Handle expense name input for auto-detection (ENH-01)
     * Only activates for Spain Deductible category
     * @param {string} name - Current expense name value
     */
    function handleExpenseNameInput(name) {
      const category = document.getElementById('newExpCategory').value;
      const badge = document.getElementById('detectionBadge');
      const deductionInput = document.getElementById('newExpDeduction');
      const hint = document.getElementById('deductionHint');

      // Only detect for Spain Deductible expenses
      if (category !== 'spainDeductible' || !badge) {
        clearExpenseDetection();
        return;
      }

      // Detect category
      const detection = detectDeductibleCategory(name);
      currentDetection = detection;

      if (detection.suggested) {
        // Show detection badge
        badge.style.display = 'inline-flex';

        if (detection.confidence === 'HIGH') {
          badge.className = 'detection-badge suggested';
          badge.textContent = '100% (suggested)';

          // Auto-fill 100% for HIGH confidence if user hasn't overridden
          if (!userOverrodeDetection && deductionInput) {
            deductionInput.value = 100;
          }
        } else {
          // MEDIUM confidence
          badge.className = 'detection-badge medium';
          badge.textContent = '100%?';
        }

        // Show hint about category
        if (hint) {
          hint.style.display = 'block';
          hint.textContent = `Detected: ${detection.category} - typically 100% business deductible`;
        }
      } else {
        clearExpenseDetection();
      }
    }

    /**
     * Handle deduction percentage change (ENH-01)
     * Shows confirmation when user overrides auto-detected value
     * @param {number} value - New deduction percentage
     */
    function handleDeductionChange(value) {
      const hint = document.getElementById('deductionHint');

      // Check if user is overriding an auto-detected 100%
      if (currentDetection.suggested && currentDetection.confidence === 'HIGH') {
        if (parseInt(value) !== 100) {
          userOverrodeDetection = true;
          if (hint) {
            hint.style.display = 'block';
            hint.textContent = `Note: ${currentDetection.category} expenses are typically 100% deductible`;
            hint.style.color = 'var(--warning)';
          }
        } else {
          userOverrodeDetection = false;
          if (hint) {
            hint.style.display = 'block';
            hint.textContent = `Detected: ${currentDetection.category} - typically 100% business deductible`;
            hint.style.color = '';
          }
        }
      }
    }

    /**
     * Clear expense detection state (ENH-01)
     */
    function clearExpenseDetection() {
      const badge = document.getElementById('detectionBadge');
      const hint = document.getElementById('deductionHint');

      if (badge) {
        badge.style.display = 'none';
        badge.textContent = '';
      }
      if (hint) {
        hint.style.display = 'none';
        hint.textContent = '';
        hint.style.color = '';
      }

      currentDetection = { suggested: false, category: null, confidence: null };
      userOverrodeDetection = false;
    }

    /**
     * Submit new expense from form
     * Validates input and adds to appropriate category
     */
    function submitNewExpense() {
      const name = document.getElementById('newExpName').value.trim();
      const amount = parseFloat(document.getElementById('newExpAmount').value) || 0;
      const category = document.getElementById('newExpCategory').value;
      const deduction = parseFloat(document.getElementById('newExpDeduction').value) || 100;

      // Validate
      if (!name) {
        alert('Please enter a name for the expense.');
        return;
      }
      if (amount < 0) {
        alert('Amount cannot be negative.');
        return;
      }

      let expense;
      if (category === 'spainDeductible') {
        expense = {
          name,
          baseAmount: amount,
          deductionPct: Math.min(100, Math.max(0, deduction))
        };
      } else {
        expense = { name, amount };
      }

      addExpense(category, expense);
      hideAddForm();
    }

    /**
     * Reset the What-If Calculator to default values
     */
    function resetDetailsForm() {
      const defaults = {
        monthlyRevenue: 6000,
        calcSpainDeductible: 383,
        calcWorkTravel: 1000,
        calcPrivateCosts: 1727,
        calcRetaMonthly: 428.40,
        calcMinimoPersonal: 5550,
        hasDescendant: true
      };

      Object.entries(defaults).forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (el) {
          if (el.type === 'checkbox') {
            el.checked = value;
          } else {
            el.value = value;
          }
        }
      });

      recalculateTotals();
    }

    /**
     * Save current What-If Calculator values as a new scenario
     */
    function saveAsScenario() {
      const monthlyRevenue = parseFloat(document.getElementById('monthlyRevenue')?.value) || 0;
      const spainDeductible = parseFloat(document.getElementById('calcSpainDeductible')?.value) || 0;
      const workTravel = parseFloat(document.getElementById('calcWorkTravel')?.value) || 0;
      const privateCosts = parseFloat(document.getElementById('calcPrivateCosts')?.value) || 0;
      const hasDescendant = document.getElementById('hasDescendant')?.checked ?? true;

      // Prompt for scenario name
      const name = prompt('Enter a name for this scenario:', `Custom (${formatEUR(monthlyRevenue)}/mo)`);
      if (!name) return;

      // Create new scenario
      const newScenario = {
        id: crypto.randomUUID(),
        name: name,
        monthlyRevenue: monthlyRevenue,
        monthlyExpenses: spainDeductible,
        workTravelCost: workTravel,
        hasDescendant: hasDescendant,
        isCustom: true
      };

      // Add to scenario state
      scenarioState.scenarios[newScenario.id] = newScenario;
      scenarioState.customOrder.push(newScenario.id);
      saveScenarioState();

      // Re-render scenarios
      renderScenarioCards();
      renderComparisonTable();

      // Notify user
      alert(`Scenario "${name}" saved! Switch to the Scenarios tab to view it.`);
    }

    /**
     * Recalculate totals and update IRPF results
     * Uses What-If Calculator inputs if available, falls back to expense data
     */
    function recalculateTotals() {
      // Get inputs - use calculator fields if they exist, otherwise use expense totals
      const monthlyRevenue = parseFloat(document.getElementById('monthlyRevenue')?.value) || 0;
      const hasDescendant = document.getElementById('hasDescendant')?.checked ?? true;

      // Calculator inputs (What-If mode)
      const calcSpainEl = document.getElementById('calcSpainDeductible');
      const calcTravelEl = document.getElementById('calcWorkTravel');
      const calcPrivateEl = document.getElementById('calcPrivateCosts');
      const calcRetaEl = document.getElementById('calcRetaMonthly');
      const calcMinimoEl = document.getElementById('calcMinimoPersonal');

      let spainDeductible, workTravel, privateCostsMonthly, retaMonthly, minimoPersonal;

      if (calcSpainEl && calcTravelEl && calcPrivateEl) {
        // Use calculator inputs
        spainDeductible = parseFloat(calcSpainEl.value) || 0;
        workTravel = parseFloat(calcTravelEl.value) || 0;
        privateCostsMonthly = parseFloat(calcPrivateEl.value) || 0;
        retaMonthly = calcRetaEl ? parseFloat(calcRetaEl.value) || FISCAL_2025.RETA_MONTHLY : FISCAL_2025.RETA_MONTHLY;
        minimoPersonal = calcMinimoEl ? parseFloat(calcMinimoEl.value) || FISCAL_2025.MINIMO_PERSONAL : FISCAL_2025.MINIMO_PERSONAL;
      } else {
        // Fallback to expense data totals
        const totals = getExpenseTotals();
        spainDeductible = totals.spainDeductible.monthly;
        workTravel = totals.workTravel.monthly;
        privateCostsMonthly = totals.private.monthly;
        retaMonthly = FISCAL_2025.RETA_MONTHLY;
        minimoPersonal = FISCAL_2025.MINIMO_PERSONAL;
      }

      const totalDeductible = spainDeductible + workTravel;

      // Create fiscal config with possible overrides
      const fiscalConfig = {
        ...FISCAL_2025,
        RETA_MONTHLY: retaMonthly,
        RETA_ANNUAL: retaMonthly * 12,
        MINIMO_PERSONAL: minimoPersonal
      };

      // Calculate IRPF with custom fiscal config
      const r = calculateFullIRPFWithConfig(monthlyRevenue, totalDeductible, hasDescendant, fiscalConfig);

      // Override with our calculated values for display
      const totals = {
        spainDeductible: { monthly: spainDeductible, annual: spainDeductible * 12 },
        workTravel: { monthly: workTravel, annual: workTravel * 12 },
        private: { monthly: privateCostsMonthly, annual: privateCostsMonthly * 12 }
      };

      const leefgeld = r.netMonthly - privateCostsMonthly;

      const html = `
        <!-- Key Metrics Summary -->
        <div class="results-summary">
          <div class="summary-card highlight">
            <span class="summary-label">Disposable Income</span>
            <span class="summary-value accent">${formatEUR(leefgeld)}<span class="summary-unit">/month</span></span>
          </div>
          <div class="summary-card">
            <span class="summary-label">Net After Tax</span>
            <span class="summary-value">${formatEUR(r.netMonthly)}<span class="summary-unit">/month</span></span>
          </div>
          <div class="summary-card">
            <span class="summary-label">IRPF Tax</span>
            <span class="summary-value negative">${formatEUR(r.cuotaIntegra)}<span class="summary-unit">/year</span></span>
          </div>
          <div class="summary-card">
            <span class="summary-label">Effective Rate</span>
            <span class="summary-value">${formatPercent(r.effectiveRate)}</span>
          </div>
        </div>

        <!-- Detailed Breakdown Grid -->
        <div class="results-grid">
          <div class="results-section">
            <h3 class="results-section-title">Income</h3>
            <div class="results-row">
              <span class="row-label">Monthly Revenue</span>
              <span class="row-value">${formatEUR(r.monthlyRevenue)}</span>
            </div>
            <div class="results-row">
              <span class="row-label">Annual Revenue</span>
              <span class="row-value">${formatEUR(r.annualRevenue)}</span>
            </div>
          </div>

          <div class="results-section">
            <h3 class="results-section-title">Deductions</h3>
            <div class="results-row">
              <span class="row-label">RETA (Social Security) ${sourceHint('RETA')}</span>
              <span class="row-value">${formatEUR(r.retaAnnual)}</span>
            </div>
            <div class="results-row">
              <span class="row-label">Spain Deductible</span>
              <span class="row-value">${formatEUR(totals.spainDeductible.annual)}</span>
            </div>
            <div class="results-row">
              <span class="row-label">Work Travel</span>
              <span class="row-value">${formatEUR(totals.workTravel.annual)}</span>
            </div>
            <div class="results-row total">
              <span class="row-label">Total Deductible</span>
              <span class="row-value">${formatEUR(r.totalDeductible)}</span>
            </div>
          </div>

          <div class="results-section">
            <h3 class="results-section-title">IRPF Calculation ${sourceHint('IRPF_BRACKETS')}</h3>
            <div class="results-row">
              <span class="row-label">Rendimiento Neto Previo</span>
              <span class="row-value">${formatEUR(r.rendimientoNetoPrevio)}</span>
            </div>
            <div class="results-row">
              <span class="row-label">Gastos Dificil (5%, max 2000) ${sourceHint('GASTOS_DIFICIL')}</span>
              <span class="row-value">-${formatEUR(r.gastosDificil)}</span>
            </div>
            <div class="results-row total">
              <span class="row-label">Base Liquidable</span>
              <span class="row-value">${formatEUR(r.baseLiquidable)}</span>
            </div>
          </div>

          <div class="results-section">
            <h3 class="results-section-title">Tax Reductions ${sourceHint('MINIMO_APPLICATION')}</h3>
            <div class="results-row">
              <span class="row-label">Minimo Personal ${sourceHint('MINIMO_PERSONAL')}</span>
              <span class="row-value">${formatEUR(r.minimoPersonal)}</span>
            </div>
            <div class="results-row">
              <span class="row-label">Minimo Descendientes ${sourceHint('MINIMO_DESCENDIENTES')}</span>
              <span class="row-value">${formatEUR(r.minimoDescendientes)}</span>
            </div>
            <div class="results-row total">
              <span class="row-label">Total Minimos</span>
              <span class="row-value">${formatEUR(r.minimoTotal)}</span>
            </div>
          </div>

          <div class="results-section">
            <h3 class="results-section-title">Final Calculation</h3>
            <div class="results-row">
              <span class="row-label">Annual Net (after IRPF + RETA)</span>
              <span class="row-value">${formatEUR(r.netAnnual)}</span>
            </div>
            <div class="results-row">
              <span class="row-label">Monthly Net</span>
              <span class="row-value">${formatEUR(r.netMonthly)}</span>
            </div>
            <div class="results-row">
              <span class="row-label">Private Costs (non-deductible)</span>
              <span class="row-value">-${formatEUR(privateCostsMonthly)}/mo</span>
            </div>
          </div>
        </div>

        ${createFootnotes()}
      `;

      document.getElementById('results').innerHTML = html;
    }

    // ============================================================
    // CALCULATION FUNCTIONS
    // ============================================================
    // Implements official AEAT IRPF calculation methodology
    // CRITICAL: Uses 4-phase method where minimos reduce TAX, not BASE
    // ============================================================

    /**
     * Apply progressive IRPF brackets to any amount
     * Uses cumulative baseTax approach for accuracy at bracket boundaries
     * @param {number} amount - Taxable amount in EUR
     * @returns {number} - Tax amount in EUR (rounded to 2 decimals)
     */
    function applyBrackets(amount) {
      if (amount <= 0) return 0;

      for (const bracket of FISCAL_2025.IRPF_BRACKETS) {
        if (amount <= bracket.upTo) {
          return Math.round((bracket.baseTax + (amount - bracket.prevLimit) * bracket.rate) * 100) / 100;
        }
      }
      // Fallback (should never reach with Infinity bound)
      const last = FISCAL_2025.IRPF_BRACKETS[FISCAL_2025.IRPF_BRACKETS.length - 1];
      return Math.round((last.baseTax + (amount - last.prevLimit) * last.rate) * 100) / 100;
    }

    /**
     * Calculate Cuota Integra using 4-phase AEAT method
     * CRITICAL: Minimos reduce TAX liability, NOT taxable base
     *
     * Method:
     * 1. Calculate tax on full base liquidable
     * 2. Calculate tax on minimo amount (capped at base liquidable)
     * 3. Subtract #2 from #1 to get cuota integra
     *
     * Source: AEAT practical examples
     * https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2022/c15-calculo-impuesto-determinacion-cuotas-integras/ejemplo-practico-calculo-cuotas-integras-autonomica.html
     *
     * @param {number} baseLiquidable - Taxable base after all deductions
     * @param {number} minimoTotal - Sum of minimo personal + descendientes
     * @returns {number} - Cuota integra (tax liability) in EUR
     */
    function calculateCuotaIntegra(baseLiquidable, minimoTotal) {
      const cuota1 = applyBrackets(baseLiquidable);
      const minimoApplicable = Math.min(minimoTotal, baseLiquidable);
      const cuota3 = applyBrackets(minimoApplicable);
      return Math.max(0, Math.round((cuota1 - cuota3) * 100) / 100);
    }

    /**
     * Calculate Gastos de Dificil Justificacion
     * For Estimacion Directa Simplificada: 5% with 2000 EUR annual cap
     *
     * Source: AEAT Estimacion Directa Simplificada
     * Note: Was 7% in 2023, reverted to 5% for 2024 onwards
     *
     * @param {number} rendimientoNetoPrevio - Net income before gastos dificil
     * @returns {number} - Deductible amount in EUR
     */
    function calculateGastosDificil(rendimientoNetoPrevio) {
      if (rendimientoNetoPrevio <= 0) return 0;
      const calculated = rendimientoNetoPrevio * FISCAL_2025.GASTOS_DIFICIL_RATE;
      return Math.round(Math.min(calculated, FISCAL_2025.GASTOS_DIFICIL_MAX) * 100) / 100;
    }

    /**
     * Main IRPF calculation function - returns all intermediate values
     *
     * CALC-05 Clarification:
     * The 7% reduccion rendimientos applies only when calculating the RETA base
     * for Social Security purposes. For IRPF, the actual RETA cuota paid
     * (428.40 EUR/month) is deducted as an expense. Since the user has a fixed
     * RETA cuota from registration, we simply deduct it as a business expense.
     *
     * @param {number} monthlyRevenue - Gross monthly revenue in EUR
     * @param {number} monthlyDeductibleExpenses - Monthly deductible business expenses in EUR
     * @param {boolean} hasDescendant - Whether user has 1 dependent child
     * @returns {object} - Complete calculation breakdown
     */
    function calculateFullIRPF(monthlyRevenue, monthlyDeductibleExpenses = 0, hasDescendant = true) {
      // Step 1: Annualize inputs
      const annualRevenue = monthlyRevenue * 12;
      const annualExpenses = monthlyDeductibleExpenses * 12;

      // Step 2: Total deductible = expenses + RETA (fixed cuota, not calculated)
      // CALC-05: RETA cuota is deducted as expense. The 7% reduccion is for SS, not IRPF.
      const totalDeductible = annualExpenses + FISCAL_2025.RETA_ANNUAL;

      // Step 3: Rendimiento Neto Previo (before gastos dificil)
      const rendimientoNetoPrevio = annualRevenue - totalDeductible;

      // Step 4: Gastos dificil justificacion
      const gastosDificil = calculateGastosDificil(rendimientoNetoPrevio);

      // Step 5: Rendimiento Neto = Base Liquidable (for autonomo)
      const rendimientoNeto = rendimientoNetoPrevio - gastosDificil;
      const baseLiquidable = Math.max(0, rendimientoNeto);

      // Step 6: Calculate minimos
      const minimoPersonal = FISCAL_2025.MINIMO_PERSONAL;
      const minimoDescendientes = hasDescendant ? FISCAL_2025.MINIMO_DESCENDIENTES_PRIMERO : 0;
      const minimoTotal = minimoPersonal + minimoDescendientes;

      // Step 7: Cuota Integra using 4-phase method
      const cuotaIntegra = calculateCuotaIntegra(baseLiquidable, minimoTotal);

      // Step 8: Effective tax rate
      const effectiveRate = rendimientoNeto > 0 ? (cuotaIntegra / rendimientoNeto) : 0;

      // Step 9: Net income calculations
      const netAnnual = annualRevenue - totalDeductible - gastosDificil - cuotaIntegra;
      const netMonthly = netAnnual / 12;

      // Step 10: Leefgeld (after private costs)
      const leefgeld = netMonthly - FISCAL_2025.PRIVATE_COSTS_MONTHLY;

      return {
        // Inputs
        monthlyRevenue,
        annualRevenue,
        monthlyExpenses: monthlyDeductibleExpenses,
        annualExpenses,

        // Deductions
        retaMonthly: FISCAL_2025.RETA_MONTHLY,
        retaAnnual: FISCAL_2025.RETA_ANNUAL,
        totalDeductible,

        // Calculation chain
        rendimientoNetoPrevio,
        gastosDificil,
        rendimientoNeto,
        baseLiquidable,

        // Minimos (for display)
        minimoPersonal,
        minimoDescendientes,
        minimoTotal,

        // Tax
        cuotaIntegra,
        effectiveRate,

        // Net income
        netAnnual,
        netMonthly,
        leefgeld,

        // Private costs (for reference)
        privateCostsMonthly: FISCAL_2025.PRIVATE_COSTS_MONTHLY
      };
    }

    /**
     * Calculate IRPF with custom fiscal configuration
     * Allows overriding RETA, minimos for what-if analysis
     *
     * @param {number} monthlyRevenue - Gross monthly revenue
     * @param {number} monthlyDeductibleExpenses - Monthly deductible expenses
     * @param {boolean} hasDescendant - Has dependent child
     * @param {object} fiscal - Custom fiscal config (merged with FISCAL_2025)
     * @returns {object} - Complete calculation breakdown
     */
    function calculateFullIRPFWithConfig(monthlyRevenue, monthlyDeductibleExpenses = 0, hasDescendant = true, fiscal = FISCAL_2025) {
      const annualRevenue = monthlyRevenue * 12;
      const annualExpenses = monthlyDeductibleExpenses * 12;

      const retaAnnual = fiscal.RETA_ANNUAL || FISCAL_2025.RETA_ANNUAL;
      const retaMonthly = fiscal.RETA_MONTHLY || FISCAL_2025.RETA_MONTHLY;
      const totalDeductible = annualExpenses + retaAnnual;

      const rendimientoNetoPrevio = annualRevenue - totalDeductible;
      const gastosDificil = calculateGastosDificil(rendimientoNetoPrevio);
      const rendimientoNeto = rendimientoNetoPrevio - gastosDificil;
      const baseLiquidable = Math.max(0, rendimientoNeto);

      const minimoPersonal = fiscal.MINIMO_PERSONAL || FISCAL_2025.MINIMO_PERSONAL;
      const minimoDescendientes = hasDescendant ? (fiscal.MINIMO_DESCENDIENTES_PRIMERO || FISCAL_2025.MINIMO_DESCENDIENTES_PRIMERO) : 0;
      const minimoTotal = minimoPersonal + minimoDescendientes;

      const cuotaIntegra = calculateCuotaIntegra(baseLiquidable, minimoTotal);
      const effectiveRate = rendimientoNeto > 0 ? (cuotaIntegra / rendimientoNeto) : 0;

      const netAnnual = annualRevenue - totalDeductible - gastosDificil - cuotaIntegra;
      const netMonthly = netAnnual / 12;

      return {
        monthlyRevenue,
        annualRevenue,
        monthlyExpenses: monthlyDeductibleExpenses,
        annualExpenses,
        retaMonthly,
        retaAnnual,
        totalDeductible,
        rendimientoNetoPrevio,
        gastosDificil,
        rendimientoNeto,
        baseLiquidable,
        minimoPersonal,
        minimoDescendientes,
        minimoTotal,
        cuotaIntegra,
        effectiveRate,
        netAnnual,
        netMonthly
      };
    }

    // ============================================================
    // FORMATTING UTILITIES
    // ============================================================

    /**
     * Format amount as EUR currency (Spanish locale)
     * @param {number} amount - Amount in EUR
     * @returns {string} - Formatted string like "5.550,00 EUR"
     */
    function formatEUR(amount) {
      return new Intl.NumberFormat('es-ES', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(amount);
    }

    /**
     * Format decimal as percentage
     * @param {number} decimal - Decimal value (0.25 = 25%)
     * @returns {string} - Formatted percentage like "25,00 %"
     */
    function formatPercent(decimal) {
      return new Intl.NumberFormat('es-ES', {
        style: 'percent',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(decimal);
    }

    // ============================================================
    // SOURCE CITATION UTILITIES
    // ============================================================

    /**
     * Create source hint HTML for inline citations
     * Uses click modal for better UX
     * @param {string} sourceKey - Key from SOURCES constant
     * @returns {string} - HTML string with clickable info icon
     */
    function sourceHint(sourceKey) {
      const s = SOURCES[sourceKey];
      if (!s) return '';
      const title = s.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
      const text = `${s.source}: ${s.note}`.replace(/'/g, "\\'").replace(/"/g, '&quot;');
      return `<button type="button" class="source-hint-btn" onclick="openTooltipModal('${title}', '${text}')" aria-label="More info about ${s.name}">?</button>`;
    }

    /**
     * Create footnotes section HTML listing all sources
     * @returns {string} - HTML string with sources list
     */
    function createFootnotes() {
      let html = '<div class="footnotes"><h4>Sources</h4><ul>';
      for (const [key, s] of Object.entries(SOURCES)) {
        html += `<li>
          <strong>${s.name}</strong> -
          <a href="${s.url}" target="_blank" rel="noopener">${s.source}</a>
          <span class="confidence-${s.confidence.toLowerCase()}">[${s.confidence}]</span>
        </li>`;
      }
      html += '</ul></div>';
      return html;
    }

    // ============================================================
    // UI FUNCTIONS
    // ============================================================

    /**
     * Legacy calculate function - kept for compatibility
     * Now redirects to recalculateTotals()
     */
    function calculate() {
      recalculateTotals();
    }

    /**
     * Reset the Details tab form to defaults
     */
    function resetDetailsForm() {
      document.getElementById('monthlyRevenue').value = '6000';
      document.getElementById('hasDescendant').checked = true;
      recalculateTotals();
    }

    // ============================================================
    // SCENARIO CARD RENDERING
    // ============================================================
    // Renders scenario cards sorted by leefgeld (highest first)
    // ============================================================

    /**
     * Render all scenario cards sorted by leefgeld (highest first)
     * First card (optimal) shows "Highest Disposable" badge
     * Includes "+ New Scenario" button at the end
     */
    function renderScenarioCards() {
      const container = document.getElementById('scenarioCards');
      if (!container) return;

      const sorted = getSortedScenarios();

      const cardsHtml = sorted.map((scenario, index) => {
        const isOptimal = index === 0;
        const isSelected = scenarioState.selected.includes(scenario.id);
        const isCustom = !scenario.isPreset;
        const workTravelCost = getWorkTravelCost(scenario);
        const totalExpenses = (scenario.monthlyExpenses + workTravelCost) * 12;
        const annualRevenue = scenario.monthlyRevenue * 12;
        const effectiveRate = scenario.results.effectiveRate || 0;

        const classes = [
          'scenario-card',
          isOptimal ? 'optimal' : '',
          isSelected ? 'selected' : '',
          isCustom ? 'custom' : ''
        ].filter(Boolean).join(' ');

        // Full breakdown card with onclick for detail modal (UI-02, UI-04)
        return `
          <div class="${classes}" data-id="${scenario.id}" onclick="if(!event.target.closest('.edit-btn') && !event.target.closest('input') && !event.target.closest('.term-tooltip-trigger')) openDetailModal('${scenario.id}')">
            <div class="card-header">
              <input type="checkbox"
                     ${isSelected ? 'checked' : ''}
                     onchange="toggleScenarioSelection('${scenario.id}')"
                     aria-label="Select ${scenario.name} for comparison">
              <h3>${scenario.name}</h3>
              ${isOptimal ? '<span class="optimal-badge">Highest Disposable</span>' : ''}
            </div>

            <div class="card-metrics">
              <div class="metric">
                <span class="label">Revenue</span>
                <span class="value value-positive">${formatEUR(annualRevenue)}/yr</span>
              </div>
              <div class="metric">
                <span class="label">Expenses</span>
                <span class="value value-negative">${formatEUR(totalExpenses)}/yr</span>
              </div>
              <div class="metric divider"></div>
              <div class="metric">
                <span class="label">${createTooltip('irpf', 'IRPF')}</span>
                <span class="value value-negative">${formatEUR(scenario.results.cuotaIntegra)}</span>
              </div>
              <div class="metric">
                <span class="label">${createTooltip('reta', 'RETA')}</span>
                <span class="value value-negative">${formatEUR(scenario.results.retaAnnual)}</span>
              </div>
              <div class="metric">
                <span class="label">Tax Rate</span>
                <span class="value">${(effectiveRate * 100).toFixed(1)}%</span>
              </div>
              <div class="metric divider"></div>
              <div class="metric">
                <span class="label">Net Income</span>
                <span class="value value-positive">${formatEUR(scenario.results.netAnnual)}/yr</span>
              </div>
              <div class="metric">
                <span class="label">Monthly Net</span>
                <span class="value">${formatEUR(scenario.results.netMonthly)}</span>
              </div>
              <div class="metric highlight">
                <span class="label">${createTooltip('leefgeld', 'Disposable Income')}</span>
                <span class="value">${formatEUR(scenario.results.leefgeld)}/mo</span>
              </div>
            </div>

            <button class="edit-btn" onclick="openEditModal('${scenario.id}')">
              Edit
            </button>
          </div>
        `;
      }).join('');

      // Add "+ New" button at end
      const newButtonHtml = `
        <button class="new-scenario-btn" onclick="showTemplateDialog()">+ New Scenario</button>
      `;

      container.innerHTML = cardsHtml + newButtonHtml;
    }

    /**
     * Toggle scenario selection for comparison
     * Updates state, saves to localStorage, and re-renders
     *
     * @param {string} scenarioId - ID of scenario to toggle
     */
    function toggleScenarioSelection(scenarioId) {
      const idx = scenarioState.selected.indexOf(scenarioId);
      if (idx === -1) {
        scenarioState.selected.push(scenarioId);
      } else {
        scenarioState.selected.splice(idx, 1);
      }
      saveScenarioState();
      renderScenarioCards();
      renderComparisonTable();
    }

    // ============================================================
    // COMPARISON TABLE RENDERING
    // ============================================================
    // Renders side-by-side comparison table for selected scenarios
    // ============================================================

    /**
     * Render comparison table for selected scenarios
     * Shows full calculation breakdown with sticky header and optimal highlighting
     */
    function renderComparisonTable() {
      const container = document.getElementById('comparisonTable');
      if (!container) return;

      const selectedIds = scenarioState.selected;

      // Empty state
      if (selectedIds.length === 0) {
        container.innerHTML = `
          <div class="comparison-empty">
            <p>Select scenarios using checkboxes to compare them side-by-side</p>
          </div>
        `;
        return;
      }

      // Get selected scenarios with results
      const scenarios = selectedIds
        .map(id => scenarioState.scenarios[id])
        .filter(Boolean)
        .map(s => ({
          ...s,
          results: calculateScenarioResults(s)
        }));

      // Verify all required properties exist on first results object (defensive check)
      if (scenarios.length > 0) {
        const requiredProps = [
          'annualRevenue', 'annualExpenses', 'retaAnnual', 'totalDeductible',
          'rendimientoNetoPrevio', 'gastosDificil', 'baseLiquidable',
          'minimoPersonal', 'minimoDescendientes', 'minimoTotal',
          'cuotaIntegra', 'effectiveRate', 'netAnnual', 'netMonthly',
          'leefgeld', 'privateCostsMonthly'
        ];
        const firstResults = scenarios[0].results;
        for (const prop of requiredProps) {
          if (firstResults[prop] === undefined) {
            console.error(`renderComparisonTable: missing property '${prop}' in results object. Check calculateFullIRPFWithFiscal return value in Plan 03-01.`);
          }
        }
      }

      // Find optimal values for highlighting
      const optimalLeefgeld = Math.max(...scenarios.map(s => s.results.leefgeld));
      const optimalEffRate = Math.min(...scenarios.map(s => s.results.effectiveRate));
      const optimalNetMonthly = Math.max(...scenarios.map(s => s.results.netMonthly));

      // Define metric rows (full breakdown per CONTEXT.md) with valueClass for color-coding (UI-07)
      // Tooltips added for key terms (UI-09)
      const metrics = [
        { label: 'Monthly Revenue', getValue: (s) => s.monthlyRevenue, format: formatEUR, valueClass: 'value-positive' },
        { label: 'Monthly Expenses', getValue: (s) => s.monthlyExpenses, format: formatEUR, valueClass: '' },
        { label: 'Work Travel Costs', getValue: (s) => getWorkTravelCost(s), format: formatEUR, valueClass: '' },
        { label: 'Total Monthly Expenses', getValue: (s) => s.monthlyExpenses + getWorkTravelCost(s), format: formatEUR, valueClass: 'value-negative' },
        { divider: true },
        { label: 'Annual Revenue', getValue: (s) => s.results.annualRevenue, format: formatEUR, valueClass: 'value-positive' },
        { label: createTooltip('reta', 'RETA (Annual)'), getValue: (s) => s.results.retaAnnual, format: formatEUR, valueClass: 'value-negative' },
        { label: 'Annual Expenses', getValue: (s) => s.results.annualExpenses, format: formatEUR, valueClass: '' },
        { label: 'Total Deductible', getValue: (s) => s.results.totalDeductible, format: formatEUR, valueClass: 'value-negative' },
        { divider: true },
        { label: 'Rendimiento Neto Previo', getValue: (s) => s.results.rendimientoNetoPrevio, format: formatEUR, valueClass: '' },
        { label: createTooltip('gastos', 'Gastos Dificil (5%)'), getValue: (s) => s.results.gastosDificil, format: formatEUR, valueClass: '' },
        { label: 'Base Liquidable', getValue: (s) => s.results.baseLiquidable, format: formatEUR, valueClass: '' },
        { divider: true },
        { label: createTooltip('minimo', 'Minimo Personal'), getValue: (s) => s.results.minimoPersonal, format: formatEUR, valueClass: '' },
        { label: createTooltip('descendientes', 'Minimo Descendientes'), getValue: (s) => s.results.minimoDescendientes, format: formatEUR, valueClass: '' },
        { label: 'Total Minimos', getValue: (s) => s.results.minimoTotal, format: formatEUR, valueClass: '' },
        { divider: true },
        { label: createTooltip('irpf', 'Cuota Integra (Annual IRPF)'), getValue: (s) => s.results.cuotaIntegra, format: formatEUR, valueClass: 'value-negative', optimalMin: true },
        { label: 'Effective Tax Rate', getValue: (s) => s.results.effectiveRate, format: formatPercent, valueClass: '', optimalMin: true },
        { divider: true },
        { label: 'Net Annual', getValue: (s) => s.results.netAnnual, format: formatEUR, valueClass: 'value-positive' },
        { label: 'Net Monthly', getValue: (s) => s.results.netMonthly, format: formatEUR, valueClass: 'value-positive', optimalMax: optimalNetMonthly },
        { label: 'Private Costs', getValue: (s) => s.results.privateCostsMonthly, format: formatEUR, valueClass: 'value-negative' },
        { label: createTooltip('leefgeld', 'Disposable Income'), getValue: (s) => s.results.leefgeld, format: formatEUR, valueClass: '', optimalMax: optimalLeefgeld, highlight: true }
      ];

      // Build table HTML
      let tableHtml = `
        <div class="comparison-container">
          <table class="comparison-table">
            <thead>
              <tr>
                <th>Metric</th>
                ${scenarios.map(s => `<th>${s.name}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
      `;

      metrics.forEach(metric => {
        if (metric.divider) {
          tableHtml += `<tr class="divider"><td colspan="${scenarios.length + 1}"></td></tr>`;
        } else {
          const rowClass = metric.highlight ? 'highlight-row' : '';
          tableHtml += `<tr class="${rowClass}">`;
          tableHtml += `<td>${metric.label}</td>`;

          scenarios.forEach(s => {
            const value = metric.getValue(s);
            const cellClasses = [];

            // Determine if this value is optimal
            if (metric.optimalMax !== undefined && value === metric.optimalMax) {
              cellClasses.push('optimal');
            }
            if (metric.optimalMin && value === optimalEffRate) {
              cellClasses.push('optimal');
            }
            // Add color class (UI-07) unless optimal takes precedence
            if (metric.valueClass && !cellClasses.includes('optimal')) {
              cellClasses.push(metric.valueClass);
            }

            const classAttr = cellClasses.length ? cellClasses.join(' ') : '';
            tableHtml += `<td class="${classAttr}">${metric.format(value)}</td>`;
          });

          tableHtml += '</tr>';
        }
      });

      tableHtml += `
            </tbody>
          </table>
        </div>
      `;

      container.innerHTML = tableHtml;

      // Also render mobile comparison view (UI-08)
      const mobileContainer = document.querySelector('.comparison-mobile');
      if (mobileContainer) {
        mobileContainer.innerHTML = renderMobileComparison(scenarios);
      }
    }

    /**
     * Render mobile comparison blocks (vertical layout)
     * @param {array} scenarios - Array of scenario objects with results
     * @returns {string} - HTML string of comparison blocks
     */
    function renderMobileComparison(scenarios) {
      if (!scenarios || scenarios.length === 0) {
        return '<p class="comparison-empty">Select scenarios to compare</p>';
      }

      const optimalLeefgeld = Math.max(...scenarios.map(s => s.results.leefgeld));

      return scenarios.map(s => {
        const isOptimal = s.results.leefgeld === optimalLeefgeld;

        return `
          <div class="comparison-block${isOptimal ? ' optimal' : ''}">
            <h4 class="block-title">${s.name}${isOptimal ? ' <span class="optimal-badge">Optimal</span>' : ''}</h4>
            <div class="block-metrics">
              <div class="block-row">
                <span class="label">Revenue</span>
                <span class="value value-positive">${formatEUR(s.results.annualRevenue)}/yr</span>
              </div>
              <div class="block-row">
                <span class="label">Expenses</span>
                <span class="value value-negative">${formatEUR(s.results.totalDeductible)}</span>
              </div>
              <div class="block-row">
                <span class="label">IRPF</span>
                <span class="value value-negative">${formatEUR(s.results.cuotaIntegra)}</span>
              </div>
              <div class="block-row">
                <span class="label">RETA</span>
                <span class="value value-negative">${formatEUR(s.results.retaAnnual)}</span>
              </div>
              <div class="block-row">
                <span class="label">Tax Rate</span>
                <span class="value">${(s.results.effectiveRate * 100).toFixed(1)}%</span>
              </div>
              <div class="block-row">
                <span class="label">Net Income</span>
                <span class="value value-positive">${formatEUR(s.results.netAnnual)}</span>
              </div>
              <div class="block-row highlight">
                <span class="label">Disposable Income</span>
                <span class="value">${formatEUR(s.results.leefgeld)}/mo</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    /**
     * Copy comparison table data to clipboard (UI-10)
     * Strips tooltips from cells before copying
     */
    async function copyTableToClipboard() {
      const table = document.querySelector('.comparison-table');
      if (!table) {
        showNotification('No comparison data to copy', 'error');
        return;
      }

      const rows = Array.from(table.querySelectorAll('tr'));
      const text = rows.map(row => {
        const cells = Array.from(row.querySelectorAll('th, td'));
        return cells.map(cell => {
          // Get text content, stripping tooltips
          const clone = cell.cloneNode(true);
          clone.querySelectorAll('[role="tooltip"]').forEach(t => t.remove());
          return clone.textContent.trim();
        }).join('\t');
      }).join('\n');

      try {
        await navigator.clipboard.writeText(text);
        showNotification('Copied to clipboard!');
      } catch (err) {
        console.error('Clipboard write failed:', err);
        showNotification('Copy failed - try again', 'error');
      }
    }

    // ============================================================
    // DETAIL MODAL FUNCTIONALITY (UI-04)
    // ============================================================
    // Read-only modal for viewing full scenario breakdown
    // ============================================================

    let currentDetailScenarioId = null;

    /**
     * Open detail modal showing full scenario breakdown
     * @param {string} scenarioId - ID of scenario to display
     */
    function openDetailModal(scenarioId) {
      const scenario = scenarioState.scenarios[scenarioId];
      if (!scenario) return;

      currentDetailScenarioId = scenarioId;
      const results = calculateScenarioResults(scenario);
      const body = document.getElementById('detail-body');
      const dialog = document.getElementById('detail-modal');
      const title = dialog.querySelector('.detail-title');
      const isOptimal = getSortedScenarios()[0]?.id === scenarioId;

      title.textContent = scenario.name + (isOptimal ? ' (Optimal)' : '');

      const workTravelCost = getWorkTravelCost(scenario);

      body.innerHTML = `
        <div class="detail-section">
          <h4>Income</h4>
          <div class="detail-row">
            <span class="label">Monthly Revenue</span>
            <span class="value">${formatEUR(scenario.monthlyRevenue)}</span>
          </div>
          <div class="detail-row">
            <span class="label">Annual Revenue</span>
            <span class="value">${formatEUR(results.annualRevenue)}</span>
          </div>
        </div>

        <div class="detail-section">
          <h4>Expenses</h4>
          <div class="detail-row">
            <span class="label">Spain Deductible</span>
            <span class="value value-negative">${formatEUR(scenario.monthlyExpenses * 12)}</span>
          </div>
          <div class="detail-row">
            <span class="label">Work Travel Costs</span>
            <span class="value value-negative">${formatEUR(workTravelCost * 12)}</span>
          </div>
          <div class="detail-row">
            <span class="label">Private Costs</span>
            <span class="value value-negative">${formatEUR(results.privateCostsMonthly * 12)}</span>
          </div>
          <div class="detail-row total">
            <span class="label">Total Expenses</span>
            <span class="value">${formatEUR(results.annualExpenses + (workTravelCost * 12))}</span>
          </div>
        </div>

        <div class="detail-section">
          <h4>Taxes</h4>
          <div class="detail-row">
            <span class="label">IRPF (Income Tax)</span>
            <span class="value value-negative">${formatEUR(results.cuotaIntegra)}</span>
          </div>
          <div class="detail-row">
            <span class="label">RETA (Social Security)</span>
            <span class="value value-negative">${formatEUR(results.retaAnnual)}</span>
          </div>
          <div class="detail-row">
            <span class="label">Effective Tax Rate</span>
            <span class="value">${(results.effectiveRate * 100).toFixed(1)}%</span>
          </div>
        </div>

        <div class="detail-section">
          <h4>Net Result</h4>
          <div class="detail-row">
            <span class="label">Net Income (Annual)</span>
            <span class="value value-positive">${formatEUR(results.netAnnual)}</span>
          </div>
          <div class="detail-row">
            <span class="label">Monthly Net</span>
            <span class="value value-positive">${formatEUR(results.netMonthly)}</span>
          </div>
          <div class="detail-row total">
            <span class="label">Disposable Income</span>
            <span class="value">${formatEUR(results.leefgeld)}/mo</span>
          </div>
        </div>
      `;

      dialog.showModal();
    }

    /**
     * Close detail modal
     */
    function closeDetailModal() {
      document.getElementById('detail-modal').close();
      currentDetailScenarioId = null;
    }

    /**
     * Transition from detail modal to edit modal
     */
    function editFromDetail() {
      const scenarioId = currentDetailScenarioId;
      closeDetailModal();
      if (scenarioId && typeof openEditModal === 'function') {
        openEditModal(scenarioId);
      }
    }

    // ============================================================
    // EDIT MODAL FUNCTIONALITY
    // ============================================================
    // Modal for editing scenario values with live results preview
    // ============================================================

    let currentEditScenarioId = null;

    /**
     * Open edit modal for a scenario
     * Populates form with scenario values and shows modal
     *
     * @param {string} scenarioId - ID of scenario to edit
     */
    function openEditModal(scenarioId) {
      const scenario = scenarioState.scenarios[scenarioId];
      if (!scenario) return;

      currentEditScenarioId = scenarioId;
      const dialog = document.getElementById('editScenarioDialog');

      // Populate form fields
      document.getElementById('editScenarioName').value = scenario.name;
      document.getElementById('editMonthlyRevenue').value = scenario.monthlyRevenue;
      document.getElementById('editMonthlyExpenses').value = scenario.monthlyExpenses;
      document.getElementById('editWorkTravelCost').value = getWorkTravelCost(scenario);
      document.getElementById('editHasDescendant').checked = scenario.hasDescendant;

      // Populate fiscal overrides (empty means use default)
      const overrides = scenario.fiscalOverrides || {};
      document.getElementById('editRetaOverride').value = overrides.RETA_MONTHLY || '';
      document.getElementById('editMinimoPersonalOverride').value = overrides.MINIMO_PERSONAL || '';
      document.getElementById('editMinimoDescOverride').value = overrides.MINIMO_DESCENDIENTES_PRIMERO || '';

      // Show/hide delete button based on preset status
      const deleteBtn = document.getElementById('deleteScenarioBtn');
      deleteBtn.style.display = scenario.isPreset ? 'none' : 'block';

      // Update dialog title
      document.getElementById('dialogTitle').textContent = `Edit ${scenario.name}`;

      // Calculate and show initial results
      updateLiveResults();

      // Open modal
      dialog.showModal();
    }

    /**
     * Close edit modal without saving
     */
    function closeEditModal() {
      const dialog = document.getElementById('editScenarioDialog');
      dialog.close();
      currentEditScenarioId = null;
    }

    // ============================================================
    // LIVE RECALCULATION
    // ============================================================
    // requestAnimationFrame-debounced live recalculation on input
    // ============================================================

    let liveCalcRafId = null;

    /**
     * Handle input change in edit modal
     * Uses requestAnimationFrame for debouncing
     */
    function onScenarioInputChange() {
      // Cancel any pending recalculation
      if (liveCalcRafId) {
        cancelAnimationFrame(liveCalcRafId);
      }

      // Schedule recalculation for next frame
      liveCalcRafId = requestAnimationFrame(() => {
        updateLiveResults();
        liveCalcRafId = null;
      });
    }

    /**
     * Get current values from edit form
     * @returns {object} - Form values with fiscalOverrides if any
     */
    function getEditFormValues() {
      const monthlyRevenue = parseFloat(document.getElementById('editMonthlyRevenue').value) || 0;
      const monthlyExpenses = parseFloat(document.getElementById('editMonthlyExpenses').value) || 0;
      const workTravelCost = parseFloat(document.getElementById('editWorkTravelCost').value) || 0;
      const hasDescendant = document.getElementById('editHasDescendant').checked;

      // Fiscal overrides (empty string = use default)
      const retaOverride = document.getElementById('editRetaOverride').value;
      const minimoPersonalOverride = document.getElementById('editMinimoPersonalOverride').value;
      const minimoDescOverride = document.getElementById('editMinimoDescOverride').value;

      let fiscalOverrides = null;
      if (retaOverride || minimoPersonalOverride || minimoDescOverride) {
        fiscalOverrides = {};
        if (retaOverride) {
          fiscalOverrides.RETA_MONTHLY = parseFloat(retaOverride);
          fiscalOverrides.RETA_ANNUAL = parseFloat(retaOverride) * 12;
        }
        if (minimoPersonalOverride) {
          fiscalOverrides.MINIMO_PERSONAL = parseFloat(minimoPersonalOverride);
        }
        if (minimoDescOverride) {
          fiscalOverrides.MINIMO_DESCENDIENTES_PRIMERO = parseFloat(minimoDescOverride);
        }
      }

      return {
        name: document.getElementById('editScenarioName').value.trim(),
        monthlyRevenue,
        monthlyExpenses,
        workTravelCost,
        hasDescendant,
        fiscalOverrides
      };
    }

    /**
     * Update live results pane with calculated values
     * Called on every input change (debounced)
     */
    function updateLiveResults() {
      const values = getEditFormValues();
      const results = calculateScenarioResults(values);

      // Verify results object has all expected properties (defensive programming)
      // These properties are guaranteed by calculateFullIRPFWithFiscal in Plan 03-01
      const requiredProps = [
        'annualRevenue', 'totalDeductible', 'rendimientoNeto', 'gastosDificil',
        'baseLiquidable', 'minimoTotal', 'cuotaIntegra', 'effectiveRate',
        'retaAnnual', 'netMonthly', 'leefgeld'
      ];
      for (const prop of requiredProps) {
        if (results[prop] === undefined) {
          console.error(`updateLiveResults: missing property '${prop}' in results object`);
        }
      }

      const container = document.getElementById('liveEditResults');
      container.innerHTML = `
        <div class="live-result-row">
          <span class="label">Annual Revenue</span>
          <span class="value">${formatEUR(results.annualRevenue)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Total Deductible</span>
          <span class="value">${formatEUR(results.totalDeductible)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Rendimiento Neto</span>
          <span class="value">${formatEUR(results.rendimientoNeto)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Gastos Dificil (5%)</span>
          <span class="value">${formatEUR(results.gastosDificil)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Base Liquidable</span>
          <span class="value">${formatEUR(results.baseLiquidable)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Total Minimos</span>
          <span class="value">${formatEUR(results.minimoTotal)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Cuota Integra (IRPF)</span>
          <span class="value">${formatEUR(results.cuotaIntegra)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Effective Tax Rate</span>
          <span class="value">${formatPercent(results.effectiveRate)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">RETA Annual</span>
          <span class="value">${formatEUR(results.retaAnnual)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Net Monthly</span>
          <span class="value">${formatEUR(results.netMonthly)}</span>
        </div>
        <div class="live-result-row highlight">
          <span class="label">Disposable Income</span>
          <span class="value">${formatEUR(results.leefgeld)}/mo</span>
        </div>
      `;
    }

    // ============================================================
    // SAVE AND DELETE FUNCTIONALITY
    // ============================================================

    /**
     * Save changes from edit form to scenario state
     * Called when dialog closes with 'save' return value
     */
    function saveScenarioChanges() {
      if (!currentEditScenarioId) return;

      const values = getEditFormValues();

      // Validate name
      if (!values.name) {
        alert('Please enter a scenario name');
        return;
      }

      const scenario = scenarioState.scenarios[currentEditScenarioId];
      if (!scenario) return;

      // Update scenario (keep id and isPreset)
      Object.assign(scenario, {
        name: values.name,
        monthlyRevenue: values.monthlyRevenue,
        monthlyExpenses: values.monthlyExpenses,
        workTravelCost: values.workTravelCost,
        hasDescendant: values.hasDescendant,
        fiscalOverrides: values.fiscalOverrides
      });
      // Remove legacy property if present
      delete scenario.belgiumPattern;

      saveScenarioState();
      renderScenarioCards();
      renderComparisonTable();
    }

    /**
     * Confirm and delete current scenario
     * Only works for custom scenarios (not presets A-E)
     */
    function confirmDeleteScenario() {
      if (!currentEditScenarioId) return;

      const scenario = scenarioState.scenarios[currentEditScenarioId];
      if (!scenario) return;

      if (scenario.isPreset) {
        alert('Cannot delete preset scenarios (A-E). You can only delete custom scenarios.');
        return;
      }

      if (confirm(`Delete "${scenario.name}"? This cannot be undone.`)) {
        delete scenarioState.scenarios[currentEditScenarioId];
        scenarioState.customOrder = scenarioState.customOrder.filter(id => id !== currentEditScenarioId);
        scenarioState.selected = scenarioState.selected.filter(id => id !== currentEditScenarioId);
        saveScenarioState();
        closeEditModal();
        renderScenarioCards();
        renderComparisonTable();
      }
    }

    /**
     * Initialize edit dialog event handlers
     * Called on DOMContentLoaded
     */
    function initEditDialog() {
      const dialog = document.getElementById('editScenarioDialog');
      if (!dialog) return;

      // Handle form submit (Save button)
      dialog.addEventListener('close', () => {
        if (dialog.returnValue === 'save') {
          saveScenarioChanges();
        }
      });

      // Prevent Esc from saving (cancel event)
      dialog.addEventListener('cancel', (e) => {
        // Default behavior is fine - just closes without saving
      });

      // Attach input change handlers for live recalculation
      const inputs = dialog.querySelectorAll('input, select');
      inputs.forEach(input => {
        input.addEventListener('input', onScenarioInputChange);
        input.addEventListener('change', onScenarioInputChange); // For checkboxes and selects
      });
    }

    // ============================================================
    // TEMPLATE DIALOG / CUSTOM SCENARIO CREATION
    // ============================================================
    // Create new scenarios from existing scenario templates
    // ============================================================

    let selectedTemplateId = null;

    /**
     * Show template selection dialog for creating new scenario
     */
    function showTemplateDialog() {
      const dialog = document.getElementById('templateSelectDialog');
      const optionsContainer = document.getElementById('templateOptions');

      // Build template options from all scenarios
      const allScenarios = Object.values(scenarioState.scenarios);

      optionsContainer.innerHTML = allScenarios.map((s, index) => {
        const workTravelCost = getWorkTravelCost(s);
        const checked = index === 0 ? 'checked' : '';

        return `
          <label class="template-option">
            <input type="radio" name="template" value="${s.id}" ${checked}>
            <div class="template-info">
              <div class="template-name">${s.name}</div>
              <div class="template-desc">${formatEUR(s.monthlyRevenue)}/mo revenue, ${formatEUR(s.monthlyExpenses + workTravelCost)}/mo expenses</div>
            </div>
          </label>
        `;
      }).join('');

      // Clear name input
      document.getElementById('newScenarioName').value = '';

      dialog.showModal();
    }

    /**
     * Close template dialog without creating
     */
    function closeTemplateDialog() {
      document.getElementById('templateSelectDialog').close();
    }

    /**
     * Initialize template dialog event handlers
     * Called on DOMContentLoaded
     */
    function initTemplateDialog() {
      const dialog = document.getElementById('templateSelectDialog');
      if (!dialog) return;

      dialog.addEventListener('close', () => {
        if (dialog.returnValue === 'create') {
          createCustomScenario();
        }
      });
    }

    /**
     * Create a new custom scenario from selected template
     * Called when template dialog closes with 'create' return value
     */
    function createCustomScenario() {
      const name = document.getElementById('newScenarioName').value.trim();
      if (!name) {
        alert('Please enter a name for the scenario');
        return;
      }

      // Get selected template
      const selectedRadio = document.querySelector('#templateOptions input[name="template"]:checked');
      if (!selectedRadio) {
        alert('Please select a template');
        return;
      }

      const templateId = selectedRadio.value;
      const template = scenarioState.scenarios[templateId];
      if (!template) return;

      // Create new scenario from template
      const newScenario = {
        ...structuredClone(template),
        id: crypto.randomUUID(),
        name: name,
        isPreset: false,
        fiscalOverrides: null  // Reset any overrides from template
      };

      // Add to state
      scenarioState.scenarios[newScenario.id] = newScenario;
      scenarioState.customOrder.push(newScenario.id);
      saveScenarioState();
      renderScenarioCards();
      renderComparisonTable();

      // Open edit modal for new scenario
      openEditModal(newScenario.id);
    }

    // Tooltip escape key handler (UI-09, BUG-02)
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        // Close tooltip modal if open (handled natively by dialog)
        // Remove focus from any tooltip trigger
        if (document.activeElement.classList.contains('term-tooltip-trigger')) {
          document.activeElement.blur();
        }
      }
    });

    // ============================================================
    // PHASE 7: COMPLIANCE TAB CONTENT
    // ============================================================

    // ===========================================
    // PHASE 7: COMPLIANCE WARNING BANNER
    // ===========================================

    function getComplianceWarningDismissKey() {
      return 'complianceWarningDismissed_session';
    }

    function isComplianceWarningDismissed() {
      return sessionStorage.getItem(getComplianceWarningDismissKey()) === 'true';
    }

    function dismissComplianceWarning() {
      sessionStorage.setItem(getComplianceWarningDismissKey(), 'true');
      const banner = document.getElementById('complianceWarningBanner');
      if (banner) {
        banner.classList.remove('visible');
      }
    }

    function getBelgiumDayCount() {
      // Uses existing calendarState from Phase 4
      if (typeof calendarState === 'undefined' || !calendarState.days) return 0;
      let count = 0;
      for (const dateKey in calendarState.days) {
        const dayData = calendarState.days[dateKey];
        const status = dayData.status;
        // Count Belgium and Travel days toward threshold (conservative approach)
        if (status === 'belgium' || status === 'travel') {
          count++;
        }
      }
      return count;
    }

    function updateComplianceWarning() {
      const banner = document.getElementById('complianceWarningBanner');
      const textEl = document.getElementById('warningText');
      if (!banner || !textEl) return;

      // Don't show if dismissed this session
      if (isComplianceWarningDismissed()) {
        banner.classList.remove('visible');
        return;
      }

      const belgiumDays = getBelgiumDayCount();

      // Remove previous threshold classes
      banner.classList.remove('threshold-170', 'threshold-180', 'threshold-183');

      if (belgiumDays >= 183) {
        banner.classList.add('visible', 'threshold-183');
        textEl.innerHTML = `<strong>${belgiumDays} Belgium/travel days.</strong> You have exceeded the 183-day threshold. Treaty tie-breaker provisions apply to determine tax residence.`;
      } else if (belgiumDays >= 180) {
        banner.classList.add('visible', 'threshold-180');
        textEl.innerHTML = `<strong>${belgiumDays} Belgium/travel days.</strong> You are approaching the 183-day threshold. Review treaty provisions in the Compliance tab.`;
      } else if (belgiumDays >= 170) {
        banner.classList.add('visible', 'threshold-170');
        textEl.innerHTML = `<strong>${belgiumDays} Belgium/travel days.</strong> Approaching 183-day threshold. Consider reviewing treaty provisions.`;
      } else {
        banner.classList.remove('visible');
      }
    }

    /**
     * Render the Compliance tab content with collapsible sections
     * Two-column layout: Left = Working requirements, Right = Tax residence rules
     */
    function renderComplianceContent() {
      const panel = document.getElementById('compliancePanel');
      if (!panel) return;

      panel.innerHTML = `
        <h2>Compliance Information</h2>

        <div class="compliance-columns">
          <!-- LEFT COLUMN: Working in Belgium -->
          <div class="compliance-col">
            <div class="action-phase">
              <h3>While Working in Belgium</h3>
              <div class="compliance-section">
                <button class="section-header" aria-expanded="false" aria-controls="content-dietas">
                  <span>Dietas Limits</span>
                  <span class="section-icon">&#9654;</span>
                </button>
                <div class="section-content" id="content-dietas" hidden>
                  <table class="fiscal-table">
                    <thead><tr><th>Location</th><th>Overnight</th><th>Day only</th></tr></thead>
                    <tbody>
                      <tr><td>Spain</td><td>${formatEUR(DIETAS_LIMITS.spain.withOvernight)}</td><td>${formatEUR(DIETAS_LIMITS.spain.withoutOvernight)}</td></tr>
                      <tr><td>Belgium</td><td class="highlight">${formatEUR(DIETAS_LIMITS.abroad.withOvernight)}</td><td>${formatEUR(DIETAS_LIMITS.abroad.withoutOvernight)}</td></tr>
                    </tbody>
                  </table>
                  <cite class="source-citation">${renderInlineSource('AEAT_DIETAS', DIETAS_LIMITS.source)} | ${renderInlineSource('BOE_REGLAMENTO_IRPF', 'Reglamento Art. 9')}</cite>
                </div>
              </div>
              <div class="compliance-section">
                <button class="section-header" aria-expanded="false" aria-controls="content-factura">
                  <span>Factura Completa</span>
                  <span class="section-icon">&#9654;</span>
                </button>
                <div class="section-content" id="content-factura" hidden>
                  <p class="plain-summary"><strong>Required for deduction:</strong> complete invoice (not just receipt)</p>
                  <ul class="requirements-list">
                    ${FACTURA_REQUIREMENTS.required.map(r => `<li><span class="field-name">${r.field}</span><span class="field-desc">${r.description}</span></li>`).join('')}
                  </ul>
                  <div class="invalid-list">
                    <h5>NOT Valid:</h5>
                    <ul class="requirements-list">
                      ${FACTURA_REQUIREMENTS.notValid.map(r => `<li><span class="invalid-type">${r.type}</span> - ${r.reason}</li>`).join('')}
                    </ul>
                  </div>
                  <cite class="source-citation">${renderInlineSource('AEAT_FACTURACION', FACTURA_REQUIREMENTS.source)}</cite>
                </div>
              </div>
              <div class="compliance-section">
                <button class="section-header" aria-expanded="false" aria-controls="content-payment">
                  <span>Payment Method</span>
                  <span class="section-icon">&#9654;</span>
                </button>
                <div class="section-content" id="content-payment" hidden>
                  <div class="payment-warning">
                    <strong>Cash = NOT deductible</strong>
                    <p>Use: bank card, transfer, Bizum, or traceable electronic payment</p>
                  </div>
                  <cite class="source-citation">Ley 6/2017 (AEAT)</cite>
                </div>
              </div>
            </div>
          </div>

          <!-- RIGHT COLUMN: Tax Residence -->
          <div class="compliance-col">
            <div class="action-phase">
              <h3>Tax Residence Rules</h3>
              <div class="compliance-section">
                <button class="section-header" aria-expanded="false" aria-controls="content-183">
                  <span>183-Day Threshold</span>
                  <span class="section-icon">&#9654;</span>
                </button>
                <div class="section-content" id="content-183" hidden>
                  <p class="plain-summary">183+ days in Spain = Spanish tax resident (domestic law)</p>
                  <div class="entry-exit-warning">
                    <strong>Entry/exit days count in BOTH countries</strong>
                    <p>Travel day counts in both Spain and Belgium simultaneously</p>
                  </div>
                  <cite class="source-citation">${renderInlineSource('BOE_LIRPF', 'LIRPF Art. 9.1.a')}</cite>
                </div>
              </div>
              <div class="compliance-section">
                <button class="section-header" aria-expanded="false" aria-controls="content-family">
                  <span>Family Presumption</span>
                  <span class="section-icon">&#9654;</span>
                </button>
                <div class="section-content" id="content-family" hidden>
                  <p class="plain-summary"><strong>Art. 9.1.b LIRPF:</strong> ${ARTICLE_9_1_B.plainSummary}</p>
                  <p class="plain-summary"><strong>Implication:</strong> ${ARTICLE_9_1_B.implication}</p>
                  <cite class="source-citation">${renderInlineSource('BOE_LIRPF', ARTICLE_9_1_B.source)}</cite>
                </div>
              </div>
              <div class="compliance-section">
                <button class="section-header" aria-expanded="false" aria-controls="content-tiebreaker">
                  <span>Treaty Tie-Breaker</span>
                  <span class="section-icon">&#9654;</span>
                </button>
                <div class="section-content" id="content-tiebreaker" hidden>
                  <p class="plain-summary">When both countries claim you, treaty resolves via 5-step hierarchy:</p>
                  <ol class="tie-breaker-steps">
                    ${TREATY_ARTICLE_4.steps.map(s => `<li><span class="step-name">${s.name}</span><span class="step-plain">${s.plain}</span></li>`).join('')}
                  </ol>
                  <cite class="source-citation">${renderInlineSource('BOE_TREATY', 'BOE-A-2003-13375')} | ${renderInlineSource('AEAT_TREATY_BELGIUM', 'AEAT Belgium CDI')}</cite>
                </div>
              </div>
              <div class="compliance-section">
                <button class="section-header" aria-expanded="false" aria-controls="content-centro">
                  <span>Vital Interests</span>
                  <span class="section-icon">&#9654;</span>
                </button>
                <div class="section-content" id="content-centro" hidden>
                  <p class="plain-summary"><strong>Personal:</strong> Family, social ties, "where you live your life"</p>
                  <p class="plain-summary"><strong>Economic:</strong> Work, income, property</p>
                  <p class="plain-summary">Family location often tips the balance when combined with maintained home and regular returns.</p>
                  <cite class="source-citation">OECD Model Tax Convention Commentary, Art. 4</cite>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Official Sources Section (Phase 8: ENH-03/04/05) -->
        <div class="sources-section">
          <h3>Official Sources</h3>
          <p style="color: var(--text-muted); font-size: var(--size-small); margin-bottom: var(--spacing-md);">
            All fiscal data in this calculator is sourced from official Spanish government publications.
            Click any link to verify at the original source.
          </p>

          <div class="sources-grid">
            <div class="sources-category">
              <h4>IRPF / Income Tax</h4>
              <div class="sources-category-links" id="sourcesIRPF"></div>
            </div>

            <div class="sources-category">
              <h4>RETA / Social Security</h4>
              <div class="sources-category-links" id="sourcesRETA"></div>
            </div>

            <div class="sources-category">
              <h4>Treaty & Residency</h4>
              <div class="sources-category-links" id="sourcesTreaty"></div>
            </div>

            <div class="sources-category">
              <h4>Expenses & Documentation</h4>
              <div class="sources-category-links" id="sourcesExpenses"></div>
            </div>
          </div>
        </div>
      `;

      // Set up collapsible section event listeners
      panel.querySelectorAll('.compliance-section .section-header').forEach(btn => {
        btn.addEventListener('click', () => {
          const expanded = btn.getAttribute('aria-expanded') === 'true';
          btn.setAttribute('aria-expanded', !expanded);
          const contentId = btn.getAttribute('aria-controls');
          const content = document.getElementById(contentId);
          if (content) {
            content.hidden = expanded;
          }
        });
      });

      // Initialize sources section
      initSourcesSection();
    }

    /**
     * Initialize Official Sources section with categorized links (Phase 8: ENH-03/04/05)
     */
    function initSourcesSection() {
      // IRPF Sources
      const irpfContainer = document.getElementById('sourcesIRPF');
      if (irpfContainer) {
        irpfContainer.innerHTML = [
          renderSourceLink('AEAT_IRPF'),
          renderSourceLink('AEAT_AUTONOMOS'),
          renderSourceLink('AEAT_MINIMO_PERSONAL'),
          renderSourceLink('AEAT_MINIMO_DESCENDIENTES'),
          renderSourceLink('AEAT_ESTIMACION_DIRECTA')
        ].join('');
      }

      // RETA Sources
      const retaContainer = document.getElementById('sourcesRETA');
      if (retaContainer) {
        retaContainer.innerHTML = [
          renderSourceLink('SS_RETA'),
          renderSourceLink('RETA_COTIZACION')
        ].join('');
      }

      // Treaty Sources
      const treatyContainer = document.getElementById('sourcesTreaty');
      if (treatyContainer) {
        treatyContainer.innerHTML = [
          renderSourceLink('BOE_TREATY'),
          renderSourceLink('AEAT_TREATY_BELGIUM'),
          renderSourceLink('BOE_LIRPF')
        ].join('');
      }

      // Expenses Sources
      const expensesContainer = document.getElementById('sourcesExpenses');
      if (expensesContainer) {
        expensesContainer.innerHTML = [
          renderSourceLink('AEAT_DIETAS'),
          renderSourceLink('BOE_REGLAMENTO_IRPF'),
          renderSourceLink('AEAT_FACTURACION')
        ].join('');
      }
    }

    /**
     * Initialize Details tab source hints (Phase 8: ENH-03)
     */
    function initDetailsSourceHints() {
      // RETA source hint
      const retaHint = document.getElementById('retaSourceHint');
      if (retaHint) {
        retaHint.innerHTML = `Fixed from registration ${renderInlineSource('SS_RETA', 'RETA rates')}`;
      }

      // Minimo Personal source hint
      const minimoHint = document.getElementById('minimoSourceHint');
      if (minimoHint) {
        minimoHint.innerHTML = renderInlineSource('AEAT_MINIMO_PERSONAL', 'AEAT source');
      }
    }

    // =====================================================
    // PHASE 12: Data Architecture Foundation
    // =====================================================

    const DB_NAME = 'AutonomoBusinessDB';
    const DB_VERSION = 2;

    class AppDatabase extends Dexie {
      constructor() {
        super(DB_NAME);

        // Version 1: Original schema (keep for upgrade path)
        this.version(1).stores({
          // Business entities (autonomo, SL)
          entities: '++id, type, nif_cif, name, is_active, created_at, deleted_at',

          // Clients
          clients: '++id, entity_id, nif_cif, name, country, category, created_at, deleted_at, [entity_id+deleted_at]',

          // Projects (per client)
          projects: '++id, client_id, entity_id, name, status, rate_cents, created_at, deleted_at',

          // Invoices (VeriFactu compliant)
          invoices: '++id, entity_id, client_id, series, invoice_number, status, date_issued, date_due, subtotal_cents, iva_cents, irpf_cents, total_cents, deleted_at, [entity_id+series+invoice_number], [entity_id+deleted_at], [entity_id+status]',

          // Invoice line items
          invoice_lines: '++id, invoice_id, description, quantity, unit_price_cents, iva_rate, line_total_cents',

          // Invoice sequences (per entity, per series)
          invoice_sequences: '++id, entity_id, series, last_number, [entity_id+series]',

          // Expenses
          expenses: '++id, entity_id, category, subcategory, vendor, date, amount_cents, iva_cents, deductible_amount_cents, description, is_billable, client_id, project_id, receipt_id, created_at, deleted_at, [entity_id+deleted_at], [entity_id+category], [entity_id+date]',

          // Receipts (linked to expenses)
          receipts: '++id, expense_id, file_name, file_type, file_data, ocr_status, ocr_confidence, ocr_extracted, created_at',

          // Calendar days
          calendar_days: '++id, entity_id, date, location, client_id, project_id, notes, created_at, updated_at, [entity_id+date]',

          // Tax calculations (cached results)
          tax_calculations: '++id, entity_id, tax_type, period_start, period_end, calculated_at, input_data, result_data',

          // Sync queue
          sync_queue: '++id, table_name, record_id, operation, data, created_at, retry_count, last_error',

          // App settings
          settings: 'key, value, updated_at'
        });

        // Version 2: Add authentication and permissions tables
        this.version(2).stores({
          // Business entities - now with owner_id for auth
          entities: '++id, type, nif_cif, name, is_active, owner_id, created_at, deleted_at',

          // Existing tables (unchanged indexes)
          clients: '++id, entity_id, nif_cif, name, country, category, created_at, deleted_at, [entity_id+deleted_at]',
          projects: '++id, client_id, entity_id, name, status, rate_cents, created_at, deleted_at',
          invoices: '++id, entity_id, client_id, series, invoice_number, status, date_issued, date_due, subtotal_cents, iva_cents, irpf_cents, total_cents, deleted_at, [entity_id+series+invoice_number], [entity_id+deleted_at], [entity_id+status]',
          invoice_lines: '++id, invoice_id, description, quantity, unit_price_cents, iva_rate, line_total_cents',
          invoice_sequences: '++id, entity_id, series, last_number, [entity_id+series]',
          expenses: '++id, entity_id, category, subcategory, vendor, date, amount_cents, iva_cents, deductible_amount_cents, description, is_billable, client_id, project_id, receipt_id, created_at, deleted_at, [entity_id+deleted_at], [entity_id+category], [entity_id+date]',
          receipts: '++id, expense_id, file_name, file_type, file_data, ocr_status, ocr_confidence, ocr_extracted, created_at',
          calendar_days: '++id, entity_id, date, location, client_id, project_id, notes, created_at, updated_at, [entity_id+date]',
          tax_calculations: '++id, entity_id, tax_type, period_start, period_end, calculated_at, input_data, result_data',
          sync_queue: '++id, table_name, record_id, operation, data, created_at, retry_count, last_error',
          settings: 'key, value, updated_at',

          // NEW: Authentication and permissions tables (Phase 14)
          // User profiles - extends Supabase auth.users
          profiles: 'id, email',  // id is UUID from auth.users (not auto-increment)

          // Entity sharing - junction table for user-entity-role relationships
          entity_shares: '++id, entity_id, user_id, [entity_id+user_id]',

          // Entity invitations - pending invitations with expiry
          entity_invitations: '++id, entity_id, invite_code, email, expires_at',

          // User sessions - tracks active sessions per user
          user_sessions: '++id, user_id, last_active_at'
        }).upgrade(tx => {
          // Migration: Add owner_id to existing entities (nullable until user authenticates)
          return tx.table('entities').toCollection().modify(entity => {
            if (entity.owner_id === undefined) {
              entity.owner_id = null;  // Will be set on first authentication
            }
          });
        });

        // Define table references
        this.entities = this.table('entities');
        this.clients = this.table('clients');
        this.projects = this.table('projects');
        this.invoices = this.table('invoices');
        this.invoice_lines = this.table('invoice_lines');
        this.invoice_sequences = this.table('invoice_sequences');
        this.expenses = this.table('expenses');
        this.receipts = this.table('receipts');
        this.calendar_days = this.table('calendar_days');
        this.tax_calculations = this.table('tax_calculations');
        this.sync_queue = this.table('sync_queue');
        this.settings = this.table('settings');

        // NEW: Auth table references (Phase 14)
        this.profiles = this.table('profiles');
        this.entity_shares = this.table('entity_shares');
        this.entity_invitations = this.table('entity_invitations');
        this.user_sessions = this.table('user_sessions');
      }
    }

    const db = new AppDatabase();

    // =====================================================
    // Money Utilities (Integer Cents)
    // =====================================================

    const MoneyUtils = {
      // Convert user input (euros) to storage (cents)
      eurosToCents(euroValue) {
        if (euroValue === null || euroValue === undefined || euroValue === '') {
          return 0;
        }
        if (typeof euroValue === 'string') {
          // Handle comma as decimal separator (European format)
          euroValue = euroValue.replace(/\s/g, '').replace(',', '.');
        }
        return currency(euroValue, { precision: 2 }).intValue;
      },

      // Convert storage (cents) to numeric euros
      centsToEuros(cents) {
        if (cents === null || cents === undefined) return 0;
        return currency(cents, { fromCents: true, precision: 2 }).value;
      },

      // Format for display with currency symbol (Spanish locale)
      formatEuros(cents, locale = 'es-ES') {
        const euros = this.centsToEuros(cents);
        return new Intl.NumberFormat(locale, {
          style: 'currency',
          currency: 'EUR',
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }).format(euros);
      },

      // Format without symbol (for input fields)
      formatEurosPlain(cents) {
        const euros = this.centsToEuros(cents);
        return euros.toFixed(2);
      },

      // Banker's rounding for tax calculations
      roundCents(cents) {
        if (cents % 1 === 0.5 || cents % 1 === -0.5) {
          const floor = Math.floor(cents);
          return floor % 2 === 0 ? floor : Math.ceil(cents);
        }
        return Math.round(cents);
      },

      // Calculate IVA amount from base
      calculateIVA(baseCents, rate = 0.21) {
        return this.roundCents(baseCents * rate);
      },

      // Add amounts safely (all in cents)
      add(...centAmounts) {
        return centAmounts.reduce((sum, amt) => sum + (amt || 0), 0);
      },

      // Subtract amounts safely (all in cents)
      subtract(fromCents, ...subtractCents) {
        return subtractCents.reduce((result, amt) => result - (amt || 0), fromCents || 0);
      }
    };

    // =====================================================
    // Audit Fields Helper
    // =====================================================

    function auditFields(isCreate = true) {
      const now = new Date().toISOString();
      const userId = getCurrentUserId();

      if (isCreate) {
        return {
          created_at: now,
          updated_at: now,
          created_by: userId,
          updated_by: userId
        };
      }
      return {
        updated_at: now,
        updated_by: userId
      };
    }

    function getCurrentUserId() {
      // Will be implemented in Phase 14 (Auth)
      // For now, return placeholder
      return 'local-user';
    }

    // =====================================================
    // Sync Queue (Offline-First) - Phase 12
    // =====================================================

    const SyncQueue = {
      // Warning thresholds
      WARN_THRESHOLD: 100,
      ALERT_THRESHOLD: 500,
      CRITICAL_THRESHOLD: 1000,

      /**
       * Queue a data change for eventual sync
       * @param {string} tableName - Table that changed
       * @param {number} recordId - Record ID
       * @param {string} operation - 'CREATE', 'UPDATE', 'DELETE'
       * @param {object} data - Changed data
       * @returns {Promise<number>} Queue entry ID
       */
      async queueChange(tableName, recordId, operation, data) {
        const entry = {
          table_name: tableName,
          record_id: recordId,
          operation: operation,
          data: JSON.stringify(data),
          created_at: new Date().toISOString(),
          retry_count: 0,
          last_error: null
        };

        const id = await db.sync_queue.add(entry);
        await this.updateIndicator();

        console.log(`Queued: ${operation} ${tableName}/${recordId}`);
        return id;
      },

      /**
       * Get pending sync queue count
       * @returns {Promise<number>} Count
       */
      async getPendingCount() {
        return db.sync_queue.count();
      },

      /**
       * Get all pending queue entries
       * @returns {Promise<Array>} Queue entries
       */
      async getPending() {
        return db.sync_queue.orderBy('created_at').toArray();
      },

      /**
       * Update the sync status indicator in UI
       */
      async updateIndicator() {
        const count = await this.getPendingCount();
        let indicator = document.getElementById('sync-indicator');

        // Create indicator if it doesn't exist
        if (!indicator) {
          indicator = this.createIndicator();
        }

        // Update status
        const statusEl = indicator.querySelector('.sync-status-text');
        const badgeEl = indicator.querySelector('.sync-badge');

        if (count === 0) {
          statusEl.textContent = 'Synced';
          indicator.className = 'sync-indicator synced';
          badgeEl.style.display = 'none';
        } else {
          statusEl.textContent = `${count} pending`;
          indicator.className = 'sync-indicator pending';
          badgeEl.textContent = count > 99 ? '99+' : count;
          badgeEl.style.display = 'flex';

          // Check thresholds and show warnings
          if (count >= this.CRITICAL_THRESHOLD) {
            indicator.classList.add('critical');
            this.showWarning('critical', count);
          } else if (count >= this.ALERT_THRESHOLD) {
            indicator.classList.add('alert');
            this.showWarning('alert', count);
          } else if (count >= this.WARN_THRESHOLD) {
            this.showWarning('warn', count);
          }
        }
      },

      /**
       * Create the sync indicator UI element
       * @returns {HTMLElement} Indicator element
       */
      createIndicator() {
        const indicator = document.createElement('div');
        indicator.id = 'sync-indicator';
        indicator.className = 'sync-indicator synced';
        indicator.innerHTML = `
          <svg class="sync-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12a9 9 0 11-9-9 9.75 9.75 0 016.74 2.74"/>
            <path d="M21 3v9h-9"/>
          </svg>
          <span class="sync-status-text">Synced</span>
          <span class="sync-badge" style="display: none;">0</span>
        `;

        // Add click handler to show queue details
        indicator.addEventListener('click', () => this.showQueueDetails());

        // Insert into page (top-right corner)
        document.body.appendChild(indicator);
        return indicator;
      },

      /**
       * Show warning notification for large queue
       * @param {string} level - 'warn', 'alert', 'critical'
       * @param {number} count - Queue count
       */
      showWarning(level, count) {
        // Avoid repeated warnings (only show once per session per threshold)
        const key = `sync_warning_${level}`;
        if (sessionStorage.getItem(key)) return;
        sessionStorage.setItem(key, 'shown');

        const messages = {
          warn: `You have ${count} unsynced changes. Consider connecting to sync.`,
          alert: `Warning: ${count} unsynced changes. Connect to sync soon to avoid data loss.`,
          critical: `Critical: ${count} unsynced changes! Connect immediately to sync your data.`
        };

        console.warn(`[SyncQueue] ${messages[level]}`);

        // Show UI notification if available (Phase 5 notification system)
        if (typeof showNotification === 'function') {
          showNotification({
            type: level === 'critical' ? 'error' : 'warning',
            message: messages[level],
            duration: level === 'critical' ? 0 : 10000 // Critical stays until dismissed
          });
        }
      },

      /**
       * Show queue details modal/panel
       */
      async showQueueDetails() {
        const entries = await this.getPending();
        console.log('Sync queue entries:', entries);

        // Group by table
        const byTable = {};
        for (const entry of entries) {
          if (!byTable[entry.table_name]) {
            byTable[entry.table_name] = { CREATE: 0, UPDATE: 0, DELETE: 0 };
          }
          byTable[entry.table_name][entry.operation]++;
        }

        console.table(byTable);

        // Simple alert for now (replace with modal in UI phase)
        if (entries.length > 0) {
          const summary = Object.entries(byTable)
            .map(([table, ops]) => `${table}: ${ops.CREATE}C/${ops.UPDATE}U/${ops.DELETE}D`)
            .join('\n');
          alert(`Sync Queue (${entries.length} items)\n\n${summary}\n\nCloud sync coming in Phase 27.`);
        } else {
          alert('All data is synced!');
        }
      },

      /**
       * Clear sync queue (for testing or after successful sync)
       * @param {number[]} ids - Specific IDs to clear (optional, clears all if not provided)
       */
      async clearQueue(ids = null) {
        if (ids) {
          await db.sync_queue.bulkDelete(ids);
        } else {
          await db.sync_queue.clear();
        }
        await this.updateIndicator();
      }
    };

    // =====================================================
    // Data Manager (Soft Delete & Retention) - Phase 12
    // =====================================================

    const DataManager = {
      // Tables that support soft delete (financial records)
      SOFT_DELETE_TABLES: ['invoices', 'expenses', 'receipts', 'clients', 'entities', 'projects'],

      // Retention period in years (Spanish tax audit statute of limitations)
      RETENTION_YEARS: 4,

      // Restore window in days
      RESTORE_WINDOW_DAYS: 30,

      /**
       * Soft delete a record (set deleted_at, queue for sync)
       * @param {string} tableName - Table to delete from
       * @param {number} id - Record ID
       * @returns {Promise<boolean>} Success status
       */
      async softDelete(tableName, id) {
        if (!this.SOFT_DELETE_TABLES.includes(tableName)) {
          throw new Error(`Table ${tableName} does not support soft delete`);
        }

        const record = await db[tableName].get(id);
        if (!record) {
          throw new Error(`Record not found: ${tableName}/${id}`);
        }

        if (record.deleted_at) {
          throw new Error('Record already deleted');
        }

        const now = new Date().toISOString();
        const changes = {
          deleted_at: now,
          ...auditFields(false)
        };

        await db[tableName].update(id, changes);
        await SyncQueue.queueChange(tableName, id, 'UPDATE', changes);

        console.log(`Soft deleted: ${tableName}/${id}`);
        return true;
      },

      /**
       * Restore a soft-deleted record (within 30-day window)
       * @param {string} tableName - Table to restore from
       * @param {number} id - Record ID
       * @returns {Promise<boolean>} Success status
       */
      async restore(tableName, id) {
        const record = await db[tableName].get(id);
        if (!record) {
          throw new Error(`Record not found: ${tableName}/${id}`);
        }

        if (!record.deleted_at) {
          throw new Error('Record is not deleted');
        }

        // Check restore window
        const deletedDate = new Date(record.deleted_at);
        const daysSinceDeleted = (Date.now() - deletedDate.getTime()) / (1000 * 60 * 60 * 24);

        if (daysSinceDeleted > this.RESTORE_WINDOW_DAYS) {
          throw new Error(`Cannot restore: Record deleted more than ${this.RESTORE_WINDOW_DAYS} days ago. ` +
            `Record will be retained for audit until ${this.RETENTION_YEARS}-year purge.`);
        }

        const changes = {
          deleted_at: null,
          ...auditFields(false)
        };

        await db[tableName].update(id, changes);
        await SyncQueue.queueChange(tableName, id, 'UPDATE', changes);

        console.log(`Restored: ${tableName}/${id}`);
        return true;
      },

      /**
       * Get active records (not deleted)
       * @param {string} tableName - Table to query
       * @param {number} entityId - Entity filter (optional)
       * @returns {Promise<Array>} Active records
       */
      async getActive(tableName, entityId = null) {
        let query = db[tableName];

        if (entityId && db[tableName].schema.indexes.some(i => i.name === '[entity_id+deleted_at]')) {
          // Use compound index if available
          return query.where('[entity_id+deleted_at]').equals([entityId, null]).toArray();
        }

        // Fallback to filter
        let results = await query.toArray();
        results = results.filter(r => r.deleted_at === null || r.deleted_at === undefined);

        if (entityId) {
          results = results.filter(r => r.entity_id === entityId);
        }

        return results;
      },

      /**
       * Get deleted records (for "Deleted Items" view)
       * @param {string} tableName - Table to query
       * @param {number} entityId - Entity filter (optional)
       * @returns {Promise<Array>} Deleted records with metadata
       */
      async getDeleted(tableName, entityId = null) {
        let results = await db[tableName].toArray();
        results = results.filter(r => r.deleted_at !== null && r.deleted_at !== undefined);

        if (entityId) {
          results = results.filter(r => r.entity_id === entityId);
        }

        // Add metadata for UI
        const now = Date.now();
        return results.map(r => {
          const deletedDate = new Date(r.deleted_at);
          const daysSinceDeleted = Math.floor((now - deletedDate.getTime()) / (1000 * 60 * 60 * 24));
          const canRestore = daysSinceDeleted <= this.RESTORE_WINDOW_DAYS;

          return {
            ...r,
            _daysSinceDeleted: daysSinceDeleted,
            _canRestore: canRestore,
            _restoreDeadline: canRestore
              ? new Date(deletedDate.getTime() + (this.RESTORE_WINDOW_DAYS * 24 * 60 * 60 * 1000)).toISOString()
              : null
          };
        });
      },

      /**
       * Auto-purge records deleted more than RETENTION_YEARS ago
       * Called on app initialization
       * @returns {Promise<{table: string, count: number}[]>} Purge results
       */
      async autoPurgeOldRecords() {
        const cutoffDate = new Date();
        cutoffDate.setFullYear(cutoffDate.getFullYear() - this.RETENTION_YEARS);
        const cutoff = cutoffDate.toISOString();

        const results = [];

        for (const tableName of this.SOFT_DELETE_TABLES) {
          try {
            const oldRecords = await db[tableName]
              .filter(r => r.deleted_at && r.deleted_at < cutoff)
              .toArray();

            if (oldRecords.length > 0) {
              const ids = oldRecords.map(r => r.id);
              await db[tableName].bulkDelete(ids);

              // Queue hard deletes for sync
              for (const record of oldRecords) {
                await SyncQueue.queueChange(tableName, record.id, 'DELETE', { id: record.id });
              }

              results.push({ table: tableName, count: oldRecords.length });
              console.log(`Auto-purged ${oldRecords.length} records from ${tableName} (deleted before ${cutoff})`);
            }
          } catch (error) {
            console.error(`Error purging ${tableName}:`, error);
          }
        }

        return results;
      },

      /**
       * Check if record is within restore window
       * @param {object} record - Record with deleted_at field
       * @returns {boolean} Can restore
       */
      canRestore(record) {
        if (!record.deleted_at) return false;
        const deletedDate = new Date(record.deleted_at);
        const daysSinceDeleted = (Date.now() - deletedDate.getTime()) / (1000 * 60 * 60 * 24);
        return daysSinceDeleted <= this.RESTORE_WINDOW_DAYS;
      }
    };

    // =====================================================
    // Invoice Manager (VeriFactu Compliance) - Phase 12
    // =====================================================

    const InvoiceManager = {
      // Invoice series types
      SERIES: {
        F: 'F', // Factura ordinaria (regular invoice)
        R: 'R', // Factura rectificativa (correcting invoice)
        S: 'S'  // Factura simplificada (simplified invoice, <400 EUR)
      },

      // Invoice statuses
      STATUS: {
        DRAFT: 'draft',
        SENT: 'sent',
        PAID: 'paid',
        OVERDUE: 'overdue',
        ARCHIVED: 'archived'
      },

      /**
       * Get next invoice number in sequence (thread-safe via transaction)
       * Format: F-2026-0001, R-2026-0001, etc.
       * @param {number} entityId - Entity ID
       * @param {string} series - Invoice series (F, R, S)
       * @returns {Promise<string>} Invoice number
       */
      async getNextInvoiceNumber(entityId, series = 'F') {
        if (!Object.values(this.SERIES).includes(series)) {
          throw new Error(`Invalid invoice series: ${series}. Must be F, R, or S.`);
        }

        return db.transaction('rw', db.invoice_sequences, async () => {
          // Find or create sequence for this entity+series
          let seq = await db.invoice_sequences
            .where('[entity_id+series]')
            .equals([entityId, series])
            .first();

          if (!seq) {
            // First invoice in this series for this entity
            seq = {
              entity_id: entityId,
              series: series,
              last_number: 0
            };
            seq.id = await db.invoice_sequences.add(seq);
          }

          // Increment sequence
          seq.last_number++;
          await db.invoice_sequences.update(seq.id, { last_number: seq.last_number });

          // Format: {series}-{year}-{4-digit-padded-number}
          const year = new Date().getFullYear();
          const paddedNum = String(seq.last_number).padStart(4, '0');
          return `${series}-${year}-${paddedNum}`;
        });
      },

      /**
       * Get current sequence number (without incrementing)
       * @param {number} entityId - Entity ID
       * @param {string} series - Invoice series
       * @returns {Promise<number>} Current last number
       */
      async getCurrentNumber(entityId, series = 'F') {
        const seq = await db.invoice_sequences
          .where('[entity_id+series]')
          .equals([entityId, series])
          .first();

        return seq ? seq.last_number : 0;
      },

      /**
       * Archive an invoice (soft delete for drafts only)
       * VeriFactu requires: sent/paid invoices CANNOT be deleted
       * @param {number} invoiceId - Invoice ID
       * @returns {Promise<boolean>} Success
       */
      async archiveInvoice(invoiceId) {
        const invoice = await db.invoices.get(invoiceId);

        if (!invoice) {
          throw new Error(`Invoice not found: ${invoiceId}`);
        }

        if (invoice.deleted_at) {
          throw new Error('Invoice already archived');
        }

        // CRITICAL: Only draft invoices can be archived
        if (invoice.status !== this.STATUS.DRAFT) {
          throw new Error(
            `Cannot archive ${invoice.status} invoice. ` +
            `VeriFactu requires sent/paid invoices to remain in sequence. ` +
            `To correct errors, create a factura rectificativa (series R). ` +
            `To cancel the operation, issue a credit note.`
          );
        }

        // Archive (soft delete) the draft
        const now = new Date().toISOString();
        const changes = {
          deleted_at: now,
          status: this.STATUS.ARCHIVED,
          ...auditFields(false)
        };

        await db.invoices.update(invoiceId, changes);
        await SyncQueue.queueChange('invoices', invoiceId, 'UPDATE', changes);

        console.log(`Archived draft invoice: ${invoice.invoice_number}`);
        return true;
      },

      /**
       * Create a rectifying invoice (factura rectificativa)
       * Links to original invoice and uses series 'R'
       * @param {number} originalInvoiceId - Original invoice to correct
       * @param {object} corrections - Correction data
       * @returns {Promise<{id: number, invoice_number: string}>}
       */
      async createRectifyingInvoice(originalInvoiceId, corrections) {
        const original = await db.invoices.get(originalInvoiceId);

        if (!original) {
          throw new Error(`Original invoice not found: ${originalInvoiceId}`);
        }

        if (original.status === this.STATUS.DRAFT) {
          throw new Error('Cannot create rectificativa for draft invoice. Edit the draft directly.');
        }

        if (original.deleted_at) {
          throw new Error('Cannot create rectificativa for archived invoice.');
        }

        // Valid correction reasons (per Real Decreto 1619/2012 Art. 15)
        const validReasons = [
          'error_datos_fiscales',     // Error in fiscal data (NIF, name, address)
          'modificacion_base',        // Modification of taxable base
          'descuento_posterior',      // Subsequent discount
          'devolucion_envases',       // Return of packaging
          'impago_concurso',          // Non-payment in insolvency proceedings
          'otros'                     // Other (requires description)
        ];

        if (!corrections.reason || !validReasons.includes(corrections.reason)) {
          throw new Error(`Invalid correction reason. Must be one of: ${validReasons.join(', ')}`);
        }

        // Get next R-series number
        const invoiceNumber = await this.getNextInvoiceNumber(original.entity_id, this.SERIES.R);

        const rectifying = {
          entity_id: original.entity_id,
          client_id: original.client_id,
          series: this.SERIES.R,
          invoice_number: invoiceNumber,
          status: this.STATUS.DRAFT,
          date_issued: new Date().toISOString().split('T')[0],
          date_due: null,

          // Link to original
          original_invoice_id: original.id,
          original_invoice_number: original.invoice_number,
          correction_reason: corrections.reason,
          correction_description: corrections.description || null,

          // Amounts (negative for credit, positive for debit)
          subtotal_cents: corrections.subtotal_cents || 0,
          iva_cents: corrections.iva_cents || 0,
          irpf_cents: corrections.irpf_cents || 0,
          total_cents: corrections.total_cents || 0,

          deleted_at: null,
          ...auditFields(true)
        };

        const id = await db.invoices.add(rectifying);
        await SyncQueue.queueChange('invoices', id, 'CREATE', rectifying);

        console.log(`Created rectifying invoice: ${invoiceNumber} for original: ${original.invoice_number}`);
        return { id, invoice_number: invoiceNumber };
      },

      /**
       * Get all invoices for an entity (active only by default)
       * @param {number} entityId - Entity ID
       * @param {object} options - Query options
       * @returns {Promise<Array>} Invoices
       */
      async getInvoices(entityId, options = {}) {
        const { includeArchived = false, status = null, series = null } = options;

        let query = db.invoices.where('entity_id').equals(entityId);
        let results = await query.toArray();

        // Filter archived unless requested
        if (!includeArchived) {
          results = results.filter(inv => !inv.deleted_at);
        }

        // Filter by status if specified
        if (status) {
          results = results.filter(inv => inv.status === status);
        }

        // Filter by series if specified
        if (series) {
          results = results.filter(inv => inv.series === series);
        }

        // Sort by date descending
        return results.sort((a, b) => b.date_issued.localeCompare(a.date_issued));
      },

      /**
       * Validate invoice number format
       * @param {string} invoiceNumber - Number to validate
       * @returns {boolean} Is valid
       */
      isValidInvoiceNumber(invoiceNumber) {
        // Format: {series}-{year}-{number}
        const pattern = /^[FRS]-\d{4}-\d{4,}$/;
        return pattern.test(invoiceNumber);
      },

      /**
       * Parse invoice number components
       * @param {string} invoiceNumber - Number to parse
       * @returns {{series: string, year: number, number: number}|null}
       */
      parseInvoiceNumber(invoiceNumber) {
        if (!this.isValidInvoiceNumber(invoiceNumber)) return null;

        const [series, year, num] = invoiceNumber.split('-');
        return {
          series,
          year: parseInt(year, 10),
          number: parseInt(num, 10)
        };
      }
    };

    // =====================================================
    // PHASE 13: Multi-Entity Architecture
    // =====================================================

    /**
     * Entity type constants for type-safe entity handling
     * Used throughout the multi-entity architecture
     */
    const ENTITY_TYPE = Object.freeze({
      AUTONOMO: 'autonomo',
      SOCIEDAD_LIMITADA: 'sociedad_limitada'
    });

    /**
     * Spanish Tax ID Validator
     * Validates NIF, CIF, and NIE with official check digit algorithms
     *
     * NIF (Numero de Identificacion Fiscal): For individual persons
     *   Format: 8 digits + 1 control letter
     *   Algorithm: letter = NIF_LETTERS[number % 23]
     *
     * NIE (Numero de Identidad de Extranjero): For foreign residents
     *   Format: X/Y/Z + 7 digits + 1 control letter
     *   Algorithm: Replace prefix (X=0, Y=1, Z=2), then NIF algorithm
     *
     * CIF (Codigo de Identificacion Fiscal): For legal entities
     *   Format: 1 letter (org type) + 7 digits + 1 control (letter or digit)
     *   Algorithm: Sum with odd/even position weighting, control varies by org type
     */
    const SpanishTaxIdValidator = {
      // NIF check letter lookup table (official AEAT sequence)
      NIF_LETTERS: 'TRWAGMYFPDXBNJZSQVHLCKE',

      // CIF control letter lookup (for letter-control types)
      CIF_CONTROL_LETTERS: 'JABCDEFGHI',

      // CIF organization types that MUST use letter control
      CIF_LETTER_CONTROL: ['K', 'P', 'Q', 'S'],

      // CIF organization types that MUST use number control
      CIF_NUMBER_CONTROL: ['A', 'B', 'E', 'H'],

      // Organization type descriptions
      ORG_TYPES: {
        'A': 'Sociedad Anonima',
        'B': 'Sociedad de Responsabilidad Limitada',
        'C': 'Sociedad Colectiva',
        'D': 'Sociedad Comanditaria',
        'E': 'Comunidad de Bienes',
        'F': 'Sociedad Cooperativa',
        'G': 'Asociacion o Fundacion',
        'H': 'Comunidad de Propietarios',
        'J': 'Sociedad Civil',
        'K': 'Entidad Extranjera (Espana)',
        'L': 'Entidad Extranjera (Sin Establecimiento)',
        'M': 'Entidad Extranjera (Con Establecimiento)',
        'N': 'Entidad Extranjera',
        'P': 'Corporacion Local',
        'Q': 'Organismo Publico',
        'R': 'Congregacion o Institucion Religiosa',
        'S': 'Organo de la Administracion del Estado',
        'U': 'Union Temporal de Empresas',
        'V': 'Otros tipos no definidos',
        'W': 'Establecimientos permanentes de entidades no residentes'
      },

      /**
       * Clean input: trim, uppercase, remove spaces and hyphens
       * @param {string} input - Raw input
       * @returns {string} Cleaned input
       */
      _clean(input) {
        if (!input) return '';
        return input.toString().trim().toUpperCase().replace(/[\s-]/g, '');
      },

      /**
       * Get organization type description from CIF letter
       * @param {string} letter - First letter of CIF
       * @returns {string} Organization type description
       */
      getOrganizationType(letter) {
        return this.ORG_TYPES[letter] || 'Tipo desconocido';
      },

      /**
       * Validate NIF (Spanish personal tax ID)
       * Format: 8 digits + 1 letter
       * @param {string} nif - NIF to validate
       * @returns {{valid: boolean, error?: string, formatted?: string}}
       */
      validateNIF(nif) {
        const cleaned = this._clean(nif);

        if (!cleaned) {
          return { valid: false, error: 'NIF requerido' };
        }

        // Format: 8 digits + 1 letter
        const match = cleaned.match(/^(\d{8})([A-Z])$/);

        if (!match) {
          return { valid: false, error: 'Formato NIF invalido (8 digitos + letra)' };
        }

        const [, digits, letter] = match;
        const expectedLetter = this.NIF_LETTERS[parseInt(digits, 10) % 23];

        if (letter !== expectedLetter) {
          return {
            valid: false,
            error: `Letra de control incorrecta (esperada: ${expectedLetter})`
          };
        }

        return { valid: true, formatted: cleaned };
      },

      /**
       * Validate NIE (Foreign resident tax ID)
       * Format: X/Y/Z + 7 digits + 1 letter
       * @param {string} nie - NIE to validate
       * @returns {{valid: boolean, error?: string, formatted?: string}}
       */
      validateNIE(nie) {
        const cleaned = this._clean(nie);

        if (!cleaned) {
          return { valid: false, error: 'NIE requerido' };
        }

        // Format: X/Y/Z + 7 digits + 1 letter
        const match = cleaned.match(/^([XYZ])(\d{7})([A-Z])$/);

        if (!match) {
          return { valid: false, error: 'Formato NIE invalido (X/Y/Z + 7 digitos + letra)' };
        }

        const [, prefix, digits, letter] = match;

        // Convert prefix to number: X=0, Y=1, Z=2
        const prefixValue = { 'X': '0', 'Y': '1', 'Z': '2' }[prefix];
        const fullNumber = parseInt(prefixValue + digits, 10);
        const expectedLetter = this.NIF_LETTERS[fullNumber % 23];

        if (letter !== expectedLetter) {
          return {
            valid: false,
            error: `Letra de control incorrecta (esperada: ${expectedLetter})`
          };
        }

        return { valid: true, formatted: cleaned };
      },

      /**
       * Validate CIF (Legal entity tax ID)
       * Format: 1 org type letter + 7 digits + 1 control (letter or digit)
       * @param {string} cif - CIF to validate
       * @returns {{valid: boolean, error?: string, formatted?: string, organizationType?: string}}
       */
      validateCIF(cif) {
        const cleaned = this._clean(cif);

        if (!cleaned) {
          return { valid: false, error: 'CIF requerido' };
        }

        // Format: org letter + 7 digits + control (letter or digit)
        const match = cleaned.match(/^([ABCDEFGHJKLMNPQRSUVW])(\d{7})([0-9A-J])$/);

        if (!match) {
          return { valid: false, error: 'Formato CIF invalido (letra + 7 digitos + control)' };
        }

        const [, orgLetter, digits, control] = match;

        // Calculate control digit/letter using official algorithm
        let sumEven = 0;
        let sumOdd = 0;

        for (let i = 0; i < 7; i++) {
          const digit = parseInt(digits[i], 10);

          if (i % 2 === 0) {
            // Odd positions (1st, 3rd, 5th, 7th): multiply by 2, sum digits if > 9
            const doubled = digit * 2;
            sumOdd += doubled > 9 ? doubled - 9 : doubled;
          } else {
            // Even positions (2nd, 4th, 6th): just sum
            sumEven += digit;
          }
        }

        const total = sumOdd + sumEven;
        const controlNumber = (10 - (total % 10)) % 10;
        const controlLetter = this.CIF_CONTROL_LETTERS[controlNumber];

        // Determine expected control based on organization type
        let expectedControl;
        let isValid = false;

        if (this.CIF_LETTER_CONTROL.includes(orgLetter)) {
          // These types MUST use letter control
          expectedControl = controlLetter;
          isValid = control === controlLetter;
        } else if (this.CIF_NUMBER_CONTROL.includes(orgLetter)) {
          // These types MUST use number control
          expectedControl = controlNumber.toString();
          isValid = control === controlNumber.toString();
        } else {
          // Other types can use either letter or number
          expectedControl = `${controlNumber} o ${controlLetter}`;
          isValid = control === controlNumber.toString() || control === controlLetter;
        }

        if (!isValid) {
          return {
            valid: false,
            error: `Digito de control incorrecto (esperado: ${expectedControl})`
          };
        }

        return {
          valid: true,
          formatted: cleaned,
          organizationType: this.getOrganizationType(orgLetter)
        };
      },

      /**
       * Auto-detect and validate any Spanish tax ID
       * @param {string} taxId - Tax ID to validate
       * @returns {{valid: boolean, error?: string, formatted?: string, type?: string, organizationType?: string}}
       */
      validate(taxId) {
        const cleaned = this._clean(taxId);

        if (!cleaned) {
          return { valid: false, error: 'Identificador fiscal requerido' };
        }

        // Detect type by format
        // NIE: starts with X, Y, or Z
        if (/^[XYZ]/.test(cleaned)) {
          const result = this.validateNIE(cleaned);
          return { ...result, type: 'NIE' };
        }

        // CIF: starts with organization letter (not X/Y/Z, not digit)
        if (/^[ABCDEFGHJKLMNPQRSUVW]/.test(cleaned)) {
          const result = this.validateCIF(cleaned);
          return { ...result, type: 'CIF' };
        }

        // NIF: starts with digit
        if (/^\d/.test(cleaned)) {
          const result = this.validateNIF(cleaned);
          return { ...result, type: 'NIF' };
        }

        return { valid: false, error: 'Formato de identificador fiscal no reconocido' };
      }
    };

    // =====================================================
    // Entity Context (Current Entity State Management)
    // =====================================================

    const EntityContext = (() => {
      let currentEntity = null;
      const observers = new Set();

      return {
        // Get current entity object
        get current() {
          return currentEntity;
        },

        // Get current entity ID (convenience)
        get entityId() {
          return currentEntity?.id ?? null;
        },

        // Set current entity and notify observers
        async setEntity(entityId) {
          // Skip if already selected
          if (entityId === currentEntity?.id) return;

          // Fetch entity from database
          const entity = await db.entities.get(entityId);
          if (!entity) {
            throw new Error(`Entity ${entityId} not found`);
          }
          if (entity.deleted_at) {
            throw new Error(`Entity ${entityId} is deleted`);
          }
          if (!entity.is_active) {
            throw new Error(`Entity ${entityId} is archived`);
          }

          currentEntity = entity;

          // Persist selection to settings
          await db.settings.put({
            key: 'current_entity_id',
            value: entityId,
            updated_at: new Date().toISOString()
          });

          // Notify all observers
          this.notify();
        },

        // Clear entity (logout/no entity state)
        clear() {
          currentEntity = null;
          this.notify();
        },

        // Subscribe to entity changes
        subscribe(callback) {
          observers.add(callback);
          // Return unsubscribe function
          return () => observers.delete(callback);
        },

        // Notify all observers of entity change
        notify() {
          observers.forEach(callback => {
            try {
              callback(currentEntity);
            } catch (error) {
              console.error('EntityContext observer error:', error);
            }
          });
        },

        // Initialize from persisted selection (call on app startup)
        async initialize() {
          try {
            const setting = await db.settings.get('current_entity_id');
            if (setting?.value) {
              await this.setEntity(setting.value);
              return true;
            }
          } catch (error) {
            console.warn('Could not restore entity selection:', error);
          }
          return false;
        },

        // Get count of observers (for debugging)
        get observerCount() {
          return observers.size;
        }
      };
    })();

    // =====================================================
    // Entity Manager (CRUD Operations)
    // =====================================================

    const EntityManager = {
      // Create new entity (Autonomo or SL)
      async createEntity(entityData) {
        const { type, ...data } = entityData;

        // Validate entity type
        if (!Object.values(ENTITY_TYPE).includes(type)) {
          throw new Error(`Tipo de entidad invlido: ${type}`);
        }

        // Validate tax ID based on type
        let taxIdField, validatedTaxId;
        if (type === ENTITY_TYPE.AUTONOMO) {
          const result = SpanishTaxIdValidator.validateNIF(data.nif);
          if (!result.valid) {
            throw new Error(`NIF invlido: ${result.error}`);
          }
          validatedTaxId = result.formatted;
          taxIdField = 'nif';
        } else {
          const result = SpanishTaxIdValidator.validateCIF(data.cif);
          if (!result.valid) {
            throw new Error(`CIF invlido: ${result.error}`);
          }
          validatedTaxId = result.formatted;
          taxIdField = 'cif';
        }

        // Check for duplicate tax ID
        const existing = await db.entities
          .where('nif_cif')
          .equals(validatedTaxId)
          .filter(e => !e.deleted_at)
          .first();

        if (existing) {
          throw new Error(`Ya existe una entidad con este ${taxIdField.toUpperCase()}`);
        }

        // Build entity record
        const entity = {
          type,
          nif_cif: validatedTaxId,
          name: data.name?.trim(),
          is_active: true,
          deleted_at: null,
          ...auditFields(true)
        };

        // Add type-specific fields
        if (type === ENTITY_TYPE.AUTONOMO) {
          entity.domicilio_fiscal = data.domicilio_fiscal?.trim() || '';
          entity.iae_codes = data.iae_codes || [];
          entity.iae_primary = data.iae_primary?.trim() || '';
          entity.fecha_alta = data.fecha_alta || null;
        } else {
          entity.domicilio_social = data.domicilio_social?.trim() || '';
          entity.registro_mercantil = {
            provincia: data.registro_mercantil?.provincia?.trim() || '',
            tomo: data.registro_mercantil?.tomo?.trim() || '',
            libro: data.registro_mercantil?.libro?.trim() || '',
            folio: data.registro_mercantil?.folio?.trim() || '',
            seccion: data.registro_mercantil?.seccion?.trim() || '',
            hoja: data.registro_mercantil?.hoja?.trim() || '',
            inscripcion: data.registro_mercantil?.inscripcion?.trim() || ''
          };
          entity.fecha_constitucion = data.fecha_constitucion || null;
          entity.capital_social_cents = data.capital_social_cents || 300000; // 3000 EUR minimum
        }

        // Insert entity
        const id = await db.entities.add(entity);

        // Queue for sync
        await SyncQueue.queueChange('entities', id, 'CREATE', entity);

        // Auto-select if first entity
        const entityCount = await db.entities
          .filter(e => !e.deleted_at && e.is_active)
          .count();

        if (entityCount === 1) {
          await EntityContext.setEntity(id);
        }

        // Check for dual activity after creation (Phase 13-05)
        setTimeout(() => DualActivityDetector.checkAndWarn(), 100);

        return id;
      },

      // Get entity by ID
      async getEntity(entityId) {
        return db.entities.get(entityId);
      },

      // Get all entities (including archived, excluding deleted)
      async getAllEntities() {
        return db.entities
          .filter(e => !e.deleted_at)
          .toArray();
      },

      // Get only active (non-archived) entities
      async getActiveEntities() {
        return db.entities
          .filter(e => !e.deleted_at && e.is_active)
          .toArray();
      },

      // Get archived entities
      async getArchivedEntities() {
        return db.entities
          .filter(e => !e.deleted_at && !e.is_active)
          .toArray();
      },

      // Update entity
      async updateEntity(entityId, updates) {
        const entity = await this.getEntity(entityId);
        if (!entity) throw new Error('Entidad no encontrada');
        if (entity.deleted_at) throw new Error('Entidad eliminada');

        // If updating tax ID, validate it
        if (updates.nif || updates.cif) {
          const taxId = updates.nif || updates.cif;
          const result = SpanishTaxIdValidator.validate(taxId);
          if (!result.valid) {
            throw new Error(`Identificador fiscal invlido: ${result.error}`);
          }
          updates.nif_cif = result.formatted;
        }

        // Apply updates
        const updatedFields = {
          ...updates,
          updated_at: new Date().toISOString()
        };

        await db.entities.update(entityId, updatedFields);
        await SyncQueue.queueChange('entities', entityId, 'UPDATE', updatedFields);

        // Refresh EntityContext if this is the current entity
        if (EntityContext.entityId === entityId) {
          const refreshed = await this.getEntity(entityId);
          // Force notify observers with updated data
          await EntityContext.setEntity(entityId);
        }

        return true;
      },

      // Archive entity (soft deactivate)
      async archiveEntity(entityId) {
        const entity = await this.getEntity(entityId);
        if (!entity) throw new Error('Entidad no encontrada');
        if (!entity.is_active) throw new Error('Entidad ya archivada');

        // If archiving current entity, switch to another
        if (EntityContext.entityId === entityId) {
          const otherEntity = await db.entities
            .filter(e => e.id !== entityId && !e.deleted_at && e.is_active)
            .first();

          if (otherEntity) {
            await EntityContext.setEntity(otherEntity.id);
          } else {
            EntityContext.clear();
          }
        }

        await db.entities.update(entityId, {
          is_active: false,
          updated_at: new Date().toISOString()
        });

        await SyncQueue.queueChange('entities', entityId, 'UPDATE', { is_active: false });

        // Check dual activity (archiving may hide warning) - Phase 13-05
        setTimeout(() => DualActivityDetector.checkAndWarn(), 100);

        return true;
      },

      // Restore archived entity
      async restoreEntity(entityId) {
        const entity = await this.getEntity(entityId);
        if (!entity) throw new Error('Entidad no encontrada');
        if (entity.is_active) throw new Error('Entidad ya esta activa');
        if (entity.deleted_at) throw new Error('Entidad eliminada, no se puede restaurar');

        await db.entities.update(entityId, {
          is_active: true,
          updated_at: new Date().toISOString()
        });

        await SyncQueue.queueChange('entities', entityId, 'UPDATE', { is_active: true });

        // Check dual activity (restoration may trigger it) - Phase 13-05
        setTimeout(() => DualActivityDetector.checkAndWarn(), 100);

        return true;
      },

      // Permanently delete (only if within soft delete window - handled by DataManager)
      async deleteEntity(entityId) {
        return DataManager.softDelete('entities', entityId);
      }
    };

    // =====================================================
    // Entity Modal Controller
    // =====================================================

    const EntityModal = {
      selectedType: null,

      open() {
        this.reset();
        document.getElementById('entity-modal-overlay').classList.add('active');
        // Prevent body scroll when modal is open
        document.body.style.overflow = 'hidden';
      },

      close() {
        document.getElementById('entity-modal-overlay').classList.remove('active');
        document.body.style.overflow = '';
        this.reset();
      },

      reset() {
        this.selectedType = null;
        document.getElementById('entity-form-fields').style.display = 'none';
        document.getElementById('autonomo-fields').style.display = 'none';
        document.getElementById('sl-fields').style.display = 'none';
        document.getElementById('entity-modal-submit').disabled = true;

        // Reset type selector
        document.querySelectorAll('.entity-type-option').forEach(opt => {
          opt.classList.remove('selected');
        });

        // Reset form
        document.getElementById('entity-form').reset();

        // Clear validation states
        document.querySelectorAll('.entity-form__input').forEach(input => {
          input.classList.remove('valid', 'invalid');
        });
        document.querySelectorAll('.entity-form__error').forEach(err => {
          err.style.display = 'none';
        });
      },

      selectType(type) {
        this.selectedType = type;

        // Update type selector UI
        document.querySelectorAll('.entity-type-option').forEach(opt => {
          opt.classList.toggle('selected', opt.dataset.type === type);
        });

        // Show form fields
        document.getElementById('entity-form-fields').style.display = 'block';
        document.getElementById('autonomo-fields').style.display = type === 'autonomo' ? 'block' : 'none';
        document.getElementById('sl-fields').style.display = type === 'sociedad_limitada' ? 'block' : 'none';

        // Enable submit button
        document.getElementById('entity-modal-submit').disabled = false;

        // Focus first input
        if (type === 'autonomo') {
          document.getElementById('entity-nif').focus();
        } else {
          document.getElementById('entity-cif').focus();
        }
      },

      validateNIF() {
        const input = document.getElementById('entity-nif');
        const errorEl = document.getElementById('entity-nif-error');
        const value = input.value.trim();

        if (!value) {
          input.classList.remove('valid', 'invalid');
          errorEl.style.display = 'none';
          return false;
        }

        const result = SpanishTaxIdValidator.validateNIF(value);
        input.classList.toggle('valid', result.valid);
        input.classList.toggle('invalid', !result.valid);

        if (!result.valid) {
          errorEl.textContent = result.error;
          errorEl.style.display = 'block';
        } else {
          errorEl.style.display = 'none';
        }

        return result.valid;
      },

      validateCIF() {
        const input = document.getElementById('entity-cif');
        const errorEl = document.getElementById('entity-cif-error');
        const value = input.value.trim();

        if (!value) {
          input.classList.remove('valid', 'invalid');
          errorEl.style.display = 'none';
          return false;
        }

        const result = SpanishTaxIdValidator.validateCIF(value);
        input.classList.toggle('valid', result.valid);
        input.classList.toggle('invalid', !result.valid);

        if (!result.valid) {
          errorEl.textContent = result.error;
          errorEl.style.display = 'block';
        } else {
          errorEl.style.display = 'none';
        }

        return result.valid;
      },

      async submit() {
        if (!this.selectedType) return;

        try {
          let entityData;

          if (this.selectedType === 'autonomo') {
            // Validate required fields
            const nif = document.getElementById('entity-nif').value.trim();
            const nombre = document.getElementById('entity-nombre').value.trim();
            const domicilio = document.getElementById('entity-domicilio-fiscal').value.trim();

            if (!nif || !nombre || !domicilio) {
              alert('Por favor, completa todos los campos obligatorios.');
              return;
            }

            if (!this.validateNIF()) {
              document.getElementById('entity-nif').focus();
              return;
            }

            entityData = {
              type: ENTITY_TYPE.AUTONOMO,
              nif,
              name: nombre,
              domicilio_fiscal: domicilio,
              iae_primary: document.getElementById('entity-iae').value.trim(),
              iae_codes: document.getElementById('entity-iae').value.trim() ?
                [document.getElementById('entity-iae').value.trim()] : [],
              fecha_alta: document.getElementById('entity-fecha-alta').value || null
            };
          } else {
            // SL
            const cif = document.getElementById('entity-cif').value.trim();
            const razonSocial = document.getElementById('entity-razon-social').value.trim();
            const domicilio = document.getElementById('entity-domicilio-social').value.trim();

            if (!cif || !razonSocial || !domicilio) {
              alert('Por favor, completa todos los campos obligatorios.');
              return;
            }

            if (!this.validateCIF()) {
              document.getElementById('entity-cif').focus();
              return;
            }

            const capitalInput = document.getElementById('entity-capital-social').value;
            const capitalEuros = parseFloat(capitalInput) || 3000;

            entityData = {
              type: ENTITY_TYPE.SOCIEDAD_LIMITADA,
              cif,
              name: razonSocial,
              domicilio_social: domicilio,
              registro_mercantil: {
                provincia: document.getElementById('entity-rm-provincia').value.trim(),
                tomo: document.getElementById('entity-rm-tomo').value.trim(),
                libro: '',
                folio: document.getElementById('entity-rm-folio').value.trim(),
                seccion: document.getElementById('entity-rm-seccion').value.trim(),
                hoja: document.getElementById('entity-rm-hoja').value.trim(),
                inscripcion: document.getElementById('entity-rm-inscripcion').value.trim()
              },
              fecha_constitucion: document.getElementById('entity-fecha-constitucion').value || null,
              capital_social_cents: MoneyUtils.eurosToCents(capitalEuros)
            };
          }

          const entityId = await EntityManager.createEntity(entityData);
          console.log('Entity created:', entityId);

          this.close();

          // Refresh entity switcher
          if (entitySwitcher) {
            entitySwitcher.refresh();
          }

          // Show success notification
          showNotification(`Entidad "${entityData.name}" creada correctamente.`, 'success');

        } catch (error) {
          console.error('Error creating entity:', error);
          alert(`Error: ${error.message}`);
        }
      },

      // Initialize event listeners
      init() {
        // NIF validation on blur
        const nifInput = document.getElementById('entity-nif');
        if (nifInput) {
          nifInput.addEventListener('blur', () => this.validateNIF());
        }

        // CIF validation on blur
        const cifInput = document.getElementById('entity-cif');
        if (cifInput) {
          cifInput.addEventListener('blur', () => this.validateCIF());
        }

        // Close on overlay click
        const overlay = document.getElementById('entity-modal-overlay');
        if (overlay) {
          overlay.addEventListener('click', (e) => {
            if (e.target.id === 'entity-modal-overlay') {
              this.close();
            }
          });
        }

        // Close on Escape key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && document.getElementById('entity-modal-overlay')?.classList.contains('active')) {
            this.close();
          }
        });
      }
    };

    // =====================================================
    // Entity Switcher Component (Phase 13-04)
    // =====================================================

    function createEntitySwitcher(containerId) {
      const container = document.getElementById(containerId);
      if (!container) {
        console.warn('Entity switcher container not found:', containerId);
        return null;
      }

      // Create HTML structure
      container.innerHTML = `
        <div class="entity-switcher" role="combobox" aria-expanded="false"
             aria-haspopup="listbox" aria-labelledby="entity-switcher-label">
          <span id="entity-switcher-label" class="visually-hidden">Seleccionar entidad</span>

          <button class="entity-switcher__trigger"
                  aria-describedby="entity-switcher-label"
                  type="button">
            <span class="entity-switcher__icon" aria-hidden="true">&#128203;</span>
            <span class="entity-switcher__name">Seleccionar entidad...</span>
            <span class="entity-switcher__type"></span>
            <svg class="entity-switcher__chevron" aria-hidden="true"
                 viewBox="0 0 24 24" width="16" height="16">
              <path d="M7 10l5 5 5-5z" fill="currentColor"/>
            </svg>
          </button>

          <ul class="entity-switcher__menu" role="listbox"
              aria-labelledby="entity-switcher-label" hidden>
          </ul>
        </div>
      `;

      const trigger = container.querySelector('.entity-switcher__trigger');
      const menu = container.querySelector('.entity-switcher__menu');
      const nameEl = container.querySelector('.entity-switcher__name');
      const typeEl = container.querySelector('.entity-switcher__type');
      const iconEl = container.querySelector('.entity-switcher__icon');
      const wrapper = container.querySelector('.entity-switcher');

      let entities = [];
      let isOpen = false;

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Load entities from database
      async function loadEntities() {
        entities = await EntityManager.getActiveEntities();
        renderMenu();
      }

      // Render menu options
      function renderMenu() {
        const currentId = EntityContext.entityId;

        if (entities.length === 0) {
          menu.innerHTML = `
            <li class="entity-switcher__empty">
              No hay entidades creadas
            </li>
            <li class="entity-switcher__divider" role="separator"></li>
            <li class="entity-switcher__option entity-switcher__option--action"
                role="option"
                data-action="create"
                tabindex="-1">
              <span class="entity-switcher__option-icon" aria-hidden="true">&#10133;</span>
              <span class="entity-switcher__option-name">Crear nueva entidad</span>
            </li>
          `;
          return;
        }

        menu.innerHTML = entities.map(entity => `
          <li class="entity-switcher__option ${entity.id === currentId ? 'entity-switcher__option--active' : ''}"
              role="option"
              data-entity-id="${entity.id}"
              aria-selected="${entity.id === currentId}"
              tabindex="-1">
            <span class="entity-switcher__option-icon" aria-hidden="true">
              ${entity.type === 'autonomo' ? '&#128100;' : '&#127970;'}
            </span>
            <span class="entity-switcher__option-name">${escapeHtml(entity.name)}</span>
            <span class="entity-switcher__option-type">
              ${entity.type === 'autonomo' ? 'Autonomo' : 'S.L.'}
            </span>
            ${entity.id === currentId ? '<span class="entity-switcher__check" aria-hidden="true">&#10003;</span>' : ''}
          </li>
        `).join('');

        // Add "Create entity" option
        menu.innerHTML += `
          <li class="entity-switcher__divider" role="separator"></li>
          <li class="entity-switcher__option entity-switcher__option--action"
              role="option"
              data-action="create"
              tabindex="-1">
            <span class="entity-switcher__option-icon" aria-hidden="true">&#10133;</span>
            <span class="entity-switcher__option-name">Crear nueva entidad</span>
          </li>
        `;
      }

      // Update trigger display
      function updateTrigger(entity) {
        if (entity) {
          nameEl.textContent = entity.name;
          typeEl.textContent = entity.type === 'autonomo' ? 'Autonomo' : 'S.L.';
          iconEl.innerHTML = entity.type === 'autonomo' ? '&#128100;' : '&#127970;';
        } else {
          nameEl.textContent = 'Seleccionar entidad...';
          typeEl.textContent = '';
          iconEl.innerHTML = '&#128203;';
        }
        // Re-render menu to update active state
        renderMenu();
      }

      // Toggle menu open/closed
      function toggleMenu(open) {
        isOpen = open !== undefined ? open : !isOpen;
        wrapper.setAttribute('aria-expanded', isOpen);
        menu.hidden = !isOpen;

        if (isOpen) {
          // Focus active or first option
          const activeOption = menu.querySelector('.entity-switcher__option--active') ||
                               menu.querySelector('.entity-switcher__option');
          if (activeOption) activeOption.focus();
        }
      }

      // Handle entity selection
      async function selectEntity(entityId) {
        toggleMenu(false);
        trigger.focus();

        if (entityId && entityId !== EntityContext.entityId) {
          try {
            await EntityContext.setEntity(entityId);
          } catch (error) {
            console.error('Failed to switch entity:', error);
            alert(`Error al cambiar entidad: ${error.message}`);
          }
        }
      }

      // Event: Trigger click
      trigger.addEventListener('click', () => toggleMenu());

      // Event: Trigger keyboard
      trigger.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowDown') {
          e.preventDefault();
          toggleMenu(true);
        }
      });

      // Event: Menu click
      menu.addEventListener('click', async (e) => {
        const option = e.target.closest('[role="option"]');
        if (!option) return;

        const action = option.dataset.action;
        if (action === 'create') {
          toggleMenu(false);
          EntityModal.open();
          return;
        }

        const entityId = parseInt(option.dataset.entityId);
        if (!isNaN(entityId)) {
          await selectEntity(entityId);
        }
      });

      // Event: Menu keyboard navigation
      menu.addEventListener('keydown', async (e) => {
        const options = Array.from(menu.querySelectorAll('[role="option"]'));
        const currentIndex = options.indexOf(document.activeElement);

        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault();
            const nextIndex = Math.min(currentIndex + 1, options.length - 1);
            if (options[nextIndex]) options[nextIndex].focus();
            break;
          case 'ArrowUp':
            e.preventDefault();
            const prevIndex = Math.max(currentIndex - 1, 0);
            if (options[prevIndex]) options[prevIndex].focus();
            break;
          case 'Enter':
          case ' ':
            e.preventDefault();
            if (document.activeElement) document.activeElement.click();
            break;
          case 'Escape':
            e.preventDefault();
            toggleMenu(false);
            trigger.focus();
            break;
          case 'Tab':
            toggleMenu(false);
            break;
        }
      });

      // Event: Close on outside click
      document.addEventListener('click', (e) => {
        if (isOpen && !container.contains(e.target)) {
          toggleMenu(false);
        }
      });

      // Subscribe to EntityContext changes
      EntityContext.subscribe((entity) => {
        updateTrigger(entity);
      });

      // Initialize
      loadEntities();
      updateTrigger(EntityContext.current);

      // Return public API
      return {
        refresh: loadEntities,
        open: () => toggleMenu(true),
        close: () => toggleMenu(false)
      };
    }

    // Global reference for the entity switcher
    let entitySwitcher = null;

    // =====================================================
    // Dual Activity Detection (Phase 13-05)
    // =====================================================

    const DualActivityDetector = {
      // Detect if user has both Autonomo and SL entities
      async detect() {
        const entities = await EntityManager.getActiveEntities();

        const autonomoEntities = entities.filter(e => e.type === ENTITY_TYPE.AUTONOMO);
        const slEntities = entities.filter(e => e.type === ENTITY_TYPE.SOCIEDAD_LIMITADA);

        const hasAutonomo = autonomoEntities.length > 0;
        const hasSL = slEntities.length > 0;

        if (hasAutonomo && hasSL) {
          return {
            isDualActivity: true,
            autonomoEntities,
            slEntities,
            totalEntities: entities.length,
            message: 'Actividad dual detectada',
            explanation: 'Como autonomo que tambien administra una Sociedad Limitada, ' +
                         'te consideran "autonomo societario". Esto implica una base minima ' +
                         'de cotizacion de 1.000 EUR/mes (cuota ~315 EUR/mes) en lugar de ' +
                         'la base segun tus ingresos reales.',
            impact: {
              minimumBaseCents: 100000,     // 1000 EUR
              minimumCuotaCents: 31500,     // 315 EUR (31.5% of 1000)
              note: 'La cuota exacta depende del tipo de cotizacion adicional elegido.'
            }
          };
        }

        return {
          isDualActivity: false,
          autonomoEntities,
          slEntities,
          totalEntities: entities.length
        };
      },

      // Check and show warning if dual activity detected
      async checkAndWarn() {
        const result = await this.detect();

        if (result.isDualActivity) {
          this.showWarningBanner(result);
        } else {
          this.hideWarningBanner();
        }

        return result;
      },

      // Show warning banner in UI
      showWarningBanner(detectionResult) {
        // Remove existing banner if any
        this.hideWarningBanner();

        const banner = document.createElement('div');
        banner.id = 'dual-activity-warning';
        banner.className = 'dual-activity-warning';
        banner.setAttribute('role', 'alert');
        banner.innerHTML = `
          <div class="dual-activity-warning__icon">&#9888;</div>
          <div class="dual-activity-warning__content">
            <div class="dual-activity-warning__title">${detectionResult.message}</div>
            <div class="dual-activity-warning__text">${detectionResult.explanation}</div>
            <div class="dual-activity-warning__entities">
              <span class="dual-activity-warning__entity-count">
                &#128100; ${detectionResult.autonomoEntities.length} Autonomo${detectionResult.autonomoEntities.length > 1 ? 's' : ''} +
                &#127970; ${detectionResult.slEntities.length} S.L.${detectionResult.slEntities.length > 1 ? 's' : ''}
              </span>
            </div>
          </div>
          <button class="dual-activity-warning__dismiss" onclick="DualActivityDetector.dismissBanner()" aria-label="Cerrar aviso">
            &#10005;
          </button>
        `;

        // Insert after header or at top of content
        const header = document.querySelector('.dashboard-header') ||
                       document.querySelector('.entity-switcher-container')?.parentElement;
        if (header?.parentElement) {
          header.parentElement.insertBefore(banner, header.nextSibling);
        } else {
          document.body.insertBefore(banner, document.body.firstChild);
        }
      },

      // Hide warning banner
      hideWarningBanner() {
        const existing = document.getElementById('dual-activity-warning');
        if (existing) {
          existing.remove();
        }
      },

      // Dismiss banner (user action) - persists for session
      dismissBanner() {
        this.hideWarningBanner();
        sessionStorage.setItem('dual_activity_warning_dismissed', 'true');
      },

      // Check if banner was dismissed this session
      wasDismissed() {
        return sessionStorage.getItem('dual_activity_warning_dismissed') === 'true';
      },

      // Initialize on app load (respects dismissal)
      async initialize() {
        if (this.wasDismissed()) {
          return { isDualActivity: false, dismissed: true };
        }
        return this.checkAndWarn();
      }
    };

    // =====================================================
    // Database Initialization
    // =====================================================

    async function initializeDatabase() {
      const loadingScreen = document.getElementById('loading-screen');
      const loadingStatus = document.getElementById('loading-status');

      try {
        loadingScreen.classList.add('visible');

        // Step 1: Open database (triggers migrations if needed)
        loadingStatus.textContent = 'Opening database...';
        await db.open();
        console.log('Database opened:', db.name, 'version:', db.verno);

        // Step 2: Run maintenance (auto-purge old soft-deleted records)
        loadingStatus.textContent = 'Running maintenance...';
        const purged = await DataManager.autoPurgeOldRecords();
        if (purged.length > 0) {
          console.log('Auto-purge results:', purged);
        }

        // Step 3: Check sync status and create indicator
        loadingStatus.textContent = 'Checking sync status...';
        await SyncQueue.updateIndicator();

        // Step 4: Verify tables exist
        loadingStatus.textContent = 'Verifying schema...';
        const tables = db.tables.map(t => t.name);
        console.log('Database tables:', tables);

        // Step 5: Initialize entity context from persisted selection
        loadingStatus.textContent = 'Restoring session...';
        const entityRestored = await EntityContext.initialize();
        if (entityRestored) {
          console.log('Restored entity:', EntityContext.current?.name);
        }

        // Step 6: Check for dual activity on startup (Phase 13-05)
        loadingStatus.textContent = 'Checking entity configuration...';
        await DualActivityDetector.initialize();

        // Success
        loadingScreen.classList.remove('visible');
        console.log('Database initialized successfully');
        return true;

      } catch (error) {
        console.error('Database initialization failed:', error);
        loadingStatus.textContent = `Error: ${error.message}`;
        loadingStatus.classList.add('error');
        return false;
      }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async () => {
      // Phase 12: Initialize database first
      const dbSuccess = await initializeDatabase();
      if (!dbSuccess) {
        console.warn('Database initialization failed, continuing with limited functionality');
      }

      // Phase 13: Initialize entity modal
      EntityModal.init();

      // Phase 13-04: Initialize entity switcher
      const switcherContainer = document.getElementById('entity-switcher-container');
      if (switcherContainer) {
        entitySwitcher = createEntitySwitcher('entity-switcher-container');
      }

      // Initialize scenario state
      scenarioState = initScenarioState();

      // Existing Phase 2 initialization
      renderAllSections();
      recalculateTotals();

      // Phase 3 initialization
      renderScenarioCards();
      renderComparisonTable();
      initEditDialog();
      initTemplateDialog();

      // Phase 4 initialization - Calendar
      renderCalendar();
      updateCountDisplays();  // Initialize count displays
      showContractedWizard(); // Show wizard if not yet applied

      // Phase 7 initialization - Compliance
      renderComplianceContent();
      updateComplianceWarning();

      // Phase 8 initialization - Income
      renderIncomeList();

      // Phase 8 initialization - Details tab source hints (ENH-03)
      initDetailsSourceHints();

      // Phase 8 - Income dialog: close on backdrop click
      const incomeDialog = document.getElementById('incomeDialog');
      if (incomeDialog) {
        incomeDialog.addEventListener('click', (e) => {
          if (e.target === incomeDialog) {
            closeIncomeDialog();
          }
        });
      }

      // Phase 7.1 - Tooltip modal: close on backdrop click
      const tooltipModal = document.getElementById('tooltipModal');
      if (tooltipModal) {
        tooltipModal.addEventListener('click', (e) => {
          if (e.target === tooltipModal) {
            tooltipModal.close();
          }
        });
      }

      // Phase 7.2 - Expense dialog: close on backdrop click
      const expenseDialog = document.getElementById('addExpenseDialog');
      if (expenseDialog) {
        expenseDialog.addEventListener('click', (e) => {
          if (e.target === expenseDialog) {
            hideAddForm();
          }
        });
      }
    });
  </script>

  <!-- Phase 13: Entity Creation Modal -->
  <div id="entity-modal-overlay" class="entity-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="entity-modal-title">
    <div class="entity-modal">
      <div class="entity-modal__header">
        <h2 id="entity-modal-title" class="entity-modal__title">Crear Nueva Entidad</h2>
        <button class="entity-modal__close" aria-label="Cerrar" onclick="EntityModal.close()">&times;</button>
      </div>

      <div class="entity-modal__body">
        <!-- Entity Type Selection -->
        <div class="entity-modal__section">
          <div class="entity-modal__section-title">Tipo de Entidad</div>
          <div class="entity-type-selector">
            <div class="entity-type-option" data-type="autonomo" onclick="EntityModal.selectType('autonomo')">
              <div class="entity-type-option__icon">&#128100;</div>
              <div class="entity-type-option__name">Autonomo</div>
              <div class="entity-type-option__desc">Persona fisica</div>
            </div>
            <div class="entity-type-option" data-type="sociedad_limitada" onclick="EntityModal.selectType('sociedad_limitada')">
              <div class="entity-type-option__icon">&#127970;</div>
              <div class="entity-type-option__name">Sociedad Limitada</div>
              <div class="entity-type-option__desc">Persona juridica</div>
            </div>
          </div>
        </div>

        <!-- Form Fields Container -->
        <div id="entity-form-fields" class="entity-modal__section" style="display: none;">
          <form id="entity-form" onsubmit="return false;">
            <!-- Autonomo Fields -->
            <div id="autonomo-fields" style="display: none;">
              <div class="entity-form__group">
                <label class="entity-form__label entity-form__label--required" for="entity-nif">NIF</label>
                <input type="text" id="entity-nif" class="entity-form__input" placeholder="12345678Z" maxlength="9">
                <div id="entity-nif-error" class="entity-form__error" style="display: none;"></div>
              </div>
              <div class="entity-form__group">
                <label class="entity-form__label entity-form__label--required" for="entity-nombre">Nombre Completo</label>
                <input type="text" id="entity-nombre" class="entity-form__input" placeholder="Juan Garcia Lopez">
              </div>
              <div class="entity-form__group">
                <label class="entity-form__label entity-form__label--required" for="entity-domicilio-fiscal">Domicilio Fiscal</label>
                <input type="text" id="entity-domicilio-fiscal" class="entity-form__input" placeholder="Calle Mayor 1, 28001 Madrid">
              </div>
              <div class="entity-form__row">
                <div class="entity-form__group">
                  <label class="entity-form__label" for="entity-iae">Epigrafe IAE Principal</label>
                  <input type="text" id="entity-iae" class="entity-form__input" placeholder="841">
                  <div class="entity-form__hint">Codigo de actividad economica</div>
                </div>
                <div class="entity-form__group">
                  <label class="entity-form__label" for="entity-fecha-alta">Fecha de Alta</label>
                  <input type="date" id="entity-fecha-alta" class="entity-form__input">
                </div>
              </div>
            </div>

            <!-- SL Fields -->
            <div id="sl-fields" style="display: none;">
              <div class="entity-form__group">
                <label class="entity-form__label entity-form__label--required" for="entity-cif">CIF</label>
                <input type="text" id="entity-cif" class="entity-form__input" placeholder="B12345678" maxlength="9">
                <div id="entity-cif-error" class="entity-form__error" style="display: none;"></div>
              </div>
              <div class="entity-form__group">
                <label class="entity-form__label entity-form__label--required" for="entity-razon-social">Razon Social</label>
                <input type="text" id="entity-razon-social" class="entity-form__input" placeholder="Empresa Ejemplo SL">
              </div>
              <div class="entity-form__group">
                <label class="entity-form__label entity-form__label--required" for="entity-domicilio-social">Domicilio Social</label>
                <input type="text" id="entity-domicilio-social" class="entity-form__input" placeholder="Paseo de la Castellana 100, 28046 Madrid">
              </div>
              <div class="entity-form__group">
                <label class="entity-form__label">Registro Mercantil</label>
                <div class="registro-mercantil-fields">
                  <div class="entity-form__row entity-form__row--3">
                    <div class="entity-form__group">
                      <label class="entity-form__label" for="entity-rm-provincia">Provincia</label>
                      <input type="text" id="entity-rm-provincia" class="entity-form__input" placeholder="Madrid">
                    </div>
                    <div class="entity-form__group">
                      <label class="entity-form__label" for="entity-rm-tomo">Tomo</label>
                      <input type="text" id="entity-rm-tomo" class="entity-form__input" placeholder="45097">
                    </div>
                    <div class="entity-form__group">
                      <label class="entity-form__label" for="entity-rm-folio">Folio</label>
                      <input type="text" id="entity-rm-folio" class="entity-form__input" placeholder="195">
                    </div>
                  </div>
                  <div class="entity-form__row entity-form__row--3">
                    <div class="entity-form__group">
                      <label class="entity-form__label" for="entity-rm-seccion">Seccion</label>
                      <input type="text" id="entity-rm-seccion" class="entity-form__input" placeholder="8">
                    </div>
                    <div class="entity-form__group">
                      <label class="entity-form__label" for="entity-rm-hoja">Hoja</label>
                      <input type="text" id="entity-rm-hoja" class="entity-form__input" placeholder="M-452031">
                    </div>
                    <div class="entity-form__group">
                      <label class="entity-form__label" for="entity-rm-inscripcion">Inscripcion</label>
                      <input type="text" id="entity-rm-inscripcion" class="entity-form__input" placeholder="1">
                    </div>
                  </div>
                </div>
              </div>
              <div class="entity-form__row">
                <div class="entity-form__group">
                  <label class="entity-form__label" for="entity-fecha-constitucion">Fecha Constitucion</label>
                  <input type="date" id="entity-fecha-constitucion" class="entity-form__input">
                </div>
                <div class="entity-form__group">
                  <label class="entity-form__label" for="entity-capital-social">Capital Social (EUR)</label>
                  <input type="number" id="entity-capital-social" class="entity-form__input" placeholder="3000" min="3000" step="1" value="3000">
                  <div class="entity-form__hint">Minimo 3.000 EUR para SL</div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="entity-modal__footer">
        <button class="entity-modal__btn entity-modal__btn--secondary" onclick="EntityModal.close()">Cancelar</button>
        <button id="entity-modal-submit" class="entity-modal__btn entity-modal__btn--primary" onclick="EntityModal.submit()" disabled>Crear Entidad</button>
      </div>
    </div>
  </div>
</body>
</html>
