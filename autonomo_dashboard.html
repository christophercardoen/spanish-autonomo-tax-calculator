<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Autonomo Tax Calculator - 2025/2026</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ===========================================
       PHASE 5: DASHBOARD UI
       =========================================== */

    :root {
      /* Updated theme colors per CONTEXT.md */
      --bg: #1a1a1a;           /* Charcoal (was #1a1a2e) */
      --bg-surface: #242424;   /* Slightly lighter for cards */
      --bg-elevated: #2d2d44;  /* For modals, tooltips */
      --text: #eaeaea;
      --text-muted: #a0a0a0;
      --accent: #4ade80;

      /* Semantic colors per UI-07 */
      --positive: #4ade80;     /* green - income/positive values */
      --negative: #f87171;     /* red - expenses/negative values */
      --warning: #fb923c;      /* orange - threshold warnings */
      --belgium: #60a5fa;      /* blue - Belgium related */

      /* Typography per CONTEXT.md and UI-11 */
      --font-ui: 'DM Sans', system-ui, sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --size-header: 20px;
      --size-numbers: 18px;
      --size-labels: 14px;
      --size-small: 12px;

      /* Spacing scale (Phase 7.2) */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      --spacing-2xl: 48px;

      /* Border radius tokens (Phase 7.2) */
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
    }
    body {
      font-family: var(--font-ui);
      background: var(--bg);
      color: var(--text);
      padding: 2rem;
    }
    .container { max-width: 1200px; margin: 0 auto; }

    /* ===========================================
       PHASE 7.2: GLOBAL POLISH
       =========================================== */

    /* Focus-visible styles for keyboard accessibility */
    :focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Button consistency */
    button {
      font-family: var(--font-ui);
      font-weight: 500;
      border-radius: var(--radius-md);
      transition: background-color 0.15s ease, transform 0.1s ease;
    }

    button:hover:not(:disabled) {
      transform: scale(1.02);
    }

    button:active:not(:disabled) {
      transform: scale(0.98);
    }

    /* ===========================================
       PHASE 5: TAB NAVIGATION
       =========================================== */

    /* Dashboard wrapper for relative positioning */
    .dashboard {
      position: relative;  /* For absolute positioned radio inputs */
    }

    /* Dashboard header (Phase 7.2: subtle gradient for depth) */
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-lg);
      padding-bottom: var(--spacing-md);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, transparent 100%);
    }

    .dashboard-title {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text);
    }

    .dashboard-subtitle {
      margin: 0.25rem 0 0 0;
      font-size: var(--size-small);
      color: var(--text-muted);
    }

    /* Hide radio buttons but keep accessible */
    .tab-input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    /* Tab navigation bar */
    .tab-nav {
      display: flex;
      gap: 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 1.5rem;
    }

    /* Tab labels as clickable buttons */
    .tab-label {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      color: var(--text-muted);
      font-weight: 500;
      font-size: var(--size-labels);
      transition: border-color 0.2s, color 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .tab-label:hover {
      color: var(--text);
    }

    /* Active tab styling (Phase 7.2: enhanced letter-spacing) */
    #tab-scenarios:checked ~ .tab-nav .tab-label[for="tab-scenarios"],
    #tab-calendar:checked ~ .tab-nav .tab-label[for="tab-calendar"],
    #tab-expenses:checked ~ .tab-nav .tab-label[for="tab-expenses"],
    #tab-details:checked ~ .tab-nav .tab-label[for="tab-details"],
    #tab-compliance:checked ~ .tab-nav .tab-label[for="tab-compliance"] {
      border-bottom-color: var(--accent);
      color: var(--accent);
      letter-spacing: 0.75px;
    }

    /* Hide all tab content by default */
    .tab-panel {
      display: none;
    }

    /* Show content for checked tab */
    #tab-scenarios:checked ~ .tab-panels .panel-scenarios,
    #tab-calendar:checked ~ .tab-panels .panel-calendar,
    #tab-expenses:checked ~ .tab-panels .panel-expenses,
    #tab-details:checked ~ .tab-panels .panel-details,
    #tab-compliance:checked ~ .tab-panels .panel-compliance {
      display: block;
    }

    /* ===========================================
       PHASE 7: COMPLIANCE TAB STYLES
       =========================================== */

    .compliance-section {
      margin-bottom: 1.5rem;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      overflow: hidden;
    }

    .compliance-section .section-header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: transparent;
      border: none;
      color: var(--text);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      text-align: left;
    }

    .compliance-section .section-header:hover {
      background: rgba(255,255,255,0.05);
    }

    .compliance-section .section-icon {
      font-size: 1.25rem;
      transition: transform 0.2s;
    }

    .compliance-section .section-header[aria-expanded="true"] .section-icon {
      transform: rotate(45deg);
    }

    .compliance-section .section-content {
      padding: 0 1rem 1rem;
    }

    .compliance-section .section-content[hidden] {
      display: none;
    }

    .legal-text {
      background: rgba(255,255,255,0.05);
      border-left: 3px solid var(--accent);
      padding: 1rem;
      margin: 0 0 1rem 0;
      font-style: italic;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .plain-summary {
      font-size: 0.95rem;
      line-height: 1.6;
      color: var(--text);
    }

    .plain-summary strong {
      color: var(--accent);
    }

    .action-phase {
      margin-bottom: 2rem;
    }

    .action-phase h3 {
      font-size: 1.1rem;
      margin: 0 0 1rem 0;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      color: var(--text);
    }

    .fiscal-table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
      font-size: 0.9rem;
    }

    .fiscal-table th,
    .fiscal-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .fiscal-table th {
      color: var(--text-muted);
      font-weight: 500;
    }

    .fiscal-table td.highlight {
      color: var(--accent);
      font-weight: 600;
    }

    .fiscal-table tbody tr:hover {
      background: rgba(255,255,255,0.03);
    }

    .panel-compliance .source-citation {
      display: block;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
      font-style: normal;
    }

    .requirements-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .requirements-list li {
      padding: 0.5rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      display: flex;
      gap: 0.5rem;
    }

    .requirements-list li:last-child {
      border-bottom: none;
    }

    .requirements-list .field-name {
      color: var(--accent);
      font-weight: 500;
      min-width: 180px;
    }

    .invalid-list {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .invalid-list h5 {
      color: var(--negative);
      margin: 0 0 0.75rem 0;
      font-size: 0.9rem;
    }

    .invalid-list li {
      color: var(--text-muted);
    }

    .invalid-list .invalid-type {
      color: var(--negative);
      font-weight: 500;
    }

    .tie-breaker-steps {
      list-style: none;
      padding: 0;
      counter-reset: step;
    }

    .tie-breaker-steps li {
      padding: 1rem;
      margin-bottom: 0.5rem;
      background: rgba(255,255,255,0.03);
      border-radius: 4px;
      counter-increment: step;
      position: relative;
      padding-left: 3rem;
    }

    .tie-breaker-steps li::before {
      content: counter(step);
      position: absolute;
      left: 1rem;
      top: 1rem;
      width: 1.5rem;
      height: 1.5rem;
      background: var(--accent);
      color: var(--bg);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .tie-breaker-steps .step-name {
      font-weight: 600;
      color: var(--text);
      display: block;
      margin-bottom: 0.5rem;
    }

    .tie-breaker-steps .step-legal {
      font-style: italic;
      color: var(--text-muted);
      font-size: 0.85rem;
      display: block;
      margin-bottom: 0.5rem;
    }

    .tie-breaker-steps .step-plain {
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .payment-warning {
      background: rgba(248, 113, 113, 0.1);
      border-left: 3px solid var(--negative);
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 0 4px 4px 0;
    }

    .payment-warning strong {
      color: var(--negative);
    }

    /* Compliance Warning Banner (COMP-01) */
    .compliance-warning-banner {
      display: none;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
      background: rgba(251, 146, 60, 0.15);
      border: 1px solid var(--warning);
      border-radius: 8px;
      color: var(--text);
    }

    .compliance-warning-banner.visible {
      display: flex;
    }

    .compliance-warning-banner.threshold-170 {
      background: rgba(251, 146, 60, 0.1);
    }

    .compliance-warning-banner.threshold-180 {
      background: rgba(251, 146, 60, 0.15);
    }

    .compliance-warning-banner.threshold-183 {
      background: rgba(248, 113, 113, 0.15);
      border-color: var(--negative);
    }

    .compliance-warning-banner .warning-text {
      font-size: 0.9rem;
      flex: 1;
    }

    .compliance-warning-banner .warning-text strong {
      color: var(--warning);
    }

    .compliance-warning-banner.threshold-183 .warning-text strong {
      color: var(--negative);
    }

    .compliance-warning-banner .dismiss-btn {
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 1.25rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      margin-left: 1rem;
      opacity: 0.7;
    }

    .compliance-warning-banner .dismiss-btn:hover {
      opacity: 1;
    }

    /* Global Disclaimer Footer (COMP-08) */
    .global-disclaimer {
      margin-top: 3rem;
      padding: 1rem;
      background: rgba(255,255,255,0.02);
      border-top: 1px solid rgba(255,255,255,0.1);
      text-align: center;
    }

    .global-disclaimer p {
      font-size: 0.8rem;
      color: var(--text-muted);
      line-height: 1.5;
      max-width: 800px;
      margin: 0 auto;
    }

    /* Entry/Exit Day Warning (COMP-10) */
    .entry-exit-warning {
      background: rgba(251, 146, 60, 0.1);
      border-left: 3px solid var(--warning);
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 0 4px 4px 0;
      font-size: 0.9rem;
    }

    .entry-exit-warning strong {
      color: var(--warning);
    }

    input[type="number"] { padding: 0.5rem; font-size: 1rem; width: 150px; }
    input[type="checkbox"] { width: auto; }
    button { padding: 0.5rem 1rem; cursor: pointer; }
    .result { margin-top: 1rem; font-family: monospace; }
    .breakdown { margin-left: 1rem; font-size: 0.9rem; opacity: 0.8; }
    .input-section {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .input-section label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    h2 { color: var(--accent); margin-top: 2rem; }
    h3 { margin-top: 1.5rem; margin-bottom: 0.5rem; opacity: 0.9; }
    hr { border: none; border-top: 1px solid rgba(255,255,255,0.2); margin: 0.5rem 0; }

    /* Source citation styling */
    .source-hint {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      margin-left: 4px;
      background: rgba(74, 222, 128, 0.2);
      border: 1px solid var(--accent);
      border-radius: 50%;
      font-size: 10px;
      color: var(--accent);
      cursor: help;
      position: relative;
      vertical-align: middle;
    }

    .source-hint:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #2d2d44;
      border: 1px solid var(--accent);
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      font-size: 11px;
      white-space: normal;
      max-width: 300px;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      margin-bottom: 8px;
    }

    .source-hint:hover::before {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--accent);
      z-index: 101;
    }

    /* Footnotes section */
    .footnotes {
      margin-top: 3rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .footnotes h4 {
      margin-bottom: 1rem;
      color: var(--accent);
    }

    .footnotes ul {
      list-style: none;
      padding: 0;
    }

    .footnotes li {
      margin-bottom: 0.5rem;
    }

    .footnotes a {
      color: var(--accent);
      text-decoration: none;
    }

    .footnotes a:hover {
      text-decoration: underline;
    }

    .confidence-high { color: #4ade80; }
    .confidence-medium { color: #facc15; }

    /* Expense Sections */
    .expenses-container {
      margin-top: 2rem;
    }

    .expense-section {
      margin-bottom: 2rem;
      padding: 1rem;
      border-radius: 8px;
      background: rgba(255,255,255,0.03);
    }

    .expense-section.spain-deductible {
      border-left: 3px solid #4ade80;  /* Green - deductible */
    }

    .expense-section.work-travel {
      border-left: 3px solid #60a5fa;  /* Blue - work travel */
    }

    .expense-section.private {
      border-left: 3px solid #f87171;  /* Red - not deductible */
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .section-title {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-total {
      font-family: 'JetBrains Mono', monospace;
      opacity: 0.8;
    }

    .expense-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .expense-row:last-child {
      border-bottom: none;
    }

    .expense-name {
      font-weight: 500;
      min-width: 150px;
    }

    .expense-formula {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      opacity: 0.7;
      flex: 1;
      text-align: center;
    }

    .expense-value {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      min-width: 200px;
      text-align: right;
    }

    .expense-actions {
      display: flex;
      gap: 0.25rem;
    }

    .delete-btn {
      background: transparent;
      border: 1px solid #f87171;
      color: #f87171;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      padding: 0;
    }

    .delete-btn:hover {
      background: #f87171;
      color: var(--bg);
    }

    /* Add Expense Form */
    .add-expense-btn {
      background: transparent;
      border: 1px dashed rgba(255,255,255,0.3);
      color: var(--text);
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 0.5rem;
      width: 100%;
    }

    .add-expense-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .add-form {
      background: rgba(0,0,0,0.2);
      padding: 1rem;
      border-radius: 4px;
      margin-top: 0.5rem;
    }

    .add-form.hidden {
      display: none;
    }

    .add-form h4 {
      margin: 0 0 1rem 0;
      color: var(--accent);
    }

    .form-row {
      margin-bottom: 0.75rem;
    }

    .form-row label {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.9rem;
    }

    .form-row input,
    .form-row select {
      padding: 0.5rem;
      background: var(--bg);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      color: var(--text);
    }

    .form-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .form-actions button {
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
    }

    .form-actions button:first-child {
      background: var(--accent);
      border: none;
      color: var(--bg);
    }

    .form-actions button:last-child {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.3);
      color: var(--text);
    }

    /* Reset button */
    .reset-btn {
      background: transparent;
      border: 1px solid #f87171;
      color: #f87171;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .reset-btn:hover {
      background: #f87171;
      color: var(--bg);
    }

    /* Scenario Cards Section */
    .scenario-section {
      margin-top: 2rem;
    }

    .scenario-cards {
      display: flex;
      gap: 1rem;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      scroll-padding: 1rem;
      padding: 1rem 0;
      -webkit-overflow-scrolling: touch;
    }

    /* Enhanced scenario cards per UI-02, UI-03, Phase 7.2 polish */
    .scenario-card {
      flex: 0 0 320px;           /* Wider for full breakdown */
      scroll-snap-align: start;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      box-shadow: 0 1px 3px rgba(0,0,0,0.3), 0 4px 12px rgba(0,0,0,0.2);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;           /* Indicate clickable */
    }

    .scenario-card:hover {
      transform: translateY(-6px);  /* Enhanced lift effect */
      box-shadow: 0 8px 24px rgba(74, 222, 128, 0.15), 0 4px 12px rgba(0,0,0,0.3);
    }

    /* Optimal scenario indicator - Bloomberg green highlight */
    .scenario-card.optimal {
      background: rgba(74, 222, 128, 0.08);
      border-color: rgba(74, 222, 128, 0.3);
    }

    .scenario-card.optimal:hover {
      box-shadow:
        0 8px 24px rgba(0,0,0,0.4),
        0 0 0 1px rgba(74, 222, 128, 0.4);  /* Stronger glow for optimal */
    }

    /* Custom scenario visual distinction */
    .scenario-card.custom {
      border-left: 3px solid #60a5fa;
    }

    /* Selected scenario */
    .scenario-card.selected {
      border: 2px solid var(--accent);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .card-header input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    .card-header h3 {
      margin: 0;
      font-size: 1.1rem;
      flex: 1;
    }

    .optimal-badge {
      background: var(--accent);
      color: var(--bg);
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-weight: 600;
    }

    /* Full breakdown metrics per CONTEXT.md */
    .card-metrics {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .metric {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      padding: 0.2rem 0;
    }

    .metric .label {
      color: var(--text-muted);
    }

    .metric .value {
      font-family: var(--font-mono);
      font-size: var(--size-labels);
    }

    /* Divider for metric groups */
    .metric.divider {
      padding: 0;
      margin: 0.4rem 0;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    /* Highlight row (leefgeld) */
    .metric.highlight {
      padding: 0.4rem 0;
      margin-top: 0.4rem;
      border-top: 1px solid rgba(255,255,255,0.15);
    }

    .metric.highlight .value {
      color: var(--accent);
      font-weight: 600;
      font-size: var(--size-numbers);
    }

    /* Color-coded values per UI-07 */
    .value-positive { color: var(--positive); }
    .value-negative { color: var(--negative); }
    .value-warning { color: var(--warning); }

    .edit-btn {
      margin-top: 1rem;
      width: 100%;
      padding: 0.5rem;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text);
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
    }

    .edit-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Scrollbar styling */
    .scenario-cards::-webkit-scrollbar {
      height: 8px;
    }

    .scenario-cards::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
    }

    .scenario-cards::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
    }

    /* Edit Modal Dialog */
    dialog {
      background: var(--bg);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 0;
      max-width: 900px;
      width: 90vw;
      max-height: 90vh;
    }

    dialog::backdrop {
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
    }

    /* Detail modal for scenario breakdown (UI-04) */
    .detail-dialog {
      background: var(--bg);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 0;
      max-width: 500px;
      width: 90%;
      color: var(--text);
    }

    .detail-dialog::backdrop {
      background: rgba(0,0,0,0.7);
    }

    .detail-content {
      padding: 1.5rem;
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .detail-title {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
    }

    .detail-header .close-btn {
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 1.5rem;
      cursor: pointer;
      opacity: 0.7;
      padding: 0;
    }

    .detail-header .close-btn:hover {
      opacity: 1;
    }

    .detail-body {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .detail-section {
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      padding: 1rem;
    }

    .detail-section h4 {
      margin: 0 0 0.75rem 0;
      font-size: var(--size-labels);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 0.4rem 0;
      font-size: 0.9rem;
    }

    .detail-row .label {
      color: var(--text-muted);
    }

    .detail-row .value {
      font-family: var(--font-mono);
    }

    .detail-row.total {
      border-top: 1px solid rgba(255,255,255,0.1);
      margin-top: 0.5rem;
      padding-top: 0.75rem;
      font-weight: 600;
    }

    .detail-row.total .value {
      color: var(--accent);
    }

    .detail-footer {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .detail-footer button {
      flex: 1;
    }

    .dialog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .dialog-header h2 {
      margin: 0;
      color: var(--accent);
    }

    .dialog-close {
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      opacity: 0.7;
    }

    .dialog-close:hover {
      opacity: 1;
    }

    .dialog-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      padding: 1.5rem;
      max-height: 60vh;
      overflow-y: auto;
    }

    .input-pane, .results-pane {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .input-pane h3, .results-pane h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
      opacity: 0.8;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 0.5rem;
    }

    .results-pane {
      background: rgba(255,255,255,0.03);
      padding: 1rem;
      border-radius: 8px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .form-group label {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .form-group input,
    .form-group select {
      padding: 0.5rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .checkbox-group {
      flex-direction: row;
      align-items: center;
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    .fiscal-overrides {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .fiscal-overrides summary {
      cursor: pointer;
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .fiscal-overrides[open] summary {
      margin-bottom: 1rem;
    }

    /* Live results display */
    .live-result-row {
      display: flex;
      justify-content: space-between;
      padding: 0.4rem 0;
      font-size: 0.9rem;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .live-result-row:last-child {
      border-bottom: none;
    }

    .live-result-row .label {
      opacity: 0.7;
    }

    .live-result-row .value {
      font-family: 'JetBrains Mono', monospace;
    }

    .live-result-row.highlight {
      padding: 0.6rem 0;
      margin-top: 0.5rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .live-result-row.highlight .value {
      color: var(--accent);
      font-weight: 600;
      font-size: 1rem;
    }

    .dialog-footer {
      display: flex;
      gap: 1rem;
      padding: 1rem 1.5rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .dialog-footer .spacer {
      flex: 1;
    }

    .dialog-footer button {
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .primary-btn {
      background: var(--accent);
      color: var(--bg);
      border: none;
      font-weight: 600;
    }

    .primary-btn:hover {
      opacity: 0.9;
    }

    .secondary-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text);
    }

    .secondary-btn:hover {
      border-color: rgba(255,255,255,0.4);
    }

    .danger-btn {
      background: transparent;
      border: 1px solid #f87171;
      color: #f87171;
    }

    .danger-btn:hover {
      background: #f87171;
      color: var(--bg);
    }

    /* Responsive: stack on mobile */
    @media (max-width: 700px) {
      .dialog-body {
        grid-template-columns: 1fr;
      }
    }

    /* Comparison Table with sticky first column (UI-06) */
    .comparison-container {
      margin-top: 2rem;
      overflow-x: auto;      /* Enable horizontal scroll */
      overflow-y: visible;   /* Let content expand vertically */
      max-width: 100%;
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    /* Horizontal scrollbar for comparison */
    .comparison-container::-webkit-scrollbar {
      height: 8px;
    }

    .comparison-container::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
    }

    .comparison-container::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
    }

    .comparison-container::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.3);
    }

    /* Base table */
    .comparison-table {
      width: max-content;    /* Allow table to exceed container */
      min-width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    /* Sticky header row - z-index: 100 */
    .comparison-table thead th {
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 100;
      border-bottom: 2px solid var(--accent);
      padding: 0.75rem 1rem;
      text-align: right;
      font-weight: 600;
      white-space: nowrap;
    }

    /* Sticky first column (metric names) - z-index: 99 */
    .comparison-table tbody td:first-child,
    .comparison-table thead th:first-child {
      position: sticky;
      left: 0;
      z-index: 99;
      background: var(--bg);
      min-width: 180px;
      text-align: left;
    }

    /* Corner cell (sticky both directions) - z-index: 101 */
    .comparison-table thead th:first-child {
      z-index: 101;
    }

    /* Regular cells */
    .comparison-table tbody td {
      padding: 0.5rem 1rem;
      text-align: right;
      font-family: var(--font-mono);
      border-bottom: 1px solid rgba(255,255,255,0.05);
      white-space: nowrap;
    }

    .comparison-table tbody td:first-child {
      font-family: var(--font-ui);
      color: var(--text-muted);
    }

    /* Divider row */
    .comparison-table tr.divider td {
      padding: 0.25rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.15);
    }

    /* Highlight row (leefgeld) */
    .comparison-table tr.highlight-row td {
      padding: 0.75rem 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
      font-weight: 600;
    }

    /* Optimal value cell */
    .comparison-table td.optimal {
      color: var(--accent);
      font-weight: 700;
    }

    /* Color-coded values in comparison table (UI-07) */
    .comparison-table .value-positive { color: var(--positive); }
    .comparison-table .value-negative { color: var(--negative); }
    .comparison-table .value-warning { color: var(--warning); }

    /* Table row hover state (Phase 7.2) */
    .comparison-table tbody tr:hover {
      background: rgba(255,255,255,0.05);
    }

    /* Empty state */
    .comparison-empty {
      text-align: center;
      padding: 2rem;
      opacity: 0.6;
    }

    .comparison-empty p {
      margin: 0;
    }

    /* New Scenario Button */
    .new-scenario-btn {
      background: transparent;
      border: 2px dashed rgba(255,255,255,0.2);
      color: var(--text);
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      margin-left: 1rem;
      flex-shrink: 0;
      transition: border-color 0.2s, color 0.2s;
    }

    .new-scenario-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Template Selection Dialog */
    #templateSelectDialog {
      max-width: 400px;
    }

    .template-options {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin: 1rem 0;
    }

    .template-option {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .template-option:hover {
      border-color: var(--accent);
    }

    .template-option input[type="radio"] {
      accent-color: var(--accent);
    }

    .template-option .template-info {
      flex: 1;
    }

    .template-option .template-name {
      font-weight: 600;
    }

    .template-option .template-desc {
      font-size: 0.85rem;
      opacity: 0.7;
    }

    /* Calendar Section */
    .calendar-section {
      margin-top: 2rem;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding: 0 0.5rem;
    }

    .calendar-header h3 {
      margin: 0;
      flex: 1;
      text-align: center;
      font-size: 1.2rem;
    }

    .nav-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text);
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      transition: border-color 0.2s, color 0.2s;
    }

    .nav-btn:hover:not(:disabled) {
      border-color: var(--accent);
      color: var(--accent);
    }

    .nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 0.5rem;
    }

    .day-header {
      text-align: center;
      padding: 0.5rem;
      font-size: 0.85rem;
      font-weight: 600;
      opacity: 0.6;
    }

    .day-cell {
      min-height: 60px;
      background: rgba(255,255,255,0.03);
      border-radius: 4px;
      padding: 0.25rem;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }

    .day-cell:hover:not(.empty) {
      background: rgba(255,255,255,0.08);
    }

    .day-cell.empty {
      background: transparent;
      cursor: default;
    }

    .day-cell.belgium {
      background: rgba(59, 130, 246, 0.15);
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .day-cell.spain {
      background: rgba(74, 222, 128, 0.15);
      border: 1px solid rgba(74, 222, 128, 0.3);
    }

    .day-cell.travel {
      background: rgba(251, 146, 60, 0.15);
      border: 1px solid rgba(251, 146, 60, 0.3);
    }

    .day-number {
      font-size: 0.85rem;
      font-weight: 500;
    }

    .status-emoji {
      display: block;
      text-align: center;
      font-size: 1.2rem;
      margin-top: 0.25rem;
    }

    .contracted-badge {
      position: absolute;
      top: 2px;
      right: 4px;
      font-size: 10px;
      opacity: 0.7;
      font-weight: 600;
      color: var(--accent);
    }

    /* Day Picker Dialog Status Options */
    .status-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }

    .status-option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .status-option:hover {
      border-color: var(--accent);
    }

    .status-option input[type="radio"] {
      accent-color: var(--accent);
    }

    .status-emoji-large {
      font-size: 1.5rem;
    }

    /* Day Picker Dialog - narrower width */
    #dayPickerDialog {
      max-width: 400px;
    }

    #bulkPickerDialog {
      max-width: 400px;
    }

    /* Selected day cells (for bulk selection) */
    .day-cell.selected {
      outline: 2px solid var(--accent);
      outline-offset: -2px;
      background: rgba(79, 209, 139, 0.2);
    }

    /* ===========================================
       CALENDAR MULTI-SELECT ENHANCEMENTS (BUG-05)
       =========================================== */

    /* Selection Indicator Bar */
    .selection-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--accent);
      color: var(--bg);
      font-weight: 600;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .selection-indicator.hidden {
      display: none;
    }

    .selection-indicator .clear-btn {
      padding: 6px 12px;
      background: rgba(0, 0, 0, 0.2);
      border: none;
      border-radius: 4px;
      color: var(--bg);
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .selection-indicator .clear-btn:hover {
      background: rgba(0, 0, 0, 0.3);
    }

    /* Week Selector Button */
    .week-selector {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      padding: 0;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--bg-surface);
      color: var(--text-muted);
      font-size: 0.7rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .week-selector:hover {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }

    /* Month Select All Button */
    .month-select-all {
      padding: 4px 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: transparent;
      color: var(--text-muted);
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      margin-left: 12px;
    }

    .month-select-all:hover {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }

    /* Calendar grid with week selectors - 8 columns */
    .calendar-grid-with-weeks {
      display: grid;
      grid-template-columns: 32px repeat(7, 1fr);
      gap: 2px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 0.5rem;
    }

    .calendar-grid-with-weeks .day-header {
      text-align: center;
      padding: 0.5rem;
      font-size: 0.85rem;
      font-weight: 600;
      opacity: 0.6;
    }

    .calendar-grid-with-weeks .week-selector-cell {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Unsaved changes indicator */
    .unsaved-indicator {
      color: #facc15;
      font-size: 0.9rem;
      align-self: center;
    }
    .unsaved-indicator.hidden { display: none; }

    /* Calendar Stats Display */
    .calendar-stats {
      display: flex;
      gap: 2rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .count-display {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .count-label {
      opacity: 0.7;
    }

    .count-value {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      font-size: 1.1rem;
    }

    /* Warning Badge */
    .warning-badge {
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .warning-badge.yellow { background: #facc15; color: #1a1a2e; }
    .warning-badge.orange { background: #fb923c; color: #1a1a2e; }
    .warning-badge.red { background: #f87171; color: #1a1a2e; }

    /* Warning Banner */
    .warning-banner {
      padding: 0.75rem 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      font-weight: 500;
    }

    .warning-banner.yellow { background: rgba(250, 204, 21, 0.15); border: 1px solid #facc15; color: #facc15; }
    .warning-banner.orange { background: rgba(251, 146, 60, 0.15); border: 1px solid #fb923c; color: #fb923c; }
    .warning-banner.red { background: rgba(248, 113, 113, 0.15); border: 1px solid #f87171; color: #f87171; }

    .warning-banner.hidden, .warning-badge.hidden { display: none; }

    /* Export Section */
    .export-section {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .export-buttons {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .export-buttons button {
      display: flex;
      align-items: center;
    }

    /* Notification Toast */
    .notification {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateY(1rem);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .notification.success {
      background: rgba(74, 222, 128, 0.2);
      border: 1px solid var(--accent);
      color: var(--accent);
    }

    .notification.error {
      background: rgba(248, 113, 113, 0.2);
      border: 1px solid #f87171;
      color: #f87171;
    }

    .notification.hidden {
      display: none;
    }

    /* ===========================================
       PHASE 5/7.1: TOOLTIP MODALS (UI-09, BUG-02)
       =========================================== */

    /* Tooltip trigger - clickable info icon */
    .term-tooltip-trigger {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: inherit;
      text-decoration: none;
      border-bottom: 1px dotted var(--text-muted);
    }

    .term-tooltip-trigger:hover,
    .term-tooltip-trigger:focus {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .term-tooltip-trigger:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      font-size: 10px;
      font-weight: 700;
      color: var(--bg);
      background: var(--accent);
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* Tooltip Modal Dialog */
    .tooltip-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 400px;
      width: 90%;
      padding: 0;
      border: none;
      border-radius: 12px;
      background: var(--bg-surface);
      color: var(--text);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
    }

    .tooltip-modal::backdrop {
      background: rgba(0, 0, 0, 0.6);
      -webkit-backdrop-filter: blur(4px);
      backdrop-filter: blur(4px);
    }

    .tooltip-modal-content {
      padding: 24px;
    }

    .tooltip-modal-title {
      margin: 0 0 12px 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--accent);
    }

    .tooltip-modal-text {
      margin: 0 0 20px 0;
      font-size: 0.95rem;
      line-height: 1.6;
      color: var(--text);
    }

    .tooltip-modal-close {
      display: block;
      width: 100%;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      background: var(--accent);
      color: var(--bg);
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .tooltip-modal-close:hover {
      opacity: 0.9;
    }

    .tooltip-modal-close:focus-visible {
      outline: 2px solid var(--text);
      outline-offset: 2px;
    }

    /* Ensure tooltips in cards don't get clipped */
    .scenario-card {
      overflow: visible;
    }

    /* ===========================================
       PHASE 5: PRINT STYLES (UI-10)
       =========================================== */

    /* Export actions bar */
    .export-actions {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      justify-content: flex-end;
    }

    .export-actions button {
      font-size: var(--size-small);
      padding: 0.4rem 0.75rem;
    }

    @media print {
      /* Light theme for printing */
      body {
        background: white !important;
        color: black !important;
        font-size: 11pt;
        padding: 0;
      }

      .container {
        max-width: 100%;
      }

      /* Hide interactive elements */
      .tab-nav,
      .tab-input,
      .edit-btn,
      .delete-btn,
      .add-expense-btn,
      .new-scenario-btn,
      .export-actions,
      .nav-btn,
      .reset-btn,
      button:not(.print-include),
      dialog,
      .calendar-section,
      .panel-calendar,
      .panel-expenses,
      .panel-details,
      [role="tooltip"] {
        display: none !important;
      }

      /* Show only scenarios panel */
      .tab-panel {
        display: block !important;
      }

      .panel-scenarios {
        display: block !important;
      }

      /* Dashboard header adjustments */
      .dashboard-header {
        border-bottom: 2px solid #333;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
      }

      .dashboard-title {
        color: black;
        font-size: 16pt;
      }

      .dashboard-subtitle {
        color: #666;
      }

      /* Scenario cards in print grid */
      .scenario-cards {
        display: grid !important;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
        overflow: visible !important;
      }

      .scenario-card {
        background: white !important;
        border: 1px solid #ccc !important;
        color: black !important;
        page-break-inside: avoid;
        padding: 0.75rem;
        flex: none !important;
      }

      .scenario-card.optimal {
        border: 2px solid #333 !important;
        background: #f5f5f5 !important;
      }

      .optimal-badge {
        background: #333 !important;
        color: white !important;
      }

      /* Metrics in print */
      .metric .label,
      .metric .value {
        color: black !important;
      }

      .metric.highlight .value {
        color: black !important;
        font-weight: 700;
      }

      /* Comparison table for print */
      .comparison-container {
        overflow: visible !important;
        border: 1px solid #ccc !important;
      }

      .comparison-table {
        width: 100% !important;
      }

      .comparison-table th,
      .comparison-table td {
        position: static !important;
        background: white !important;
        color: black !important;
        border: 1px solid #ddd !important;
        padding: 0.4rem !important;
        font-size: 9pt;
      }

      .comparison-table thead th {
        background: #f0f0f0 !important;
        font-weight: 700;
      }

      .comparison-table td.optimal {
        background: #e8f5e9 !important;
        font-weight: 700;
      }

      /* Color classes in print */
      .value-positive,
      .value-negative,
      .value-warning {
        color: black !important;
      }

      /* Hide mobile comparison on print */
      .comparison-mobile {
        display: none !important;
      }

      /* Page settings */
      @page {
        margin: 1cm;
        size: landscape;
      }
    }

    /* ===========================================
       PHASE 5: RESPONSIVE DESIGN (UI-08)
       =========================================== */

    /* Mobile comparison blocks (hidden on desktop) */
    .comparison-mobile {
      display: none;
    }

    .comparison-block {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .comparison-block.optimal {
      border-color: var(--accent);
      background: rgba(74, 222, 128, 0.05);
    }

    .block-title {
      margin: 0 0 1rem 0;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .block-metrics {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .block-row {
      display: flex;
      justify-content: space-between;
      padding: 0.4rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .block-row:last-child {
      border-bottom: none;
    }

    .block-row .label {
      color: var(--text-muted);
    }

    .block-row .value {
      font-family: var(--font-mono);
    }

    .block-row.highlight {
      padding-top: 0.6rem;
      margin-top: 0.4rem;
      border-top: 1px solid rgba(255,255,255,0.1);
      border-bottom: none;
    }

    .block-row.highlight .value {
      color: var(--accent);
      font-weight: 600;
    }

    /* Tablet breakpoint */
    @media (max-width: 900px) {
      .container {
        padding: 1rem;
      }

      .scenario-cards {
        gap: 0.75rem;
      }

      .scenario-card {
        flex: 0 0 280px;
      }

      .dialog-body {
        grid-template-columns: 1fr;
      }
    }

    /* Medium tablet breakpoint */
    @media (max-width: 768px) {
      /* Reduce container padding */
      body {
        padding: 1rem;
      }

      /* Tab nav adjustments */
      .tab-label {
        padding: 0.6rem 1rem;
        font-size: 0.8rem;
      }

      /* Calendar adjustments for tablet */
      .calendar-stats {
        flex-direction: column;
        gap: 0.75rem;
      }

      /* Expense form full width */
      .add-form {
        padding: 1rem;
      }

      .form-row input,
      .form-row select {
        width: 100%;
        min-height: 44px; /* Touch-friendly size */
      }

      /* Dialog adjustments */
      dialog {
        max-width: 95vw;
        width: 95vw;
      }

      /* Compliance sections */
      .requirements-list li {
        flex-direction: column;
        gap: 0.25rem;
      }

      .requirements-list .field-name {
        min-width: unset;
      }
    }

    /* Mobile breakpoint */
    @media (max-width: 600px) {
      body {
        padding: 0.5rem;
      }

      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .dashboard-title {
        font-size: 1.25rem;
      }

      /* Stack tabs in 2x3 grid on mobile */
      .tab-nav {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0;
        border-bottom: none;
      }

      .tab-label {
        padding: 0.75rem 0.5rem;
        font-size: 0.7rem;
        text-align: center;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        border-right: 1px solid rgba(255,255,255,0.1);
        min-height: 44px; /* Touch-friendly size */
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .tab-label:nth-child(3n) {
        border-right: none;
      }

      .tab-label:nth-child(4),
      .tab-label:nth-child(5) {
        border-bottom: none;
      }

      /* Scenario cards full width */
      .scenario-cards {
        flex-direction: column;
        overflow-x: visible;
        gap: 0.75rem;
      }

      .scenario-card {
        flex: none;
        width: 100%;
        padding: var(--spacing-md);
      }

      .card-header {
        flex-wrap: wrap;
      }

      /* Edit button full width */
      .edit-btn {
        min-height: 44px;
      }

      /* Hide horizontal comparison table on mobile */
      .comparison-container {
        display: none;
      }

      /* Show vertical comparison blocks on mobile */
      .comparison-mobile {
        display: block;
      }

      /* Mobile comparison blocks styling */
      .comparison-block {
        padding: var(--spacing-md);
      }

      .block-row {
        padding: 0.5rem 0;
      }

      .block-row .value {
        font-size: 0.9rem;
      }

      /* Export actions stack */
      .export-actions {
        flex-direction: column;
      }

      .export-actions button {
        width: 100%;
        min-height: 44px;
      }

      /* Calendar adjustments */
      .calendar-header {
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0;
      }

      .calendar-header h3 {
        order: 1;
        width: 100%;
        text-align: center;
        font-size: 1rem;
        margin-bottom: 0.5rem;
      }

      .nav-btn {
        order: 2;
        min-height: 44px;
        min-width: 44px;
        flex: 1;
      }

      .calendar-grid {
        gap: 1px;
        padding: 0.25rem;
      }

      .day-header {
        padding: 0.25rem;
        font-size: 0.7rem;
      }

      .day-cell {
        min-height: 48px; /* Touch-friendly minimum */
        padding: 0.2rem;
        font-size: 0.75rem;
      }

      .day-number {
        font-size: 0.75rem;
      }

      .status-emoji {
        font-size: 1.1rem;
      }

      .contracted-badge {
        font-size: 8px;
        top: 1px;
        right: 2px;
      }

      /* Week selector buttons */
      .week-selector {
        min-width: 24px;
        min-height: 24px;
      }

      /* Selection indicator mobile */
      .selection-indicator {
        flex-wrap: wrap;
        padding: 10px 12px;
        font-size: 0.85rem;
      }

      .selection-indicator .clear-btn {
        min-height: 36px;
        padding: 8px 12px;
      }

      /* Calendar stats mobile */
      .calendar-stats {
        flex-direction: column;
        gap: 0.5rem;
      }

      .count-display {
        flex-wrap: wrap;
        font-size: 0.9rem;
      }

      /* Calendar actions */
      .calendar-actions {
        flex-direction: column-reverse !important;
        align-items: stretch !important;
      }

      .calendar-actions .primary-btn {
        width: 100%;
        min-height: 44px;
      }

      /* Export section mobile */
      .export-section {
        margin-top: 1rem;
      }

      .export-buttons {
        flex-direction: column;
      }

      .export-buttons button {
        width: 100%;
        min-height: 44px;
        justify-content: center;
      }

      /* Dialog full width on mobile */
      dialog {
        width: 100vw;
        max-width: 100vw;
        max-height: 100vh;
        margin: 0;
        border-radius: 0;
      }

      .dialog-header {
        padding: 1rem;
      }

      .dialog-header h2 {
        font-size: 1.1rem;
      }

      .dialog-body {
        padding: 1rem;
        max-height: calc(100vh - 140px);
      }

      .dialog-footer {
        padding: 1rem;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .dialog-footer button {
        min-height: 44px;
        flex: 1 1 auto;
      }

      .dialog-footer .spacer {
        display: none;
      }

      /* Form groups on mobile */
      .form-group input,
      .form-group select {
        width: 100%;
        min-height: 44px;
        font-size: 16px; /* Prevents zoom on iOS */
      }

      /* Detail dialog mobile */
      .detail-dialog {
        max-width: 100vw;
        width: 100vw;
        max-height: 100vh;
        border-radius: 0;
      }

      .detail-content {
        padding: 1rem;
        max-height: calc(100vh - 60px);
        overflow-y: auto;
      }

      .detail-footer {
        flex-direction: column;
        gap: 0.5rem;
      }

      .detail-footer button {
        min-height: 44px;
      }

      /* Tooltip modal mobile */
      .tooltip-modal {
        max-width: 95vw;
        width: 95vw;
      }

      /* Status options in day picker */
      .status-options {
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
      }

      .status-option {
        padding: 0.6rem;
        min-height: 60px;
        flex-direction: column;
        justify-content: center;
        text-align: center;
      }

      .status-emoji-large {
        font-size: 1.25rem;
      }

      /* Expense sections mobile */
      .expense-section {
        padding: 0.75rem;
      }

      .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .expense-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
        padding: 0.75rem 0;
      }

      .expense-name {
        min-width: unset;
        width: 100%;
      }

      .expense-formula {
        text-align: left;
        font-size: 0.8rem;
      }

      .expense-value {
        min-width: unset;
        text-align: left;
        display: flex;
        justify-content: space-between;
        width: 100%;
        align-items: center;
      }

      .expense-actions {
        margin-left: auto;
      }

      .delete-btn {
        min-width: 36px;
        min-height: 36px;
      }

      /* Add expense button */
      .add-expense-btn {
        min-height: 44px;
      }

      /* Add form mobile */
      .add-form {
        padding: 0.75rem;
      }

      .form-row input,
      .form-row select {
        width: 100%;
        min-height: 44px;
        font-size: 16px; /* Prevents zoom on iOS */
      }

      .form-actions {
        flex-direction: column;
      }

      .form-actions button {
        min-height: 44px;
      }

      /* Reset button */
      .reset-btn {
        min-height: 44px;
        width: 100%;
      }

      /* Compliance tab mobile */
      .compliance-section .section-header {
        padding: 0.75rem;
      }

      .compliance-section .section-content {
        padding: 0 0.75rem 0.75rem;
      }

      .tie-breaker-steps li {
        padding-left: 2.5rem;
        padding: 0.75rem 0.75rem 0.75rem 2.5rem;
      }

      .tie-breaker-steps li::before {
        left: 0.5rem;
        width: 1.25rem;
        height: 1.25rem;
        font-size: 0.75rem;
      }

      /* Global disclaimer mobile */
      .global-disclaimer {
        padding: 0.75rem;
        margin-top: 2rem;
      }

      .global-disclaimer p {
        font-size: 0.75rem;
      }

      /* Template dialog mobile */
      #templateSelectDialog {
        max-width: 100vw;
        width: 100vw;
      }

      .template-option {
        padding: 0.75rem;
        min-height: 60px;
      }

      /* Warning banner mobile */
      .compliance-warning-banner {
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-start;
      }

      .compliance-warning-banner .dismiss-btn {
        align-self: flex-end;
        margin-left: 0;
      }
    }

    /* Extra small mobile (375px - iPhone SE) */
    @media (max-width: 400px) {
      body {
        padding: 0.25rem;
      }

      .dashboard-title {
        font-size: 1.1rem;
      }

      .tab-label {
        font-size: 0.65rem;
        padding: 0.5rem 0.25rem;
      }

      .day-cell {
        min-height: 44px;
      }

      .day-number {
        font-size: 0.7rem;
      }

      .status-emoji {
        font-size: 1rem;
        margin-top: 0.15rem;
      }

      .metric {
        font-size: 0.8rem;
      }

      .metric .value {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <!-- Notification Toast (used by clipboard copy) -->
  <div id="notification" class="notification hidden"></div>

  <div class="container">
    <div class="dashboard">
      <!-- Dashboard Header -->
      <header class="dashboard-header">
        <div>
          <h1 class="dashboard-title">Autonomo Tax Calculator</h1>
          <p class="dashboard-subtitle">Self-Employed Tax Calculator 2025/2026</p>
        </div>
      </header>

      <!-- Compliance Warning Banner (COMP-01) -->
      <div id="complianceWarningBanner" class="compliance-warning-banner" role="alert" aria-live="polite">
        <span class="warning-text" id="warningText"></span>
        <button class="dismiss-btn" aria-label="Dismiss warning" onclick="dismissComplianceWarning()">&times;</button>
      </div>

      <!-- Tab radio inputs (hidden) -->
      <input type="radio" name="tabs" id="tab-scenarios" class="tab-input" checked>
      <input type="radio" name="tabs" id="tab-calendar" class="tab-input">
      <input type="radio" name="tabs" id="tab-expenses" class="tab-input">
      <input type="radio" name="tabs" id="tab-details" class="tab-input">
      <input type="radio" name="tabs" id="tab-compliance" class="tab-input">

      <!-- Tab navigation -->
      <nav class="tab-nav">
        <label for="tab-scenarios" class="tab-label">Scenarios</label>
        <label for="tab-calendar" class="tab-label">Calendar</label>
        <label for="tab-expenses" class="tab-label">Expenses</label>
        <label for="tab-details" class="tab-label">Details</label>
        <label for="tab-compliance" class="tab-label">Compliance</label>
      </nav>

      <!-- Tab panels container -->
      <div class="tab-panels">

        <!-- EXPENSES TAB -->
        <section class="tab-panel panel-expenses">
          <div class="expenses-container">
      <h2>Expense Tracking</h2>
      <div id="spainSection"></div>
      <div id="workTravelSection"></div>
      <div id="privateSection"></div>
      <div style="margin-top: 1rem; display: flex; justify-content: flex-end;">
        <button class="reset-btn" onclick="resetToDefaults()">Reset to Defaults</button>
      </div>

      <!-- Add Expense Form (global, one for all sections) -->
      <div id="addExpenseForm" class="add-form hidden">
        <h4>Add New Expense</h4>
        <div class="form-row">
          <label>Name: <input type="text" id="newExpName" placeholder="e.g., Software subscription" required></label>
        </div>
        <div class="form-row">
          <label>Amount (EUR/month): <input type="number" id="newExpAmount" min="0" step="0.01" required></label>
        </div>
        <div class="form-row">
          <label>Category:
            <select id="newExpCategory" onchange="toggleDeductionField()">
              <option value="spainDeductible">Spain Deductible</option>
              <option value="workTravel">Work Travel</option>
              <option value="private">Private</option>
            </select>
          </label>
        </div>
        <div class="form-row" id="deductionRow">
          <label>Deduction %: <input type="number" id="newExpDeduction" min="0" max="100" value="100"></label>
        </div>
        <div class="form-actions">
          <button onclick="submitNewExpense()">Add</button>
          <button onclick="hideAddForm()">Cancel</button>
        </div>
      </div>
          </div>
        </section>

        <!-- SCENARIOS TAB -->
        <section class="tab-panel panel-scenarios">
          <div class="scenario-section">
            <h2>Scenario Comparison</h2>
            <div id="scenarioCards" class="scenario-cards">
              <!-- Populated by renderScenarioCards() -->
            </div>
            <div class="export-actions">
              <button onclick="copyTableToClipboard()" class="secondary-btn">
                Copy to Clipboard
              </button>
              <button onclick="window.print()" class="secondary-btn">
                Print / PDF
              </button>
            </div>
            <div id="comparisonTable">
              <!-- Populated by renderComparisonTable() -->
            </div>
            <div class="comparison-mobile">
              <!-- Populated by renderMobileComparison() -->
            </div>
          </div>
        </section>

        <!-- CALENDAR TAB -->
        <section class="tab-panel panel-calendar">
          <div class="calendar-section">
      <h2>Belgium Calendar 2026</h2>

      <div class="calendar-info" style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 4px; font-size: 0.9rem;">
        <strong style="color: var(--accent);">How days are counted:</strong>
        <ul style="margin: 0.5rem 0 0 1.5rem; opacity: 0.8; line-height: 1.6;">
          <li><strong>Belgium days</strong> + <strong>Travel days</strong> count toward 183-day threshold</li>
          <li><strong>Spain days</strong> do not count toward threshold</li>
          <li><strong>Travel days:</strong> Use for flight days between countries</li>
        </ul>
      </div>

      <div class="calendar-stats">
        <div class="count-display">
          <span class="count-label">This month:</span>
          <span id="monthBelgiumCount" class="count-value">0</span> Belgium
        </div>
        <div class="count-display">
          <span class="count-label">Annual total:</span>
          <span id="annualBelgiumCount" class="count-value">0</span> Belgium + Travel
          <span class="source-hint" data-tooltip="Entry and exit days (travel days between Belgium and Spain) may be counted by BOTH countries' tax authorities. This calculator counts Travel days toward the 183-day threshold as a conservative approach. Art. 4 Spain-Belgium tax treaty applies for tie-breaker.">?</span>
          <span id="warningBadge" class="warning-badge hidden"></span>
        </div>
      </div>
      <div id="warningBanner" class="warning-banner hidden"></div>

      <!-- Selection Indicator (shows when days are selected) -->
      <div id="selectionIndicator" class="selection-indicator hidden">
        <span><span id="selectionCount">0</span> days selected</span>
        <button type="button" class="clear-btn" onclick="clearSelection()">Clear</button>
        <button type="button" class="clear-btn" onclick="openBulkPicker()">Set Status</button>
      </div>

      <div id="calendarContainer">
        <!-- Populated by renderCalendar() -->
      </div>
      <div class="calendar-actions" style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: flex-end;">
        <span id="unsavedIndicator" class="unsaved-indicator hidden">Unsaved changes</span>
        <button id="saveCalendarBtn" class="primary-btn" onclick="commitCalendarChanges()" disabled>Save Calendar</button>
      </div>

      <div class="export-section">
        <h4 style="margin: 0 0 0.75rem 0; opacity: 0.8;">Export Calendar</h4>
        <div class="export-buttons">
          <button class="secondary-btn" onclick="downloadICS()">
            <span style="margin-right: 0.5rem;">&#128197;</span>
            Export ICS
          </button>
          <button class="secondary-btn" onclick="downloadCSV()">
            <span style="margin-right: 0.5rem;">&#128196;</span>
            Export CSV
          </button>
          <button class="secondary-btn" onclick="copyToClipboard()">
            <span style="margin-right: 0.5rem;">&#128203;</span>
            Copy Summary
          </button>
        </div>
      </div>

      <details class="holidays-reference" style="margin-top: 1rem;">
        <summary style="cursor: pointer; opacity: 0.8;">Belgian Public Holidays 2026 (Reference)</summary>
        <div style="padding: 1rem 0; font-size: 0.9rem; opacity: 0.8;">
          <p style="margin-bottom: 0.5rem;">These are NOT auto-marked. Mark manually if you are in Belgium:</p>
          <ul style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">
            <li>Apr 6 - Easter Monday</li>
            <li>May 1 - Labour Day</li>
            <li>May 14 - Ascension Day</li>
            <li>May 25 - Whit Monday</li>
            <li>Jul 21 - Belgian National Holiday</li>
            <li>Aug 15 - Assumption Day (Saturday - substitute TBD)</li>
            <li>Nov 1 - All Saints' Day (Sunday - substitute TBD)</li>
            <li>Nov 11 - Armistice Day</li>
            <li>Dec 25 - Christmas Day</li>
          </ul>
          <p style="margin-top: 0.75rem; font-style: italic;">
            If a holiday falls the day before a contracted work day, you may need to be in Belgium.
            These still count toward the 183-day threshold.
          </p>
        </div>
      </details>
          </div>
        </section>

        <!-- DETAILS TAB -->
        <section class="tab-panel panel-details">
          <div class="input-section">
            <label>
              Monthly Revenue (EUR):
              <input type="number" id="monthlyRevenue" value="6000" min="0" step="100" oninput="recalculateTotals()">
            </label>
            <label>
              <input type="checkbox" id="hasDescendant" checked onchange="recalculateTotals()">
              1 Dependent Child (adds 2,400 EUR minimo)
            </label>
          </div>
          <div id="results" class="result"></div>
        </section>

        <!-- COMPLIANCE TAB -->
        <section class="tab-panel panel-compliance" id="compliancePanel">
          <!-- Content populated by renderComplianceContent() -->
        </section>

      </div><!-- end .tab-panels -->

      <!-- Global Disclaimer Footer (COMP-08) -->
      <footer class="global-disclaimer" id="globalDisclaimer">
        <p>
          <strong>Disclaimer:</strong> This calculator provides estimates for informational and educational purposes only.
          It does not constitute tax, legal, or financial advice. Tax laws are complex, subject to change, and vary by
          individual circumstances. Your actual tax liability may differ from these estimates. Always consult with a
          qualified tax professional (asesor fiscal, gestor) for guidance specific to your situation before making any
          financial decisions or filing tax returns.
        </p>
      </footer>
    </div><!-- end .dashboard -->

    <!-- Edit Scenario Modal -->
    <dialog id="editScenarioDialog" aria-labelledby="dialogTitle">
      <form method="dialog" class="edit-form">
        <header class="dialog-header">
          <h2 id="dialogTitle">Edit Scenario</h2>
          <button type="button" class="dialog-close" aria-label="Close" onclick="closeEditModal()">x</button>
        </header>

        <div class="dialog-body">
          <!-- Input pane (left) -->
          <div class="input-pane">
            <div class="form-group">
              <label for="editScenarioName">Scenario Name</label>
              <input type="text" id="editScenarioName" required autofocus>
            </div>

            <h3>Income & Expenses</h3>
            <div class="form-group">
              <label for="editMonthlyRevenue">Monthly Revenue (EUR)</label>
              <input type="number" id="editMonthlyRevenue" min="0" step="100">
            </div>
            <div class="form-group">
              <label for="editMonthlyExpenses">Monthly Expenses (EUR)</label>
              <input type="number" id="editMonthlyExpenses" min="0" step="100">
            </div>
            <div class="form-group">
              <label for="editWorkTravelCost">Work Travel Cost (EUR/month)</label>
              <input type="number" id="editWorkTravelCost" min="0" step="100" placeholder="e.g., 1000 or 2500">
            </div>
            <div class="form-group checkbox-group">
              <input type="checkbox" id="editHasDescendant">
              <label for="editHasDescendant">1 Dependent Child (adds 2,400 EUR minimo)</label>
            </div>

            <details class="fiscal-overrides">
              <summary>Fiscal Overrides (What-If Analysis)</summary>
              <div class="form-group">
                <label for="editRetaOverride">RETA Monthly (EUR)</label>
                <input type="number" id="editRetaOverride" placeholder="428.40" min="0" step="0.01">
              </div>
              <div class="form-group">
                <label for="editMinimoPersonalOverride">Minimo Personal (EUR)</label>
                <input type="number" id="editMinimoPersonalOverride" placeholder="5550" min="0" step="1">
              </div>
              <div class="form-group">
                <label for="editMinimoDescOverride">Minimo Descendientes (EUR)</label>
                <input type="number" id="editMinimoDescOverride" placeholder="2400" min="0" step="1">
              </div>
            </details>
          </div>

          <!-- Results pane (right) - live updating -->
          <div class="results-pane">
            <h3>Calculated Results</h3>
            <div id="liveEditResults">
              <!-- Populated by updateLiveResults() -->
            </div>
          </div>
        </div>

        <footer class="dialog-footer">
          <button type="button" id="deleteScenarioBtn" class="danger-btn" onclick="confirmDeleteScenario()">Delete</button>
          <div class="spacer"></div>
          <button type="button" class="secondary-btn" onclick="closeEditModal()">Cancel</button>
          <button type="submit" value="save" class="primary-btn">Save Changes</button>
        </footer>
      </form>
    </dialog>

    <!-- Detail Modal for Scenario Breakdown (UI-04) -->
    <dialog id="detail-modal" class="detail-dialog">
      <div class="detail-content">
        <header class="detail-header">
          <h2 class="detail-title">Scenario Details</h2>
          <button class="close-btn" onclick="closeDetailModal()">&times;</button>
        </header>
        <div class="detail-body" id="detail-body">
          <!-- Populated by openDetailModal() -->
        </div>
        <footer class="detail-footer">
          <button class="secondary-btn" onclick="closeDetailModal()">Close</button>
          <button class="primary-btn" onclick="editFromDetail()">Edit Scenario</button>
        </footer>
      </div>
    </dialog>

    <!-- Template Selection Dialog for New Scenario -->
    <dialog id="templateSelectDialog" aria-labelledby="templateDialogTitle">
      <form method="dialog">
        <header class="dialog-header">
          <h2 id="templateDialogTitle">Create New Scenario</h2>
          <button type="button" class="dialog-close" aria-label="Close" onclick="closeTemplateDialog()">x</button>
        </header>

        <div style="padding: 1.5rem;">
          <div class="form-group">
            <label for="newScenarioName">Scenario Name (required)</label>
            <input type="text" id="newScenarioName" required placeholder="e.g., Aggressive Growth">
          </div>

          <h3 style="margin-top: 1rem; font-size: 0.95rem;">Copy values from:</h3>
          <div class="template-options" id="templateOptions">
            <!-- Populated by showTemplateDialog() -->
          </div>
        </div>

        <footer class="dialog-footer">
          <div class="spacer"></div>
          <button type="button" class="secondary-btn" onclick="closeTemplateDialog()">Cancel</button>
          <button type="submit" value="create" class="primary-btn">Create Scenario</button>
        </footer>
      </form>
    </dialog>

    <!-- Contracted Pattern Wizard Dialog -->
    <dialog id="contractedWizardDialog">
      <div class="dialog-header">
        <h2>Apply Contracted Pattern?</h2>
        <button type="button" class="dialog-close" onclick="declineContractedPattern()">x</button>
      </div>
      <div style="padding: 1.5rem;">
        <p>Pre-fill calendar with your contracted work pattern?</p>
        <ul style="opacity: 0.8; margin: 1rem 0;">
          <li>Monday and Tuesday every week</li>
          <li>Wednesday-Friday of first week each month</li>
        </ul>
        <p style="font-size: 0.9rem; opacity: 0.7;">
          Belgian holidays are NOT auto-filled. You can override any day later.
        </p>
      </div>
      <div class="dialog-footer">
        <div class="spacer"></div>
        <button class="secondary-btn" onclick="declineContractedPattern()">Skip</button>
        <button class="primary-btn" onclick="applyContractedPattern()">Apply Pattern</button>
      </div>
    </dialog>

    <!-- Day Picker Dialog (Single Day Status) -->
    <dialog id="dayPickerDialog">
      <div class="dialog-header">
        <h2 id="pickerDateDisplay">February 15, 2026</h2>
        <button type="button" class="dialog-close" onclick="closeDayPicker()">x</button>
      </div>
      <div style="padding: 1.5rem;">
        <p id="pickerContracted" style="opacity: 0.7; margin-bottom: 1rem;"></p>

        <div class="status-options">
          <label class="status-option">
            <input type="radio" name="dayStatus" value="belgium">
            <span class="status-emoji-large">&#x1F1E7;&#x1F1EA;</span>
            <span>Belgium</span>
          </label>
          <label class="status-option">
            <input type="radio" name="dayStatus" value="spain">
            <span class="status-emoji-large">&#x1F1EA;&#x1F1F8;</span>
            <span>Spain</span>
          </label>
          <label class="status-option">
            <input type="radio" name="dayStatus" value="travel">
            <span class="status-emoji-large">&#x2708;&#xFE0F;</span>
            <span>Travel</span>
          </label>
          <label class="status-option">
            <input type="radio" name="dayStatus" value="unset">
            <span class="status-emoji-large">&#x26AA;</span>
            <span>Unset</span>
          </label>
        </div>

        <div class="picker-counts" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
          <p id="pickerMonthCount" style="opacity: 0.8;"></p>
          <p id="pickerAnnualCount" style="opacity: 0.8;"></p>
        </div>
      </div>
      <div class="dialog-footer">
        <div class="spacer"></div>
        <button class="secondary-btn" onclick="closeDayPicker()">Cancel</button>
        <button class="primary-btn" onclick="saveDayStatus()">Save</button>
      </div>
    </dialog>

    <!-- Bulk Picker Dialog (Multiple Days Status) -->
    <dialog id="bulkPickerDialog">
      <div class="dialog-header">
        <h2>Set Status for <span id="bulkCount">5</span> Days</h2>
        <button type="button" class="dialog-close" onclick="closeBulkPicker()">x</button>
      </div>
      <div style="padding: 1.5rem;">
        <p style="opacity: 0.7; margin-bottom: 1rem;">Apply status to all selected days:</p>
        <div class="status-options">
          <label class="status-option">
            <input type="radio" name="bulkStatus" value="belgium">
            <span class="status-emoji-large">&#x1F1E7;&#x1F1EA;</span>
            <span>Belgium</span>
          </label>
          <label class="status-option">
            <input type="radio" name="bulkStatus" value="spain">
            <span class="status-emoji-large">&#x1F1EA;&#x1F1F8;</span>
            <span>Spain</span>
          </label>
          <label class="status-option">
            <input type="radio" name="bulkStatus" value="travel">
            <span class="status-emoji-large">&#x2708;&#xFE0F;</span>
            <span>Travel</span>
          </label>
          <label class="status-option">
            <input type="radio" name="bulkStatus" value="unset">
            <span class="status-emoji-large">&#x26AA;</span>
            <span>Unset</span>
          </label>
        </div>
      </div>
      <div class="dialog-footer">
        <div class="spacer"></div>
        <button class="secondary-btn" onclick="closeBulkPicker()">Cancel</button>
        <button class="primary-btn" onclick="saveBulkStatus()">Apply to All</button>
      </div>
    </dialog>

    <!-- Tooltip Modal (single instance, reused for all tooltips) -->
    <dialog id="tooltipModal" class="tooltip-modal">
      <div class="tooltip-modal-content">
        <h3 id="tooltipModalTitle" class="tooltip-modal-title"></h3>
        <p id="tooltipModalText" class="tooltip-modal-text"></p>
        <button type="button" class="tooltip-modal-close" autofocus onclick="closeTooltipModal()">Got it</button>
      </div>
    </dialog>
  </div>
  <script>
    // ============================================================
    // FISCAL_2025 CONSTANTS
    // ============================================================
    // All fiscal data verified from official AEAT/BOE sources
    // See: .planning/research/FISCAL_DATA.md for full citations
    // ============================================================

    const FISCAL_2025 = Object.freeze({
      // IRPF Brackets - Combined estatal + autonomica rates
      // Source: Wolters Kluwer, AEAT - unchanged from 2024
      // https://www.wolterskluwer.com/es-es/expert-insights/tramos-retenciones-irpf-2025-novedades
      //
      // baseTax = cumulative tax from all lower brackets
      // prevLimit = upper boundary of previous bracket
      IRPF_BRACKETS: Object.freeze([
        { upTo: 12450, rate: 0.19, baseTax: 0, prevLimit: 0 },
        { upTo: 20200, rate: 0.24, baseTax: 2365.50, prevLimit: 12450 },
        { upTo: 35200, rate: 0.30, baseTax: 4225.50, prevLimit: 20200 },
        { upTo: 60000, rate: 0.37, baseTax: 8725.50, prevLimit: 35200 },
        { upTo: 300000, rate: 0.45, baseTax: 17901.50, prevLimit: 60000 },
        { upTo: Infinity, rate: 0.47, baseTax: 125901.50, prevLimit: 300000 }
      ]),

      // Personal/Family minimums
      // Source: AEAT Manual Practico IRPF 2024
      // https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2024/c14-adecuacion-impuesto-circunstancias-personales/cuadro-resumen-minimo-personal-familiar.html
      MINIMO_PERSONAL: 5550,
      MINIMO_DESCENDIENTES_PRIMERO: 2400,

      // Fixed RETA from user registration
      // This is the actual cuota paid, not a calculated value
      // Source: User's Seguridad Social registration document
      RETA_MONTHLY: 428.40,
      RETA_ANNUAL: 5140.80,

      // Gastos dificil justificacion (Estimacion Directa Simplificada)
      // Source: AEAT Estimacion Directa Simplificada
      // https://sede.agenciatributaria.gob.es/Sede/irpf/empresarios-individuales-profesionales/regimenes-determinar-rendimiento-actividad/estimacion-directa-simplificada.html
      // Note: Was 7% in 2023, reverted to 5% for 2024 onwards
      GASTOS_DIFICIL_RATE: 0.05,
      GASTOS_DIFICIL_MAX: 2000,

      // Private costs (fixed, not deductible)
      // Breakdown: Rent 70% (808.50) + GSM 50% (27.50) + Electricity 91% (91) + Auto (600) + Insurance (200)
      PRIVATE_COSTS_MONTHLY: 1727
    });

    // ============================================================
    // OFFICIAL SOURCE CITATIONS
    // ============================================================
    // All fiscal data traced to official AEAT/BOE/Seguridad Social sources
    // ============================================================

    // ============================================================
    // CALENDAR CONSTANTS
    // ============================================================
    // Data structures for Belgium presence calendar (Feb-Dec 2026)
    // ============================================================

    const CALENDAR_STORAGE_KEY = 'autonomo_calendar_v1';

    const DAY_STATUS = Object.freeze({
      UNSET: 'unset',
      BELGIUM: 'belgium',
      SPAIN: 'spain',
      TRAVEL: 'travel'
    });

    const DEFAULT_CALENDAR_STATE = Object.freeze({
      version: 1,
      year: 2026,
      startMonth: 1,  // February (0-indexed)
      endMonth: 11,   // December (0-indexed)
      days: {},       // { "2026-02-15": { status: "belgium", contracted: true } }
      contractedPatternApplied: false,
      lastModified: null,
      currentMonth: 1  // February (0-indexed) - for navigation
    });

    // ============================================================
    // CALENDAR STATE MANAGEMENT
    // ============================================================
    // localStorage persistence for calendar state
    // ============================================================

    /**
     * Convert Date to ISO date key string (YYYY-MM-DD)
     * @param {Date} date - Date object
     * @returns {string} - ISO date string like "2026-02-15"
     */
    function toISODateKey(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    /**
     * Load calendar state from localStorage
     * Falls back to DEFAULT_CALENDAR_STATE on error or invalid data
     * @returns {object} - Calendar state object (mutable clone)
     */
    function loadCalendarState() {
      try {
        const stored = localStorage.getItem(CALENDAR_STORAGE_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);
          // Version check for future migration support
          if (parsed && parsed.version === 1) {
            return parsed;
          }
        }
      } catch (e) {
        console.warn('localStorage calendar load failed:', e.message);
      }
      // Return mutable clone of defaults
      return structuredClone(DEFAULT_CALENDAR_STATE);
    }

    /**
     * Save calendar state to localStorage
     * Updates lastModified timestamp
     * @returns {boolean} - True if save succeeded
     */
    function saveCalendarState() {
      try {
        calendarState.lastModified = new Date().toISOString();
        localStorage.setItem(CALENDAR_STORAGE_KEY, JSON.stringify(calendarState));
        return true;
      } catch (e) {
        if (e.name === 'QuotaExceededError') {
          console.warn('localStorage quota exceeded - calendar state not persisted');
        } else {
          console.warn('localStorage calendar save failed:', e.message);
        }
        return false;
      }
    }

    // Global calendar state - initialized from localStorage or defaults
    let calendarState = loadCalendarState();

    // Selection state for bulk operations
    let lastClickedDate = null;
    let selectedDates = new Set();
    let unsavedChanges = false;

    // ============================================================
    // CALENDAR RENDERING FUNCTIONS
    // ============================================================
    // Month grid rendering with navigation for Feb-Dec 2026
    // ============================================================

    /**
     * Get month grid as 2D array of weeks
     * Each week is 7 cells (Date or null for empty padding)
     * Uses Monday-start week alignment
     *
     * @param {number} year - Year (e.g., 2026)
     * @param {number} month - Month (0-indexed, 0=January)
     * @returns {array} - Array of weeks, each week is array of 7 elements
     */
    function getMonthGrid(year, month) {
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const totalDays = lastDay.getDate();

      // Monday-start: convert Sunday=0 to 6, Mon=1 to 0, etc.
      const startOffset = (firstDay.getDay() + 6) % 7;

      const weeks = [];
      let currentWeek = [];

      // Add empty cells for days before month starts
      for (let i = 0; i < startOffset; i++) {
        currentWeek.push(null);
      }

      // Add days of month
      for (let day = 1; day <= totalDays; day++) {
        currentWeek.push(new Date(year, month, day));

        if (currentWeek.length === 7) {
          weeks.push(currentWeek);
          currentWeek = [];
        }
      }

      // Add empty cells to complete last week
      while (currentWeek.length > 0 && currentWeek.length < 7) {
        currentWeek.push(null);
      }
      if (currentWeek.length > 0) {
        weeks.push(currentWeek);
      }

      return weeks;
    }

    /**
     * Get status emoji for a day status
     * @param {string} status - Day status from DAY_STATUS
     * @returns {string} - Emoji character
     */
    function getStatusEmoji(status) {
      switch (status) {
        case DAY_STATUS.BELGIUM: return '\u{1F1E7}\u{1F1EA}'; // Flag Belgium
        case DAY_STATUS.SPAIN: return '\u{1F1EA}\u{1F1F8}'; // Flag Spain
        case DAY_STATUS.TRAVEL: return '\u{2708}\u{FE0F}'; // Airplane
        default: return '';
      }
    }

    /**
     * Navigate to different month
     * Updates currentMonth within bounds [startMonth, endMonth]
     *
     * @param {number} delta - Direction (-1 for prev, +1 for next)
     */
    function navigateMonth(delta) {
      const newMonth = calendarState.currentMonth + delta;
      if (newMonth >= calendarState.startMonth && newMonth <= calendarState.endMonth) {
        calendarState.currentMonth = newMonth;
        saveCalendarState();
        renderCalendar();
        updateCountDisplays();  // Update counts for new month
      }
    }

    /**
     * Render calendar for current month
     * Shows month header with navigation and day grid
     */
    function renderCalendar() {
      const container = document.getElementById('calendarContainer');
      if (!container) return;

      const year = calendarState.year;
      const month = calendarState.currentMonth;

      // Get month name
      const monthName = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' })
        .format(new Date(year, month, 1));

      // Check navigation bounds
      const canPrev = month > calendarState.startMonth;
      const canNext = month < calendarState.endMonth;

      // Build header with Select All button
      const headerHtml = `
        <div class="calendar-header">
          <button class="nav-btn" onclick="navigateMonth(-1)" ${canPrev ? '' : 'disabled'}>
            &larr; Prev
          </button>
          <div style="display: flex; align-items: center; justify-content: center;">
            <h3 style="margin: 0;">${monthName}</h3>
            <button type="button" class="month-select-all" onclick="selectMonth(${month})" title="Select all days in ${monthName}">Select All</button>
          </div>
          <button class="nav-btn" onclick="navigateMonth(1)" ${canNext ? '' : 'disabled'}>
            Next &rarr;
          </button>
        </div>
      `;

      // Build grid with week selectors
      const weeks = getMonthGrid(year, month);
      const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

      let gridHtml = '<div class="calendar-grid-with-weeks">';

      // Day headers (empty cell for week selector column)
      gridHtml += '<div class="day-header"></div>';
      dayNames.forEach(name => {
        gridHtml += `<div class="day-header">${name}</div>`;
      });

      // Day cells with week selectors
      weeks.forEach((week, weekIndex) => {
        // Find first non-null date in this week to calculate Monday
        const firstDateInWeek = week.find(d => d !== null);
        let weekStartKey = null;

        if (firstDateInWeek) {
          // Calculate the Monday of this week
          const monday = new Date(firstDateInWeek);
          const dayOfWeek = monday.getDay();
          // Adjust to Monday (0=Sunday, so Sunday needs -6, others need 1-dayOfWeek)
          const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
          monday.setDate(monday.getDate() - daysToSubtract);
          weekStartKey = toISODateKey(monday);
        }

        // Week selector button
        if (weekStartKey) {
          gridHtml += `<div class="week-selector-cell"><button type="button" class="week-selector" onclick="selectWeek('${weekStartKey}')" title="Select entire week" aria-label="Select week starting ${weekStartKey}">W</button></div>`;
        } else {
          gridHtml += '<div class="week-selector-cell"></div>';
        }

        // Day cells for this week
        week.forEach(date => {
          if (date === null) {
            gridHtml += '<div class="day-cell empty"></div>';
          } else {
            const dateKey = toISODateKey(date);
            const dayData = calendarState.days[dateKey] || {};
            const status = dayData.status || DAY_STATUS.UNSET;
            const isContracted = dayData.contracted === true;
            const emoji = getStatusEmoji(status);

            const isSelected = selectedDates.has(dateKey);
            const selectedClass = isSelected ? 'selected' : '';

            gridHtml += `
              <div class="day-cell ${status} ${selectedClass}" data-date="${dateKey}" onclick="handleDayClick('${dateKey}', event)">
                <span class="day-number">${date.getDate()}</span>
                ${isContracted ? '<span class="contracted-badge">C</span>' : ''}
                <span class="status-emoji">${emoji}</span>
              </div>
            `;
          }
        });
      });

      gridHtml += '</div>';

      container.innerHTML = headerHtml + gridHtml;
    }

    // ============================================================
    // CONTRACTED PATTERN FUNCTIONS
    // ============================================================
    // Generate contracted work pattern: Mon-Tue weekly + first-week Wed-Fri
    // ============================================================

    /**
     * Generate contracted work pattern for Feb-Dec 2026
     * Pattern: Monday and Tuesday every week, plus Wed-Fri of first week each month
     *
     * @param {number} year - Year (e.g., 2026)
     * @param {number} startMonth - Start month (0-indexed)
     * @param {number} endMonth - End month (0-indexed)
     * @returns {array} - Array of ISO date strings (contracted days)
     */
    function generateContractedPattern(year, startMonth, endMonth) {
      const contractedDays = [];
      for (let month = startMonth; month <= endMonth; month++) {
        const lastOfMonth = new Date(year, month + 1, 0);
        let isFirstWeek = true;

        for (let day = 1; day <= lastOfMonth.getDate(); day++) {
          const date = new Date(year, month, day);
          const dayOfWeek = date.getDay(); // 0=Sunday, 1=Monday, etc.

          // Monday (1) or Tuesday (2) = always contracted
          if (dayOfWeek === 1 || dayOfWeek === 2) {
            contractedDays.push(toISODateKey(date));
          }

          // First week: Wed(3), Thu(4), Fri(5) also contracted
          if (isFirstWeek && (dayOfWeek === 3 || dayOfWeek === 4 || dayOfWeek === 5)) {
            contractedDays.push(toISODateKey(date));
          }

          // End first week on Sunday (after first full week)
          if (dayOfWeek === 0 && day > 1) {
            isFirstWeek = false;
          }
        }
      }
      return contractedDays;
    }

    /**
     * Show contracted pattern wizard dialog
     * Only shows if contractedPatternApplied is false
     */
    function showContractedWizard() {
      if (calendarState.contractedPatternApplied) {
        return; // Already applied or declined
      }

      const dialog = document.getElementById('contractedWizardDialog');
      if (dialog) {
        dialog.showModal();
      }
    }

    /**
     * Apply contracted pattern to calendar
     * Marks all contracted days as Belgium with contracted flag
     */
    function applyContractedPattern() {
      const contractedDays = generateContractedPattern(
        calendarState.year,
        calendarState.startMonth,
        calendarState.endMonth
      );

      // Mark each contracted day as Belgium + contracted
      contractedDays.forEach(dateKey => {
        calendarState.days[dateKey] = {
          status: DAY_STATUS.BELGIUM,
          contracted: true
        };
      });

      calendarState.contractedPatternApplied = true;
      saveCalendarState();
      renderCalendar();
      updateCountDisplays();  // Update counts after applying pattern

      // Close dialog
      const dialog = document.getElementById('contractedWizardDialog');
      if (dialog) {
        dialog.close();
      }
    }

    /**
     * Decline contracted pattern
     * Sets flag so wizard doesn't appear again
     */
    function declineContractedPattern() {
      calendarState.contractedPatternApplied = true;
      saveCalendarState();

      // Close dialog
      const dialog = document.getElementById('contractedWizardDialog');
      if (dialog) {
        dialog.close();
      }
    }

    // ============================================================
    // DAY PICKER DIALOG FUNCTIONS
    // ============================================================
    // Open/close day picker and save status for individual days
    // ============================================================

    /**
     * Open day picker dialog for a specific date
     * Shows date info, contracted status, and current status selection
     *
     * @param {string} dateKey - ISO date key (YYYY-MM-DD)
     */
    function openDayPicker(dateKey) {
      const dialog = document.getElementById('dayPickerDialog');
      if (!dialog) return;

      // Store dateKey for save operation
      dialog.dataset.dateKey = dateKey;

      // Format date for display
      const date = new Date(dateKey);
      const dateDisplay = new Intl.DateTimeFormat('en-US', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      }).format(date);
      document.getElementById('pickerDateDisplay').textContent = dateDisplay;

      // Show contracted status
      const dayData = calendarState.days[dateKey] || {};
      const contractedEl = document.getElementById('pickerContracted');
      if (dayData.contracted) {
        contractedEl.textContent = 'Contracted work day';
      } else {
        contractedEl.textContent = '';
      }

      // Set current status radio
      const currentStatus = dayData.status || 'unset';
      const radios = dialog.querySelectorAll('input[name="dayStatus"]');
      radios.forEach(radio => {
        radio.checked = radio.value === currentStatus;
      });

      // Update count displays
      updatePickerCounts();

      dialog.showModal();
    }

    /**
     * Update the count displays in the day picker dialog
     */
    function updatePickerCounts() {
      const counts = calculateCounts();
      const monthCountEl = document.getElementById('pickerMonthCount');
      const annualCountEl = document.getElementById('pickerAnnualCount');

      if (monthCountEl) {
        monthCountEl.textContent = `${counts.monthBelgium} days in Belgium this month`;
      }
      if (annualCountEl) {
        annualCountEl.textContent = `${counts.annualThreshold} days in Belgium (annual total)`;
      }
    }

    /**
     * Save the selected status for the current day
     * Marks state as dirty (unsaved) - requires explicit Save to commit
     */
    function saveDayStatus() {
      const dialog = document.getElementById('dayPickerDialog');
      if (!dialog) return;

      const dateKey = dialog.dataset.dateKey;
      if (!dateKey) return;

      // Get selected status
      const selectedRadio = dialog.querySelector('input[name="dayStatus"]:checked');
      const newStatus = selectedRadio ? selectedRadio.value : 'unset';

      // Update calendarState.days, preserving contracted flag
      const existingData = calendarState.days[dateKey] || {};
      calendarState.days[dateKey] = {
        status: newStatus,
        contracted: existingData.contracted || false
      };

      // Mark as having unsaved changes
      markUnsaved();

      // Close dialog and re-render
      dialog.close();
      renderCalendar();
      updateCountDisplays();
    }

    /**
     * Close day picker dialog without saving
     */
    function closeDayPicker() {
      const dialog = document.getElementById('dayPickerDialog');
      if (dialog) {
        dialog.close();
      }
    }

    /**
     * Handle day cell click
     * Single click opens day picker; Shift+click selects range for bulk operation
     *
     * @param {string} dateKey - ISO date key (YYYY-MM-DD)
     * @param {Event} event - Click event
     */
    function handleDayClick(dateKey, event) {
      if (event.shiftKey && lastClickedDate) {
        // Range selection
        selectDateRange(lastClickedDate, dateKey);
      } else {
        // Single selection
        selectedDates.clear();
        selectedDates.add(dateKey);
        lastClickedDate = dateKey;
        openDayPicker(dateKey);
      }
    }

    /**
     * Select a range of dates between start and end
     * Opens bulk picker after selection
     *
     * @param {string} start - Start date key (YYYY-MM-DD)
     * @param {string} end - End date key (YYYY-MM-DD)
     */
    function selectDateRange(start, end) {
      const startDate = new Date(start);
      const endDate = new Date(end);

      // Ensure start < end
      const [from, to] = startDate <= endDate
        ? [startDate, endDate]
        : [endDate, startDate];

      selectedDates.clear();
      const current = new Date(from);
      while (current <= to) {
        // Only include dates in valid range (Feb-Dec 2026)
        const month = current.getMonth();
        if (current.getFullYear() === 2026 && month >= 1 && month <= 11) {
          selectedDates.add(toISODateKey(current));
        }
        current.setDate(current.getDate() + 1);
      }

      // Re-render to show selection, then open bulk picker
      renderCalendar();
      updateSelectionIndicator();
      openBulkPicker();
    }

    /**
     * Open bulk picker dialog for multiple selected dates
     */
    function openBulkPicker() {
      const dialog = document.getElementById('bulkPickerDialog');
      if (!dialog) return;

      // Update count display
      document.getElementById('bulkCount').textContent = selectedDates.size;

      // Default to belgium selected
      const radios = dialog.querySelectorAll('input[name="bulkStatus"]');
      radios.forEach(radio => {
        radio.checked = radio.value === 'belgium';
      });

      dialog.showModal();
    }

    /**
     * Close bulk picker dialog without saving
     */
    function closeBulkPicker() {
      const dialog = document.getElementById('bulkPickerDialog');
      if (dialog) {
        dialog.close();
      }
      // Clear selection
      selectedDates.clear();
      renderCalendar();
      updateSelectionIndicator();
    }

    /**
     * Save bulk status to all selected dates
     */
    function saveBulkStatus() {
      const dialog = document.getElementById('bulkPickerDialog');
      if (!dialog) return;

      // Get selected status
      const selectedRadio = dialog.querySelector('input[name="bulkStatus"]:checked');
      const newStatus = selectedRadio ? selectedRadio.value : 'unset';

      // Apply status to all selected dates
      selectedDates.forEach(dateKey => {
        const existingData = calendarState.days[dateKey] || {};
        calendarState.days[dateKey] = {
          status: newStatus,
          contracted: existingData.contracted || false
        };
      });

      // Mark as having unsaved changes
      markUnsaved();

      // Close dialog, clear selection, and re-render
      dialog.close();
      selectedDates.clear();
      renderCalendar();
      updateSelectionIndicator();
      updateCountDisplays();
    }

    /**
     * Mark calendar as having unsaved changes
     * Shows indicator and enables save button
     */
    function markUnsaved() {
      unsavedChanges = true;
      const indicator = document.getElementById('unsavedIndicator');
      const saveBtn = document.getElementById('saveCalendarBtn');
      if (indicator) indicator.classList.remove('hidden');
      if (saveBtn) saveBtn.disabled = false;
    }

    // ============================================================
    // MULTI-SELECT ENHANCEMENTS (BUG-05)
    // ============================================================
    // Week and month selection with selection indicator
    // ============================================================

    /**
     * Select all days in a week
     * @param {string} weekStartKey - ISO date key of week's Monday
     */
    function selectWeek(weekStartKey) {
      const start = new Date(weekStartKey);

      // Clear existing selection and add week's days
      selectedDates.clear();

      for (let i = 0; i < 7; i++) {
        const day = new Date(start);
        day.setDate(start.getDate() + i);

        // Only include valid range (Feb-Dec 2026)
        if (day.getFullYear() === 2026 && day.getMonth() >= 1) {
          selectedDates.add(toISODateKey(day));
        }
      }

      renderCalendar();
      updateSelectionIndicator();

      if (selectedDates.size > 0) {
        openBulkPicker();
      }
    }

    /**
     * Select all days in a month
     * @param {number} month - Month index (0-11)
     */
    function selectMonth(month) {
      const year = 2026;
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);  // Last day of month

      selectedDates.clear();

      const current = new Date(firstDay);
      while (current <= lastDay) {
        selectedDates.add(toISODateKey(current));
        current.setDate(current.getDate() + 1);
      }

      renderCalendar();
      updateSelectionIndicator();
      openBulkPicker();
    }

    /**
     * Update selection indicator visibility and count
     */
    function updateSelectionIndicator() {
      const indicator = document.getElementById('selectionIndicator');
      const countEl = document.getElementById('selectionCount');

      if (!indicator || !countEl) return;

      if (selectedDates.size > 0) {
        countEl.textContent = selectedDates.size;
        indicator.classList.remove('hidden');
      } else {
        indicator.classList.add('hidden');
      }
    }

    /**
     * Clear all selected dates
     */
    function clearSelection() {
      selectedDates.clear();
      renderCalendar();
      updateSelectionIndicator();
    }

    // ============================================================
    // COUNTING SYSTEM AND WARNING THRESHOLDS (Task 2)
    // ============================================================
    // Count Belgium/Spain/Travel days and display warnings
    // ============================================================

    const WARNING_THRESHOLDS = Object.freeze({
      YELLOW: 170,
      ORANGE: 180,
      RED: 183
    });

    /**
     * Calculate all day counts for current month and year
     * @returns {object} - Monthly and annual counts
     */
    function calculateCounts() {
      const days = calendarState.days;
      let monthBelgium = 0, monthTravel = 0, monthSpain = 0;
      let annualBelgium = 0, annualTravel = 0, annualSpain = 0;

      const currentMonth = calendarState.currentMonth;
      const year = calendarState.year;

      Object.entries(days).forEach(([dateKey, data]) => {
        const [y, m] = dateKey.split('-').map(Number);
        if (y !== year) return;

        // Annual counts
        if (data.status === 'belgium') annualBelgium++;
        else if (data.status === 'travel') annualTravel++;
        else if (data.status === 'spain') annualSpain++;

        // Monthly counts (for current displayed month)
        if (m - 1 === currentMonth) {  // m is 1-indexed from ISO string
          if (data.status === 'belgium') monthBelgium++;
          else if (data.status === 'travel') monthTravel++;
          else if (data.status === 'spain') monthSpain++;
        }
      });

      return {
        monthBelgium, monthTravel, monthSpain,
        annualBelgium, annualTravel, annualSpain,
        annualThreshold: annualBelgium + annualTravel  // Conservative: both count
      };
    }

    /**
     * Get warning level based on threshold count
     * @param {number} thresholdCount - Number of Belgium + Travel days
     * @returns {string|null} - 'red', 'orange', 'yellow', or null
     */
    function getWarningLevel(thresholdCount) {
      if (thresholdCount >= WARNING_THRESHOLDS.RED) return 'red';
      if (thresholdCount >= WARNING_THRESHOLDS.ORANGE) return 'orange';
      if (thresholdCount >= WARNING_THRESHOLDS.YELLOW) return 'yellow';
      return null;
    }

    /**
     * Update count displays and warning banners
     * Called after any day status change
     */
    function updateCountDisplays() {
      const counts = calculateCounts();

      const monthCountEl = document.getElementById('monthBelgiumCount');
      const annualCountEl = document.getElementById('annualBelgiumCount');
      if (monthCountEl) monthCountEl.textContent = counts.monthBelgium;
      if (annualCountEl) annualCountEl.textContent = counts.annualThreshold;

      const warningLevel = getWarningLevel(counts.annualThreshold);
      const badge = document.getElementById('warningBadge');
      const banner = document.getElementById('warningBanner');

      // Reset classes
      if (badge) badge.className = 'warning-badge hidden';
      if (banner) banner.className = 'warning-banner hidden';

      if (warningLevel && badge && banner) {
        badge.className = `warning-badge ${warningLevel}`;
        badge.textContent = warningLevel === 'red' ? 'EXCEEDED' : 'WARNING';

        banner.className = `warning-banner ${warningLevel}`;
        const messages = {
          yellow: `Approaching threshold: ${counts.annualThreshold} days in Belgium (183 triggers residency review)`,
          orange: `Very close to threshold: ${counts.annualThreshold} days in Belgium (183 triggers residency review)`,
          red: `Threshold exceeded: ${counts.annualThreshold} days in Belgium (exceeds 183-day limit)`
        };
        banner.textContent = messages[warningLevel];
      }
    }

    /**
     * Commit calendar changes to localStorage
     * Clears unsaved indicator and disables save button
     */
    function commitCalendarChanges() {
      calendarState.lastModified = new Date().toISOString();
      saveCalendarState();
      unsavedChanges = false;
      const indicator = document.getElementById('unsavedIndicator');
      const saveBtn = document.getElementById('saveCalendarBtn');
      if (indicator) indicator.classList.add('hidden');
      if (saveBtn) saveBtn.disabled = true;
      // Update compliance warning banner when calendar changes are saved
      updateComplianceWarning();
    }

    // ============================================================
    // CALENDAR EXPORT FUNCTIONS (Task 1)
    // ============================================================
    // ICS and CSV export with Blob API download
    // ============================================================

    /**
     * Format date for ICS timestamp (YYYYMMDDTHHMMSSZ format)
     * @param {Date} date - Date to format
     * @returns {string} - ICS formatted timestamp
     */
    function formatICSTimestamp(date) {
      return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
    }

    /**
     * Generate ICS (iCalendar) content for all marked days
     * Follows RFC 5545 specification
     * @returns {string} - Valid ICS file content
     */
    function generateICS() {
      const events = Object.entries(calendarState.days)
        .filter(([_, data]) => data.status && data.status !== 'unset')
        .map(([dateKey, data]) => {
          const date = new Date(dateKey);
          const nextDay = new Date(date);
          nextDay.setDate(nextDay.getDate() + 1);

          const statusText = {
            belgium: 'Belgium Work Day',
            spain: 'Spain',
            travel: 'Travel Day'
          }[data.status];

          const contractedNote = data.contracted ? ' (Contracted)' : '';

          // ICS format for all-day events
          return `BEGIN:VEVENT
UID:${dateKey}-autonomo@tax-calculator
DTSTAMP:${formatICSTimestamp(new Date())}
DTSTART;VALUE=DATE:${dateKey.replace(/-/g, '')}
DTEND;VALUE=DATE:${toISODateKey(nextDay).replace(/-/g, '')}
SUMMARY:${statusText}${contractedNote}
DESCRIPTION:${statusText} - Autonomo Tax Calculator Belgium Tracking
END:VEVENT`;
        });

      return `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Autonomo Tax Calculator//Belgium Calendar//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:Belgium Work Calendar 2026
${events.join('\n')}
END:VCALENDAR`;
    }

    /**
     * Download ICS file via Blob API
     * Creates temporary anchor element for download
     */
    function downloadICS() {
      const ics = generateICS();
      const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'belgium-calendar-2026.ics';
      document.body.appendChild(a);
      a.click();

      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    /**
     * Escape a field value for CSV (handles quotes, commas, newlines)
     * @param {any} value - Value to escape
     * @returns {string} - CSV-safe string
     */
    function escapeCSVField(value) {
      if (value == null) return '';
      const str = String(value);
      if (str.search(/("|,|\n)/g) >= 0) {
        return '"' + str.replace(/"/g, '""') + '"';
      }
      return str;
    }

    /**
     * Generate CSV content for all marked days
     * Includes headers, data rows, and summary section
     * @returns {string} - CSV file content
     */
    function generateCSV() {
      const headers = ['Date', 'Day of Week', 'Status', 'Contracted', 'Month'];
      const rows = Object.entries(calendarState.days)
        .filter(([_, data]) => data.status && data.status !== 'unset')
        .sort(([a], [b]) => a.localeCompare(b))
        .map(([dateKey, data]) => {
          const date = new Date(dateKey);
          return [
            dateKey,
            date.toLocaleDateString('en-GB', { weekday: 'long' }),
            data.status,
            data.contracted ? 'Yes' : 'No',
            date.toLocaleDateString('en-GB', { month: 'long' })
          ];
        });

      // Add summary rows at bottom
      const counts = calculateCounts();
      const summaryRows = [
        [],  // Empty row
        ['SUMMARY'],
        ['Total Belgium Days', counts.annualBelgium],
        ['Total Travel Days', counts.annualTravel],
        ['Total Spain Days', counts.annualSpain],
        ['Combined (Belgium + Travel)', counts.annualThreshold],
        ['183-day Threshold', counts.annualThreshold >= 183 ? 'EXCEEDED' : 'OK']
      ];

      const allRows = [headers, ...rows, ...summaryRows];
      return allRows.map(row => row.map(escapeCSVField).join(',')).join('\n');
    }

    /**
     * Download CSV file via Blob API
     * Creates temporary anchor element for download
     */
    function downloadCSV() {
      const csv = generateCSV();
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'belgium-calendar-2026.csv';
      document.body.appendChild(a);
      a.click();

      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ============================================================
    // CLIPBOARD COPY AND NOTIFICATION (Task 2)
    // ============================================================
    // Copy summary to clipboard with visual feedback notification
    // ============================================================

    /**
     * Show notification toast with auto-hide
     * @param {string} message - Message to display
     * @param {string} type - 'success' or 'error'
     */
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type}`;

      // Auto-hide after 3 seconds
      setTimeout(() => {
        notification.classList.add('hidden');
      }, 3000);
    }

    /**
     * Generate monthly breakdown text for summary
     * @returns {string} - Formatted monthly breakdown
     */
    function generateMonthlyBreakdown() {
      const months = ['Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const breakdown = [];

      for (let m = 1; m <= 11; m++) {  // Feb(1) to Dec(11) - 0-indexed months
        let belgium = 0, travel = 0, spain = 0;

        Object.entries(calendarState.days).forEach(([dateKey, data]) => {
          const month = parseInt(dateKey.split('-')[1], 10) - 1;  // Convert to 0-indexed
          if (month === m) {
            if (data.status === 'belgium') belgium++;
            else if (data.status === 'travel') travel++;
            else if (data.status === 'spain') spain++;
          }
        });

        if (belgium + travel + spain > 0) {
          breakdown.push(`  ${months[m - 1]}: ${belgium} BE, ${travel} Travel, ${spain} ES`);
        }
      }

      return breakdown.length > 0 ? breakdown.join('\n') : '  No days marked yet';
    }

    /**
     * Copy calendar summary to clipboard
     * Shows notification on success/failure
     */
    async function copyToClipboard() {
      const counts = calculateCounts();
      const warningLevel = getWarningLevel(counts.annualThreshold);
      const warningText = warningLevel
        ? `\nWARNING: ${counts.annualThreshold >= 183 ? 'THRESHOLD EXCEEDED' : 'Approaching threshold'}`
        : '';

      const summary = `Belgium Calendar 2026 Summary
============================
Total Belgium days: ${counts.annualBelgium}
Total Travel days: ${counts.annualTravel}
Total Spain days: ${counts.annualSpain}
Combined (Belgium + Travel): ${counts.annualThreshold}
183-day threshold status: ${counts.annualThreshold >= 183 ? 'EXCEEDED' : 'OK'}${warningText}

Monthly Breakdown:
${generateMonthlyBreakdown()}

Note: Entry and exit days may count in BOTH Belgium and Spain.
Generated by Autonomo Tax Calculator`;

      try {
        await navigator.clipboard.writeText(summary);
        showNotification('Summary copied to clipboard!');
      } catch (err) {
        console.error('Clipboard write failed:', err);
        showNotification('Copy failed - please try again', 'error');
      }
    }

    const SOURCES = Object.freeze({
      IRPF_BRACKETS: {
        name: "IRPF Tramos 2025",
        source: "AEAT / Wolters Kluwer",
        url: "https://www.wolterskluwer.com/es-es/expert-insights/tramos-retenciones-irpf-2025-novedades",
        note: "Unchanged from 2024. Combined estatal + autonomica rates.",
        confidence: "HIGH"
      },
      MINIMO_PERSONAL: {
        name: "Minimo del Contribuyente",
        source: "AEAT Manual Practico IRPF 2024",
        url: "https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2024/c14-adecuacion-impuesto-circunstancias-personales/cuadro-resumen-minimo-personal-familiar.html",
        note: "5,550 EUR for all taxpayers regardless of age.",
        confidence: "HIGH"
      },
      MINIMO_DESCENDIENTES: {
        name: "Minimo por Descendientes",
        source: "AEAT",
        url: "https://sede.agenciatributaria.gob.es/Sede/ciudadanos-familias-personas-discapacidad/minimo-personal-familiar/minimo-descendientes.html",
        note: "2,400 EUR for first child. Add 2,800 EUR if under 3 years old.",
        confidence: "HIGH"
      },
      RETA: {
        name: "Cuota RETA",
        source: "User registration document / BOE",
        url: "https://www.boe.es/diario_boe/txt.php?id=BOE-A-2025-3780",
        note: "Fixed cuota 428.40 EUR/month from autonomo registration.",
        confidence: "HIGH"
      },
      GASTOS_DIFICIL: {
        name: "Gastos de Dificil Justificacion",
        source: "AEAT Estimacion Directa Simplificada",
        url: "https://sede.agenciatributaria.gob.es/Sede/irpf/empresarios-individuales-profesionales/regimenes-determinar-rendimiento-actividad/estimacion-directa-simplificada.html",
        note: "5% of rendimiento neto, maximum 2,000 EUR/year. Was 7% only in 2023.",
        confidence: "HIGH"
      },
      MINIMO_APPLICATION: {
        name: "4-Phase Minimo Method",
        source: "AEAT Cuotas Integras Example",
        url: "https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2022/c15-calculo-impuesto-determinacion-cuotas-integras/ejemplo-practico-calculo-cuotas-integras-autonomica.html",
        note: "Minimos reduce TAX LIABILITY, not taxable base. Tax on minimo is subtracted from tax on full base.",
        confidence: "HIGH"
      },
      DIETAS: {
        name: "Dietas y Asignaciones para Gastos de Viaje",
        source: "Reglamento IRPF Art. 9",
        url: "https://www.boe.es/buscar/act.php?id=BOE-A-2007-6820&tn=1&p=20231228#a9",
        note: "Abroad: 91.35 EUR/day with overnight, 48.08 EUR without. Spain: 53.34 EUR/day with overnight, 26.67 EUR without.",
        confidence: "HIGH"
      }
    });

    // ===========================================
    // PHASE 7: COMPLIANCE CONSTANTS
    // ===========================================

    const DIETAS_LIMITS = Object.freeze({
      spain: {
        withOvernight: 53.34,
        withoutOvernight: 26.67
      },
      abroad: {
        withOvernight: 91.35,
        withoutOvernight: 48.08
      },
      source: 'Art. 9 Reglamento IRPF (RD 439/2007)'
    });

    const TREATY_ARTICLE_4 = Object.freeze({
      title: 'Article 4: Tax Residence Tie-Breaker',
      source: 'Spain-Belgium Tax Treaty (BOE-A-2003-13375)',
      steps: [
        {
          name: 'Permanent Home',
          legal: 'vivienda permanente a su disposicion',
          plain: 'The country where you have a permanent home available to you. If only in one country, that country is your tax residence.'
        },
        {
          name: 'Center of Vital Interests',
          legal: 'centro de intereses vitales - relaciones personales y economicas mas estrechas',
          plain: 'If permanent homes in both countries: where your personal ties (family, social life) and economic ties (work, assets) are strongest. Family location receives special weight per OECD Commentary.'
        },
        {
          name: 'Habitual Abode',
          legal: 'viva habitualmente',
          plain: 'If center cannot be determined: the country where you spend more time overall.'
        },
        {
          name: 'Nationality',
          legal: 'nacional',
          plain: 'If habitual abode is equal: the country of your citizenship.'
        },
        {
          name: 'Mutual Agreement',
          legal: 'autoridades competentes resolveran de comun acuerdo',
          plain: 'If dual national or none: tax authorities of both countries negotiate.'
        }
      ]
    });

    const ARTICLE_9_1_B = Object.freeze({
      title: 'Art. 9.1.b LIRPF: Family Presumption',
      source: 'Ley 35/2006, Art. 9.1.b (BOE-A-2006-20764)',
      legalText: 'Se presumira, salvo prueba en contrario, que el contribuyente tiene su residencia habitual en territorio espanol cuando, de acuerdo con los criterios anteriores, resida habitualmente en Espana el conyuge no separado legalmente y los hijos menores de edad que dependan de aquel.',
      plainSummary: 'If your non-legally-separated spouse AND/OR dependent minor children habitually reside in Spain, Spanish law PRESUMES you are also a Spanish tax resident. This presumption is "rebuttable" (can be challenged), but the burden of proof shifts to you to demonstrate your tax residence is elsewhere.',
      implication: 'For a person with family in Spain, this presumption operates in your FAVOR when another country might claim tax residency. Spain starts from the position that you are Spanish resident based on family ties, making it easier to defend Spanish tax residence under treaty tie-breaker rules.'
    });

    const FACTURA_REQUIREMENTS = Object.freeze({
      title: 'Factura Completa Requirements',
      source: 'AEAT - Reglamento de Facturacion',
      required: [
        { field: 'Numero de factura', description: 'Sequential invoice number' },
        { field: 'Fecha de emision', description: 'Issue date' },
        { field: 'NIF del emisor', description: 'Supplier tax ID' },
        { field: 'Nombre/Razon social emisor', description: 'Supplier name or company' },
        { field: 'Domicilio fiscal emisor', description: 'Supplier address' },
        { field: 'NIF del destinatario', description: 'YOUR tax ID (autonomo NIF)' },
        { field: 'Nombre destinatario', description: 'YOUR name' },
        { field: 'Domicilio fiscal destinatario', description: 'YOUR fiscal address' },
        { field: 'Descripcion', description: 'Description of goods/services' },
        { field: 'Base imponible', description: 'Taxable amount before IVA' },
        { field: 'Tipo de IVA', description: 'IVA rate (if applicable)' },
        { field: 'Cuota de IVA', description: 'IVA amount' },
        { field: 'Total', description: 'Total amount' }
      ],
      notValid: [
        { type: 'Ticket/Receipt', reason: 'Missing recipient identification' },
        { type: 'Factura simplificada', reason: 'Lacks full recipient data for IRPF deduction' },
        { type: 'Bank statement alone', reason: 'Not proof of business expense' },
        { type: 'Airbnb confirmation email', reason: 'Not a valid tax invoice' }
      ]
    });

    // ============================================================
    // PHASE 7: DISCLAIMER CONSTANT
    // ============================================================

    const DISCLAIMER = Object.freeze({
      title: 'Disclaimer',
      text: 'This calculator provides estimates for informational and educational purposes only. It does not constitute tax, legal, or financial advice. Tax laws are complex, subject to change, and vary by individual circumstances. Your actual tax liability may differ from these estimates. Always consult with a qualified tax professional (asesor fiscal, gestor) for guidance specific to your situation before making any financial decisions or filing tax returns.',
      shortVersion: 'For informational purposes only. Consult a qualified tax professional for advice specific to your situation.'
    });

    // ============================================================
    // TOOLTIPS (UI-09)
    // ============================================================
    // Accessible tooltip definitions for technical tax terms
    // ============================================================

    const TOOLTIPS = Object.freeze({
      irpf: {
        title: 'IRPF (Impuesto sobre la Renta)',
        text: 'Spanish personal income tax. Progressive rates from 19% to 47% based on taxable income brackets.'
      },
      reta: {
        title: 'RETA (Regimen Especial)',
        text: 'Spanish social security contribution for self-employed. Fixed monthly quota (cuota) based on income tramo.'
      },
      minimo: {
        title: 'Minimo Personal',
        text: 'Tax-free personal allowance (5,550 EUR). Reduces the tax owed, not the taxable base.'
      },
      descendientes: {
        title: 'Minimo por Descendientes',
        text: 'Child allowance (2,400 EUR for first child). Reduces tax liability after rate application.'
      },
      gastos: {
        title: 'Gastos de Dificil Justificacion',
        text: '5% deduction on net income for hard-to-document expenses. Capped at 2,000 EUR annually.'
      },
      leefgeld: {
        title: 'Disposable Income',
        text: 'Money remaining after all taxes AND private living costs. Your true take-home pay.'
      },
      dietas: {
        title: 'Dietas (Per Diem)',
        text: 'Tax-exempt daily allowance for work travel. Belgium: 91.35 EUR with overnight stay.'
      },
      treaty: {
        title: 'Spain-Belgium Tax Treaty',
        text: 'Bilateral agreement preventing double taxation. Article 4 defines tax residency rules.'
      }
    });

    /**
     * Create clickable tooltip trigger that opens modal
     * @param {string} term - Key from TOOLTIPS constant
     * @param {string} displayText - Text to display as trigger
     * @returns {string} - HTML with click trigger or just displayText if term not found
     */
    function createTooltip(term, displayText) {
      const tooltip = TOOLTIPS[term];
      if (!tooltip) return displayText;

      // Escape quotes for inline handlers
      const title = tooltip.title.replace(/'/g, "\\'").replace(/"/g, '&quot;');
      const text = tooltip.text.replace(/'/g, "\\'").replace(/"/g, '&quot;');

      return `<span class="term-tooltip-trigger" tabindex="0"
        onclick="openTooltipModal('${title}', '${text}')"
        onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openTooltipModal('${title}', '${text}')}"
        role="button"
        aria-label="Learn more about ${tooltip.title}">
        ${displayText}<span class="info-icon">i</span>
      </span>`;
    }

    /**
     * Open tooltip modal with title and text
     * @param {string} title - Modal title
     * @param {string} text - Modal body text
     */
    function openTooltipModal(title, text) {
      const dialog = document.getElementById('tooltipModal');
      if (!dialog) return;

      document.getElementById('tooltipModalTitle').textContent = title;
      document.getElementById('tooltipModalText').textContent = text;
      dialog.showModal();
    }

    /**
     * Close tooltip modal
     */
    function closeTooltipModal() {
      const dialog = document.getElementById('tooltipModal');
      if (dialog) dialog.close();
    }

    // ============================================================
    // EXPENSE DATA CONSTANTS
    // ============================================================
    // Pre-filled expense data for Spain deductible, Belgium costs, and private
    // All amounts from CLAUDE.md Fixed Costs section
    // ============================================================

    const DEFAULT_EXPENSES = Object.freeze({
      version: 1,
      categories: Object.freeze({
        spainDeductible: Object.freeze([
          Object.freeze({ id: 'huur', name: 'Rent (30% deductible)', baseAmount: 1155, deductionPct: 30, deletable: true }),
          Object.freeze({ id: 'gsm', name: 'Mobile (50% deductible)', baseAmount: 55, deductionPct: 50, deletable: true }),
          Object.freeze({ id: 'elektriciteit', name: 'Electricity (9% deductible)', baseAmount: 100, deductionPct: 9, deletable: true })
        ]),
        workTravel: Object.freeze([
          Object.freeze({ id: 'belgium-travel-low', name: 'Belgium Travel (Standard)', amount: 1000, description: '3 days, 1 flight (Mon-Wed pattern)', deletable: true }),
          Object.freeze({ id: 'belgium-travel-high', name: 'Belgium Travel (Extended)', amount: 2500, description: '17 days, 4 flights (full week pattern)', deletable: true })
        ]),
        private: Object.freeze([
          Object.freeze({ id: 'huur-private', name: 'Rent (70% private)', amount: 808.50, deletable: true }),
          Object.freeze({ id: 'gsm-private', name: 'Mobile (50% private)', amount: 27.50, deletable: true }),
          Object.freeze({ id: 'elektriciteit-private', name: 'Electricity (91% private)', amount: 91, deletable: true }),
          Object.freeze({ id: 'auto', name: 'Car', amount: 600, deletable: true }),
          Object.freeze({ id: 'verzekeringen', name: 'Insurance', amount: 200, deletable: true })
        ])
      })
    });

    // ============================================================
    // LOCALSTORAGE PERSISTENCE
    // ============================================================
    // Expense data persists between browser sessions
    // Graceful fallback for Safari private mode and quota errors
    // ============================================================

    const STORAGE_KEY = 'autonomo_expenses_v1';

    /**
     * Migrate old expense data format to new work-travel structure
     * Converts belgiumPattern + belgiumCosts to workTravel category
     * @param {object} data - Expense data object
     * @returns {object} - Migrated expense data
     */
    function migrateExpenseData(data) {
      // Migrate old belgiumPattern to new work-travel expenses
      if (data.belgiumPattern !== undefined || data.categories.belgiumCosts !== undefined) {
        const amount = data.belgiumPattern === 'high' ? 2500 : 1000;

        // Create workTravel category from old data
        if (!data.categories.workTravel) {
          data.categories.workTravel = [
            { id: 'belgium-travel-migrated', name: 'Belgium Travel', amount: amount,
              description: 'Migrated from pattern', deletable: true }
          ];
        }

        // Remove old belgiumCosts category and belgiumPattern
        delete data.categories.belgiumCosts;
        delete data.belgiumPattern;

        console.log('Migrated expense data from belgiumPattern to workTravel');
      }

      return data;
    }

    /**
     * Load expenses from localStorage
     * Falls back to DEFAULT_EXPENSES on error or invalid data
     * @returns {object} - Expense data object (mutable clone)
     */
    function loadExpenses() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);
          // Version check for future migration support
          if (parsed && parsed.version === 1) {
            // Apply migration for old data format
            return migrateExpenseData(parsed);
          }
        }
      } catch (e) {
        console.warn('localStorage load failed (Safari private mode?):', e.message);
      }
      // Return mutable clone of defaults
      return structuredClone(DEFAULT_EXPENSES);
    }

    /**
     * Save expenses to localStorage
     * Handles QuotaExceededError gracefully
     * @returns {boolean} - True if save succeeded
     */
    function saveExpenses() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(expenseData));
        return true;
      } catch (e) {
        if (e.name === 'QuotaExceededError') {
          console.warn('localStorage quota exceeded - changes not persisted');
        } else {
          console.warn('localStorage save failed:', e.message);
        }
        return false;
      }
    }

    // Global expense data - initialized from localStorage or defaults
    let expenseData = loadExpenses();

    // ============================================================
    // SCENARIO PRESETS
    // ============================================================
    // Pre-configured scenarios (A-E) from CLAUDE.md
    // Values: A(3K), B(6K), C(9K), D(12K), E(18K)
    // Belgium patterns: A/B use 'low' (1K), C/D/E use 'high' (2.5K)
    // ============================================================

    const SCENARIO_PRESETS = Object.freeze({
      'A': Object.freeze({
        id: 'A',
        name: 'Scenario A',
        isPreset: true,
        monthlyRevenue: 3000,
        monthlyExpenses: 750,
        workTravelCost: 1000,  // Standard pattern: 3 days, 1 flight
        hasDescendant: true,
        fiscalOverrides: null
      }),
      'B': Object.freeze({
        id: 'B',
        name: 'Scenario B',
        isPreset: true,
        monthlyRevenue: 6000,
        monthlyExpenses: 1500,
        workTravelCost: 1000,  // Standard pattern
        hasDescendant: true,
        fiscalOverrides: null
      }),
      'C': Object.freeze({
        id: 'C',
        name: 'Scenario C',
        isPreset: true,
        monthlyRevenue: 9000,
        monthlyExpenses: 3000,
        workTravelCost: 2500,  // Extended pattern: 17 days, 4 flights
        hasDescendant: true,
        fiscalOverrides: null
      }),
      'D': Object.freeze({
        id: 'D',
        name: 'Scenario D',
        isPreset: true,
        monthlyRevenue: 12000,
        monthlyExpenses: 5000,
        workTravelCost: 2500,  // Extended pattern
        hasDescendant: true,
        fiscalOverrides: null
      }),
      'E': Object.freeze({
        id: 'E',
        name: 'Scenario E',
        isPreset: true,
        monthlyRevenue: 18000,
        monthlyExpenses: 8000,
        workTravelCost: 2500,  // Extended pattern
        hasDescendant: true,
        fiscalOverrides: null
      })
    });

    // ============================================================
    // SCENARIO STATE MANAGEMENT
    // ============================================================
    // Centralized state with localStorage persistence
    // ============================================================

    const SCENARIO_STORAGE_KEY = 'autonomo_scenarios_v1';

    // Scenario state - initialized on DOMContentLoaded
    let scenarioState = null;

    /**
     * Initialize scenario state from localStorage or defaults
     * @returns {object} - Scenario state object
     */
    function initScenarioState() {
      try {
        const stored = localStorage.getItem(SCENARIO_STORAGE_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);
          if (parsed.version === 1) {
            return parsed;
          }
        }
      } catch (e) {
        console.warn('Failed to load scenarios:', e.message);
      }
      // Return default state with presets
      return {
        version: 1,
        scenarios: structuredClone(SCENARIO_PRESETS),
        selected: [],
        customOrder: []
      };
    }

    /**
     * Save scenario state to localStorage
     * @returns {boolean} - True if save succeeded
     */
    function saveScenarioState() {
      try {
        localStorage.setItem(SCENARIO_STORAGE_KEY, JSON.stringify(scenarioState));
        return true;
      } catch (e) {
        console.warn('Failed to save scenarios:', e.message);
        return false;
      }
    }

    // ============================================================
    // SCENARIO CALCULATION FUNCTIONS
    // ============================================================
    // Extends Phase 1 calculateFullIRPF with fiscal override support
    // ============================================================

    /**
     * Calculate full IRPF with optional fiscal configuration overrides
     * This is a copy of Phase 1's calculateFullIRPF but accepts a fiscal parameter
     * for what-if analysis (scenarios can override RETA, minimos, brackets)
     *
     * @param {number} monthlyRevenue - Gross monthly revenue in EUR
     * @param {number} monthlyDeductibleExpenses - Monthly deductible business expenses in EUR
     * @param {boolean} hasDescendant - Whether user has 1 dependent child
     * @param {object|null} fiscal - Optional fiscal config overrides (defaults to FISCAL_2025)
     * @returns {object} - Complete calculation breakdown
     */
    function calculateFullIRPFWithFiscal(monthlyRevenue, monthlyDeductibleExpenses = 0, hasDescendant = true, fiscal = null) {
      // Use provided fiscal config or default to FISCAL_2025
      const config = fiscal || FISCAL_2025;

      // Step 1: Annualize inputs
      const annualRevenue = monthlyRevenue * 12;
      const annualExpenses = monthlyDeductibleExpenses * 12;

      // Step 2: Total deductible = expenses + RETA
      const retaAnnual = config.RETA_ANNUAL || FISCAL_2025.RETA_ANNUAL;
      const totalDeductible = annualExpenses + retaAnnual;

      // Step 3: Rendimiento Neto Previo (before gastos dificil)
      const rendimientoNetoPrevio = annualRevenue - totalDeductible;

      // Step 4: Gastos dificil justificacion (use FISCAL_2025 rates - these don't change)
      const gastosDificil = calculateGastosDificil(rendimientoNetoPrevio);

      // Step 5: Rendimiento Neto = Base Liquidable (for autonomo)
      const rendimientoNeto = rendimientoNetoPrevio - gastosDificil;
      const baseLiquidable = Math.max(0, rendimientoNeto);

      // Step 6: Calculate minimos (can be overridden)
      const minimoPersonal = config.MINIMO_PERSONAL || FISCAL_2025.MINIMO_PERSONAL;
      const minimoDescendientes = hasDescendant
        ? (config.MINIMO_DESCENDIENTES_PRIMERO || FISCAL_2025.MINIMO_DESCENDIENTES_PRIMERO)
        : 0;
      const minimoTotal = minimoPersonal + minimoDescendientes;

      // Step 7: Cuota Integra using 4-phase method
      const cuotaIntegra = calculateCuotaIntegra(baseLiquidable, minimoTotal);

      // Step 8: Effective tax rate
      const effectiveRate = rendimientoNeto > 0 ? (cuotaIntegra / rendimientoNeto) : 0;

      // Step 9: Net income calculations
      const netAnnual = annualRevenue - totalDeductible - gastosDificil - cuotaIntegra;
      const netMonthly = netAnnual / 12;

      // Step 10: Leefgeld (after private costs)
      const privateCostsMonthly = config.PRIVATE_COSTS_MONTHLY || FISCAL_2025.PRIVATE_COSTS_MONTHLY;
      const leefgeld = netMonthly - privateCostsMonthly;

      const retaMonthly = config.RETA_MONTHLY || FISCAL_2025.RETA_MONTHLY;

      // Return all values matching Phase 1's calculateFullIRPF return structure
      return {
        // Inputs
        monthlyRevenue,
        annualRevenue,
        monthlyExpenses: monthlyDeductibleExpenses,
        annualExpenses,

        // Deductions
        retaMonthly,
        retaAnnual,
        totalDeductible,

        // Calculation chain
        rendimientoNetoPrevio,
        gastosDificil,
        rendimientoNeto,
        baseLiquidable,

        // Minimos (for display)
        minimoPersonal,
        minimoDescendientes,
        minimoTotal,

        // Tax
        cuotaIntegra,
        effectiveRate,

        // Net income
        netAnnual,
        netMonthly,
        leefgeld,

        // Private costs (for reference)
        privateCostsMonthly
      };
    }

    /**
     * Calculate results for a scenario
     * Wraps calculateFullIRPFWithFiscal with scenario-specific inputs
     *
     * @param {object} scenario - Scenario object
     * @returns {object} - Complete calculation results
     */
    function calculateScenarioResults(scenario) {
      const workTravelCost = getWorkTravelCost(scenario);
      const totalDeductible = scenario.monthlyExpenses + workTravelCost;

      // Allow fiscal overrides for what-if analysis
      const fiscal = scenario.fiscalOverrides
        ? { ...FISCAL_2025, ...scenario.fiscalOverrides }
        : FISCAL_2025;

      // Call calculateFullIRPFWithFiscal (derived from Phase 1's calculateFullIRPF)
      return calculateFullIRPFWithFiscal(
        scenario.monthlyRevenue,
        totalDeductible,
        scenario.hasDescendant,
        fiscal
      );
    }

    /**
     * Get work travel cost for a scenario
     * Supports both new workTravelCost property and legacy belgiumPattern
     * @param {object} scenario - Scenario object
     * @returns {number} - Monthly work travel cost
     */
    function getWorkTravelCost(scenario) {
      if (scenario.workTravelCost !== undefined) {
        return scenario.workTravelCost;
      }
      // Legacy support for old belgiumPattern
      return scenario.belgiumPattern === 'high' ? 2500 : 1000;
    }

    /**
     * Get all scenarios sorted by leefgeld (highest first)
     * Each scenario includes its calculated results
     *
     * @returns {array} - Array of scenarios with results, sorted by leefgeld descending
     */
    function getSortedScenarios() {
      const scenarios = Object.values(scenarioState.scenarios);
      return scenarios
        .map(s => ({
          ...s,
          results: calculateScenarioResults(s)
        }))
        .sort((a, b) => b.results.leefgeld - a.results.leefgeld);
    }

    // ============================================================
    // DEPRECATED: Belgium pattern toggle functions removed
    // Work travel expenses are now editable items like other categories
    // Migration function in loadExpenses() handles old localStorage data
    // ============================================================

    // ============================================================
    // EXPENSE DATA MANAGEMENT
    // ============================================================
    // Reset, calculation helpers, and totals for expense tracking
    // ============================================================

    /**
     * Reset all expenses to default values with confirmation
     * @returns {boolean} - True if reset occurred
     */
    function resetToDefaults() {
      if (confirm('Reset all expenses to default values? This cannot be undone.')) {
        expenseData = structuredClone(DEFAULT_EXPENSES);
        saveExpenses();
        renderAllSections();
        recalculateTotals();
        return true;
      }
      return false;
    }

    /**
     * Calculate deductible amount for an expense
     * Spain expenses have baseAmount * deductionPct; others use amount directly
     * @param {object} expense - Expense object
     * @returns {number} - Monthly deductible amount (rounded to 2 decimals)
     */
    function calculateDeductible(expense) {
      if (expense.baseAmount !== undefined && expense.deductionPct !== undefined) {
        return Math.round(expense.baseAmount * (expense.deductionPct / 100) * 100) / 100;
      }
      return Math.round((expense.amount || 0) * 100) / 100;
    }

    /**
     * Calculate total deductible for a category
     * @param {string} categoryKey - Key in expenseData.categories
     * @returns {number} - Total monthly amount (rounded to 2 decimals)
     */
    function calculateCategoryTotal(categoryKey) {
      const category = expenseData.categories[categoryKey];
      if (!category) return 0;

      const total = category.reduce((sum, exp) => sum + calculateDeductible(exp), 0);
      return Math.round(total * 100) / 100;
    }

    /**
     * Get all expense totals for integration with IRPF calculation
     * @returns {object} - Monthly and annual totals per category
     */
    function getExpenseTotals() {
      const spainMonthly = calculateCategoryTotal('spainDeductible');
      const workTravelMonthly = calculateCategoryTotal('workTravel');
      const privateMonthly = calculateCategoryTotal('private');

      return {
        spainDeductible: {
          monthly: spainMonthly,
          annual: Math.round(spainMonthly * 12 * 100) / 100
        },
        workTravel: {
          monthly: workTravelMonthly,
          annual: Math.round(workTravelMonthly * 12 * 100) / 100
        },
        private: {
          monthly: privateMonthly,
          annual: Math.round(privateMonthly * 12 * 100) / 100
        },
        totalDeductible: {
          monthly: Math.round((spainMonthly + workTravelMonthly) * 100) / 100,
          annual: Math.round((spainMonthly + workTravelMonthly) * 12 * 100) / 100
        }
      };
    }

    // ============================================================
    // EXPENSE SECTION RENDERING
    // ============================================================
    // Render expense sections with formulas, delete buttons, and totals
    // ============================================================

    /**
     * Format expense calculation formula for display
     * Shows transparent calculation: BASE x PERCENT% = RESULT
     * @param {object} expense - Expense object
     * @param {string} categoryKey - Category key for context
     * @returns {string} - Formatted formula string
     */
    function formatFormula(expense, categoryKey) {
      if (expense.baseAmount !== undefined && expense.deductionPct !== undefined) {
        // Spain deductible: show base x percent
        const result = expense.baseAmount * (expense.deductionPct / 100);
        return `${formatEUR(expense.baseAmount)} x ${expense.deductionPct}% = ${formatEUR(result)}`;
      } else if (categoryKey === 'private') {
        // Private: 0% deductible
        return `${formatEUR(expense.amount)} x 0% = ${formatEUR(0)}`;
      } else {
        // Belgium costs: 100% deductible
        return `${formatEUR(expense.amount)} x 100% = ${formatEUR(expense.amount)}`;
      }
    }

    /**
     * Render a single expense row with formula and delete button
     * @param {object} expense - Expense object
     * @param {string} categoryKey - Category key
     * @returns {string} - HTML string for expense row
     */
    function renderExpenseRow(expense, categoryKey) {
      const monthly = calculateDeductible(expense);
      const annual = Math.round(monthly * 12 * 100) / 100;

      return `
        <div class="expense-row" data-id="${expense.id}" data-category="${categoryKey}">
          <span class="expense-name">${expense.name}</span>
          <span class="expense-formula">${formatFormula(expense, categoryKey)}</span>
          <span class="expense-value">${formatEUR(monthly)}/month (${formatEUR(annual)}/year)</span>
          <div class="expense-actions">
            <button class="delete-btn" onclick="deleteExpense('${categoryKey}', '${expense.id}')" title="Delete">x</button>
          </div>
        </div>
      `;
    }

    /**
     * Render a complete expense section with header, rows, and add button
     * @param {string} categoryKey - Category key in expenseData.categories
     * @param {string} sectionClass - CSS class for section styling
     * @param {string} title - Section title
     * @returns {string} - HTML string for section
     */
    function renderExpenseSection(categoryKey, sectionClass, title) {
      const expenses = expenseData.categories[categoryKey] || [];
      const total = calculateCategoryTotal(categoryKey);
      const annual = Math.round(total * 12 * 100) / 100;

      // Render expense rows
      const rowsHtml = expenses.map(exp => renderExpenseRow(exp, categoryKey)).join('');

      return `
        <div class="expense-section ${sectionClass}">
          <div class="section-header">
            <span class="section-title">${title}</span>
            <span class="section-total">Total: ${formatEUR(total)}/month (${formatEUR(annual)}/year)</span>
          </div>
          <div class="expense-rows">
            ${rowsHtml}
          </div>
          <button class="add-expense-btn" onclick="showAddForm('${categoryKey}')">+ Add Expense</button>
        </div>
      `;
    }

    /**
     * Render all expense sections
     * Updates the DOM with current expense data
     */
    function renderAllSections() {
      const spainEl = document.getElementById('spainSection');
      const workTravelEl = document.getElementById('workTravelSection');
      const privateEl = document.getElementById('privateSection');

      if (spainEl) {
        spainEl.innerHTML = renderExpenseSection('spainDeductible', 'spain-deductible', 'Spain Deductible Expenses');
      }
      if (workTravelEl) {
        workTravelEl.innerHTML = renderExpenseSection('workTravel', 'work-travel', 'Work Travel Expenses');
      }
      if (privateEl) {
        privateEl.innerHTML = renderExpenseSection('private', 'private', 'Private Expenses (Not Deductible)');
      }
    }

    // ============================================================
    // ADD/DELETE EXPENSE FUNCTIONALITY
    // ============================================================
    // User can add new expenses and delete existing ones
    // Changes trigger IRPF recalculation
    // ============================================================

    /**
     * Add a new expense to a category
     * @param {string} categoryKey - Category key in expenseData.categories
     * @param {object} expense - Expense object to add
     */
    function addExpense(categoryKey, expense) {
      expense.id = expense.id || crypto.randomUUID();
      expense.deletable = true;
      expenseData.categories[categoryKey].push(expense);
      saveExpenses();
      renderAllSections();
      recalculateTotals();
    }

    /**
     * Delete an expense from a category
     * @param {string} categoryKey - Category key in expenseData.categories
     * @param {string} expenseId - ID of expense to delete
     */
    function deleteExpense(categoryKey, expenseId) {
      const category = expenseData.categories[categoryKey];
      const index = category.findIndex(e => e.id === expenseId);
      if (index !== -1) {
        category.splice(index, 1);
        saveExpenses();
        renderAllSections();
        recalculateTotals();
      }
    }

    /**
     * Show the add expense form
     * @param {string} categoryKey - Category to pre-select
     */
    function showAddForm(categoryKey) {
      const form = document.getElementById('addExpenseForm');
      if (form) {
        form.classList.remove('hidden');
        const categorySelect = document.getElementById('newExpCategory');
        if (categorySelect) {
          categorySelect.value = categoryKey;
          toggleDeductionField();
        }
      }
    }

    /**
     * Hide the add expense form and clear values
     */
    function hideAddForm() {
      const form = document.getElementById('addExpenseForm');
      if (form) {
        form.classList.add('hidden');
        document.getElementById('newExpName').value = '';
        document.getElementById('newExpAmount').value = '';
        document.getElementById('newExpDeduction').value = '100';
      }
    }

    /**
     * Toggle visibility of deduction percentage field
     * Only shown for Spain Deductible expenses
     */
    function toggleDeductionField() {
      const category = document.getElementById('newExpCategory').value;
      const deductionRow = document.getElementById('deductionRow');
      if (deductionRow) {
        deductionRow.style.display = category === 'spainDeductible' ? 'block' : 'none';
      }
    }

    /**
     * Submit new expense from form
     * Validates input and adds to appropriate category
     */
    function submitNewExpense() {
      const name = document.getElementById('newExpName').value.trim();
      const amount = parseFloat(document.getElementById('newExpAmount').value) || 0;
      const category = document.getElementById('newExpCategory').value;
      const deduction = parseFloat(document.getElementById('newExpDeduction').value) || 100;

      // Validate
      if (!name) {
        alert('Please enter a name for the expense.');
        return;
      }
      if (amount < 0) {
        alert('Amount cannot be negative.');
        return;
      }

      let expense;
      if (category === 'spainDeductible') {
        expense = {
          name,
          baseAmount: amount,
          deductionPct: Math.min(100, Math.max(0, deduction))
        };
      } else {
        expense = { name, amount };
      }

      addExpense(category, expense);
      hideAddForm();
    }

    /**
     * Recalculate totals and update IRPF results
     * KEY INTEGRATION: Expense changes trigger full IRPF recalculation
     */
    function recalculateTotals() {
      const totals = getExpenseTotals();
      const monthlyRevenue = parseFloat(document.getElementById('monthlyRevenue').value) || 0;
      const hasDescendant = document.getElementById('hasDescendant').checked;

      // totalDeductible = Spain + Belgium (private is not deductible)
      const totalDeductible = totals.totalDeductible.monthly;

      // Calculate IRPF with expense totals
      const r = calculateFullIRPF(monthlyRevenue, totalDeductible, hasDescendant);

      // Get private costs from expense data (dynamic, not fixed)
      const privateCostsMonthly = totals.private.monthly;
      const leefgeld = r.netMonthly - privateCostsMonthly;

      const html = `
        <h2>Results</h2>

        <h3>Income</h3>
        <div class="breakdown">
          Monthly Revenue: ${formatEUR(r.monthlyRevenue)}<br>
          Annual Revenue: ${formatEUR(r.annualRevenue)}
        </div>

        <h3>Deductions</h3>
        <div class="breakdown">
          RETA (Seguridad Social): ${formatEUR(r.retaAnnual)} (${formatEUR(r.retaMonthly)}/month) ${sourceHint('RETA')}<br>
          Spain Deductible: ${formatEUR(totals.spainDeductible.annual)} (${formatEUR(totals.spainDeductible.monthly)}/month)<br>
          Work Travel Costs: ${formatEUR(totals.workTravel.annual)} (${formatEUR(totals.workTravel.monthly)}/month)<br>
          <strong>Total Deductible: ${formatEUR(r.totalDeductible)}</strong>
        </div>

        <h3>IRPF Calculation ${sourceHint('IRPF_BRACKETS')}</h3>
        <div class="breakdown">
          Rendimiento Neto Previo: ${formatEUR(r.rendimientoNetoPrevio)}<br>
          Gastos Dificil Justificacion (5%, max 2000): ${formatEUR(r.gastosDificil)} ${sourceHint('GASTOS_DIFICIL')}<br>
          <strong>Rendimiento Neto / Base Liquidable: ${formatEUR(r.baseLiquidable)}</strong>
        </div>

        <h3>Minimos (reduce tax, not base) ${sourceHint('MINIMO_APPLICATION')}</h3>
        <div class="breakdown">
          Minimo Personal: ${formatEUR(r.minimoPersonal)} ${sourceHint('MINIMO_PERSONAL')}<br>
          Minimo por Descendientes: ${formatEUR(r.minimoDescendientes)} ${sourceHint('MINIMO_DESCENDIENTES')}<br>
          <strong>Total Minimos: ${formatEUR(r.minimoTotal)}</strong>
        </div>

        <h3>Tax</h3>
        <div class="breakdown">
          <strong>Cuota Integra (Annual IRPF): ${formatEUR(r.cuotaIntegra)}</strong><br>
          Effective Tax Rate: ${formatPercent(r.effectiveRate)}
        </div>

        <h3>Net Income</h3>
        <div class="breakdown">
          Annual Net: ${formatEUR(r.netAnnual)}<br>
          <strong>Monthly Net: ${formatEUR(r.netMonthly)}</strong><br>
          <hr>
          Private Costs: ${formatEUR(privateCostsMonthly)}/month (${formatEUR(privateCostsMonthly * 12)}/year)<br>
          <strong style="color: var(--accent);">Disposable Income (after all costs): ${formatEUR(leefgeld)}/month</strong>
        </div>

        ${createFootnotes()}
      `;

      document.getElementById('results').innerHTML = html;
    }

    // ============================================================
    // CALCULATION FUNCTIONS
    // ============================================================
    // Implements official AEAT IRPF calculation methodology
    // CRITICAL: Uses 4-phase method where minimos reduce TAX, not BASE
    // ============================================================

    /**
     * Apply progressive IRPF brackets to any amount
     * Uses cumulative baseTax approach for accuracy at bracket boundaries
     * @param {number} amount - Taxable amount in EUR
     * @returns {number} - Tax amount in EUR (rounded to 2 decimals)
     */
    function applyBrackets(amount) {
      if (amount <= 0) return 0;

      for (const bracket of FISCAL_2025.IRPF_BRACKETS) {
        if (amount <= bracket.upTo) {
          return Math.round((bracket.baseTax + (amount - bracket.prevLimit) * bracket.rate) * 100) / 100;
        }
      }
      // Fallback (should never reach with Infinity bound)
      const last = FISCAL_2025.IRPF_BRACKETS[FISCAL_2025.IRPF_BRACKETS.length - 1];
      return Math.round((last.baseTax + (amount - last.prevLimit) * last.rate) * 100) / 100;
    }

    /**
     * Calculate Cuota Integra using 4-phase AEAT method
     * CRITICAL: Minimos reduce TAX liability, NOT taxable base
     *
     * Method:
     * 1. Calculate tax on full base liquidable
     * 2. Calculate tax on minimo amount (capped at base liquidable)
     * 3. Subtract #2 from #1 to get cuota integra
     *
     * Source: AEAT practical examples
     * https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2022/c15-calculo-impuesto-determinacion-cuotas-integras/ejemplo-practico-calculo-cuotas-integras-autonomica.html
     *
     * @param {number} baseLiquidable - Taxable base after all deductions
     * @param {number} minimoTotal - Sum of minimo personal + descendientes
     * @returns {number} - Cuota integra (tax liability) in EUR
     */
    function calculateCuotaIntegra(baseLiquidable, minimoTotal) {
      const cuota1 = applyBrackets(baseLiquidable);
      const minimoApplicable = Math.min(minimoTotal, baseLiquidable);
      const cuota3 = applyBrackets(minimoApplicable);
      return Math.max(0, Math.round((cuota1 - cuota3) * 100) / 100);
    }

    /**
     * Calculate Gastos de Dificil Justificacion
     * For Estimacion Directa Simplificada: 5% with 2000 EUR annual cap
     *
     * Source: AEAT Estimacion Directa Simplificada
     * Note: Was 7% in 2023, reverted to 5% for 2024 onwards
     *
     * @param {number} rendimientoNetoPrevio - Net income before gastos dificil
     * @returns {number} - Deductible amount in EUR
     */
    function calculateGastosDificil(rendimientoNetoPrevio) {
      if (rendimientoNetoPrevio <= 0) return 0;
      const calculated = rendimientoNetoPrevio * FISCAL_2025.GASTOS_DIFICIL_RATE;
      return Math.round(Math.min(calculated, FISCAL_2025.GASTOS_DIFICIL_MAX) * 100) / 100;
    }

    /**
     * Main IRPF calculation function - returns all intermediate values
     *
     * CALC-05 Clarification:
     * The 7% reduccion rendimientos applies only when calculating the RETA base
     * for Social Security purposes. For IRPF, the actual RETA cuota paid
     * (428.40 EUR/month) is deducted as an expense. Since the user has a fixed
     * RETA cuota from registration, we simply deduct it as a business expense.
     *
     * @param {number} monthlyRevenue - Gross monthly revenue in EUR
     * @param {number} monthlyDeductibleExpenses - Monthly deductible business expenses in EUR
     * @param {boolean} hasDescendant - Whether user has 1 dependent child
     * @returns {object} - Complete calculation breakdown
     */
    function calculateFullIRPF(monthlyRevenue, monthlyDeductibleExpenses = 0, hasDescendant = true) {
      // Step 1: Annualize inputs
      const annualRevenue = monthlyRevenue * 12;
      const annualExpenses = monthlyDeductibleExpenses * 12;

      // Step 2: Total deductible = expenses + RETA (fixed cuota, not calculated)
      // CALC-05: RETA cuota is deducted as expense. The 7% reduccion is for SS, not IRPF.
      const totalDeductible = annualExpenses + FISCAL_2025.RETA_ANNUAL;

      // Step 3: Rendimiento Neto Previo (before gastos dificil)
      const rendimientoNetoPrevio = annualRevenue - totalDeductible;

      // Step 4: Gastos dificil justificacion
      const gastosDificil = calculateGastosDificil(rendimientoNetoPrevio);

      // Step 5: Rendimiento Neto = Base Liquidable (for autonomo)
      const rendimientoNeto = rendimientoNetoPrevio - gastosDificil;
      const baseLiquidable = Math.max(0, rendimientoNeto);

      // Step 6: Calculate minimos
      const minimoPersonal = FISCAL_2025.MINIMO_PERSONAL;
      const minimoDescendientes = hasDescendant ? FISCAL_2025.MINIMO_DESCENDIENTES_PRIMERO : 0;
      const minimoTotal = minimoPersonal + minimoDescendientes;

      // Step 7: Cuota Integra using 4-phase method
      const cuotaIntegra = calculateCuotaIntegra(baseLiquidable, minimoTotal);

      // Step 8: Effective tax rate
      const effectiveRate = rendimientoNeto > 0 ? (cuotaIntegra / rendimientoNeto) : 0;

      // Step 9: Net income calculations
      const netAnnual = annualRevenue - totalDeductible - gastosDificil - cuotaIntegra;
      const netMonthly = netAnnual / 12;

      // Step 10: Leefgeld (after private costs)
      const leefgeld = netMonthly - FISCAL_2025.PRIVATE_COSTS_MONTHLY;

      return {
        // Inputs
        monthlyRevenue,
        annualRevenue,
        monthlyExpenses: monthlyDeductibleExpenses,
        annualExpenses,

        // Deductions
        retaMonthly: FISCAL_2025.RETA_MONTHLY,
        retaAnnual: FISCAL_2025.RETA_ANNUAL,
        totalDeductible,

        // Calculation chain
        rendimientoNetoPrevio,
        gastosDificil,
        rendimientoNeto,
        baseLiquidable,

        // Minimos (for display)
        minimoPersonal,
        minimoDescendientes,
        minimoTotal,

        // Tax
        cuotaIntegra,
        effectiveRate,

        // Net income
        netAnnual,
        netMonthly,
        leefgeld,

        // Private costs (for reference)
        privateCostsMonthly: FISCAL_2025.PRIVATE_COSTS_MONTHLY
      };
    }

    // ============================================================
    // FORMATTING UTILITIES
    // ============================================================

    /**
     * Format amount as EUR currency (Spanish locale)
     * @param {number} amount - Amount in EUR
     * @returns {string} - Formatted string like "5.550,00 EUR"
     */
    function formatEUR(amount) {
      return new Intl.NumberFormat('es-ES', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(amount);
    }

    /**
     * Format decimal as percentage
     * @param {number} decimal - Decimal value (0.25 = 25%)
     * @returns {string} - Formatted percentage like "25,00 %"
     */
    function formatPercent(decimal) {
      return new Intl.NumberFormat('es-ES', {
        style: 'percent',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(decimal);
    }

    // ============================================================
    // SOURCE CITATION UTILITIES
    // ============================================================

    /**
     * Create source hint HTML for inline citations
     * @param {string} sourceKey - Key from SOURCES constant
     * @returns {string} - HTML string with tooltip
     */
    function sourceHint(sourceKey) {
      const s = SOURCES[sourceKey];
      if (!s) return '';
      const tooltip = `${s.source}: ${s.note}`;
      return `<span class="source-hint" data-tooltip="${tooltip.replace(/"/g, '&quot;')}" data-source="${sourceKey}">i</span>`;
    }

    /**
     * Create footnotes section HTML listing all sources
     * @returns {string} - HTML string with sources list
     */
    function createFootnotes() {
      let html = '<div class="footnotes"><h4>Sources</h4><ul>';
      for (const [key, s] of Object.entries(SOURCES)) {
        html += `<li>
          <strong>${s.name}</strong> -
          <a href="${s.url}" target="_blank" rel="noopener">${s.source}</a>
          <span class="confidence-${s.confidence.toLowerCase()}">[${s.confidence}]</span>
        </li>`;
      }
      html += '</ul></div>';
      return html;
    }

    // ============================================================
    // UI FUNCTIONS
    // ============================================================

    /**
     * Legacy calculate function - kept for compatibility
     * Now redirects to recalculateTotals()
     */
    function calculate() {
      recalculateTotals();
    }

    // ============================================================
    // SCENARIO CARD RENDERING
    // ============================================================
    // Renders scenario cards sorted by leefgeld (highest first)
    // ============================================================

    /**
     * Render all scenario cards sorted by leefgeld (highest first)
     * First card (optimal) shows "Highest Disposable" badge
     * Includes "+ New Scenario" button at the end
     */
    function renderScenarioCards() {
      const container = document.getElementById('scenarioCards');
      if (!container) return;

      const sorted = getSortedScenarios();

      const cardsHtml = sorted.map((scenario, index) => {
        const isOptimal = index === 0;
        const isSelected = scenarioState.selected.includes(scenario.id);
        const isCustom = !scenario.isPreset;
        const workTravelCost = getWorkTravelCost(scenario);
        const totalExpenses = (scenario.monthlyExpenses + workTravelCost) * 12;
        const annualRevenue = scenario.monthlyRevenue * 12;
        const effectiveRate = scenario.results.effectiveRate || 0;

        const classes = [
          'scenario-card',
          isOptimal ? 'optimal' : '',
          isSelected ? 'selected' : '',
          isCustom ? 'custom' : ''
        ].filter(Boolean).join(' ');

        // Full breakdown card with onclick for detail modal (UI-02, UI-04)
        return `
          <div class="${classes}" data-id="${scenario.id}" onclick="if(!event.target.closest('.edit-btn') && !event.target.closest('input')) openDetailModal('${scenario.id}')">
            <div class="card-header">
              <input type="checkbox"
                     ${isSelected ? 'checked' : ''}
                     onchange="toggleScenarioSelection('${scenario.id}')"
                     aria-label="Select ${scenario.name} for comparison">
              <h3>${scenario.name}</h3>
              ${isOptimal ? '<span class="optimal-badge">Highest Disposable</span>' : ''}
            </div>

            <div class="card-metrics">
              <div class="metric">
                <span class="label">Revenue</span>
                <span class="value value-positive">${formatEUR(annualRevenue)}/yr</span>
              </div>
              <div class="metric">
                <span class="label">Expenses</span>
                <span class="value value-negative">${formatEUR(totalExpenses)}/yr</span>
              </div>
              <div class="metric divider"></div>
              <div class="metric">
                <span class="label">${createTooltip('irpf', 'IRPF')}</span>
                <span class="value value-negative">${formatEUR(scenario.results.cuotaIntegra)}</span>
              </div>
              <div class="metric">
                <span class="label">${createTooltip('reta', 'RETA')}</span>
                <span class="value value-negative">${formatEUR(scenario.results.retaAnnual)}</span>
              </div>
              <div class="metric">
                <span class="label">Tax Rate</span>
                <span class="value">${(effectiveRate * 100).toFixed(1)}%</span>
              </div>
              <div class="metric divider"></div>
              <div class="metric">
                <span class="label">Net Income</span>
                <span class="value value-positive">${formatEUR(scenario.results.netAnnual)}/yr</span>
              </div>
              <div class="metric">
                <span class="label">Monthly Net</span>
                <span class="value">${formatEUR(scenario.results.netMonthly)}</span>
              </div>
              <div class="metric highlight">
                <span class="label">${createTooltip('leefgeld', 'Disposable Income')}</span>
                <span class="value">${formatEUR(scenario.results.leefgeld)}/mo</span>
              </div>
            </div>

            <button class="edit-btn" onclick="openEditModal('${scenario.id}')">
              Edit
            </button>
          </div>
        `;
      }).join('');

      // Add "+ New" button at end
      const newButtonHtml = `
        <button class="new-scenario-btn" onclick="showTemplateDialog()">+ New Scenario</button>
      `;

      container.innerHTML = cardsHtml + newButtonHtml;
    }

    /**
     * Toggle scenario selection for comparison
     * Updates state, saves to localStorage, and re-renders
     *
     * @param {string} scenarioId - ID of scenario to toggle
     */
    function toggleScenarioSelection(scenarioId) {
      const idx = scenarioState.selected.indexOf(scenarioId);
      if (idx === -1) {
        scenarioState.selected.push(scenarioId);
      } else {
        scenarioState.selected.splice(idx, 1);
      }
      saveScenarioState();
      renderScenarioCards();
      renderComparisonTable();
    }

    // ============================================================
    // COMPARISON TABLE RENDERING
    // ============================================================
    // Renders side-by-side comparison table for selected scenarios
    // ============================================================

    /**
     * Render comparison table for selected scenarios
     * Shows full calculation breakdown with sticky header and optimal highlighting
     */
    function renderComparisonTable() {
      const container = document.getElementById('comparisonTable');
      if (!container) return;

      const selectedIds = scenarioState.selected;

      // Empty state
      if (selectedIds.length === 0) {
        container.innerHTML = `
          <div class="comparison-empty">
            <p>Select scenarios using checkboxes to compare them side-by-side</p>
          </div>
        `;
        return;
      }

      // Get selected scenarios with results
      const scenarios = selectedIds
        .map(id => scenarioState.scenarios[id])
        .filter(Boolean)
        .map(s => ({
          ...s,
          results: calculateScenarioResults(s)
        }));

      // Verify all required properties exist on first results object (defensive check)
      if (scenarios.length > 0) {
        const requiredProps = [
          'annualRevenue', 'annualExpenses', 'retaAnnual', 'totalDeductible',
          'rendimientoNetoPrevio', 'gastosDificil', 'baseLiquidable',
          'minimoPersonal', 'minimoDescendientes', 'minimoTotal',
          'cuotaIntegra', 'effectiveRate', 'netAnnual', 'netMonthly',
          'leefgeld', 'privateCostsMonthly'
        ];
        const firstResults = scenarios[0].results;
        for (const prop of requiredProps) {
          if (firstResults[prop] === undefined) {
            console.error(`renderComparisonTable: missing property '${prop}' in results object. Check calculateFullIRPFWithFiscal return value in Plan 03-01.`);
          }
        }
      }

      // Find optimal values for highlighting
      const optimalLeefgeld = Math.max(...scenarios.map(s => s.results.leefgeld));
      const optimalEffRate = Math.min(...scenarios.map(s => s.results.effectiveRate));
      const optimalNetMonthly = Math.max(...scenarios.map(s => s.results.netMonthly));

      // Define metric rows (full breakdown per CONTEXT.md) with valueClass for color-coding (UI-07)
      // Tooltips added for key terms (UI-09)
      const metrics = [
        { label: 'Monthly Revenue', getValue: (s) => s.monthlyRevenue, format: formatEUR, valueClass: 'value-positive' },
        { label: 'Monthly Expenses', getValue: (s) => s.monthlyExpenses, format: formatEUR, valueClass: '' },
        { label: 'Work Travel Costs', getValue: (s) => getWorkTravelCost(s), format: formatEUR, valueClass: '' },
        { label: 'Total Monthly Expenses', getValue: (s) => s.monthlyExpenses + getWorkTravelCost(s), format: formatEUR, valueClass: 'value-negative' },
        { divider: true },
        { label: 'Annual Revenue', getValue: (s) => s.results.annualRevenue, format: formatEUR, valueClass: 'value-positive' },
        { label: createTooltip('reta', 'RETA (Annual)'), getValue: (s) => s.results.retaAnnual, format: formatEUR, valueClass: 'value-negative' },
        { label: 'Annual Expenses', getValue: (s) => s.results.annualExpenses, format: formatEUR, valueClass: '' },
        { label: 'Total Deductible', getValue: (s) => s.results.totalDeductible, format: formatEUR, valueClass: 'value-negative' },
        { divider: true },
        { label: 'Rendimiento Neto Previo', getValue: (s) => s.results.rendimientoNetoPrevio, format: formatEUR, valueClass: '' },
        { label: createTooltip('gastos', 'Gastos Dificil (5%)'), getValue: (s) => s.results.gastosDificil, format: formatEUR, valueClass: '' },
        { label: 'Base Liquidable', getValue: (s) => s.results.baseLiquidable, format: formatEUR, valueClass: '' },
        { divider: true },
        { label: createTooltip('minimo', 'Minimo Personal'), getValue: (s) => s.results.minimoPersonal, format: formatEUR, valueClass: '' },
        { label: createTooltip('descendientes', 'Minimo Descendientes'), getValue: (s) => s.results.minimoDescendientes, format: formatEUR, valueClass: '' },
        { label: 'Total Minimos', getValue: (s) => s.results.minimoTotal, format: formatEUR, valueClass: '' },
        { divider: true },
        { label: createTooltip('irpf', 'Cuota Integra (Annual IRPF)'), getValue: (s) => s.results.cuotaIntegra, format: formatEUR, valueClass: 'value-negative', optimalMin: true },
        { label: 'Effective Tax Rate', getValue: (s) => s.results.effectiveRate, format: formatPercent, valueClass: '', optimalMin: true },
        { divider: true },
        { label: 'Net Annual', getValue: (s) => s.results.netAnnual, format: formatEUR, valueClass: 'value-positive' },
        { label: 'Net Monthly', getValue: (s) => s.results.netMonthly, format: formatEUR, valueClass: 'value-positive', optimalMax: optimalNetMonthly },
        { label: 'Private Costs', getValue: (s) => s.results.privateCostsMonthly, format: formatEUR, valueClass: 'value-negative' },
        { label: createTooltip('leefgeld', 'Disposable Income'), getValue: (s) => s.results.leefgeld, format: formatEUR, valueClass: '', optimalMax: optimalLeefgeld, highlight: true }
      ];

      // Build table HTML
      let tableHtml = `
        <div class="comparison-container">
          <table class="comparison-table">
            <thead>
              <tr>
                <th>Metric</th>
                ${scenarios.map(s => `<th>${s.name}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
      `;

      metrics.forEach(metric => {
        if (metric.divider) {
          tableHtml += `<tr class="divider"><td colspan="${scenarios.length + 1}"></td></tr>`;
        } else {
          const rowClass = metric.highlight ? 'highlight-row' : '';
          tableHtml += `<tr class="${rowClass}">`;
          tableHtml += `<td>${metric.label}</td>`;

          scenarios.forEach(s => {
            const value = metric.getValue(s);
            const cellClasses = [];

            // Determine if this value is optimal
            if (metric.optimalMax !== undefined && value === metric.optimalMax) {
              cellClasses.push('optimal');
            }
            if (metric.optimalMin && value === optimalEffRate) {
              cellClasses.push('optimal');
            }
            // Add color class (UI-07) unless optimal takes precedence
            if (metric.valueClass && !cellClasses.includes('optimal')) {
              cellClasses.push(metric.valueClass);
            }

            const classAttr = cellClasses.length ? cellClasses.join(' ') : '';
            tableHtml += `<td class="${classAttr}">${metric.format(value)}</td>`;
          });

          tableHtml += '</tr>';
        }
      });

      tableHtml += `
            </tbody>
          </table>
        </div>
      `;

      container.innerHTML = tableHtml;

      // Also render mobile comparison view (UI-08)
      const mobileContainer = document.querySelector('.comparison-mobile');
      if (mobileContainer) {
        mobileContainer.innerHTML = renderMobileComparison(scenarios);
      }
    }

    /**
     * Render mobile comparison blocks (vertical layout)
     * @param {array} scenarios - Array of scenario objects with results
     * @returns {string} - HTML string of comparison blocks
     */
    function renderMobileComparison(scenarios) {
      if (!scenarios || scenarios.length === 0) {
        return '<p class="comparison-empty">Select scenarios to compare</p>';
      }

      const optimalLeefgeld = Math.max(...scenarios.map(s => s.results.leefgeld));

      return scenarios.map(s => {
        const isOptimal = s.results.leefgeld === optimalLeefgeld;

        return `
          <div class="comparison-block${isOptimal ? ' optimal' : ''}">
            <h4 class="block-title">${s.name}${isOptimal ? ' <span class="optimal-badge">Optimal</span>' : ''}</h4>
            <div class="block-metrics">
              <div class="block-row">
                <span class="label">Revenue</span>
                <span class="value value-positive">${formatEUR(s.results.annualRevenue)}/yr</span>
              </div>
              <div class="block-row">
                <span class="label">Expenses</span>
                <span class="value value-negative">${formatEUR(s.results.totalDeductible)}</span>
              </div>
              <div class="block-row">
                <span class="label">IRPF</span>
                <span class="value value-negative">${formatEUR(s.results.cuotaIntegra)}</span>
              </div>
              <div class="block-row">
                <span class="label">RETA</span>
                <span class="value value-negative">${formatEUR(s.results.retaAnnual)}</span>
              </div>
              <div class="block-row">
                <span class="label">Tax Rate</span>
                <span class="value">${(s.results.effectiveRate * 100).toFixed(1)}%</span>
              </div>
              <div class="block-row">
                <span class="label">Net Income</span>
                <span class="value value-positive">${formatEUR(s.results.netAnnual)}</span>
              </div>
              <div class="block-row highlight">
                <span class="label">Disposable Income</span>
                <span class="value">${formatEUR(s.results.leefgeld)}/mo</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    /**
     * Copy comparison table data to clipboard (UI-10)
     * Strips tooltips from cells before copying
     */
    async function copyTableToClipboard() {
      const table = document.querySelector('.comparison-table');
      if (!table) {
        showNotification('No comparison data to copy', 'error');
        return;
      }

      const rows = Array.from(table.querySelectorAll('tr'));
      const text = rows.map(row => {
        const cells = Array.from(row.querySelectorAll('th, td'));
        return cells.map(cell => {
          // Get text content, stripping tooltips
          const clone = cell.cloneNode(true);
          clone.querySelectorAll('[role="tooltip"]').forEach(t => t.remove());
          return clone.textContent.trim();
        }).join('\t');
      }).join('\n');

      try {
        await navigator.clipboard.writeText(text);
        showNotification('Copied to clipboard!');
      } catch (err) {
        console.error('Clipboard write failed:', err);
        showNotification('Copy failed - try again', 'error');
      }
    }

    // ============================================================
    // DETAIL MODAL FUNCTIONALITY (UI-04)
    // ============================================================
    // Read-only modal for viewing full scenario breakdown
    // ============================================================

    let currentDetailScenarioId = null;

    /**
     * Open detail modal showing full scenario breakdown
     * @param {string} scenarioId - ID of scenario to display
     */
    function openDetailModal(scenarioId) {
      const scenario = scenarioState.scenarios[scenarioId];
      if (!scenario) return;

      currentDetailScenarioId = scenarioId;
      const results = calculateScenarioResults(scenario);
      const body = document.getElementById('detail-body');
      const dialog = document.getElementById('detail-modal');
      const title = dialog.querySelector('.detail-title');
      const isOptimal = getSortedScenarios()[0]?.id === scenarioId;

      title.textContent = scenario.name + (isOptimal ? ' (Optimal)' : '');

      const workTravelCost = getWorkTravelCost(scenario);

      body.innerHTML = `
        <div class="detail-section">
          <h4>Income</h4>
          <div class="detail-row">
            <span class="label">Monthly Revenue</span>
            <span class="value">${formatEUR(scenario.monthlyRevenue)}</span>
          </div>
          <div class="detail-row">
            <span class="label">Annual Revenue</span>
            <span class="value">${formatEUR(results.annualRevenue)}</span>
          </div>
        </div>

        <div class="detail-section">
          <h4>Expenses</h4>
          <div class="detail-row">
            <span class="label">Spain Deductible</span>
            <span class="value value-negative">${formatEUR(scenario.monthlyExpenses * 12)}</span>
          </div>
          <div class="detail-row">
            <span class="label">Work Travel Costs</span>
            <span class="value value-negative">${formatEUR(workTravelCost * 12)}</span>
          </div>
          <div class="detail-row">
            <span class="label">Private Costs</span>
            <span class="value value-negative">${formatEUR(results.privateCostsMonthly * 12)}</span>
          </div>
          <div class="detail-row total">
            <span class="label">Total Expenses</span>
            <span class="value">${formatEUR(results.annualExpenses + (workTravelCost * 12))}</span>
          </div>
        </div>

        <div class="detail-section">
          <h4>Taxes</h4>
          <div class="detail-row">
            <span class="label">IRPF (Income Tax)</span>
            <span class="value value-negative">${formatEUR(results.cuotaIntegra)}</span>
          </div>
          <div class="detail-row">
            <span class="label">RETA (Social Security)</span>
            <span class="value value-negative">${formatEUR(results.retaAnnual)}</span>
          </div>
          <div class="detail-row">
            <span class="label">Effective Tax Rate</span>
            <span class="value">${(results.effectiveRate * 100).toFixed(1)}%</span>
          </div>
        </div>

        <div class="detail-section">
          <h4>Net Result</h4>
          <div class="detail-row">
            <span class="label">Net Income (Annual)</span>
            <span class="value value-positive">${formatEUR(results.netAnnual)}</span>
          </div>
          <div class="detail-row">
            <span class="label">Monthly Net</span>
            <span class="value value-positive">${formatEUR(results.netMonthly)}</span>
          </div>
          <div class="detail-row total">
            <span class="label">Disposable Income</span>
            <span class="value">${formatEUR(results.leefgeld)}/mo</span>
          </div>
        </div>
      `;

      dialog.showModal();
    }

    /**
     * Close detail modal
     */
    function closeDetailModal() {
      document.getElementById('detail-modal').close();
      currentDetailScenarioId = null;
    }

    /**
     * Transition from detail modal to edit modal
     */
    function editFromDetail() {
      const scenarioId = currentDetailScenarioId;
      closeDetailModal();
      if (scenarioId && typeof openEditModal === 'function') {
        openEditModal(scenarioId);
      }
    }

    // ============================================================
    // EDIT MODAL FUNCTIONALITY
    // ============================================================
    // Modal for editing scenario values with live results preview
    // ============================================================

    let currentEditScenarioId = null;

    /**
     * Open edit modal for a scenario
     * Populates form with scenario values and shows modal
     *
     * @param {string} scenarioId - ID of scenario to edit
     */
    function openEditModal(scenarioId) {
      const scenario = scenarioState.scenarios[scenarioId];
      if (!scenario) return;

      currentEditScenarioId = scenarioId;
      const dialog = document.getElementById('editScenarioDialog');

      // Populate form fields
      document.getElementById('editScenarioName').value = scenario.name;
      document.getElementById('editMonthlyRevenue').value = scenario.monthlyRevenue;
      document.getElementById('editMonthlyExpenses').value = scenario.monthlyExpenses;
      document.getElementById('editWorkTravelCost').value = getWorkTravelCost(scenario);
      document.getElementById('editHasDescendant').checked = scenario.hasDescendant;

      // Populate fiscal overrides (empty means use default)
      const overrides = scenario.fiscalOverrides || {};
      document.getElementById('editRetaOverride').value = overrides.RETA_MONTHLY || '';
      document.getElementById('editMinimoPersonalOverride').value = overrides.MINIMO_PERSONAL || '';
      document.getElementById('editMinimoDescOverride').value = overrides.MINIMO_DESCENDIENTES_PRIMERO || '';

      // Show/hide delete button based on preset status
      const deleteBtn = document.getElementById('deleteScenarioBtn');
      deleteBtn.style.display = scenario.isPreset ? 'none' : 'block';

      // Update dialog title
      document.getElementById('dialogTitle').textContent = `Edit ${scenario.name}`;

      // Calculate and show initial results
      updateLiveResults();

      // Open modal
      dialog.showModal();
    }

    /**
     * Close edit modal without saving
     */
    function closeEditModal() {
      const dialog = document.getElementById('editScenarioDialog');
      dialog.close();
      currentEditScenarioId = null;
    }

    // ============================================================
    // LIVE RECALCULATION
    // ============================================================
    // requestAnimationFrame-debounced live recalculation on input
    // ============================================================

    let liveCalcRafId = null;

    /**
     * Handle input change in edit modal
     * Uses requestAnimationFrame for debouncing
     */
    function onScenarioInputChange() {
      // Cancel any pending recalculation
      if (liveCalcRafId) {
        cancelAnimationFrame(liveCalcRafId);
      }

      // Schedule recalculation for next frame
      liveCalcRafId = requestAnimationFrame(() => {
        updateLiveResults();
        liveCalcRafId = null;
      });
    }

    /**
     * Get current values from edit form
     * @returns {object} - Form values with fiscalOverrides if any
     */
    function getEditFormValues() {
      const monthlyRevenue = parseFloat(document.getElementById('editMonthlyRevenue').value) || 0;
      const monthlyExpenses = parseFloat(document.getElementById('editMonthlyExpenses').value) || 0;
      const workTravelCost = parseFloat(document.getElementById('editWorkTravelCost').value) || 0;
      const hasDescendant = document.getElementById('editHasDescendant').checked;

      // Fiscal overrides (empty string = use default)
      const retaOverride = document.getElementById('editRetaOverride').value;
      const minimoPersonalOverride = document.getElementById('editMinimoPersonalOverride').value;
      const minimoDescOverride = document.getElementById('editMinimoDescOverride').value;

      let fiscalOverrides = null;
      if (retaOverride || minimoPersonalOverride || minimoDescOverride) {
        fiscalOverrides = {};
        if (retaOverride) {
          fiscalOverrides.RETA_MONTHLY = parseFloat(retaOverride);
          fiscalOverrides.RETA_ANNUAL = parseFloat(retaOverride) * 12;
        }
        if (minimoPersonalOverride) {
          fiscalOverrides.MINIMO_PERSONAL = parseFloat(minimoPersonalOverride);
        }
        if (minimoDescOverride) {
          fiscalOverrides.MINIMO_DESCENDIENTES_PRIMERO = parseFloat(minimoDescOverride);
        }
      }

      return {
        name: document.getElementById('editScenarioName').value.trim(),
        monthlyRevenue,
        monthlyExpenses,
        workTravelCost,
        hasDescendant,
        fiscalOverrides
      };
    }

    /**
     * Update live results pane with calculated values
     * Called on every input change (debounced)
     */
    function updateLiveResults() {
      const values = getEditFormValues();
      const results = calculateScenarioResults(values);

      // Verify results object has all expected properties (defensive programming)
      // These properties are guaranteed by calculateFullIRPFWithFiscal in Plan 03-01
      const requiredProps = [
        'annualRevenue', 'totalDeductible', 'rendimientoNeto', 'gastosDificil',
        'baseLiquidable', 'minimoTotal', 'cuotaIntegra', 'effectiveRate',
        'retaAnnual', 'netMonthly', 'leefgeld'
      ];
      for (const prop of requiredProps) {
        if (results[prop] === undefined) {
          console.error(`updateLiveResults: missing property '${prop}' in results object`);
        }
      }

      const container = document.getElementById('liveEditResults');
      container.innerHTML = `
        <div class="live-result-row">
          <span class="label">Annual Revenue</span>
          <span class="value">${formatEUR(results.annualRevenue)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Total Deductible</span>
          <span class="value">${formatEUR(results.totalDeductible)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Rendimiento Neto</span>
          <span class="value">${formatEUR(results.rendimientoNeto)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Gastos Dificil (5%)</span>
          <span class="value">${formatEUR(results.gastosDificil)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Base Liquidable</span>
          <span class="value">${formatEUR(results.baseLiquidable)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Total Minimos</span>
          <span class="value">${formatEUR(results.minimoTotal)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Cuota Integra (IRPF)</span>
          <span class="value">${formatEUR(results.cuotaIntegra)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Effective Tax Rate</span>
          <span class="value">${formatPercent(results.effectiveRate)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">RETA Annual</span>
          <span class="value">${formatEUR(results.retaAnnual)}</span>
        </div>
        <div class="live-result-row">
          <span class="label">Net Monthly</span>
          <span class="value">${formatEUR(results.netMonthly)}</span>
        </div>
        <div class="live-result-row highlight">
          <span class="label">Disposable Income</span>
          <span class="value">${formatEUR(results.leefgeld)}/mo</span>
        </div>
      `;
    }

    // ============================================================
    // SAVE AND DELETE FUNCTIONALITY
    // ============================================================

    /**
     * Save changes from edit form to scenario state
     * Called when dialog closes with 'save' return value
     */
    function saveScenarioChanges() {
      if (!currentEditScenarioId) return;

      const values = getEditFormValues();

      // Validate name
      if (!values.name) {
        alert('Please enter a scenario name');
        return;
      }

      const scenario = scenarioState.scenarios[currentEditScenarioId];
      if (!scenario) return;

      // Update scenario (keep id and isPreset)
      Object.assign(scenario, {
        name: values.name,
        monthlyRevenue: values.monthlyRevenue,
        monthlyExpenses: values.monthlyExpenses,
        workTravelCost: values.workTravelCost,
        hasDescendant: values.hasDescendant,
        fiscalOverrides: values.fiscalOverrides
      });
      // Remove legacy property if present
      delete scenario.belgiumPattern;

      saveScenarioState();
      renderScenarioCards();
      renderComparisonTable();
    }

    /**
     * Confirm and delete current scenario
     * Only works for custom scenarios (not presets A-E)
     */
    function confirmDeleteScenario() {
      if (!currentEditScenarioId) return;

      const scenario = scenarioState.scenarios[currentEditScenarioId];
      if (!scenario) return;

      if (scenario.isPreset) {
        alert('Cannot delete preset scenarios (A-E). You can only delete custom scenarios.');
        return;
      }

      if (confirm(`Delete "${scenario.name}"? This cannot be undone.`)) {
        delete scenarioState.scenarios[currentEditScenarioId];
        scenarioState.customOrder = scenarioState.customOrder.filter(id => id !== currentEditScenarioId);
        scenarioState.selected = scenarioState.selected.filter(id => id !== currentEditScenarioId);
        saveScenarioState();
        closeEditModal();
        renderScenarioCards();
        renderComparisonTable();
      }
    }

    /**
     * Initialize edit dialog event handlers
     * Called on DOMContentLoaded
     */
    function initEditDialog() {
      const dialog = document.getElementById('editScenarioDialog');
      if (!dialog) return;

      // Handle form submit (Save button)
      dialog.addEventListener('close', () => {
        if (dialog.returnValue === 'save') {
          saveScenarioChanges();
        }
      });

      // Prevent Esc from saving (cancel event)
      dialog.addEventListener('cancel', (e) => {
        // Default behavior is fine - just closes without saving
      });

      // Attach input change handlers for live recalculation
      const inputs = dialog.querySelectorAll('input, select');
      inputs.forEach(input => {
        input.addEventListener('input', onScenarioInputChange);
        input.addEventListener('change', onScenarioInputChange); // For checkboxes and selects
      });
    }

    // ============================================================
    // TEMPLATE DIALOG / CUSTOM SCENARIO CREATION
    // ============================================================
    // Create new scenarios from existing scenario templates
    // ============================================================

    let selectedTemplateId = null;

    /**
     * Show template selection dialog for creating new scenario
     */
    function showTemplateDialog() {
      const dialog = document.getElementById('templateSelectDialog');
      const optionsContainer = document.getElementById('templateOptions');

      // Build template options from all scenarios
      const allScenarios = Object.values(scenarioState.scenarios);

      optionsContainer.innerHTML = allScenarios.map((s, index) => {
        const workTravelCost = getWorkTravelCost(s);
        const checked = index === 0 ? 'checked' : '';

        return `
          <label class="template-option">
            <input type="radio" name="template" value="${s.id}" ${checked}>
            <div class="template-info">
              <div class="template-name">${s.name}</div>
              <div class="template-desc">${formatEUR(s.monthlyRevenue)}/mo revenue, ${formatEUR(s.monthlyExpenses + workTravelCost)}/mo expenses</div>
            </div>
          </label>
        `;
      }).join('');

      // Clear name input
      document.getElementById('newScenarioName').value = '';

      dialog.showModal();
    }

    /**
     * Close template dialog without creating
     */
    function closeTemplateDialog() {
      document.getElementById('templateSelectDialog').close();
    }

    /**
     * Initialize template dialog event handlers
     * Called on DOMContentLoaded
     */
    function initTemplateDialog() {
      const dialog = document.getElementById('templateSelectDialog');
      if (!dialog) return;

      dialog.addEventListener('close', () => {
        if (dialog.returnValue === 'create') {
          createCustomScenario();
        }
      });
    }

    /**
     * Create a new custom scenario from selected template
     * Called when template dialog closes with 'create' return value
     */
    function createCustomScenario() {
      const name = document.getElementById('newScenarioName').value.trim();
      if (!name) {
        alert('Please enter a name for the scenario');
        return;
      }

      // Get selected template
      const selectedRadio = document.querySelector('#templateOptions input[name="template"]:checked');
      if (!selectedRadio) {
        alert('Please select a template');
        return;
      }

      const templateId = selectedRadio.value;
      const template = scenarioState.scenarios[templateId];
      if (!template) return;

      // Create new scenario from template
      const newScenario = {
        ...structuredClone(template),
        id: crypto.randomUUID(),
        name: name,
        isPreset: false,
        fiscalOverrides: null  // Reset any overrides from template
      };

      // Add to state
      scenarioState.scenarios[newScenario.id] = newScenario;
      scenarioState.customOrder.push(newScenario.id);
      saveScenarioState();
      renderScenarioCards();
      renderComparisonTable();

      // Open edit modal for new scenario
      openEditModal(newScenario.id);
    }

    // Tooltip escape key handler (UI-09, BUG-02)
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        // Close tooltip modal if open (handled natively by dialog)
        // Remove focus from any tooltip trigger
        if (document.activeElement.classList.contains('term-tooltip-trigger')) {
          document.activeElement.blur();
        }
      }
    });

    // ============================================================
    // PHASE 7: COMPLIANCE TAB CONTENT
    // ============================================================

    // ===========================================
    // PHASE 7: COMPLIANCE WARNING BANNER
    // ===========================================

    function getComplianceWarningDismissKey() {
      return 'complianceWarningDismissed_session';
    }

    function isComplianceWarningDismissed() {
      return sessionStorage.getItem(getComplianceWarningDismissKey()) === 'true';
    }

    function dismissComplianceWarning() {
      sessionStorage.setItem(getComplianceWarningDismissKey(), 'true');
      const banner = document.getElementById('complianceWarningBanner');
      if (banner) {
        banner.classList.remove('visible');
      }
    }

    function getBelgiumDayCount() {
      // Uses existing calendarState from Phase 4
      if (typeof calendarState === 'undefined' || !calendarState.days) return 0;
      let count = 0;
      for (const dateKey in calendarState.days) {
        const dayData = calendarState.days[dateKey];
        const status = dayData.status;
        // Count Belgium and Travel days toward threshold (conservative approach)
        if (status === 'belgium' || status === 'travel') {
          count++;
        }
      }
      return count;
    }

    function updateComplianceWarning() {
      const banner = document.getElementById('complianceWarningBanner');
      const textEl = document.getElementById('warningText');
      if (!banner || !textEl) return;

      // Don't show if dismissed this session
      if (isComplianceWarningDismissed()) {
        banner.classList.remove('visible');
        return;
      }

      const belgiumDays = getBelgiumDayCount();

      // Remove previous threshold classes
      banner.classList.remove('threshold-170', 'threshold-180', 'threshold-183');

      if (belgiumDays >= 183) {
        banner.classList.add('visible', 'threshold-183');
        textEl.innerHTML = `<strong>${belgiumDays} Belgium/travel days.</strong> You have exceeded the 183-day threshold. Treaty tie-breaker provisions apply to determine tax residence.`;
      } else if (belgiumDays >= 180) {
        banner.classList.add('visible', 'threshold-180');
        textEl.innerHTML = `<strong>${belgiumDays} Belgium/travel days.</strong> You are approaching the 183-day threshold. Review treaty provisions in the Compliance tab.`;
      } else if (belgiumDays >= 170) {
        banner.classList.add('visible', 'threshold-170');
        textEl.innerHTML = `<strong>${belgiumDays} Belgium/travel days.</strong> Approaching 183-day threshold. Consider reviewing treaty provisions.`;
      } else {
        banner.classList.remove('visible');
      }
    }

    /**
     * Render the Compliance tab content with collapsible sections
     * Content organized by action: Before Travel, While Working, When Filing
     */
    function renderComplianceContent() {
      const panel = document.getElementById('compliancePanel');
      if (!panel) return;

      panel.innerHTML = `
        <h2>Compliance Information</h2>

        <!-- SECTION 1: Before You Travel -->
        <div class="action-phase">
          <h3>Before You Travel</h3>

          <div class="compliance-section">
            <button class="section-header" aria-expanded="false" aria-controls="content-treaty-overview">
              <span>Spain-Belgium Tax Treaty Overview</span>
              <span class="section-icon">+</span>
            </button>
            <div class="section-content" id="content-treaty-overview" hidden>
              <p class="plain-summary">
                Spain and Belgium have a tax treaty (BOE-A-2003-13375) to prevent double taxation.
                If both countries claim you as a tax resident, the treaty provides "tie-breaker" rules
                to determine which country has primary taxation rights.
              </p>
              <cite class="source-citation">${TREATY_ARTICLE_4.source}</cite>
            </div>
          </div>
        </div>

        <!-- SECTION 2: While Working in Belgium -->
        <div class="action-phase">
          <h3>While Working in Belgium</h3>

          <div class="compliance-section">
            <button class="section-header" aria-expanded="false" aria-controls="content-dietas">
              <span>Dietas Limits (Meal Allowances)</span>
              <span class="section-icon">+</span>
            </button>
            <div class="section-content" id="content-dietas" hidden>
              <p class="plain-summary">
                Spanish tax law allows deduction of meal expenses ("dietas") up to fixed daily limits
                when working in a different municipality from your residence. Higher limits apply abroad.
              </p>
              <table class="fiscal-table">
                <thead>
                  <tr>
                    <th>Location</th>
                    <th>With Overnight</th>
                    <th>Without Overnight</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Spain</td>
                    <td>${formatEUR(DIETAS_LIMITS.spain.withOvernight)}/day</td>
                    <td>${formatEUR(DIETAS_LIMITS.spain.withoutOvernight)}/day</td>
                  </tr>
                  <tr>
                    <td>Belgium (Abroad)</td>
                    <td class="highlight">${formatEUR(DIETAS_LIMITS.abroad.withOvernight)}/day</td>
                    <td>${formatEUR(DIETAS_LIMITS.abroad.withoutOvernight)}/day</td>
                  </tr>
                </tbody>
              </table>
              <cite class="source-citation">${DIETAS_LIMITS.source}</cite>
            </div>
          </div>

          <div class="compliance-section">
            <button class="section-header" aria-expanded="false" aria-controls="content-factura">
              <span>Factura Completa Requirements</span>
              <span class="section-icon">+</span>
            </button>
            <div class="section-content" id="content-factura" hidden>
              <p class="plain-summary">
                <strong>To deduct an expense, you need a "factura completa" (complete invoice)</strong>,
                not just a ticket or receipt. The invoice must include both the supplier's AND your fiscal data.
              </p>
              <ul class="requirements-list">
                ${FACTURA_REQUIREMENTS.required.map(r => `
                  <li>
                    <span class="field-name">${r.field}</span>
                    <span class="field-desc">${r.description}</span>
                  </li>
                `).join('')}
              </ul>
              <div class="invalid-list">
                <h5>NOT Valid for Deduction:</h5>
                <ul class="requirements-list">
                  ${FACTURA_REQUIREMENTS.notValid.map(r => `
                    <li>
                      <span class="invalid-type">${r.type}</span>
                      <span class="field-desc">- ${r.reason}</span>
                    </li>
                  `).join('')}
                </ul>
              </div>
              <cite class="source-citation">${FACTURA_REQUIREMENTS.source}</cite>
            </div>
          </div>

          <div class="compliance-section">
            <button class="section-header" aria-expanded="false" aria-controls="content-payment">
              <span>Electronic Payment Requirement</span>
              <span class="section-icon">+</span>
            </button>
            <div class="section-content" id="content-payment" hidden>
              <p class="plain-summary">
                Since 2018, meal/maintenance expenses (dietas) must be paid via electronic means to be deductible.
              </p>
              <div class="payment-warning">
                <strong>Cash payments for dietas are NOT deductible.</strong>
                <p>Acceptable payment methods: bank card, bank transfer, Bizum, or other traceable electronic payment.</p>
              </div>
              <cite class="source-citation">Ley 6/2017 (AEAT)</cite>
            </div>
          </div>
        </div>

        <!-- SECTION 3: When Filing Taxes -->
        <div class="action-phase">
          <h3>When Filing Taxes</h3>

          <div class="compliance-section">
            <button class="section-header" aria-expanded="false" aria-controls="content-tiebreaker">
              <span>Treaty Tie-Breaker Rules (Article 4)</span>
              <span class="section-icon">+</span>
            </button>
            <div class="section-content" id="content-tiebreaker" hidden>
              <p class="plain-summary">
                When both Spain and Belgium claim you as a tax resident, the treaty resolves the conflict
                using a 5-step hierarchy. <strong>The first criterion that produces a clear answer determines your residence.</strong>
              </p>
              <ol class="tie-breaker-steps">
                ${TREATY_ARTICLE_4.steps.map(s => `
                  <li>
                    <span class="step-name">${s.name}</span>
                    <span class="step-legal">"${s.legal}"</span>
                    <span class="step-plain">${s.plain}</span>
                  </li>
                `).join('')}
              </ol>
              <cite class="source-citation">${TREATY_ARTICLE_4.source}</cite>
            </div>
          </div>

          <div class="compliance-section">
            <button class="section-header" aria-expanded="false" aria-controls="content-centro">
              <span>Centro de Intereses Vitales (Center of Vital Interests)</span>
              <span class="section-icon">+</span>
            </button>
            <div class="section-content" id="content-centro" hidden>
              <p class="plain-summary">
                The "center of vital interests" considers BOTH personal ties (family, social connections)
                AND economic ties (work, assets). Per OECD Commentary, <strong>personal ties receive special weight</strong>.
              </p>
              <p class="plain-summary">
                <strong>Personal relations include:</strong> Family location, social relationships, where you "live your life"
              </p>
              <p class="plain-summary">
                <strong>Economic relations include:</strong> Work location, income source, property ownership
              </p>
              <p class="plain-summary">
                For a person with family in one country but working extensively in another:
                The family location often tips the balance, especially when combined with maintained family home,
                regular returns, and social ties in the home country.
              </p>
              <cite class="source-citation">OECD Model Tax Convention Commentary, Art. 4</cite>
            </div>
          </div>

          <div class="compliance-section">
            <button class="section-header" aria-expanded="false" aria-controls="content-family">
              <span>Family Presumption (Art. 9.1.b LIRPF)</span>
              <span class="section-icon">+</span>
            </button>
            <div class="section-content" id="content-family" hidden>
              <blockquote class="legal-text" cite="BOE-A-2006-20764">
                "${ARTICLE_9_1_B.legalText}"
              </blockquote>
              <p class="plain-summary">
                <strong>In plain language:</strong> ${ARTICLE_9_1_B.plainSummary}
              </p>
              <p class="plain-summary" style="margin-top: 1rem;">
                <strong>Practical implication:</strong> ${ARTICLE_9_1_B.implication}
              </p>
              <cite class="source-citation">${ARTICLE_9_1_B.source}</cite>
            </div>
          </div>

          <div class="compliance-section">
            <button class="section-header" aria-expanded="false" aria-controls="content-183">
              <span>The 183-Day Threshold</span>
              <span class="section-icon">+</span>
            </button>
            <div class="section-content" id="content-183" hidden>
              <p class="plain-summary">
                The 183-day rule determines tax residence under <strong>domestic law</strong>.
                If you spend more than 183 days in Spain, Spanish law considers you a Spanish tax resident.
                Similarly, Belgium counts days for its own residency determination.
              </p>
              <p class="plain-summary">
                <strong>For treaty purposes:</strong> The Spain-Belgium treaty uses a 12-month rolling period
                (not calendar year) when determining where employment income can be taxed.
              </p>
              <div class="entry-exit-warning">
                <strong>Entry and exit days count in BOTH countries.</strong>
                <p>When you fly from Spain to Belgium, that day counts toward your presence in both countries.
                This means your total "days" may exceed 365 when added together. Tax authorities use "day of presence"
                rules that count any partial day as a full day in that country.</p>
              </div>
              <cite class="source-citation">LIRPF Art. 9.1.a, Spain-Belgium Treaty Art. 15</cite>
            </div>
          </div>
        </div>
      `;

      // Set up collapsible section event listeners
      panel.querySelectorAll('.compliance-section .section-header').forEach(btn => {
        btn.addEventListener('click', () => {
          const expanded = btn.getAttribute('aria-expanded') === 'true';
          btn.setAttribute('aria-expanded', !expanded);
          const contentId = btn.getAttribute('aria-controls');
          const content = document.getElementById(contentId);
          if (content) {
            content.hidden = expanded;
          }
        });
      });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize scenario state
      scenarioState = initScenarioState();

      // Existing Phase 2 initialization
      renderAllSections();
      recalculateTotals();

      // Phase 3 initialization
      renderScenarioCards();
      renderComparisonTable();
      initEditDialog();
      initTemplateDialog();

      // Phase 4 initialization - Calendar
      renderCalendar();
      updateCountDisplays();  // Initialize count displays
      showContractedWizard(); // Show wizard if not yet applied

      // Phase 7 initialization - Compliance
      renderComplianceContent();
      updateComplianceWarning();

      // Phase 7.1 - Tooltip modal: close on backdrop click
      const tooltipModal = document.getElementById('tooltipModal');
      if (tooltipModal) {
        tooltipModal.addEventListener('click', (e) => {
          if (e.target === tooltipModal) {
            tooltipModal.close();
          }
        });
      }
    });
  </script>
</body>
</html>
