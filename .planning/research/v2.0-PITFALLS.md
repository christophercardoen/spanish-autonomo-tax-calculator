# Pitfalls Research - Spanish Autonomo Business Management System v2.0

**Domain:** Business management system with CRM, invoicing, receipt management, tax automation for Spanish autonomo with global clients
**Researched:** 2026-02-03
**Overall Confidence:** MEDIUM-HIGH (multiple official sources verified)
**Transformation Context:** Single-file HTML calculator (v1.1) to production business management system with financial data, cross-device sync, and tax compliance

---

## Executive Summary

Transforming a static tax calculator into a production business management system introduces ten categories of pitfalls: data architecture (migration, sync conflicts), Spanish invoicing compliance (VeriFactu, factura completa, numbering), cross-border tax implications (global clients, IVA rules), receipt OCR accuracy (European formats, languages), calendar-client integration (183-day tracking with multiple clients), expense-client linking (shared expenses, deductibility), tax automation (Modelo 130 cumulative errors, RETA regularization), security/compliance (GDPR, 4-year retention), mobile UX (offline mode, receipt upload), and migration (preserving v1.1 functionality).

The most dangerous v2.0-specific pitfalls are:

1. **VeriFactu invoice numbering gaps** - AEAT will flag discontinuous sequences; correcting requires rectificativa invoices, not deletions
2. **Float precision for currency** - JavaScript float errors (0.1 + 0.2 !== 0.3) cause cumulative financial calculation drift
3. **Sync conflict data loss** - Last-write-wins destroys financial records; need transaction logging and conflict resolution
4. **OCR date format confusion** - European DD/MM vs US MM/DD causes wrong expense dates (tax year attribution)
5. **Global client IVA mistakes** - Different rules for EU (inversion sujeto pasivo), UK (third country, no IVA), US (no IVA, but W-8BEN needed)

---

## Critical Pitfalls

Mistakes that cause major financial damage, AEAT penalties, data loss, or legal problems.

### Pitfall 1: VeriFactu Invoice Numbering Gaps

**What goes wrong:** Invoice management system allows deleting invoices or creates gaps in numbering sequences. Under VeriFactu (mandatory July 2027 for autonomos), AEAT cross-references invoice numbers and flags discontinuities.

**Impact:**
- Penalty up to 50,000 EUR per fiscal year for non-compliant software
- Invoice audit triggers requiring explanation for every gap
- Cannot delete invoices - must issue factura rectificativa instead
- "Ghost series" that bypass main ledger are explicitly forbidden

**Warning Signs:**
- Users requesting "delete invoice" functionality
- Draft invoices that never get finalized (gaps in sequence)
- Multiple invoice series without clear separation logic
- Ability to edit issued invoices without audit trail

**Prevention:**
- Invoice numbers are immutable once assigned
- Implement "void" workflow that creates anulacion record linking to original
- Corrections require factura rectificativa (separate series)
- Maintain hash chain between sequential invoices (VeriFactu requirement)
- Draft invoices should NOT consume sequence numbers until finalized

**Phase to Address:** Invoicing foundation phase (before any invoice can be created)

**Severity:** CRITICAL (50,000 EUR penalty + AEAT audit)

**Sources:**
- [VeriFactu Spain 2025-2026: Dates, QR, Penalties](https://getrenn.com/blog/verifactu)
- [Anti-Fraud Law in Spain: What Changes by 2026](https://getrenn.com/blog/anti-fraud-law)
- [VATupdate: Spain's VeriFactu System](https://www.vatupdate.com/2025/12/03/briefing-document-spains-verifactu-verified-billing-system/)

---

### Pitfall 2: Factura Completa Missing Mandatory Fields

**What goes wrong:** Invoice generator omits one or more of the 13 mandatory fields for Spanish factura completa. AEAT rejects invoices at audit, client cannot deduct expense.

**Impact:**
- Invoices not legally valid for tax purposes
- Client loses IVA deduction right (damages business relationship)
- Fine up to 1% of invoice value for missing mandatory fields
- Payment delays when clients request corrections

**Mandatory Fields (Spanish Factura Completa):**
1. Invoice number (consecutive, no gaps)
2. Issue date
3. Supplier full name
4. Supplier NIF
5. Supplier address (domicilio fiscal)
6. Client full name/company name
7. Client NIF/VAT number
8. Client address
9. Clear description of goods/services
10. Service/delivery date (if different from issue date)
11. Tax base (base imponible)
12. IVA rate and amount (or exemption reason)
13. Total amount

**Additional Required in Specific Cases:**
- IRPF retention (if client is obligated to retain)
- "Inversion del sujeto pasivo" mention for EU B2B
- Exemption article reference for tax-exempt operations

**Warning Signs:**
- Invoice template missing any field above
- Foreign clients entered without VAT number validation
- No service date field (required when different from issue date)
- Missing legal mentions for exemptions

**Prevention:**
- Invoice creation requires ALL mandatory fields before save
- Client record must have valid NIF/VAT stored
- Auto-populate legal mentions based on client type (EU B2B, third country, etc.)
- Preview mode shows exactly what will appear on PDF

**Phase to Address:** Client management and Invoice generation phases

**Severity:** CRITICAL (invoice invalidity + client relationship damage)

**Sources:**
- [Mandatory Invoice Details in Spain](https://getrenn.com/blog/mandatory-invoice-details)
- [Autonomo invoicing in Spain: complete 2025 guide](https://getrenn.com/blog/self-employed-invoicing)

---

### Pitfall 3: Float Precision Currency Calculation Errors

**What goes wrong:** Using JavaScript's native Number type for currency calculations causes floating-point precision errors. Small errors compound over time, causing invoices/reports to be off by cents.

**Example:** `0.1 + 0.2 === 0.30000000000000004` (not 0.3)

**Impact:**
- Invoice totals don't match line item sums
- Modelo 130 calculations drift from reality
- Bank reconciliation fails (0.01 EUR difference per transaction adds up)
- Audit trail shows inexplicable discrepancies
- User loses trust in calculation accuracy

**Warning Signs:**
- Totals that don't match manual calculator
- Comparison tests failing intermittently
- "Rounding differences" accumulating over quarters
- Using `toFixed()` for storage instead of display only

**Prevention:**
- Store all monetary values as integers (cents)
- Use currency.js library for all arithmetic operations
- Apply rounding only at display time, not storage
- Currency type must include amount + currency code (EUR vs USD)
- Test suite specifically for financial calculation edge cases

**Implementation:**
```javascript
// BAD: Float storage
const price = 19.99;
const tax = price * 0.21;  // Precision error

// GOOD: Integer storage (cents)
const priceInCents = 1999;
const taxInCents = Math.round(priceInCents * 0.21);  // 420 cents
```

**Phase to Address:** Data architecture phase (before any financial data stored)

**Severity:** CRITICAL (calculation accuracy is core value proposition)

**Sources:**
- [Handle Money in JavaScript: Financial Precision](https://dev.to/benjamin_renoux/financial-precision-in-javascript-handle-money-without-losing-a-cent-1chc)
- [Currency.js library](https://currency.js.org/)
- [JavaScript Rounding Errors in Financial Applications](https://www.robinwieruch.de/javascript-rounding-errors/)

---

### Pitfall 4: Sync Conflict Data Loss (Last-Write-Wins)

**What goes wrong:** User edits expense on mobile while offline, then edits same expense on desktop. When sync occurs, naive last-write-wins strategy destroys one version entirely.

**Impact:**
- Lost financial records (expense deleted, invoice modified incorrectly)
- Cannot prove expense at audit (4-year retention requirement violated)
- User loses trust in cross-device functionality
- Cannot determine which version was "correct"

**Warning Signs:**
- No conflict detection mechanism
- No version history for records
- Sync errors silently ignored
- "Your changes were overwritten" without recovery option

**Prevention:**
- Implement operation-based sync (log operations, not states)
- Version each record with vector clock or timestamp
- Detect conflicts and prompt user to resolve
- For financial data: server-wins with notification, not silent overwrite
- Maintain complete audit log of all changes with timestamps

**Conflict Resolution Strategy for Financial Data:**
1. Server version is source of truth
2. Local changes queued as "pending sync"
3. When conflict detected, show both versions
4. User explicitly chooses or merges
5. Never auto-delete financial records without explicit user action

**Phase to Address:** Data architecture phase (sync foundation)

**Severity:** CRITICAL (data loss violates 4-year retention requirement)

**Sources:**
- [Data Synchronization in PWAs: Offline-First Strategies](https://gtcsys.com/comprehensive-faqs-guide-data-synchronization-in-pwas-offline-first-strategies-and-conflict-resolution/)
- [Make Your PWA Work Offline Part 2](https://www.monterail.com/blog/pwa-offline-dynamic-data)

---

### Pitfall 5: Global Client IVA Rule Confusion

**What goes wrong:** System applies wrong IVA treatment based on client location. EU clients require VIES validation and inversion del sujeto pasivo. UK (post-Brexit) and US clients are third countries (no IVA at all). Getting this wrong causes tax authority issues in multiple jurisdictions.

**Client Types and IVA Treatment:**

| Client Location | IVA Treatment | Declaration |
|-----------------|---------------|-------------|
| Spain (B2B) | 21% IVA + IRPF retention | Modelo 303 |
| Spain (B2C) | 21% IVA | Modelo 303 |
| EU (B2B with valid VAT) | 0% (inversion sujeto pasivo) | Modelo 349 |
| EU (B2C or invalid VAT) | 21% Spanish IVA | Modelo 303 + OSS if applicable |
| UK (B2B) | 0% (third country export) | Modelo 303 at 0% |
| US/CA/AU (B2B) | 0% (third country export) | Modelo 303 at 0% |

**Impact:**
- Incorrect IVA charged (too much or too little)
- Missing Modelo 349 filings (150-10,000 EUR penalty)
- Removed from ROI (cannot do EU intracomunitario)
- Client cannot claim IVA if incorrectly charged
- Double taxation if client not informed of obligations

**Warning Signs:**
- No VIES validation when creating EU client
- Single "foreign client" category without EU/non-EU distinction
- Missing Modelo 349 when EU B2B operations exist
- Charging IVA to third-country clients

**Prevention:**
- Client creation requires country selection first
- EU countries: mandatory VIES validation of VAT number
- Automatic determination of invoice type based on client type
- Block invoice creation for EU B2B without valid VAT number
- Quarterly Modelo 349 reminder when EU operations exist
- Clear UI showing: "This invoice will be without IVA because [reason]"

**Special Cases:**
- **Belgian clients (B2B):** Inversion del sujeto pasivo, Modelo 349
- **UK clients (post-Brexit):** Third country, no IVA, no Modelo 349
- **US clients:** No IVA, but may need W-8BEN for treaty benefits

**Phase to Address:** Client management phase

**Severity:** CRITICAL (multi-jurisdiction tax compliance)

**Sources:**
- [IVA Intracomunitario Guide 2025](https://tukonta.com/asesoramiento/iva-intracomunitario/)
- [Invoicing Services Abroad from Spain](https://entretramites.com/en/fiscal-tax/invoicing-services-abroad-spain)
- [VIES VAT Number Validation](https://ec.europa.eu/taxation_customs/vies)

---

### Pitfall 6: 4-Year Document Retention Violation

**What goes wrong:** System auto-deletes old receipts/invoices or allows users to delete financial records before 4-year retention period expires (Article 66 LGT). At AEAT audit, documentation is missing.

**Impact:**
- Cannot prove deductions at audit (disallowed, plus 50-150% penalty)
- Loss of burden of proof advantage
- GDPR is NOT an excuse to delete financial records within retention period
- Personal liability for missing tax documentation

**Warning Signs:**
- "Delete" option available for any financial record
- No retention period tracking
- Storage space optimization that removes old records
- Receipt images not backed up properly

**Prevention:**
- Soft delete only (mark as deleted, never remove from database)
- Retention period calculated per document: issue date + 4 years + filing deadline
- Block deletion attempts with explanation: "This document must be retained until [date]"
- Archive system for records past retention (can be deleted after)
- Regular backup verification of receipt images

**Retention Timeline Example:**
- Invoice issued: 2026-03-15
- Tax year: 2026
- Filing deadline: June 2027 (Renta 2026)
- Retention until: June 2031 (4 years from filing deadline)
- Earliest possible deletion: July 2031

**Phase to Address:** Data architecture phase (before any delete functionality)

**Severity:** CRITICAL (AEAT audit + inability to defend deductions)

**Sources:**
- [Spain 4-Year Document Retention](https://www.fiscal-requirements.com/news/3924)
- [Autonomo Tax Obligations: Returns and Deadlines](https://www.europeaccountants.com/blog/autonomo-tax-obligations-returns-and-deadlines/)

---

## High-Severity Pitfalls

Mistakes that cause significant problems but are recoverable.

### Pitfall 7: Modelo 130 Cumulative Calculation Errors

**What goes wrong:** Tax automation calculates Q3 payment based only on Q3 data, instead of cumulative (Q1+Q2+Q3). System doesn't subtract retenciones already paid by clients, or prior quarterly payments.

**The Correct Formula:**
```
Pago Q3 = (Cumulative Income Jan-Sep - Cumulative Expenses Jan-Sep) x 20%
         - Retenciones received Jan-Sep
         - Payments made Q1 + Q2
```

**Impact:**
- Overpayment (cash flow problem, locked until annual return)
- Underpayment (penalties 35-150% of unpaid amount)
- Zero-result filing not submitted (still required, penalty for non-filing)
- Mismatch flagged at annual IRPF declaration

**Warning Signs:**
- Quarter-only calculations without cumulative totals
- Missing retenciones tracker
- No reminder for zero/negative result filing
- Prior payments not automatically subtracted

**Prevention:**
- Data model tracks cumulative YTD, not just current quarter
- Retenciones from client invoices automatically tracked
- Prior Modelo 130 payments stored and subtracted
- Explicit UI: "Q3 = 20% x (Net Jan-Sep) - Retenciones - Q1 Payment - Q2 Payment"
- Filing reminder even when result is zero: "You must still file Modelo 130 with 0 EUR"

**Phase to Address:** Tax automation phase

**Severity:** HIGH (penalties, but recoverable with proper filing)

**Sources:**
- [Modelo 130: Quarterly Income Tax for Self-Employed](https://www.facturaz.es/resources/guides/modelo-130-quarterly-income-tax-for-self-employed)
- [Declarando: Modelo 130 Guide](https://declarando.es/modelo-130)

---

### Pitfall 8: OCR Date Format Confusion (DD/MM vs MM/DD)

**What goes wrong:** Receipt OCR extracts date "03/04/2026" and interprets it as March 4 (US format) when it should be April 3 (European format). Wrong date = wrong tax year/quarter attribution.

**Impact:**
- Expense attributed to wrong quarter
- Modelo 130 calculations incorrect
- Audit shows expense date doesn't match receipt
- Cross-border receipts (Belgium, Spain) vs US receipts have different formats

**Warning Signs:**
- No date format detection/validation
- All dates assumed to be one format
- No user confirmation of extracted dates
- Receipts from multiple countries processed identically

**Prevention:**
- OCR must detect merchant location and use appropriate format
- If ambiguous (e.g., 03/04/2026), flag for user confirmation
- Use heuristics: if first number > 12, must be DD/MM
- Store dates in ISO 8601 format internally (YYYY-MM-DD)
- Show detected date with confirmation: "Date: April 3, 2026 - Correct? [Yes/No]"

**OCR Date Confidence Rules:**
- Unambiguous: 25/03/2026 = March 25 (HIGH confidence)
- Ambiguous: 03/04/2026 = March 4 or April 3? (LOW confidence, ask user)
- Written month: "3 Apr 2026" = April 3 (HIGH confidence)

**Phase to Address:** Receipt OCR phase

**Severity:** HIGH (tax year attribution errors)

**Sources:**
- [Date and time notation in Europe - Wikipedia](https://en.wikipedia.org/wiki/Date_and_time_notation_in_Europe)
- [List of date formats by country - Wikipedia](https://en.wikipedia.org/wiki/List_of_date_formats_by_country)

---

### Pitfall 9: Missing W-8BEN for US Clients

**What goes wrong:** Spanish autonomo invoices US clients without providing W-8BEN form. US client withholds 30% of payment (default withholding rate) instead of 0% treaty rate.

**Impact:**
- 30% of invoice value withheld by US client
- Complex IRS refund process to recover
- Client relationship damage (they prefer vendors with proper documentation)
- Annual renewal required (W-8BEN valid 3 years)

**Warning Signs:**
- US client created without W-8BEN tracking
- No reminder for W-8BEN expiration (3-year validity)
- US payments received at less than invoiced amount (30% withheld)

**Prevention:**
- Client type "US" triggers W-8BEN checklist item
- Track: W-8BEN submitted? Date? Expiration?
- Reminder 60 days before W-8BEN expiration
- Invoice for US client shows warning if W-8BEN not on file
- Guidance: "Without W-8BEN, client may withhold 30% of payment"

**US-Spain Treaty Reference:**
- Article 14 (Independent Personal Services): 0% withholding if no fixed base in US
- Requires valid W-8BEN with Spanish NIF and treaty claim

**Phase to Address:** Client management phase (US-specific requirements)

**Severity:** HIGH (30% cash flow hit, recoverable but slow)

**Sources:**
- [IRS: About Form W-8BEN](https://www.irs.gov/forms-pubs/about-form-w-8-ben)
- [Understanding the US-Spain Tax Treaty](https://trolley.com/learning-center/understanding-us-spain-tax-treaty/)

---

### Pitfall 10: 183-Day Counting with Multiple Clients

**What goes wrong:** Calendar shows days worked for each client separately. User thinks: "80 days for Client A + 100 days for Client B = 180 days, under threshold." But 183-day rule counts presence, not client attribution. Many days overlap.

**Impact:**
- Underestimate of actual Belgium presence days
- Unexpected crossing of 183-day threshold
- Dual residency complications with AEAT
- Entry/exit days counted twice (in both countries)

**Warning Signs:**
- Per-client day counters without total presence counter
- No handling of days worked for multiple clients
- Travel days not counted as presence
- Weekend days during work trips treated as "not work"

**Prevention:**
- Master presence calendar is source of truth
- Each day has single location (Belgium, Spain, Other)
- Client work is linked to days, but doesn't change presence count
- Working for 2 Belgian clients on same day = 1 Belgium day
- Entry/exit day warning: "Counts as presence in BOTH countries"
- Running total always visible: "Current: 145 Belgium days / 183 threshold"

**Example:**
- Monday: Belgium (Client A + Client B meeting) = 1 Belgium day
- Tuesday: Belgium (Client A) = 1 Belgium day
- Wednesday: Flight Spain -> Belgium = 1 Spain day + 1 Belgium day (counts both)
- Total: 3 Belgium days, 1 Spain day (4 presence-days from 3 calendar days)

**Phase to Address:** Calendar integration phase

**Severity:** HIGH (residency risk, but recoverable with treaty defense)

**Sources:**
- [The 183 Day Rule in Spain](https://abadabogados.com/en/183-day-rule-spain/)
- [Tax resident in Spain: How to calculate the 183 days?](https://www.agmabogados.com/en/when-am-i-a-tax-resident-in-spain-how-do-i-calculate-the-183-days/)

---

### Pitfall 11: Expense-Client Linking Ambiguity

**What goes wrong:** Flight to Belgium is for work with 2 clients. System forces single-client attribution, causing incorrect cost allocation or missed deduction opportunity.

**Categories of Expense Attribution:**

| Expense Type | Attribution | Deductibility |
|--------------|-------------|---------------|
| Client-specific (dedicated trip) | 100% to client | 100% deductible |
| Shared (multi-client trip) | Split by work days | 100% deductible |
| General overhead (home office) | No client link | 30% deductible |
| Private | None | 0% deductible |

**Impact:**
- Expenses not linked to any client (lost deduction tracking)
- Over-attribution to single client (incorrect project costing)
- Home office expenses incorrectly linked to clients
- Audit trail doesn't show allocation logic

**Warning Signs:**
- Expense requires exactly one client selection
- No "overhead" or "shared" expense category
- Home office costs forced into client attribution
- Belgium trip with multiple client meetings = which client?

**Prevention:**
- Expense can have: single client, multiple clients (split), or no client (overhead)
- Automatic split calculation based on work days
- Fixed expenses (home office 30%) never linked to specific clients
- Clear categorization: Client expense, Overhead expense, Private expense
- Trip detection: "This Belgium trip includes work for Client A (3 days) and Client B (2 days). Split costs 60%/40%?"

**Phase to Address:** Expense management phase

**Severity:** HIGH (accounting accuracy, deduction optimization)

---

### Pitfall 12: Missing Modelo 349 for EU Operations

**What goes wrong:** System tracks EU invoices but doesn't aggregate into Modelo 349 (required quarterly declaration of intracomunitario operations).

**Impact:**
- Penalty 150-10,000 EUR per omission
- Potential removal from ROI (cannot operate intracomunitario)
- Cross-reference mismatch between countries (Belgian tax authority queries Spain)

**Threshold Rules:**
- **Monthly filing:** If quarterly total > 50,000 EUR
- **Quarterly filing:** If no quarter > 50,000 EUR
- **No filing:** If no EU intracomunitario operations that quarter

**Warning Signs:**
- EU client invoices tracked but no Modelo 349 report
- No quarterly reminder for Modelo 349
- Operations classified incorrectly (B2C vs B2B)

**Prevention:**
- Automatic calculation of quarterly EU B2B totals
- Reminder: "You have 3,500 EUR in EU intracomunitario operations this quarter. File Modelo 349 by [date]."
- Pre-filled report with client NIF-IVA, amounts, operation keys
- Operation key validation: "E" for goods delivery, "S" for services received, etc.

**Phase to Address:** Tax automation phase (alongside Modelo 130)

**Severity:** HIGH (penalty + ROI removal risk)

**Sources:**
- [Modelo 349: Guide with Examples](https://declarando.es/modelo-349)
- [Stripe: Guide to Form 349 in Spain](https://stripe.com/resources/more/model-349-spain)

---

## Medium-Severity Pitfalls

Mistakes that cause friction and extra work.

### Pitfall 13: RETA Regularization Projection Missing

**What goes wrong:** User enters invoices but system doesn't project RETA regularization exposure. By year-end, actual rendimientos are far above declared tramo, causing shock lump-sum payment.

**Impact:**
- Unexpected payment demand (could be 1,000+ EUR)
- 10-20% recargo if not paid timely
- Benefits calculated on wrong base (cannot correct retroactively)

**Prevention:**
- Real-time calculation: "Your current net income (X EUR/month average) is in tramo Y. You're paying tramo Z. Projected regularization: W EUR."
- Alert when divergence > 1 tramo
- Recommendation to adjust tramo proactively

**Phase to Address:** Tax automation phase

**Severity:** MEDIUM (cash flow shock, but expected after v1.1 education)

---

### Pitfall 14: Dietas Limit Exceeded Without Warning

**What goes wrong:** OCR extracts 120 EUR hotel expense in Belgium. System accepts it, but dietas limit is 91.35 EUR/day with overnight. The 28.65 EUR excess is non-deductible.

**Spanish Dietas Limits (Abroad):**

| Type | Daily Limit |
|------|-------------|
| With overnight (pernocta) | 91.35 EUR |
| Without overnight | 48.08 EUR |

**Impact:**
- Over-deduction discovered at audit
- Penalty on disallowed amount
- Must recalculate Modelo 130 payments

**Warning Signs:**
- No validation against dietas limits
- Daily expense totals not aggregated
- Multiple expense entries for same day not summed

**Prevention:**
- Per-day expense aggregation
- Warning: "Total expenses for 2026-03-15 in Belgium: 125 EUR. Dietas limit: 91.35 EUR. 33.65 EUR is non-deductible."
- Automatic marking of excess as "non-deductible" portion

**Phase to Address:** Receipt/expense management phase

**Severity:** MEDIUM (audit adjustment, but calculable)

---

### Pitfall 15: Receipt OCR Low Confidence Without Fallback

**What goes wrong:** OCR returns extraction with 45% confidence on crumpled Belgian hotel receipt. System accepts values without flagging uncertainty.

**Common OCR Failure Scenarios:**
- Handwritten receipts (some hotels still use these)
- Multi-page hotel bills (PDF with itemized charges)
- Low photo quality (blurry, shadows, wrinkled paper)
- Multi-language (Dutch, French, German on Belgian receipts)
- Currency symbol confusion (EUR vs USD vs GBP)

**Impact:**
- Wrong amounts entered into system
- Wrong dates attributed
- Duplicate receipts not detected
- Manual correction required but user doesn't know

**Warning Signs:**
- No confidence score shown
- No manual review workflow for low-confidence extractions
- Duplicate detection only by exact match

**Prevention:**
- Show confidence score for each extracted field
- Below 70% confidence: require manual verification
- Highlight low-confidence fields in yellow
- Duplicate detection by: amount + date range + vendor similarity
- Fallback: "Cannot read this receipt. Please enter manually."

**OCR Confidence Thresholds:**
- > 90%: Auto-accept, green indicator
- 70-90%: Accept with warning, yellow indicator
- < 70%: Manual entry required, red indicator

**Phase to Address:** Receipt OCR phase

**Severity:** MEDIUM (data quality, correctable)

---

### Pitfall 16: localStorage Data Loss During Migration

**What goes wrong:** v1.1 uses localStorage for all data. Migration to v2.0 database clears localStorage without proper export, losing user's existing scenarios and calendar data.

**Impact:**
- Loss of all v1.1 customizations
- Calendar patterns deleted (user spent hours configuring)
- User trust destroyed
- No way to recover without backup

**Warning Signs:**
- No export option in v1.1
- Migration doesn't read localStorage first
- No parallel-run period
- "Start fresh" as only v2.0 option

**Prevention:**
- v1.1 EOL includes export to JSON functionality
- v2.0 onboarding: "Import data from v1.1?" with file picker
- OR automatic localStorage detection and migration prompt
- Parallel running: v1.1 remains accessible during v2.0 transition
- Explicit warning: "Migration will import your existing data. Verify before proceeding."

**Migration Flow:**
1. Detect existing localStorage data
2. Show preview: "Found: 5 custom scenarios, 45 calendar entries, 12 expenses"
3. User confirms import
4. Create backup in v2.0 database
5. Mark localStorage as migrated (don't auto-delete)
6. Allow manual localStorage clear after verification

**Phase to Address:** Migration/onboarding phase (first v2.0 release)

**Severity:** MEDIUM (data loss, but v1.1 is simulator - recoverable with effort)

**Sources:**
- [localForage Migration Issue](https://github.com/localForage/localForage/issues/41)
- [LocalStorage vs IndexedDB Guide](https://dev.to/tene/localstorage-vs-indexeddb-javascript-guide-storage-limits-best-practices-fl5)

---

### Pitfall 17: Client NIF Not Encrypted at Rest

**What goes wrong:** Client database stores NIF/tax IDs in plaintext. Data breach exposes sensitive tax identifiers. AEPD (Spanish data protection authority) considers NIF "particularly sensitive."

**Impact:**
- GDPR violation (Article 32 - security of processing)
- AEPD fine (up to 260,000 EUR in recent cases involving NIF)
- Identity theft risk for clients
- Reputational damage

**Warning Signs:**
- Database fields storing NIF without encryption
- Logs containing client NIF in plaintext
- Backups not encrypted
- API responses including NIF unnecessarily

**Prevention:**
- Encrypt NIF at rest (AES-256 minimum)
- Access logging for NIF field reads
- Mask NIF in UI (show only last 3 characters: "***1234X")
- Never log NIF values
- Data minimization: only store NIF when legally required (invoices)

**Phase to Address:** Data architecture phase (security foundations)

**Severity:** MEDIUM (GDPR compliance, but no breach = no penalty)

**Sources:**
- [AEPD Spain - EXP202404641](https://gdprhub.eu/index.php?title=AEPD_(Spain)_-_EXP202404641)
- [GDPR Guide to National Implementation: Spain](https://www.whitecase.com/insight-our-thinking/gdpr-guide-national-implementation-spain)

---

### Pitfall 18: Mobile Receipt Upload Without Offline Mode

**What goes wrong:** User traveling in Belgium takes photo of receipt, but mobile data is slow/unavailable. Upload fails, user forgets to retry, receipt lost.

**Impact:**
- Missing receipts (4-year retention violated)
- Expense not recorded (deduction lost)
- User frustration with mobile experience

**Warning Signs:**
- Receipt upload requires immediate network connection
- No queue for pending uploads
- No local storage of receipt images
- Failed uploads not retried

**Prevention:**
- Save receipt image locally first (IndexedDB or file system)
- Queue for background upload when connectivity available
- Visual indicator: "3 receipts pending upload"
- Retry logic with exponential backoff
- Never delete local copy until server confirms storage

**PWA Requirements:**
- Service worker for offline functionality
- IndexedDB for receipt image storage
- Background sync API for upload queue
- Notification when sync completes

**Phase to Address:** Mobile/PWA phase

**Severity:** MEDIUM (UX friction, data loss risk)

---

## Low-Severity Pitfalls

Annoyances that are easily correctable.

### Pitfall 19: VeriFactu QR Code Wrong Format

**What goes wrong:** Invoice PDF includes QR code, but format doesn't match AEAT specifications. Client cannot verify invoice at AEAT portal.

**VeriFactu QR Requirements:**
- Links to AEAT verification portal
- Contains: invoice ID, hash, verification URL
- Must include text: "Factura verificable en la sede electronica de la AEAT" or "VERI*FACTU"

**Prevention:**
- Use official AEAT QR specification
- Test QR verification manually before production
- Include required legend text below QR

**Phase to Address:** Invoice generation phase (PDF templates)

**Severity:** LOW (correctable with template update, July 2027 deadline)

---

### Pitfall 20: Calendar Sync Creates Duplicate Events

**What goes wrong:** Google Calendar integration syncs Belgium work days, but doesn't detect existing events. User gets duplicate "Belgium - Client A" entries.

**Prevention:**
- Unique ID per calendar event (stored in extended properties)
- Before create: check if event with same ID exists
- Update existing instead of creating new
- Two-way sync: changes in Google Calendar reflected in app

**Phase to Address:** Calendar integration phase

**Severity:** LOW (annoying, not data loss)

---

### Pitfall 21: Multi-Page PDF Receipt Processed Incorrectly

**What goes wrong:** Hotel bill is 3-page PDF with itemized charges. OCR extracts total from each page instead of grand total, creating 3 expense entries.

**Prevention:**
- PDF page detection: if multi-page, look for "Total" or "Grand Total" keywords
- Aggregate amounts intelligently
- Show preview: "Detected 3 pages. Grand total: 285 EUR. Correct?"
- Allow manual override for complex documents

**Phase to Address:** Receipt OCR phase

**Severity:** LOW (manual correction available)

---

## Phase-Specific Pitfall Mapping

| Phase | Critical Pitfalls | High Pitfalls | Medium Pitfalls |
|-------|------------------|---------------|-----------------|
| Data Architecture | 3 (float precision), 4 (sync conflicts), 6 (retention) | - | 16 (migration), 17 (encryption) |
| Client Management | 2 (factura fields), 5 (IVA rules) | 9 (W-8BEN), 11 (expense linking) | - |
| Invoice Generation | 1 (numbering), 2 (fields) | - | 19 (QR format) |
| Receipt/Expense | - | 8 (date formats), 14 (dietas) | 15 (OCR confidence), 21 (multi-page) |
| Calendar Integration | - | 10 (183-day counting) | 20 (sync duplicates) |
| Tax Automation | - | 7 (Modelo 130), 12 (Modelo 349) | 13 (RETA projection) |
| Mobile/PWA | - | - | 18 (offline upload) |

---

## Prevention Strategy by Severity

### Critical (Must Address Before Launch)
1. Integer storage for all currency values (cents)
2. VeriFactu-compliant invoice numbering (no gaps, rectificativa workflow)
3. Factura completa validation (all 13 fields required)
4. VIES validation for EU clients
5. 4-year retention enforcement (soft delete only)
6. Sync conflict detection with user resolution

### High (Address in First Release)
1. Modelo 130 cumulative calculation with retenciones
2. OCR date format detection and confirmation
3. W-8BEN tracking for US clients
4. 183-day master presence counter
5. Modelo 349 automation for EU operations

### Medium (Address in First Quarter)
1. localStorage migration path
2. Dietas limit validation
3. OCR confidence thresholds
4. RETA regularization projection
5. NIF encryption at rest

---

## Confidence Assessment

| Pitfall Category | Confidence | Reason |
|-----------------|------------|--------|
| VeriFactu compliance (1, 19) | HIGH | RD 254/2025, official AEAT documentation |
| Factura completa (2) | HIGH | Official AEAT requirements, multiple sources |
| Float precision (3) | HIGH | Well-documented JavaScript behavior |
| Sync conflicts (4) | HIGH | Standard PWA/offline patterns |
| IVA rules (5) | HIGH | AEAT guidance, EU framework |
| Document retention (6) | HIGH | Article 66 LGT, official requirement |
| Modelo 130 (7) | HIGH | Official AEAT requirements |
| Date formats (8) | HIGH | ISO standards, well-documented |
| W-8BEN (9) | HIGH | IRS documentation, treaty text |
| 183-day counting (10) | HIGH | TEAC rulings, Spanish jurisprudence |
| Expense linking (11) | MEDIUM | Business logic, some interpretation needed |
| Modelo 349 (12) | HIGH | AEAT requirements, penalties documented |
| OCR accuracy (15) | MEDIUM | Varies by implementation, general patterns known |
| Migration (16) | HIGH | Well-documented browser storage behavior |
| GDPR/NIF (17) | HIGH | AEPD rulings, GDPR requirements |

---

## Sources Summary

### Official/Authoritative (HIGH confidence)
- [AEAT: VeriFactu Systems](https://sede.agenciatributaria.gob.es/Sede/iva/sistemas-informaticos-facturacion-verifactu.html)
- [VIES VAT Number Validation](https://ec.europa.eu/taxation_customs/vies)
- [IRS: Form W-8BEN](https://www.irs.gov/forms-pubs/about-form-w-8-ben)
- [AEPD: GDPR Enforcement](https://gdprhub.eu)
- [BOE: Article 66 LGT](https://www.boe.es/buscar/act.php?id=BOE-A-2003-23186)

### Technical References (HIGH confidence)
- [Currency.js](https://currency.js.org/)
- [JavaScript Rounding Errors](https://www.robinwieruch.de/javascript-rounding-errors/)
- [MDN: Storage Quotas](https://developer.mozilla.org/en-US/docs/Web/API/Storage_API/Storage_quotas_and_eviction_criteria)

### Tax Guidance (MEDIUM confidence)
- [Declarando: Modelo 130](https://declarando.es/modelo-130)
- [Declarando: Modelo 349](https://declarando.es/modelo-349)
- [TuKonta: IVA Intracomunitario](https://tukonta.com/asesoramiento/iva-intracomunitario/)
- [Rydoo: Per Diems in Spain](https://www.rydoo.com/compliance/spain/per-diems-in-spain/)

---

*Research completed: 2026-02-03*
*Confidence: MEDIUM-HIGH*
*Ready for roadmap: YES*
