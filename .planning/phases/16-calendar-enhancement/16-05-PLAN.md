---
phase: 16-calendar-enhancement
plan: 05
type: execute
wave: 3
depends_on: ["16-02"]
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "User can export calendar to ICS file with client information"
    - "User can export calendar to CSV file for spreadsheet analysis"
    - "Export includes all days with location, client, project, notes"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Enhanced ICS export"
      contains: "generateEnhancedICS"
    - path: "autonomo_dashboard.html"
      provides: "CSV export"
      contains: "generateCSV"
  key_links:
    - from: "generateEnhancedICS"
      to: "CalendarManager"
      via: "day data query"
      pattern: "CalendarManager\\.getDaysForYear"
---

<objective>
Enhance ICS export to include client/project information and add CSV export capability.

Purpose: Enable users to use calendar data in external tools (Google Calendar, Excel, etc.)
Output: Enhanced ICS with client tags, CSV export with all fields
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-calendar-enhancement/16-RESEARCH.md
@.planning/phases/16-calendar-enhancement/16-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance ICS Export with Client Information</name>
  <files>autonomo_dashboard.html</files>
  <action>
Update existing generateICS() function to include client/project data:

1. Create generateEnhancedICS(year) async function:
   ```javascript
   async function generateEnhancedICS(year) {
     // Get all days for the year
     const days = await CalendarManager.getDaysForYear(year);

     // Get client lookup for names
     const clients = await ClientManager.getClients();
     const clientMap = new Map(clients.map(c => [c.id, c.name]));

     // Get project lookup for names
     const projects = await db.projects
       .where('entity_id').equals(EntityContext.entityId)
       .toArray();
     const projectMap = new Map(projects.map(p => [p.id, p.name]));

     // Generate events
     const events = days
       .filter(d => d.location && d.location !== 'unset')
       .map(d => {
         const date = new Date(d.date);
         const nextDay = new Date(date);
         nextDay.setDate(nextDay.getDate() + 1);

         // Build summary with location and client
         const locationText = {
           belgium: 'Belgium üáßüá™',
           spain: 'Spain üá™üá∏',
           travel: 'Travel ‚úàÔ∏è',
           other: 'Other üìç'
         }[d.location];

         const clientName = d.client_id ? clientMap.get(d.client_id) : null;
         const projectName = d.project_id ? projectMap.get(d.project_id) : null;

         let summary = locationText;
         if (clientName) summary += ` - ${clientName}`;
         if (projectName) summary += ` (${projectName})`;

         // Build description
         let description = `Location: ${locationText}`;
         if (clientName) description += `\\nClient: ${clientName}`;
         if (projectName) description += `\\nProject: ${projectName}`;
         if (d.notes) description += `\\nNotes: ${d.notes}`;

         return `BEGIN:VEVENT
DTSTART;VALUE=DATE:${d.date.replace(/-/g, '')}
DTEND;VALUE=DATE:${toISODateKey(nextDay).replace(/-/g, '')}
DTSTAMP:${formatICSTimestamp(new Date())}
UID:${d.id || d.date}-${d.entity_id}@autonomo-calculator
SUMMARY:${escapeICS(summary)}
DESCRIPTION:${escapeICS(description)}
END:VEVENT`;
       });

     return `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Autonomo Tax Calculator//Work Calendar v2.0//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:Work Calendar ${year}
X-WR-CALDESC:Autonomo work presence calendar
${events.join('\n')}
END:VCALENDAR`;
   }

   // Helper: Escape special characters for ICS
   function escapeICS(str) {
     return str
       .replace(/\\/g, '\\\\')
       .replace(/,/g, '\\,')
       .replace(/;/g, '\\;')
       .replace(/\n/g, '\\n');
   }
   ```

2. Update export button handler to use new function:
   ```javascript
   async function exportToICS() {
     const year = calendarState.currentYear;
     const ics = await generateEnhancedICS(year);

     const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
     const url = URL.createObjectURL(blob);
     const a = document.createElement('a');
     a.href = url;
     a.download = `work-calendar-${year}.ics`;
     a.click();
     URL.revokeObjectURL(url);
   }
   ```

3. Keep existing formatICSTimestamp() function if present, or add:
   ```javascript
   function formatICSTimestamp(date) {
     return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
   }
   ```
  </action>
  <verify>
Export test:
1. Click Export ICS button
2. Open downloaded file in text editor
3. Verify events include SUMMARY with client name
4. Verify DESCRIPTION includes project and notes
  </verify>
  <done>
ICS export includes location, client, project, and notes in each event
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement CSV Export</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add CSV export functionality for spreadsheet analysis:

1. Create generateCSV(year) async function:
   ```javascript
   async function generateCSV(year) {
     // Get all days for the year
     const days = await CalendarManager.getDaysForYear(year);

     // Get client and project lookups
     const clients = await ClientManager.getClients();
     const clientMap = new Map(clients.map(c => [c.id, c.name]));

     const projects = await db.projects
       .where('entity_id').equals(EntityContext.entityId)
       .toArray();
     const projectMap = new Map(projects.map(p => [p.id, p.name]));

     // CSV header
     const headers = ['Date', 'Day', 'Location', 'Client', 'Project', 'Notes'];

     // CSV rows
     const rows = days
       .sort((a, b) => a.date.localeCompare(b.date))
       .map(d => {
         const date = new Date(d.date);
         const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
         const location = d.location || '';
         const client = d.client_id ? (clientMap.get(d.client_id) || '') : '';
         const project = d.project_id ? (projectMap.get(d.project_id) || '') : '';
         const notes = d.notes || '';

         return [
           d.date,
           dayName,
           location,
           escapeCSV(client),
           escapeCSV(project),
           escapeCSV(notes)
         ];
       });

     // Build CSV content
     const csvContent = [
       headers.join(','),
       ...rows.map(row => row.join(','))
     ].join('\n');

     return csvContent;
   }

   // Helper: Escape CSV fields
   function escapeCSV(str) {
     if (!str) return '';
     // If contains comma, quote, or newline, wrap in quotes and escape inner quotes
     if (/[,"\n\r]/.test(str)) {
       return `"${str.replace(/"/g, '""')}"`;
     }
     return str;
   }
   ```

2. Create export handler:
   ```javascript
   async function exportToCSV() {
     const year = calendarState.currentYear;
     const csv = await generateCSV(year);

     const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
     const url = URL.createObjectURL(blob);
     const a = document.createElement('a');
     a.href = url;
     a.download = `work-calendar-${year}.csv`;
     a.click();
     URL.revokeObjectURL(url);
   }
   ```

3. Add export buttons to calendar toolbar:
   ```html
   <div class="calendar-export-buttons">
     <button type="button" class="btn btn-secondary" onclick="exportToICS()" title="Export to iCal format">
       üìÖ Export ICS
     </button>
     <button type="button" class="btn btn-secondary" onclick="exportToCSV()" title="Export to CSV for Excel">
       üìä Export CSV
     </button>
   </div>
   ```

4. Add CSS for button group:
   ```css
   .calendar-export-buttons {
     display: flex;
     gap: 0.5rem;
   }
   ```
  </action>
  <verify>
CSV export test:
1. Click Export CSV button
2. Open in Excel/Google Sheets
3. Verify columns: Date, Day, Location, Client, Project, Notes
4. Verify data rows match calendar entries
  </verify>
  <done>
CSV export produces valid spreadsheet with all calendar data
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Expense Linking Infrastructure</name>
  <files>autonomo_dashboard.html</files>
  <action>
Prepare expense linking infrastructure for Phase 17:

1. Update CalendarManager.getLinkedExpenseCount(dateKey) to query expenses:
   ```javascript
   async getLinkedExpenseCount(dateKey) {
     // Check if expenses table is populated (Phase 17)
     try {
       const count = await db.expenses
         .where('[entity_id+date]')
         .equals([EntityContext.entityId, dateKey])
         .count();
       return count;
     } catch (e) {
       // Table may not have index or expenses feature not ready
       return 0;
     }
   }
   ```

2. Add batch method for getting expense counts for a month:
   ```javascript
   async getLinkedExpenseCounts(dateKeys) {
     const counts = {};
     try {
       const expenses = await db.expenses
         .where('entity_id').equals(EntityContext.entityId)
         .and(e => dateKeys.includes(e.date))
         .toArray();

       dateKeys.forEach(key => counts[key] = 0);
       expenses.forEach(e => {
         if (counts[e.date] !== undefined) counts[e.date]++;
       });
     } catch (e) {
       dateKeys.forEach(key => counts[key] = 0);
     }
     return counts;
   }
   ```

3. Update renderCalendar() to show expense badges:
   - Call getLinkedExpenseCounts() for visible month
   - Display badge on days with expenses > 0
   - Use small badge in corner of day cell

4. Update day editor to show linked expenses (read-only list):
   ```javascript
   async function loadDayExpenses(dateKey) {
     const expensesDiv = document.getElementById('dayEditorExpensesInfo');
     const countDiv = document.getElementById('dayEditorExpensesCount');

     try {
       const count = await CalendarManager.getLinkedExpenseCount(dateKey);
       if (count > 0) {
         countDiv.textContent = `${count} expense(s) linked to this day`;
         expensesDiv.style.display = 'block';
       } else {
         expensesDiv.style.display = 'none';
       }
     } catch (e) {
       expensesDiv.style.display = 'none';
     }
   }
   ```

5. Note: Full expense linking will be implemented in Phase 17
  </action>
  <verify>
Infrastructure test:
1. Check that getLinkedExpenseCount returns 0 (no expenses yet)
2. Calendar renders without errors
3. Day editor doesn't show expense section (count is 0)
  </verify>
  <done>
Expense linking infrastructure ready for Phase 17 integration
  </done>
</task>

</tasks>

<verification>
1. ICS export includes client and project in events
2. CSV export produces valid spreadsheet format
3. Both exports work for any year in range
4. Expense linking infrastructure doesn't break existing functionality
5. Export buttons visible and functional on calendar
</verification>

<success_criteria>
- ICS export includes enhanced event information
- CSV export works in Excel/Sheets
- Expense linking placeholder ready for Phase 17
- No regressions in existing calendar functionality
</success_criteria>

<output>
After completion, create `.planning/phases/16-calendar-enhancement/16-05-SUMMARY.md`
</output>
