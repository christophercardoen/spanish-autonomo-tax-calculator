---
phase: 16-calendar-enhancement
plan: 04
type: execute
wave: 3
depends_on: ["16-02"]
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "183-day threshold warnings appear at 170, 180, and 183 days"
    - "Belgium + Travel days both count toward threshold"
    - "Calendar supports multiple years (2026 Feb-Dec + 2027 full year)"
    - "Month/annual count displays update in real-time"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Enhanced count calculation"
      contains: "calculateThresholdCounts"
    - path: "autonomo_dashboard.html"
      provides: "Warning display"
      contains: "threshold-warning"
  key_links:
    - from: "calculateThresholdCounts"
      to: "CalendarManager.getDaysForYear"
      via: "annual day query"
      pattern: "getDaysForYear"
---

<objective>
Enhance 183-day threshold tracking to work with IndexedDB data, support multi-year navigation, and show progressive warning levels.

Purpose: Preserve tax residency compliance monitoring while transitioning to new data layer
Output: Updated count displays, warning banners at 170/180/183 days, year navigation
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-calendar-enhancement/16-RESEARCH.md
@.planning/phases/16-calendar-enhancement/16-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor Count Calculation to Use IndexedDB</name>
  <files>autonomo_dashboard.html</files>
  <action>
Replace existing calculateCounts() with async IndexedDB-based version:

1. Create calculateThresholdCounts(year) async function:
   ```javascript
   async function calculateThresholdCounts(year) {
     const days = await CalendarManager.getDaysForYear(year);

     let belgium = 0, spain = 0, travel = 0, other = 0;
     const monthCounts = {};

     // Initialize month counts (month is 1-12 for display)
     for (let m = 1; m <= 12; m++) {
       monthCounts[m] = { belgium: 0, spain: 0, travel: 0 };
     }

     days.forEach(d => {
       const month = parseInt(d.date.split('-')[1], 10);

       switch (d.location) {
         case 'belgium':
           belgium++;
           monthCounts[month].belgium++;
           break;
         case 'spain':
           spain++;
           monthCounts[month].spain++;
           break;
         case 'travel':
           travel++;
           monthCounts[month].travel++;
           break;
         case 'other':
           other++;
           break;
       }
     });

     return {
       annual: {
         belgium,
         spain,
         travel,
         other,
         threshold: belgium + travel  // Both count toward 183
       },
       monthly: monthCounts
     };
   }
   ```

2. Update updateCountDisplays() to be async:
   - Await calculateThresholdCounts(currentYear)
   - Update DOM elements with counts
   - Update warning banner based on threshold

3. Keep fallback for old localStorage data during migration period:
   - If IndexedDB returns 0 days but localStorage has data, show migration prompt
  </action>
  <verify>
Console test:
- `await calculateThresholdCounts(2026)` returns object with annual and monthly counts
- Matches visible calendar days when manually counted
  </verify>
  <done>
Count calculation uses IndexedDB data with monthly and annual breakdowns
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Progressive Warning System</name>
  <files>autonomo_dashboard.html</files>
  <action>
Create three-tier warning system for 183-day threshold:

1. Define warning levels:
   ```javascript
   const WARNING_LEVELS = Object.freeze({
     SAFE: { threshold: 0, class: 'safe', icon: '‚úÖ', message: '' },
     CAUTION: { threshold: 170, class: 'caution', icon: '‚ö†Ô∏è', message: 'Approaching 183-day threshold' },
     WARNING: { threshold: 180, class: 'warning', icon: 'üî∂', message: 'Very close to 183-day threshold' },
     DANGER: { threshold: 183, class: 'danger', icon: 'üö®', message: 'EXCEEDED 183-day threshold!' }
   });
   ```

2. Create getWarningLevel(thresholdCount) function:
   - Returns appropriate WARNING_LEVELS entry

3. Update/create warning banner HTML:
   ```html
   <div id="thresholdWarningBanner" class="threshold-banner" style="display: none;">
     <span class="warning-icon"></span>
     <span class="warning-message"></span>
     <span class="warning-count">
       <strong id="thresholdCount">0</strong> of 183 days
     </span>
     <button type="button" class="warning-dismiss" onclick="dismissThresholdWarning()">√ó</button>
   </div>
   ```

4. Add CSS for warning levels:
   ```css
   .threshold-banner {
     padding: 0.75rem 1rem;
     margin-bottom: 1rem;
     border-radius: 6px;
     display: flex;
     align-items: center;
     gap: 0.75rem;
     font-size: 0.9rem;
   }

   .threshold-banner.safe {
     display: none;
   }

   .threshold-banner.caution {
     background: rgba(250, 204, 21, 0.15);
     border: 1px solid rgba(250, 204, 21, 0.3);
     color: #fbbf24;
   }

   .threshold-banner.warning {
     background: rgba(251, 146, 60, 0.15);
     border: 1px solid rgba(251, 146, 60, 0.3);
     color: #f97316;
   }

   .threshold-banner.danger {
     background: rgba(239, 68, 68, 0.15);
     border: 1px solid rgba(239, 68, 68, 0.3);
     color: #ef4444;
   }

   .warning-count {
     margin-left: auto;
   }

   .warning-dismiss {
     background: none;
     border: none;
     font-size: 1.2rem;
     cursor: pointer;
     opacity: 0.7;
   }
   ```

5. Update warning banner on count changes:
   ```javascript
   function updateThresholdWarning(thresholdCount) {
     const banner = document.getElementById('thresholdWarningBanner');
     const level = getWarningLevel(thresholdCount);

     if (level === WARNING_LEVELS.SAFE) {
       banner.style.display = 'none';
       return;
     }

     banner.className = `threshold-banner ${level.class}`;
     banner.querySelector('.warning-icon').textContent = level.icon;
     banner.querySelector('.warning-message').textContent = level.message;
     document.getElementById('thresholdCount').textContent = thresholdCount;
     banner.style.display = 'flex';
   }
   ```
  </action>
  <verify>
Visual check at different thresholds:
- 169 days: No banner
- 170 days: Yellow caution banner
- 180 days: Orange warning banner
- 183+ days: Red danger banner
  </verify>
  <done>
Progressive warning banners appear at 170, 180, and 183+ day thresholds
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement Multi-Year Navigation</name>
  <files>autonomo_dashboard.html</files>
  <action>
Extend calendar to support 2026 (Feb-Dec) and 2027 (full year):

1. Update calendar state to track year and month independently:
   ```javascript
   // Replace startMonth/endMonth with year-aware tracking
   const CALENDAR_RANGE = {
     2026: { startMonth: 1, endMonth: 11 },  // Feb-Dec
     2027: { startMonth: 0, endMonth: 11 }   // Jan-Dec
   };
   ```

2. Modify calendarState structure:
   ```javascript
   calendarState = {
     version: 2,  // Increment for migration
     currentYear: 2026,
     currentMonth: 1,
     // ... other fields
   };
   ```

3. Update navigateMonth() to handle year boundaries:
   ```javascript
   function navigateMonth(delta) {
     let newMonth = calendarState.currentMonth + delta;
     let newYear = calendarState.currentYear;

     // Handle year rollover
     if (newMonth > 11) {
       newMonth = 0;
       newYear++;
     } else if (newMonth < 0) {
       newMonth = 11;
       newYear--;
     }

     // Check if new position is within allowed range
     const yearRange = CALENDAR_RANGE[newYear];
     if (!yearRange) return;  // Year not supported

     if (newMonth < yearRange.startMonth || newMonth > yearRange.endMonth) {
       return;  // Month not allowed for this year
     }

     calendarState.currentYear = newYear;
     calendarState.currentMonth = newMonth;
     saveCalendarState();
     renderCalendar();
     updateCountDisplays();
   }
   ```

4. Update navigation button disabled states:
   - Prev disabled if at Feb 2026
   - Next disabled if at Dec 2027

5. Add year display to calendar header:
   ```html
   <h3>${monthName} ${year}</h3>
   ```

6. Update annual count display to show per-year totals:
   ```html
   <div class="year-summary">
     <strong>${year} Summary:</strong>
     üáßüá™ ${belgium} | üá™üá∏ ${spain} | ‚úàÔ∏è ${travel}
     <span class="threshold-indicator">(${threshold}/183)</span>
   </div>
   ```

7. Add year quick-jump buttons:
   ```html
   <div class="year-nav">
     <button onclick="jumpToYear(2026)" class="${year===2026?'active':''}">2026</button>
     <button onclick="jumpToYear(2027)" class="${year===2027?'active':''}">2027</button>
   </div>
   ```
  </action>
  <verify>
Navigation test:
1. Navigate to December 2026
2. Click Next - should go to January 2027
3. Navigate to December 2027 - Next button disabled
4. Navigate to February 2026 - Prev button disabled
5. Click year buttons to jump between years
  </verify>
  <done>
Calendar supports navigation from Feb 2026 through Dec 2027 with year display
  </done>
</task>

</tasks>

<verification>
1. Count calculations match actual IndexedDB data
2. Warning banners appear at correct thresholds
3. Year navigation works correctly at boundaries
4. Per-year totals display accurately
5. No errors when switching years
</verification>

<success_criteria>
- 183-day tracking works with IndexedDB data
- Progressive warnings at 170/180/183 days
- Calendar supports 2026-2027 navigation
- Year summary shows per-year counts
</success_criteria>

<output>
After completion, create `.planning/phases/16-calendar-enhancement/16-04-SUMMARY.md`
</output>
