---
phase: 16-calendar-enhancement
plan: 06
type: execute
wave: 4
depends_on: ["16-04", "16-05"]
files_modified:
  - autonomo_dashboard.html
autonomous: true
user_setup:
  - service: google-cloud
    why: "Google Calendar sync requires OAuth client credentials"
    env_vars: []
    dashboard_config:
      - task: "Create OAuth 2.0 Client ID"
        location: "Google Cloud Console > APIs & Services > Credentials"
      - task: "Enable Calendar API"
        location: "Google Cloud Console > APIs & Services > Library"
      - task: "Add authorized JavaScript origins"
        location: "OAuth client settings (localhost:3013 for dev, production URL)"

must_haves:
  truths:
    - "User can authorize Google Calendar access via OAuth"
    - "User can sync calendar to Google Calendar"
    - "App calendar entries push to Google Calendar"
    - "External Google Calendar events shown as read-only"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "GCalSync module"
      contains: "const GCalSync"
    - path: "autonomo_dashboard.html"
      provides: "Sync UI"
      contains: "gcalSyncBtn"
  key_links:
    - from: "GCalSync.sync"
      to: "CalendarManager"
      via: "push local changes"
      pattern: "CalendarManager\\.getDays"
    - from: "GCalSync"
      to: "google.accounts.oauth2"
      via: "OAuth token client"
      pattern: "initTokenClient"
---

<objective>
Implement Google Calendar synchronization with OAuth authentication and bidirectional sync.

Purpose: Enable users to sync work calendar with Google Calendar for mobile access and team visibility
Output: GCalSync module with OAuth, push/pull sync, conflict handling per CALENDAR-16
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-calendar-enhancement/16-RESEARCH.md
@.planning/phases/16-calendar-enhancement/16-04-SUMMARY.md
@.planning/phases/16-calendar-enhancement/16-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Google Identity Services and API Client</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add Google OAuth and Calendar API client libraries:

1. Add script tags in head section (after other CDN scripts):
   ```html
   <!-- Google Identity Services for OAuth -->
   <script src="https://accounts.google.com/gsi/client" async defer></script>
   <!-- Google API Client for Calendar API -->
   <script src="https://apis.google.com/js/api.js" async defer></script>
   ```

2. Create GCAL_CONFIG constant (near other config constants):
   ```javascript
   // Google Calendar configuration
   // User must set CLIENT_ID from Google Cloud Console
   const GCAL_CONFIG = Object.freeze({
     CLIENT_ID: '', // Set via Settings or hardcode for development
     SCOPES: 'https://www.googleapis.com/auth/calendar.events',
     DISCOVERY_DOC: 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest',
     CALENDAR_ID: 'primary'  // User's primary calendar
   });
   ```

3. Add GCalSync state object:
   ```javascript
   const GCalSync = {
     tokenClient: null,
     accessToken: null,
     gapiInitialized: false,
     gisInitialized: false,
     isAuthorized: false,

     // Will be populated with methods in Task 2
   };
   ```

4. Create initialization functions:
   ```javascript
   // Initialize Google API client
   async function initGapi() {
     await new Promise((resolve, reject) => {
       gapi.load('client', { callback: resolve, onerror: reject });
     });

     await gapi.client.init({
       discoveryDocs: [GCAL_CONFIG.DISCOVERY_DOC]
     });

     GCalSync.gapiInitialized = true;
     maybeEnableSync();
   }

   // Initialize Google Identity Services
   function initGis() {
     if (!GCAL_CONFIG.CLIENT_ID) {
       console.log('GCal sync disabled: CLIENT_ID not configured');
       return;
     }

     GCalSync.tokenClient = google.accounts.oauth2.initTokenClient({
       client_id: GCAL_CONFIG.CLIENT_ID,
       scope: GCAL_CONFIG.SCOPES,
       callback: handleTokenResponse
     });

     GCalSync.gisInitialized = true;
     maybeEnableSync();
   }

   // Enable sync UI once both libraries loaded
   function maybeEnableSync() {
     if (GCalSync.gapiInitialized && GCalSync.gisInitialized) {
       document.getElementById('gcalConnectBtn')?.removeAttribute('disabled');
     }
   }

   // Handle OAuth token response
   function handleTokenResponse(response) {
     if (response.error) {
       console.error('OAuth error:', response.error);
       showNotification('Google Calendar authorization failed', 'error');
       return;
     }

     GCalSync.accessToken = response.access_token;
     GCalSync.isAuthorized = true;
     updateGCalUI();
     showNotification('Connected to Google Calendar', 'success');
   }
   ```

5. Call init functions after page load:
   ```javascript
   // Add to DOMContentLoaded handler
   if (typeof gapi !== 'undefined') {
     initGapi();
   }
   if (typeof google !== 'undefined' && google.accounts) {
     initGis();
   }
   ```
  </action>
  <verify>
Console check:
- No errors loading Google scripts
- `GCalSync.gapiInitialized` true after page load (if gapi loaded)
- `GCalSync.gisInitialized` true if CLIENT_ID is set
  </verify>
  <done>
Google Identity Services and API client loaded and initialized
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement GCalSync Push/Pull Operations</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add sync methods to GCalSync object:

1. Push local entries to Google Calendar:
   ```javascript
   GCalSync.pushToGCal = async function(day, clientName, projectName) {
     if (!this.isAuthorized) throw new Error('Not authorized');

     const locationText = {
       belgium: 'Belgium Work Day',
       spain: 'Spain',
       travel: 'Travel Day',
       other: 'Other'
     }[day.location];

     let summary = locationText;
     if (clientName) summary += ` - ${clientName}`;
     if (projectName) summary += ` (${projectName})`;

     const event = {
       summary,
       description: day.notes || '',
       start: { date: day.date },
       end: {
         date: (() => {
           const d = new Date(day.date);
           d.setDate(d.getDate() + 1);
           return toISODateKey(d);
         })()
       }
     };

     // Check if event already exists (update vs create)
     if (day.gcal_event_id) {
       // Update existing event
       await gapi.client.calendar.events.update({
         calendarId: GCAL_CONFIG.CALENDAR_ID,
         eventId: day.gcal_event_id,
         resource: event
       });
     } else {
       // Create new event
       const response = await gapi.client.calendar.events.insert({
         calendarId: GCAL_CONFIG.CALENDAR_ID,
         resource: event
       });

       // Store event ID for future updates
       await db.calendar_days.update(day.id, {
         gcal_event_id: response.result.id,
         gcal_sync_status: 'synced'
       });
     }
   };
   ```

2. Pull events from Google Calendar:
   ```javascript
   GCalSync.pullFromGCal = async function(startDate, endDate) {
     if (!this.isAuthorized) throw new Error('Not authorized');

     const response = await gapi.client.calendar.events.list({
       calendarId: GCAL_CONFIG.CALENDAR_ID,
       timeMin: `${startDate}T00:00:00Z`,
       timeMax: `${endDate}T23:59:59Z`,
       singleEvents: true,
       orderBy: 'startTime'
     });

     return response.result.items || [];
   };
   ```

3. Main sync function:
   ```javascript
   GCalSync.sync = async function() {
     if (!this.isAuthorized) {
       this.authorize();
       return;
     }

     const year = calendarState.currentYear;
     const startDate = `${year}-01-01`;
     const endDate = `${year}-12-31`;

     // Get local days
     const localDays = await CalendarManager.getDaysForYear(year);

     // Get client/project lookups
     const clients = await ClientManager.getClients();
     const clientMap = new Map(clients.map(c => [c.id, c.name]));

     const projects = await db.projects
       .where('entity_id').equals(EntityContext.entityId)
       .toArray();
     const projectMap = new Map(projects.map(p => [p.id, p.name]));

     // Push local changes to GCal
     let pushed = 0;
     for (const day of localDays) {
       if (!day.location || day.location === 'unset') continue;

       try {
         const clientName = day.client_id ? clientMap.get(day.client_id) : null;
         const projectName = day.project_id ? projectMap.get(day.project_id) : null;
         await this.pushToGCal(day, clientName, projectName);
         pushed++;
       } catch (e) {
         console.warn(`Failed to sync day ${day.date}:`, e);
       }
     }

     // Pull GCal events (read-only suggestions)
     const gcalEvents = await this.pullFromGCal(startDate, endDate);

     // Store external events for display (don't overwrite local data)
     // Per CALENDAR-16: external events shown as read-only suggestions
     const externalEvents = gcalEvents.filter(e => !e.id?.startsWith('autonomo-'));

     showNotification(`Synced ${pushed} days to Google Calendar`, 'success');
     return { pushed, pulled: externalEvents.length };
   };
   ```

4. Authorization method:
   ```javascript
   GCalSync.authorize = function() {
     if (!this.tokenClient) {
       showNotification('Google Calendar not configured', 'error');
       return;
     }

     // Request access token (prompts user consent)
     this.tokenClient.requestAccessToken();
   };

   GCalSync.revoke = function() {
     if (this.accessToken) {
       google.accounts.oauth2.revoke(this.accessToken, () => {
         this.accessToken = null;
         this.isAuthorized = false;
         updateGCalUI();
         showNotification('Disconnected from Google Calendar', 'info');
       });
     }
   };
   ```
  </action>
  <verify>
Console test (requires CLIENT_ID):
- `GCalSync.authorize()` - opens Google consent screen
- After authorization, `GCalSync.isAuthorized` is true
- `await GCalSync.sync()` - syncs without errors
  </verify>
  <done>
GCalSync push/pull operations working with Google Calendar API
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Google Calendar Sync UI</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add UI for Google Calendar connection and sync:

1. Add GCal section to calendar toolbar:
   ```html
   <div class="gcal-section">
     <div id="gcalNotConfigured" style="display: none;">
       <span class="text-muted">Google Calendar sync requires configuration</span>
     </div>

     <div id="gcalDisconnected">
       <button type="button" id="gcalConnectBtn" class="btn btn-secondary" onclick="GCalSync.authorize()" disabled>
         ðŸ”— Connect Google Calendar
       </button>
     </div>

     <div id="gcalConnected" style="display: none;">
       <span class="gcal-status">âœ“ Connected to Google Calendar</span>
       <button type="button" class="btn btn-primary" onclick="syncToGCal()">
         ðŸ”„ Sync Now
       </button>
       <button type="button" class="btn btn-secondary btn-sm" onclick="GCalSync.revoke()">
         Disconnect
       </button>
     </div>
   </div>
   ```

2. Create updateGCalUI function:
   ```javascript
   function updateGCalUI() {
     const notConfigured = document.getElementById('gcalNotConfigured');
     const disconnected = document.getElementById('gcalDisconnected');
     const connected = document.getElementById('gcalConnected');

     if (!GCAL_CONFIG.CLIENT_ID) {
       notConfigured.style.display = 'block';
       disconnected.style.display = 'none';
       connected.style.display = 'none';
       return;
     }

     notConfigured.style.display = 'none';

     if (GCalSync.isAuthorized) {
       disconnected.style.display = 'none';
       connected.style.display = 'flex';
     } else {
       disconnected.style.display = 'block';
       connected.style.display = 'none';
     }
   }
   ```

3. Create sync handler with progress indicator:
   ```javascript
   async function syncToGCal() {
     const syncBtn = document.querySelector('#gcalConnected .btn-primary');
     const originalText = syncBtn.textContent;

     try {
       syncBtn.textContent = 'â³ Syncing...';
       syncBtn.disabled = true;

       const result = await GCalSync.sync();

       syncBtn.textContent = 'âœ“ Synced!';
       setTimeout(() => {
         syncBtn.textContent = originalText;
         syncBtn.disabled = false;
       }, 2000);

     } catch (e) {
       console.error('Sync failed:', e);
       showNotification('Sync failed: ' + e.message, 'error');
       syncBtn.textContent = originalText;
       syncBtn.disabled = false;
     }
   }
   ```

4. Add CSS for GCal section:
   ```css
   .gcal-section {
     display: flex;
     align-items: center;
     gap: 0.75rem;
     padding: 0.5rem 0;
     border-top: 1px solid var(--border-color);
     margin-top: 0.5rem;
   }

   .gcal-status {
     color: var(--success-color);
     font-size: 0.85rem;
   }

   #gcalConnected {
     display: flex;
     align-items: center;
     gap: 0.5rem;
   }
   ```

5. Add configuration hint in Settings (placeholder for Phase 29):
   ```javascript
   // Note: Full settings UI in Phase 29
   // For now, document that CLIENT_ID must be set in code
   ```

6. Call updateGCalUI on page load and after auth state changes
  </action>
  <verify>
UI test:
1. With no CLIENT_ID: Shows "requires configuration" message
2. With CLIENT_ID but not connected: Shows "Connect" button
3. After connecting: Shows "Sync Now" button and "Connected" status
4. Click Sync: Shows progress, then success
  </verify>
  <done>
Google Calendar sync UI with connect/disconnect/sync buttons
  </done>
</task>

</tasks>

<verification>
1. Google OAuth flow works (requires CLIENT_ID setup)
2. Local calendar events push to Google Calendar
3. Sync button shows progress and result
4. Disconnect revokes access
5. UI shows correct state (not configured / disconnected / connected)
</verification>

<success_criteria>
- OAuth authorization flow complete
- Push sync creates/updates GCal events
- UI reflects connection state
- Error handling with user feedback
- Per CALENDAR-16: app calendar wins, external events read-only
</success_criteria>

<output>
After completion, create `.planning/phases/16-calendar-enhancement/16-06-SUMMARY.md`
</output>
