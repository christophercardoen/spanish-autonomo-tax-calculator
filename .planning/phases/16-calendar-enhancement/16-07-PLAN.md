---
phase: 16-calendar-enhancement
plan: 07
type: execute
wave: 5
depends_on: ["16-04", "16-05", "16-06"]
files_modified:
  - autonomo_dashboard.html
autonomous: false

must_haves:
  truths:
    - "All CALENDAR-01 through CALENDAR-16 requirements verified"
    - "Calendar renders correctly with client tags and location icons"
    - "183-day warnings display at correct thresholds"
    - "Work patterns apply without overwriting manual edits"
    - "Export to ICS/CSV produces valid files"
  artifacts: []
  key_links: []
---

<objective>
Verify all Phase 16 requirements are met through comprehensive testing and user acceptance.

Purpose: Ensure calendar enhancement features work correctly before moving to Phase 17
Output: Verification report and any final bug fixes
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-calendar-enhancement/16-RESEARCH.md
@.planning/phases/16-calendar-enhancement/16-04-SUMMARY.md
@.planning/phases/16-calendar-enhancement/16-05-SUMMARY.md
@.planning/phases/16-calendar-enhancement/16-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run Automated Verification Checks</name>
  <files>autonomo_dashboard.html</files>
  <action>
Create and run verification script in browser console:

```javascript
async function verifyPhase16() {
  const results = [];
  const pass = (name) => results.push({ name, status: 'PASS' });
  const fail = (name, reason) => results.push({ name, status: 'FAIL', reason });

  // CALENDAR-01: Month grid calendar
  try {
    const grid = document.querySelector('.calendar-grid-with-weeks');
    if (grid && grid.children.length > 0) pass('CALENDAR-01: Month grid exists');
    else fail('CALENDAR-01', 'Calendar grid not found');
  } catch (e) { fail('CALENDAR-01', e.message); }

  // CALENDAR-02: Day editor modal
  try {
    const modal = document.getElementById('dayEditorModal');
    if (modal) pass('CALENDAR-02: Day editor modal exists');
    else fail('CALENDAR-02', 'Day editor modal not found');
  } catch (e) { fail('CALENDAR-02', e.message); }

  // CALENDAR-03: Day editor fields
  try {
    const location = document.querySelector('[name="dayLocation"]');
    const client = document.getElementById('dayEditorClient');
    const project = document.getElementById('dayEditorProject');
    const notes = document.getElementById('dayEditorNotes');
    if (location && client && project && notes) pass('CALENDAR-03: Day editor fields exist');
    else fail('CALENDAR-03', 'Missing day editor fields');
  } catch (e) { fail('CALENDAR-03', e.message); }

  // CALENDAR-04: 183-day tracking
  try {
    if (typeof calculateThresholdCounts === 'function') {
      const counts = await calculateThresholdCounts(2026);
      if (counts.annual && typeof counts.annual.threshold === 'number') {
        pass('CALENDAR-04: 183-day tracking works');
      } else fail('CALENDAR-04', 'Threshold calculation failed');
    } else fail('CALENDAR-04', 'calculateThresholdCounts not found');
  } catch (e) { fail('CALENDAR-04', e.message); }

  // CALENDAR-05: Work pattern on project
  try {
    if (typeof WorkPatternManager !== 'undefined' && WorkPatternManager.savePatternToProject) {
      pass('CALENDAR-05: WorkPatternManager exists');
    } else fail('CALENDAR-05', 'WorkPatternManager not found');
  } catch (e) { fail('CALENDAR-05', e.message); }

  // CALENDAR-06: Pattern auto-apply
  try {
    if (WorkPatternManager.applyPattern) {
      pass('CALENDAR-06: applyPattern function exists');
    } else fail('CALENDAR-06', 'applyPattern not found');
  } catch (e) { fail('CALENDAR-06', e.message); }

  // CALENDAR-07: Bulk selection
  try {
    const weekSelector = document.querySelector('.week-selector');
    const monthSelectAll = document.querySelector('.month-select-all');
    if (weekSelector || monthSelectAll) pass('CALENDAR-07: Bulk selection exists');
    else fail('CALENDAR-07', 'Bulk selection controls not found');
  } catch (e) { fail('CALENDAR-07', e.message); }

  // CALENDAR-08: Monthly counts
  try {
    const counts = await calculateThresholdCounts(2026);
    if (counts.monthly && Object.keys(counts.monthly).length === 12) {
      pass('CALENDAR-08: Monthly counts calculated');
    } else fail('CALENDAR-08', 'Monthly counts incomplete');
  } catch (e) { fail('CALENDAR-08', e.message); }

  // CALENDAR-09: Annual totals
  try {
    const counts = await calculateThresholdCounts(2026);
    if (typeof counts.annual.belgium === 'number') {
      pass('CALENDAR-09: Annual totals calculated');
    } else fail('CALENDAR-09', 'Annual totals missing');
  } catch (e) { fail('CALENDAR-09', e.message); }

  // CALENDAR-10: Warning levels
  try {
    if (typeof WARNING_LEVELS !== 'undefined' &&
        WARNING_LEVELS.CAUTION.threshold === 170 &&
        WARNING_LEVELS.WARNING.threshold === 180 &&
        WARNING_LEVELS.DANGER.threshold === 183) {
      pass('CALENDAR-10: Warning levels correct');
    } else fail('CALENDAR-10', 'Warning level thresholds incorrect');
  } catch (e) { fail('CALENDAR-10', e.message); }

  // CALENDAR-11: Expense linking infrastructure
  try {
    if (CalendarManager.getLinkedExpenseCount) {
      const count = await CalendarManager.getLinkedExpenseCount('2026-02-15');
      pass('CALENDAR-11: Expense linking infrastructure ready');
    } else fail('CALENDAR-11', 'getLinkedExpenseCount not found');
  } catch (e) { fail('CALENDAR-11', e.message); }

  // CALENDAR-12: Day shows client tag and location
  // (Visual check required - automated check for structure only)
  try {
    const dayCell = document.querySelector('.day-cell[data-date]');
    if (dayCell) pass('CALENDAR-12: Day cells have data-date attribute');
    else fail('CALENDAR-12', 'Day cells missing data-date');
  } catch (e) { fail('CALENDAR-12', e.message); }

  // CALENDAR-13: ICS export
  try {
    if (typeof generateEnhancedICS === 'function') {
      pass('CALENDAR-13: ICS export function exists');
    } else fail('CALENDAR-13', 'generateEnhancedICS not found');
  } catch (e) { fail('CALENDAR-13', e.message); }

  // CALENDAR-14: CSV export
  try {
    if (typeof generateCSV === 'function') {
      pass('CALENDAR-14: CSV export function exists');
    } else fail('CALENDAR-14', 'generateCSV not found');
  } catch (e) { fail('CALENDAR-14', e.message); }

  // CALENDAR-15: Google Calendar sync
  try {
    if (typeof GCalSync !== 'undefined' && GCalSync.sync) {
      pass('CALENDAR-15: GCalSync module exists');
    } else fail('CALENDAR-15', 'GCalSync not found');
  } catch (e) { fail('CALENDAR-15', e.message); }

  // CALENDAR-16: Conflict resolution (app wins)
  try {
    if (GCalSync && typeof GCalSync.pushToGCal === 'function') {
      pass('CALENDAR-16: Push sync (app wins) exists');
    } else fail('CALENDAR-16', 'Push sync not found');
  } catch (e) { fail('CALENDAR-16', e.message); }

  // Summary
  const passed = results.filter(r => r.status === 'PASS').length;
  const failed = results.filter(r => r.status === 'FAIL').length;

  console.table(results);
  console.log(`\nPhase 16 Verification: ${passed}/${results.length} passed`);

  return { results, passed, failed };
}

// Run it
verifyPhase16();
```

Document any failures and fix them.
  </action>
  <verify>
Console output shows all 16 requirements passing
  </verify>
  <done>
Automated verification passes for all CALENDAR requirements
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 16 Calendar Enhancement with:
- CalendarManager IndexedDB CRUD operations
- Day editor modal with client/project/location tagging
- Work pattern system with project storage and calendar application
- 183-day threshold warnings at 170/180/183 levels
- Multi-year navigation (2026-2027)
- Enhanced ICS export with client information
- CSV export for spreadsheet analysis
- Google Calendar sync infrastructure (requires CLIENT_ID configuration)
  </what-built>
  <how-to-verify>
1. **Calendar Rendering (CALENDAR-01)**
   - Navigate to Calendario tab
   - Verify month grid displays with day cells
   - Navigate between months using Prev/Next buttons
   - Verify year displays in header

2. **Day Editor (CALENDAR-02, CALENDAR-03)**
   - Click any calendar day
   - Verify modal opens with date in title
   - Select location (Belgium radio)
   - Select a client from dropdown
   - Select a project from dropdown
   - Enter notes
   - Click Save
   - Verify calendar cell shows location emoji and client abbreviation

3. **Work Patterns (CALENDAR-05, CALENDAR-06)**
   - Edit a project with active work pattern
   - Verify pattern fields (Mon-Tue checkboxes, location)
   - Click "Apply Pattern" button on calendar
   - Select client and project
   - Set date range
   - Apply pattern
   - Verify days are tagged (but existing entries preserved)

4. **183-Day Tracking (CALENDAR-04, CALENDAR-09, CALENDAR-10)**
   - Tag several days as Belgium
   - Watch annual count update
   - If threshold > 170, verify yellow warning banner
   - If threshold > 180, verify orange warning
   - If threshold > 183, verify red danger banner

5. **Multi-Year (CALENDAR-08)**
   - Navigate to December 2026
   - Click Next - should go to January 2027
   - Navigate to December 2027 - Next should be disabled
   - Use year buttons to jump between years

6. **Export (CALENDAR-13, CALENDAR-14)**
   - Click Export ICS - download .ics file
   - Open in text editor, verify events have client/project info
   - Click Export CSV - download .csv file
   - Open in Excel/Sheets, verify columns and data

7. **Google Calendar (CALENDAR-15, CALENDAR-16)**
   - If CLIENT_ID configured: Click Connect, authorize
   - Click Sync Now, verify success message
   - Check Google Calendar for created events
   - If not configured: Verify "requires configuration" message
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 16, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Automated verification script passes all 16 checks
2. Human visual verification confirms UI behavior
3. No console errors during normal operation
4. Export files valid and complete
</verification>

<success_criteria>
All Phase 16 requirements verified:
- CALENDAR-01 through CALENDAR-16 passing
- No regressions in existing calendar functionality
- Migration from v1 localStorage complete
- Ready for Phase 17 expense linking
</success_criteria>

<output>
After completion, create `.planning/phases/16-calendar-enhancement/16-07-SUMMARY.md`
</output>
