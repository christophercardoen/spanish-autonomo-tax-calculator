---
phase: 16-calendar-enhancement
plan: 03
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "User can assign a work pattern template to a project"
    - "User can apply work pattern to calendar for a date range"
    - "Pattern application respects existing manual edits (only fills empty days)"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "WorkPatternManager module"
      contains: "const WorkPatternManager"
    - path: "autonomo_dashboard.html"
      provides: "Work pattern form fields"
      contains: "projectWorkPattern"
  key_links:
    - from: "WorkPatternManager.applyPattern"
      to: "CalendarManager.saveDay"
      via: "bulk day creation"
      pattern: "CalendarManager\\.saveDay"
---

<objective>
Create work pattern system that allows users to define recurring schedules on projects and auto-apply them to the calendar.

Purpose: Automate repetitive calendar tagging for clients with fixed work schedules (e.g., Mon-Tue every week)
Output: WorkPatternManager module, pattern form fields on project edit, apply-pattern button on calendar
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-calendar-enhancement/16-RESEARCH.md
@.planning/phases/16-calendar-enhancement/16-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement WorkPatternManager Module</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add WorkPatternManager module after CalendarManager:

1. Define WORK_PATTERN_TYPE constants:
   ```javascript
   const WORK_PATTERN_TYPE = Object.freeze({
     WEEKLY: 'weekly',       // Same days every week
     FIRST_WEEK: 'first_week', // Extra days in first week of month
     CUSTOM: 'custom'        // User-defined pattern
   });
   ```

2. Define default pattern structure:
   ```javascript
   const DEFAULT_WORK_PATTERN = {
     type: 'weekly',
     days: [],              // Array of day numbers (1=Mon, 2=Tue, ..., 7=Sun)
     first_week_extra: [],  // Extra days for first week of month
     location: 'belgium',   // Default location for pattern days
     active: false          // Must be explicitly activated
   };
   ```

3. WorkPatternManager object with methods:

   a. validatePattern(pattern):
      - Ensure days array contains valid numbers 1-7
      - Ensure location is valid LOCATION_TYPE
      - Return { valid: boolean, errors: string[] }

   b. savePatternToProject(projectId, pattern) async:
      - Validate pattern
      - Get project via ProjectManager.getProjectById(projectId)
      - Update project record with work_pattern field
      - Use db.projects.update()

   c. getPatternFromProject(projectId) async:
      - Get project record
      - Return project.work_pattern or null

   d. applyPattern(projectId, startDate, endDate) async:
      - Get project and its pattern
      - Validate date range
      - Iterate each day in range
      - For each day matching pattern criteria:
        - Check if day already has data (CalendarManager.getDay)
        - SKIP if day has location set (respect manual edits)
        - Create new record with pattern's location, project.client_id, projectId
      - Return { applied: number, skipped: number }

   e. previewPattern(pattern, startDate, endDate):
      - Return array of ISO date keys that would be filled
      - Does NOT check existing data (for preview only)

4. Pattern matching logic:
   ```javascript
   function matchesPattern(date, pattern) {
     const dayOfWeek = date.getDay();
     // Convert JS day (0=Sun) to ISO day (1=Mon, 7=Sun)
     const isoDay = dayOfWeek === 0 ? 7 : dayOfWeek;

     // Check regular weekly days
     if (pattern.days.includes(isoDay)) return true;

     // Check first-week extra days
     if (date.getDate() <= 7 && pattern.first_week_extra?.includes(isoDay)) {
       return true;
     }

     return false;
   }
   ```
  </action>
  <verify>
Console test:
- `WorkPatternManager.validatePattern({type:'weekly', days:[1,2], location:'belgium'})` - returns {valid:true}
- `WorkPatternManager.previewPattern({days:[1,2]}, '2026-02-01', '2026-02-28')` - returns array of Monday/Tuesday dates
  </verify>
  <done>
WorkPatternManager module provides pattern validation, storage, and application logic
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Work Pattern Fields to Project Form</name>
  <files>autonomo_dashboard.html</files>
  <action>
Extend the project form (from Phase 15) to include work pattern configuration:

1. Locate project form/modal (search for project form elements)

2. Add work pattern section after rate fields:
   ```html
   <fieldset class="form-fieldset">
     <legend>Work Pattern</legend>

     <div class="form-group">
       <label>
         <input type="checkbox" id="projectPatternActive" />
         Enable recurring work pattern
       </label>
     </div>

     <div id="projectPatternFields" style="display: none;">
       <div class="form-group">
         <label>Work Days (select all that apply)</label>
         <div class="day-checkbox-group">
           <label><input type="checkbox" name="patternDay" value="1" /> Mon</label>
           <label><input type="checkbox" name="patternDay" value="2" /> Tue</label>
           <label><input type="checkbox" name="patternDay" value="3" /> Wed</label>
           <label><input type="checkbox" name="patternDay" value="4" /> Thu</label>
           <label><input type="checkbox" name="patternDay" value="5" /> Fri</label>
           <label><input type="checkbox" name="patternDay" value="6" /> Sat</label>
           <label><input type="checkbox" name="patternDay" value="7" /> Sun</label>
         </div>
       </div>

       <div class="form-group">
         <label>Extra days in first week of month</label>
         <div class="day-checkbox-group">
           <label><input type="checkbox" name="patternFirstWeek" value="3" /> Wed</label>
           <label><input type="checkbox" name="patternFirstWeek" value="4" /> Thu</label>
           <label><input type="checkbox" name="patternFirstWeek" value="5" /> Fri</label>
         </div>
         <small class="form-hint">For patterns like "Mon-Tue + first week Wed-Fri"</small>
       </div>

       <div class="form-group">
         <label for="projectPatternLocation">Default Location</label>
         <select id="projectPatternLocation">
           <option value="belgium">üáßüá™ Belgium</option>
           <option value="spain">üá™üá∏ Spain</option>
           <option value="travel">‚úàÔ∏è Travel</option>
           <option value="other">üìç Other</option>
         </select>
       </div>
     </div>
   </fieldset>
   ```

3. Add JavaScript to toggle pattern fields visibility:
   ```javascript
   document.getElementById('projectPatternActive').addEventListener('change', function() {
     document.getElementById('projectPatternFields').style.display = this.checked ? 'block' : 'none';
   });
   ```

4. Modify project save function to include work_pattern:
   - Collect checked days from patternDay checkboxes
   - Collect first_week_extra from patternFirstWeek checkboxes
   - Get location from dropdown
   - Build pattern object and include in project data

5. Modify project load function to populate pattern fields:
   - If project.work_pattern exists, check active checkbox
   - Show pattern fields if active
   - Check appropriate day checkboxes
   - Select correct location

6. Add CSS for checkbox grid:
   ```css
   .day-checkbox-group {
     display: flex;
     flex-wrap: wrap;
     gap: 0.5rem;
   }

   .day-checkbox-group label {
     display: flex;
     align-items: center;
     gap: 0.25rem;
     padding: 0.25rem 0.5rem;
     background: var(--card-bg);
     border: 1px solid var(--border-color);
     border-radius: 4px;
     cursor: pointer;
   }
   ```
  </action>
  <verify>
Test flow:
1. Create/edit project
2. Check "Enable recurring work pattern"
3. Select Mon, Tue, and Wed-Fri for first week
4. Save project
5. Edit project again - pattern settings retained
  </verify>
  <done>
Project form includes work pattern configuration that persists with project
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Apply Pattern Button to Calendar</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add UI to apply work patterns from calendar view:

1. Add "Apply Pattern" button to calendar toolbar (near existing buttons):
   ```html
   <button type="button" class="btn btn-secondary" onclick="openApplyPatternModal()">
     üìÖ Apply Pattern
   </button>
   ```

2. Create Apply Pattern Modal:
   ```html
   <div id="applyPatternModal" class="modal" style="display: none;">
     <div class="modal-content" style="max-width: 450px;">
       <div class="modal-header">
         <h3>Apply Work Pattern</h3>
         <button type="button" class="modal-close" onclick="closeApplyPatternModal()">&times;</button>
       </div>
       <form id="applyPatternForm" onsubmit="executeApplyPattern(event)">
         <div class="form-group">
           <label for="applyPatternClient">Client</label>
           <select id="applyPatternClient" required onchange="loadClientProjects()">
             <option value="">-- Select client --</option>
           </select>
         </div>

         <div class="form-group">
           <label for="applyPatternProject">Project (with pattern)</label>
           <select id="applyPatternProject" required disabled>
             <option value="">-- Select client first --</option>
           </select>
         </div>

         <div class="form-group">
           <label for="applyPatternStart">Start Date</label>
           <input type="date" id="applyPatternStart" required />
         </div>

         <div class="form-group">
           <label for="applyPatternEnd">End Date</label>
           <input type="date" id="applyPatternEnd" required />
         </div>

         <div id="applyPatternPreview" class="pattern-preview">
           <!-- Filled dynamically -->
         </div>

         <div class="modal-actions">
           <button type="button" class="btn btn-secondary" onclick="closeApplyPatternModal()">Cancel</button>
           <button type="submit" class="btn btn-primary">Apply Pattern</button>
         </div>
       </form>
     </div>
   </div>
   ```

3. Implement JavaScript functions:

   a. openApplyPatternModal():
      - Populate client dropdown with ClientManager.getClients()
      - Filter to only clients with projects that have patterns
      - Set default dates: start = first of current month, end = last of current month
      - Show modal

   b. loadClientProjects():
      - Get selected client_id
      - Fetch projects via ProjectManager.getProjectsByClient(clientId)
      - Filter to projects with work_pattern.active === true
      - Populate project dropdown
      - If only one project, auto-select it

   c. previewApplyPattern():
      - Called on project select and date change
      - Get project's pattern
      - Call WorkPatternManager.previewPattern()
      - Display preview: "{N} days will be tagged"
      - List dates or show "No matching days in range"

   d. executeApplyPattern(event):
      - event.preventDefault()
      - Get project, start date, end date
      - Call WorkPatternManager.applyPattern()
      - Show result: "Applied to {N} days, skipped {M} existing entries"
      - Close modal
      - Re-render calendar

4. Add event listeners for live preview:
   ```javascript
   document.getElementById('applyPatternProject').addEventListener('change', previewApplyPattern);
   document.getElementById('applyPatternStart').addEventListener('change', previewApplyPattern);
   document.getElementById('applyPatternEnd').addEventListener('change', previewApplyPattern);
   ```
  </action>
  <verify>
Test flow:
1. Create project with Mon-Tue pattern for client
2. Click "Apply Pattern" on calendar
3. Select client and project
4. Set date range (Feb 1 - Feb 28)
5. See preview showing expected days
6. Apply - calendar shows tagged days
7. Apply again - shows "skipped N existing entries"
  </verify>
  <done>
Apply Pattern modal allows bulk-tagging calendar days from project work patterns
  </done>
</task>

</tasks>

<verification>
1. WorkPatternManager validates and applies patterns correctly
2. Project form captures and persists work pattern settings
3. Apply Pattern modal shows preview before applying
4. Manual edits are preserved when applying patterns
5. Calendar updates to show newly tagged days
</verification>

<success_criteria>
- Work patterns can be defined on projects
- Patterns can be applied to arbitrary date ranges
- Existing manual entries are never overwritten
- Preview shows exactly what will be tagged
</success_criteria>

<output>
After completion, create `.planning/phases/16-calendar-enhancement/16-03-SUMMARY.md`
</output>
