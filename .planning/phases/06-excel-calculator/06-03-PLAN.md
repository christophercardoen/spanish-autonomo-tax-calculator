---
phase: 06-excel-calculator
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - scripts/generate-excel.js
autonomous: false

must_haves:
  truths:
    - "Overview sheet shows summary section with all scenarios"
    - "Comparison table pulls values from scenario sheets via cross-sheet formulas"
    - "Hyperlinks navigate to individual scenario sheets"
    - "Workbook opens in Excel without any errors"
  artifacts:
    - path: "scripts/generate-excel.js"
      provides: "Complete Excel generator"
      contains: "createOverviewSheet"
    - path: "autonomo_calculator.xlsx"
      provides: "Final workbook"
  key_links:
    - from: "Overview sheet"
      to: "Scenario sheets"
      via: "Cross-sheet formula references"
      pattern: "'Scenario.*'!B"
---

<objective>
Create Overview sheet with summary section and comparison table, add hyperlink navigation, and finalize workbook for delivery.

Purpose: Overview provides at-a-glance comparison of all scenarios and easy navigation. Final verification ensures workbook is error-free and professional.
Output: Complete autonomo_calculator.xlsx with Overview sheet, comparison table, hyperlinks, and professional print layout.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-excel-calculator/06-RESEARCH.md
@.planning/phases/06-excel-calculator/06-CONTEXT.md
@.planning/phases/06-excel-calculator/06-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Overview sheet with summary and comparison table</name>
  <files>scripts/generate-excel.js</files>
  <action>
    Add createOverviewSheet(workbook, scenarios) function to generate-excel.js.

    **Section 1: HEADER (rows 1-3)**
    - Row 1: "Spanish Autonomo Tax Calculator" - bold, size 18
    - Row 2: "Fiscal Year 2025/2026" - size 12
    - Row 3: Empty

    **Section 2: NAVIGATION (rows 4-10)**
    - Row 4: "Quick Navigation" - bold, size 14
    - Rows 5-9: Hyperlinks to each scenario sheet
      - Format: cell text = "Scenario A - 3K", hyperlink = "#'Scenario A - 3K'!A1"
      - Blue color, underline
    - Row 10: Hyperlink to "Constants" sheet

    **Section 3: COMPARISON TABLE (rows 12-30)**
    - Row 12: "Scenario Comparison" - bold, size 14
    - Row 13: Column headers: Metric | A | B | C | D | E
    - Apply header styling: bold, light gray background (FFD0D0D0)

    Comparison rows with cross-sheet formulas:
    - Row 14: Monthly Revenue = ='Scenario A - 3K'!B3, etc.
    - Row 15: Monthly Expenses = ='Scenario A - 3K'!B4
    - Row 16: Belgium Pattern = ='Scenario A - 3K'!B5
    - Row 17: (empty row for visual separation)
    - Row 18: Annual Revenue = ='Scenario A - 3K'!B8
    - Row 19: Total Deductible = ='Scenario A - 3K'!B13
    - Row 20: Base Liquidable = ='Scenario A - 3K'!B18
    - Row 21: (empty row)
    - Row 22: Annual IRPF = ='Scenario A - 3K'!B41
    - Row 23: Monthly IRPF = ='Scenario A - 3K'!B42
    - Row 24: Effective Tax Rate = ='Scenario A - 3K'!B47
    - Row 25: (empty row)
    - Row 26: Annual Net Income = ='Scenario A - 3K'!B43
    - Row 27: Monthly Net Income = ='Scenario A - 3K'!B44
    - Row 28: Annual Leefgeld = ='Scenario A - 3K'!B45
    - Row 29: Monthly Leefgeld = ='Scenario A - 3K'!B46

    For each row, create formulas for columns B-F referencing scenarios A-E.
    Use single quotes around sheet names with spaces: ='Scenario A - 3K'!B3

    **Styling:**
    - Metric column (A): width 25, left-aligned
    - Scenario columns (B-F): width 15, right-aligned, centered headers
    - Currency cells: '"EUR "#,##0.00'
    - Percentage cells: '0.0%'
    - Alternating row colors: white/light gray for readability

    **Conditional Formatting:**
    - Leefgeld rows (28, 29): Red if negative, Orange if 0-500, Green if >=500
    - Apply to range B28:F29

    **Freeze panes:**
    - Freeze row 13 (header row) so it stays visible when scrolling

    Update main() to:
    1. Create Constants sheet
    2. Create Overview sheet FIRST (so it's the leftmost tab after Constants)
    3. Create scenario sheets

    Reorder: Constants should be last tab (reference), Overview first tab.
    Actually, better order: Overview, Scenario A-E, Constants (Overview as default view).
  </action>
  <verify>
    Run `node scripts/generate-excel.js` - no errors.
    Open in Excel - Overview tab should be first visible tab.
    Comparison table shows values pulled from scenario sheets.
    Click hyperlink "Scenario A - 3K" - navigates to that sheet.
    Change value in Scenario B - Overview comparison updates.
  </verify>
  <done>
    Overview sheet created with navigation and comparison table.
    All cross-sheet formulas work correctly.
    Hyperlinks navigate to correct sheets.
    Conditional formatting applied to key metrics.
    Tab order: Overview, Scenario A-E, Constants.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add print layout and final polish</name>
  <files>scripts/generate-excel.js</files>
  <action>
    Add print-ready settings to all sheets:

    **Overview sheet:**
    - Print area: A1:F30
    - Page orientation: Landscape
    - Fit to 1 page wide, auto height
    - Header: "Spanish Autonomo Tax Calculator - Overview"
    - Footer: "Page &P of &N | Generated: &D"
    - Margins: Normal (0.75 inch)

    **Scenario sheets:**
    - Print area: A1:E50 (or appropriate range)
    - Page orientation: Portrait
    - Fit to 1 page wide
    - Header: "Scenario {id} - {label} | Spanish Autonomo Tax Calculator"
    - Footer: "Page &P | Generated: &D"

    **Constants sheet:**
    - Print area: A1:D25
    - Page orientation: Portrait
    - Header: "Fiscal Constants 2025/2026"

    **Final touches:**
    - Add worksheet.protect() to Constants sheet (prevent accidental edits)
    - Allow editing of specific cells on scenario sheets (inputs only)
    - Add "Generated by autonomo_calculator" comment in A1 of each sheet

    Note: ExcelJS pageSetup API:
    ```javascript
    sheet.pageSetup = {
      orientation: 'landscape',
      fitToPage: true,
      fitToWidth: 1,
      fitToHeight: 0,
      printArea: 'A1:F30'
    };
    sheet.headerFooter = {
      oddHeader: '&C&"Arial,Bold"Spanish Autonomo Tax Calculator',
      oddFooter: '&LPage &P of &N&R&D'
    };
    ```

    Run final generation and verify file integrity.
  </action>
  <verify>
    Run `node scripts/generate-excel.js` - no errors.
    Open in Excel and go to Print Preview for Overview - should show landscape, 1 page.
    Check Page Setup dialog - print area and headers/footers set.
    Try editing Constants sheet - should be protected (warning dialog).
    File size reasonable (<1MB for this workbook).
  </verify>
  <done>
    Print layouts configured for all sheets.
    Constants sheet protected from accidental edits.
    Headers and footers present for professional printing.
    Workbook is production-ready.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Excel workbook (autonomo_calculator.xlsx) with:
    - Overview sheet with comparison table and navigation
    - 5 scenario sheets (A-E) with full IRPF calculation breakdown
    - Constants sheet with named ranges for fiscal data
    - Professional styling, conditional formatting, print layouts
  </what-built>
  <how-to-verify>
    1. Open autonomo_calculator.xlsx in Excel (not Google Sheets or preview)
    2. Verify Overview tab is first visible sheet
    3. Check comparison table shows values for all 5 scenarios
    4. Click "Scenario C - 9K" hyperlink - should navigate to that sheet
    5. On Scenario C, verify:
       - Monthly Revenue shows 9000
       - Belgium Pattern shows 2500
       - IRPF bracket calculation has 6 rows with formulas
       - 4-phase minimo section shows Cuota Integra calculation
       - Leefgeld shows green (positive) or appropriate color
    6. Change Scenario C Monthly Revenue from 9000 to 15000
       - All calculated values should update
       - Overview comparison table should reflect new values
    7. Go to File > Print Preview for Overview
       - Should show landscape layout
       - Header/footer should be visible
    8. Try to edit Constants sheet cell B3 (RETA Monthly)
       - Should show protection warning
    9. Check for any #REF!, #DIV/0!, #NAME?, #VALUE! errors
       - None should be present
  </how-to-verify>
  <resume-signal>Type "approved" if workbook functions correctly, or describe issues found.</resume-signal>
</task>

</tasks>

<verification>
1. Run `node scripts/generate-excel.js` - creates file without errors
2. File opens in Excel without warnings or errors
3. All 7 sheets present (Overview + 5 scenarios + Constants)
4. Cross-sheet formulas in Overview work correctly
5. Hyperlink navigation works
6. Editing inputs triggers recalculation throughout workbook
7. No Excel errors (#REF!, #DIV/0!, #NAME?, #VALUE!)
8. Print preview shows professional layout
9. Constants sheet is protected
</verification>

<success_criteria>
XLS-01: Multi-sheet workbook (Overview + 5 scenario sheets + Constants) - COMPLETE
XLS-02: Overview sheet with comparison table - COMPLETE
XLS-03: Individual scenario sheets with detailed breakdowns - COMPLETE (from 06-02)
XLS-04: All calculations use Excel formulas - COMPLETE
XLS-05: Professional styling with colors and borders - COMPLETE
XLS-06: Expense breakdown tables visible - COMPLETE (from 06-02)
XLS-07: RETA and IRPF step-by-step calculations - COMPLETE (from 06-02)
XLS-08: Workbook recalculates without errors - VERIFIED
XLS-09: Currency formatting (EUR) - COMPLETE
XLS-10: Percentage formatting - COMPLETE
</success_criteria>

<output>
After completion, create `.planning/phases/06-excel-calculator/06-03-SUMMARY.md`
</output>
