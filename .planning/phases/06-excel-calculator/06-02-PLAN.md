---
phase: 06-excel-calculator
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - scripts/generate-excel.js
autonomous: true

must_haves:
  truths:
    - "Each scenario sheet has editable input cells (revenue, expenses, Belgium pattern)"
    - "IRPF calculation shows step-by-step bracket rows with MAX/MIN formulas"
    - "4-phase minimo method is visible (Cuota1 -> Minimos -> Cuota3 -> CuotaIntegra)"
    - "All 5 scenarios (A-E) are generated with correct default values"
  artifacts:
    - path: "scripts/generate-excel.js"
      provides: "Scenario sheet generation"
      contains: "createScenarioSheet"
  key_links:
    - from: "Scenario sheets"
      to: "Constants sheet"
      via: "Named range references"
      pattern: "RETA_ANNUAL|MINIMO_PERSONAL|GASTOS_DIFICIL"
---

<objective>
Create scenario sheet template function and generate all 5 scenario sheets (A-E) with full IRPF calculation breakdown.

Purpose: Each scenario sheet provides a complete, editable tax calculation that users can experiment with. Step-by-step visibility enables accountant verification of AEAT methodology.
Output: 5 scenario sheets with inputs, expense breakdown, IRPF brackets, 4-phase minimo, and final results (net income, leefgeld).
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-excel-calculator/06-RESEARCH.md
@.planning/phases/06-excel-calculator/06-CONTEXT.md
@.planning/phases/06-excel-calculator/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scenario sheet template function</name>
  <files>scripts/generate-excel.js</files>
  <action>
    Add createScenarioSheet(workbook, scenario) function to generate-excel.js.

    Sheet name format: "Scenario {id} - {label}" (e.g., "Scenario A - 3K")

    **Section 1: INPUTS (rows 1-6)**
    - Header row: "INPUTS (Edit these values)" - bold, size 14
    - Row 3: Monthly Revenue (input cell B3, light blue fill #E0F0FF)
    - Row 4: Monthly Expenses (input cell B4, light blue fill)
    - Row 5: Belgium Pattern (input cell B5, light blue fill, data validation dropdown: 1000,2500)
    - Row 6: Spain Deductible (input cell B6, light blue fill, default 383)

    **Section 2: ANNUAL CALCULATIONS (rows 8-14)**
    - Row 8: Annual Revenue = B3*12
    - Row 9: Annual Expenses = B4*12
    - Row 10: Annual Belgium Costs = B5*12
    - Row 11: Annual Spain Deductible = B6*12
    - Row 12: RETA Annual = RETA_ANNUAL (named range)
    - Row 13: Total Deductible = SUM(B9:B12)
    - Row 14: Rendimiento Neto Previo = B8-B13

    **Section 3: GASTOS DIFICIL (rows 16-18)**
    - Row 16: Rendimiento Neto Previo (reference to B14)
    - Row 17: Gastos Dificil (5%) = MIN(MAX(0,B14)*GASTOS_DIFICIL_RATE, GASTOS_DIFICIL_MAX)
    - Row 18: Base Liquidable = MAX(0,B14-B17)

    **Section 4: IRPF BRACKET CALCULATION (rows 20-28)**
    - Header: "IRPF Bracket Calculation"
    - Column headers: Lower | Upper | Rate | Taxable | Tax
    - 6 rows for brackets (use MAX/MIN pattern for Taxable column):
      - Taxable in bracket: =MAX(0,MIN($B$18,UpperBound)-LowerBound)
      - Tax for bracket: =Taxable*Rate
    - Row 28: Total Tax (Cuota 1) = SUM of Tax column

    **Section 5: 4-PHASE MINIMO METHOD (rows 30-38)**
    - Row 30: Header "4-Phase Minimo Method"
    - Row 31: Base Liquidable (ref B18)
    - Row 32: Tax on Base (Cuota 1) (ref E28)
    - Row 33: Minimo Personal = MINIMO_PERSONAL
    - Row 34: Minimo Descendientes = MINIMO_DESCENDIENTES
    - Row 35: Total Minimos = B33+B34
    - Row 36: Tax on Minimos (Cuota 3) - calculate using same bracket logic on B35
    - Row 37: Cuota Integra = MAX(0,B32-B36)
    - Row 38: Cuota Diferencial = B37 (same as Cuota Integra for autonomos)

    **Section 6: FINAL RESULTS (rows 40-46)**
    - Row 40: Header "Final Results"
    - Row 41: Annual IRPF = B38
    - Row 42: Monthly IRPF = B41/12
    - Row 43: Annual Net Income = B8-B13-B41
    - Row 44: Monthly Net Income = B43/12
    - Row 45: Annual Leefgeld = B43-(PRIVATE_COSTS*12)
    - Row 46: Monthly Leefgeld = B45/12

    **Styling:**
    - Input cells: light blue fill (ARGB: FFE0F0FF)
    - Headers: bold, size 12
    - Section headers: bold, size 14
    - Currency cells: numFmt = '"EUR "#,##0.00'
    - Percentage cells: numFmt = '0.0%'
    - Column widths: A=30, B=15, C=10, D=15, E=15

    **Effective Rate:**
    - Row 47: Effective Tax Rate = IFERROR(B41/B14,0) with percentage format

    **Conditional Formatting:**
    - Leefgeld cells (B45, B46): Red if <0, Orange if 0-500, Green if >=500
    - Effective Tax Rate: Red if >40%, Orange if 30-40%, Green if <30%

    Use IFERROR wrapper for division operations to prevent #DIV/0!.
  </action>
  <verify>
    Code compiles without syntax errors.
    Function takes workbook and scenario object as parameters.
    Returns the created sheet.
  </verify>
  <done>
    createScenarioSheet function implemented with all 6 sections.
    Input cells have data validation and light blue fill.
    All formulas use named ranges where appropriate.
    Conditional formatting applied to key result cells.
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate all 5 scenario sheets</name>
  <files>scripts/generate-excel.js</files>
  <action>
    Add SCENARIOS constant array with 5 preset scenarios:
    ```javascript
    const SCENARIOS = [
      { id: 'A', label: '3K', monthlyRevenue: 3000, monthlyExpenses: 750, belgiumCost: 1000 },
      { id: 'B', label: '6K', monthlyRevenue: 6000, monthlyExpenses: 1500, belgiumCost: 1000 },
      { id: 'C', label: '9K', monthlyRevenue: 9000, monthlyExpenses: 3000, belgiumCost: 2500 },
      { id: 'D', label: '12K', monthlyRevenue: 12000, monthlyExpenses: 5000, belgiumCost: 2500 },
      { id: 'E', label: '18K', monthlyRevenue: 18000, monthlyExpenses: 8000, belgiumCost: 2500 }
    ];
    ```

    Update main() function to:
    1. Create Constants sheet (already done)
    2. Loop through SCENARIOS and call createScenarioSheet for each
    3. Save workbook

    Belgium patterns: A/B use 1000 (low), C/D/E use 2500 (high) per CLAUDE.md.
    Spain deductible default: 383 EUR/month (from CLAUDE.md fixed costs).

    Run generator and verify all 5 sheets are created.
  </action>
  <verify>
    Run `node scripts/generate-excel.js` - completes without errors.
    Open autonomo_calculator.xlsx in Excel.
    Verify 6 tabs exist: Constants, Scenario A - 3K, Scenario B - 6K, Scenario C - 9K, Scenario D - 12K, Scenario E - 18K.
    Check Scenario A: Revenue shows 3000, Belgium shows 1000.
    Check Scenario E: Revenue shows 18000, Belgium shows 2500.
    Change an input value - all dependent cells should recalculate.
  </verify>
  <done>
    All 5 scenario sheets generated with correct default values.
    Each sheet has working formulas that recalculate when inputs change.
    No Excel errors (#REF!, #DIV/0!, #NAME?, #VALUE!) present.
    IRPF calculations produce correct results (spot-check against HTML dashboard).
  </done>
</task>

</tasks>

<verification>
1. Run `node scripts/generate-excel.js` - no errors
2. Open in Excel - 6 tabs visible (Constants + 5 scenarios)
3. Scenario A - 3K: Monthly Revenue = 3000, Belgium Pattern = 1000
4. Scenario E - 18K: Monthly Revenue = 18000, Belgium Pattern = 2500
5. Edit Scenario C Monthly Revenue from 9000 to 10000 - all calculations update
6. No #REF!, #DIV/0!, #NAME?, #VALUE! errors in any cell
7. Conditional formatting shows green for high leefgeld, red for low
</verification>

<success_criteria>
- createScenarioSheet function generates complete calculation breakdown
- All 5 scenario sheets have correct preset values (A=3K, B=6K, C=9K, D=12K, E=18K)
- Belgium cost patterns match requirements (A/B=1000, C/D/E=2500)
- IRPF brackets visible with step-by-step rows
- 4-phase minimo method fully displayed
- Input cells are editable with data validation
- Formulas recalculate when inputs change
- Professional styling applied (colors, fonts, widths)
</success_criteria>

<output>
After completion, create `.planning/phases/06-excel-calculator/06-02-SUMMARY.md`
</output>
