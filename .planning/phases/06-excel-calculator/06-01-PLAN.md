---
phase: 06-excel-calculator
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/package.json
  - scripts/generate-excel.js
autonomous: true

must_haves:
  truths:
    - "Node.js project exists in scripts/ with ExcelJS dependency"
    - "Constants sheet contains all fiscal data with named ranges"
    - "Named ranges are workbook-scoped (accessible from all sheets)"
  artifacts:
    - path: "scripts/package.json"
      provides: "Node.js project configuration"
      contains: "exceljs"
    - path: "scripts/generate-excel.js"
      provides: "Excel generation script (partial)"
      contains: "createConstantsSheet"
  key_links:
    - from: "scripts/generate-excel.js"
      to: "ExcelJS API"
      via: "require('exceljs')"
      pattern: "require.*exceljs"
---

<objective>
Create Node.js Excel generator script with ExcelJS and implement Constants sheet containing all fiscal data as named ranges.

Purpose: Foundation for Excel workbook - Constants sheet provides single-point update location for 2027 rates and named ranges enable clean formulas throughout all scenario sheets.
Output: Runnable script that creates a workbook with Constants sheet containing RETA, minimos, gastos dificil, and IRPF brackets as named ranges.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-excel-calculator/06-RESEARCH.md
@.planning/phases/06-excel-calculator/06-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Node.js project with ExcelJS</name>
  <files>scripts/package.json</files>
  <action>
    Create scripts/ directory if not exists.
    Initialize Node.js project with `npm init -y`.
    Install ExcelJS: `npm install exceljs`.

    Verify package.json contains exceljs dependency.

    Note: Use npm, not yarn (simpler for single-script projects).
  </action>
  <verify>
    Run `cat scripts/package.json | grep exceljs` - should show dependency.
    Run `ls scripts/node_modules/exceljs` - directory should exist.
  </verify>
  <done>
    scripts/package.json exists with exceljs in dependencies.
    node_modules/exceljs is installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create generator script with Constants sheet</name>
  <files>scripts/generate-excel.js</files>
  <action>
    Create scripts/generate-excel.js with:

    1. ExcelJS require and workbook creation
    2. createConstantsSheet(workbook) function that:
       - Creates 'Constants' worksheet
       - Adds fiscal data with labels in column A, values in column B:
         - RETA Monthly: 428.40 (named range: RETA_MONTHLY)
         - RETA Annual: =RETA_MONTHLY*12 (named range: RETA_ANNUAL)
         - Minimo Personal: 5550 (named range: MINIMO_PERSONAL)
         - Minimo Descendientes: 2400 (named range: MINIMO_DESCENDIENTES)
         - Gastos Dificil Rate: 0.05 (5%) (named range: GASTOS_DIFICIL_RATE)
         - Gastos Dificil Max: 2000 (named range: GASTOS_DIFICIL_MAX)
         - Private Costs Monthly: 1727 (named range: PRIVATE_COSTS)
       - Adds IRPF bracket reference table (6 brackets: 0-12450@19%, 12450-20200@24%, 20200-35200@30%, 35200-60000@37%, 60000-300000@45%, 300000+@47%)
       - Column widths set for readability (A=25, B=15, C=10, D=15)
       - Currency formatting: '"EUR "#,##0.00' for monetary values
       - Percentage formatting: '0.0%' for rates
    3. Named ranges using workbook.definedNames.add() with absolute references ($):
       - Format: "'Constants'!$B$N" where N is the row number
       - These are workbook-scoped, not sheet-scoped
    4. Main async function that:
       - Creates workbook
       - Calls createConstantsSheet
       - Writes to '../autonomo_calculator.xlsx' (relative to scripts/)
       - Logs success message
    5. Call main() at bottom

    Use English formula syntax (commas, not semicolons).
    Set result: undefined for formulas (let Excel calculate).

    Header styling: bold, size 14 for sheet title.
  </action>
  <verify>
    Run `node scripts/generate-excel.js` - should create file without errors.
    Run `ls -la autonomo_calculator.xlsx` - file should exist.
    Open file in Excel - Constants sheet should show all fiscal data with working RETA Annual formula.
  </verify>
  <done>
    scripts/generate-excel.js creates workbook with Constants sheet.
    All named ranges (RETA_MONTHLY, RETA_ANNUAL, MINIMO_PERSONAL, MINIMO_DESCENDIENTES, GASTOS_DIFICIL_RATE, GASTOS_DIFICIL_MAX, PRIVATE_COSTS) are defined.
    IRPF brackets table is visible on Constants sheet.
    Currency and percentage formatting applied correctly.
  </done>
</task>

</tasks>

<verification>
1. `npm test` in scripts/ - not applicable (no tests)
2. `node scripts/generate-excel.js` runs without errors
3. autonomo_calculator.xlsx exists in project root
4. Opening in Excel shows Constants sheet with all named ranges working
5. RETA Annual cell shows calculated value (5140.80) not formula text
</verification>

<success_criteria>
- Node.js project initialized with ExcelJS dependency
- generate-excel.js creates valid .xlsx file
- Constants sheet contains all 7 named ranges
- IRPF brackets reference table visible
- Formatting (currency, percentage) applied correctly
- No #NAME? or #REF! errors when opening in Excel
</success_criteria>

<output>
After completion, create `.planning/phases/06-excel-calculator/06-01-SUMMARY.md`
</output>
