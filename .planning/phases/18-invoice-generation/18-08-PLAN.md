---
phase: 18-invoice-generation
plan: 08
type: execute
wave: 4
depends_on: ["18-05", "18-06"]
files_modified:
  - autonomo_dashboard.html
autonomous: false

must_haves:
  truths:
    - "All 23 INVOICE requirements verified as implemented"
    - "No JavaScript console errors on page load"
    - "Invoice form creates drafts, detail view manages lifecycle, PDF generates correctly"
    - "All existing tabs (Scenarios, Calendar, Expenses, Clients) still work"
    - "Entity switching re-renders invoice data correctly"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Complete Phase 18 implementation with all bug fixes applied"
  key_links:
    - from: "invoices tab"
      to: "InvoiceManager"
      via: "all UI interactions"
      pattern: "InvoiceManager\\."
---

<objective>
Browser testing and verification of all Phase 18 functionality. Test every requirement, fix bugs found, and verify no regressions in existing features.

Purpose: Ensure the complete invoicing system works end-to-end before presenting to user for approval.
Output: Bug-free invoicing system verified in browser.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-invoice-generation/18-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Comprehensive browser testing and bug fixing</name>
  <files>autonomo_dashboard.html</files>
  <action>
  Open http://localhost:3013/autonomo_dashboard.html in Chrome browser.

  **Test Sequence:**

  1. **Page Load** - No console errors, all tabs visible including "Invoices"
  2. **Tab Navigation** - Click every tab (Scenarios, Calendar, Expenses, Invoices, Details, Income, Clients, Compliance), verify each renders
  3. **Invoice Tab Empty State** - Click Invoices tab with no invoices, see "No invoices yet" message
  4. **Create Invoice (INVOICE-01, 02, 05, 06):**
     - Click "+ New Invoice", dialog opens
     - Select a client (or create one first if none exist)
     - Verify IVA treatment auto-detected (INVOICE-07 for EU B2B)
     - Add 3 line items with different quantities and prices
     - Verify live totals calculation
     - Save draft
     - Verify sequential invoice number format (F-2026-0001)
  5. **Entity-Type Headers (INVOICE-03, 04):**
     - Create invoice under autonomo entity -- check detail shows NIF
     - If SL entity exists, create invoice -- check detail shows CIF + Registro Mercantil
  6. **IVA Treatment (INVOICE-07):**
     - Create invoice for EU B2B client -- verify 0% IVA, legal text shown
     - Create invoice for Spanish client -- verify 21% IVA
  7. **IRPF (INVOICE-08):**
     - Under autonomo entity, invoice Spanish client -- IRPF toggle visible
     - Set IRPF to 15% -- verify it reduces total
     - Under SL entity -- IRPF toggle should NOT appear
  8. **VeriFactu QR (INVOICE-09):**
     - Generate PDF, verify QR code in bottom-right corner
  9. **Calendar Populate (INVOICE-10):**
     - If client has calendar days, test "Populate from Calendar" feature
  10. **Billable Expenses (INVOICE-11):**
      - Test adding expense as line item (if billable expenses exist)
  11. **Status Workflow (INVOICE-12, 13, 14):**
      - Mark invoice as sent -- status changes, invoice locked
      - Record partial payment -- payment history shows
      - Record remaining payment -- status changes to paid
  12. **Overdue (INVOICE-15):**
      - Create invoice with past due date, mark as sent
      - Verify overdue badge appears in list
      - Verify overdue alert banner shows
  13. **PDF (INVOICE-16, 17, 18):**
      - Generate PDF, verify all sections render
      - Download works
      - Print dialog opens
  14. **Rectificativa (INVOICE-19):**
      - From sent invoice, create rectificativa
      - Verify R-series number, links to original
  15. **Soft Delete (INVOICE-20):**
      - Archive a draft invoice -- disappears from list
      - Verify sent/paid invoices cannot be archived
  16. **List View (INVOICE-21):**
      - Verify columns: number, client, date, total, status, overdue indicator
  17. **Filters (INVOICE-22):**
      - Filter by client -- only matching invoices shown
      - Filter by status -- only matching status shown
      - Filter by month -- only matching month shown
  18. **Income Tracking (INVOICE-23):**
      - Verify client detail totals show real invoice amounts
  19. **Regression Testing:**
      - Scenarios tab -- calculations still work
      - Calendar tab -- calendar renders, day editor works
      - Expenses tab -- expense list renders, create/edit works
      - Clients tab -- client list and detail work
  20. **Entity Switching:**
      - Switch between entities -- invoice list updates
      - Invoices are entity-scoped (entity A's invoices don't show in entity B)

  **Fix all bugs found during testing.** For each fix:
  - Document what was broken
  - Apply the fix
  - Re-test to confirm the fix works
  - Commit each fix separately with message: `fix(18): {description}`

  **After all tests pass, commit final verification state.**
  </action>
  <verify>
  All 23 INVOICE requirements verified.
  No console errors on any tab.
  No regressions in existing features.
  All bug fixes committed.
  </verify>
  <done>Phase 18 browser testing complete. All invoice requirements verified. All bugs fixed. No regressions.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Invoice Generation system (Phase 18) with:
  - Invoice creation with sequential numbering and factura completa fields
  - Entity-type headers (Autonomo NIF vs SL CIF + Registro Mercantil)
  - IVA treatment by client category (Spain 21%, EU B2B reverse charge, export no IVA)
  - IRPF retention for autonomo invoicing Spanish clients
  - Dynamic line items with live calculation
  - Invoice-level discount (% or fixed)
  - Multi-currency support (EUR, USD, GBP) with exchange rate
  - Status workflow: Draft -> Sent -> Paid with overdue flagging
  - Partial payment recording with payment history
  - PDF generation with branded header, AutoTable line items, VeriFactu QR code
  - Factura rectificativa for corrections to sent invoices
  - Client detail integration (real invoice totals, invoice list per client)
  - Entity logo upload for PDF headers
  - Email delivery (optional, requires Supabase + Resend setup)
  - Invoice list with filters (client, status, month, project)
  - Overdue invoice alerts
  - Permission enforcement (accountant restrictions)
  - Soft delete only (4-year retention compliance)
  </what-built>
  <how-to-verify>
  1. Open http://localhost:3013/autonomo_dashboard.html
  2. Click "Invoices" tab
  3. Click "+ New Invoice" and create an invoice:
     - Select a client
     - Add 2-3 line items
     - Note the IVA treatment shown
     - Save the draft
  4. View the invoice detail -- verify all info displayed
  5. Click "Generate PDF" -- download and review the PDF:
     - Entity header with fiscal info
     - Client info
     - Line items table
     - Totals with IVA
     - VeriFactu QR code in bottom-right
  6. Mark invoice as "Sent"
  7. Record a payment
  8. Check other tabs (Scenarios, Calendar, Expenses) still work
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 18, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
All 23 INVOICE requirements tested and working:
- INVOICE-01: Create invoice for client
- INVOICE-02: Sequential numbering (no gaps)
- INVOICE-03: Autonomo entity header (NIF)
- INVOICE-04: SL entity header (CIF + Registro Mercantil)
- INVOICE-05: 13 factura completa fields
- INVOICE-06: Line items with description, qty, price, IVA, total
- INVOICE-07: EU B2B reverse charge, correct IVA treatment
- INVOICE-08: IRPF retention (autonomo + Spanish client only)
- INVOICE-09: VeriFactu QR code
- INVOICE-10: Calendar populate (days x rate)
- INVOICE-11: Billable expenses as line items
- INVOICE-12: Status workflow (Draft -> Sent -> Paid)
- INVOICE-13: Mark as sent
- INVOICE-14: Payment recording
- INVOICE-15: Overdue detection (sent >30 days, unpaid)
- INVOICE-16: PDF generation
- INVOICE-17: VeriFactu QR in PDF
- INVOICE-18: Download, print, email
- INVOICE-19: Factura rectificativa
- INVOICE-20: Soft delete only (no permanent delete)
- INVOICE-21: Invoice list view
- INVOICE-22: Filters (client, date, status, project)
- INVOICE-23: Income tracking per entity
</verification>

<success_criteria>
All 23 requirements verified in browser. No console errors. No regressions. User approves the complete invoicing system.
</success_criteria>

<output>
After completion, create `.planning/phases/18-invoice-generation/18-08-SUMMARY.md`
</output>
