---
phase: 18-invoice-generation
plan: 03
type: execute
wave: 2
depends_on: ["18-01", "18-02"]
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "User can open invoice form, select client, add line items, see live totals, and save draft"
    - "IVA rate auto-set from client category when client is selected"
    - "IRPF toggle only visible for autonomo entity invoicing Spanish client"
    - "Line items can be added, edited, and removed dynamically"
    - "Discount field updates totals in real-time"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Invoice form JS handlers: openInvoiceForm, handleSaveInvoice, addInvoiceLineItem, recalculateInvoiceFormTotals, handleInvoiceClientChange"
      contains: "openInvoiceForm"
  key_links:
    - from: "openInvoiceForm"
      to: "invoiceDialog"
      via: "dialog.showModal()"
      pattern: "invoiceDialog.*showModal"
    - from: "handleInvoiceClientChange"
      to: "IVA_TREATMENT"
      via: "client category lookup"
      pattern: "IVA_TREATMENT\\["
    - from: "handleSaveInvoice"
      to: "InvoiceManager.createInvoice"
      via: "form data extraction"
      pattern: "InvoiceManager\\.createInvoice"
---

<objective>
Wire up the invoice form dialog with full interactivity: client selection with IVA auto-detection, dynamic line items, live totals recalculation, IRPF toggle logic, discount handling, currency switching, and save/update functionality.

Purpose: Users can create and edit invoice drafts with all the business logic wired -- the core invoicing action.
Output: Fully functional invoice form that creates/updates invoices in IndexedDB.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-invoice-generation/18-RESEARCH.md
@.planning/phases/18-invoice-generation/18-01-SUMMARY.md
@.planning/phases/18-invoice-generation/18-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Invoice form JS handlers - open, close, client change, currency, IRPF</name>
  <files>autonomo_dashboard.html</files>
  <action>
  Add a new JS section after the InvoiceManager definition. Title it:
  ```javascript
  // =====================================================
  // PHASE 18: Invoice Form Handlers
  // =====================================================
  ```

  Implement these functions:

  1. `async function openInvoiceForm(invoiceId = null)` - Opens invoice dialog:
     - If invoiceId provided, load invoice data and populate form (edit mode)
     - If no invoiceId, reset all form fields (create mode)
     - Set dialog title: "New Invoice" or "Edit Invoice #{number}"
     - Set invoiceDate to today if create mode
     - Set invoiceDueDate to 30 days from today if create mode
     - Populate client dropdown from ClientManager.getClients() for current entity (exclude archived)
     - Store invoiceId on dialog element as data-edit-id attribute (empty string for create)
     - Call invoiceDialog.showModal()

  2. `function closeInvoiceForm()` - Closes dialog:
     - invoiceDialog.close()
     - Clear data-edit-id

  3. `async function handleInvoiceClientChange()` - When client selection changes:
     - Get selected client from db
     - Look up IVA treatment: IVA_TREATMENT[client.category]
     - Show IVA treatment info div with label and legal text (if any)
     - Set all line item IVA rates to the client's IVA rate
     - Show/hide IRPF group: only if entity type is autonomo AND client.category === 'spain'
     - Show/hide "From Project" button if client has projects
     - Show/hide calendar populate section if client has calendar days
     - Recalculate form totals

  4. `function handleInvoiceCurrencyChange()` - When currency changes:
     - If currency !== 'EUR', show exchange rate group, auto-fetch rate
     - If currency === 'EUR', hide exchange rate group, set rate to 1
     - Recalculate totals

  5. `async function fetchExchangeRateForInvoice()` - Fetches exchange rate:
     - Call InvoiceManager.fetchExchangeRate(currency)
     - If rate returned, set invoiceExchangeRate input value
     - If null (error), show brief notification to enter manually

  6. `function addInvoiceLineItem(prefill = null)` - Adds a row to line items table:
     - Create a new tr in invoiceLineItemsBody with inputs:
       - Description: text input (prefill.description or empty)
       - Quantity: number input, step 0.5, min 0 (prefill.quantity or 1)
       - Unit Price: number input, step 0.01, min 0 (prefill.unit_price or 0)
       - IVA %: number input, readonly, auto-set from client category IVA rate (multiply by 100 for display)
       - Line Total: span showing calculated total (readonly)
       - Remove button (x) with onclick to remove row and recalculate
     - Each input has oninput="recalculateInvoiceFormTotals()"
     - Store project_id as data attribute if prefill has it
     - Recalculate totals

  7. `function removeInvoiceLineItem(rowElement)` - Removes line item row:
     - Remove the tr element
     - Recalculate totals

  8. `function recalculateInvoiceFormTotals()` - Live calculation in form:
     - Iterate all line item rows in invoiceLineItemsBody
     - For each row: qty * unit_price = line total (update display)
     - Sum all line totals = subtotal
     - Apply discount: read discountType and discountValue
     - Calculate IVA on discounted subtotal using client's IVA rate
     - Calculate IRPF if irpf_rate > 0
     - Total = discounted subtotal + IVA - IRPF
     - Update all display spans (invoiceFormSubtotal, invoiceFormDiscount, invoiceFormIva, invoiceFormIrpf, invoiceFormTotal)
     - Show/hide discount row based on discountType
     - Show/hide IRPF row based on irpfRate
     - Update IVA label with actual rate %

  9. `function handleDiscountTypeChange()` - Show/hide discount value input:
     - If discount type is '' (none), hide value input
     - Otherwise show it with appropriate placeholder (% or EUR)
     - Recalculate totals

  Use _escapeHtml() (from Phase 17) for all user-generated content display.
  Use MoneyUtils for all cent conversions.
  </action>
  <verify>
  Open browser. Click Invoices tab, click "+ New Invoice".
  Dialog opens with today's date and due date 30 days out.
  Client dropdown populates with available clients.
  Select a client -- IVA treatment info appears, IVA rate set on line items.
  Add a line item -- fields appear.
  Enter description, qty=2, unit price=100 -- line total shows 200.00, subtotal shows 200.00, IVA shows 42.00 (for Spain 21%), total shows 242.00.
  No console errors.
  </verify>
  <done>Invoice form opens, populates clients, auto-detects IVA, shows/hides IRPF, calculates live totals, handles currency and discount changes.</done>
</task>

<task type="auto">
  <name>Task 2: Save/update invoice logic and edit mode</name>
  <files>autonomo_dashboard.html</files>
  <action>
  Add save and edit functions:

  1. `async function handleSaveInvoice()` - Saves invoice:
     - Read form values: client_id, date, due date, currency, exchange rate, discount type/value, irpf_rate, notes
     - Validate: client_id required, at least 1 line item
     - Get editId from invoiceDialog data-edit-id
     - If editId (edit mode):
       - Call InvoiceManager.updateInvoice(editId, changes)
       - Delete existing line items and recreate (simpler than diff)
       - Add all line items from form via InvoiceManager.addLineItem()
     - If no editId (create mode):
       - Call InvoiceManager.createInvoice(invoiceData) to get {id, invoice_number}
       - Add all line items from form via InvoiceManager.addLineItem()
     - Close dialog
     - Render invoice list
     - Show brief success notification

  2. `async function populateInvoiceFormForEdit(invoiceId)` - Fills form for editing:
     - Get invoice via InvoiceManager.getInvoice(invoiceId) -- returns invoice with lines
     - Set all form field values from invoice data
     - Populate line items table from invoice.lines
     - Handle IVA treatment display for the invoice's client
     - Show IRPF if applicable
     - Recalculate totals

  3. `async function addLineFromProject()` - Adds line item from client project:
     - Get selected client's projects
     - If only one project, auto-select it
     - If multiple, show a quick selection (use existing project data)
     - Create line item: description = project.name, quantity = 1, unit_price = project.rate_cents converted to euros
     - Store project_id as data attribute on the row

  4. `async function openCalendarPopulate()` - Opens calendar populate dialog:
     - Get selected client_id from invoice form
     - Populate project dropdown from client's projects
     - Set default date range to current month
     - calendarPopulateDialog.showModal()

  5. `async function handleCalendarPopulate()` - Populates line from calendar:
     - Get project, start date, end date from dialog
     - Query db.calendar_days for client_id + date range
     - Count matching days
     - Get project rate
     - Add line item: description = "{project name} - {start} to {end} ({N} days)", quantity = N, unit_price = rate
     - Close calendar populate dialog

  6. `async function openExpenseSelector()` - Add billable expense as line item:
     - Query expenses for current client where is_billable = true
     - For each selected expense, add as line item with description = expense vendor + date, amount = expense amount

  All save operations should use try/catch with user-friendly error messages.
  After successful save, call renderInvoiceList() to refresh the list.
  </action>
  <verify>
  Open form, select client, add line items, click "Save Draft".
  Invoice saves to IndexedDB (check via DevTools Application > IndexedDB > AutonomoBusinessDB > invoices).
  Close dialog and reopen for edit -- all fields populated correctly.
  Edit a value and save -- updated in DB.
  No console errors.
  </verify>
  <done>Invoices can be created and edited as drafts. Line items are stored in invoice_lines table. Totals calculated correctly with IVA, discount, IRPF. Calendar and project populate work.</done>
</task>

</tasks>

<verification>
- Create invoice with Spanish client: 21% IVA applied, IRPF toggle visible (if autonomo entity)
- Create invoice with EU B2B client: 0% IVA, legal text "Inversion del sujeto pasivo" shown
- Create invoice with UK client: 0% IVA, export text shown
- Edit a draft invoice: values load correctly in form
- Attempt to edit a sent invoice: should be blocked (but sent status not yet reachable in this plan)
- Line items add/remove/edit correctly
- Discount applies before IVA
- Calendar populate adds correct line item from calendar days
- All monetary calculations use MoneyUtils (integer cents)
</verification>

<success_criteria>
User can create a draft invoice by selecting a client, adding line items, and saving. IVA treatment auto-detected from client category. IRPF conditional on entity type + client category. Totals calculated live. Invoices persist in IndexedDB.
</success_criteria>

<output>
After completion, create `.planning/phases/18-invoice-generation/18-03-SUMMARY.md`
</output>
