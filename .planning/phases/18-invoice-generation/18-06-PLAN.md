---
phase: 18-invoice-generation
plan: 06
type: execute
wave: 3
depends_on: ["18-03", "18-04"]
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "Client detail invoices tab shows list of invoices for that client"
    - "Client calculateTotals returns real invoice totals (total invoiced, outstanding, profit)"
    - "Invoice total income per entity tracks paid invoice sums (INVOICE-23)"
    - "System prevents deleting invoices -- only soft delete/archive for drafts"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Wired client detail invoices tab, calculateTotals with real data, permission enforcement on invoice actions"
      contains: "calculateTotals.*invoices"
  key_links:
    - from: "ClientDetailUI.calculateTotals"
      to: "InvoiceManager.getInvoices"
      via: "query invoices by client_id"
      pattern: "InvoiceManager\\.getInvoices|db\\.invoices.*client_id"
    - from: "client detail invoices tab"
      to: "renderClientInvoices"
      via: "tab click handler"
      pattern: "renderClientInvoices"
---

<objective>
Wire up client detail view integration (replace Phase 18 placeholder, implement calculateTotals with real invoice data), add permission enforcement on invoice actions, and implement invoice income tracking per entity.

Purpose: Connects invoicing to the existing client management system and ensures proper permission enforcement across all invoice operations.
Output: Client detail shows real invoice data. Permission-aware invoice UI. Income tracking from paid invoices.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-invoice-generation/18-01-SUMMARY.md
@.planning/phases/18-invoice-generation/18-03-SUMMARY.md
@.planning/phases/18-invoice-generation/18-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Client detail invoices tab and calculateTotals wiring</name>
  <files>autonomo_dashboard.html</files>
  <action>
  1. Replace the placeholder in client detail invoices tab (line ~9185):
     Replace:
     ```html
     <p class="coming-soon">Invoices will be available in phase 18.</p>
     ```
     With:
     ```html
     <div id="client-invoices-header" class="panel-header" style="margin-bottom: 0.5rem;">
       <span id="client-invoices-count" class="text-dim"></span>
       <button class="btn btn-small btn-primary" data-permission="create" onclick="createInvoiceForClient()">+ Invoice</button>
     </div>
     <div id="client-invoices-list"></div>
     <div id="client-invoices-empty" class="empty-state hidden">
       <p>No invoices for this client yet.</p>
     </div>
     ```

  2. Add `async function renderClientInvoices(clientId)`:
     - Query invoices for this client: db.invoices.where('client_id').equals(clientId).filter(inv => !inv.deleted_at).toArray()
     - Sort by date_issued descending
     - Render in #client-invoices-list as compact rows:
       - Invoice number, date, total (MoneyUtils.formatEuros), status badge
       - Each row clickable -> opens invoice detail (switch to invoices tab, show detail)
     - Show/hide empty state
     - Update count text: "3 invoices"

  3. Add `function createInvoiceForClient()`:
     - Get current client ID from client detail view
     - Open invoice form pre-populated with this client selected
     - Switch to invoices tab after (or open dialog over current view)

  4. Update `ClientDetailUI.calculateTotals(clientId)` (at line ~22627):
     Replace the TODO/placeholder code with real invoice queries:
     ```javascript
     async calculateTotals(clientId) {
       let invoiced = 0;
       let paid = 0;

       try {
         const invoices = await db.invoices
           .where('client_id').equals(clientId)
           .filter(inv => !inv.deleted_at && inv.status !== 'draft')
           .toArray();

         for (const inv of invoices) {
           invoiced += inv.total_cents || 0;
           paid += inv.paid_cents || 0;
         }
       } catch (e) {
         console.debug('calculateTotals: invoice query error', e);
       }

       // Sum billable expenses for this client (existing Phase 17 code)
       let expensesTotal = 0;
       try {
         const clientExpenses = await ExpenseManager.getExpenses({ client_id: clientId });
         for (const exp of clientExpenses) {
           expensesTotal += exp.amount_cents || 0;
         }
       } catch (e) {
         console.debug('calculateTotals: expense query error', e);
       }

       return {
         invoiced,
         outstanding: invoiced - paid,
         profit: invoiced - expensesTotal
       };
     }
     ```

  5. Wire renderClientInvoices into the client detail tab activation:
     - When the "Invoices" tab is clicked in client detail, call renderClientInvoices(clientId)
     - This should integrate with the existing tab switching logic in ClientDetailUI

  6. Update the client list view to include "Last Invoice" column data:
     - In the client list rendering, show the last invoice date if available
     - Query the most recent invoice per client for display
  </action>
  <verify>
  Open a client detail page.
  Click "Invoices" tab -- see list of invoices for that client (or empty state).
  Total Invoiced, Outstanding, Profit values in client summary are real numbers from invoices.
  Click "+ Invoice" -- opens invoice form pre-populated with this client.
  Create an invoice, go back to client detail -- invoice appears in list, totals update.
  No console errors.
  </verify>
  <done>Client detail invoices tab shows real invoice data. calculateTotals queries actual invoices. "+ Invoice" button creates pre-populated invoice. Client list shows last invoice info.</done>
</task>

<task type="auto">
  <name>Task 2: Permission enforcement and soft delete protection</name>
  <files>autonomo_dashboard.html</files>
  <action>
  1. Apply permission attributes to all invoice action buttons:
     - "+ New Invoice" button: data-permission="create"
     - "Save Draft" button: data-permission="create" (for new) or data-permission="edit" (for edit)
     - "Send" button: data-permission="edit" data-permission-type="invoice"
     - "Record Payment" button: data-permission="edit" data-permission-type="invoice"
     - "Archive" button: data-permission="delete"
     - "Create Rectificativa" button: data-permission="create"
     - PDF generation: allowed for all roles (read access)

  2. Ensure accountant role restrictions (from Phase 14):
     - Accountant (canCreateInvoice: false per line 17677) should see invoice actions disabled
     - Check the existing PermissionUI.applyPermissions() call triggers after invoice UI renders
     - Add PermissionUI.applyPermissions() call at end of renderInvoiceList() and showInvoiceDetail()

  3. Enforce soft delete only (INVOICE-20):
     - Verify InvoiceManager.archiveInvoice() only does soft delete (already implemented in Phase 12)
     - Add validation in any delete-related code paths: only draft invoices can be archived
     - Add 4-year retention note in archive confirmation dialog

  4. Add `async function getEntityIncomeSummary(entityId)` - Income tracking per entity (INVOICE-23):
     - Query all paid invoices for entity
     - Sum total_cents grouped by month/year
     - Return { total: totalCents, byMonth: [{year, month, total}], count }
     - This will be used by future reporting phases

  5. Ensure EntityContext subscriber re-renders invoice list when entity changes:
     - Call renderInvoiceList() when entity changes (similar to expense list pattern)
     - Call populateInvoiceFilters() to refresh client dropdown for new entity
  </action>
  <verify>
  Switch between entities -- invoice list updates to show invoices for current entity.
  Create invoice for entity A, switch to entity B -- invoice not visible.
  Permission enforcement: if using gestor role, create/edit buttons should be disabled.
  Attempt to archive a sent invoice -- error message shown.
  Attempt to archive a draft invoice -- succeeds with confirmation.
  No console errors.
  </verify>
  <done>Invoice actions respect permission roles. Soft delete only for drafts. Entity-scoped invoice list updates on entity switch. Income tracking per entity available.</done>
</task>

</tasks>

<verification>
- Client detail invoices tab shows real invoice list (not placeholder)
- calculateTotals returns real invoice data
- Client total invoiced, outstanding, profit are accurate
- Permission enforcement on all invoice actions
- Soft delete only (no permanent delete)
- Entity switching re-renders invoice list correctly
- Income tracking sums paid invoices by entity
</verification>

<success_criteria>
Client management fully integrated with invoicing. Permission-aware invoice UI. Entity-scoped data isolation. Income tracking from paid invoices.
</success_criteria>

<output>
After completion, create `.planning/phases/18-invoice-generation/18-06-SUMMARY.md`
</output>
