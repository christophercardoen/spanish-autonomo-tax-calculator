---
phase: 18-invoice-generation
plan: 07
type: execute
wave: 4
depends_on: ["18-05", "18-06"]
files_modified:
  - autonomo_dashboard.html
autonomous: true
user_setup:
  - service: resend
    why: "Email delivery for sending invoices to clients (optional)"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys"
    dashboard_config:
      - task: "Create Resend account and get API key"
        location: "https://resend.com/signup"
      - task: "Deploy send-invoice Edge Function to Supabase"
        location: "Supabase Dashboard -> Edge Functions"

must_haves:
  truths:
    - "User can email invoice PDF to client via Edge Function (when configured)"
    - "Email includes invoice PDF as attachment with professional email body"
    - "Download/print always works without email configuration"
    - "Graceful degradation: email button shows setup message when Edge Function not configured"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "handleEmailInvoice function, email dialog HTML"
      contains: "handleEmailInvoice"
  key_links:
    - from: "handleEmailInvoice"
      to: "Supabase Edge Function"
      via: "fetch POST with PDF attachment"
      pattern: "supabase.*functions.*send-invoice"
---

<objective>
Add email delivery for invoices via Supabase Edge Function + Resend API. Implement download/print shortcuts. This is an optional enhancement -- the system works fully without email configured.

Purpose: Users can send invoices to clients via email with PDF attachment, completing the invoice delivery workflow.
Output: Email button on invoice detail that sends PDF to client's email. Download and print buttons always available.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-invoice-generation/18-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Email, download, and print handlers</name>
  <files>autonomo_dashboard.html</files>
  <action>
  1. Add email invoice dialog HTML (near other dialogs):
     ```html
     <dialog id="emailInvoiceDialog" class="invoice-dialog" style="max-width: 500px;">
       <div class="dialog-header">
         <h2>Email Invoice</h2>
         <button type="button" class="dialog-close" onclick="document.getElementById('emailInvoiceDialog').close()">x</button>
       </div>
       <div style="padding: 1.5rem;">
         <div class="form-group">
           <label for="emailTo">To *</label>
           <input type="email" id="emailTo" required>
         </div>
         <div class="form-group">
           <label for="emailCc">CC</label>
           <input type="email" id="emailCc">
         </div>
         <div class="form-group">
           <label for="emailSubject">Subject</label>
           <input type="text" id="emailSubject">
         </div>
         <div class="form-group">
           <label for="emailBody">Message</label>
           <textarea id="emailBody" rows="5"></textarea>
         </div>
         <p class="text-dim" style="font-size: 0.8rem;">PDF will be attached automatically.</p>
         <div class="dialog-actions">
           <button class="btn" onclick="document.getElementById('emailInvoiceDialog').close()">Cancel</button>
           <button class="btn btn-primary" id="sendEmailBtn" onclick="handleSendInvoiceEmail()">Send Email</button>
         </div>
       </div>
     </dialog>
     ```

  2. Add `async function handleEmailInvoice(invoiceId)`:
     - Get invoice and client from DB
     - Pre-fill email form:
       - To: client's email (from client record)
       - Subject: "Invoice {invoice_number} from {entity_name}"
       - Body: "Dear {client_name},\n\nPlease find attached invoice {invoice_number} dated {date} for the amount of {total}.\n\nDue date: {due_date}\n\nPayment terms: {notes}\n\nBest regards,\n{entity_name}"
     - Open emailInvoiceDialog.showModal()

  3. Add `async function handleSendInvoiceEmail()`:
     - Get form values: to, cc, subject, body
     - Validate: to required
     - Generate PDF as base64 (modify InvoicePDFGenerator.generatePDF to return base64 option):
       - Add parameter `returnBase64 = false`
       - If true, return doc.output('datauristring') instead of saving
     - Check if Supabase is configured:
       - If not: show message "Email sending requires Supabase configuration. Use the Download button instead."
       - Return early
     - Call Supabase Edge Function:
       ```javascript
       const { data, error } = await supabase.functions.invoke('send-invoice', {
         body: {
           to: emailTo,
           cc: emailCc || undefined,
           subject: emailSubject,
           html: emailBodyFormatted,
           attachments: [{
             filename: `${invoice.invoice_number}.pdf`,
             content: pdfBase64 // base64 encoded PDF
           }]
         }
       });
       ```
     - On success: close dialog, show notification "Invoice emailed successfully"
     - On error: show error message
     - Update invoice date_sent if not already set (auto-mark as sent on first email)

  4. Add `function handlePrintInvoice(invoiceId)`:
     - Generate PDF in a new window/iframe
     - Use doc.output('bloburl') to create a blob URL
     - Open in new window and trigger print
     - Alternative: use doc.autoPrint() jsPDF feature

  5. Add `function handleDownloadInvoice(invoiceId)`:
     - Simply call InvoicePDFGenerator.generatePDF(invoiceId) -- it already does doc.save()

  6. Add these action buttons to the invoice detail actions (renderInvoiceDetailActions):
     - "Download PDF" button (always shown, all statuses)
     - "Print" button (always shown)
     - "Email" button (shown for sent/draft, opens email dialog)

  7. Create the Edge Function template file (informational for user setup):
     - Add a comment block in the code explaining the Edge Function:
     ```javascript
     /*
      * OPTIONAL: Email delivery via Supabase Edge Function
      *
      * Deploy this Edge Function to enable email sending:
      *
      * supabase/functions/send-invoice/index.ts:
      *
      * import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
      * import { Resend } from "npm:resend"
      *
      * serve(async (req) => {
      *   const resend = new Resend(Deno.env.get('RESEND_API_KEY'))
      *   const { to, cc, subject, html, attachments } = await req.json()
      *   const { data, error } = await resend.emails.send({
      *     from: 'invoices@yourdomain.com',
      *     to, cc, subject, html, attachments
      *   })
      *   return new Response(JSON.stringify({ data, error }))
      * })
      *
      * Set RESEND_API_KEY in Supabase Edge Function secrets.
      */
     ```

  8. Graceful degradation for email:
     - If typeof supabase === 'undefined' or SUPABASE_CONFIG is empty:
       - Email button shows tooltip: "Configure Supabase for email delivery"
       - Button is visually dimmed but not hidden
       - Clicking it shows a helpful message about setup requirements
     - Download and Print always work regardless of Supabase config
  </action>
  <verify>
  Click "Download PDF" on invoice detail -- PDF downloads.
  Click "Print" -- print dialog opens.
  Click "Email" -- email dialog opens with pre-filled fields.
  If Supabase not configured, email send shows helpful setup message.
  If Supabase configured (optional), email sends successfully.
  All three actions work for draft, sent, and paid invoices.
  No console errors.
  </verify>
  <done>Email, download, and print functionality for invoices. Email via Supabase Edge Function with graceful degradation when not configured. PDF always available for download/print regardless of email setup.</done>
</task>

</tasks>

<verification>
- Download PDF works for all invoice statuses
- Print opens browser print dialog
- Email dialog pre-fills from client data
- Email sends via Edge Function when configured
- Graceful degradation when Supabase not configured
- Edge Function template documented in code
- No console errors
</verification>

<success_criteria>
Invoice delivery options complete: download, print, and email. Email gracefully degrades without Supabase. PDF generation reliable for all invoice types.
</success_criteria>

<output>
After completion, create `.planning/phases/18-invoice-generation/18-07-SUMMARY.md`
</output>
