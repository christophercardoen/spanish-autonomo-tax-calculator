---
phase: 18-invoice-generation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "Invoices tab appears in main navigation between Expenses and Details"
    - "Invoices tab panel contains list container, filters, and summary bar"
    - "Invoice form dialog supports create and edit modes with line items"
    - "Invoice CSS provides professional dark-theme styling consistent with existing tabs"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Invoice tab HTML, invoice dialog HTML, invoice CSS"
      contains: "tab-invoices"
  key_links:
    - from: "tab-invoices radio input"
      to: "panel-invoices section"
      via: "CSS :checked sibling selector"
      pattern: "tab-invoices:checked.*panel-invoices"
    - from: "invoice-dialog"
      to: "invoice form fields"
      via: "dialog element"
      pattern: "invoiceDialog"
---

<objective>
Add the Invoices tab to main navigation, create the invoice list HTML structure, invoice form dialog HTML, and all invoice-specific CSS. This is the static HTML/CSS scaffold that the JS logic plans will wire up.

Purpose: Provides the complete UI skeleton for invoicing -- tab, list view, form dialog, detail view -- so JS plans can wire up interactivity without building HTML.
Output: New "Invoices" tab in nav, invoice list section, invoice form dialog, all styled.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-invoice-generation/18-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Invoice tab navigation and CSS</name>
  <files>autonomo_dashboard.html</files>
  <action>
  1. Add invoice tab radio input at line ~8464 (after tab-expenses, before tab-details):
     ```html
     <input type="radio" name="tabs" id="tab-invoices" class="tab-input">
     ```

  2. Add invoice tab label in the nav (line ~8474, after Expenses label, before Details label):
     ```html
     <label for="tab-invoices" class="tab-label">Invoices</label>
     ```

  3. Add CSS for the new tab in the active tab styling block (around line 229-235):
     - Add `#tab-invoices:checked ~ .tab-nav .tab-label[for="tab-invoices"]` to the active tab selector list
     - Add `#tab-invoices:checked ~ .tab-panels .panel-invoices` to the show content selector list (around line 247-253)

  4. Add comprehensive invoice CSS after the existing clients CSS section. Create a new section:
     ```css
     /* ===========================================
        PHASE 18: INVOICES TAB STYLES
        =========================================== */
     ```

     Include styles for:
     - `.panel-invoices` - Tab panel container with padding
     - `.invoices-header` - Flex header with title and "New Invoice" button
     - `.invoices-filters` - Filter bar with select dropdowns (client, status, date range)
     - `.invoices-summary-bar` - Summary strip showing: total invoiced, outstanding, overdue count
     - `.invoice-table` - Full-width table for desktop
       - Columns: Number, Client, Date, Due Date, Total, Status, Actions
       - Alternating row colors using existing --card-bg and --bg vars
       - Hover highlight
     - `.invoice-status-badge` - Status badges (draft=gray, sent=blue, paid=green, overdue=red/orange)
       - `.badge-draft { background: var(--text-dim); }`
       - `.badge-sent { background: #3b82f6; }`
       - `.badge-paid { background: var(--positive); }`
       - `.badge-overdue { background: var(--negative); }`
     - `.invoice-cards` - Card layout for mobile (display: none on desktop, block on mobile <768px)
       - Each card: invoice number, client, total, status badge, date
     - `.invoice-actions` - Action buttons (view, edit, PDF, send)
     - `.overdue-alert` - Top-of-panel alert bar for overdue invoices (red tint background)

     Invoice form dialog styles:
     - `.invoice-dialog` - Dialog with max-width 800px, dark theme matching existing expense-dialog
     - `.invoice-line-items-table` - Editable table within form
       - Columns: Description, Qty, Unit Price, IVA%, Line Total, Actions (remove)
       - Add row button below table
     - `.invoice-totals-section` - Right-aligned totals block (subtotal, discount, IVA, IRPF, total)
     - `.invoice-meta-row` - Two-column layout for client/date/currency fields
     - `.invoice-notes-field` - Textarea for payment terms

     Invoice detail view styles:
     - `.invoice-detail-view` - Full panel view replacing list when viewing single invoice
     - `.invoice-detail-header` - Invoice number + status badge + action buttons
     - `.invoice-detail-body` - Entity info, client info, line items table, totals
     - `.payment-history` - Payment records list
     - `.payment-form` - Inline form for recording payments

     Follow the established design patterns:
     - Use CSS custom properties: --bg, --card-bg, --text, --text-dim, --accent, --positive, --negative, --border
     - Use var(--spacing-sm/md/lg) for spacing
     - Use var(--radius) for border-radius
     - Dark theme (background: var(--card-bg))
     - JetBrains Mono for monetary values (font-family: 'JetBrains Mono', monospace)
     - Responsive: table on desktop (>768px), cards on mobile

  5. Add mobile-specific overrides in the existing @media (max-width: 768px) block:
     - Hide invoice table, show invoice cards
     - Stack invoice form fields vertically
     - Full-width dialog on mobile
  </action>
  <verify>
  Open browser at http://localhost:3013/autonomo_dashboard.html
  Verify "Invoices" tab appears in navigation bar.
  Click "Invoices" tab -- empty panel shows (no content yet, just the container).
  Check no console errors.
  Verify all other tabs still work (click Scenarios, Calendar, Expenses).
  </verify>
  <done>Invoices tab visible in navigation. Clicking it shows the panel-invoices section. All CSS defined. No console errors.</done>
</task>

<task type="auto">
  <name>Task 2: Invoice list HTML, form dialog HTML, and detail view HTML</name>
  <files>autonomo_dashboard.html</files>
  <action>
  1. Add the invoice tab panel section after panel-expenses section (around line 8766, or wherever panel-expenses ends). Follow the pattern of other tab panels:

  ```html
  <!-- INVOICES TAB -->
  <section class="tab-panel panel-invoices">
    <!-- Overdue Alert Banner (hidden by default) -->
    <div id="overdue-alert" class="overdue-alert" style="display: none;">
      <span class="overdue-alert-icon">!</span>
      <span id="overdue-alert-text"></span>
    </div>

    <!-- Invoice List View -->
    <div id="invoice-list-view">
      <div class="invoices-header">
        <h2>Invoices</h2>
        <button class="btn btn-primary" id="new-invoice-btn" data-permission="create" onclick="openInvoiceForm()">+ New Invoice</button>
      </div>

      <!-- Filters -->
      <div class="invoices-filters">
        <select id="invoiceFilterClient" onchange="renderInvoiceList()">
          <option value="">All Clients</option>
        </select>
        <select id="invoiceFilterStatus" onchange="renderInvoiceList()">
          <option value="">All Statuses</option>
          <option value="draft">Draft</option>
          <option value="sent">Sent</option>
          <option value="paid">Paid</option>
          <option value="overdue">Overdue</option>
        </select>
        <input type="month" id="invoiceFilterMonth" onchange="renderInvoiceList()">
        <select id="invoiceFilterProject" onchange="renderInvoiceList()">
          <option value="">All Projects</option>
        </select>
      </div>

      <!-- Summary Bar -->
      <div class="invoices-summary-bar">
        <div class="summary-item">
          <span class="summary-label">Total Invoiced</span>
          <span id="invoiceSummaryTotal" class="summary-value mono">-</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Outstanding</span>
          <span id="invoiceSummaryOutstanding" class="summary-value mono">-</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Overdue</span>
          <span id="invoiceSummaryOverdue" class="summary-value mono overdue-value">-</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Paid</span>
          <span id="invoiceSummaryPaid" class="summary-value mono paid-value">-</span>
        </div>
      </div>

      <!-- Desktop Table -->
      <table class="invoice-table" id="invoiceTable">
        <thead>
          <tr>
            <th>Number</th>
            <th>Client</th>
            <th>Date</th>
            <th>Due Date</th>
            <th class="text-right">Total</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="invoiceTableBody"></tbody>
      </table>

      <!-- Mobile Cards -->
      <div class="invoice-cards" id="invoiceCards"></div>

      <!-- Empty State -->
      <div id="invoiceEmptyState" class="empty-state" style="display: none;">
        <p id="invoiceEmptyText">No invoices yet. Create your first invoice.</p>
      </div>
    </div>

    <!-- Invoice Detail View (hidden by default) -->
    <div id="invoice-detail-view" class="invoice-detail-view" style="display: none;">
      <div class="invoice-detail-header">
        <button class="btn btn-small" onclick="showInvoiceList()">Back to List</button>
        <h2 id="detail-invoice-number"></h2>
        <span id="detail-invoice-status" class="invoice-status-badge"></span>
        <div class="invoice-detail-actions" id="detail-invoice-actions"></div>
      </div>
      <div class="invoice-detail-body">
        <div class="invoice-detail-meta">
          <div class="detail-entity-info" id="detail-entity-info"></div>
          <div class="detail-client-info" id="detail-client-info"></div>
        </div>
        <div class="invoice-detail-info-row">
          <span>Date: <strong id="detail-invoice-date"></strong></span>
          <span>Due: <strong id="detail-invoice-due"></strong></span>
          <span id="detail-invoice-currency-info"></span>
        </div>
        <table class="invoice-detail-lines-table">
          <thead>
            <tr>
              <th>Description</th>
              <th class="text-right">Qty</th>
              <th class="text-right">Unit Price</th>
              <th class="text-right">IVA %</th>
              <th class="text-right">Total</th>
            </tr>
          </thead>
          <tbody id="detail-line-items"></tbody>
        </table>
        <div class="invoice-detail-totals" id="detail-totals"></div>

        <!-- Legal Text (EU B2B, export, etc.) -->
        <div id="detail-legal-text" class="invoice-legal-text" style="display: none;"></div>

        <!-- Rectificativa Reference -->
        <div id="detail-rectificativa-ref" class="rectificativa-ref" style="display: none;"></div>

        <!-- Payment History -->
        <div class="payment-section">
          <h3>Payments</h3>
          <div id="payment-history"></div>
          <div id="payment-form-container" style="display: none;">
            <h4>Record Payment</h4>
            <div class="payment-form">
              <input type="number" id="paymentAmount" placeholder="Amount (EUR)" step="0.01" min="0">
              <input type="date" id="paymentDate">
              <select id="paymentMethod">
                <option value="transfer">Bank Transfer</option>
                <option value="card">Card</option>
                <option value="cash">Cash</option>
                <option value="other">Other</option>
              </select>
              <input type="text" id="paymentReference" placeholder="Reference / Note">
              <button class="btn btn-primary" onclick="handleRecordPayment()">Record</button>
            </div>
          </div>
        </div>

        <!-- Notes -->
        <div id="detail-notes" class="invoice-notes" style="display: none;"></div>
      </div>
    </div>
  </section>
  ```

  2. Add invoice form dialog (before the closing </body> tag or near other dialogs):

  ```html
  <!-- Invoice Form Dialog -->
  <dialog id="invoiceDialog" class="invoice-dialog">
    <div class="dialog-header">
      <h2 id="invoiceDialogTitle">New Invoice</h2>
      <button type="button" class="dialog-close" onclick="closeInvoiceForm()">x</button>
    </div>
    <div class="invoice-dialog-body">
      <!-- Meta Fields Row -->
      <div class="invoice-meta-row">
        <div class="form-group">
          <label for="invoiceClient">Client *</label>
          <select id="invoiceClient" onchange="handleInvoiceClientChange()" required>
            <option value="">Select client...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="invoiceDate">Issue Date *</label>
          <input type="date" id="invoiceDate" required>
        </div>
        <div class="form-group">
          <label for="invoiceDueDate">Due Date</label>
          <input type="date" id="invoiceDueDate">
        </div>
      </div>

      <div class="invoice-meta-row">
        <div class="form-group">
          <label for="invoiceCurrency">Currency</label>
          <select id="invoiceCurrency" onchange="handleInvoiceCurrencyChange()">
            <option value="EUR">EUR</option>
            <option value="USD">USD</option>
            <option value="GBP">GBP</option>
          </select>
        </div>
        <div class="form-group" id="exchangeRateGroup" style="display: none;">
          <label for="invoiceExchangeRate">Exchange Rate (to EUR)</label>
          <input type="number" id="invoiceExchangeRate" step="0.0001" min="0" value="1">
          <button class="btn btn-small" onclick="fetchExchangeRateForInvoice()">Fetch Rate</button>
        </div>
        <div class="form-group" id="irpfGroup" style="display: none;">
          <label for="invoiceIrpf">IRPF Retention</label>
          <select id="invoiceIrpf" onchange="recalculateInvoiceFormTotals()">
            <option value="0">None</option>
            <option value="15">15% (standard)</option>
            <option value="7">7% (first 3 years)</option>
          </select>
        </div>
      </div>

      <!-- IVA Treatment Info -->
      <div id="invoiceIvaTreatment" class="iva-treatment-info" style="display: none;"></div>

      <!-- Auto-populate from Calendar -->
      <div id="calendarPopulateSection" class="calendar-populate-section" style="display: none;">
        <button class="btn btn-small" onclick="openCalendarPopulate()">Populate from Calendar Days</button>
        <span id="calendarPopulateInfo" class="populate-info"></span>
      </div>

      <!-- Line Items -->
      <div class="invoice-line-items-section">
        <h3>Line Items</h3>
        <table class="invoice-line-items-table">
          <thead>
            <tr>
              <th>Description</th>
              <th class="text-right" style="width:70px">Qty</th>
              <th class="text-right" style="width:100px">Unit Price</th>
              <th class="text-right" style="width:80px">IVA %</th>
              <th class="text-right" style="width:100px">Total</th>
              <th style="width:40px"></th>
            </tr>
          </thead>
          <tbody id="invoiceLineItemsBody"></tbody>
        </table>
        <div class="line-items-actions">
          <button class="btn btn-small" onclick="addInvoiceLineItem()">+ Add Line</button>
          <button class="btn btn-small" id="addFromExpenseBtn" onclick="openExpenseSelector()" style="display: none;">+ From Expense</button>
          <button class="btn btn-small" id="addFromProjectBtn" onclick="addLineFromProject()" style="display: none;">+ From Project</button>
        </div>
      </div>

      <!-- Discount -->
      <div class="invoice-discount-row">
        <label>Discount:</label>
        <select id="invoiceDiscountType" onchange="recalculateInvoiceFormTotals()">
          <option value="">None</option>
          <option value="percentage">Percentage (%)</option>
          <option value="fixed">Fixed Amount</option>
        </select>
        <input type="number" id="invoiceDiscountValue" value="0" min="0" step="0.01" oninput="recalculateInvoiceFormTotals()" style="display: none;">
      </div>

      <!-- Totals -->
      <div class="invoice-totals-section">
        <div class="totals-row"><span>Subtotal:</span><span id="invoiceFormSubtotal" class="mono">0.00</span></div>
        <div class="totals-row" id="discountRow" style="display: none;"><span>Discount:</span><span id="invoiceFormDiscount" class="mono">-0.00</span></div>
        <div class="totals-row"><span id="invoiceIvaLabel">IVA (21%):</span><span id="invoiceFormIva" class="mono">0.00</span></div>
        <div class="totals-row" id="irpfRow" style="display: none;"><span id="invoiceIrpfLabel">IRPF (15%):</span><span id="invoiceFormIrpf" class="mono">-0.00</span></div>
        <div class="totals-row totals-total"><span>TOTAL:</span><span id="invoiceFormTotal" class="mono">0.00</span></div>
      </div>

      <!-- Notes -->
      <div class="form-group">
        <label for="invoiceNotes">Notes / Payment Terms</label>
        <textarea id="invoiceNotes" rows="3" placeholder="Bank details, payment terms..."></textarea>
      </div>

      <!-- Dialog Actions -->
      <div class="dialog-actions">
        <button class="btn" onclick="closeInvoiceForm()">Cancel</button>
        <button class="btn btn-primary" id="saveInvoiceBtn" onclick="handleSaveInvoice()">Save Draft</button>
      </div>
    </div>
  </dialog>

  <!-- Calendar Populate Dialog -->
  <dialog id="calendarPopulateDialog" class="invoice-dialog" style="max-width: 500px;">
    <div class="dialog-header">
      <h2>Populate from Calendar</h2>
      <button type="button" class="dialog-close" onclick="document.getElementById('calendarPopulateDialog').close()">x</button>
    </div>
    <div style="padding: 1.5rem;">
      <div class="form-group">
        <label for="calPopProject">Project</label>
        <select id="calPopProject"></select>
      </div>
      <div class="form-group">
        <label for="calPopStartDate">Start Date</label>
        <input type="date" id="calPopStartDate">
      </div>
      <div class="form-group">
        <label for="calPopEndDate">End Date</label>
        <input type="date" id="calPopEndDate">
      </div>
      <div id="calPopPreview" class="calendar-pop-preview"></div>
      <div class="dialog-actions">
        <button class="btn" onclick="document.getElementById('calendarPopulateDialog').close()">Cancel</button>
        <button class="btn btn-primary" onclick="handleCalendarPopulate()">Add Line Item</button>
      </div>
    </div>
  </dialog>
  ```

  3. Add factura rectificativa dialog:
  ```html
  <!-- Rectificativa Dialog -->
  <dialog id="rectificativaDialog" class="invoice-dialog" style="max-width: 500px;">
    <div class="dialog-header">
      <h2>Create Factura Rectificativa</h2>
      <button type="button" class="dialog-close" onclick="document.getElementById('rectificativaDialog').close()">x</button>
    </div>
    <div style="padding: 1.5rem;">
      <p id="rectOriginalRef" class="rect-original-ref"></p>
      <div class="form-group">
        <label for="rectReason">Correction Reason *</label>
        <select id="rectReason" required>
          <option value="">Select reason...</option>
          <option value="error_datos_fiscales">Error in fiscal data</option>
          <option value="modificacion_base">Modification of taxable base</option>
          <option value="descuento_posterior">Subsequent discount</option>
          <option value="devolucion_envases">Return of packaging</option>
          <option value="impago_concurso">Non-payment (insolvency)</option>
          <option value="otros">Other</option>
        </select>
      </div>
      <div class="form-group">
        <label for="rectDescription">Description</label>
        <textarea id="rectDescription" rows="3" placeholder="Describe the correction..."></textarea>
      </div>
      <div class="dialog-actions">
        <button class="btn" onclick="document.getElementById('rectificativaDialog').close()">Cancel</button>
        <button class="btn btn-primary" onclick="handleCreateRectificativa()">Create Rectificativa</button>
      </div>
    </div>
  </dialog>
  ```

  IMPORTANT: Place the invoices tab panel AFTER the expenses panel section and BEFORE the scenarios panel section in the HTML order. The radio input order and CSS selectors handle which panel shows -- the DOM order of panels does not matter for display, but placing it logically helps maintainability.
  </action>
  <verify>
  Open browser at http://localhost:3013/autonomo_dashboard.html
  Click "Invoices" tab -- see the header "Invoices", "+ New Invoice" button, filter dropdowns, summary bar, empty table.
  Click "+ New Invoice" button -- invoice dialog opens (no JS wired yet, so it should at least show the dialog element).
  Check all other tabs still render correctly.
  No console errors.
  </verify>
  <done>Invoices tab shows complete UI scaffold: list view with filters/summary/table, detail view with payments, form dialog with line items and totals. All HTML elements have correct IDs for JS wiring. Responsive CSS for mobile cards.</done>
</task>

</tasks>

<verification>
- Invoices tab appears in navigation between Expenses and Details
- Clicking Invoices tab shows the panel-invoices section
- Invoice form dialog has all required fields: client, dates, currency, line items, discount, IRPF, notes
- CSS provides dark theme styling consistent with existing tabs
- Mobile responsive: cards instead of table on <768px
- No console errors
- All existing tabs continue to work
</verification>

<success_criteria>
Complete UI scaffold for invoicing is in place. All HTML elements have IDs ready for JS wiring. CSS provides professional dark-theme styling. Tab navigation works. Zero console errors.
</success_criteria>

<output>
After completion, create `.planning/phases/18-invoice-generation/18-02-SUMMARY.md`
</output>
