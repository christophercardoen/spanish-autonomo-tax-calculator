---
phase: 18-invoice-generation
plan: 04
type: execute
wave: 2
depends_on: ["18-01", "18-02"]
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "Invoice list shows all active invoices with number, client, date, total, and status badge"
    - "User can filter invoices by client, status, date, and project"
    - "Summary bar shows total invoiced, outstanding, overdue count, and paid totals"
    - "Overdue invoices show red badge and overdue alert banner"
    - "Invoice list view shows dual layout: table on desktop, cards on mobile"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "renderInvoiceList, renderInvoiceSummary, renderOverdueAlert functions"
      contains: "renderInvoiceList"
  key_links:
    - from: "renderInvoiceList"
      to: "InvoiceManager.getInvoices"
      via: "entity-scoped query"
      pattern: "InvoiceManager\\.getInvoices"
    - from: "renderInvoiceList"
      to: "invoiceTableBody"
      via: "innerHTML population"
      pattern: "invoiceTableBody"
    - from: "tab-invoices change"
      to: "renderInvoiceList"
      via: "event listener on tab activation"
      pattern: "tab-invoices.*renderInvoiceList"
---

<objective>
Wire up the invoice list view with data rendering, filtering, summary calculations, and overdue alerts. Implement the invoice detail view for viewing individual invoices with status actions and payment recording.

Purpose: Users can see all their invoices at a glance, filter and sort them, identify overdue items, and drill into individual invoice details to manage status and payments.
Output: Working invoice list with filters, summary bar, detail view with payment recording.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-invoice-generation/18-RESEARCH.md
@.planning/phases/18-invoice-generation/18-01-SUMMARY.md
@.planning/phases/18-invoice-generation/18-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Invoice list rendering and filtering</name>
  <files>autonomo_dashboard.html</files>
  <action>
  Add a new JS section:
  ```javascript
  // =====================================================
  // PHASE 18: Invoice List & Detail Handlers
  // =====================================================
  ```

  1. `async function renderInvoiceList()` - Renders invoice list:
     - Get entityId from EntityContext
     - If no entity, show empty state and return
     - Get all invoices via InvoiceManager.getInvoices(entityId)
     - Apply filters:
       - Client filter: invoiceFilterClient value
       - Status filter: invoiceFilterStatus value
         - Special case: 'overdue' = status is 'sent' AND InvoiceManager.isOverdue(invoice)
       - Month filter: invoiceFilterMonth value (match date_issued year-month)
       - Project filter: check if any line item has matching project_id
     - Load client names for display (batch load like expense list does with _loadClientNameCache pattern)
     - Render desktop table rows in invoiceTableBody:
       - Each row: invoice_number, client name, date_issued (formatted), date_due (formatted), total (MoneyUtils.formatEuros), status badge, action buttons
       - Row onclick opens detail view (except action buttons)
       - Status badge: use badge-draft/badge-sent/badge-paid class. If status is 'sent' and isOverdue, use badge-overdue
       - Action buttons: View, Edit (draft only), PDF (any), Archive (draft only)
     - Render mobile cards in invoiceCards:
       - Each card: invoice number + status badge top row, client name, date, total
       - Card onclick opens detail view
     - Show/hide empty state based on results
       - Empty text: "No invoices yet" vs "No invoices match filters"
     - Call renderInvoiceSummary(invoices) with ALL invoices (unfiltered) for summary bar
     - Call renderOverdueAlert(invoices) with unfiltered invoices

  2. `async function renderInvoiceSummary(invoices)` - Updates summary bar:
     - Total Invoiced: sum of all non-archived invoice total_cents
     - Outstanding: sum of sent invoices (total_cents - paid_cents)
     - Overdue: count + sum of overdue invoices
     - Paid: sum of paid invoice total_cents
     - Update DOM elements with MoneyUtils.formatEuros values
     - Overdue shows count + amount, e.g., "2 (EUR 3,400.00)"

  3. `function renderOverdueAlert(invoices)` - Shows/hides overdue alert:
     - Filter overdue invoices
     - If any: show overdue-alert div with text like "3 overdue invoices totalling EUR 5,200.00"
     - If none: hide overdue-alert div

  4. `async function populateInvoiceFilters()` - Populates filter dropdowns:
     - Client filter: get clients for entity, add as options
     - Project filter: get projects for entity, add as options
     - Called when invoices tab is activated

  5. Tab activation listener - Add event listener for tab-invoices radio input:
     ```javascript
     document.getElementById('tab-invoices').addEventListener('change', function(e) {
       if (e.target.checked) {
         populateInvoiceFilters();
         renderInvoiceList();
       }
     });
     ```

  6. EntityContext subscriber - Subscribe to entity changes to re-render invoice list when entity switches (follow the pattern from expense list).

  Use _escapeHtml() for all client names and invoice data displayed in HTML.
  Use MoneyUtils.formatEuros() for all monetary amounts.
  Follow the dual rendering pattern from Phase 17 (table for desktop, cards for mobile).
  </action>
  <verify>
  Open browser, click Invoices tab.
  If no invoices exist, see "No invoices yet" empty state.
  Create an invoice (from Plan 03), go back to list -- invoice appears in table.
  Summary bar updates with totals.
  Filter by status "Draft" -- only draft invoices shown.
  Clear filter -- all invoices shown again.
  No console errors.
  </verify>
  <done>Invoice list renders all invoices with status badges. Filters work for client/status/month. Summary bar shows total/outstanding/overdue/paid. Overdue alert banner appears when applicable.</done>
</task>

<task type="auto">
  <name>Task 2: Invoice detail view and status/payment actions</name>
  <files>autonomo_dashboard.html</files>
  <action>
  Implement detail view and status workflow handlers:

  1. `async function showInvoiceDetail(invoiceId)` - Shows detail view:
     - Hide invoice-list-view, show invoice-detail-view
     - Get invoice with lines via InvoiceManager.getInvoice(invoiceId)
     - Get entity via EntityManager.getEntity(invoice.entity_id)
     - Get client via db.clients.get(invoice.client_id)
     - Populate:
       - detail-invoice-number: invoice.invoice_number
       - detail-invoice-status: status badge (class + text)
       - detail-invoice-date: formatted date
       - detail-invoice-due: formatted due date (+ "OVERDUE" label if overdue)
       - detail-entity-info: entity name, NIF/CIF, address (format differs by entity type)
       - detail-client-info: client name, NIF/tax ID, address, country flag
       - detail-line-items: populate table rows from invoice.lines
       - detail-totals: subtotal, discount (if any), IVA with rate, IRPF (if any), total
       - detail-legal-text: show IVA legal text if applicable (EU B2B, export)
       - detail-rectificativa-ref: if invoice has original_invoice_id, show reference
       - detail-notes: show notes if present
       - Currency info: show currency + exchange rate if non-EUR
     - Render payment history via renderPaymentHistory(invoiceId)
     - Render action buttons based on status via renderInvoiceDetailActions(invoice)

  2. `function showInvoiceList()` - Returns to list view:
     - Hide invoice-detail-view, show invoice-list-view
     - Re-render list (data may have changed)

  3. `function renderInvoiceDetailActions(invoice)` - Contextual action buttons:
     - Draft: [Edit] [Send] [Generate PDF] [Create Rectificativa -- hidden for draft] [Archive]
     - Sent: [Record Payment] [Generate PDF] [Create Rectificativa]
     - Paid: [Generate PDF] [Create Rectificativa]
     - Archived: [Generate PDF] (read-only)
     - Each button has appropriate onclick handler and data-permission attribute

  4. `async function handleMarkAsSent(invoiceId)` - Mark invoice as sent:
     - Confirm with user: "Mark invoice {number} as sent? This will lock the invoice for editing."
     - Call InvoiceManager.markAsSent(invoiceId)
     - Re-render detail view
     - Show success notification

  5. `async function handleRecordPayment()` - Record payment from form:
     - Get invoiceId from current detail view
     - Read payment form values: amount (convert to cents), date, method, reference
     - Validate: amount > 0, date required
     - Call InvoiceManager.recordPayment(invoiceId, paymentData)
     - Re-render detail view (status may change to paid)
     - Clear payment form
     - Show success notification

  6. `async function renderPaymentHistory(invoiceId)` - Renders payment records:
     - Get payments via InvoiceManager.getPayments(invoiceId)
     - Get invoice for total/paid amounts
     - Show each payment: date, amount, method, reference
     - Show remaining balance (total - paid)
     - Show/hide payment form based on:
       - Status must be 'sent' (not yet fully paid)
       - Set max amount on payment input to remaining balance
       - Pre-fill date with today

  7. `async function handleArchiveInvoice(invoiceId)` - Archive draft invoice:
     - Confirm: "Archive invoice {number}? The invoice number will be consumed and cannot be reused."
     - Call InvoiceManager.archiveInvoice(invoiceId) (already exists from Phase 12)
     - Show invoice list
     - Show success notification

  8. `async function handleCreateRectificativa(invoiceId)` - Opens rectificativa flow:
     - If called without invoiceId, get it from current detail view
     - Set rectOriginalRef text: "Correcting invoice: {original_number}"
     - rectificativaDialog.showModal()
     - Store original invoice id on dialog

  9. `async function handleSubmitRectificativa()` - Creates rectificativa:
     - Get original invoice id from dialog
     - Get reason and description from form
     - Call InvoiceManager.createRectifyingInvoice(originalId, { reason, description })
     - Close rectificativa dialog
     - Open the new rectificativa in edit mode (openInvoiceForm with new id)
     - Show notification

  10. Keyboard shortcut: Escape key in detail view returns to list (if no dialog open).
  </action>
  <verify>
  Create an invoice with line items. Click on it in the list -- detail view shows.
  Detail view shows: entity info, client info, line items table, totals, status badge.
  Click "Back to List" -- returns to list.
  Click "Send" on a draft -- confirms, status changes to "Sent".
  On sent invoice detail: "Record Payment" form visible.
  Record a partial payment -- payment history shows, remaining balance updates.
  Record final payment (full remaining) -- status changes to "Paid".
  Archive a draft invoice -- invoice disappears from list.
  Create rectificativa from a sent invoice -- R-series invoice created.
  No console errors throughout.
  </verify>
  <done>Invoice detail view fully functional with entity/client info, line items, totals. Status workflow works: draft -> sent -> paid. Payment recording with partial payment support. Archive and rectificativa flows work.</done>
</task>

</tasks>

<verification>
- Invoice list renders all invoices for current entity
- Filters work: client, status, month, overdue
- Summary bar accurate: total, outstanding, overdue, paid
- Detail view shows complete invoice data
- Status transitions: draft -> sent -> paid
- Payment recording tracks partial payments
- Overdue detection works (sent + past due + unpaid)
- Archive only works on drafts
- Rectificativa links to original invoice
- XSS prevention via _escapeHtml on all user content
</verification>

<success_criteria>
Complete invoice list and detail view working. User can view, filter, and drill into invoices. Status workflow (draft -> sent -> paid) with payment recording. Overdue detection and alerts. Archive and rectificativa support.
</success_criteria>

<output>
After completion, create `.planning/phases/18-invoice-generation/18-04-SUMMARY.md`
</output>
