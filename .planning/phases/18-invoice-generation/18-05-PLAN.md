---
phase: 18-invoice-generation
plan: 05
type: execute
wave: 3
depends_on: ["18-03", "18-04"]
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "User can generate a professional A4 PDF from any invoice"
    - "PDF includes branded header with entity identity (autonomo: NIF, SL: CIF + Registro Mercantil)"
    - "PDF includes VeriFactu QR code in bottom-right corner"
    - "PDF shows line items table with proper column alignment"
    - "PDF shows correct legal text for EU B2B and export invoices"
    - "PDF downloads with filename matching invoice number (e.g., F-2026-0001.pdf)"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "InvoicePDFGenerator singleton with generatePDF method"
      contains: "InvoicePDFGenerator"
  key_links:
    - from: "InvoicePDFGenerator.generatePDF"
      to: "jsPDF"
      via: "lazy-loaded CDN script"
      pattern: "jspdf\\.umd\\.min\\.js"
    - from: "InvoicePDFGenerator._drawVeriFactuQR"
      to: "QRCode"
      via: "QR code generation to data URL"
      pattern: "new QRCode"
    - from: "InvoicePDFGenerator._drawHeader"
      to: "entity.type"
      via: "conditional header fields"
      pattern: "ENTITY_TYPE\\.AUTONOMO|ENTITY_TYPE\\.SOCIEDAD"
---

<objective>
Implement PDF generation using jsPDF + AutoTable with VeriFactu QR code. Creates professional A4 invoices with branded header, entity-type-specific fields, line items table, totals breakdown, legal text, and QR code.

Purpose: Users can download/print compliant Spanish invoices as professional PDFs with all required factura completa fields and VeriFactu QR.
Output: InvoicePDFGenerator singleton that produces downloadable A4 PDF from any invoice.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-invoice-generation/18-RESEARCH.md
@.planning/phases/18-invoice-generation/18-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: InvoicePDFGenerator singleton with lazy-loaded jsPDF + QR</name>
  <files>autonomo_dashboard.html</files>
  <action>
  Create the InvoicePDFGenerator singleton. Place it after the Invoice Form Handlers section.

  ```javascript
  // =====================================================
  // PHASE 18: Invoice PDF Generator
  // =====================================================
  ```

  Use the ReceiptManager._loadScript() pattern for lazy-loading. Create a shared _loadScript if InvoicePDFGenerator needs its own, or call ReceiptManager._loadScript() directly (it checks for existing scripts).

  **InvoicePDFGenerator object with these methods:**

  1. `async _ensureLibraries()` - Lazy-loads jsPDF, AutoTable, and QRCode.js:
     - Check window.jspdf; if missing, load: https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js
     - Check window.jspdf?.jsPDF?.API?.autoTable; if missing, load: https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js
     - Check window.QRCode; if missing, load: https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js
     - Use ReceiptManager._loadScript() or duplicate the pattern

  2. `async generatePDF(invoiceId)` - Main entry point:
     - Call _ensureLibraries()
     - Get invoice with lines via InvoiceManager.getInvoice(invoiceId)
     - Get entity via EntityManager.getEntity(invoice.entity_id)
     - Get client via db.clients.get(invoice.client_id)
     - Create jsPDF instance: new jsPDF({ unit: 'mm', format: 'a4' })
     - A4 = 210mm x 297mm
     - Margins: top 15mm, left 20mm, right 20mm, bottom 20mm
     - Content width = 170mm
     - Call drawing methods in order:
       a. _drawHeader(doc, invoice, entity) -- returns Y position after header
       b. _drawClientBlock(doc, client, invoice, startY)
       c. _drawInvoiceMeta(doc, invoice, startY)
       d. _drawLineItems(doc, invoice.lines, startY) -- AutoTable, returns finalY
       e. _drawTotals(doc, invoice, finalY)
       f. _drawLegalText(doc, invoice, client, afterTotalsY)
       g. _drawNotes(doc, invoice, afterLegalY)
       h. await _drawVeriFactuQR(doc, invoice, entity) -- bottom-right corner
       i. _drawFooter(doc, invoice)
     - Save: doc.save(`${invoice.invoice_number}.pdf`)
     - Return true on success

  3. `_drawHeader(doc, invoice, entity)` - Branded header:
     - Draw accent color bar at top: 210mm wide, 4mm tall, color #3b82f6 (blue accent)
     - Entity name large and bold (Helvetica-Bold 16pt)
     - Below entity name, entity-type-specific fields:
       - Autonomo: "NIF: {nif}", "Domicilio fiscal: {address}"
       - SL: "CIF: {cif}", "Razon social: {name}", "Registro Mercantil: Tomo {tomo}, Folio {folio}, Hoja {hoja}", "Domicilio social: {address}"
     - If entity has logo_data (base64), draw logo on left side (30x30mm), text shifts right
     - Invoice number and series on the right side, large: "INVOICE" label, then "{invoice_number}"
     - Return Y position after header (approx 45-55mm from top depending on entity type)

  4. `_drawClientBlock(doc, client, startY)` - Client info block:
     - Draw on the LEFT side (under entity info):
       - "Bill To:" label (bold)
       - Client name
       - Tax ID (NIF/CIF/VAT number)
       - Address (if available)
       - Country
     - Return Y after client block

  5. `_drawInvoiceMeta(doc, invoice, startY)` - Invoice metadata on RIGHT side:
     - Date: formatted date_issued
     - Due Date: formatted date_due
     - Currency: invoice.currency (+ exchange rate if non-EUR)
     - Status is NOT shown on PDF (professional invoices don't show internal status)

  6. `_drawLineItems(doc, lines, startY)` - Line items table using AutoTable:
     - Use doc.autoTable() with:
       - startY: position after client/meta blocks
       - head: [['Description', 'Qty', 'Unit Price', 'IVA %', 'Total']]
       - body: lines mapped to [description, qty, formatEuros(unit_price_cents), (iva_rate*100)+'%', formatEuros(line_total_cents)]
       - styles: { fontSize: 9, cellPadding: 3, textColor: [220, 220, 220], fillColor: [30, 30, 35] }
       - headStyles: { fillColor: [59, 130, 246], textColor: [255, 255, 255], fontStyle: 'bold' }
       - alternateRowStyles: { fillColor: [35, 35, 42] }
       - columnStyles: right-align columns 1-4 (qty, price, IVA, total)
       - margin: { left: 20, right: 20 }
       - theme: 'grid'
     - Return finalY from autoTable

  7. `_drawTotals(doc, invoice, startY)` - Totals section:
     - Right-aligned block (x=120mm to 190mm area)
     - Draw rows:
       - Subtotal: MoneyUtils.formatEuros(invoice.subtotal_cents)
       - Discount (if any): -MoneyUtils.formatEuros(discountAmount) with label
       - IVA {rate}%: MoneyUtils.formatEuros(invoice.iva_cents)
       - IRPF {rate}% (if any): -MoneyUtils.formatEuros(invoice.irpf_cents)
       - Separator line
       - TOTAL (bold, larger font): MoneyUtils.formatEuros(invoice.total_cents)
       - If non-EUR: show EUR equivalent below
     - Use Helvetica for labels, Courier for numbers (monospace alignment)
     - Return Y after totals

  8. `_drawLegalText(doc, invoice, client, startY)` - Legal text:
     - Get IVA treatment for client category
     - If legalText exists, draw in italics below totals
     - For rectificativa: add "Factura rectificativa de: {original_number}. Motivo: {reason}"
     - Font size 8pt, gray color
     - Return Y after legal text

  9. `_drawNotes(doc, invoice, startY)` - Notes/payment terms:
     - If invoice.notes is not empty, draw in a light box
     - Label "Notes / Payment Terms" (bold 8pt)
     - Notes text (8pt)
     - Return Y after notes

  10. `async _drawVeriFactuQR(doc, invoice, entity)` - VeriFactu QR code:
      - Generate QR URL via InvoiceManager.generateVeriFactuQRUrl(invoice, entity)
      - Create temporary hidden div
      - Render QR code using new QRCode(div, { text: url, width: 128, height: 128, correctLevel: QRCode.CorrectLevel.H })
      - Wait for render (setTimeout 150ms)
      - Extract canvas data URL
      - Clean up temporary div
      - Draw QR image in bottom-right corner: x=160mm, y=252mm, width=35mm, height=35mm
      - Draw label above QR: "QR tributario" (8pt)
      - Draw small text below: "VERI*FACTU" (7pt)

  11. `_drawFooter(doc, invoice)` - Page footer:
      - Draw separator line at y=287mm
      - Page number: "Page 1 of 1" (or actual page count for multi-page)
      - Generated date: "Generated: {today}"

  **Additional helper:**
  12. `_formatDate(isoDate)` - Format ISO date to human-readable: "23 April 2026"

  **Font strategy:** Use jsPDF built-in fonts only:
  - Helvetica for body text
  - Helvetica-Bold for headings and labels
  - Courier for monetary values (monospace for alignment)
  Do NOT embed custom fonts (DM Sans, JetBrains Mono) -- they add 300-500KB bloat and have rendering issues.

  **Wire the "Generate PDF" button** in the detail view actions to call:
  ```javascript
  async function handleGeneratePDF(invoiceId) {
    try {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Generating...';
      await InvoicePDFGenerator.generatePDF(invoiceId);
      btn.textContent = 'PDF Downloaded';
      setTimeout(() => { btn.disabled = false; btn.textContent = 'Generate PDF'; }, 2000);
    } catch (err) {
      console.error('PDF generation failed:', err);
      alert('PDF generation failed: ' + err.message);
      btn.disabled = false;
      btn.textContent = 'Generate PDF';
    }
  }
  ```
  </action>
  <verify>
  Create an invoice with 3+ line items (different quantities, prices).
  Go to invoice detail view, click "Generate PDF".
  PDF downloads with filename matching invoice number.
  Open PDF and verify:
  - A4 size
  - Blue accent bar at top
  - Entity name and fiscal info visible
  - Client info present
  - Line items table with correct columns and values
  - Totals section (subtotal, IVA, total) correct
  - VeriFactu QR code visible in bottom-right
  - "QR tributario" label above QR
  - Footer with page number
  Test with EU B2B client -- verify legal text "Inversion del sujeto pasivo" appears.
  No console errors during generation.
  </verify>
  <done>InvoicePDFGenerator produces professional A4 PDF with branded header, entity-type fields, client info, line items table (AutoTable), totals with IVA/IRPF, legal text, VeriFactu QR code, and footer. Libraries lazy-loaded from CDN.</done>
</task>

<task type="auto">
  <name>Task 2: Logo upload per entity and PDF logo integration</name>
  <files>autonomo_dashboard.html</files>
  <action>
  1. Add logo upload functionality to the entity edit flow:
     - In the entity creation/edit modal (from Phase 13), add a logo upload field:
       - Label: "Company Logo (optional)"
       - Input type="file" accept="image/*" with id="entityLogoUpload"
       - Preview div showing current logo if exists
       - "Remove Logo" button if logo exists
     - On file selection:
       - Read file as data URL
       - Compress to max 200x200px using canvas (JPEG quality 0.8)
       - Store as logo_data property on entity record
       - Show preview

  2. Add `async function compressLogoImage(file)`:
     - Create Image from file data URL
     - Draw to canvas scaled to max 200px width/height (maintain aspect ratio)
     - Return canvas.toDataURL('image/jpeg', 0.8)
     - Graceful fallback: if compression fails, use original data URL

  3. Update InvoicePDFGenerator._drawHeader to use logo:
     - If entity.logo_data exists:
       - Draw logo at x=20mm, y=8mm, width=25mm, height auto (maintain aspect ratio)
       - Shift entity text to x=50mm (after logo)
     - If no logo:
       - Entity text starts at x=20mm as before

  4. Wire logo upload in entity modal:
     - Add the file input HTML near other entity fields
     - Handle save: include logo_data in entity update
     - Handle edit: show existing logo in preview

  Note: The logo is stored per entity in IndexedDB. It is NOT stored per invoice -- the PDF reads from the entity's current logo. If the entity changes their logo, future PDFs will use the new logo.
  </action>
  <verify>
  Edit an entity and upload a logo image.
  Logo appears in preview.
  Generate a PDF for an invoice under that entity -- logo appears in header.
  Edit entity, remove logo.
  Generate PDF again -- no logo, text starts at left margin.
  Upload a very large image (2000x2000px) -- verify it gets compressed.
  No console errors.
  </verify>
  <done>Entity logo upload with compression. Logo appears in PDF header when present. Text layout adjusts for logo presence. Logo stored as compressed base64 in entity record.</done>
</task>

</tasks>

<verification>
- PDF generates without errors for all invoice types (draft, sent, paid)
- PDF includes all 13 factura completa fields
- Entity type determines header: NIF for autonomo, CIF + Registro Mercantil for SL
- IVA legal text appears for EU B2B and export invoices
- IRPF shown when applicable
- VeriFactu QR code visible and contains correct AEAT URL
- PDF filename matches invoice number
- Logo appears in header when uploaded
- Multi-page invoices handle page breaks in line items table
- jsPDF and QRCode.js lazy-loaded (not on page load)
</verification>

<success_criteria>
Professional A4 PDF generation working with all required Spanish compliance elements. VeriFactu QR code present. Entity-type-specific headers. Logo support. Libraries lazy-loaded from CDN.
</success_criteria>

<output>
After completion, create `.planning/phases/18-invoice-generation/18-05-SUMMARY.md`
</output>
