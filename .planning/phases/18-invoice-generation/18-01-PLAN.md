---
phase: 18-invoice-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "IVA_TREATMENT config object maps CLIENT_CATEGORY to rate/label/legalText"
    - "Dexie DB version 4 includes invoice_payments table"
    - "InvoiceManager has createInvoice, updateInvoice, addLineItem, removeLineItem, calculateInvoiceTotals methods"
    - "Status transitions enforced: draft->sent->paid with immutability on sent"
    - "Payment recording tracks partial payments with method/reference/date"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "IVA_TREATMENT, IRPF_RETENTION constants, extended InvoiceManager with CRUD + line items + status + payments + totals calculation"
      contains: "IVA_TREATMENT"
  key_links:
    - from: "IVA_TREATMENT"
      to: "CLIENT_CATEGORY"
      via: "category key lookup"
      pattern: "IVA_TREATMENT\\[client\\.category\\]"
    - from: "InvoiceManager.createInvoice"
      to: "InvoiceManager.getNextInvoiceNumber"
      via: "sequential number assignment"
      pattern: "getNextInvoiceNumber"
    - from: "InvoiceManager.calculateInvoiceTotals"
      to: "MoneyUtils"
      via: "cents arithmetic"
      pattern: "MoneyUtils\\.(roundCents|calculateIVA)"
---

<objective>
Extend InvoiceManager with full CRUD, line item management, IVA/IRPF calculation, status workflow, and payment tracking. Add IVA_TREATMENT configuration. Upgrade Dexie schema to version 4 with invoice_payments table.

Purpose: Establishes the complete data layer for invoicing -- all subsequent plans (form, list, PDF) depend on this foundation.
Output: Working InvoiceManager singleton with all business logic, ready for UI wiring.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-invoice-generation/18-RESEARCH.md
@.planning/phases/18-invoice-generation/18-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: IVA_TREATMENT + IRPF constants and Dexie schema upgrade</name>
  <files>autonomo_dashboard.html</files>
  <action>
  1. Add IVA_TREATMENT constant immediately after the CLIENT_CATEGORY block (around line 19250). Use Object.freeze():
     - spain: { rate: 0.21, label: 'IVA 21%', legalText: null }
     - eu_b2b: { rate: 0, label: 'Exempt - Reverse charge', legalText: 'Inversion del sujeto pasivo - Art. 84.Uno.2 Ley 37/1992 del IVA. Art. 196 Directiva 2006/112/CE.' }
     - eu_b2c: { rate: 0.21, label: 'IVA 21%', legalText: null }
     - uk: { rate: 0, label: 'Export - No IVA', legalText: 'Exportacion de servicios. Operacion no sujeta a IVA. Art. 69 Ley 37/1992.' }
     - third_country: { rate: 0, label: 'Export - No IVA', legalText: 'Exportacion de servicios. Operacion no sujeta a IVA. Art. 69 Ley 37/1992.' }

  2. Add IRPF_RETENTION constant:
     - STANDARD: 15  (established autonomo)
     - REDUCED: 7    (first 3 years of activity)
     - NONE: 0       (default, SL entities, foreign clients)
     Note: IRPF retention only applies when entity_type === 'autonomo' AND client.category === 'spain'

  3. Add INVOICE_CURRENCY constant:
     - EUR: 'EUR', USD: 'USD', GBP: 'GBP'

  4. Upgrade Dexie schema to version 4 (current is version 3 at line 14669):
     - Add new version(4) block copying ALL existing stores from version 3
     - Add new table: invoice_payments: '++id, invoice_id, amount_cents, date, method, reference, created_at, [invoice_id]'
     - Add table reference: this.invoice_payments = this.table('invoice_payments')
     - Update DB_VERSION const from 2 to 4 (note: this const is informational only, Dexie uses the version() calls)

  IMPORTANT: Do NOT remove or modify existing version(1), version(2), version(3) blocks. Only ADD version(4).
  </action>
  <verify>
  Search the file for "IVA_TREATMENT" and confirm it exists with all 5 category keys.
  Search for "version(4)" and confirm it includes invoice_payments table.
  Search for "IRPF_RETENTION" and confirm STANDARD=15, REDUCED=7.
  Open in browser at http://localhost:3013/autonomo_dashboard.html -- page loads without console errors, existing tabs work.
  </verify>
  <done>IVA_TREATMENT maps all 5 client categories to rate/label/legalText. Dexie version 4 adds invoice_payments table. IRPF_RETENTION and INVOICE_CURRENCY constants defined.</done>
</task>

<task type="auto">
  <name>Task 2: Extend InvoiceManager with full CRUD, line items, status workflow, payments, and totals</name>
  <files>autonomo_dashboard.html</files>
  <action>
  Extend the existing InvoiceManager object (starts at line 18405) by adding these methods AFTER the existing parseInvoiceNumber method (line 18646). Keep ALL existing methods (getNextInvoiceNumber, getCurrentNumber, archiveInvoice, createRectifyingInvoice, getInvoices, isValidInvoiceNumber, parseInvoiceNumber).

  Add the following methods to InvoiceManager:

  **CRUD Operations:**
  1. `async createInvoice(invoiceData)` - Creates a draft invoice:
     - Requires EntityContext.entityId
     - Gets client via db.clients.get(invoiceData.client_id) to validate
     - Looks up IVA treatment from IVA_TREATMENT[client.category]
     - Calls this.getNextInvoiceNumber(entityId, this.SERIES.F) for sequential number
     - Stores: entity_id, client_id, series:'F', invoice_number, status:'draft', date_issued (default today ISO), date_due (default 30 days from issue), currency (default 'EUR'), exchange_rate (default 1), discount_type (null), discount_value (0), irpf_rate (0), subtotal_cents:0, iva_cents:0, irpf_cents:0, total_cents:0, paid_cents:0, notes:'', date_sent:null, deleted_at:null, ...auditFields(true)
     - Queues to SyncQueue
     - Returns { id, invoice_number }

  2. `async updateInvoice(id, changes)` - Updates a draft invoice ONLY:
     - Gets invoice, checks status === 'draft' or throws "Cannot edit {status} invoice"
     - Merges changes + auditFields(false)
     - Queues to SyncQueue
     - If line-item-affecting fields changed (discount_type, discount_value, irpf_rate), recalculate totals
     - Returns updated invoice

  3. `async getInvoice(id)` - Gets single invoice with line items:
     - Gets invoice from db.invoices.get(id)
     - Gets lines from db.invoice_lines.where('invoice_id').equals(id).toArray()
     - Returns { ...invoice, lines }

  **Line Item Operations:**
  4. `async addLineItem(invoiceId, item)` - Adds line item to draft invoice:
     - Validates invoice is draft
     - item: { description, quantity, unit_price_cents, iva_rate, project_id (optional), sort_order }
     - Calculates line_total_cents = MoneyUtils.roundCents(quantity * unit_price_cents)
     - Stores with invoice_id, ...auditFields(true)
     - Recalculates invoice totals via calculateInvoiceTotals(invoiceId)
     - Queues to SyncQueue
     - Returns line item id

  5. `async updateLineItem(lineId, changes)` - Updates a line item:
     - Gets line, gets its invoice, validates invoice is draft
     - If quantity or unit_price_cents changed, recalculate line_total_cents
     - Updates line + auditFields(false)
     - Recalculates invoice totals
     - Returns updated line

  6. `async removeLineItem(lineId)` - Removes a line item:
     - Gets line, gets its invoice, validates invoice is draft
     - Deletes line from db.invoice_lines
     - Recalculates invoice totals
     - Queues to SyncQueue

  7. `async getLineItems(invoiceId)` - Gets all line items for invoice:
     - Query db.invoice_lines.where('invoice_id').equals(invoiceId).toArray()
     - Sort by sort_order then by id
     - Return sorted array

  **Calculations:**
  8. `async calculateInvoiceTotals(invoiceId)` - Recalculates and stores totals:
     - Gets all line items for invoice
     - Sum all line_total_cents = subtotalCents
     - Apply discount: if discount_type === 'percentage', discountCents = roundCents(subtotalCents * discount_value/100); if 'fixed', discountCents = discount_value
     - discountedSubtotal = subtotalCents - discountCents
     - Get client for IVA treatment, ivaCents = MoneyUtils.calculateIVA(discountedSubtotal, treatment.rate)
     - If irpf_rate > 0: irpfCents = roundCents(discountedSubtotal * irpf_rate/100)
     - totalCents = discountedSubtotal + ivaCents - irpfCents
     - Update invoice record with subtotal_cents, iva_cents, irpf_cents, total_cents + auditFields(false)
     - Return { subtotalCents, discountCents, ivaCents, irpfCents, totalCents }

  9. `getIVATreatment(clientCategory)` - Returns IVA_TREATMENT entry for category (synchronous)

  10. `async fetchExchangeRate(fromCurrency, toCurrency = 'EUR')` - Fetches rate from Frankfurter API:
      - If same currency, return 1
      - Fetch from https://api.frankfurter.dev/v1/latest?base={from}&symbols={to}
      - Return rate or null on error (fallback to manual entry)

  **Status Workflow:**
  11. `async markAsSent(invoiceId, dateSent)` - Draft -> Sent:
      - Validate invoice is draft
      - Update status to 'sent', date_sent = dateSent || today ISO
      - Queue to SyncQueue
      - Return updated invoice

  12. `async recordPayment(invoiceId, paymentData)` - Records payment:
      - paymentData: { amount_cents, date, method ('transfer'|'card'|'cash'|'other'), reference }
      - Validate invoice status is 'sent' or already has partial payments
      - Add record to db.invoice_payments
      - Update invoice.paid_cents += amount_cents
      - If paid_cents >= total_cents, update status to 'paid'
      - Queue both to SyncQueue
      - Return payment id

  13. `async getPayments(invoiceId)` - Gets payment records:
      - Query db.invoice_payments.where('invoice_id').equals(invoiceId).toArray()
      - Sort by date descending
      - Return array

  14. `isOverdue(invoice)` - Checks if invoice is overdue (synchronous):
      - Return false if status !== 'sent'
      - Return false if no date_due
      - Compare today ISO > date_due AND paid_cents < total_cents

  15. `async getOverdueInvoices(entityId)` - Gets all overdue invoices:
      - Get all sent invoices via getInvoices(entityId, { status: 'sent' })
      - Filter by isOverdue()
      - Return array

  **VeriFactu:**
  16. `generateVeriFactuQRUrl(invoice, entity)` - Generates AEAT QR URL (synchronous):
      - Base URL: https://www2.agenciatributaria.gob.es/wlpl/TIKE-CONT/ValidarQR
      - Params: nif=entity.nif_cif, numserie=invoice.invoice_number, fecha=DD-MM-YYYY format, importe=total in euros with "." decimal 2 places
      - Return full URL string

  17. `_formatDateDDMMYYYY(isoDate)` - Helper: converts YYYY-MM-DD to DD-MM-YYYY

  **Income Tracking:**
  18. `async getTotalIncome(entityId, options = {})` - Sums paid invoice totals:
      - Options: { startDate, endDate, clientId }
      - Query paid invoices for entity
      - Filter by date range and client if provided
      - Return { totalCents, count }

  IMPORTANT PATTERNS TO FOLLOW:
  - All monetary values in integer cents (use MoneyUtils)
  - Use auditFields(true) for create, auditFields(false) for update
  - Use SyncQueue.queueChange() for all mutations
  - Use EntityContext.entityId for current entity
  - Follow the same coding style as ExpenseManager (around line 20225)
  </action>
  <verify>
  Search for "createInvoice" and confirm the method exists in InvoiceManager.
  Search for "calculateInvoiceTotals" and confirm it uses MoneyUtils.
  Search for "markAsSent" and confirm it checks status === 'draft'.
  Search for "recordPayment" and confirm it updates paid_cents.
  Search for "generateVeriFactuQRUrl" and confirm correct AEAT URL.
  Open in browser -- no console errors on page load.
  </verify>
  <done>InvoiceManager extended with 18 new methods covering CRUD, line items, calculations, status workflow, payments, VeriFactu QR, and income tracking. All methods use MoneyUtils for cents arithmetic and follow established codebase patterns.</done>
</task>

</tasks>

<verification>
- IVA_TREATMENT[CLIENT_CATEGORY.EU_B2B].rate === 0
- IVA_TREATMENT[CLIENT_CATEGORY.SPAIN].rate === 0.21
- InvoiceManager.createInvoice() returns {id, invoice_number} with F-series format
- InvoiceManager.updateInvoice() throws on non-draft invoices
- InvoiceManager.markAsSent() transitions draft to sent
- InvoiceManager.recordPayment() updates paid_cents and auto-transitions to paid when fully paid
- InvoiceManager.isOverdue() returns true for sent invoice past due date
- InvoiceManager.calculateInvoiceTotals() correctly applies discount before IVA
- Dexie opens without errors at version 4
- No console errors on page load
</verification>

<success_criteria>
All InvoiceManager methods exist and are syntactically valid. IVA_TREATMENT maps all 5 client categories. Dexie version 4 includes invoice_payments table. Page loads without errors. Foundation ready for UI plans.
</success_criteria>

<output>
After completion, create `.planning/phases/18-invoice-generation/18-01-SUMMARY.md`
</output>
