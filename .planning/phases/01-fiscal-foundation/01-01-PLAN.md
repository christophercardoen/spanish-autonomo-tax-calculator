---
phase: 01-fiscal-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "User enters gross monthly revenue and sees correct annual IRPF calculated"
    - "Progressive tax brackets (19%, 24%, 30%, 37%, 45%, 47%) are applied correctly"
    - "RETA cuota of 428.40 EUR/month is deducted before IRPF calculation"
    - "Minimo personal (5550 EUR) and minimo descendientes (2400 EUR) reduce tax via 4-phase method"
    - "5% gastos dificil justificacion applies with 2000 EUR cap"
    - "Effective tax rate and net income display correctly"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Single-file HTML with IRPF/RETA calculation engine"
      min_lines: 200
      contains:
        - "FISCAL_2025"
        - "applyBrackets"
        - "calculateCuotaIntegra"
  key_links:
    - from: "User input (monthly revenue)"
      to: "IRPF calculation output"
      via: "calculateFullIRPF function"
      pattern: "calculateFullIRPF\\("
    - from: "Base liquidable"
      to: "Cuota integra"
      via: "4-phase minimo application"
      pattern: "calculateCuotaIntegra\\(baseLiquidable.*minimoTotal\\)"
---

<objective>
Build the core IRPF and RETA calculation engine for Spanish autonomo tax liability.

Purpose: This is the fiscal foundation - all downstream features (scenarios, comparisons, Excel export) depend on having accurate, verified tax calculations. Getting this wrong means everything downstream is wrong.

Output: Single HTML file (autonomo_dashboard.html) with working JavaScript calculation engine and basic UI to demonstrate calculations work correctly.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/REQUIREMENTS.md
@.planning/ROADMAP.md
@.planning/phases/01-fiscal-foundation/01-RESEARCH.md
@.planning/research/FISCAL_DATA.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FISCAL_2025 constants with verified rates</name>
  <files>autonomo_dashboard.html</files>
  <action>
Create the single-file HTML structure with embedded JavaScript containing all fiscal constants.

**Structure:**
```html
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Autonomo Tax Calculator - 2025/2026</title>
  <style>
    /* Minimal styling for now - Phase 5 adds full dashboard */
    :root {
      --bg: #1a1a2e;
      --text: #eaeaea;
      --accent: #4ade80;
    }
    body {
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 2rem;
    }
    .container { max-width: 800px; margin: 0 auto; }
    input { padding: 0.5rem; font-size: 1rem; width: 150px; }
    button { padding: 0.5rem 1rem; cursor: pointer; }
    .result { margin-top: 1rem; font-family: monospace; }
    .breakdown { margin-left: 1rem; font-size: 0.9rem; opacity: 0.8; }
  </style>
</head>
<body>
  <div class="container">
    <!-- UI added in Task 3 -->
  </div>
  <script>
    // Fiscal constants here
  </script>
</body>
</html>
```

**FISCAL_2025 constant (use Object.freeze for immutability):**

```javascript
const FISCAL_2025 = Object.freeze({
  // IRPF Brackets - Combined estatal + autonomica rates
  // Source: Wolters Kluwer, AEAT - unchanged from 2024
  IRPF_BRACKETS: Object.freeze([
    { upTo: 12450, rate: 0.19, baseTax: 0, prevLimit: 0 },
    { upTo: 20200, rate: 0.24, baseTax: 2365.50, prevLimit: 12450 },
    { upTo: 35200, rate: 0.30, baseTax: 4225.50, prevLimit: 20200 },
    { upTo: 60000, rate: 0.37, baseTax: 8725.50, prevLimit: 35200 },
    { upTo: 300000, rate: 0.45, baseTax: 17901.50, prevLimit: 60000 },
    { upTo: Infinity, rate: 0.47, baseTax: 125901.50, prevLimit: 300000 }
  ]),

  // Personal/Family minimums
  // Source: AEAT Manual Practico IRPF 2024
  MINIMO_PERSONAL: 5550,
  MINIMO_DESCENDIENTES_PRIMERO: 2400,

  // Fixed RETA from user registration
  RETA_MONTHLY: 428.40,
  RETA_ANNUAL: 5140.80,

  // Gastos dificil justificacion
  // Source: AEAT Estimacion Directa Simplificada
  GASTOS_DIFICIL_RATE: 0.05,
  GASTOS_DIFICIL_MAX: 2000,

  // Private costs (fixed, not deductible)
  PRIVATE_COSTS_MONTHLY: 1727
});
```

**Key implementation notes:**
- baseTax values are cumulative tax from all lower brackets
- Bracket boundaries use exclusive upper bound (12450 means up to and including 12450)
- All currency values in EUR
- RETA is FIXED at 428.40/month - do NOT calculate dynamically
  </action>
  <verify>
Open autonomo_dashboard.html in browser, open console, type `FISCAL_2025` and verify:
- IRPF_BRACKETS has 6 entries with correct rates (19, 24, 30, 37, 45, 47)
- MINIMO_PERSONAL is 5550
- RETA_MONTHLY is 428.40
- Object is frozen (cannot be modified)
  </verify>
  <done>FISCAL_2025 constant exists with all verified fiscal data, frozen and accessible in browser console</done>
</task>

<task type="auto">
  <name>Task 2: Implement IRPF calculation functions with 4-phase minimo method</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add the calculation functions to the script section.

**CRITICAL: Use 4-phase minimo application method from research.**

The minimos (personal + descendientes) do NOT reduce the taxable base. Instead:
1. Calculate tax on full base liquidable
2. Calculate tax on minimo amount
3. Subtract #2 from #1 to get cuota integra

**CALC-05 Clarification (7% reduccion rendimientos):**

The "7% reduccion rendimientos" referenced in CALC-05 applies to RETA base calculation for Social Security purposes, NOT to IRPF calculation. Per 01-RESEARCH.md:

> "CALC-05 clarified: 7% is for RETA, not IRPF - The '7% reduccion rendimientos' applies only when calculating the RETA base for Social Security. For IRPF purposes, the actual RETA cuota paid (428.40 EUR/month) is deducted as an expense."

Since the user has a FIXED RETA cuota from registration (428.40 EUR/month = 5,140.80 EUR/year), we do NOT need to implement dynamic RETA calculation with the 7% reduction. The RETA cuota is predetermined by Social Security based on the user's declared tramo.

For IRPF purposes, we simply deduct the actual RETA cuota paid as a business expense (implemented in calculateFullIRPF below via FISCAL_2025.RETA_ANNUAL). This satisfies CALC-05's intent: RETA is properly handled as a deduction before IRPF calculation.

**Functions to implement:**

```javascript
// Apply progressive brackets to any amount
function applyBrackets(amount) {
  if (amount <= 0) return 0;

  for (const bracket of FISCAL_2025.IRPF_BRACKETS) {
    if (amount <= bracket.upTo) {
      return Math.round((bracket.baseTax + (amount - bracket.prevLimit) * bracket.rate) * 100) / 100;
    }
  }
  // Fallback (should never reach with Infinity bound)
  const last = FISCAL_2025.IRPF_BRACKETS[FISCAL_2025.IRPF_BRACKETS.length - 1];
  return Math.round((last.baseTax + (amount - last.prevLimit) * last.rate) * 100) / 100;
}

// 4-phase method: minimos reduce TAX, not BASE
function calculateCuotaIntegra(baseLiquidable, minimoTotal) {
  const cuota1 = applyBrackets(baseLiquidable);
  const minimoApplicable = Math.min(minimoTotal, baseLiquidable);
  const cuota3 = applyBrackets(minimoApplicable);
  return Math.max(0, Math.round((cuota1 - cuota3) * 100) / 100);
}

// Calculate gastos dificil justificacion (5%, max 2000)
function calculateGastosDificil(rendimientoNetoPrevio) {
  if (rendimientoNetoPrevio <= 0) return 0;
  const calculated = rendimientoNetoPrevio * FISCAL_2025.GASTOS_DIFICIL_RATE;
  return Math.round(Math.min(calculated, FISCAL_2025.GASTOS_DIFICIL_MAX) * 100) / 100;
}

// Main calculation function - returns all intermediate values
// Note: RETA is deducted as FIXED cuota (428.40/month) per CALC-05 clarification
// The 7% reduccion applies to RETA base calculation (Social Security), not IRPF
function calculateFullIRPF(monthlyRevenue, monthlyDeductibleExpenses = 0, hasDescendant = true) {
  // Step 1: Annualize inputs
  const annualRevenue = monthlyRevenue * 12;
  const annualExpenses = monthlyDeductibleExpenses * 12;

  // Step 2: Total deductible = expenses + RETA (fixed cuota, not calculated)
  // CALC-05: RETA cuota is deducted as expense. The 7% reduccion is for SS, not IRPF.
  const totalDeductible = annualExpenses + FISCAL_2025.RETA_ANNUAL;

  // Step 3: Rendimiento Neto Previo (before gastos dificil)
  const rendimientoNetoPrevio = annualRevenue - totalDeductible;

  // Step 4: Gastos dificil justificacion
  const gastosDificil = calculateGastosDificil(rendimientoNetoPrevio);

  // Step 5: Rendimiento Neto = Base Liquidable (for autonomo)
  const rendimientoNeto = rendimientoNetoPrevio - gastosDificil;
  const baseLiquidable = Math.max(0, rendimientoNeto);

  // Step 6: Calculate minimos
  const minimoPersonal = FISCAL_2025.MINIMO_PERSONAL;
  const minimoDescendientes = hasDescendant ? FISCAL_2025.MINIMO_DESCENDIENTES_PRIMERO : 0;
  const minimoTotal = minimoPersonal + minimoDescendientes;

  // Step 7: Cuota Integra using 4-phase method
  const cuotaIntegra = calculateCuotaIntegra(baseLiquidable, minimoTotal);

  // Step 8: Effective tax rate
  const effectiveRate = rendimientoNeto > 0 ? (cuotaIntegra / rendimientoNeto) : 0;

  // Step 9: Net income calculations
  const netAnnual = annualRevenue - totalDeductible - gastosDificil - cuotaIntegra;
  const netMonthly = netAnnual / 12;

  // Step 10: Leefgeld (after private costs)
  const leefgeld = netMonthly - FISCAL_2025.PRIVATE_COSTS_MONTHLY;

  return {
    // Inputs
    monthlyRevenue,
    annualRevenue,
    monthlyExpenses: monthlyDeductibleExpenses,
    annualExpenses,

    // Deductions
    retaMonthly: FISCAL_2025.RETA_MONTHLY,
    retaAnnual: FISCAL_2025.RETA_ANNUAL,
    totalDeductible,

    // Calculation chain
    rendimientoNetoPrevio,
    gastosDificil,
    rendimientoNeto,
    baseLiquidable,

    // Minimos (for display)
    minimoPersonal,
    minimoDescendientes,
    minimoTotal,

    // Tax
    cuotaIntegra,
    effectiveRate,

    // Net income
    netAnnual,
    netMonthly,
    leefgeld,

    // Private costs (for reference)
    privateCostsMonthly: FISCAL_2025.PRIVATE_COSTS_MONTHLY
  };
}

// EUR formatting
function formatEUR(amount) {
  return new Intl.NumberFormat('es-ES', {
    style: 'currency',
    currency: 'EUR',
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(amount);
}

// Percentage formatting
function formatPercent(decimal) {
  return new Intl.NumberFormat('es-ES', {
    style: 'percent',
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(decimal);
}
```

**Anti-patterns to avoid (from research):**
- DO NOT subtract minimos from base liquidable before applying brackets
- DO NOT apply 7% reduction to IRPF calculation (that's for RETA base, user has fixed cuota)
- DO NOT mix annual/monthly without explicit conversion
- Round all currency to 2 decimal places to avoid floating point issues
  </action>
  <verify>
In browser console, run these verification tests:

```javascript
// Test 1: Bracket boundaries
console.log('Bracket test 12450:', applyBrackets(12450)); // Should be 2365.50
console.log('Bracket test 20200:', applyBrackets(20200)); // Should be 4225.50
console.log('Bracket test 35200:', applyBrackets(35200)); // Should be 8725.50

// Test 2: Minimo effect
const result = calculateFullIRPF(6000, 0, true);
console.log('6K/month result:', result);
// Expected: cuotaIntegra around 7000-8000 EUR for 72K annual revenue minus RETA

// Test 3: Gastos dificil cap
const highResult = calculateFullIRPF(15000, 0, true);
console.log('High income gastos dificil:', highResult.gastosDificil);
// Should be capped at 2000 EUR

// Test 4: RETA deduction (CALC-05)
console.log('RETA annual deduction:', result.retaAnnual);
// Should be 5140.80 EUR (fixed cuota, not calculated with 7%)
```
  </verify>
  <done>
All calculation functions work correctly:
- applyBrackets returns correct cumulative tax for any amount
- calculateCuotaIntegra uses 4-phase method (minimos reduce tax, not base)
- calculateGastosDificil applies 5% with 2000 EUR cap
- calculateFullIRPF returns complete breakdown with all intermediate values
- RETA is deducted as fixed cuota (CALC-05 satisfied - 7% is for SS, not IRPF)
  </done>
</task>

<task type="auto">
  <name>Task 3: Build minimal UI to demonstrate calculations</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add HTML form and results display to the container div.

**UI elements needed:**

```html
<div class="container">
  <h1>Autonomo Tax Calculator 2025/2026</h1>
  <p>Calculate your IRPF liability as a Spanish autonomo</p>

  <div class="input-section">
    <label>
      Monthly Revenue (EUR):
      <input type="number" id="monthlyRevenue" value="6000" min="0" step="100">
    </label>
    <label>
      Monthly Deductible Expenses (EUR):
      <input type="number" id="monthlyExpenses" value="0" min="0" step="50">
    </label>
    <label>
      <input type="checkbox" id="hasDescendant" checked>
      1 Dependent Child (adds 2,400 EUR minimo)
    </label>
    <button onclick="calculate()">Calculate</button>
  </div>

  <div id="results" class="result"></div>
</div>
```

**JavaScript calculate() function:**

```javascript
function calculate() {
  const monthlyRevenue = parseFloat(document.getElementById('monthlyRevenue').value) || 0;
  const monthlyExpenses = parseFloat(document.getElementById('monthlyExpenses').value) || 0;
  const hasDescendant = document.getElementById('hasDescendant').checked;

  const r = calculateFullIRPF(monthlyRevenue, monthlyExpenses, hasDescendant);

  const html = `
    <h2>Results</h2>

    <h3>Income</h3>
    <div class="breakdown">
      Monthly Revenue: ${formatEUR(r.monthlyRevenue)}<br>
      Annual Revenue: ${formatEUR(r.annualRevenue)}
    </div>

    <h3>Deductions</h3>
    <div class="breakdown">
      RETA (Seguridad Social): ${formatEUR(r.retaAnnual)} (${formatEUR(r.retaMonthly)}/month)<br>
      Business Expenses: ${formatEUR(r.annualExpenses)}<br>
      <strong>Total Deductible: ${formatEUR(r.totalDeductible)}</strong>
    </div>

    <h3>IRPF Calculation</h3>
    <div class="breakdown">
      Rendimiento Neto Previo: ${formatEUR(r.rendimientoNetoPrevio)}<br>
      Gastos Dificil Justificacion (5%, max 2000): ${formatEUR(r.gastosDificil)}<br>
      <strong>Rendimiento Neto / Base Liquidable: ${formatEUR(r.baseLiquidable)}</strong>
    </div>

    <h3>Minimos (reduce tax, not base)</h3>
    <div class="breakdown">
      Minimo Personal: ${formatEUR(r.minimoPersonal)}<br>
      Minimo por Descendientes: ${formatEUR(r.minimoDescendientes)}<br>
      <strong>Total Minimos: ${formatEUR(r.minimoTotal)}</strong>
    </div>

    <h3>Tax</h3>
    <div class="breakdown">
      <strong>Cuota Integra (Annual IRPF): ${formatEUR(r.cuotaIntegra)}</strong><br>
      Effective Tax Rate: ${formatPercent(r.effectiveRate)}
    </div>

    <h3>Net Income</h3>
    <div class="breakdown">
      Annual Net: ${formatEUR(r.netAnnual)}<br>
      <strong>Monthly Net: ${formatEUR(r.netMonthly)}</strong><br>
      <hr>
      Private Costs: ${formatEUR(r.privateCostsMonthly)}/month<br>
      <strong style="color: var(--accent);">Leefgeld (after all costs): ${formatEUR(r.leefgeld)}/month</strong>
    </div>
  `;

  document.getElementById('results').innerHTML = html;
}

// Calculate on page load
document.addEventListener('DOMContentLoaded', calculate);
```

**Styling additions for readability:**

```css
.input-section {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  margin-bottom: 2rem;
}
.input-section label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
h2 { color: var(--accent); margin-top: 2rem; }
h3 { margin-top: 1.5rem; margin-bottom: 0.5rem; opacity: 0.9; }
hr { border: none; border-top: 1px solid rgba(255,255,255,0.2); margin: 0.5rem 0; }
```
  </action>
  <verify>
1. Open autonomo_dashboard.html in browser
2. Default values (6000 EUR/month, 0 expenses, 1 child) should auto-calculate on load
3. Verify results show:
   - Annual revenue: 72,000 EUR
   - RETA deduction: 5,140.80 EUR
   - Gastos dificil shown (should be capped at 2000 for high income)
   - Minimos total: 7,950 EUR (5550 + 2400)
   - Cuota integra calculated
   - Monthly net and leefgeld displayed
4. Change values and click Calculate - results update
5. Uncheck "1 Dependent Child" - minimo descendientes becomes 0, tax increases
  </verify>
  <done>
Working UI exists that:
- Accepts monthly revenue and expenses input
- Has toggle for descendant (child) minimo
- Displays complete step-by-step IRPF calculation
- Shows annual and monthly breakdowns (CALC-10)
- Updates on Calculate button click
  </done>
</task>

</tasks>

<verification>
## Phase Verification

After all tasks complete, verify against success criteria:

1. **User enters gross monthly revenue and sees correct annual IRPF using progressive brackets (19%-47%)**
   - Enter 6000 EUR/month
   - Annual revenue shows 72,000 EUR
   - Cuota integra shows calculated IRPF amount using correct brackets

2. **RETA deduction of 428.40 EUR/month appears correctly in calculations**
   - RETA section shows 5,140.80 EUR/year (428.40 x 12)
   - This is subtracted before IRPF calculation

3. **Minimo personal (5,550 EUR) and minimo por descendientes (2,400 EUR) reduce taxable base correctly**
   - Minimos section shows 5,550 + 2,400 = 7,950 EUR total
   - Note: These reduce TAX, not base (4-phase method)

4. **5% gastos de dificil justificacion applies with 2,000 EUR annual cap visible**
   - For 6000/month (66,859 rendimiento neto previo): 5% = 3,342 -> capped at 2,000 EUR
   - Shows calculation with cap applied

5. **All fiscal data shows source citations (AEAT/BOE references) in the UI**
   - THIS IS PLAN 01-02 - not required for this plan
   - Plan 01-02 will add source citations

6. **CALC-05 (7% reduccion) interpretation**
   - Per research: 7% applies to RETA base (Social Security), NOT IRPF
   - User has fixed RETA cuota (428.40/month) from registration
   - RETA is properly deducted as expense (5,140.80/year)
   - No dynamic RETA calculation needed - cuota is predetermined

Run this calculation test:
```
Input: 6000 EUR/month, 0 expenses, 1 child
Expected (approximate):
- Annual revenue: 72,000 EUR
- RETA: 5,140.80 EUR
- Rendimiento neto previo: 66,859.20 EUR
- Gastos dificil: 2,000 EUR (capped)
- Base liquidable: 64,859.20 EUR
- Minimos: 7,950 EUR
- Cuota integra: ~15,000-16,000 EUR (verify exact calculation)
- Effective rate: ~23-25%
```
</verification>

<success_criteria>
- [ ] autonomo_dashboard.html exists and loads without JavaScript errors
- [ ] FISCAL_2025 constant contains all verified rates from research
- [ ] applyBrackets(12450) returns 2365.50 EUR (first bracket boundary)
- [ ] calculateCuotaIntegra uses 4-phase method (minimos reduce tax, not base)
- [ ] calculateGastosDificil caps at 2000 EUR for high incomes
- [ ] UI shows complete IRPF breakdown with all intermediate values
- [ ] Both annual and monthly views available (CALC-10)
- [ ] Leefgeld calculation shows net after private costs (CALC-09)
- [ ] Effective tax rate displays correctly (CALC-07)
- [ ] RETA deducted as fixed cuota (CALC-05 - 7% is for SS base, not IRPF)
</success_criteria>

<output>
After completion, create `.planning/phases/01-fiscal-foundation/01-01-SUMMARY.md`
</output>
