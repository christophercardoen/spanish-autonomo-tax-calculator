---
phase: 01-fiscal-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "Every fiscal number in the UI has a visible source citation"
    - "IRPF brackets show AEAT/BOE reference"
    - "Minimos show AEAT Manual Practico reference"
    - "RETA cuota shows registration document reference"
    - "Gastos dificil shows AEAT Estimacion Directa Simplificada reference"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Calculator with source citations visible in UI"
      contains:
        - "SOURCES"
        - "AEAT"
        - "BOE"
        - "data-source"
  key_links:
    - from: "FISCAL_2025 constants"
      to: "SOURCES constant"
      via: "Source ID references"
      pattern: "SOURCES\\["
    - from: "UI display elements"
      to: "Source citations"
      via: "data-source attributes or info icons"
      pattern: "data-source|sourceHint"
---

<objective>
Add official source citations to all fiscal data displayed in the calculator UI.

Purpose: Tax calculations must be traceable to official government sources (AEAT, BOE, Seguridad Social) to build user confidence and enable verification. This satisfies DATA-01 through DATA-05 requirements.

Output: Updated autonomo_dashboard.html with source citations visible on hover or in footnotes for all fiscal values.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-fiscal-foundation/01-RESEARCH.md
@.planning/research/FISCAL_DATA.md
@.planning/phases/01-fiscal-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SOURCES constant with official references</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add a SOURCES constant alongside FISCAL_2025 that maps each fiscal data point to its official source.

**Add after FISCAL_2025 constant:**

```javascript
// Official source citations for all fiscal data
const SOURCES = Object.freeze({
  IRPF_BRACKETS: {
    name: "IRPF Tramos 2025",
    source: "AEAT / Wolters Kluwer",
    url: "https://www.wolterskluwer.com/es-es/expert-insights/tramos-retenciones-irpf-2025-novedades",
    note: "Unchanged from 2024. Combined estatal + autonomica rates.",
    confidence: "HIGH"
  },
  MINIMO_PERSONAL: {
    name: "Minimo del Contribuyente",
    source: "AEAT Manual Practico IRPF 2024",
    url: "https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2024/c14-adecuacion-impuesto-circunstancias-personales/cuadro-resumen-minimo-personal-familiar.html",
    note: "5,550 EUR for all taxpayers regardless of age.",
    confidence: "HIGH"
  },
  MINIMO_DESCENDIENTES: {
    name: "Minimo por Descendientes",
    source: "AEAT",
    url: "https://sede.agenciatributaria.gob.es/Sede/ciudadanos-familias-personas-discapacidad/minimo-personal-familiar/minimo-descendientes.html",
    note: "2,400 EUR for first child. Add 2,800 EUR if under 3 years old.",
    confidence: "HIGH"
  },
  RETA: {
    name: "Cuota RETA",
    source: "User registration document",
    url: "https://www.boe.es/diario_boe/txt.php?id=BOE-A-2025-3780",
    note: "Fixed cuota 428.40 EUR/month from autonomo registration.",
    confidence: "HIGH"
  },
  GASTOS_DIFICIL: {
    name: "Gastos de Dificil Justificacion",
    source: "AEAT Estimacion Directa Simplificada",
    url: "https://sede.agenciatributaria.gob.es/Sede/irpf/empresarios-individuales-profesionales/regimenes-determinar-rendimiento-actividad/estimacion-directa-simplificada.html",
    note: "5% of rendimiento neto, maximum 2,000 EUR/year. Was 7% only in 2023.",
    confidence: "HIGH"
  },
  MINIMO_APPLICATION: {
    name: "4-Phase Minimo Method",
    source: "AEAT Cuotas Integras Example",
    url: "https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2022/c15-calculo-impuesto-determinacion-cuotas-integras/ejemplo-practico-calculo-cuotas-integras-autonomica.html",
    note: "Minimos reduce TAX LIABILITY, not taxable base. Tax on minimo is subtracted from tax on full base.",
    confidence: "HIGH"
  }
});
```

This creates a single source of truth for all citations that can be referenced throughout the UI.
  </action>
  <verify>
In browser console:
```javascript
console.log(SOURCES.IRPF_BRACKETS.source); // "AEAT / Wolters Kluwer"
console.log(SOURCES.MINIMO_PERSONAL.url);  // AEAT URL
console.log(Object.keys(SOURCES).length);   // 6 sources
```
  </verify>
  <done>SOURCES constant exists with official references for all fiscal data points</done>
</task>

<task type="auto">
  <name>Task 2: Add source citation UI component and styling</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add CSS and JavaScript for displaying source citations as info icons with tooltips.

**Add to CSS section:**

```css
/* Source citation styling */
.source-hint {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 16px;
  height: 16px;
  margin-left: 4px;
  background: rgba(74, 222, 128, 0.2);
  border: 1px solid var(--accent);
  border-radius: 50%;
  font-size: 10px;
  color: var(--accent);
  cursor: help;
  position: relative;
  vertical-align: middle;
}

.source-hint:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: #2d2d44;
  border: 1px solid var(--accent);
  padding: 0.5rem 0.75rem;
  border-radius: 4px;
  font-size: 11px;
  white-space: nowrap;
  max-width: 300px;
  white-space: normal;
  z-index: 100;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.source-hint:hover::before {
  content: '';
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%) translateY(8px);
  border: 6px solid transparent;
  border-top-color: var(--accent);
  z-index: 101;
}

/* Footnotes section */
.footnotes {
  margin-top: 3rem;
  padding-top: 1rem;
  border-top: 1px solid rgba(255,255,255,0.1);
  font-size: 0.8rem;
  opacity: 0.7;
}

.footnotes h4 {
  margin-bottom: 1rem;
  color: var(--accent);
}

.footnotes ul {
  list-style: none;
  padding: 0;
}

.footnotes li {
  margin-bottom: 0.5rem;
}

.footnotes a {
  color: var(--accent);
  text-decoration: none;
}

.footnotes a:hover {
  text-decoration: underline;
}

.confidence-high { color: #4ade80; }
.confidence-medium { color: #facc15; }
```

**Add JavaScript helper function:**

```javascript
// Create source hint HTML
function sourceHint(sourceKey) {
  const s = SOURCES[sourceKey];
  if (!s) return '';
  const tooltip = `${s.source}: ${s.note}`;
  return `<span class="source-hint" data-tooltip="${tooltip.replace(/"/g, '&quot;')}" data-source="${sourceKey}">i</span>`;
}

// Create footnotes section HTML
function createFootnotes() {
  let html = '<div class="footnotes"><h4>Sources</h4><ul>';
  for (const [key, s] of Object.entries(SOURCES)) {
    html += `<li>
      <strong>${s.name}</strong> -
      <a href="${s.url}" target="_blank" rel="noopener">${s.source}</a>
      <span class="confidence-${s.confidence.toLowerCase()}">[${s.confidence}]</span>
    </li>`;
  }
  html += '</ul></div>';
  return html;
}
```
  </action>
  <verify>
1. Open browser, check that CSS is applied (no console errors)
2. In console, run: `sourceHint('IRPF_BRACKETS')` - should return HTML string with tooltip
3. In console, run: `createFootnotes()` - should return HTML list of all sources
  </verify>
  <done>Source citation components ready: sourceHint() function and footnotes generator</done>
</task>

<task type="auto">
  <name>Task 3: Integrate source citations into results display</name>
  <files>autonomo_dashboard.html</files>
  <action>
Update the calculate() function's result HTML to include source hints on all fiscal values.

**Update the results HTML generation in calculate():**

```javascript
function calculate() {
  const monthlyRevenue = parseFloat(document.getElementById('monthlyRevenue').value) || 0;
  const monthlyExpenses = parseFloat(document.getElementById('monthlyExpenses').value) || 0;
  const hasDescendant = document.getElementById('hasDescendant').checked;

  const r = calculateFullIRPF(monthlyRevenue, monthlyExpenses, hasDescendant);

  const html = `
    <h2>Results</h2>

    <h3>Income</h3>
    <div class="breakdown">
      Monthly Revenue: ${formatEUR(r.monthlyRevenue)}<br>
      Annual Revenue: ${formatEUR(r.annualRevenue)}
    </div>

    <h3>Deductions</h3>
    <div class="breakdown">
      RETA (Seguridad Social): ${formatEUR(r.retaAnnual)} (${formatEUR(r.retaMonthly)}/month) ${sourceHint('RETA')}<br>
      Business Expenses: ${formatEUR(r.annualExpenses)}<br>
      <strong>Total Deductible: ${formatEUR(r.totalDeductible)}</strong>
    </div>

    <h3>IRPF Calculation ${sourceHint('IRPF_BRACKETS')}</h3>
    <div class="breakdown">
      Rendimiento Neto Previo: ${formatEUR(r.rendimientoNetoPrevio)}<br>
      Gastos Dificil Justificacion (5%, max 2000): ${formatEUR(r.gastosDificil)} ${sourceHint('GASTOS_DIFICIL')}<br>
      <strong>Rendimiento Neto / Base Liquidable: ${formatEUR(r.baseLiquidable)}</strong>
    </div>

    <h3>Minimos (reduce tax, not base) ${sourceHint('MINIMO_APPLICATION')}</h3>
    <div class="breakdown">
      Minimo Personal: ${formatEUR(r.minimoPersonal)} ${sourceHint('MINIMO_PERSONAL')}<br>
      Minimo por Descendientes: ${formatEUR(r.minimoDescendientes)} ${sourceHint('MINIMO_DESCENDIENTES')}<br>
      <strong>Total Minimos: ${formatEUR(r.minimoTotal)}</strong>
    </div>

    <h3>Tax</h3>
    <div class="breakdown">
      <strong>Cuota Integra (Annual IRPF): ${formatEUR(r.cuotaIntegra)}</strong><br>
      Effective Tax Rate: ${formatPercent(r.effectiveRate)}
    </div>

    <h3>Net Income</h3>
    <div class="breakdown">
      Annual Net: ${formatEUR(r.netAnnual)}<br>
      <strong>Monthly Net: ${formatEUR(r.netMonthly)}</strong><br>
      <hr>
      Private Costs: ${formatEUR(r.privateCostsMonthly)}/month<br>
      <strong style="color: var(--accent);">Leefgeld (after all costs): ${formatEUR(r.leefgeld)}/month</strong>
    </div>

    ${createFootnotes()}
  `;

  document.getElementById('results').innerHTML = html;
}
```

**Key placements of source hints:**
- RETA line: Shows registration document reference
- IRPF Calculation header: References bracket source
- Gastos Dificil line: Shows AEAT Estimacion Directa reference
- Minimos header: Explains 4-phase method
- Minimo Personal: AEAT Manual reference
- Minimo Descendientes: AEAT reference

**Add footnotes section at bottom of results**
  </action>
  <verify>
1. Open autonomo_dashboard.html in browser
2. Calculate results appear with (i) icons next to:
   - RETA amount
   - IRPF Calculation header
   - Gastos Dificil line
   - Minimos header
   - Minimo Personal
   - Minimo Descendientes
3. Hover over each (i) icon - tooltip appears with source info
4. Scroll to bottom - "Sources" section lists all official references with links
5. Click a source link - opens official AEAT/BOE page in new tab
  </verify>
  <done>
All fiscal values in UI have visible source citations:
- (i) icons with hover tooltips inline
- Complete footnotes section with clickable links
- Confidence levels indicated (all HIGH for core data)
  </done>
</task>

</tasks>

<verification>
## Phase Verification

After all tasks complete, verify DATA-01 through DATA-05 requirements:

**DATA-01: All fiscal data sourced from official 2025/2026 AEAT/BOE/Seguridad Social sources**
- Check SOURCES constant has official URLs for each data point
- All sources are AEAT, BOE, or Seguridad Social official sites

**DATA-02: Source citations visible in UI (footnotes or info boxes)**
- (i) icons appear next to fiscal values
- Hovering shows tooltip with source
- Footnotes section at bottom lists all sources

**DATA-03: IRPF tramos match official 2025 brackets exactly**
- Hover over IRPF Calculation - shows Wolters Kluwer / AEAT source
- Verify brackets: 19%, 24%, 30%, 37%, 45%, 47%

**DATA-04: Minimos match official 2025/2026 amounts**
- Minimo Personal shows 5,550 EUR with AEAT source
- Minimo Descendientes shows 2,400 EUR with AEAT source

**DATA-05: Dietas match official Reglamento IRPF rates**
- Note: Dietas are Phase 2 (expense tracking), but SOURCES constant is ready
- Can add DIETAS entry to SOURCES when implementing Phase 2

## Cross-check with Success Criteria from Roadmap

1. "All fiscal data shows source citations (AEAT/BOE references) in the UI" - VERIFIED
   - Every fiscal constant has visible source
   - Footnotes section provides full reference list
</verification>

<success_criteria>
- [ ] SOURCES constant exists with 6 official reference entries
- [ ] Each source has: name, source, url, note, confidence level
- [ ] sourceHint() function generates tooltip HTML
- [ ] createFootnotes() generates sources list HTML
- [ ] Results display includes (i) icons for all fiscal values
- [ ] Hovering (i) shows tooltip with source information
- [ ] Footnotes section appears at bottom of results
- [ ] All source URLs are clickable and open in new tab
- [ ] No broken links (all URLs resolve to official sites)
</success_criteria>

<output>
After completion, create `.planning/phases/01-fiscal-foundation/01-02-SUMMARY.md`
</output>
