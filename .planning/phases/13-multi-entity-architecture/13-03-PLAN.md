---
phase: 13-multi-entity-architecture
plan: 03
type: execute
wave: 2
depends_on: [13-01, 13-02]
files_modified: [autonomo_dashboard.html]
autonomous: true

must_haves:
  truths:
    - "User can create Autonomo entity with NIF, nombre, domicilio fiscal, IAE, fecha alta"
    - "User can create SL entity with CIF, razon social, domicilio social, Registro Mercantil, constitution date, capital"
    - "Created entity appears in IndexedDB entities table"
    - "Newly created entity auto-selected as current if it's the first entity"
    - "User can archive an entity (is_active = false)"
    - "Archived entity cannot be selected via EntityContext"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "EntityManager module and create entity modal"
      contains: "const EntityManager"
  key_links:
    - from: "EntityManager.createEntity()"
      to: "SpanishTaxIdValidator.validate()"
      via: "tax ID validation before save"
      pattern: "SpanishTaxIdValidator\\.validate"
    - from: "EntityManager.createEntity()"
      to: "db.entities.add()"
      via: "insert new entity record"
      pattern: "db\\.entities\\.add"
    - from: "EntityManager.archiveEntity()"
      to: "EntityContext"
      via: "switch away from archived entity"
      pattern: "EntityContext\\.setEntity|EntityContext\\.clear"
---

<objective>
Implement EntityManager CRUD operations and create entity modal form with entity-type-specific fields.

Purpose: Users need to create their business entities (Autonomo or SL) with all required Spanish legal data before they can create clients, invoices, or track expenses. The form adapts based on entity type selection.

Output: EntityManager module with createEntity, getEntity, getAllEntities, getActiveEntities, updateEntity, archiveEntity, restoreEntity methods. Modal form with type selection and dynamic fields.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-multi-entity-architecture/13-RESEARCH.md
@.planning/phases/13-multi-entity-architecture/13-01-SUMMARY.md
@.planning/phases/13-multi-entity-architecture/13-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement EntityManager CRUD module</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add after the EntityContext module:

```javascript
// =====================================================
// Entity Manager (CRUD Operations)
// =====================================================

const EntityManager = {
  // Create new entity (Autonomo or SL)
  async createEntity(entityData) {
    const { type, ...data } = entityData;

    // Validate entity type
    if (!Object.values(ENTITY_TYPE).includes(type)) {
      throw new Error(`Tipo de entidad inv√°lido: ${type}`);
    }

    // Validate tax ID based on type
    let taxIdField, validatedTaxId;
    if (type === ENTITY_TYPE.AUTONOMO) {
      const result = SpanishTaxIdValidator.validateNIF(data.nif);
      if (!result.valid) {
        throw new Error(`NIF inv√°lido: ${result.error}`);
      }
      validatedTaxId = result.formatted;
      taxIdField = 'nif';
    } else {
      const result = SpanishTaxIdValidator.validateCIF(data.cif);
      if (!result.valid) {
        throw new Error(`CIF inv√°lido: ${result.error}`);
      }
      validatedTaxId = result.formatted;
      taxIdField = 'cif';
    }

    // Check for duplicate tax ID
    const existing = await db.entities
      .where('nif_cif')
      .equals(validatedTaxId)
      .filter(e => !e.deleted_at)
      .first();

    if (existing) {
      throw new Error(`Ya existe una entidad con este ${taxIdField.toUpperCase()}`);
    }

    // Build entity record
    const entity = {
      type,
      nif_cif: validatedTaxId,
      name: data.name?.trim(),
      is_active: true,
      deleted_at: null,
      ...auditFields(true)
    };

    // Add type-specific fields
    if (type === ENTITY_TYPE.AUTONOMO) {
      entity.domicilio_fiscal = data.domicilio_fiscal?.trim() || '';
      entity.iae_codes = data.iae_codes || [];
      entity.iae_primary = data.iae_primary?.trim() || '';
      entity.fecha_alta = data.fecha_alta || null;
    } else {
      entity.domicilio_social = data.domicilio_social?.trim() || '';
      entity.registro_mercantil = {
        provincia: data.registro_mercantil?.provincia?.trim() || '',
        tomo: data.registro_mercantil?.tomo?.trim() || '',
        libro: data.registro_mercantil?.libro?.trim() || '',
        folio: data.registro_mercantil?.folio?.trim() || '',
        seccion: data.registro_mercantil?.seccion?.trim() || '',
        hoja: data.registro_mercantil?.hoja?.trim() || '',
        inscripcion: data.registro_mercantil?.inscripcion?.trim() || ''
      };
      entity.fecha_constitucion = data.fecha_constitucion || null;
      entity.capital_social_cents = data.capital_social_cents || 300000; // 3000 EUR minimum
    }

    // Insert entity
    const id = await db.entities.add(entity);

    // Queue for sync
    await SyncQueue.queueChange('entities', id, 'CREATE', entity);

    // Auto-select if first entity
    const entityCount = await db.entities
      .filter(e => !e.deleted_at && e.is_active)
      .count();

    if (entityCount === 1) {
      await EntityContext.setEntity(id);
    }

    return id;
  },

  // Get entity by ID
  async getEntity(entityId) {
    return db.entities.get(entityId);
  },

  // Get all entities (including archived, excluding deleted)
  async getAllEntities() {
    return db.entities
      .filter(e => !e.deleted_at)
      .toArray();
  },

  // Get only active (non-archived) entities
  async getActiveEntities() {
    return db.entities
      .filter(e => !e.deleted_at && e.is_active)
      .toArray();
  },

  // Get archived entities
  async getArchivedEntities() {
    return db.entities
      .filter(e => !e.deleted_at && !e.is_active)
      .toArray();
  },

  // Update entity
  async updateEntity(entityId, updates) {
    const entity = await this.getEntity(entityId);
    if (!entity) throw new Error('Entidad no encontrada');
    if (entity.deleted_at) throw new Error('Entidad eliminada');

    // If updating tax ID, validate it
    if (updates.nif || updates.cif) {
      const taxId = updates.nif || updates.cif;
      const result = SpanishTaxIdValidator.validate(taxId);
      if (!result.valid) {
        throw new Error(`Identificador fiscal inv√°lido: ${result.error}`);
      }
      updates.nif_cif = result.formatted;
    }

    // Apply updates
    const updatedFields = {
      ...updates,
      updated_at: new Date().toISOString()
    };

    await db.entities.update(entityId, updatedFields);
    await SyncQueue.queueChange('entities', entityId, 'UPDATE', updatedFields);

    // Refresh EntityContext if this is the current entity
    if (EntityContext.entityId === entityId) {
      const refreshed = await this.getEntity(entityId);
      // Force notify observers with updated data
      await EntityContext.setEntity(entityId);
    }

    return true;
  },

  // Archive entity (soft deactivate)
  async archiveEntity(entityId) {
    const entity = await this.getEntity(entityId);
    if (!entity) throw new Error('Entidad no encontrada');
    if (!entity.is_active) throw new Error('Entidad ya archivada');

    // If archiving current entity, switch to another
    if (EntityContext.entityId === entityId) {
      const otherEntity = await db.entities
        .filter(e => e.id !== entityId && !e.deleted_at && e.is_active)
        .first();

      if (otherEntity) {
        await EntityContext.setEntity(otherEntity.id);
      } else {
        EntityContext.clear();
      }
    }

    await db.entities.update(entityId, {
      is_active: false,
      updated_at: new Date().toISOString()
    });

    await SyncQueue.queueChange('entities', entityId, 'UPDATE', { is_active: false });
    return true;
  },

  // Restore archived entity
  async restoreEntity(entityId) {
    const entity = await this.getEntity(entityId);
    if (!entity) throw new Error('Entidad no encontrada');
    if (entity.is_active) throw new Error('Entidad ya est√° activa');
    if (entity.deleted_at) throw new Error('Entidad eliminada, no se puede restaurar');

    await db.entities.update(entityId, {
      is_active: true,
      updated_at: new Date().toISOString()
    });

    await SyncQueue.queueChange('entities', entityId, 'UPDATE', { is_active: true });
    return true;
  },

  // Permanently delete (only if within soft delete window - handled by DataManager)
  async deleteEntity(entityId) {
    return DataManager.softDelete('entities', entityId);
  }
};
```
  </action>
  <verify>
Console tests:
```javascript
// Create Autonomo entity
const autoId = await EntityManager.createEntity({
  type: ENTITY_TYPE.AUTONOMO,
  nif: '12345678Z',
  name: 'Juan Garc√≠a',
  domicilio_fiscal: 'Calle Mayor 1, Madrid',
  iae_primary: '841',
  fecha_alta: '2024-01-15'
});
console.log('Created Autonomo:', autoId);

// Verify auto-selected
console.log('Auto-selected:', EntityContext.entityId === autoId); // true

// Get entity
const auto = await EntityManager.getEntity(autoId);
console.log('Entity type:', auto.type); // 'autonomo'
console.log('NIF:', auto.nif_cif); // '12345678Z'

// Archive
await EntityManager.archiveEntity(autoId);
console.log('After archive, current:', EntityContext.entityId); // null (no other entities)

// Restore
await EntityManager.restoreEntity(autoId);
const restored = await EntityManager.getEntity(autoId);
console.log('Restored is_active:', restored.is_active); // true

// Cleanup
await db.entities.delete(autoId);
await db.settings.delete('current_entity_id');
await SyncQueue.clearQueue();
```
  </verify>
  <done>
- EntityManager.createEntity() validates type and tax ID, inserts record, auto-selects first entity
- EntityManager.archiveEntity() sets is_active=false, switches away if current
- EntityManager.restoreEntity() sets is_active=true
- All operations queue changes for sync
- Duplicate tax ID detection prevents duplicate entities
  </done>
</task>

<task type="auto">
  <name>Task 2: Create entity modal form with dynamic fields</name>
  <files>autonomo_dashboard.html</files>
  <action>
1. Add CSS for the entity creation modal (in the style section, around line 500):

```css
/* Entity Creation Modal */
.entity-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.2s, visibility 0.2s;
}

.entity-modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.entity-modal {
  background: var(--card-bg, #1a1a1a);
  border: 1px solid var(--border-color, #333);
  border-radius: 12px;
  width: 90%;
  max-width: 560px;
  max-height: 90vh;
  overflow-y: auto;
  transform: translateY(-20px);
  transition: transform 0.2s;
}

.entity-modal-overlay.active .entity-modal {
  transform: translateY(0);
}

.entity-modal__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 24px;
  border-bottom: 1px solid var(--border-color, #333);
}

.entity-modal__title {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary, #fff);
  margin: 0;
}

.entity-modal__close {
  background: transparent;
  border: none;
  color: var(--text-secondary, #888);
  font-size: 24px;
  cursor: pointer;
  padding: 4px;
  line-height: 1;
}

.entity-modal__close:hover {
  color: var(--text-primary, #fff);
}

.entity-modal__body {
  padding: 24px;
}

.entity-modal__section {
  margin-bottom: 24px;
}

.entity-modal__section-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary, #888);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 16px;
}

.entity-type-selector {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.entity-type-option {
  padding: 16px;
  border: 2px solid var(--border-color, #333);
  border-radius: 8px;
  cursor: pointer;
  transition: border-color 0.15s, background-color 0.15s;
  text-align: center;
}

.entity-type-option:hover {
  border-color: var(--accent-color, #3b82f6);
  background: rgba(59, 130, 246, 0.1);
}

.entity-type-option.selected {
  border-color: var(--accent-color, #3b82f6);
  background: rgba(59, 130, 246, 0.15);
}

.entity-type-option__icon {
  font-size: 32px;
  margin-bottom: 8px;
}

.entity-type-option__name {
  font-weight: 600;
  color: var(--text-primary, #fff);
  margin-bottom: 4px;
}

.entity-type-option__desc {
  font-size: 12px;
  color: var(--text-secondary, #888);
}

.entity-form__group {
  margin-bottom: 16px;
}

.entity-form__label {
  display: block;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary, #888);
  margin-bottom: 6px;
}

.entity-form__label--required::after {
  content: ' *';
  color: var(--danger-color, #ef4444);
}

.entity-form__input,
.entity-form__select {
  width: 100%;
  padding: 10px 12px;
  background: var(--input-bg, #252525);
  border: 1px solid var(--border-color, #333);
  border-radius: 6px;
  color: var(--text-primary, #fff);
  font-size: 14px;
  font-family: inherit;
}

.entity-form__input:focus,
.entity-form__select:focus {
  outline: none;
  border-color: var(--accent-color, #3b82f6);
}

.entity-form__input.invalid {
  border-color: var(--danger-color, #ef4444);
}

.entity-form__input.valid {
  border-color: var(--success-color, #22c55e);
}

.entity-form__error {
  font-size: 12px;
  color: var(--danger-color, #ef4444);
  margin-top: 4px;
}

.entity-form__hint {
  font-size: 12px;
  color: var(--text-tertiary, #666);
  margin-top: 4px;
}

.entity-form__row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.entity-form__row--3 {
  grid-template-columns: 1fr 1fr 1fr;
}

.entity-modal__footer {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  padding: 16px 24px;
  border-top: 1px solid var(--border-color, #333);
}

.entity-modal__btn {
  padding: 10px 20px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.15s;
}

.entity-modal__btn--secondary {
  background: transparent;
  border: 1px solid var(--border-color, #333);
  color: var(--text-secondary, #888);
}

.entity-modal__btn--secondary:hover {
  background: var(--bg-hover, #252525);
  color: var(--text-primary, #fff);
}

.entity-modal__btn--primary {
  background: var(--accent-color, #3b82f6);
  border: none;
  color: #fff;
}

.entity-modal__btn--primary:hover {
  background: var(--accent-hover, #2563eb);
}

.entity-modal__btn--primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Registro Mercantil fieldset */
.registro-mercantil-fields {
  background: var(--bg-secondary, #1f1f1f);
  border-radius: 8px;
  padding: 16px;
  margin-top: 8px;
}
```

2. Add HTML for the modal (add before closing </body> tag or after the main content container):

```html
<!-- Entity Creation Modal -->
<div id="entity-modal-overlay" class="entity-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="entity-modal-title">
  <div class="entity-modal">
    <div class="entity-modal__header">
      <h2 id="entity-modal-title" class="entity-modal__title">Crear Nueva Entidad</h2>
      <button class="entity-modal__close" aria-label="Cerrar" onclick="EntityModal.close()">&times;</button>
    </div>

    <div class="entity-modal__body">
      <!-- Entity Type Selection -->
      <div class="entity-modal__section">
        <div class="entity-modal__section-title">Tipo de Entidad</div>
        <div class="entity-type-selector">
          <div class="entity-type-option" data-type="autonomo" onclick="EntityModal.selectType('autonomo')">
            <div class="entity-type-option__icon">üë§</div>
            <div class="entity-type-option__name">Aut√≥nomo</div>
            <div class="entity-type-option__desc">Persona f√≠sica</div>
          </div>
          <div class="entity-type-option" data-type="sociedad_limitada" onclick="EntityModal.selectType('sociedad_limitada')">
            <div class="entity-type-option__icon">üè¢</div>
            <div class="entity-type-option__name">Sociedad Limitada</div>
            <div class="entity-type-option__desc">Persona jur√≠dica</div>
          </div>
        </div>
      </div>

      <!-- Common Fields -->
      <div id="entity-form-fields" class="entity-modal__section" style="display: none;">
        <form id="entity-form" onsubmit="return false;">
          <!-- Autonomo Fields -->
          <div id="autonomo-fields" style="display: none;">
            <div class="entity-form__group">
              <label class="entity-form__label entity-form__label--required" for="entity-nif">NIF</label>
              <input type="text" id="entity-nif" class="entity-form__input" placeholder="12345678Z" maxlength="9">
              <div id="entity-nif-error" class="entity-form__error" style="display: none;"></div>
            </div>
            <div class="entity-form__group">
              <label class="entity-form__label entity-form__label--required" for="entity-nombre">Nombre Completo</label>
              <input type="text" id="entity-nombre" class="entity-form__input" placeholder="Juan Garc√≠a L√≥pez">
            </div>
            <div class="entity-form__group">
              <label class="entity-form__label entity-form__label--required" for="entity-domicilio-fiscal">Domicilio Fiscal</label>
              <input type="text" id="entity-domicilio-fiscal" class="entity-form__input" placeholder="Calle Mayor 1, 28001 Madrid">
            </div>
            <div class="entity-form__row">
              <div class="entity-form__group">
                <label class="entity-form__label" for="entity-iae">Ep√≠grafe IAE Principal</label>
                <input type="text" id="entity-iae" class="entity-form__input" placeholder="841">
                <div class="entity-form__hint">C√≥digo de actividad econ√≥mica</div>
              </div>
              <div class="entity-form__group">
                <label class="entity-form__label" for="entity-fecha-alta">Fecha de Alta</label>
                <input type="date" id="entity-fecha-alta" class="entity-form__input">
              </div>
            </div>
          </div>

          <!-- SL Fields -->
          <div id="sl-fields" style="display: none;">
            <div class="entity-form__group">
              <label class="entity-form__label entity-form__label--required" for="entity-cif">CIF</label>
              <input type="text" id="entity-cif" class="entity-form__input" placeholder="B12345678" maxlength="9">
              <div id="entity-cif-error" class="entity-form__error" style="display: none;"></div>
            </div>
            <div class="entity-form__group">
              <label class="entity-form__label entity-form__label--required" for="entity-razon-social">Raz√≥n Social</label>
              <input type="text" id="entity-razon-social" class="entity-form__input" placeholder="Empresa Ejemplo SL">
            </div>
            <div class="entity-form__group">
              <label class="entity-form__label entity-form__label--required" for="entity-domicilio-social">Domicilio Social</label>
              <input type="text" id="entity-domicilio-social" class="entity-form__input" placeholder="Paseo de la Castellana 100, 28046 Madrid">
            </div>
            <div class="entity-form__group">
              <label class="entity-form__label">Registro Mercantil</label>
              <div class="registro-mercantil-fields">
                <div class="entity-form__row entity-form__row--3">
                  <div class="entity-form__group">
                    <label class="entity-form__label" for="entity-rm-provincia">Provincia</label>
                    <input type="text" id="entity-rm-provincia" class="entity-form__input" placeholder="Madrid">
                  </div>
                  <div class="entity-form__group">
                    <label class="entity-form__label" for="entity-rm-tomo">Tomo</label>
                    <input type="text" id="entity-rm-tomo" class="entity-form__input" placeholder="45097">
                  </div>
                  <div class="entity-form__group">
                    <label class="entity-form__label" for="entity-rm-folio">Folio</label>
                    <input type="text" id="entity-rm-folio" class="entity-form__input" placeholder="195">
                  </div>
                </div>
                <div class="entity-form__row entity-form__row--3">
                  <div class="entity-form__group">
                    <label class="entity-form__label" for="entity-rm-seccion">Secci√≥n</label>
                    <input type="text" id="entity-rm-seccion" class="entity-form__input" placeholder="8">
                  </div>
                  <div class="entity-form__group">
                    <label class="entity-form__label" for="entity-rm-hoja">Hoja</label>
                    <input type="text" id="entity-rm-hoja" class="entity-form__input" placeholder="M-452031">
                  </div>
                  <div class="entity-form__group">
                    <label class="entity-form__label" for="entity-rm-inscripcion">Inscripci√≥n</label>
                    <input type="text" id="entity-rm-inscripcion" class="entity-form__input" placeholder="1">
                  </div>
                </div>
              </div>
            </div>
            <div class="entity-form__row">
              <div class="entity-form__group">
                <label class="entity-form__label" for="entity-fecha-constitucion">Fecha Constituci√≥n</label>
                <input type="date" id="entity-fecha-constitucion" class="entity-form__input">
              </div>
              <div class="entity-form__group">
                <label class="entity-form__label" for="entity-capital-social">Capital Social (‚Ç¨)</label>
                <input type="number" id="entity-capital-social" class="entity-form__input" placeholder="3000" min="3000" step="1" value="3000">
                <div class="entity-form__hint">M√≠nimo 3.000‚Ç¨ para SL</div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="entity-modal__footer">
      <button class="entity-modal__btn entity-modal__btn--secondary" onclick="EntityModal.close()">Cancelar</button>
      <button id="entity-modal-submit" class="entity-modal__btn entity-modal__btn--primary" onclick="EntityModal.submit()" disabled>Crear Entidad</button>
    </div>
  </div>
</div>
```

3. Add JavaScript for the EntityModal controller (after EntityManager):

```javascript
// =====================================================
// Entity Modal Controller
// =====================================================

const EntityModal = {
  selectedType: null,

  open() {
    this.reset();
    document.getElementById('entity-modal-overlay').classList.add('active');
    // Focus trap
    document.body.style.overflow = 'hidden';
  },

  close() {
    document.getElementById('entity-modal-overlay').classList.remove('active');
    document.body.style.overflow = '';
    this.reset();
  },

  reset() {
    this.selectedType = null;
    document.getElementById('entity-form-fields').style.display = 'none';
    document.getElementById('autonomo-fields').style.display = 'none';
    document.getElementById('sl-fields').style.display = 'none';
    document.getElementById('entity-modal-submit').disabled = true;

    // Reset type selector
    document.querySelectorAll('.entity-type-option').forEach(opt => {
      opt.classList.remove('selected');
    });

    // Reset form
    document.getElementById('entity-form').reset();

    // Clear validation states
    document.querySelectorAll('.entity-form__input').forEach(input => {
      input.classList.remove('valid', 'invalid');
    });
    document.querySelectorAll('.entity-form__error').forEach(err => {
      err.style.display = 'none';
    });
  },

  selectType(type) {
    this.selectedType = type;

    // Update type selector UI
    document.querySelectorAll('.entity-type-option').forEach(opt => {
      opt.classList.toggle('selected', opt.dataset.type === type);
    });

    // Show form fields
    document.getElementById('entity-form-fields').style.display = 'block';
    document.getElementById('autonomo-fields').style.display = type === 'autonomo' ? 'block' : 'none';
    document.getElementById('sl-fields').style.display = type === 'sociedad_limitada' ? 'block' : 'none';

    // Enable submit button
    document.getElementById('entity-modal-submit').disabled = false;

    // Focus first input
    if (type === 'autonomo') {
      document.getElementById('entity-nif').focus();
    } else {
      document.getElementById('entity-cif').focus();
    }
  },

  validateNIF() {
    const input = document.getElementById('entity-nif');
    const errorEl = document.getElementById('entity-nif-error');
    const value = input.value.trim();

    if (!value) {
      input.classList.remove('valid', 'invalid');
      errorEl.style.display = 'none';
      return false;
    }

    const result = SpanishTaxIdValidator.validateNIF(value);
    input.classList.toggle('valid', result.valid);
    input.classList.toggle('invalid', !result.valid);

    if (!result.valid) {
      errorEl.textContent = result.error;
      errorEl.style.display = 'block';
    } else {
      errorEl.style.display = 'none';
    }

    return result.valid;
  },

  validateCIF() {
    const input = document.getElementById('entity-cif');
    const errorEl = document.getElementById('entity-cif-error');
    const value = input.value.trim();

    if (!value) {
      input.classList.remove('valid', 'invalid');
      errorEl.style.display = 'none';
      return false;
    }

    const result = SpanishTaxIdValidator.validateCIF(value);
    input.classList.toggle('valid', result.valid);
    input.classList.toggle('invalid', !result.valid);

    if (!result.valid) {
      errorEl.textContent = result.error;
      errorEl.style.display = 'block';
    } else {
      errorEl.style.display = 'none';
    }

    return result.valid;
  },

  async submit() {
    if (!this.selectedType) return;

    try {
      let entityData;

      if (this.selectedType === 'autonomo') {
        // Validate required fields
        const nif = document.getElementById('entity-nif').value.trim();
        const nombre = document.getElementById('entity-nombre').value.trim();
        const domicilio = document.getElementById('entity-domicilio-fiscal').value.trim();

        if (!nif || !nombre || !domicilio) {
          alert('Por favor, completa todos los campos obligatorios.');
          return;
        }

        if (!this.validateNIF()) {
          document.getElementById('entity-nif').focus();
          return;
        }

        entityData = {
          type: ENTITY_TYPE.AUTONOMO,
          nif,
          name: nombre,
          domicilio_fiscal: domicilio,
          iae_primary: document.getElementById('entity-iae').value.trim(),
          iae_codes: document.getElementById('entity-iae').value.trim() ?
            [document.getElementById('entity-iae').value.trim()] : [],
          fecha_alta: document.getElementById('entity-fecha-alta').value || null
        };
      } else {
        // SL
        const cif = document.getElementById('entity-cif').value.trim();
        const razonSocial = document.getElementById('entity-razon-social').value.trim();
        const domicilio = document.getElementById('entity-domicilio-social').value.trim();

        if (!cif || !razonSocial || !domicilio) {
          alert('Por favor, completa todos los campos obligatorios.');
          return;
        }

        if (!this.validateCIF()) {
          document.getElementById('entity-cif').focus();
          return;
        }

        const capitalInput = document.getElementById('entity-capital-social').value;
        const capitalEuros = parseFloat(capitalInput) || 3000;

        entityData = {
          type: ENTITY_TYPE.SOCIEDAD_LIMITADA,
          cif,
          name: razonSocial,
          domicilio_social: domicilio,
          registro_mercantil: {
            provincia: document.getElementById('entity-rm-provincia').value.trim(),
            tomo: document.getElementById('entity-rm-tomo').value.trim(),
            libro: '',
            folio: document.getElementById('entity-rm-folio').value.trim(),
            seccion: document.getElementById('entity-rm-seccion').value.trim(),
            hoja: document.getElementById('entity-rm-hoja').value.trim(),
            inscripcion: document.getElementById('entity-rm-inscripcion').value.trim()
          },
          fecha_constitucion: document.getElementById('entity-fecha-constitucion').value || null,
          capital_social_cents: MoneyUtils.eurosToCents(capitalEuros)
        };
      }

      const entityId = await EntityManager.createEntity(entityData);
      console.log('Entity created:', entityId);

      this.close();

      // Show success notification (simple alert for now)
      alert(`Entidad "${entityData.name}" creada correctamente.`);

    } catch (error) {
      console.error('Error creating entity:', error);
      alert(`Error: ${error.message}`);
    }
  },

  // Initialize event listeners
  init() {
    // NIF validation on blur
    document.getElementById('entity-nif')?.addEventListener('blur', () => this.validateNIF());

    // CIF validation on blur
    document.getElementById('entity-cif')?.addEventListener('blur', () => this.validateCIF());

    // Close on overlay click
    document.getElementById('entity-modal-overlay')?.addEventListener('click', (e) => {
      if (e.target.id === 'entity-modal-overlay') {
        this.close();
      }
    });

    // Close on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && document.getElementById('entity-modal-overlay')?.classList.contains('active')) {
        this.close();
      }
    });
  }
};

// Initialize EntityModal on DOMContentLoaded
document.addEventListener('DOMContentLoaded', () => {
  EntityModal.init();
});
```
  </action>
  <verify>
1. Open page in browser
2. Open console, run: `EntityModal.open()`
3. Modal appears with type selection
4. Click "Aut√≥nomo" - form fields appear
5. Enter invalid NIF (12345678A), blur - shows error with expected letter
6. Enter valid NIF (12345678Z), blur - shows green border
7. Fill required fields, click "Crear Entidad"
8. Modal closes, entity created in IndexedDB
9. Check: `await EntityManager.getActiveEntities()` shows the entity
10. Check: `EntityContext.current` shows the entity (auto-selected)
  </verify>
  <done>
- EntityModal opens/closes with animation
- Type selector shows Autonomo vs SL options
- Form fields dynamically shown based on type
- NIF/CIF validation on blur with visual feedback
- Required fields validated before submit
- Entity created via EntityManager on submit
- Modal closes and resets on success
  </done>
</task>

</tasks>

<verification>
1. EntityManager CRUD operations work correctly in console
2. EntityModal opens and shows type selection
3. Selecting Autonomo shows NIF/nombre/domicilio/IAE/fecha_alta fields
4. Selecting SL shows CIF/razon social/domicilio/Registro Mercantil/constitution/capital fields
5. NIF validation shows error for invalid check digit
6. CIF validation shows error for invalid control digit
7. Creating entity stores in IndexedDB with correct fields
8. First entity auto-selected as current
9. v1.1 calculator functionality unchanged
</verification>

<success_criteria>
- EntityManager.createEntity() creates Autonomo with all required fields
- EntityManager.createEntity() creates SL with Registro Mercantil nested object
- EntityModal shows different fields based on type selection
- Tax ID validation shows Spanish error messages
- Created entity appears in db.entities table
- First created entity is auto-selected via EntityContext
- EntityManager.archiveEntity() switches away from current entity
</success_criteria>

<output>
After completion, create `.planning/phases/13-multi-entity-architecture/13-03-SUMMARY.md`
</output>
