---
phase: 13-multi-entity-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [autonomo_dashboard.html]
autonomous: true

must_haves:
  truths:
    - "NIF validation rejects invalid check digits with Spanish error message"
    - "CIF validation rejects invalid control digits with Spanish error message"
    - "NIE validation supports X/Y/Z prefix format"
    - "ENTITY_TYPE constants differentiate Autonomo from SL"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "SpanishTaxIdValidator module and ENTITY_TYPE constants"
      contains: "const SpanishTaxIdValidator"
  key_links:
    - from: "SpanishTaxIdValidator.validateNIF()"
      to: "NIF_LETTERS check digit lookup"
      via: "modulo 23 algorithm"
      pattern: "NIF_LETTERS\\[.*% 23\\]"
---

<objective>
Implement Spanish tax ID validation (NIF/CIF/NIE) with check digit algorithms and entity type constants.

Purpose: Establishes foundation for entity creation forms by ensuring all tax IDs entered are valid according to Spanish regulations. Invalid tax IDs cause invoice rejection by AEAT/VeriFactu.

Output: SpanishTaxIdValidator module with validateNIF, validateCIF, validateNIE, and auto-detect validate method. ENTITY_TYPE constants for type-safe entity handling.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-multi-entity-architecture/13-RESEARCH.md
@.planning/phases/12-data-architecture-foundation/12-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SpanishTaxIdValidator and ENTITY_TYPE constants</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add immediately after the InvoiceManager module (around line 9800):

1. Add ENTITY_TYPE constants object:
```javascript
// =====================================================
// PHASE 13: Multi-Entity Architecture
// =====================================================

const ENTITY_TYPE = Object.freeze({
  AUTONOMO: 'autonomo',
  SOCIEDAD_LIMITADA: 'sociedad_limitada'
});
```

2. Add SpanishTaxIdValidator module with:
   - NIF_LETTERS constant: 'TRWAGMYFPDXBNJZSQVHLCKE'
   - CIF_CONTROL_LETTERS constant: 'JABCDEFGHI'
   - CIF_LETTER_CONTROL array: ['K', 'P', 'Q', 'S']
   - CIF_NUMBER_CONTROL array: ['A', 'B', 'E', 'H']

   Methods (all return {valid: boolean, error?: string, formatted?: string}):

   a) validateNIF(nif):
      - Validate format: 8 digits + 1 letter (regex: /^(\d{8})([A-Z])$/)
      - Calculate expected letter: NIF_LETTERS[parseInt(digits) % 23]
      - Return Spanish error messages:
        - 'NIF requerido' if empty
        - 'Formato NIF inválido (8 dígitos + letra)' if format wrong
        - 'Letra de control incorrecta (esperada: X)' if check digit wrong

   b) validateNIE(nie):
      - Validate format: X/Y/Z + 7 digits + 1 letter
      - Convert prefix: X=0, Y=1, Z=2
      - Calculate: NIF_LETTERS[(prefixValue + digits) % 23]
      - Spanish error messages for each failure case

   c) validateCIF(cif):
      - Validate format: letter + 7 digits + control (regex: /^([ABCDEFGHJKLMNPQRSUVW])(\d{7})([0-9A-J])$/)
      - Calculate control using sum algorithm:
        - Odd positions (0,2,4,6): digit * 2, if >9 subtract 9
        - Even positions (1,3,5): just sum
        - controlNumber = (10 - (total % 10)) % 10
        - controlLetter = CIF_CONTROL_LETTERS[controlNumber]
      - Determine expected control based on org type:
        - CIF_LETTER_CONTROL types require letter
        - CIF_NUMBER_CONTROL types require number
        - Others can be either
      - Include getOrganizationType(letter) helper for display

   d) validate(taxId):
      - Auto-detect type by format and route to correct validator
      - Return result with added type field ('NIF', 'NIE', 'CIF')

All methods must:
- Trim and uppercase input
- Remove spaces and hyphens from input
- Return `formatted` field with cleaned value on success
  </action>
  <verify>
Console tests:
```javascript
// NIF valid
console.log(SpanishTaxIdValidator.validateNIF('12345678Z'));
// Should return: {valid: true, formatted: '12345678Z'}

// NIF invalid check digit
console.log(SpanishTaxIdValidator.validateNIF('12345678A'));
// Should return: {valid: false, error: 'Letra de control incorrecta (esperada: Z)'}

// CIF valid (B = SL)
console.log(SpanishTaxIdValidator.validateCIF('B12345678'));
// Should return: {valid: true, formatted: 'B12345678', organizationType: 'Sociedad de Responsabilidad Limitada'}

// Auto-detect
console.log(SpanishTaxIdValidator.validate('12345678Z'));
// Should return: {valid: true, formatted: '12345678Z', type: 'NIF'}

// ENTITY_TYPE
console.log(ENTITY_TYPE.AUTONOMO); // 'autonomo'
console.log(ENTITY_TYPE.SOCIEDAD_LIMITADA); // 'sociedad_limitada'
```
  </verify>
  <done>
- SpanishTaxIdValidator validates NIF, CIF, NIE with correct check digit algorithms
- All error messages are in Spanish
- ENTITY_TYPE constants are frozen and accessible
- Auto-detect correctly identifies tax ID type by format
  </done>
</task>

</tasks>

<verification>
1. Open browser DevTools console
2. Run all verification tests from Task 1
3. Verify NIF check digit algorithm matches official algorithm (12345678 mod 23 = 14, letter at index 14 is 'Z')
4. Verify CIF control digit calculation for B-type (SL) organizations
5. Confirm v1.1 calculator functionality unchanged (no regressions)
</verification>

<success_criteria>
- SpanishTaxIdValidator.validateNIF('12345678Z') returns {valid: true}
- SpanishTaxIdValidator.validateNIF('12345678A') returns {valid: false} with correct expected letter
- SpanishTaxIdValidator.validateCIF('B12345678') returns valid with organizationType
- SpanishTaxIdValidator.validate() auto-detects NIF/NIE/CIF format
- ENTITY_TYPE.AUTONOMO === 'autonomo'
- No JavaScript errors in console on page load
</success_criteria>

<output>
After completion, create `.planning/phases/13-multi-entity-architecture/13-01-SUMMARY.md`
</output>
