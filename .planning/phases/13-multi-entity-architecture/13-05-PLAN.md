---
phase: 13-multi-entity-architecture
plan: 05
type: execute
wave: 3
depends_on: [13-03, 13-04]
files_modified: [autonomo_dashboard.html]
autonomous: false

must_haves:
  truths:
    - "System detects when user owns both Autonomo and SL entities"
    - "Dual activity warning banner displays in UI"
    - "Warning explains RETA implications for autonomo societario"
    - "Detection runs on entity creation and app initialization"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "DualActivityDetector module and warning banner"
      contains: "const DualActivityDetector"
  key_links:
    - from: "DualActivityDetector.detect()"
      to: "db.entities"
      via: "query for both entity types"
      pattern: "type.*autonomo.*type.*sociedad_limitada|filter.*type"
    - from: "EntityManager.createEntity()"
      to: "DualActivityDetector.checkAndWarn()"
      via: "trigger check after entity creation"
      pattern: "DualActivityDetector.*check|detect"
---

<objective>
Implement dual activity detection that identifies when a user operates both as Autonomo and SL administrator, displaying relevant RETA warnings.

Purpose: Spanish tax law treats autonomo + SL administrador as "autonomo societario" with higher RETA minimum base (1,000 EUR vs variable). Users need to be aware of this before Phase 23 cross-entity calculations.

Output: DualActivityDetector module with detect method, warning banner component, and integration with entity creation flow.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-multi-entity-architecture/13-RESEARCH.md
@.planning/phases/13-multi-entity-architecture/13-03-SUMMARY.md
@.planning/phases/13-multi-entity-architecture/13-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement DualActivityDetector module</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add after EntitySwitcher component:

```javascript
// =====================================================
// Dual Activity Detection
// =====================================================

const DualActivityDetector = {
  // Detect if user has both Autonomo and SL entities
  async detect() {
    const entities = await EntityManager.getActiveEntities();

    const autonomoEntities = entities.filter(e => e.type === ENTITY_TYPE.AUTONOMO);
    const slEntities = entities.filter(e => e.type === ENTITY_TYPE.SOCIEDAD_LIMITADA);

    const hasAutonomo = autonomoEntities.length > 0;
    const hasSL = slEntities.length > 0;

    if (hasAutonomo && hasSL) {
      return {
        isDualActivity: true,
        autonomoEntities,
        slEntities,
        totalEntities: entities.length,
        message: 'Actividad dual detectada',
        explanation: 'Como aut√≥nomo que tambi√©n administra una Sociedad Limitada, ' +
                     'te consideran "aut√≥nomo societario". Esto implica una base m√≠nima ' +
                     'de cotizaci√≥n de 1.000 EUR/mes (cuota ~315 EUR/mes) en lugar de ' +
                     'la base seg√∫n tus ingresos reales.',
        impact: {
          minimumBaseCents: 100000,     // 1000 EUR
          minimumCuotaCents: 31500,     // 315 EUR (31.5% of 1000)
          note: 'La cuota exacta depende del tipo de cotizaci√≥n adicional elegido.'
        }
      };
    }

    return {
      isDualActivity: false,
      autonomoEntities,
      slEntities,
      totalEntities: entities.length
    };
  },

  // Check and show warning if dual activity detected
  async checkAndWarn() {
    const result = await this.detect();

    if (result.isDualActivity) {
      this.showWarningBanner(result);
    } else {
      this.hideWarningBanner();
    }

    return result;
  },

  // Show warning banner in UI
  showWarningBanner(detectionResult) {
    // Remove existing banner if any
    this.hideWarningBanner();

    const banner = document.createElement('div');
    banner.id = 'dual-activity-warning';
    banner.className = 'dual-activity-warning';
    banner.setAttribute('role', 'alert');
    banner.innerHTML = `
      <div class="dual-activity-warning__icon">‚ö†Ô∏è</div>
      <div class="dual-activity-warning__content">
        <div class="dual-activity-warning__title">${detectionResult.message}</div>
        <div class="dual-activity-warning__text">${detectionResult.explanation}</div>
        <div class="dual-activity-warning__entities">
          <span class="dual-activity-warning__entity-count">
            üë§ ${detectionResult.autonomoEntities.length} Aut√≥nomo${detectionResult.autonomoEntities.length > 1 ? 's' : ''} +
            üè¢ ${detectionResult.slEntities.length} S.L.${detectionResult.slEntities.length > 1 ? 's' : ''}
          </span>
        </div>
      </div>
      <button class="dual-activity-warning__dismiss" onclick="DualActivityDetector.dismissBanner()" aria-label="Cerrar aviso">
        ‚úï
      </button>
    `;

    // Insert after header or at top of content
    const header = document.querySelector('.app-header') ||
                   document.querySelector('.entity-switcher-container')?.parentElement;
    if (header?.parentElement) {
      header.parentElement.insertBefore(banner, header.nextSibling);
    } else {
      document.body.insertBefore(banner, document.body.firstChild);
    }
  },

  // Hide warning banner
  hideWarningBanner() {
    const existing = document.getElementById('dual-activity-warning');
    if (existing) {
      existing.remove();
    }
  },

  // Dismiss banner (user action) - persists for session
  dismissBanner() {
    this.hideWarningBanner();
    sessionStorage.setItem('dual_activity_warning_dismissed', 'true');
  },

  // Check if banner was dismissed this session
  wasDismissed() {
    return sessionStorage.getItem('dual_activity_warning_dismissed') === 'true';
  },

  // Initialize on app load (respects dismissal)
  async initialize() {
    if (this.wasDismissed()) {
      return { isDualActivity: false, dismissed: true };
    }
    return this.checkAndWarn();
  }
};
```

Add CSS for the warning banner (in style section):

```css
/* Dual Activity Warning Banner */
.dual-activity-warning {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 16px 20px;
  background: linear-gradient(135deg, rgba(234, 179, 8, 0.15), rgba(234, 179, 8, 0.05));
  border: 1px solid rgba(234, 179, 8, 0.3);
  border-radius: 8px;
  margin: 16px 24px;
}

.dual-activity-warning__icon {
  font-size: 24px;
  flex-shrink: 0;
}

.dual-activity-warning__content {
  flex: 1;
}

.dual-activity-warning__title {
  font-weight: 600;
  color: #eab308;
  margin-bottom: 4px;
}

.dual-activity-warning__text {
  font-size: 13px;
  color: var(--text-secondary, #888);
  line-height: 1.5;
  margin-bottom: 8px;
}

.dual-activity-warning__entities {
  font-size: 12px;
  color: var(--text-tertiary, #666);
}

.dual-activity-warning__entity-count {
  background: rgba(255, 255, 255, 0.05);
  padding: 4px 8px;
  border-radius: 4px;
}

.dual-activity-warning__dismiss {
  background: transparent;
  border: none;
  color: var(--text-tertiary, #666);
  font-size: 16px;
  cursor: pointer;
  padding: 4px;
  flex-shrink: 0;
}

.dual-activity-warning__dismiss:hover {
  color: var(--text-primary, #fff);
}
```
  </action>
  <verify>
Console test:
```javascript
// Create test entities
const autoId = await EntityManager.createEntity({
  type: ENTITY_TYPE.AUTONOMO,
  nif: '12345678Z',
  name: 'Test Autonomo',
  domicilio_fiscal: 'Madrid'
});

const slId = await EntityManager.createEntity({
  type: ENTITY_TYPE.SOCIEDAD_LIMITADA,
  cif: 'B12345678',
  name: 'Test SL',
  domicilio_social: 'Madrid'
});

// Test detection
const result = await DualActivityDetector.detect();
console.log('isDualActivity:', result.isDualActivity); // true
console.log('Autonomos:', result.autonomoEntities.length); // 1
console.log('SLs:', result.slEntities.length); // 1

// Show banner
await DualActivityDetector.checkAndWarn();
// Banner should appear in UI

// Cleanup
await db.entities.delete(autoId);
await db.entities.delete(slId);
DualActivityDetector.hideWarningBanner();
```
  </verify>
  <done>
- DualActivityDetector.detect() returns detection result with entity lists
- DualActivityDetector.checkAndWarn() shows warning banner if dual activity
- Warning banner shows entity counts and RETA explanation
- Dismiss button hides banner for session
- CSS styled to match dashboard theme (yellow warning color)
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate dual activity detection with entity creation and app init</name>
  <files>autonomo_dashboard.html</files>
  <action>
1. In EntityManager.createEntity(), after the entity is created and before returning, add dual activity check:

Find the `return id;` at the end of createEntity() and add before it:
```javascript
// Check for dual activity after creation
setTimeout(() => DualActivityDetector.checkAndWarn(), 100);
```

2. In the initializeDatabase() function, after EntityContext.initialize(), add:
```javascript
// Check for dual activity on startup
await DualActivityDetector.initialize();
```

3. In EntityManager.restoreEntity(), after restoring, also check:
```javascript
// Check dual activity (restoration may trigger it)
setTimeout(() => DualActivityDetector.checkAndWarn(), 100);
```

4. In EntityModal.submit() success block, ensure the dual activity check runs after entity creation. The check in EntityManager should handle this, but verify the flow works.
  </action>
  <verify>
1. Clear all entities and session storage
2. Create Autonomo entity - no warning appears
3. Create SL entity - warning banner appears
4. Dismiss warning, refresh page - warning stays dismissed (session)
5. Clear session storage, refresh - warning reappears
6. Archive the SL entity - warning should disappear
7. Restore the SL entity - warning should reappear
  </verify>
  <done>
- Dual activity checked on entity creation
- Dual activity checked on app initialization
- Dual activity checked on entity restoration
- Warning banner appears/disappears based on entity state
- Session-based dismissal works correctly
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 13 Multi-Entity Architecture:
- SpanishTaxIdValidator for NIF/CIF/NIE validation with check digits
- EntityContext singleton for current entity state management
- EntityManager CRUD operations for entity lifecycle
- Entity creation modal with type-specific fields
- Entity switcher dropdown in header
- Dual activity detection with RETA warning banner
  </what-built>
  <how-to-verify>
1. **Open browser DevTools and load the HTML file**
   - Page should load without JavaScript errors
   - Entity switcher should appear in header showing "Seleccionar entidad..."
   - v1.1 calculator functionality should still work

2. **Create an Autonomo entity**
   - Click entity switcher dropdown
   - Click "Crear nueva entidad"
   - Select "Aut√≥nomo"
   - Enter invalid NIF (12345678A) - should show error with expected letter 'Z'
   - Enter valid NIF (12345678Z) - green border appears
   - Fill name "Juan Garc√≠a", domicilio "Calle Mayor 1, Madrid"
   - Click "Crear Entidad"
   - Modal closes, entity switcher shows "Juan Garc√≠a - Aut√≥nomo"

3. **Create an SL entity (triggers dual activity)**
   - Click entity switcher ‚Üí "Crear nueva entidad"
   - Select "Sociedad Limitada"
   - Enter CIF (B12345678)
   - Fill raz√≥n social "Empresa Test SL", domicilio "Paseo Castellana"
   - Click "Crear Entidad"
   - Modal closes
   - **Dual activity warning banner should appear** with RETA explanation

4. **Test entity switching**
   - Click entity switcher dropdown
   - Both entities shown with checkmark on current
   - Click the other entity
   - Switcher updates to show newly selected entity
   - `EntityContext.current.name` in console shows correct entity

5. **Test persistence**
   - Refresh the page
   - Entity switcher should show last selected entity (restored from settings)
   - Dual activity warning should reappear (unless dismissed)

6. **Verify requirements coverage**
   - ENTITY-01: Multiple entities ‚úì
   - ENTITY-02: Autonomo/SL selection ‚úì
   - ENTITY-03: Autonomo fields (NIF, nombre, domicilio, IAE, alta) ‚úì
   - ENTITY-04: SL fields (CIF, razon, Registro Mercantil, constitucion, capital) ‚úì
   - ENTITY-05: Entity switcher ‚úì
   - ENTITY-06: Independent data (entity_id scoping ready) ‚úì
   - ENTITY-07: Archive (test via console: EntityManager.archiveEntity(id)) ‚úì
   - ENTITY-08: Dual activity detection ‚úì
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. DualActivityDetector.detect() correctly identifies when both entity types exist
2. Warning banner appears when second entity type is created
3. Warning banner dismissable and respects session storage
4. Warning re-appears on page refresh (unless dismissed)
5. Warning disappears if one entity type is archived
6. All Phase 13 requirements (ENTITY-01 through ENTITY-08) satisfied
</verification>

<success_criteria>
- Creating Autonomo alone: no warning
- Creating SL alone: no warning
- Creating both: warning banner appears with RETA explanation
- Dismiss button hides banner for session
- Page refresh: warning reappears (unless dismissed this session)
- Archiving one entity type: warning disappears
- All 8 ENTITY requirements verified working
</success_criteria>

<output>
After completion, create `.planning/phases/13-multi-entity-architecture/13-05-SUMMARY.md`
</output>
