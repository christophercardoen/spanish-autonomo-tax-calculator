---
phase: 13-multi-entity-architecture
plan: 04
type: execute
wave: 2
depends_on: [13-02]
files_modified: [autonomo_dashboard.html]
autonomous: true

must_haves:
  truths:
    - "Entity switcher dropdown visible in header area"
    - "Dropdown shows all active entities with type badges"
    - "Clicking entity in dropdown changes EntityContext.current"
    - "Entity switcher updates when EntityContext changes"
    - "Keyboard navigation works (ArrowUp/Down, Enter, Escape)"
    - "Create entity option in dropdown opens EntityModal"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "EntitySwitcher UI component"
      contains: "createEntitySwitcher"
  key_links:
    - from: "EntitySwitcher"
      to: "EntityContext.subscribe()"
      via: "observer pattern for reactive updates"
      pattern: "EntityContext\\.subscribe"
    - from: "EntitySwitcher option click"
      to: "EntityContext.setEntity()"
      via: "switch current entity"
      pattern: "EntityContext\\.setEntity"
---

<objective>
Implement accessible entity switcher dropdown in the header for switching between business entities.

Purpose: Users with multiple entities need a prominent, accessible way to switch context. All data views (clients, invoices, expenses, calendar) will be scoped to the selected entity.

Output: Entity switcher component with ARIA combobox pattern, keyboard navigation, entity type badges, and "Create entity" action.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-multi-entity-architecture/13-RESEARCH.md
@.planning/phases/13-multi-entity-architecture/13-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add entity switcher CSS styles</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add after the entity modal CSS (or in the main style section):

```css
/* Entity Switcher */
.entity-switcher-container {
  position: relative;
  margin-right: 16px;
}

.entity-switcher {
  position: relative;
  font-family: 'DM Sans', sans-serif;
}

.entity-switcher__trigger {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: var(--bg-secondary, #252525);
  border: 1px solid var(--border-color, #3a3a3a);
  border-radius: 6px;
  color: var(--text-primary, #fff);
  cursor: pointer;
  min-width: 200px;
  transition: border-color 0.15s, background-color 0.15s;
  font-family: inherit;
  font-size: 14px;
}

.entity-switcher__trigger:hover {
  background: var(--bg-hover, #2a2a2a);
  border-color: var(--border-hover, #4a4a4a);
}

.entity-switcher__trigger:focus {
  outline: 2px solid var(--accent-color, #3b82f6);
  outline-offset: 2px;
}

.entity-switcher__icon {
  font-size: 18px;
  flex-shrink: 0;
}

.entity-switcher__name {
  flex: 1;
  text-align: left;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.entity-switcher__type {
  font-size: 11px;
  color: var(--text-secondary, #888);
  background: var(--bg-tertiary, #333);
  padding: 2px 6px;
  border-radius: 4px;
  flex-shrink: 0;
}

.entity-switcher__chevron {
  width: 16px;
  height: 16px;
  transition: transform 0.15s;
  flex-shrink: 0;
}

.entity-switcher[aria-expanded="true"] .entity-switcher__chevron {
  transform: rotate(180deg);
}

.entity-switcher__menu {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  margin-top: 4px;
  padding: 4px 0;
  background: var(--bg-secondary, #252525);
  border: 1px solid var(--border-color, #3a3a3a);
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  z-index: 1000;
  list-style: none;
  max-height: 300px;
  overflow-y: auto;
}

.entity-switcher__option {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 12px;
  cursor: pointer;
  transition: background-color 0.1s;
}

.entity-switcher__option:hover,
.entity-switcher__option:focus {
  background: var(--bg-hover, #2a2a2a);
  outline: none;
}

.entity-switcher__option--active {
  background: var(--bg-active, #1e3a5f);
}

.entity-switcher__option--action {
  color: var(--accent-color, #3b82f6);
}

.entity-switcher__option-icon {
  font-size: 16px;
  flex-shrink: 0;
}

.entity-switcher__option-name {
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.entity-switcher__option-type {
  font-size: 11px;
  color: var(--text-secondary, #888);
  flex-shrink: 0;
}

.entity-switcher__check {
  color: var(--success-color, #22c55e);
  flex-shrink: 0;
}

.entity-switcher__divider {
  height: 1px;
  margin: 4px 0;
  background: var(--border-color, #3a3a3a);
}

.entity-switcher__empty {
  padding: 16px;
  text-align: center;
  color: var(--text-secondary, #888);
  font-size: 13px;
}

/* Visually hidden for screen readers */
.visually-hidden {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}
```
  </action>
  <verify>CSS added to style section without syntax errors.</verify>
  <done>Entity switcher CSS styles added for dark theme consistency with dashboard design.</done>
</task>

<task type="auto">
  <name>Task 2: Implement EntitySwitcher component</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add after EntityModal module:

```javascript
// =====================================================
// Entity Switcher Component
// =====================================================

function createEntitySwitcher(containerId) {
  const container = document.getElementById(containerId);
  if (!container) {
    console.warn('Entity switcher container not found:', containerId);
    return null;
  }

  // Create HTML structure
  container.innerHTML = `
    <div class="entity-switcher" role="combobox" aria-expanded="false"
         aria-haspopup="listbox" aria-labelledby="entity-switcher-label">
      <span id="entity-switcher-label" class="visually-hidden">Seleccionar entidad</span>

      <button class="entity-switcher__trigger"
              aria-describedby="entity-switcher-label"
              type="button">
        <span class="entity-switcher__icon" aria-hidden="true">üìã</span>
        <span class="entity-switcher__name">Seleccionar entidad...</span>
        <span class="entity-switcher__type"></span>
        <svg class="entity-switcher__chevron" aria-hidden="true"
             viewBox="0 0 24 24" width="16" height="16">
          <path d="M7 10l5 5 5-5z" fill="currentColor"/>
        </svg>
      </button>

      <ul class="entity-switcher__menu" role="listbox"
          aria-labelledby="entity-switcher-label" hidden>
      </ul>
    </div>
  `;

  const trigger = container.querySelector('.entity-switcher__trigger');
  const menu = container.querySelector('.entity-switcher__menu');
  const nameEl = container.querySelector('.entity-switcher__name');
  const typeEl = container.querySelector('.entity-switcher__type');
  const iconEl = container.querySelector('.entity-switcher__icon');
  const wrapper = container.querySelector('.entity-switcher');

  let entities = [];
  let isOpen = false;

  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Load entities from database
  async function loadEntities() {
    entities = await EntityManager.getActiveEntities();
    renderMenu();
  }

  // Render menu options
  function renderMenu() {
    const currentId = EntityContext.entityId;

    if (entities.length === 0) {
      menu.innerHTML = `
        <li class="entity-switcher__empty">
          No hay entidades creadas
        </li>
        <li class="entity-switcher__divider" role="separator"></li>
        <li class="entity-switcher__option entity-switcher__option--action"
            role="option"
            data-action="create"
            tabindex="-1">
          <span class="entity-switcher__option-icon" aria-hidden="true">‚ûï</span>
          <span class="entity-switcher__option-name">Crear nueva entidad</span>
        </li>
      `;
      return;
    }

    menu.innerHTML = entities.map(entity => `
      <li class="entity-switcher__option ${entity.id === currentId ? 'entity-switcher__option--active' : ''}"
          role="option"
          data-entity-id="${entity.id}"
          aria-selected="${entity.id === currentId}"
          tabindex="-1">
        <span class="entity-switcher__option-icon" aria-hidden="true">
          ${entity.type === 'autonomo' ? 'üë§' : 'üè¢'}
        </span>
        <span class="entity-switcher__option-name">${escapeHtml(entity.name)}</span>
        <span class="entity-switcher__option-type">
          ${entity.type === 'autonomo' ? 'Aut√≥nomo' : 'S.L.'}
        </span>
        ${entity.id === currentId ? '<span class="entity-switcher__check" aria-hidden="true">‚úì</span>' : ''}
      </li>
    `).join('');

    // Add "Create entity" option
    menu.innerHTML += `
      <li class="entity-switcher__divider" role="separator"></li>
      <li class="entity-switcher__option entity-switcher__option--action"
          role="option"
          data-action="create"
          tabindex="-1">
        <span class="entity-switcher__option-icon" aria-hidden="true">‚ûï</span>
        <span class="entity-switcher__option-name">Crear nueva entidad</span>
      </li>
    `;
  }

  // Update trigger display
  function updateTrigger(entity) {
    if (entity) {
      nameEl.textContent = entity.name;
      typeEl.textContent = entity.type === 'autonomo' ? 'Aut√≥nomo' : 'S.L.';
      iconEl.textContent = entity.type === 'autonomo' ? 'üë§' : 'üè¢';
    } else {
      nameEl.textContent = 'Seleccionar entidad...';
      typeEl.textContent = '';
      iconEl.textContent = 'üìã';
    }
    // Re-render menu to update active state
    renderMenu();
  }

  // Toggle menu open/closed
  function toggleMenu(open) {
    isOpen = open ?? !isOpen;
    wrapper.setAttribute('aria-expanded', isOpen);
    menu.hidden = !isOpen;

    if (isOpen) {
      // Focus active or first option
      const activeOption = menu.querySelector('.entity-switcher__option--active') ||
                           menu.querySelector('.entity-switcher__option');
      if (activeOption) activeOption.focus();
    }
  }

  // Handle entity selection
  async function selectEntity(entityId) {
    toggleMenu(false);
    trigger.focus();

    if (entityId && entityId !== EntityContext.entityId) {
      try {
        await EntityContext.setEntity(entityId);
      } catch (error) {
        console.error('Failed to switch entity:', error);
        alert(`Error al cambiar entidad: ${error.message}`);
      }
    }
  }

  // Event: Trigger click
  trigger.addEventListener('click', () => toggleMenu());

  // Event: Trigger keyboard
  trigger.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowDown') {
      e.preventDefault();
      toggleMenu(true);
    }
  });

  // Event: Menu click
  menu.addEventListener('click', async (e) => {
    const option = e.target.closest('[role="option"]');
    if (!option) return;

    const action = option.dataset.action;
    if (action === 'create') {
      toggleMenu(false);
      EntityModal.open();
      return;
    }

    const entityId = parseInt(option.dataset.entityId);
    if (!isNaN(entityId)) {
      await selectEntity(entityId);
    }
  });

  // Event: Menu keyboard navigation
  menu.addEventListener('keydown', async (e) => {
    const options = Array.from(menu.querySelectorAll('[role="option"]'));
    const currentIndex = options.indexOf(document.activeElement);

    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        const nextIndex = Math.min(currentIndex + 1, options.length - 1);
        options[nextIndex]?.focus();
        break;
      case 'ArrowUp':
        e.preventDefault();
        const prevIndex = Math.max(currentIndex - 1, 0);
        options[prevIndex]?.focus();
        break;
      case 'Enter':
      case ' ':
        e.preventDefault();
        document.activeElement?.click();
        break;
      case 'Escape':
        e.preventDefault();
        toggleMenu(false);
        trigger.focus();
        break;
      case 'Tab':
        toggleMenu(false);
        break;
    }
  });

  // Event: Close on outside click
  document.addEventListener('click', (e) => {
    if (isOpen && !container.contains(e.target)) {
      toggleMenu(false);
    }
  });

  // Subscribe to EntityContext changes
  EntityContext.subscribe((entity) => {
    updateTrigger(entity);
  });

  // Initialize
  loadEntities();
  updateTrigger(EntityContext.current);

  // Return public API
  return {
    refresh: loadEntities,
    open: () => toggleMenu(true),
    close: () => toggleMenu(false)
  };
}

// Global reference for the entity switcher
let entitySwitcher = null;
```
  </action>
  <verify>Component code added without syntax errors.</verify>
  <done>EntitySwitcher component implemented with ARIA roles, keyboard navigation, and EntityContext subscription.</done>
</task>

<task type="auto">
  <name>Task 3: Add entity switcher to header and initialize</name>
  <files>autonomo_dashboard.html</files>
  <action>
1. Find the header section in the HTML (around line 8600-8700, look for the title or top bar area). Add a container for the entity switcher in the header, typically next to the title or in a top bar.

If there's an existing header structure, add within it:
```html
<div id="entity-switcher-container" class="entity-switcher-container"></div>
```

If no dedicated header, add one at the top of the main container:
```html
<div class="app-header" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; border-bottom: 1px solid var(--border-color, #333);">
  <div id="entity-switcher-container" class="entity-switcher-container"></div>
  <div class="app-header__title" style="font-size: 18px; font-weight: 600;">Spanish Aut√≥nomo Tax Calculator</div>
  <div class="app-header__spacer"></div>
</div>
```

2. In the DOMContentLoaded handler (or initializeDatabase success callback), add initialization:

After EntityContext.initialize() and before the Ready status, add:
```javascript
// Initialize entity switcher
const switcherContainer = document.getElementById('entity-switcher-container');
if (switcherContainer) {
  entitySwitcher = createEntitySwitcher('entity-switcher-container');
}
```

3. Update entitySwitcher when entities are created. In EntityModal.submit() success block, after `this.close()`, add:
```javascript
// Refresh entity switcher
if (entitySwitcher) {
  entitySwitcher.refresh();
}
```
  </action>
  <verify>
1. Page loads with entity switcher visible in header
2. Switcher shows "Seleccionar entidad..." when no entity selected
3. Create entity via EntityModal
4. Switcher updates to show created entity
5. Create second entity
6. Switcher dropdown shows both entities
7. Click to switch between entities
8. EntityContext.current changes when switching
  </verify>
  <done>
- Entity switcher container added to header
- createEntitySwitcher() called on app initialization
- Switcher refreshes when entities created via modal
- Switcher shows current entity name and type badge
  </done>
</task>

</tasks>

<verification>
1. Entity switcher appears in header area
2. Shows "Seleccionar entidad..." when no entities exist
3. Dropdown opens on click with "Create entity" option
4. Creating entity updates switcher immediately
5. Dropdown shows all active entities with type badges
6. Clicking entity switches EntityContext.current
7. Current entity shows checkmark in dropdown
8. Keyboard navigation: ArrowUp/Down moves focus, Enter selects, Escape closes
9. Clicking outside dropdown closes it
10. Screen reader announces "Seleccionar entidad" label
</verification>

<success_criteria>
- Entity switcher visible in header
- Dropdown shows entities with icons (person for Autonomo, building for SL)
- Type badge shows "Aut√≥nomo" or "S.L."
- Current entity has active styling and checkmark
- Clicking entity changes EntityContext and updates trigger display
- "Crear nueva entidad" option opens EntityModal
- Keyboard accessible (ARIA combobox pattern)
- Outside click closes dropdown
</success_criteria>

<output>
After completion, create `.planning/phases/13-multi-entity-architecture/13-04-SUMMARY.md`
</output>
