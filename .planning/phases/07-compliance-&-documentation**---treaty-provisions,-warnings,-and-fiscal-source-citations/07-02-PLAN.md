---
phase: 07-compliance-documentation
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "User sees warning banner when Belgium days >= 170 (approaching threshold)"
    - "User sees updated warning at 180 and 183 days thresholds"
    - "User can dismiss warning banner, and it stays dismissed for the session"
    - "User sees global footer disclaimer on ALL tabs (not just Compliance)"
    - "User sees entry/exit day warning note in compliance content"
    - "Disclaimer text clearly states this is not tax advice"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Warning banner with dismiss, global disclaimer footer, entry/exit day warning"
      contains: "complianceWarningBanner|disclaimer"
  key_links:
    - from: "autonomo_dashboard.html"
      to: "Calendar data"
      via: "getBelgiumDayCount() check triggers warning"
      pattern: "getBelgiumDayCount|updateComplianceWarning"
    - from: "autonomo_dashboard.html"
      to: "sessionStorage"
      via: "Persist dismiss state"
      pattern: "sessionStorage"
---

<objective>
Add 183-day threshold warning banner, global disclaimer footer, and entry/exit day warning to complete Phase 7 compliance requirements.

Purpose: Delivers the remaining 3 requirements (COMP-01, COMP-08, COMP-10) - warning banner that responds to calendar data, disclaimer visible across all tabs, and entry/exit day warning.

Output: autonomo_dashboard.html with conditional warning banner, global disclaimer footer, and complete compliance content.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-compliance-&-documentation**---treaty-provisions,-warnings,-and-fiscal-source-citations/07-CONTEXT.md
@.planning/phases/07-compliance-&-documentation**---treaty-provisions,-warnings,-and-fiscal-source-citations/07-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add warning banner CSS and HTML structure</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add CSS styles for warning banner and disclaimer footer:

1. Add CSS for compliance warning banner (insert with other compliance CSS):
```css
/* Compliance Warning Banner (COMP-01) */
.compliance-warning-banner {
  display: none;
  align-items: center;
  justify-content: space-between;
  padding: 0.75rem 1rem;
  margin-bottom: 1rem;
  background: rgba(251, 146, 60, 0.15);
  border: 1px solid var(--warning);
  border-radius: 8px;
  color: var(--text);
}

.compliance-warning-banner.visible {
  display: flex;
}

.compliance-warning-banner.threshold-170 {
  background: rgba(251, 146, 60, 0.1);
}

.compliance-warning-banner.threshold-180 {
  background: rgba(251, 146, 60, 0.15);
}

.compliance-warning-banner.threshold-183 {
  background: rgba(248, 113, 113, 0.15);
  border-color: var(--negative);
}

.compliance-warning-banner .warning-text {
  font-size: 0.9rem;
  flex: 1;
}

.compliance-warning-banner .warning-text strong {
  color: var(--warning);
}

.compliance-warning-banner.threshold-183 .warning-text strong {
  color: var(--negative);
}

.compliance-warning-banner .dismiss-btn {
  background: transparent;
  border: none;
  color: var(--text);
  font-size: 1.25rem;
  cursor: pointer;
  padding: 0.25rem 0.5rem;
  margin-left: 1rem;
  opacity: 0.7;
}

.compliance-warning-banner .dismiss-btn:hover {
  opacity: 1;
}

/* Global Disclaimer Footer (COMP-08) */
.global-disclaimer {
  margin-top: 3rem;
  padding: 1rem;
  background: rgba(255,255,255,0.02);
  border-top: 1px solid rgba(255,255,255,0.1);
  text-align: center;
}

.global-disclaimer p {
  font-size: 0.8rem;
  color: var(--text-muted);
  line-height: 1.5;
  max-width: 800px;
  margin: 0 auto;
}

/* Entry/Exit Day Warning (COMP-10) */
.entry-exit-warning {
  background: rgba(251, 146, 60, 0.1);
  border-left: 3px solid var(--warning);
  padding: 1rem;
  margin-top: 1rem;
  border-radius: 0 4px 4px 0;
  font-size: 0.9rem;
}

.entry-exit-warning strong {
  color: var(--warning);
}
```

2. Add HTML for warning banner (inside .dashboard, BEFORE .tab-nav, around line 1865):
```html
<!-- Compliance Warning Banner (COMP-01) -->
<div id="complianceWarningBanner" class="compliance-warning-banner" role="alert" aria-live="polite">
  <span class="warning-text" id="warningText"></span>
  <button class="dismiss-btn" aria-label="Dismiss warning" onclick="dismissComplianceWarning()">&times;</button>
</div>
```

3. Add HTML for global disclaimer footer (OUTSIDE .tab-panels but inside .dashboard, at the very end before closing .dashboard div):
```html
<!-- Global Disclaimer Footer (COMP-08) -->
<footer class="global-disclaimer" id="globalDisclaimer">
  <p>
    <strong>Disclaimer:</strong> This calculator provides estimates for informational and educational purposes only.
    It does not constitute tax, legal, or financial advice. Tax laws are complex, subject to change, and vary by
    individual circumstances. Your actual tax liability may differ from these estimates. Always consult with a
    qualified tax professional (asesor fiscal, gestor) for guidance specific to your situation before making any
    financial decisions or filing tax returns.
  </p>
</footer>
```
  </action>
  <verify>Open browser, verify warning banner HTML element exists (inspect element), verify disclaimer footer visible at bottom of page.</verify>
  <done>Warning banner and disclaimer footer HTML/CSS in place.</done>
</task>

<task type="auto">
  <name>Task 2: Add warning banner JavaScript logic and entry/exit warning</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add JavaScript for warning banner display logic, dismiss functionality, and entry/exit day warning content:

1. Add DISCLAIMER constant with other Phase 7 constants:
```javascript
const DISCLAIMER = Object.freeze({
  title: 'Disclaimer',
  text: 'This calculator provides estimates for informational and educational purposes only. It does not constitute tax, legal, or financial advice. Tax laws are complex, subject to change, and vary by individual circumstances. Your actual tax liability may differ from these estimates. Always consult with a qualified tax professional (asesor fiscal, gestor) for guidance specific to your situation before making any financial decisions or filing tax returns.',
  shortVersion: 'For informational purposes only. Consult a qualified tax professional for advice specific to your situation.'
});
```

2. Add warning banner functions:
```javascript
// ===========================================
// PHASE 7: COMPLIANCE WARNING BANNER
// ===========================================

function getComplianceWarningDismissKey() {
  return 'complianceWarningDismissed_session';
}

function isComplianceWarningDismissed() {
  return sessionStorage.getItem(getComplianceWarningDismissKey()) === 'true';
}

function dismissComplianceWarning() {
  sessionStorage.setItem(getComplianceWarningDismissKey(), 'true');
  const banner = document.getElementById('complianceWarningBanner');
  if (banner) {
    banner.classList.remove('visible');
  }
}

function getBelgiumDayCount() {
  // Uses existing calendarData from Phase 4
  if (typeof calendarData === 'undefined') return 0;
  let count = 0;
  for (const monthKey in calendarData) {
    const month = calendarData[monthKey];
    for (const dayKey in month) {
      const status = month[dayKey].status;
      // Count Belgium and Travel days toward threshold (conservative approach)
      if (status === 'belgium' || status === 'travel') {
        count++;
      }
    }
  }
  return count;
}

function updateComplianceWarning() {
  const banner = document.getElementById('complianceWarningBanner');
  const textEl = document.getElementById('warningText');
  if (!banner || !textEl) return;

  // Don't show if dismissed this session
  if (isComplianceWarningDismissed()) {
    banner.classList.remove('visible');
    return;
  }

  const belgiumDays = getBelgiumDayCount();

  // Remove previous threshold classes
  banner.classList.remove('threshold-170', 'threshold-180', 'threshold-183');

  if (belgiumDays >= 183) {
    banner.classList.add('visible', 'threshold-183');
    textEl.innerHTML = `<strong>${belgiumDays} Belgium/travel days.</strong> You have exceeded the 183-day threshold. Treaty tie-breaker provisions apply to determine tax residence.`;
  } else if (belgiumDays >= 180) {
    banner.classList.add('visible', 'threshold-180');
    textEl.innerHTML = `<strong>${belgiumDays} Belgium/travel days.</strong> You are approaching the 183-day threshold. Review treaty provisions in the Compliance tab.`;
  } else if (belgiumDays >= 170) {
    banner.classList.add('visible', 'threshold-170');
    textEl.innerHTML = `<strong>${belgiumDays} Belgium/travel days.</strong> Approaching 183-day threshold. Consider reviewing treaty provisions.`;
  } else {
    banner.classList.remove('visible');
  }
}
```

3. Update renderComplianceContent() to include entry/exit day warning (add this section at the end of the "When Filing Taxes" action-phase, after the Family Presumption section):
```javascript
// Add this inside renderComplianceContent(), in the "When Filing Taxes" section HTML:
<div class="compliance-section">
  <button class="section-header" aria-expanded="false" aria-controls="content-183">
    <span>The 183-Day Threshold</span>
    <span class="section-icon">+</span>
  </button>
  <div class="section-content" id="content-183" hidden>
    <p class="plain-summary">
      The 183-day rule determines tax residence under <strong>domestic law</strong>.
      If you spend more than 183 days in Spain, Spanish law considers you a Spanish tax resident.
      Similarly, Belgium counts days for its own residency determination.
    </p>
    <p class="plain-summary">
      <strong>For treaty purposes:</strong> The Spain-Belgium treaty uses a 12-month rolling period
      (not calendar year) when determining where employment income can be taxed.
    </p>
    <div class="entry-exit-warning">
      <strong>Entry and exit days count in BOTH countries.</strong>
      <p>When you fly from Spain to Belgium, that day counts toward your presence in both countries.
      This means your total "days" may exceed 365 when added together. Tax authorities use "day of presence"
      rules that count any partial day as a full day in that country.</p>
    </div>
    <cite class="source-citation">LIRPF Art. 9.1.a, Spain-Belgium Treaty Art. 15</cite>
  </div>
</div>
```

4. Call updateComplianceWarning() in appropriate places:
- Add call in init() after calendar data is loaded
- Add call in saveCalendarData() after calendar is saved (so warning updates when days change)

Find the existing saveCalendarData function and add:
```javascript
updateComplianceWarning();
```
at the end of it.

In init(), add:
```javascript
updateComplianceWarning();
```
after `renderComplianceContent();`
  </action>
  <verify>
1. Open browser, set some Belgium days in calendar to exceed 170
2. Verify warning banner appears at top with orange styling
3. Set days to 183+, verify banner changes to red styling with stronger language
4. Click dismiss button, verify banner hides
5. Refresh page, verify banner returns (sessionStorage cleared on new session)
6. Click Compliance tab, expand "The 183-Day Threshold" section, verify entry/exit warning visible
7. Verify disclaimer footer visible at bottom of ALL tabs
  </verify>
  <done>Warning banner displays at 170/180/183 thresholds with appropriate messaging, dismissable per session via sessionStorage, entry/exit day warning in compliance content, global disclaimer footer visible on all tabs.</done>
</task>

</tasks>

<verification>
1. Set calendar to have 0 Belgium days - no warning banner visible
2. Set calendar to have 170 Belgium days - orange warning banner appears
3. Set calendar to have 180 Belgium days - warning intensifies
4. Set calendar to have 183+ Belgium days - red warning with "exceeded" language
5. Click dismiss button - banner disappears
6. Switch tabs - banner stays dismissed
7. Close and reopen browser tab - banner returns (new session)
8. Verify disclaimer footer visible on Scenarios tab
9. Verify disclaimer footer visible on Calendar tab
10. Verify disclaimer footer visible on Expenses tab
11. Verify disclaimer footer visible on Details tab
12. Verify disclaimer footer visible on Compliance tab
13. Click Compliance tab, expand "The 183-Day Threshold" section
14. Verify entry/exit day warning box with orange left border appears
15. Verify warning text mentions "Entry and exit days count in BOTH countries"
</verification>

<success_criteria>
- Warning banner appears at Belgium days >= 170
- Warning styling changes at 180 and 183 thresholds
- Warning can be dismissed via X button
- Dismissed state persists for browser session (sessionStorage)
- Warning returns after browser tab close/reopen
- Global disclaimer footer visible on ALL 5 tabs
- Disclaimer text states "does not constitute tax, legal, or financial advice"
- Entry/exit day warning section present in Compliance tab
- Entry/exit warning explains that days count in BOTH countries
- All COMP requirements (01-10) satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/07-compliance-&-documentation**---treaty-provisions,-warnings,-and-fiscal-source-citations/07-02-SUMMARY.md`
</output>
