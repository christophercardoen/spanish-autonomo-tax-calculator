---
phase: 12-data-architecture-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "Database opens without error on page load"
    - "Loading screen shows during initialization"
    - "All v2.0 entity tables exist in IndexedDB"
    - "Currency input converts to integer cents"
    - "Cents display as formatted euros"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Dexie.js database initialization and MoneyUtils"
      contains: "new Dexie"
  key_links:
    - from: "autonomo_dashboard.html"
      to: "IndexedDB"
      via: "Dexie.js db.open()"
      pattern: "db\\.open\\(\\)"
    - from: "MoneyUtils.eurosToCents"
      to: "currency.js"
      via: "currency() function"
      pattern: "currency\\("
---

<objective>
Create the IndexedDB database foundation using Dexie.js with the complete v2.0 schema, loading screen for migrations, and money utilities for integer cents handling.

Purpose: This establishes the offline-first data layer that all subsequent phases build upon. Correct schema and money handling prevent cascading bugs in invoices, expenses, and tax calculations.

Output: Database initialization code with all entity tables, MoneyUtils module, and loading screen UI.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-data-architecture-foundation/12-CONTEXT.md
@.planning/phases/12-data-architecture-foundation/12-RESEARCH.md
@autonomo_dashboard.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CDN Dependencies and Database Schema</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add CDN script tags in the head section (after fonts, before closing head tag):

```html
<!-- Dexie.js v4.x for IndexedDB -->
<script src="https://unpkg.com/dexie@4/dist/dexie.min.js"></script>

<!-- currency.js for money handling -->
<script src="https://unpkg.com/currency.js@2.0.4/dist/currency.min.js"></script>
```

Create the database schema inside a script tag at the END of the body (before closing body tag). Use the AppDatabase class pattern from RESEARCH.md:

```javascript
// =====================================================
// Phase 12: Data Architecture Foundation
// =====================================================

const DB_NAME = 'AutonomoBusinessDB';
const DB_VERSION = 1;

class AppDatabase extends Dexie {
  constructor() {
    super(DB_NAME);

    this.version(DB_VERSION).stores({
      // Business entities (autonomo, SL)
      entities: '++id, type, nif_cif, name, is_active, created_at, deleted_at',

      // Clients
      clients: '++id, entity_id, nif_cif, name, country, category, created_at, deleted_at, [entity_id+deleted_at]',

      // Projects (per client)
      projects: '++id, client_id, entity_id, name, status, rate_cents, created_at, deleted_at',

      // Invoices (VeriFactu compliant)
      invoices: '++id, entity_id, client_id, series, invoice_number, status, date_issued, date_due, subtotal_cents, iva_cents, irpf_cents, total_cents, deleted_at, [entity_id+series+invoice_number], [entity_id+deleted_at], [entity_id+status]',

      // Invoice line items
      invoice_lines: '++id, invoice_id, description, quantity, unit_price_cents, iva_rate, line_total_cents',

      // Invoice sequences (per entity, per series)
      invoice_sequences: '++id, entity_id, series, last_number, [entity_id+series]',

      // Expenses
      expenses: '++id, entity_id, category, subcategory, vendor, date, amount_cents, iva_cents, deductible_amount_cents, description, is_billable, client_id, project_id, receipt_id, created_at, deleted_at, [entity_id+deleted_at], [entity_id+category], [entity_id+date]',

      // Receipts (linked to expenses)
      receipts: '++id, expense_id, file_name, file_type, file_data, ocr_status, ocr_confidence, ocr_extracted, created_at',

      // Calendar days
      calendar_days: '++id, entity_id, date, location, client_id, project_id, notes, created_at, updated_at, [entity_id+date]',

      // Tax calculations (cached results)
      tax_calculations: '++id, entity_id, tax_type, period_start, period_end, calculated_at, input_data, result_data',

      // Sync queue
      sync_queue: '++id, table_name, record_id, operation, data, created_at, retry_count, last_error',

      // App settings
      settings: 'key, value, updated_at'
    });

    // Define table references
    this.entities = this.table('entities');
    this.clients = this.table('clients');
    this.projects = this.table('projects');
    this.invoices = this.table('invoices');
    this.invoice_lines = this.table('invoice_lines');
    this.invoice_sequences = this.table('invoice_sequences');
    this.expenses = this.table('expenses');
    this.receipts = this.table('receipts');
    this.calendar_days = this.table('calendar_days');
    this.tax_calculations = this.table('tax_calculations');
    this.sync_queue = this.table('sync_queue');
    this.settings = this.table('settings');
  }
}

const db = new AppDatabase();
```

IMPORTANT: Place this BEFORE any existing JavaScript that might try to use the database.
  </action>
  <verify>
Open browser DevTools > Application > IndexedDB. Verify 'AutonomoBusinessDB' exists with all tables listed. Console should show no errors.
  </verify>
  <done>
Database schema defined with 12 tables covering all v2.0 entities. Dexie.js and currency.js loaded via CDN.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Loading Screen and MoneyUtils</name>
  <files>autonomo_dashboard.html</files>
  <action>
**Part A: Add loading screen HTML** (at the start of body, before container):

```html
<!-- Loading Screen for Database Initialization -->
<div id="loading-screen" class="loading-screen">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <p id="loading-status">Initializing database...</p>
  </div>
</div>
```

**Part B: Add loading screen CSS** (in the style section):

```css
/* Loading Screen (Phase 12) */
.loading-screen {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
}

.loading-screen.visible {
  opacity: 1;
  visibility: visible;
}

.loading-content {
  text-align: center;
}

.loading-spinner {
  width: 48px;
  height: 48px;
  border: 4px solid var(--bg-surface);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto var(--spacing-md);
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

#loading-status {
  color: var(--text-muted);
  font-size: var(--size-labels);
}

#loading-status.error {
  color: var(--negative);
}
```

**Part C: Add MoneyUtils module** (after AppDatabase class, in the script section):

```javascript
// =====================================================
// Money Utilities (Integer Cents)
// =====================================================

const MoneyUtils = {
  // Convert user input (euros) to storage (cents)
  eurosToCents(euroValue) {
    if (euroValue === null || euroValue === undefined || euroValue === '') {
      return 0;
    }
    if (typeof euroValue === 'string') {
      // Handle comma as decimal separator (European format)
      euroValue = euroValue.replace(/\s/g, '').replace(',', '.');
    }
    return currency(euroValue, { precision: 2 }).intValue;
  },

  // Convert storage (cents) to numeric euros
  centsToEuros(cents) {
    if (cents === null || cents === undefined) return 0;
    return currency(cents, { fromCents: true, precision: 2 }).value;
  },

  // Format for display with currency symbol (Spanish locale)
  formatEuros(cents, locale = 'es-ES') {
    const euros = this.centsToEuros(cents);
    return new Intl.NumberFormat(locale, {
      style: 'currency',
      currency: 'EUR',
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }).format(euros);
  },

  // Format without symbol (for input fields)
  formatEurosPlain(cents) {
    const euros = this.centsToEuros(cents);
    return euros.toFixed(2);
  },

  // Banker's rounding for tax calculations
  roundCents(cents) {
    if (cents % 1 === 0.5 || cents % 1 === -0.5) {
      const floor = Math.floor(cents);
      return floor % 2 === 0 ? floor : Math.ceil(cents);
    }
    return Math.round(cents);
  },

  // Calculate IVA amount from base
  calculateIVA(baseCents, rate = 0.21) {
    return this.roundCents(baseCents * rate);
  },

  // Add amounts safely (all in cents)
  add(...centAmounts) {
    return centAmounts.reduce((sum, amt) => sum + (amt || 0), 0);
  },

  // Subtract amounts safely (all in cents)
  subtract(fromCents, ...subtractCents) {
    return subtractCents.reduce((result, amt) => result - (amt || 0), fromCents || 0);
  }
};
```

**Part D: Add audit fields helper** (after MoneyUtils):

```javascript
// =====================================================
// Audit Fields Helper
// =====================================================

function auditFields(isCreate = true) {
  const now = new Date().toISOString();
  const userId = getCurrentUserId();

  if (isCreate) {
    return {
      created_at: now,
      updated_at: now,
      created_by: userId,
      updated_by: userId
    };
  }
  return {
    updated_at: now,
    updated_by: userId
  };
}

function getCurrentUserId() {
  // Will be implemented in Phase 14 (Auth)
  // For now, return placeholder
  return 'local-user';
}
```

**Part E: Add database initialization function** (after audit helpers):

```javascript
// =====================================================
// Database Initialization
// =====================================================

async function initializeDatabase() {
  const loadingScreen = document.getElementById('loading-screen');
  const loadingStatus = document.getElementById('loading-status');

  try {
    loadingScreen.classList.add('visible');

    // Step 1: Open database (triggers migrations if needed)
    loadingStatus.textContent = 'Opening database...';
    await db.open();
    console.log('Database opened:', db.name, 'version:', db.verno);

    // Step 2: Verify tables exist
    loadingStatus.textContent = 'Verifying schema...';
    const tables = db.tables.map(t => t.name);
    console.log('Database tables:', tables);

    // Success
    loadingScreen.classList.remove('visible');
    console.log('Database initialized successfully');
    return true;

  } catch (error) {
    console.error('Database initialization failed:', error);
    loadingStatus.textContent = `Error: ${error.message}`;
    loadingStatus.classList.add('error');
    return false;
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
  initializeDatabase().then(success => {
    if (success) {
      console.log('App ready');
      // Existing v1.1 initialization can continue here
    }
  });
});
```
  </action>
  <verify>
1. Refresh page - loading screen should appear briefly then fade
2. Console shows "Database opened: AutonomoBusinessDB version: 1"
3. Console shows "Database tables:" with all 12 table names
4. Test MoneyUtils in console:
   - `MoneyUtils.eurosToCents('1234.56')` returns 123456
   - `MoneyUtils.centsToEuros(123456)` returns 1234.56
   - `MoneyUtils.formatEuros(123456)` returns "1.234,56 EUR" (Spanish format)
  </verify>
  <done>
Loading screen shows during initialization. MoneyUtils module converts between euros and cents correctly. Database opens with schema verification.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Database exists:**
   - Open DevTools > Application > IndexedDB
   - 'AutonomoBusinessDB' should be listed
   - Expand to see all 12 tables

2. **Loading screen works:**
   - Hard refresh (Cmd+Shift+R) to see loading screen
   - Should show spinner briefly, then fade out

3. **MoneyUtils functions:**
   ```javascript
   // Test in console
   console.log(MoneyUtils.eurosToCents('100'));       // 10000
   console.log(MoneyUtils.eurosToCents('99.99'));     // 9999
   console.log(MoneyUtils.eurosToCents('1,234.56'));  // 123456 (handles comma)
   console.log(MoneyUtils.centsToEuros(12345));       // 123.45
   console.log(MoneyUtils.formatEuros(12345));        // "123,45 EUR"
   console.log(MoneyUtils.calculateIVA(10000, 0.21)); // 2100 (21% of 100 EUR)
   ```

4. **No console errors** on page load
</verification>

<success_criteria>
- SYNC-01 partially complete: IndexedDB stores data via Dexie.js
- Database schema includes all v2.0 entity tables
- Currency conversion to/from cents works correctly
- Loading screen provides migration feedback
- Existing v1.1 functionality unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/12-data-architecture-foundation/12-01-SUMMARY.md`
</output>
