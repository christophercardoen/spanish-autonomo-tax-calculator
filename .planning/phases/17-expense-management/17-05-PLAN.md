---
phase: 17-expense-management
plan: 05
type: execute
wave: 3
depends_on: ["17-01", "17-03"]
files_modified: ["autonomo_dashboard.html"]
autonomous: true

must_haves:
  truths:
    - "User can link expense to client/project as billable (EXPENSE-09)"
    - "User can link expense to calendar days via trip dates (EXPENSE-10)"
    - "CalendarManager.getLinkedExpenseCount returns real expense counts (not placeholder 0)"
    - "Calendar day cells show expense count badge when expenses exist for that date"
    - "System calculates total deductible amount based on category rules (EXPENSE-11)"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Updated CalendarManager integration, expense-calendar linking"
      contains: "getLinkedExpenseCount"
  key_links:
    - from: "CalendarManager.getLinkedExpenseCount"
      to: "db.expenses"
      via: "compound index query [entity_id+date]"
      pattern: "db\\.expenses\\.where.*entity_id.*date"
    - from: "expense form"
      to: "CalendarManager"
      via: "date field links expense to calendar day"
      pattern: "expense\\.date"
---

<objective>
Wire expense-calendar linking so calendar day cells show real expense counts, and ensure client/project linking and deduction calculation are fully integrated end-to-end.

Purpose: Connect the Phase 17 expense data to Phase 16's calendar infrastructure (EXPENSE-10, EXPENSE-11) and enable billable expense tracking (EXPENSE-09).
Output: Updated CalendarManager integration, expense-calendar day linking, end-to-end deduction calculation verification.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-expense-management/17-RESEARCH.md
@.planning/phases/17-expense-management/17-01-SUMMARY.md
@.planning/phases/17-expense-management/17-03-SUMMARY.md
@autonomo_dashboard.html (lines 19955-20024 for CalendarManager expense count methods, 20700-20730 for day editor expense display, 20990-21010 for month rendering expense counts)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire calendar-expense integration and day editor expense panel</name>
  <files>autonomo_dashboard.html</files>
  <action>
The CalendarManager methods getLinkedExpenseCount() and getLinkedExpenseCounts() are already implemented and query db.expenses correctly (lines 19962-20024). They return real data once expenses exist in the table. No changes needed to those methods.

What IS needed:

**1. Update the calendar day editor to show linked expenses:**
Find the day editor modal rendering (around line 20723 where getLinkedExpenseCount is called). Currently it shows the expense count. Enhance this to also show a mini expense list for the selected day:

- After the expense count display, add a "Day Expenses" section
- Call ExpenseManager.getExpensesByDate(dateKey) to get expenses for this day
- Render a compact list: each expense shows category icon, vendor, amount, deductible amount
- Add an "Add Expense for This Day" button that opens the expense form dialog with the date pre-filled
- If trip expenses span this day (trip_start_date <= dateKey <= trip_end_date), show those too with a "trip" badge

**2. Travel expense date range display on calendar:**
When rendering calendar day cells, in addition to the existing expense count badge (which counts expenses by date), also check for travel expenses that span multiple days:
- Add a method to ExpenseManager: `getExpensesForDateRange(startDate, endDate)` that returns expenses where `trip_start_date <= endDate AND trip_end_date >= startDate` (overlapping range query)
- This method is used by the day editor to show trip-linked expenses, not for the calendar cells (which use the simpler date-based count)

**3. Add "Link to Calendar Day" option in expense form:**
The expense form's date field already serves as the calendar link (since CalendarManager queries by date). But for travel expenses, the trip_start_date and trip_end_date create a multi-day link.

When a travel expense is saved with trip dates:
- The expense appears in calendar day counts for the receipt date (expense.date)
- The day editor for any date within the trip range shows the travel expense with a "trip" badge

**4. Client/project expense display:**
In the client detail page's expenses tab (around line 19240 where the TODO comment exists), replace the placeholder with real data:
- Call ExpenseManager.getExpenses({ client_id: clientId }) to get billable expenses
- Render a summary: total billable amount, list of recent expenses
- This connects EXPENSE-09 (link to client) with the client detail view

Find the existing placeholder comment: "// TODO: When expenses exist (Phase 17), sum from db.expenses where client_id = clientId" and implement it.
  </action>
  <verify>Check that the day editor shows expenses for the selected date. Verify getExpensesForDateRange method exists on ExpenseManager. Check that the client detail expenses tab shows real data instead of placeholder. Verify calendar cells still render expense count badges.</verify>
  <done>Calendar day editor shows linked expenses list with "Add Expense for This Day" button. Travel expenses with trip dates appear in day editor for any date within the trip range. Client detail expenses tab shows billable expenses from ExpenseManager. getExpensesForDateRange method exists for multi-day travel queries.</done>
</task>

<task type="auto">
  <name>Task 2: End-to-end deduction calculation integration</name>
  <files>autonomo_dashboard.html</files>
  <action>
Ensure EXPENSE-11 (system calculates total deductible amount) is fully wired end-to-end:

**1. Deduction display in expense list:**
Verify that renderExpenseList() shows both amount_cents and deductible_amount_cents for each expense. Add a visual indicator when deductible != amount (partial deduction):
- Full deduction (100%): green amount, no indicator
- Partial deduction: show both amounts, with deductible in green and a small percentage badge
- Zero deduction: red "Not deductible" badge

**2. Deduction recalculation on edit:**
When expense is edited (category change, amount change, metadata change), ensure updateExpense recalculates deductible_amount_cents. The ExpenseManager.updateExpense method (from 17-01) should handle this, but verify the wiring in submitExpenseForm.

**3. Category-specific deduction display in form:**
When user selects a category in the expense form, show a hint about the deduction rules:
- HOME_OFFICE: "30% maximum deductible (Autonomo)"
- GSM: "50% deductible (Autonomo)" or "100% deductible (SL)"
- VEHICLE: "0% IRPF deductible, 50% IVA (Autonomo)" or "100% if company asset (SL)"
- MEALS_DIETAS: "Limit: €91.35/day abroad with overnight (Autonomo)"
- TRAVEL/IT/OFFICE/etc.: "100% deductible"

Display this hint below the category select in the expense form.

**4. Expense summary by category in Expense Tracker section:**
Below the expense list, add a collapsible "Deduction Summary" section that groups total expenses and deductible amounts by category:
```
Category          | Total    | Deductible | Rate
Travel            | €2,500   | €2,500     | 100%
Home Office       | €1,155   | €346.50    | 30%
Meals / Dietas    | €182.70  | €182.70    | limit
IT / Software     | €49.99   | €49.99     | 100%
─────────────────────────────────────────────────
Total             | €3,887   | €3,079     | 79%
```

Use ExpenseManager.getExpenseSummary() with grouping by category.
  </action>
  <verify>Check that expense list shows deduction indicators (full/partial/zero). Verify category hint appears in expense form when category selected. Verify deduction summary section renders grouped totals. Check that recalculation works when editing expense category.</verify>
  <done>Expense list shows deductible amounts with visual indicators (full/partial/zero). Category selection in form shows deduction rule hint. Deduction summary by category with totals appears below expense list. Editing an expense recalculates deduction correctly.</done>
</task>

</tasks>

<verification>
1. Calendar day cells show expense count badges (existing behavior, now with real data)
2. Calendar day editor shows mini expense list for selected date
3. "Add Expense for This Day" opens form with pre-filled date
4. Travel expenses appear in day editor for any date in trip range
5. Client detail page shows billable expenses from ExpenseManager
6. Deduction indicators visible in expense list (full/partial/zero)
7. Category hint shows deduction rules in expense form
8. Deduction summary by category renders with correct totals
9. No console errors
</verification>

<success_criteria>
- Calendar-expense link works: expenses show on calendar days (EXPENSE-10)
- Client-expense link works: billable expenses appear in client detail (EXPENSE-09)
- Deduction calculation correct end-to-end for all categories (EXPENSE-11)
- Visual deduction indicators in list and form
- Deduction summary by category with totals
- Zero console errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-expense-management/17-05-SUMMARY.md`
</output>
