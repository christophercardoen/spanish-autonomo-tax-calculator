---
phase: 17-expense-management
plan: 07
type: execute
wave: 4
depends_on: ["17-05", "17-06"]
files_modified: ["autonomo_dashboard.html"]
autonomous: false

must_haves:
  truths:
    - "User can create expense manually and see it in the list (EXPENSE-01, EXPENSE-12)"
    - "Receipt OCR auto-fills expense form fields (EXPENSE-02)"
    - "Category rules differ by entity type: autonomo 30% home office, SL 100% (EXPENSE-04, EXPENSE-05)"
    - "Dietas limits validated at 91.35 EUR/day Belgium with overnight (EXPENSE-08)"
    - "Expense linked to calendar day shows in day editor (EXPENSE-10)"
    - "Expense list filterable by date, category, client (EXPENSE-13)"
    - "Billable marking works and shows in client detail (EXPENSE-14)"
    - "All v1 expense sections still functional"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Complete Phase 17 expense management system"
  key_links:
    - from: "Expense form"
      to: "ExpenseManager"
      via: "submitExpenseForm -> createExpense"
    - from: "Expense list"
      to: "ExpenseManager"
      via: "renderExpenseList -> getExpenses"
    - from: "Calendar"
      to: "ExpenseManager"
      via: "getLinkedExpenseCount -> db.expenses"
---

<objective>
Browser-test the complete Phase 17 expense management system and fix any issues found.

Purpose: Ensure all 15 EXPENSE requirements work correctly in the browser before presenting to the user.
Output: Bug-free Phase 17 implementation, all console errors resolved, verification script.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-expense-management/17-RESEARCH.md
@.planning/phases/17-expense-management/17-01-SUMMARY.md
@.planning/phases/17-expense-management/17-02-SUMMARY.md
@.planning/phases/17-expense-management/17-03-SUMMARY.md
@.planning/phases/17-expense-management/17-04-SUMMARY.md
@.planning/phases/17-expense-management/17-05-SUMMARY.md
@.planning/phases/17-expense-management/17-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Browser test and fix all console errors</name>
  <files>autonomo_dashboard.html</files>
  <action>
Open http://localhost:3013/autonomo_dashboard.html in the browser and perform comprehensive testing:

**1. Page Load Test:**
- Navigate to the page
- Check console for ANY JavaScript errors (use read_console_messages with error pattern)
- Fix any errors found (syntax, reference, undefined variables)

**2. Expenses Tab Navigation:**
- Click on the Expenses tab
- Verify v1 sections still render (Spain Deductible, Work Travel, Private)
- Verify the "Expense Tracker" section appears below v1 sections
- Verify "Add Expense" button is visible
- Take screenshot for verification

**3. Expense Creation Flow:**
- Click "Add Expense" button
- Verify dialog opens with all fields
- Verify category select is populated based on entity type
- Fill in a test expense (date: today, vendor: "Test Vendor", amount: 50.00, category: IT_SOFTWARE)
- Submit the form
- Verify expense appears in the list
- Check console for errors during creation

**4. Filter Testing:**
- Create 3 test expenses with different categories and dates
- Test date range filter
- Test category filter
- Test that summary bar updates with filtered totals

**5. Edit and Archive:**
- Click edit on an expense
- Verify form pre-fills with existing data
- Change the amount, save
- Verify list updates
- Click archive on an expense
- Verify confirmation dialog appears
- Confirm archive
- Verify expense removed from list

**6. Calendar Integration:**
- Switch to Calendar tab
- Click on a date that has an expense
- Verify expense count appears (or verify the day editor shows linked expenses)

**7. Fix any issues found:**
- Fix all console errors
- Fix any rendering issues
- Fix any broken interactions
- Commit fixes with format: `fix(17): {description}`

**8. Create verification script:**
Write scripts/verify-phase-17.js (or similar) that tests:
- EXPENSE_CATEGORY has 10 categories
- ExpenseManager has all required methods
- ReceiptManager has all required methods
- validateDietas returns correct results for test cases
  </action>
  <verify>Zero console errors on page load and during expense operations. All tabs render correctly. Expense CRUD flow works end-to-end. Calendar shows expense counts.</verify>
  <done>Browser testing complete with zero console errors. All expense operations (create, list, filter, edit, archive) work in the browser. Calendar integration shows real expense counts. V1 expense sections remain functional.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Phase 17 Expense Management - Complete expense tracking system with:
1. EXPENSE_CATEGORY config with 10 categories and entity-type-aware deduction rules
2. ExpenseManager with full CRUD, deduction calculation, entity scoping
3. ReceiptManager with lazy-loaded Tesseract.js OCR and image compression
4. Expense form dialog with conditional fields (travel, meals, home office)
5. Expense list with 5 filters (date range, category, client, billable)
6. Calendar-expense linking (real expense counts on calendar days)
7. Client-expense linking (billable expenses in client detail)
8. Dietas validation with real-time warnings (AEAT limits)
9. Receipt-linked deletion protection (soft delete only)
10. Deduction summary by category with totals
  </what-built>
  <how-to-verify>
1. Open http://localhost:3013/autonomo_dashboard.html
2. Go to Expenses tab - verify v1 "Monthly Fixed Costs" sections still visible above
3. See "Expense Tracker" section with "Add Expense" button below
4. Click "Add Expense" - dialog should open with entity-type-specific categories
5. Fill in: Date=today, Vendor="Test Flight", Amount=150.00, Category=Travel, Destination=BE
6. Submit - expense should appear in the list with "€150.00" amount and "€150.00" deductible
7. Create another: Category=Meals/Dietas, Amount=120.00, Destination=BE, Overnight=checked
8. Should see warning: amount exceeds dietas limit of €91.35/day
9. Change to payment=Cash - should see red warning about cash not deductible
10. Go to Calendar tab - if expense date matches a calendar day, expense count should show
11. Use filters to filter by category, verify summary bar updates
12. Click edit on an expense, change amount, save - verify list updates
13. Click archive on an expense, confirm - verify removed from list
14. Check browser console (F12) for any errors
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
All 15 EXPENSE requirements covered:
- EXPENSE-01: Manual expense creation (form dialog)
- EXPENSE-02: Receipt OCR auto-fill (ReceiptManager)
- EXPENSE-03: All required fields present (date, amount, vendor, description, category, receipt)
- EXPENSE-04: Autonomo categories with correct deduction rules
- EXPENSE-05: SL categories with correct deduction rules
- EXPENSE-06: Home office percentage field for autonomo
- EXPENSE-07: Travel destination and trip date fields
- EXPENSE-08: Dietas limit validation (91.35/48.08/53.34/26.67)
- EXPENSE-09: Client/project linking for billable expenses
- EXPENSE-10: Calendar day linking via date field
- EXPENSE-11: Deductible amount calculated by category rules
- EXPENSE-12: List shows date, vendor, amount, category, deductible, client
- EXPENSE-13: Filters: date range, category, client, billable
- EXPENSE-14: Billable marking with client association
- EXPENSE-15: Soft delete only for receipt-linked expenses
</verification>

<success_criteria>
- All 15 EXPENSE requirements demonstrably working
- Zero console errors
- V1 expense sections (Monthly Fixed Costs) still functional
- Calendar integration shows real expense counts
- Dietas validation matches AEAT limits
- Entity-type polymorphism working (autonomo vs SL show different rules)
</success_criteria>

<output>
After completion, create `.planning/phases/17-expense-management/17-07-SUMMARY.md`
</output>
