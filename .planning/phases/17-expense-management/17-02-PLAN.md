---
phase: 17-expense-management
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: ["autonomo_dashboard.html"]
autonomous: true

must_haves:
  truths:
    - "ReceiptManager can store receipt images in IndexedDB after compressing them"
    - "ReceiptManager can lazy-load Tesseract.js and scan receipt images for text"
    - "parseReceiptText extracts vendor, date, and amount from OCR text"
    - "Receipt images are compressed to max 1024px width and JPEG quality 0.7 before storage"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "ReceiptManager singleton, compressImage function"
      contains: "const ReceiptManager"
  key_links:
    - from: "ReceiptManager"
      to: "db.receipts"
      via: "Dexie add operation"
      pattern: "db\\.receipts\\.add"
    - from: "ReceiptManager"
      to: "Tesseract"
      via: "lazy-loaded CDN script"
      pattern: "tesseract\\.min\\.js"
---

<objective>
Create the ReceiptManager singleton with OCR scanning capability and receipt image storage with compression.

Purpose: Enable receipt upload and text extraction (EXPENSE-02) independent of the expense form UI, so receipt data can auto-populate expense fields.
Output: ReceiptManager singleton and compressImage utility function added to autonomo_dashboard.html.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-expense-management/17-RESEARCH.md
@autonomo_dashboard.html (lines 13429-13430 for receipts schema)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create compressImage utility and ReceiptManager singleton</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add the ReceiptManager singleton and compressImage function after where ExpenseManager will be placed (or after ProjectManager if 17-01 hasn't run yet - they're wave 1 parallel, so place after a clear section marker). Add a section comment: "// ===== Receipt Manager (Phase 17) ====="

**1. compressImage(file, maxWidth = 1024, quality = 0.7)**
- Takes a File object (from input[type=file])
- Creates FileReader -> Image -> Canvas pipeline
- Scales down to maxWidth preserving aspect ratio (only if image is wider)
- Converts to JPEG blob at specified quality
- Returns Promise<Blob>
- Handles errors gracefully (returns original file if compression fails)

**2. ReceiptManager singleton with these methods:**

a. **_worker** - private property, null initially (Tesseract worker instance)

b. **getWorker()** - Lazy-loads Tesseract.js
   - If window.Tesseract doesn't exist, dynamically load script from CDN:
     `https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js`
   - Use _loadScript helper that creates script element and returns Promise
   - Create worker with `Tesseract.createWorker('eng+spa')` for English + Spanish
   - Cache in this._worker
   - Return worker

c. **_loadScript(src)** - Helper to dynamically load a script tag
   - Creates script element, sets src, appends to document.head
   - Returns Promise resolved on onload, rejected on onerror

d. **scanReceipt(imageFile)** - Main OCR method
   - Gets worker via getWorker()
   - Calls worker.recognize(imageFile)
   - Passes result.data.text to parseReceiptText()
   - Returns { vendor, date, amount_euros, raw_text, confidence: result.data.confidence }

e. **parseReceiptText(text)** - Extract structured data from OCR text
   - Split text into non-empty lines
   - Vendor: first non-empty line, trimmed
   - Date: regex for DD/MM/YYYY or DD.MM.YYYY or DD-MM-YYYY patterns, normalize to YYYY-MM-DD
     - Handle both 2-digit and 4-digit years
   - Amount: regex for patterns like "TOTAL: 12.50", "IMPORTE: €15,30", "AMOUNT: $20.00"
     - Match: /(?:total|importe|amount|suma|a pagar)[:\s]*[€$]?\s*([\d.,]+)/i
     - Replace comma with dot for parsing
   - Return { vendor, date, amount_euros, raw_text: text }

f. **storeReceipt(expenseId, file)** - Store compressed receipt in IndexedDB
   - First compress the image via compressImage(file)
   - Convert compressed blob to base64 data URL via FileReader
   - Add to db.receipts: { expense_id: expenseId, file_name: file.name, file_type: 'image/jpeg', file_data: base64DataUrl, ocr_status: 'pending', ocr_confidence: null, ocr_extracted: null, created_at: new Date().toISOString() }
   - Return receipt ID

g. **getReceipt(receiptId)** - Get receipt by ID from db.receipts

h. **getReceiptByExpense(expenseId)** - Get receipt linked to an expense
   - Query db.receipts.where('expense_id').equals(expenseId).first()

i. **updateOcrResult(receiptId, extracted, confidence)** - Update receipt with OCR results
   - Updates ocr_status to 'completed', ocr_confidence, ocr_extracted (JSON of parsed data)

j. **terminateWorker()** - Cleanup Tesseract worker
   - If this._worker exists, call this._worker.terminate()
   - Set this._worker = null

IMPORTANT: The Tesseract.js CDN script tag should NOT be added to the HTML head statically. It must be lazy-loaded only when scanReceipt is called (to avoid 5MB+ download on page load).
  </action>
  <verify>Search for "const ReceiptManager" in the file. Verify it has getWorker, scanReceipt, parseReceiptText, storeReceipt, getReceipt, getReceiptByExpense, updateOcrResult, terminateWorker methods. Verify compressImage function exists. Verify no static Tesseract script tag in HTML head.</verify>
  <done>ReceiptManager singleton exists with OCR scanning (lazy-loaded Tesseract.js), receipt storage with compression (max 1024px, JPEG 0.7), and receipt CRUD. compressImage utility function compresses images before IndexedDB storage. No static Tesseract script tag added to page head.</done>
</task>

</tasks>

<verification>
1. ReceiptManager has all required methods (10 methods/properties)
2. Tesseract.js loaded lazily via dynamic script injection (not in HTML head)
3. compressImage scales down to maxWidth and converts to JPEG
4. parseReceiptText handles European date formats (DD/MM/YYYY)
5. parseReceiptText finds amount patterns in Spanish and English
6. Receipt stored as compressed JPEG base64 in db.receipts
7. Page loads without console errors (Tesseract not loaded until needed)
</verification>

<success_criteria>
- ReceiptManager singleton with lazy-loaded Tesseract.js OCR
- compressImage reduces images to max 1024px width, JPEG quality 0.7
- parseReceiptText extracts vendor, date (YYYY-MM-DD), amount from OCR text
- Receipt images stored as compressed base64 in db.receipts
- No impact on page load time (Tesseract loaded only on demand)
- Zero console errors on page load
</success_criteria>

<output>
After completion, create `.planning/phases/17-expense-management/17-02-SUMMARY.md`
</output>
