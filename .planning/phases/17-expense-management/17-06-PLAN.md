---
phase: 17-expense-management
plan: 06
type: execute
wave: 3
depends_on: ["17-03", "17-04"]
files_modified: ["autonomo_dashboard.html"]
autonomous: true

must_haves:
  truths:
    - "System validates Belgium dietas limit €91.35/day with overnight, €48.08 without (EXPENSE-08)"
    - "User can mark expense as Billable and it shows in client detail (EXPENSE-14)"
    - "System prevents hard-deleting expenses with linked receipts, uses soft delete only (EXPENSE-15)"
    - "Cash payment warning appears for autonomo dietas expenses"
    - "Dietas validation shows warnings in form before submission"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "validateDietas function, dietas warning display, billable marking UI"
      contains: "validateDietas"
  key_links:
    - from: "validateDietas"
      to: "EXPENSE_CATEGORY.MEALS_DIETAS"
      via: "dietas limit lookup"
      pattern: "EXPENSE_CATEGORY.*MEALS_DIETAS"
    - from: "submitExpenseForm"
      to: "validateDietas"
      via: "pre-submit validation"
      pattern: "validateDietas"
---

<objective>
Implement dietas validation with real-time warnings, billable expense marking, and receipt-linked deletion protection.

Purpose: Ensure fiscal compliance for autonomo dietas (EXPENSE-08), enable expense-to-client billing workflow (EXPENSE-14), and protect receipt-linked expense integrity (EXPENSE-15).
Output: validateDietas function, dietas warning UI, billable toggle enhancement, and soft delete guard in autonomo_dashboard.html.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-expense-management/17-RESEARCH.md
@.planning/phases/17-expense-management/17-03-SUMMARY.md
@.planning/phases/17-expense-management/17-04-SUMMARY.md
@autonomo_dashboard.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement dietas validation with real-time form warnings</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add the validateDietas function and wire it into the expense form for real-time feedback.

**1. validateDietas(expenseData, entityType) function:**
Place near the ExpenseManager. This is a standalone validation function (not on ExpenseManager) called from the form.

Logic:
- If entityType is not AUTONOMO, return { valid: true, warnings: [] }
- If category is not 'MEALS_DIETAS', return { valid: true, warnings: [] }
- Check warnings:
  a. **Cash payment:** If payment_method === 'cash', add warning: "Dietas paid in cash are NOT deductible since 2018. Use card, transfer, or Bizum."
  b. **No destination:** If !destination, add warning: "Destination required for dietas deduction."
  c. **Same municipality:** If destination === 'home' or destination matches user's municipality, add warning: "Dietas in your municipality of residence are NOT deductible."
  d. **Daily limit exceeded:** Calculate applicable limit:
     - isAbroad = destination && destination !== 'ES'
     - hasOvernight = has_overnight === true
     - Limits (cents): Spain no overnight: 2667, Spain overnight: 5334, Abroad no overnight: 4808, Abroad overnight: 9135
     - If amount_cents > limitCents: add warning with the specific limit in euros
  e. **Electronic payment required:** If payment_method is not set, add info: "Remember: electronic payment required for dietas deduction (card, transfer, Bizum)."
- Return { valid: warnings.length === 0, warnings, deductible_limit_cents: limitCents }

**2. Wire into expense form - real-time validation:**
When category is MEALS_DIETAS:
- On amount change, destination change, overnight toggle, or payment method change: call validateDietas with current form values
- Display warnings in a `.dietas-warnings` div below the conditional fields area:
  - Each warning as a styled alert (yellow background, dark text for warnings; red for blocking issues)
  - Use icon prefix: yellow triangle for warnings, red circle for errors
- Warnings should NOT prevent submission (they are advisory), except cash payment which should show a strong red warning

**3. Wire into submitExpenseForm - pre-submit check:**
Before creating/updating the expense:
- If category is MEALS_DIETAS and entity type is AUTONOMO:
  - Run validateDietas
  - If warnings exist, show them and ask user to confirm: "There are dietas warnings. Save anyway?"
  - If user confirms or no warnings: proceed with save
  - Store the warnings as part of expense metadata (so they can be shown in the list view too)

**4. Dietas badge in expense list:**
When rendering expense list rows where category is MEALS_DIETAS:
- If expense has warnings (stored in metadata), show a small warning icon next to the amount
- Tooltip shows the specific warnings
- If payment was cash, show red "Cash - Not deductible" badge

**5. Payment method CSS:**
Style the payment method selector to highlight "cash" option with a subtle red tint when category is MEALS_DIETAS and entity is autonomo.
  </action>
  <verify>Search for "validateDietas" in the file. Verify it checks: cash payment, no destination, daily limit, electronic payment. Verify warnings display in the expense form when MEALS_DIETAS selected. Verify pre-submit confirmation for dietas warnings. Check dietas badge in expense list.</verify>
  <done>validateDietas function validates 5 conditions for autonomo dietas. Real-time warnings display in expense form when MEALS_DIETAS category selected. Pre-submit confirmation for dietas warnings. Cash payment warning prominently displayed. Expense list shows dietas warning badges. Limits match AEAT: Spain 26.67/53.34, Abroad 48.08/91.35.</done>
</task>

<task type="auto">
  <name>Task 2: Implement billable marking and receipt-linked deletion protection</name>
  <files>autonomo_dashboard.html</files>
  <action>
**1. Billable expense enhancement (EXPENSE-14):**
The expense form already has a "Billable" checkbox (from 17-03). Enhance the end-to-end flow:

a. When expense is marked billable and linked to a client:
   - The expense appears in the client detail page's expenses section (wired in 17-05)
   - In the expense list, show a "Billable" badge (green) next to the client name
   - In the expense form, when billable is checked, client field becomes required (show validation error if no client)

b. Add a "Billable Expenses" quick filter in the expense filter bar:
   - Already exists as expFilterBillable select (from 17-04)
   - Ensure it correctly filters via ExpenseManager.getExpenses({ is_billable: true/false })

c. In expense list summary bar, when billable filter is active, show:
   - "Billable Total: €X,XXX (Y expenses for Z clients)"

**2. Receipt-linked deletion protection (EXPENSE-15):**
The ExpenseManager.archiveExpense method (from 17-01) already uses DataManager.softDelete which is always a soft delete. EXPENSE-15 says "System prevents deleting expenses with linked receipts (soft delete only)."

This is already satisfied by the architecture (all deletes are soft deletes via DataManager). But add extra protection:

a. In archiveExpenseConfirm(expenseId):
   - Check if expense has a receipt_id (linked receipt)
   - If yes: show message "This expense has a linked receipt. It will be archived (soft deleted) and can be restored within 30 days."
   - If no: show standard archive confirmation
   - In both cases: use DataManager.softDelete (never hard delete)

b. Add a visual indicator in the expense list when an expense has a linked receipt:
   - Small receipt/paperclip icon next to the vendor name
   - Tooltip: "Has receipt attached"
   - Clicking the icon opens a mini preview of the receipt (if receipt image stored in db.receipts)

c. Receipt preview mini-modal:
   - Simple overlay showing the receipt image
   - Close button
   - "View Full Size" button that opens in new window/tab
   - Load receipt data from ReceiptManager.getReceiptByExpense(expenseId)

**3. Archive list (bonus if time):**
If straightforward, add a "Show Archived" toggle at the bottom of the expense list that shows soft-deleted expenses with a "Restore" button. Use DataManager.getDeleted('expenses', entityId) for this.
  </action>
  <verify>Search for "Billable" and "receipt" keywords in the expense form area. Verify billable badge shows in expense list. Verify archiveExpenseConfirm checks for receipt_id. Verify receipt icon appears for expenses with linked receipts. Verify receipt preview mini-modal exists.</verify>
  <done>Billable expenses show green badge in list, client required when billable checked. Receipt-linked expenses show paperclip icon with preview on click. Archive confirmation mentions receipt for linked expenses. All deletes use DataManager.softDelete (EXPENSE-15 satisfied). Optional: archived expenses toggle with restore button.</done>
</task>

</tasks>

<verification>
1. Dietas validation catches: cash payment, missing destination, exceeded daily limit
2. Real-time warnings display when entering MEALS_DIETAS expense as autonomo
3. Pre-submit confirmation for dietas with warnings
4. Cash payment shows prominent red warning
5. Billable badge appears in expense list for billable expenses
6. Client field required when billable checkbox is checked
7. Receipt icon shows for expenses with linked receipts
8. Receipt preview loads and displays image
9. Archive confirmation mentions receipt when linked
10. All deletes are soft deletes (DataManager.softDelete)
11. No console errors
</verification>

<success_criteria>
- Dietas limits validated: Spain 26.67/53.34, Abroad 48.08/91.35 (EXPENSE-08)
- Cash payment warning for autonomo dietas
- Billable expenses tracked and displayed with badge (EXPENSE-14)
- Receipt-linked expenses protected by soft delete only (EXPENSE-15)
- Receipt preview available from expense list
- Zero console errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-expense-management/17-06-SUMMARY.md`
</output>
