---
phase: 17-expense-management
plan: 03
type: execute
wave: 2
depends_on: ["17-01", "17-02"]
files_modified: ["autonomo_dashboard.html"]
autonomous: true

must_haves:
  truths:
    - "User can open expense form dialog from the Expenses tab"
    - "Expense form shows categories filtered by current entity type (autonomo vs SL)"
    - "User can fill date, vendor, amount, category, description and save to IndexedDB"
    - "User can upload a receipt image and have OCR auto-populate vendor/date/amount"
    - "For travel expenses, form shows destination and trip date fields (EXPENSE-07)"
    - "For home office (autonomo), form shows deductible percentage field (EXPENSE-06)"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Expense form dialog HTML, openExpenseFormDialog, submitExpenseForm functions"
      contains: "expenseFormDialog"
  key_links:
    - from: "submitExpenseForm"
      to: "ExpenseManager.createExpense"
      via: "form submission handler"
      pattern: "ExpenseManager\\.createExpense"
    - from: "openExpenseFormDialog"
      to: "EXPENSE_CATEGORY"
      via: "category select population"
      pattern: "EXPENSE_CATEGORY"
    - from: "receipt file input"
      to: "ReceiptManager.scanReceipt"
      via: "file change handler"
      pattern: "ReceiptManager\\.scanReceipt"
---

<objective>
Build the expense creation/edit form dialog with entity-type-aware category selection, receipt upload with OCR auto-fill, and conditional fields for travel and home office expenses.

Purpose: Enable users to manually create expenses (EXPENSE-01) or create from OCR-populated receipt (EXPENSE-02) with all required fields (EXPENSE-03).
Output: Expense form dialog HTML and JavaScript handler functions added to the Expenses tab.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-expense-management/17-RESEARCH.md
@.planning/phases/17-expense-management/17-01-SUMMARY.md
@.planning/phases/17-expense-management/17-02-SUMMARY.md
@autonomo_dashboard.html (lines 7525-7577 for existing expenses tab, 7536 for existing addExpenseDialog pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add expense form dialog HTML and "Add Expense" button</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add a new dialog element `expenseFormDialog` inside the expenses tab section (inside `.expenses-container`, after the existing v1 expense sections but before the closing `</div>` of expenses-container). Also add an "Add Expense" button that opens this dialog.

**Important:** The v1 expense sections (spainSection, workTravelSection, privateSection) must remain untouched. The new system coexists as "Expense Tracker" below the v1 "Monthly Fixed Costs" sections. Add a visual separator (an `<hr>` with styling or a section header).

Add this structure:

```html
<!-- Phase 17: Expense Tracker Section -->
<div class="expense-tracker-section" style="margin-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h3 style="margin: 0;">Expense Tracker</h3>
    <button class="primary-btn" data-permission="edit" data-permission-type="expense" onclick="openExpenseFormDialog()">+ Add Expense</button>
  </div>
  <div id="expenseTrackerList">
    <!-- Populated by renderExpenseList() -->
    <div class="empty-state" style="text-align: center; padding: 2rem; opacity: 0.5;">
      No expenses tracked yet. Click "Add Expense" to get started.
    </div>
  </div>
</div>
```

**Expense Form Dialog** (`expenseFormDialog`):
- Use `<dialog>` element matching the existing dialog pattern (addExpenseDialog at line 7536)
- Dialog has: header with title + close button, form body, footer with Cancel + Save
- Add CSS class `expense-form-dialog` for styling

Dialog form fields:
1. **Date** - input type="date", required, default today
2. **Vendor** - text input, placeholder "e.g., Ryanair, Amazon, Gestor X"
3. **Amount (EUR)** - number input, step="0.01", min="0", required
4. **IVA Amount (EUR)** - number input, step="0.01", min="0", default 0 (optional)
5. **Category** - select, populated dynamically from EXPENSE_CATEGORY based on entity type
6. **Subcategory** - select, populated when category has subcategories, hidden when not
7. **Description** - textarea, 2 rows, optional
8. **Receipt Upload** - file input (accept="image/*,.pdf"), with "Scan with OCR" button
9. **OCR Status** - hidden area that shows scanning progress and extracted data

**Conditional fields (shown/hidden based on category):**
10. **Destination** - text input (shown for TRAVEL and MEALS_DIETAS), placeholder "e.g., BE, ES, NL"
11. **Trip Start Date** - date input (shown for TRAVEL)
12. **Trip End Date** - date input (shown for TRAVEL)
13. **Has Overnight** - checkbox (shown for MEALS_DIETAS and TRAVEL)
14. **Payment Method** - select: card, transfer, bizum, cash (shown for MEALS_DIETAS)
15. **Deductible %** - number input (shown for HOME_OFFICE when autonomo), default 30, max 30
16. **Client** - select, populated from ClientManager (optional, for EXPENSE-09)
17. **Project** - select, populated from ProjectManager when client selected (optional)
18. **Billable** - checkbox (EXPENSE-14), shown when client is selected

Dialog footer: Cancel button (class="secondary-btn") and Save Expense button (class="primary-btn").

**CSS:** Add styles for the dialog matching existing dialog styles (.expense-dialog pattern). Style conditional fields container with class "conditional-fields". Hidden conditional fields should use display:none.

**Edit mode:** The dialog should support both create and edit. When editing, the dialog title changes to "Edit Expense", form pre-fills with existing data, and save calls updateExpense instead of createExpense. Use a data attribute `data-edit-id` on the dialog to track edit mode.
  </action>
  <verify>Search for "expenseFormDialog" in the file. Verify dialog has all 18 fields. Check that "Add Expense" button exists in the expense tracker section. Verify v1 expense sections (spainSection, workTravelSection, privateSection) are still present and untouched.</verify>
  <done>Expense form dialog with 18 fields exists in HTML. "Add Expense" button opens the dialog. Category select will be populated dynamically based on entity type. Conditional fields for travel, meals, and home office are present with display:none defaults. Edit mode supported via data-edit-id attribute. V1 expense sections remain intact.</done>
</task>

<task type="auto">
  <name>Task 2: Implement form JavaScript handlers (open, submit, OCR, conditional fields)</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add JavaScript functions to handle the expense form dialog. Place these in the script section after ReceiptManager (or after the Phase 17 manager objects).

**1. openExpenseFormDialog(editId = null)**
- Reset form, clear data-edit-id
- Get current entity from EntityContext.current
- Populate category select from EXPENSE_CATEGORY filtered by entity type:
  - Filter out categories with sl_only: true when entity is autonomo
  - For each category: `<option value="${key}">${cat.label}</option>`
- Populate client select from ClientManager.getClients() (async)
- If editId provided:
  - Load expense from ExpenseManager.getExpense(editId)
  - Pre-fill all fields (convert cents to euros for amount fields)
  - Set dialog title to "Edit Expense"
  - Set data-edit-id attribute
- Show dialog via dialog.showModal()

**2. onExpenseCategoryChange(selectElement)**
- Get selected category key
- Get category config from EXPENSE_CATEGORY
- Show/hide conditional fields based on category:
  - TRAVEL: show destination, trip_start_date, trip_end_date, has_overnight
  - MEALS_DIETAS: show destination, has_overnight, payment_method
  - HOME_OFFICE (autonomo only): show deductible percentage field
  - All others: hide all conditional fields
- If category has subcategories, populate and show subcategory select
- Otherwise hide subcategory select

**3. onExpenseClientChange(selectElement)**
- If client selected, load projects via ProjectManager.getProjectsByClient(clientId)
- Populate project select with loaded projects
- Show billable checkbox
- If no client selected, hide project select and billable checkbox

**4. handleReceiptUpload(fileInput)**
- Get file from input
- Show "Scanning..." indicator in OCR status area
- Call ReceiptManager.scanReceipt(file)
- On success: auto-fill vendor, date, amount fields from OCR result
- Show confidence badge (green if >85%, orange if 60-85%, red if <60%)
- Show extracted raw text in collapsible area for verification
- Store file reference for later storeReceipt() call on form submission
- On error: show error message, allow manual entry

**5. submitExpenseForm()**
- Prevent double submission
- Gather all form values
- Convert amount EUR to cents via MoneyUtils.eurosToCents()
- Convert IVA EUR to cents via MoneyUtils.eurosToCents()
- Build expenseData object with all fields
- Add metadata for deduction calculation: { business_proportion, destination, has_overnight }
- If editing (data-edit-id set): call ExpenseManager.updateExpense(editId, changes)
- If creating: call ExpenseManager.createExpense(expenseData)
- If receipt file uploaded: call ReceiptManager.storeReceipt(expenseId, file)
  - Update expense with receipt_id
- Close dialog
- Refresh expense list (call renderExpenseList())
- Show success toast/message

**6. closeExpenseFormDialog()**
- Close dialog
- Reset form and data-edit-id

Add event listeners for category change and client change on the respective select elements.
  </action>
  <verify>Search for "openExpenseFormDialog", "submitExpenseForm", "onExpenseCategoryChange", "handleReceiptUpload" in the file. Verify all functions exist. Check that submitExpenseForm calls ExpenseManager.createExpense and MoneyUtils.eurosToCents. Check that handleReceiptUpload calls ReceiptManager.scanReceipt.</verify>
  <done>Six form handler functions exist: openExpenseFormDialog (with edit mode support), onExpenseCategoryChange (conditional fields), onExpenseClientChange (project loading), handleReceiptUpload (OCR auto-fill), submitExpenseForm (create/update with receipt storage), closeExpenseFormDialog. Category population filters by entity type. OCR results auto-fill form fields with confidence display.</done>
</task>

</tasks>

<verification>
1. Dialog opens when "Add Expense" clicked
2. Categories filtered by entity type (autonomo hides sl_only, SL shows all)
3. Conditional fields appear/disappear when category changes
4. Receipt upload triggers OCR and auto-fills vendor/date/amount
5. Form submission creates expense in IndexedDB via ExpenseManager
6. Edit mode pre-fills form and calls updateExpense
7. Client select loads projects for selected client
8. No console errors
</verification>

<success_criteria>
- Expense form dialog opens from "Add Expense" button on Expenses tab
- 18 form fields present with appropriate conditional visibility
- Category select filtered by current entity type (autonomo vs SL)
- Receipt upload triggers OCR auto-fill with confidence display
- Form submission creates expense in IndexedDB with correct cents conversion
- Edit mode supported for existing expenses
- V1 expense sections (Monthly Fixed Costs) remain fully functional
</success_criteria>

<output>
After completion, create `.planning/phases/17-expense-management/17-03-SUMMARY.md`
</output>
