---
phase: 17-expense-management
plan: 04
type: execute
wave: 2
depends_on: ["17-01"]
files_modified: ["autonomo_dashboard.html"]
autonomous: true

must_haves:
  truths:
    - "Expense list shows date, vendor, amount, category, deductible amount, and client if linked (EXPENSE-12)"
    - "User can filter expenses by date range, category, client, and calendar days (EXPENSE-13)"
    - "Expense list updates in real-time when expenses are added, edited, or deleted"
    - "Expense summary shows total amount and total deductible for current filters"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "renderExpenseList function, expense filter UI, expense list table"
      contains: "renderExpenseList"
  key_links:
    - from: "renderExpenseList"
      to: "ExpenseManager.getExpenses"
      via: "async data fetch"
      pattern: "ExpenseManager\\.getExpenses"
    - from: "expense filters"
      to: "renderExpenseList"
      via: "filter change triggers re-render"
      pattern: "renderExpenseList"
---

<objective>
Build the expense list view with filtering, sorting, and summary totals that renders inside the Expense Tracker section on the Expenses tab.

Purpose: Fulfill EXPENSE-12 (list view with all fields) and EXPENSE-13 (filtering by date/category/client/calendar days), giving users a complete view of their tracked expenses.
Output: renderExpenseList function, filter UI controls, and expense table/card rendering in autonomo_dashboard.html.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-expense-management/17-RESEARCH.md
@.planning/phases/17-expense-management/17-01-SUMMARY.md
@autonomo_dashboard.html (lines 7525-7577 for expenses tab, existing table/list patterns from client list around lines 19200-19400)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add expense filter bar and list container HTML</name>
  <files>autonomo_dashboard.html</files>
  <action>
Replace the empty-state placeholder inside `#expenseTrackerList` (added in 17-03) with the filter bar and list container. If 17-03 hasn't added the placeholder yet (parallel wave), add both the filter bar and list container inside the expense-tracker-section div.

**Filter Bar HTML** (above the expense list):
```html
<div class="expense-filters" style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center; margin-bottom: 1rem;">
  <div class="filter-group">
    <label style="font-size: 0.8rem; opacity: 0.6;">Date From</label>
    <input type="date" id="expFilterDateFrom" onchange="renderExpenseList()">
  </div>
  <div class="filter-group">
    <label style="font-size: 0.8rem; opacity: 0.6;">Date To</label>
    <input type="date" id="expFilterDateTo" onchange="renderExpenseList()">
  </div>
  <div class="filter-group">
    <label style="font-size: 0.8rem; opacity: 0.6;">Category</label>
    <select id="expFilterCategory" onchange="renderExpenseList()">
      <option value="">All Categories</option>
      <!-- Populated dynamically -->
    </select>
  </div>
  <div class="filter-group">
    <label style="font-size: 0.8rem; opacity: 0.6;">Client</label>
    <select id="expFilterClient" onchange="renderExpenseList()">
      <option value="">All Clients</option>
      <!-- Populated dynamically -->
    </select>
  </div>
  <div class="filter-group">
    <label style="font-size: 0.8rem; opacity: 0.6;">Billable</label>
    <select id="expFilterBillable" onchange="renderExpenseList()">
      <option value="">All</option>
      <option value="true">Billable Only</option>
      <option value="false">Non-billable Only</option>
    </select>
  </div>
</div>
```

**Summary Bar** (shows totals for current filter):
```html
<div id="expenseSummaryBar" class="expense-summary-bar" style="display: flex; gap: 1.5rem; padding: 0.75rem 1rem; background: rgba(255,255,255,0.03); border-radius: 4px; margin-bottom: 1rem; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem;">
  <span>Total: <strong id="expSummaryTotal">€0.00</strong></span>
  <span>Deductible: <strong id="expSummaryDeductible" style="color: var(--positive);">€0.00</strong></span>
  <span>Count: <strong id="expSummaryCount">0</strong></span>
</div>
```

**List Container:**
```html
<div id="expenseListContainer">
  <!-- Rendered as table on desktop, cards on mobile by renderExpenseList() -->
</div>
```

**CSS for expense list:** Add styles for:
- `.expense-filters .filter-group` - vertical label+input layout
- `.expense-list-table` - dark theme table matching existing comparison table styles
- `.expense-list-table th` - sticky header, lowercase, letter-spaced
- `.expense-list-table td` - right-aligned for money columns
- `.expense-row` - hover state with subtle highlight
- `.expense-category-badge` - small colored badge for category
- `.expense-billable-badge` - "Billable" tag when is_billable
- `.expense-actions` - edit/delete button group on each row
- Mobile responsive: collapse table to card layout at <768px
  </action>
  <verify>Search for "expenseTrackerList" or "expenseListContainer" in the file. Verify filter inputs exist (expFilterDateFrom, expFilterDateTo, expFilterCategory, expFilterClient, expFilterBillable). Verify summary bar exists (expSummaryTotal, expSummaryDeductible, expSummaryCount).</verify>
  <done>Filter bar with 5 filters (date range, category, client, billable) exists above the expense list. Summary bar shows total, deductible, and count. List container ready for renderExpenseList() population. CSS styles added for dark theme table and responsive card layout.</done>
</task>

<task type="auto">
  <name>Task 2: Implement renderExpenseList and expense list rendering logic</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add JavaScript functions for rendering the expense list. Place in the script section alongside other Phase 17 functions.

**1. renderExpenseList()** (async)
- Read filter values from the filter inputs
- Build options object for ExpenseManager.getExpenses():
  - category: expFilterCategory value (or undefined)
  - client_id: expFilterClient value as number (or undefined)
  - date_from: expFilterDateFrom value (or undefined)
  - date_to: expFilterDateTo value (or undefined)
  - is_billable: parse expFilterBillable ('true'->true, 'false'->false, ''->undefined)
- Call ExpenseManager.getExpenses(options) to get filtered expenses
- If no expenses: show empty state message (differentiated between "no expenses yet" and "no expenses match filters")
- Otherwise, render as HTML table

**Table columns:**
| Date | Vendor | Category | Amount | Deductible | Client | Actions |

- Date: formatted as DD/MM/YYYY (European format)
- Vendor: text, truncated to 30 chars with title tooltip
- Category: badge with EXPENSE_CATEGORY[cat].label
- Amount: MoneyUtils.formatEuros(expense.amount_cents), right-aligned
- Deductible: MoneyUtils.formatEuros(expense.deductible_amount_cents), right-aligned, green color
- Client: Client name from client_id lookup (cache client names), show "—" if no client
- Actions: Edit button (calls openExpenseFormDialog(expense.id)), Archive button (calls archiveExpenseConfirm(expense.id))

**Update summary bar:**
- Total: sum of all filtered expenses' amount_cents, formatted
- Deductible: sum of all filtered expenses' deductible_amount_cents, formatted
- Count: number of filtered expenses

**2. populateExpenseFilters()** (async)
- Populate category filter select from EXPENSE_CATEGORY (filtered by entity type)
- Populate client filter select from ClientManager.getClients()
- Call on entity change and on tab activation

**3. archiveExpenseConfirm(expenseId)**
- Show confirm dialog: "Archive this expense? It can be restored within 30 days."
- If confirmed: call ExpenseManager.archiveExpense(expenseId)
- Re-render expense list
- Show feedback message

**4. formatDateEU(dateString)** - Helper
- Convert YYYY-MM-DD to DD/MM/YYYY for display

**5. Integration with entity context:**
- Subscribe to EntityContext changes to re-render expense list when entity switches
- Call renderExpenseList() when Expenses tab becomes active (hook into existing tab switching logic)
- Populate filters when entity changes

**Client name caching:**
- When rendering, batch-load client names from ClientManager.getClients()
- Build a Map of clientId -> clientName for display
- Avoid N+1 queries (don't call getClient per row)
  </action>
  <verify>Search for "renderExpenseList" in the file. Verify it calls ExpenseManager.getExpenses with filter options. Verify summary bar is updated with totals. Verify archiveExpenseConfirm exists. Check that client names are batch-loaded (not N+1).</verify>
  <done>renderExpenseList renders a table of expenses with all required columns (date, vendor, category, amount, deductible, client, actions). Filters work for date range, category, client, and billable status. Summary bar shows totals. Archive with confirmation dialog. Client names batch-loaded. Entity context subscription triggers re-render on entity change.</done>
</task>

</tasks>

<verification>
1. Expense list renders from IndexedDB data via ExpenseManager.getExpenses
2. All 5 filters work: date range, category, client, billable
3. Summary bar updates with filtered totals
4. Edit button opens form dialog in edit mode
5. Archive button soft-deletes with confirmation
6. Empty state shown when no expenses or no matches
7. Client names displayed from cache (not N+1 queries)
8. Entity change triggers list re-render
9. No console errors
</verification>

<success_criteria>
- Expense list displays all EXPENSE-12 required fields: date, vendor, amount, category, deductible amount, client
- Filtering works for date range, category, client, calendar days (EXPENSE-13)
- Summary bar shows total amount and total deductible for current filters
- Edit and archive actions work from list rows
- Responsive: table on desktop, cards on mobile
- Zero console errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-expense-management/17-04-SUMMARY.md`
</output>
