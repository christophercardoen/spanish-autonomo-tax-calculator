---
phase: 15-client-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [autonomo_dashboard.html]
autonomous: true

must_haves:
  truths:
    - "EU VAT format validation works for all 27 EU countries plus XI (Northern Ireland)"
    - "Greece uses EL country code (not GR) per EU VIES specification"
    - "Country flags render correctly from ISO 3166-1 alpha-2 codes"
    - "CLIENT_CATEGORY constants exist and are frozen"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "EU_VAT_PATTERNS regex object, getFlagEmoji function, CLIENT_CATEGORY constants"
      contains: "EU_VAT_PATTERNS"
  key_links:
    - from: "EU_VAT_PATTERNS"
      to: "VIESValidator (Plan 02)"
      via: "Regex patterns used for format-only validation"
      pattern: "EU_VAT_PATTERNS\\[countryCode\\]"
---

<objective>
Create EU VAT format validation patterns, country flag emoji function, and client category constants as foundation for client management.

Purpose: Establishes validation infrastructure that CLIENT-02, CLIENT-03, CLIENT-04 depend on. EU VAT patterns enable format validation offline; categories enable correct IVA treatment routing.
Output: EU_VAT_PATTERNS object, getFlagEmoji function, CLIENT_CATEGORY constants, CATEGORY_BY_COUNTRY mapping
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-client-management/15-RESEARCH.md
@.planning/phases/13-multi-entity-architecture/13-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement EU VAT Format Patterns and Country Flag Emoji</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add EU_VAT_PATTERNS object and getFlagEmoji function near SpanishTaxIdValidator (around line 10100).

**EU_VAT_PATTERNS:** Create frozen object with regex patterns for all 27 EU member states plus XI (Northern Ireland). Patterns based on European Commission VIES specification:

```javascript
const EU_VAT_PATTERNS = Object.freeze({
  AT: /^ATU\d{8}$/,                        // Austria
  BE: /^BE[01]\d{9}$/,                     // Belgium
  BG: /^BG\d{9,10}$/,                      // Bulgaria
  CY: /^CY\d{8}[A-Z]$/,                    // Cyprus
  CZ: /^CZ\d{8,10}$/,                      // Czech Republic
  DE: /^DE\d{9}$/,                         // Germany
  DK: /^DK\d{8}$/,                         // Denmark
  EE: /^EE\d{9}$/,                         // Estonia
  EL: /^EL\d{9}$/,                         // Greece (EL not GR!)
  ES: /^ES[A-Z0-9]\d{7}[A-Z0-9]$/,         // Spain
  FI: /^FI\d{8}$/,                         // Finland
  FR: /^FR[A-Z0-9]{2}\d{9}$/,              // France
  HR: /^HR\d{11}$/,                        // Croatia
  HU: /^HU\d{8}$/,                         // Hungary
  IE: /^IE(\d{7}[A-Z]{1,2}|\d[A-Z+*]\d{5}[A-Z])$/, // Ireland
  IT: /^IT\d{11}$/,                        // Italy
  LT: /^LT(\d{9}|\d{12})$/,                // Lithuania
  LU: /^LU\d{8}$/,                         // Luxembourg
  LV: /^LV\d{11}$/,                        // Latvia
  MT: /^MT\d{8}$/,                         // Malta
  NL: /^NL\d{9}B\d{2}$/,                   // Netherlands
  PL: /^PL\d{10}$/,                        // Poland
  PT: /^PT\d{9}$/,                         // Portugal
  RO: /^RO\d{2,10}$/,                      // Romania
  SE: /^SE\d{12}$/,                        // Sweden
  SI: /^SI\d{8}$/,                         // Slovenia
  SK: /^SK\d{10}$/,                        // Slovakia
  XI: /^XI\d{9}(\d{3})?$/                  // Northern Ireland
});
```

**getFlagEmoji:** Convert ISO 3166-1 alpha-2 code to flag emoji using Unicode regional indicators:

```javascript
function getFlagEmoji(countryCode) {
  if (!countryCode || countryCode.length !== 2) return '';
  const codePoints = countryCode
    .toUpperCase()
    .split('')
    .map(char => 127397 + char.charCodeAt(0));
  return String.fromCodePoint(...codePoints);
}
```

**Placement:** Add after SpanishTaxIdValidator module, before any UI code. Add comment header: `// === EU VAT Validation and Country Utilities ===`
  </action>
  <verify>
In browser console:
- `EU_VAT_PATTERNS.BE.test('BE0411905847')` returns true
- `EU_VAT_PATTERNS.EL.test('EL123456789')` returns true
- `EU_VAT_PATTERNS.DE.test('DE123456789')` returns true
- `getFlagEmoji('BE')` returns 'ðŸ‡§ðŸ‡ª'
- `getFlagEmoji('ES')` returns 'ðŸ‡ªðŸ‡¸'
- `Object.isFrozen(EU_VAT_PATTERNS)` returns true
  </verify>
  <done>
EU VAT format patterns validate correctly for all 27 EU countries plus XI. Flag emoji function converts country codes to Unicode flags. Greece uses EL code per VIES specification.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Client Category Constants and Country Mapping</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add CLIENT_CATEGORY constants and CATEGORY_BY_COUNTRY mapping after EU_VAT_PATTERNS.

**CLIENT_CATEGORY:** Frozen enum for client tax treatment categories per CLIENT-04:

```javascript
const CLIENT_CATEGORY = Object.freeze({
  SPAIN: 'spain',           // Spanish domestic client
  EU_B2B: 'eu_b2b',         // EU business (inversion sujeto pasivo)
  EU_B2C: 'eu_b2c',         // EU consumer (IVA applies)
  UK: 'uk',                 // UK post-Brexit (third country)
  THIRD_COUNTRY: 'third_country'  // US, CA, AU, etc.
});
```

**CATEGORY_BY_COUNTRY:** Frozen object mapping ISO country codes to categories. EU countries default to 'eu' (user specifies B2B/B2C later):

```javascript
const CATEGORY_BY_COUNTRY = Object.freeze({
  // Spain
  ES: CLIENT_CATEGORY.SPAIN,

  // EU Member States (27 countries) - default 'eu', user chooses B2B/B2C
  AT: 'eu', BE: 'eu', BG: 'eu', CY: 'eu', CZ: 'eu',
  DE: 'eu', DK: 'eu', EE: 'eu', EL: 'eu', FI: 'eu',
  FR: 'eu', HR: 'eu', HU: 'eu', IE: 'eu', IT: 'eu',
  LT: 'eu', LU: 'eu', LV: 'eu', MT: 'eu', NL: 'eu',
  PL: 'eu', PT: 'eu', RO: 'eu', SE: 'eu', SI: 'eu', SK: 'eu',

  // UK post-Brexit
  GB: CLIENT_CATEGORY.UK,
  XI: CLIENT_CATEGORY.UK,  // Northern Ireland (goods with EU, services = UK)

  // Default for all other countries
  _default: CLIENT_CATEGORY.THIRD_COUNTRY
});

// Helper function to get category from country code
function getClientCategoryByCountry(countryCode, isB2B = true) {
  const mapping = CATEGORY_BY_COUNTRY[countryCode?.toUpperCase()];
  if (mapping === 'eu') {
    return isB2B ? CLIENT_CATEGORY.EU_B2B : CLIENT_CATEGORY.EU_B2C;
  }
  return mapping || CATEGORY_BY_COUNTRY._default;
}
```

**EU_COUNTRY_CODES:** Array of all EU country codes for UI dropdowns:

```javascript
const EU_COUNTRY_CODES = Object.freeze([
  'AT', 'BE', 'BG', 'CY', 'CZ', 'DE', 'DK', 'EE', 'EL', 'ES',
  'FI', 'FR', 'HR', 'HU', 'IE', 'IT', 'LT', 'LU', 'LV', 'MT',
  'NL', 'PL', 'PT', 'RO', 'SE', 'SI', 'SK'
]);
```

**Placement:** Add immediately after EU_VAT_PATTERNS and getFlagEmoji, with comment header: `// === Client Category Constants ===`
  </action>
  <verify>
In browser console:
- `CLIENT_CATEGORY.SPAIN` returns 'spain'
- `CLIENT_CATEGORY.EU_B2B` returns 'eu_b2b'
- `getClientCategoryByCountry('BE', true)` returns 'eu_b2b'
- `getClientCategoryByCountry('BE', false)` returns 'eu_b2c'
- `getClientCategoryByCountry('US')` returns 'third_country'
- `getClientCategoryByCountry('GB')` returns 'uk'
- `EU_COUNTRY_CODES.includes('EL')` returns true (Greece)
- `Object.isFrozen(CLIENT_CATEGORY)` returns true
  </verify>
  <done>
CLIENT_CATEGORY constants frozen and available. Country mapping correctly routes Spain, EU (with B2B/B2C), UK, and third countries. EU country codes array available for UI dropdowns.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **EU VAT Patterns:**
   - All 28 patterns exist (27 EU + XI)
   - Greece uses EL (not GR)
   - Patterns are frozen (immutable)

2. **Country Utilities:**
   - getFlagEmoji works for any 2-letter code
   - CLIENT_CATEGORY has all 5 categories
   - getClientCategoryByCountry correctly routes all scenarios

3. **No regressions:**
   - Page loads without JavaScript errors
   - Existing SpanishTaxIdValidator still works
   - ENTITY_TYPE constants still accessible
</verification>

<success_criteria>
- EU_VAT_PATTERNS contains regex for all 27 EU member states plus XI
- Greece pattern uses 'EL' country code (not 'GR')
- getFlagEmoji('BE') returns Belgian flag emoji
- CLIENT_CATEGORY frozen with 5 categories
- getClientCategoryByCountry correctly categorizes Spain, EU B2B/B2C, UK, third country
- All objects frozen (Object.isFrozen returns true)
- No console errors on page load
</success_criteria>

<output>
After completion, create `.planning/phases/15-client-management/15-01-SUMMARY.md`
</output>
