---
phase: 15-client-management
plan: 05
type: execute
wave: 3
depends_on: ["15-02", "15-03", "15-04"]
files_modified: [autonomo_dashboard.html]
autonomous: false

must_haves:
  truths:
    - "User can view client detail page with header showing name, tax ID, flag, total invoiced"
    - "Client detail page has tabbed interface with Projects, Invoices, Expenses tabs"
    - "User can add/edit/delete contacts from client detail page"
    - "User can add/edit/archive projects from client detail page"
    - "Profitability calculation infrastructure exists (displays 0 until invoices/expenses available in Phase 17/18)"
    - "Mini calendar view placeholder shows days worked for this client (populated when calendar tagging exists in Phase 16)"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "ClientDetailUI module with tabs, ContactListUI, ProjectFormUI"
      contains: "ClientDetailUI"
  key_links:
    - from: "ClientDetailUI.open"
      to: "ClientManager.getClient"
      via: "Load client data"
      pattern: "ClientManager\\.getClient"
    - from: "ClientDetailUI.renderProjects"
      to: "ProjectManager.getProjectsByClient"
      via: "Load projects for display"
      pattern: "ProjectManager\\.getProjectsByClient"
    - from: "ClientDetailUI.calculateProfitability"
      to: "db.invoices and db.expenses"
      via: "Sum invoiced minus expenses"
      pattern: "(invoices|expenses).*client_id"
---

<objective>
Create client detail page with tabbed interface, contact management, project management, and profitability calculation.

Purpose: Enables CLIENT-13 (detail page with contact info, projects, invoices, expenses), CLIENT-14 (profitability calculation), CLIENT-06 (W-8BEN status display), CLIENT-07 (contact management on detail page). Complete client management experience.
Output: ClientDetailUI module with tabs, ContactListUI for contacts, ProjectFormUI for projects, profitability calculation
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-client-management/15-CONTEXT.md
@.planning/phases/15-client-management/15-03-SUMMARY.md
@.planning/phases/15-client-management/15-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Client Detail Page UI</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add ClientDetailUI module with header, tabs, and content panels.

**1. Add client detail panel HTML (replaces or overlays client list when viewing detail):**

```html
<!-- Client Detail View -->
<div id="client-detail-view" class="detail-view hidden">
  <button class="back-btn" id="client-back-btn">&larr; Volver a clientes</button>

  <div class="client-detail-header">
    <div class="client-detail-main">
      <span class="client-detail-flag" id="detail-flag"></span>
      <div class="client-detail-info">
        <h2 id="detail-name"></h2>
        <div class="client-detail-meta">
          <span id="detail-tax-id" class="tax-id-badge"></span>
          <span id="detail-category" class="category-badge"></span>
          <span id="detail-vies-status" class="vies-badge hidden"></span>
        </div>
      </div>
    </div>
    <div class="client-detail-summary">
      <div class="summary-item">
        <span class="summary-label">Total facturado</span>
        <span class="summary-value" id="detail-total-invoiced">0,00 EUR</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Pendiente</span>
        <span class="summary-value" id="detail-outstanding">0,00 EUR</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Beneficio</span>
        <span class="summary-value" id="detail-profit">0,00 EUR</span>
      </div>
    </div>
    <div class="client-detail-actions">
      <button class="btn btn-secondary" id="edit-client-btn" data-permission="edit">Editar</button>
      <button class="btn btn-danger" id="archive-client-btn" data-permission="delete">Archivar</button>
    </div>
  </div>

  <div class="client-detail-tabs">
    <button class="detail-tab active" data-detail-tab="contacts">Contactos</button>
    <button class="detail-tab" data-detail-tab="projects">Proyectos</button>
    <button class="detail-tab" data-detail-tab="invoices">Facturas</button>
    <button class="detail-tab" data-detail-tab="expenses">Gastos</button>
    <button class="detail-tab" data-detail-tab="calendar">Calendario</button>
  </div>

  <div id="detail-contacts-panel" class="detail-panel">
    <div class="panel-header">
      <h3>Contactos</h3>
      <button class="btn btn-small" id="add-contact-btn" data-permission="create">+ Contacto</button>
    </div>
    <div id="contacts-list" class="contacts-list"></div>
    <div id="contacts-empty" class="empty-state hidden">
      <p>No hay contactos. Añade un contacto para este cliente.</p>
    </div>
  </div>

  <div id="detail-projects-panel" class="detail-panel hidden">
    <div class="panel-header">
      <h3>Proyectos</h3>
      <button class="btn btn-small" id="add-project-btn" data-permission="create">+ Proyecto</button>
    </div>
    <div id="projects-list" class="projects-list"></div>
    <div id="projects-empty" class="empty-state hidden">
      <p>No hay proyectos. Crea un proyecto para este cliente.</p>
    </div>
  </div>

  <div id="detail-invoices-panel" class="detail-panel hidden">
    <div class="panel-header">
      <h3>Facturas</h3>
    </div>
    <div id="invoices-list" class="invoices-list">
      <p class="coming-soon">Las facturas estarán disponibles en la fase 18.</p>
    </div>
  </div>

  <div id="detail-expenses-panel" class="detail-panel hidden">
    <div class="panel-header">
      <h3>Gastos vinculados</h3>
    </div>
    <div id="expenses-list" class="expenses-list">
      <p class="coming-soon">Los gastos vinculados estarán disponibles en la fase 17.</p>
    </div>
  </div>

  <div id="detail-calendar-panel" class="detail-panel hidden">
    <div class="panel-header">
      <h3>Días trabajados</h3>
    </div>
    <div id="client-mini-calendar" class="mini-calendar">
      <p class="coming-soon">El calendario de cliente estará disponible en la fase 16.</p>
    </div>
  </div>
</div>
```

**2. Add CSS for client detail:**

```css
/* Client Detail View Styles */
.detail-view {
  padding: 1rem;
}

.back-btn {
  background: transparent;
  border: none;
  color: var(--accent-primary);
  cursor: pointer;
  padding: 0.5rem 0;
  margin-bottom: 1rem;
}

.back-btn:hover {
  text-decoration: underline;
}

.client-detail-header {
  display: grid;
  grid-template-columns: 1fr auto auto;
  gap: 2rem;
  align-items: start;
  padding: 1.5rem;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  margin-bottom: 1rem;
}

.client-detail-main {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
}

.client-detail-flag {
  font-size: 3rem;
}

.client-detail-info h2 {
  margin: 0 0 0.5rem 0;
  font-size: 1.5rem;
}

.client-detail-meta {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.tax-id-badge,
.category-badge,
.vies-badge {
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
  font-family: var(--font-mono);
}

.tax-id-badge {
  background: var(--bg-tertiary);
  color: var(--text-secondary);
}

.category-badge {
  background: var(--accent-primary);
  color: white;
}

.vies-badge.valid {
  background: var(--success-color);
  color: white;
}

.vies-badge.invalid {
  background: var(--error-color);
  color: white;
}

.client-detail-summary {
  display: flex;
  gap: 2rem;
}

.summary-item {
  text-align: right;
}

.summary-label {
  display: block;
  font-size: 0.75rem;
  color: var(--text-secondary);
  margin-bottom: 0.25rem;
}

.summary-value {
  font-family: var(--font-mono);
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--text-primary);
}

.client-detail-actions {
  display: flex;
  gap: 0.5rem;
}

.client-detail-tabs {
  display: flex;
  gap: 0;
  border-bottom: 1px solid var(--border-color);
  margin-bottom: 1rem;
}

.detail-tab {
  padding: 0.75rem 1.5rem;
  background: transparent;
  border: none;
  border-bottom: 2px solid transparent;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
}

.detail-tab:hover {
  color: var(--text-primary);
}

.detail-tab.active {
  color: var(--accent-primary);
  border-bottom-color: var(--accent-primary);
}

.detail-panel {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 1rem;
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.panel-header h3 {
  margin: 0;
  font-size: 1rem;
}

.btn-small {
  padding: 0.25rem 0.75rem;
  font-size: 0.875rem;
}

.coming-soon {
  color: var(--text-secondary);
  font-style: italic;
  text-align: center;
  padding: 2rem;
}

/* Contact list styles */
.contacts-list {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.contact-item {
  display: grid;
  grid-template-columns: auto 1fr auto auto;
  gap: 1rem;
  align-items: center;
  padding: 0.75rem;
  background: var(--bg-tertiary);
  border-radius: 4px;
}

.contact-item.primary {
  border-left: 3px solid var(--accent-primary);
}

.contact-role {
  font-size: 0.75rem;
  color: var(--text-secondary);
  text-transform: uppercase;
}

.contact-name {
  font-weight: 500;
}

.contact-details {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

/* Project list styles */
.projects-list {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.project-item {
  display: grid;
  grid-template-columns: 1fr auto auto auto;
  gap: 1rem;
  align-items: center;
  padding: 0.75rem;
  background: var(--bg-tertiary);
  border-radius: 4px;
}

.project-name {
  font-weight: 500;
}

.project-rate {
  font-family: var(--font-mono);
  color: var(--accent-primary);
}

.project-dates {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.status-badge {
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
  text-transform: uppercase;
}

.status-badge.active {
  background: var(--success-color);
  color: white;
}

.status-badge.upcoming {
  background: var(--warning-color);
  color: black;
}

.status-badge.completed {
  background: var(--text-secondary);
  color: white;
}

.status-badge.cancelled {
  background: var(--error-color);
  color: white;
}
```

**3. ClientDetailUI module:**

```javascript
// === Client Detail UI Module ===
const ClientDetailUI = {
  clientId: null,
  client: null,
  detailView: null,
  listTab: null,

  init() {
    this.detailView = document.getElementById('client-detail-view');
    this.listTab = document.getElementById('clients-tab');

    if (!this.detailView) return;

    // Back button
    document.getElementById('client-back-btn')?.addEventListener('click', () => this.close());

    // Edit button
    document.getElementById('edit-client-btn')?.addEventListener('click', () => {
      if (this.clientId) ClientFormUI.openEdit(this.clientId);
    });

    // Archive button
    document.getElementById('archive-client-btn')?.addEventListener('click', () => {
      this.archiveClient();
    });

    // Tab switching
    this.detailView.querySelectorAll('.detail-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        this.switchTab(tab.dataset.detailTab);
      });
    });

    // Add contact button
    document.getElementById('add-contact-btn')?.addEventListener('click', () => {
      ContactFormUI.openCreate(this.clientId);
    });

    // Add project button
    document.getElementById('add-project-btn')?.addEventListener('click', () => {
      ProjectFormUI.openCreate(this.clientId);
    });
  },

  async open(clientId) {
    this.clientId = clientId;
    this.client = await ClientManager.getClient(clientId);

    if (!this.client) {
      alert('Cliente no encontrado');
      return;
    }

    // Hide list, show detail
    this.listTab?.querySelector('.clients-header')?.classList.add('hidden');
    this.listTab?.querySelector('.clients-filters')?.classList.add('hidden');
    this.listTab?.querySelector('#client-list')?.classList.add('hidden');
    this.listTab?.querySelector('#client-empty-state')?.classList.add('hidden');
    this.detailView?.classList.remove('hidden');

    // Render header
    await this.renderHeader();

    // Switch to contacts tab and load
    this.switchTab('contacts');
  },

  close() {
    this.clientId = null;
    this.client = null;

    // Show list, hide detail
    this.detailView?.classList.add('hidden');
    this.listTab?.querySelector('.clients-header')?.classList.remove('hidden');
    this.listTab?.querySelector('.clients-filters')?.classList.remove('hidden');
    this.listTab?.querySelector('#client-list')?.classList.remove('hidden');

    ClientListUI.refresh();
  },

  async renderHeader() {
    const client = this.client;
    if (!client) return;

    document.getElementById('detail-flag').textContent = getFlagEmoji(client.country_code);
    document.getElementById('detail-name').textContent = client.name;
    document.getElementById('detail-tax-id').textContent = client.tax_id || 'Sin NIF';

    // Category badge
    const categoryEl = document.getElementById('detail-category');
    const categoryLabels = {
      spain: 'España',
      eu_b2b: 'UE B2B',
      eu_b2c: 'UE B2C',
      uk: 'Reino Unido',
      third_country: 'Tercer país'
    };
    categoryEl.textContent = categoryLabels[client.category] || client.category;

    // VIES status
    const viesEl = document.getElementById('detail-vies-status');
    if (client.tax_id_type === 'eu_vat') {
      viesEl.classList.remove('hidden');
      viesEl.textContent = client.tax_id_validated ? 'VIES ✓' : 'VIES pendiente';
      viesEl.className = `vies-badge ${client.tax_id_validated ? 'valid' : 'invalid'}`;
    } else {
      viesEl.classList.add('hidden');
    }

    // Calculate summary values
    const totals = await this.calculateTotals(client.id);
    document.getElementById('detail-total-invoiced').textContent = MoneyUtils.formatEuros(totals.invoiced);
    document.getElementById('detail-outstanding').textContent = MoneyUtils.formatEuros(totals.outstanding);
    document.getElementById('detail-profit').textContent = MoneyUtils.formatEuros(totals.profit);

    // Apply permission UI
    PermissionUI?.applyPermissions?.();
  },

  async calculateTotals(clientId) {
    // TODO: When invoices exist (Phase 18), sum from db.invoices where client_id = clientId
    // TODO: When expenses exist (Phase 17), sum from db.expenses where client_id = clientId

    // Placeholder - will be implemented when invoice/expense phases complete
    const invoiced = 0;
    const paid = 0;
    const expenses = 0;

    return {
      invoiced,
      outstanding: invoiced - paid,
      profit: invoiced - expenses
    };
  },

  switchTab(tabName) {
    // Update tab buttons
    this.detailView.querySelectorAll('.detail-tab').forEach(tab => {
      tab.classList.toggle('active', tab.dataset.detailTab === tabName);
    });

    // Update panels
    this.detailView.querySelectorAll('.detail-panel').forEach(panel => {
      panel.classList.toggle('hidden', !panel.id.includes(tabName));
    });

    // Load content for selected tab
    switch (tabName) {
      case 'contacts':
        this.renderContacts();
        break;
      case 'projects':
        this.renderProjects();
        break;
      case 'invoices':
        // Phase 18
        break;
      case 'expenses':
        // Phase 17
        break;
      case 'calendar':
        // Phase 16
        break;
    }
  },

  async renderContacts() {
    if (!this.clientId) return;

    const contacts = await ContactManager.getContacts(this.clientId);
    const container = document.getElementById('contacts-list');
    const emptyState = document.getElementById('contacts-empty');

    if (contacts.length === 0) {
      container.innerHTML = '';
      emptyState?.classList.remove('hidden');
      return;
    }

    emptyState?.classList.add('hidden');

    container.innerHTML = contacts.map(contact => `
      <div class="contact-item ${contact.is_primary ? 'primary' : ''}" data-contact-id="${contact.id}">
        <span class="contact-role">${CONTACT_ROLE_LABELS[contact.role] || contact.role}</span>
        <div>
          <div class="contact-name">${escapeHtml(contact.name)}</div>
          <div class="contact-details">
            ${contact.email ? `<a href="mailto:${escapeHtml(contact.email)}">${escapeHtml(contact.email)}</a>` : ''}
            ${contact.email && contact.phone ? ' · ' : ''}
            ${contact.phone ? escapeHtml(contact.phone) : ''}
          </div>
        </div>
        <button class="btn btn-icon" onclick="ContactFormUI.openEdit(${contact.id})" data-permission="edit" title="Editar">&#9998;</button>
        <button class="btn btn-icon btn-danger" onclick="ClientDetailUI.deleteContact(${contact.id})" data-permission="delete" title="Eliminar">&times;</button>
      </div>
    `).join('');

    PermissionUI?.applyPermissions?.();
  },

  async renderProjects() {
    if (!this.clientId) return;

    const projects = await ProjectManager.getProjectsByClient(this.clientId);
    const container = document.getElementById('projects-list');
    const emptyState = document.getElementById('projects-empty');

    if (projects.length === 0) {
      container.innerHTML = '';
      emptyState?.classList.remove('hidden');
      return;
    }

    emptyState?.classList.add('hidden');

    container.innerHTML = projects.map(project => `
      <div class="project-item" data-project-id="${project.id}">
        <div class="project-name">${escapeHtml(project.name)}</div>
        <span class="project-rate">${ProjectManager.formatRate(project)}</span>
        <span class="project-dates">
          ${project.start_date || '?'} - ${project.end_date || '?'}
        </span>
        <span class="status-badge ${project.status}">${PROJECT_STATUS_LABELS[project.status]}</span>
        <button class="btn btn-icon" onclick="ProjectFormUI.openEdit(${project.id})" data-permission="edit" title="Editar">&#9998;</button>
      </div>
    `).join('');

    PermissionUI?.applyPermissions?.();
  },

  async deleteContact(contactId) {
    if (!confirm('¿Eliminar este contacto?')) return;

    try {
      await ContactManager.deleteContact(contactId);
      await this.renderContacts();
    } catch (err) {
      alert(err.message);
    }
  },

  async archiveClient() {
    if (!confirm('¿Archivar este cliente? El cliente quedará oculto pero sus datos se conservan.')) return;

    try {
      await ClientManager.archiveClient(this.clientId);
      this.close();
    } catch (err) {
      alert(err.message);
    }
  },

  async refresh() {
    if (this.clientId) {
      this.client = await ClientManager.getClient(this.clientId);
      await this.renderHeader();
      // Refresh current tab
      const activeTab = this.detailView.querySelector('.detail-tab.active')?.dataset.detailTab;
      if (activeTab) this.switchTab(activeTab);
    }
  }
};
```

**4. Initialize in DOMContentLoaded:**
Add `ClientDetailUI.init();` after ClientFormUI.init().

**Placement:** Add HTML after clients-tab content, CSS in styles, JS after ClientFormUI module.
  </action>
  <verify>
1. Click a client row in list - detail view opens
2. Header shows flag, name, tax ID, category badge
3. EU clients show VIES status badge
4. Summary shows totals (0 for now - invoices in Phase 18)
5. Tabs switch between Contacts, Projects, Invoices, Expenses, Calendar
6. Back button returns to list
  </verify>
  <done>
Client detail page with header showing key info, tabbed interface for contacts/projects/invoices/expenses/calendar. Profitability calculation placeholder ready for invoice/expense phases.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Contact and Project Form Modals</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add ContactFormUI and ProjectFormUI modules for creating/editing contacts and projects.

**1. Add Contact Form Modal HTML:**

```html
<!-- Contact Form Modal -->
<div id="contact-modal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="contact-modal-title">Nuevo Contacto</h3>
      <button class="modal-close" onclick="ContactFormUI.close()">&times;</button>
    </div>

    <form id="contact-form" class="modal-form">
      <input type="hidden" id="contact-client-id">

      <div class="form-group">
        <label for="contact-name">Nombre *</label>
        <input type="text" id="contact-name" required>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="contact-email">Email</label>
          <input type="email" id="contact-email">
        </div>
        <div class="form-group">
          <label for="contact-phone">Teléfono</label>
          <input type="tel" id="contact-phone">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="contact-role">Rol</label>
          <select id="contact-role">
            <option value="general">General</option>
            <option value="billing">Facturación</option>
            <option value="project_manager">Gestor de proyecto</option>
            <option value="technical">Técnico</option>
          </select>
        </div>
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="contact-primary">
            Contacto principal
          </label>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="ContactFormUI.close()">Cancelar</button>
        <button type="submit" class="btn btn-primary">Guardar</button>
      </div>
    </form>
  </div>
</div>
```

**2. Add Project Form Modal HTML:**

```html
<!-- Project Form Modal -->
<div id="project-modal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="project-modal-title">Nuevo Proyecto</h3>
      <button class="modal-close" onclick="ProjectFormUI.close()">&times;</button>
    </div>

    <form id="project-form" class="modal-form">
      <input type="hidden" id="project-client-id">

      <div class="form-group">
        <label for="project-name">Nombre del proyecto *</label>
        <input type="text" id="project-name" required placeholder="Ej: Consultoría IT Q1 2026">
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="project-rate-type">Tipo de tarifa</label>
          <select id="project-rate-type">
            <option value="daily">Diario</option>
            <option value="hourly">Por hora</option>
            <option value="fixed">Precio fijo</option>
            <option value="monthly_retainer">Retainer mensual</option>
          </select>
        </div>
        <div class="form-group">
          <label for="project-rate">Tarifa (EUR)</label>
          <input type="number" id="project-rate" step="0.01" min="0" placeholder="650.00">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="project-start">Fecha inicio</label>
          <input type="date" id="project-start">
        </div>
        <div class="form-group">
          <label for="project-end">Fecha fin</label>
          <input type="date" id="project-end">
        </div>
      </div>

      <div class="form-group">
        <label for="project-status-override">Estado (manual)</label>
        <select id="project-status-override">
          <option value="">Auto (basado en fechas)</option>
          <option value="cancelled">Cancelado</option>
        </select>
      </div>

      <div class="form-group">
        <label for="project-notes">Notas</label>
        <textarea id="project-notes" rows="2"></textarea>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="ProjectFormUI.close()">Cancelar</button>
        <button type="submit" class="btn btn-primary">Guardar</button>
      </div>
    </form>
  </div>
</div>
```

**3. ContactFormUI module:**

```javascript
// === Contact Form UI Module ===
const ContactFormUI = {
  modal: null,
  form: null,
  editingId: null,

  init() {
    this.modal = document.getElementById('contact-modal');
    this.form = document.getElementById('contact-form');

    this.form?.addEventListener('submit', (e) => this.handleSubmit(e));
  },

  openCreate(clientId) {
    this.editingId = null;
    this.form?.reset();
    document.getElementById('contact-client-id').value = clientId;
    document.getElementById('contact-modal-title').textContent = 'Nuevo Contacto';
    this.modal?.classList.remove('hidden');
    document.getElementById('contact-name')?.focus();
  },

  async openEdit(contactId) {
    const contact = await db.contacts.get(contactId);
    if (!contact) return;

    this.editingId = contactId;
    document.getElementById('contact-client-id').value = contact.client_id;
    document.getElementById('contact-modal-title').textContent = 'Editar Contacto';

    document.getElementById('contact-name').value = contact.name || '';
    document.getElementById('contact-email').value = contact.email || '';
    document.getElementById('contact-phone').value = contact.phone || '';
    document.getElementById('contact-role').value = contact.role || 'general';
    document.getElementById('contact-primary').checked = contact.is_primary;

    this.modal?.classList.remove('hidden');
  },

  close() {
    this.modal?.classList.add('hidden');
    this.editingId = null;
  },

  async handleSubmit(e) {
    e.preventDefault();

    const clientId = parseInt(document.getElementById('contact-client-id').value, 10);
    const contactData = {
      name: document.getElementById('contact-name')?.value?.trim(),
      email: document.getElementById('contact-email')?.value?.trim() || null,
      phone: document.getElementById('contact-phone')?.value?.trim() || null,
      role: document.getElementById('contact-role')?.value || 'general',
      is_primary: document.getElementById('contact-primary')?.checked || false
    };

    try {
      if (this.editingId) {
        await ContactManager.updateContact(this.editingId, contactData);
      } else {
        await ContactManager.createContact(clientId, contactData);
      }

      this.close();
      await ClientDetailUI.renderContacts();
    } catch (err) {
      alert(err.message);
    }
  }
};
```

**4. ProjectFormUI module:**

```javascript
// === Project Form UI Module ===
const ProjectFormUI = {
  modal: null,
  form: null,
  editingId: null,

  init() {
    this.modal = document.getElementById('project-modal');
    this.form = document.getElementById('project-form');

    this.form?.addEventListener('submit', (e) => this.handleSubmit(e));
  },

  openCreate(clientId) {
    this.editingId = null;
    this.form?.reset();
    document.getElementById('project-client-id').value = clientId;
    document.getElementById('project-modal-title').textContent = 'Nuevo Proyecto';
    this.modal?.classList.remove('hidden');
    document.getElementById('project-name')?.focus();
  },

  async openEdit(projectId) {
    const project = await ProjectManager.getProject(projectId);
    if (!project) return;

    this.editingId = projectId;
    document.getElementById('project-client-id').value = project.client_id;
    document.getElementById('project-modal-title').textContent = 'Editar Proyecto';

    document.getElementById('project-name').value = project.name || '';
    document.getElementById('project-rate-type').value = project.rate_type || 'daily';
    document.getElementById('project-rate').value = project.rate_cents ? (project.rate_cents / 100).toFixed(2) : '';
    document.getElementById('project-start').value = project.start_date || '';
    document.getElementById('project-end').value = project.end_date || '';
    document.getElementById('project-status-override').value = project.status_override || '';
    document.getElementById('project-notes').value = project.notes || '';

    this.modal?.classList.remove('hidden');
  },

  close() {
    this.modal?.classList.add('hidden');
    this.editingId = null;
  },

  async handleSubmit(e) {
    e.preventDefault();

    const clientId = parseInt(document.getElementById('project-client-id').value, 10);
    const rateValue = document.getElementById('project-rate')?.value;

    const projectData = {
      name: document.getElementById('project-name')?.value?.trim(),
      rate_type: document.getElementById('project-rate-type')?.value || 'daily',
      rate_cents: rateValue ? MoneyUtils.eurosToCents(rateValue) : 0,
      start_date: document.getElementById('project-start')?.value || null,
      end_date: document.getElementById('project-end')?.value || null,
      status_override: document.getElementById('project-status-override')?.value || null,
      notes: document.getElementById('project-notes')?.value?.trim() || null
    };

    try {
      if (this.editingId) {
        await ProjectManager.updateProject(this.editingId, projectData);
      } else {
        await ProjectManager.createProject(clientId, projectData);
      }

      this.close();
      await ClientDetailUI.renderProjects();
    } catch (err) {
      alert(err.message);
    }
  }
};
```

**5. Initialize in DOMContentLoaded:**
Add `ContactFormUI.init(); ProjectFormUI.init();` after ClientDetailUI.init().

**Placement:** Add modal HTML near other modals, JS after ClientDetailUI module.
  </action>
  <verify>
1. On client detail, click "+ Contacto" - modal opens
2. Fill contact form and submit - contact appears in list
3. Click edit on contact - modal opens with data populated
4. Click "+ Proyecto" - modal opens
5. Fill project form with rate and dates - project appears with correct status
6. Edit project - modal shows existing data
  </verify>
  <done>
Contact and project form modals enable full CRUD from client detail page. Rate conversion uses MoneyUtils.eurosToCents. Project status auto-calculates from dates.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete client management feature with:
- Client list with search, filters, country flags
- Create/edit client modal with tax ID validation
- Spanish NIF/CIF validation via SpanishTaxIdValidator
- EU VAT format validation with VIES button
- Client detail page with tabs
- Contact management (add, edit, delete, set primary)
- Project management (add, edit with rate types and auto-status)
- Profitability summary (shows 0 until invoices exist in Phase 18)
  </what-built>
  <how-to-verify>
1. Open http://localhost:3013 (or your dashboard URL)
2. Navigate to "Clientes" tab
3. Click "+ Nuevo Cliente"
4. Test Spanish client:
   - Select "Espana" as country
   - Enter NIF "12345678Z" - should validate on blur
   - Fill name, save - client appears in list
5. Test Belgian client:
   - Click "+ Nuevo Cliente"
   - Select "Belgica" as country
   - B2B checkbox should appear
   - Enter VAT "0411905847"
   - "Verificar VIES" button should appear
   - Save (VIES warning if not verified) - client created
6. Click a client row - detail view opens
7. Add a contact via "+ Contacto" button
8. Mark contact as primary - should show indicator
9. Add a project via "+ Proyecto" button
   - Set daily rate 650 EUR
   - Set dates in past - status should be "Completed"
   - Set dates in future - status should be "Upcoming"
10. Switch between tabs (Projects, Invoices, Expenses, Calendar)
11. Click back button - returns to list
12. Verify search filters work
13. Verify country filter works
  </how-to-verify>
  <resume-signal>Type "approved" if client management works correctly, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Client Detail:**
   - Header shows all client info
   - Tabs switch correctly
   - Profitability shows (0 until invoices exist)

2. **Contacts:**
   - CRUD works
   - Primary designation works
   - Role labels display correctly

3. **Projects:**
   - CRUD works
   - Rate formatting correct
   - Status auto-calculates
   - Status override works

4. **Integration:**
   - List updates after detail changes
   - Permission UI applies
   - Entity context respected
</verification>

<success_criteria>
- Client detail page opens from list row click
- Header shows name, flag, tax ID, category, VIES status
- Profitability summary displays totals
- Tabs switch between Contacts, Projects, Invoices, Expenses, Calendar
- Contacts can be created, edited, deleted, marked as primary
- Projects can be created with 4 rate types
- Project status auto-calculates from dates
- Project status can be overridden to cancelled
- Back button returns to client list
- Archive button soft-deletes client
- Edit button opens client form modal
- Human verifies full feature flow
</success_criteria>

<output>
After completion, create `.planning/phases/15-client-management/15-05-SUMMARY.md`
</output>
