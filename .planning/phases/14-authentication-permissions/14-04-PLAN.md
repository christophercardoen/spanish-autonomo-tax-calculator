---
phase: 14-authentication-permissions
plan: 04
type: execute
wave: 4
depends_on: [14-03]
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "User can enroll TOTP 2FA via QR code"
    - "User must enter TOTP code to complete login when 2FA enabled"
    - "User can disable 2FA from settings"
    - "User can view list of active sessions"
    - "User can revoke individual sessions"
    - "User can sign out all other devices"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "MFA enrollment UI"
      contains: "mfa-enroll"
    - path: "autonomo_dashboard.html"
      provides: "Sessions list UI"
      contains: "sessions-list"
  key_links:
    - from: "MFA enroll button"
      to: "supabase.auth.mfa.enroll"
      via: "MFAManager.enroll"
      pattern: "mfa\\.enroll"
    - from: "sessions list"
      to: "SessionManager.getSessions"
      via: "SessionsUI.load"
      pattern: "getSessions"
---

<objective>
Two-factor authentication (TOTP) and session management

Purpose: Enhance security with 2FA option and give users visibility/control over their active sessions (AUTH-05, AUTH-06)
Output: MFA enrollment/verification flows, active sessions list with revocation capability
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-authentication-permissions/14-RESEARCH.md
@.planning/phases/14-authentication-permissions/14-03-SUMMARY.md

Key patterns from 14-RESEARCH.md:
- Enroll: supabase.auth.mfa.enroll({ factorType: 'totp', friendlyName: 'Authenticator App' })
- Challenge: supabase.auth.mfa.challengeAndVerify({ factorId, code })
- List factors: supabase.auth.mfa.listFactors()
- AAL check: supabase.auth.mfa.getAuthenticatorAssuranceLevel()

Key decisions from 14-CONTEXT.md:
- 2FA: TOTP app only (Google Authenticator, Authy, etc.)
- Session duration: Never expires (logout manually or on new device)
- Active sessions: Visible list showing all devices, with remote logout capability
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MFAManager module for TOTP 2FA</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add MFAManager module after AuthManager:

```javascript
const MFAManager = {
  // Check if MFA is required for current session
  async checkMFARequired() {
    if (!supabase) return { required: false };

    try {
      const { data: { currentLevel, nextLevel }, error } =
        await supabase.auth.mfa.getAuthenticatorAssuranceLevel();

      if (error) throw error;

      // MFA required if enrolled (nextLevel=aal2) but session is aal1
      const required = currentLevel === 'aal1' && nextLevel === 'aal2';
      return { required, currentLevel, nextLevel };
    } catch (error) {
      console.error('MFA check error:', error);
      return { required: false, error };
    }
  },

  // Get enrolled MFA factors
  async getFactors() {
    if (!supabase) return [];

    try {
      const { data, error } = await supabase.auth.mfa.listFactors();
      if (error) throw error;
      return data.totp || [];
    } catch (error) {
      console.error('List factors error:', error);
      return [];
    }
  },

  // Check if user has MFA enabled
  async isMFAEnabled() {
    const factors = await this.getFactors();
    return factors.length > 0;
  },

  // Start MFA enrollment (AUTH-05)
  async enroll() {
    if (!supabase) {
      throw new Error('Supabase not configured');
    }

    const { data, error } = await supabase.auth.mfa.enroll({
      factorType: 'totp',
      friendlyName: 'Authenticator App'
    });

    if (error) throw error;

    return {
      factorId: data.id,
      qrCode: data.totp.qr_code,  // SVG data URI
      secret: data.totp.secret,   // For manual entry
      uri: data.totp.uri
    };
  },

  // Verify enrollment with TOTP code
  async verifyEnrollment(factorId, code) {
    if (!supabase) {
      throw new Error('Supabase not configured');
    }

    const { data, error } = await supabase.auth.mfa.challengeAndVerify({
      factorId,
      code
    });

    if (error) throw error;

    console.log('MFA enrollment verified');
    return true;
  },

  // Verify MFA challenge during login
  async verifyChallenge(factorId, code) {
    if (!supabase) {
      throw new Error('Supabase not configured');
    }

    const { data, error } = await supabase.auth.mfa.challengeAndVerify({
      factorId,
      code
    });

    if (error) throw error;

    console.log('MFA challenge verified, session upgraded to AAL2');
    return true;
  },

  // Unenroll MFA factor (disable 2FA)
  async unenroll(factorId) {
    if (!supabase) {
      throw new Error('Supabase not configured');
    }

    const { data, error } = await supabase.auth.mfa.unenroll({
      factorId
    });

    if (error) throw error;

    console.log('MFA factor unenrolled');
    return true;
  }
};
```

Update AuthManager.initialize() to check for MFA after getting session:

```javascript
// After getting session in AuthManager.initialize():
// Check if MFA verification is needed
if (session) {
  const mfaCheck = await MFAManager.checkMFARequired();
  if (mfaCheck.required) {
    // Will need to show MFA challenge UI
    const factors = await MFAManager.getFactors();
    if (factors.length > 0) {
      this.pendingMFAFactorId = factors[0].id;
      // AuthUI will show MFA challenge
    }
  }
}
```

Add pendingMFAFactorId property to AuthManager:
```javascript
// At top of AuthManager object
pendingMFAFactorId: null,
```
  </action>
  <verify>
Console tests:
- MFAManager.checkMFARequired() returns object with required property
- MFAManager.isMFAEnabled() returns boolean
- MFAManager.enroll (function exists)
- MFAManager.verifyChallenge (function exists)
  </verify>
  <done>
MFAManager module with enroll, verifyEnrollment, verifyChallenge, unenroll, checkMFARequired, getFactors, isMFAEnabled methods
  </done>
</task>

<task type="auto">
  <name>Task 2: Add MFA enrollment and challenge UI</name>
  <files>autonomo_dashboard.html</files>
  <action>
1. Add MFA styles:

```css
/* MFA Modal Styles */
.mfa-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

.mfa-modal.hidden {
  display: none;
}

.mfa-content {
  background: var(--bg-secondary, #242424);
  border: 1px solid var(--border-color, #333);
  border-radius: 12px;
  padding: 32px;
  max-width: 400px;
  width: 90%;
  text-align: center;
}

.mfa-content h3 {
  margin: 0 0 8px 0;
  font-size: 20px;
  color: var(--text-primary, #fff);
}

.mfa-content p {
  color: var(--text-secondary, #888);
  font-size: 14px;
  margin-bottom: 24px;
}

.mfa-qr-code {
  background: #fff;
  padding: 16px;
  border-radius: 8px;
  margin-bottom: 16px;
  display: inline-block;
}

.mfa-qr-code img,
.mfa-qr-code svg {
  width: 180px;
  height: 180px;
}

.mfa-secret {
  background: var(--bg-primary, #1a1a1a);
  padding: 12px;
  border-radius: 6px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  color: var(--text-secondary, #888);
  margin-bottom: 20px;
  word-break: break-all;
}

.mfa-secret-label {
  font-size: 11px;
  color: var(--text-tertiary, #666);
  margin-bottom: 4px;
}

.mfa-code-input {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-bottom: 20px;
}

.mfa-code-input input {
  width: 48px;
  height: 56px;
  text-align: center;
  font-size: 24px;
  font-family: 'JetBrains Mono', monospace;
  background: var(--bg-primary, #1a1a1a);
  border: 1px solid var(--border-color, #333);
  border-radius: 8px;
  color: var(--text-primary, #fff);
}

.mfa-code-input input:focus {
  outline: none;
  border-color: var(--accent-color, #3b82f6);
}

.mfa-actions {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.mfa-btn {
  padding: 12px 24px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.2s;
}

.mfa-btn-primary {
  background: var(--accent-color, #3b82f6);
  color: #fff;
  border: none;
}

.mfa-btn-primary:hover {
  background: #2563eb;
}

.mfa-btn-primary:disabled {
  background: #4b5563;
  cursor: not-allowed;
}

.mfa-btn-secondary {
  background: transparent;
  color: var(--text-secondary, #888);
  border: 1px solid var(--border-color, #333);
}

.mfa-btn-secondary:hover {
  background: var(--bg-tertiary, #2a2a2a);
}
```

2. Add MFA modals HTML (after auth screen):

```html
<!-- MFA Challenge Modal (shown during login when 2FA required) -->
<div id="mfa-challenge-modal" class="mfa-modal hidden">
  <div class="mfa-content">
    <h3>Two-Factor Authentication</h3>
    <p>Enter the 6-digit code from your authenticator app.</p>

    <div class="mfa-code-input" id="mfa-challenge-code">
      <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="0">
      <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="1">
      <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="2">
      <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="3">
      <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="4">
      <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="5">
    </div>

    <div id="mfa-challenge-message" class="auth-message" style="display: none;"></div>

    <div class="mfa-actions">
      <button class="mfa-btn mfa-btn-primary" onclick="MFAUI.verifyChallenge()">
        Verify
      </button>
      <button class="mfa-btn mfa-btn-secondary" onclick="MFAUI.cancelChallenge()">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- MFA Enrollment Modal -->
<div id="mfa-enroll-modal" class="mfa-modal hidden">
  <div class="mfa-content">
    <h3>Set Up Two-Factor Authentication</h3>
    <p>Scan this QR code with your authenticator app (Google Authenticator, Authy, etc.)</p>

    <div class="mfa-qr-code" id="mfa-qr-container">
      <!-- QR code will be inserted here -->
    </div>

    <div class="mfa-secret-label">Or enter this code manually:</div>
    <div class="mfa-secret" id="mfa-secret-code">Loading...</div>

    <p style="margin-top: 20px;">Enter the 6-digit code to verify:</p>

    <div class="mfa-code-input" id="mfa-enroll-code">
      <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="0">
      <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="1">
      <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="2">
      <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="3">
      <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="4">
      <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="5">
    </div>

    <div id="mfa-enroll-message" class="auth-message" style="display: none;"></div>

    <div class="mfa-actions">
      <button class="mfa-btn mfa-btn-primary" onclick="MFAUI.completeEnrollment()">
        Enable 2FA
      </button>
      <button class="mfa-btn mfa-btn-secondary" onclick="MFAUI.cancelEnrollment()">
        Cancel
      </button>
    </div>
  </div>
</div>
```

3. Add MFAUI controller:

```javascript
const MFAUI = {
  enrollmentData: null,

  // Setup code input auto-advance behavior
  initCodeInputs(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const inputs = container.querySelectorAll('input');
    inputs.forEach((input, index) => {
      // Auto-advance on input
      input.addEventListener('input', (e) => {
        const value = e.target.value;
        if (value && index < inputs.length - 1) {
          inputs[index + 1].focus();
        }
      });

      // Handle backspace
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !e.target.value && index > 0) {
          inputs[index - 1].focus();
        }
      });

      // Handle paste
      input.addEventListener('paste', (e) => {
        e.preventDefault();
        const paste = (e.clipboardData || window.clipboardData).getData('text');
        const digits = paste.replace(/\D/g, '').split('');
        digits.slice(0, 6).forEach((digit, i) => {
          if (inputs[i]) inputs[i].value = digit;
        });
        // Focus last filled or next empty
        const lastIndex = Math.min(digits.length - 1, 5);
        inputs[lastIndex]?.focus();
      });
    });
  },

  // Get code from inputs
  getCode(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return '';
    return Array.from(container.querySelectorAll('input'))
      .map(i => i.value)
      .join('');
  },

  // Clear code inputs
  clearCode(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.querySelectorAll('input').forEach(i => {
      i.value = '';
    });
    container.querySelector('input')?.focus();
  },

  // Show message in modal
  showMessage(elementId, message, type) {
    const el = document.getElementById(elementId);
    if (el) {
      el.textContent = message;
      el.className = `auth-message ${type}`;
      el.style.display = 'block';
    }
  },

  // Start enrollment flow (AUTH-05)
  async startEnrollment() {
    if (AuthManager.isOfflineMode()) {
      alert('2FA requires online mode with Supabase configured.');
      return;
    }

    try {
      this.enrollmentData = await MFAManager.enroll();

      // Show QR code
      const qrContainer = document.getElementById('mfa-qr-container');
      if (qrContainer && this.enrollmentData.qrCode) {
        qrContainer.innerHTML = `<img src="${this.enrollmentData.qrCode}" alt="QR Code">`;
      }

      // Show secret for manual entry
      const secretEl = document.getElementById('mfa-secret-code');
      if (secretEl) {
        secretEl.textContent = this.enrollmentData.secret;
      }

      // Show modal
      const modal = document.getElementById('mfa-enroll-modal');
      if (modal) modal.classList.remove('hidden');

      // Init code inputs
      this.initCodeInputs('mfa-enroll-code');
      this.clearCode('mfa-enroll-code');

    } catch (error) {
      console.error('MFA enrollment error:', error);
      alert('Failed to start 2FA setup: ' + error.message);
    }
  },

  // Complete enrollment
  async completeEnrollment() {
    const code = this.getCode('mfa-enroll-code');
    if (code.length !== 6) {
      this.showMessage('mfa-enroll-message', 'Please enter all 6 digits', 'error');
      return;
    }

    try {
      await MFAManager.verifyEnrollment(this.enrollmentData.factorId, code);

      this.showMessage('mfa-enroll-message', '2FA enabled successfully!', 'success');

      // Close modal after delay
      setTimeout(() => {
        this.closeEnrollmentModal();
      }, 1500);

    } catch (error) {
      console.error('MFA verify error:', error);
      this.showMessage('mfa-enroll-message', 'Invalid code. Please try again.', 'error');
      this.clearCode('mfa-enroll-code');
    }
  },

  // Cancel enrollment
  cancelEnrollment() {
    this.enrollmentData = null;
    this.closeEnrollmentModal();
  },

  closeEnrollmentModal() {
    const modal = document.getElementById('mfa-enroll-modal');
    if (modal) modal.classList.add('hidden');
    this.enrollmentData = null;
  },

  // Show MFA challenge (during login)
  showChallenge(factorId) {
    AuthManager.pendingMFAFactorId = factorId;
    const modal = document.getElementById('mfa-challenge-modal');
    if (modal) modal.classList.remove('hidden');

    this.initCodeInputs('mfa-challenge-code');
    this.clearCode('mfa-challenge-code');
  },

  // Verify challenge
  async verifyChallenge() {
    const code = this.getCode('mfa-challenge-code');
    if (code.length !== 6) {
      this.showMessage('mfa-challenge-message', 'Please enter all 6 digits', 'error');
      return;
    }

    try {
      await MFAManager.verifyChallenge(AuthManager.pendingMFAFactorId, code);

      // Close modal and proceed to app
      this.closeChallengeModal();
      AuthUI.updateAuthState();

    } catch (error) {
      console.error('MFA challenge error:', error);
      this.showMessage('mfa-challenge-message', 'Invalid code. Please try again.', 'error');
      this.clearCode('mfa-challenge-code');
    }
  },

  // Cancel challenge (sign out)
  async cancelChallenge() {
    await AuthManager.signOut();
    this.closeChallengeModal();
  },

  closeChallengeModal() {
    const modal = document.getElementById('mfa-challenge-modal');
    if (modal) modal.classList.add('hidden');
    AuthManager.pendingMFAFactorId = null;
  },

  // Disable 2FA
  async disable() {
    if (!confirm('Are you sure you want to disable 2FA? This will make your account less secure.')) {
      return;
    }

    try {
      const factors = await MFAManager.getFactors();
      if (factors.length > 0) {
        await MFAManager.unenroll(factors[0].id);
        alert('2FA has been disabled.');
      }
    } catch (error) {
      console.error('MFA disable error:', error);
      alert('Failed to disable 2FA: ' + error.message);
    }
  }
};
```

4. Update AuthUI to show MFA challenge when needed:

Add to AuthUI.updateAuthState():
```javascript
// Check for pending MFA challenge
if (AuthManager.pendingMFAFactorId) {
  MFAUI.showChallenge(AuthManager.pendingMFAFactorId);
  return; // Don't show main app until MFA verified
}
```
  </action>
  <verify>
1. Console: MFAUI.startEnrollment (function exists)
2. If Supabase configured: Start enrollment should show QR code modal
3. Code input auto-advances when typing digits
4. Paste 6-digit code fills all inputs
  </verify>
  <done>
MFA enrollment modal with QR code display, MFA challenge modal for login, code input UX with auto-advance and paste support
  </done>
</task>

<task type="auto">
  <name>Task 3: Add sessions list UI</name>
  <files>autonomo_dashboard.html</files>
  <action>
1. Add sessions styles:

```css
/* Sessions Modal Styles */
.sessions-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

.sessions-modal.hidden {
  display: none;
}

.sessions-content {
  background: var(--bg-secondary, #242424);
  border: 1px solid var(--border-color, #333);
  border-radius: 12px;
  padding: 24px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}

.sessions-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.sessions-header h3 {
  margin: 0;
  font-size: 18px;
  color: var(--text-primary, #fff);
}

.sessions-close {
  background: none;
  border: none;
  color: var(--text-secondary, #888);
  cursor: pointer;
  padding: 4px;
  font-size: 20px;
}

.sessions-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.session-item {
  background: var(--bg-primary, #1a1a1a);
  border: 1px solid var(--border-color, #333);
  border-radius: 8px;
  padding: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.session-item.current {
  border-color: var(--accent-color, #3b82f6);
}

.session-info {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.session-device {
  font-size: 14px;
  color: var(--text-primary, #fff);
  font-weight: 500;
}

.session-details {
  font-size: 12px;
  color: var(--text-secondary, #888);
}

.session-current-badge {
  font-size: 11px;
  background: var(--accent-color, #3b82f6);
  color: #fff;
  padding: 2px 8px;
  border-radius: 10px;
  margin-left: 8px;
}

.session-revoke {
  background: transparent;
  border: 1px solid #ef4444;
  color: #ef4444;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

.session-revoke:hover {
  background: #ef4444;
  color: #fff;
}

.sessions-actions {
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid var(--border-color, #333);
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.sessions-action-btn {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  font-size: 14px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.sessions-action-btn.danger {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #ef4444;
}

.sessions-action-btn.danger:hover {
  background: rgba(239, 68, 68, 0.2);
}

.sessions-empty {
  text-align: center;
  color: var(--text-secondary, #888);
  padding: 32px;
  font-size: 14px;
}
```

2. Add sessions modal HTML:

```html
<!-- Sessions Modal (AUTH-06) -->
<div id="sessions-modal" class="sessions-modal hidden">
  <div class="sessions-content">
    <div class="sessions-header">
      <h3>Active Sessions</h3>
      <button class="sessions-close" onclick="SessionsUI.close()">&times;</button>
    </div>

    <div id="sessions-list" class="sessions-list">
      <!-- Sessions will be populated dynamically -->
    </div>

    <div class="sessions-actions">
      <button class="sessions-action-btn danger" onclick="SessionsUI.signOutOthers()">
        Sign out all other devices
      </button>
    </div>
  </div>
</div>
```

3. Add SessionsUI controller:

```javascript
const SessionsUI = {
  // Open sessions modal (AUTH-06)
  async open() {
    const modal = document.getElementById('sessions-modal');
    if (modal) modal.classList.remove('hidden');
    await this.load();
  },

  // Close modal
  close() {
    const modal = document.getElementById('sessions-modal');
    if (modal) modal.classList.add('hidden');
  },

  // Load sessions list
  async load() {
    const container = document.getElementById('sessions-list');
    if (!container) return;

    const user = AuthManager.getUser();
    if (!user) {
      container.innerHTML = '<div class="sessions-empty">Please sign in to view sessions.</div>';
      return;
    }

    const sessions = await SessionManager.getSessions(user.id);
    const currentSessionId = AuthManager.localSessionId;

    if (sessions.length === 0) {
      container.innerHTML = '<div class="sessions-empty">No active sessions found.</div>';
      return;
    }

    container.innerHTML = sessions.map(session => {
      const isCurrent = session.id === currentSessionId;
      const lastActive = this.formatLastActive(session.last_active_at);

      return `
        <div class="session-item ${isCurrent ? 'current' : ''}">
          <div class="session-info">
            <div class="session-device">
              ${this.escapeHtml(session.device_name || 'Unknown Device')}
              ${isCurrent ? '<span class="session-current-badge">Current</span>' : ''}
            </div>
            <div class="session-details">
              Last active: ${lastActive}
              ${session.location ? ` &bull; ${this.escapeHtml(session.location)}` : ''}
            </div>
          </div>
          ${!isCurrent ? `
            <button class="session-revoke" onclick="SessionsUI.revoke('${session.id}')">
              Revoke
            </button>
          ` : ''}
        </div>
      `;
    }).join('');
  },

  // Revoke individual session
  async revoke(sessionId) {
    if (!confirm('Are you sure you want to revoke this session?')) {
      return;
    }

    try {
      await SessionManager.revokeSession(sessionId);
      await this.load(); // Refresh list
    } catch (error) {
      console.error('Revoke session error:', error);
      alert('Failed to revoke session');
    }
  },

  // Sign out all other devices
  async signOutOthers() {
    if (!confirm('This will sign out all other devices. Continue?')) {
      return;
    }

    try {
      const user = AuthManager.getUser();
      if (!user) return;

      await SessionManager.revokeOtherSessions(user.id, AuthManager.localSessionId);

      // Also sign out via Supabase if available
      if (!AuthManager.isOfflineMode()) {
        await AuthManager.signOut('others');
      }

      await this.load(); // Refresh list
      alert('All other sessions have been revoked.');
    } catch (error) {
      console.error('Sign out others error:', error);
      alert('Failed to sign out other devices');
    }
  },

  // Format last active time
  formatLastActive(isoString) {
    if (!isoString) return 'Unknown';

    const date = new Date(isoString);
    const now = new Date();
    const diff = now - date;

    const minutes = Math.floor(diff / (1000 * 60));
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));

    if (minutes < 1) return 'Just now';
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}h ago`;
    if (days < 7) return `${days}d ago`;

    return date.toLocaleDateString('es-ES', {
      day: 'numeric',
      month: 'short',
      year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
    });
  },

  // Escape HTML to prevent XSS
  escapeHtml(str) {
    if (!str) return '';
    return str.replace(/[&<>"']/g, char => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    }[char]));
  }
};
```

4. Update UserMenuUI.showSessions():

```javascript
// In UserMenuUI object, update showSessions:
showSessions() {
  this.close();
  SessionsUI.open();
},
```

5. Add 2FA toggle to profile page. Find the profile-form in profile tab and add before the Save button:

```html
<!-- 2FA Settings -->
<div class="profile-field" id="profile-2fa-section">
  <label>Two-Factor Authentication</label>
  <div id="profile-2fa-status" style="display: flex; align-items: center; gap: 12px; margin-top: 8px;">
    <span id="profile-2fa-text">Loading...</span>
    <button type="button" id="profile-2fa-btn" class="auth-link" onclick="ProfileUI.toggle2FA()">
      Enable
    </button>
  </div>
</div>
```

6. Add 2FA toggle logic to ProfileUI:

```javascript
// Add to ProfileUI object:
async update2FAStatus() {
  const statusEl = document.getElementById('profile-2fa-text');
  const btnEl = document.getElementById('profile-2fa-btn');
  const sectionEl = document.getElementById('profile-2fa-section');

  if (AuthManager.isOfflineMode()) {
    if (sectionEl) sectionEl.style.display = 'none';
    return;
  }

  const enabled = await MFAManager.isMFAEnabled();

  if (statusEl) {
    statusEl.textContent = enabled ? 'Enabled' : 'Disabled';
    statusEl.style.color = enabled ? '#22c55e' : 'var(--text-secondary)';
  }

  if (btnEl) {
    btnEl.textContent = enabled ? 'Disable' : 'Enable';
  }
},

async toggle2FA() {
  const enabled = await MFAManager.isMFAEnabled();
  if (enabled) {
    await MFAUI.disable();
  } else {
    await MFAUI.startEnrollment();
  }
  // Refresh status after modal closes
  setTimeout(() => this.update2FAStatus(), 500);
}
```

7. Update ProfileUI.load() to also update 2FA status:

```javascript
// Add at end of ProfileUI.load():
await this.update2FAStatus();
```
  </action>
  <verify>
1. Click "Active Sessions" in user menu - modal opens
2. Sessions list shows current device with "Current" badge
3. Other sessions show "Revoke" button
4. "Sign out all other devices" button at bottom
5. Profile page shows 2FA toggle
6. Click "Enable" on 2FA - enrollment modal opens
  </verify>
  <done>
Sessions modal with list of active sessions, revoke individual sessions, sign out all other devices, 2FA toggle in profile page
  </done>
</task>

</tasks>

<verification>
1. Open autonomo_dashboard.html
2. Sign in (or continue offline)
3. Go to Profile - 2FA section visible (hidden in offline mode)
4. Click Enable 2FA - QR code modal appears (requires Supabase)
5. Click Active Sessions in user menu - sessions list shows
6. Current session marked, other sessions have revoke button
7. "Sign out all other devices" works
</verification>

<success_criteria>
- MFAManager module handles TOTP enrollment, verification, unenrollment
- MFA enrollment shows QR code and secret for manual entry (AUTH-05)
- MFA challenge intercepts login when 2FA enabled
- Code input UX auto-advances and handles paste
- Sessions list shows all active sessions with device info (AUTH-06)
- Current session identified, cannot be revoked
- Can revoke individual sessions
- Can sign out all other devices
- 2FA toggle visible in profile settings
</success_criteria>

<output>
After completion, create `.planning/phases/14-authentication-permissions/14-04-SUMMARY.md`
</output>
