---
phase: 14-authentication-permissions
plan: 03
type: execute
wave: 3
depends_on: [14-02]
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "Unauthenticated user sees login screen instead of dashboard"
    - "User can enter email and submit for magic link"
    - "User can click Google sign-in button"
    - "After authentication, user sees dashboard"
    - "User can access profile page to view/edit personal info"
    - "User can sign out and return to login screen"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Login screen UI"
      contains: "auth-screen"
    - path: "autonomo_dashboard.html"
      provides: "Profile page"
      contains: "profile-tab"
  key_links:
    - from: "login form submit"
      to: "AuthManager.signInWithMagicLink"
      via: "form event handler"
      pattern: "signInWithMagicLink.*email"
    - from: "Google button click"
      to: "AuthManager.signInWithGoogle"
      via: "click event handler"
      pattern: "signInWithGoogle"
---

<objective>
Authentication UI with login screen, profile page, and auth state management

Purpose: Provide user interface for authentication flow - users need visual way to sign in before using the application
Output: Login screen (magic link + Google), profile page with edit capability, auth-based view switching
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-authentication-permissions/14-CONTEXT.md
@.planning/phases/14-authentication-permissions/14-02-SUMMARY.md

Key decisions from 14-CONTEXT.md:
- Unauthenticated users: Redirect immediately to login page (no landing/preview)
- Primary method: Magic link (passwordless)
- Social login: Google only
- Login page design at Claude's discretion
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add login/auth screen HTML and CSS</name>
  <files>autonomo_dashboard.html</files>
  <action>
1. Add auth screen styles in the CSS section (near other screen/modal styles):

```css
/* Auth Screen Styles */
.auth-screen {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--bg-primary, #1a1a1a);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.auth-screen.hidden {
  display: none;
}

.auth-container {
  background: var(--bg-secondary, #242424);
  border: 1px solid var(--border-color, #333);
  border-radius: 12px;
  padding: 48px;
  max-width: 400px;
  width: 90%;
  text-align: center;
}

.auth-logo {
  font-size: 24px;
  font-weight: 600;
  color: var(--text-primary, #fff);
  margin-bottom: 8px;
}

.auth-subtitle {
  color: var(--text-secondary, #888);
  font-size: 14px;
  margin-bottom: 32px;
}

.auth-form {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.auth-input {
  background: var(--bg-primary, #1a1a1a);
  border: 1px solid var(--border-color, #333);
  border-radius: 8px;
  padding: 14px 16px;
  font-size: 16px;
  color: var(--text-primary, #fff);
  width: 100%;
  box-sizing: border-box;
  transition: border-color 0.2s;
}

.auth-input:focus {
  outline: none;
  border-color: var(--accent-color, #3b82f6);
}

.auth-input::placeholder {
  color: var(--text-tertiary, #666);
}

.auth-button {
  background: var(--accent-color, #3b82f6);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 14px 24px;
  font-size: 16px;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.2s, transform 0.1s;
}

.auth-button:hover {
  background: #2563eb;
}

.auth-button:active {
  transform: scale(0.98);
}

.auth-button:disabled {
  background: #4b5563;
  cursor: not-allowed;
}

.auth-button.google {
  background: #fff;
  color: #333;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
}

.auth-button.google:hover {
  background: #f3f4f6;
}

.auth-button.google svg {
  width: 20px;
  height: 20px;
}

.auth-divider {
  display: flex;
  align-items: center;
  gap: 16px;
  margin: 8px 0;
  color: var(--text-tertiary, #666);
  font-size: 13px;
}

.auth-divider::before,
.auth-divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border-color, #333);
}

.auth-message {
  padding: 12px 16px;
  border-radius: 8px;
  font-size: 14px;
  margin-top: 16px;
}

.auth-message.success {
  background: rgba(34, 197, 94, 0.1);
  color: #22c55e;
  border: 1px solid rgba(34, 197, 94, 0.2);
}

.auth-message.error {
  background: rgba(239, 68, 68, 0.1);
  color: #ef4444;
  border: 1px solid rgba(239, 68, 68, 0.2);
}

.auth-footer {
  margin-top: 24px;
  color: var(--text-tertiary, #666);
  font-size: 12px;
}

.auth-link {
  color: var(--accent-color, #3b82f6);
  cursor: pointer;
  text-decoration: none;
}

.auth-link:hover {
  text-decoration: underline;
}

/* Password reset view */
.auth-container[data-view="reset"] .auth-main-form,
.auth-container[data-view="main"] .auth-reset-form,
.auth-container[data-view="new-password"] .auth-main-form,
.auth-container[data-view="new-password"] .auth-reset-form,
.auth-container[data-view="main"] .auth-new-password-form,
.auth-container[data-view="reset"] .auth-new-password-form {
  display: none;
}

/* Offline mode notice */
.auth-offline-notice {
  background: rgba(234, 179, 8, 0.1);
  border: 1px solid rgba(234, 179, 8, 0.2);
  color: #eab308;
  padding: 12px 16px;
  border-radius: 8px;
  font-size: 13px;
  margin-bottom: 24px;
}
```

2. Add auth screen HTML right after the opening body tag (before loading screen):

```html
<!-- Auth Screen -->
<div id="auth-screen" class="auth-screen">
  <div class="auth-container" data-view="main">
    <div class="auth-logo">Autonomo Dashboard</div>
    <div class="auth-subtitle">Business Management for Spanish SMEs</div>

    <!-- Offline mode notice (shown when Supabase not configured) -->
    <div id="auth-offline-notice" class="auth-offline-notice" style="display: none;">
      Running in offline mode. Authentication disabled.<br>
      <button class="auth-link" onclick="AuthUI.continueOffline()">Continue without sign in</button>
    </div>

    <!-- Main login form -->
    <form class="auth-form auth-main-form" onsubmit="AuthUI.handleMagicLink(event)">
      <input
        type="email"
        class="auth-input"
        id="auth-email"
        placeholder="Enter your email"
        required
        autocomplete="email"
      >
      <button type="submit" class="auth-button" id="auth-submit-btn">
        Continue with Email
      </button>

      <div class="auth-divider">or</div>

      <button type="button" class="auth-button google" onclick="AuthUI.handleGoogle()">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        Continue with Google
      </button>

      <div id="auth-message" class="auth-message" style="display: none;"></div>
    </form>

    <!-- Password reset form -->
    <form class="auth-form auth-reset-form" onsubmit="AuthUI.handlePasswordReset(event)">
      <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">
        Enter your email to receive a password reset link.
      </p>
      <input
        type="email"
        class="auth-input"
        id="auth-reset-email"
        placeholder="Enter your email"
        required
        autocomplete="email"
      >
      <button type="submit" class="auth-button">
        Send Reset Link
      </button>
      <button type="button" class="auth-link" onclick="AuthUI.showView('main')" style="margin-top: 8px;">
        Back to sign in
      </button>
      <div id="auth-reset-message" class="auth-message" style="display: none;"></div>
    </form>

    <!-- New password form (after clicking reset link) -->
    <form class="auth-form auth-new-password-form" onsubmit="AuthUI.handleNewPassword(event)">
      <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">
        Enter your new password.
      </p>
      <input
        type="password"
        class="auth-input"
        id="auth-new-password"
        placeholder="New password"
        required
        minlength="8"
        autocomplete="new-password"
      >
      <input
        type="password"
        class="auth-input"
        id="auth-confirm-password"
        placeholder="Confirm password"
        required
        minlength="8"
        autocomplete="new-password"
      >
      <button type="submit" class="auth-button">
        Update Password
      </button>
      <div id="auth-password-message" class="auth-message" style="display: none;"></div>
    </form>

    <div class="auth-footer">
      <span class="auth-link" onclick="AuthUI.showView('reset')">Forgot password?</span>
    </div>
  </div>
</div>
```
  </action>
  <verify>
1. Open autonomo_dashboard.html
2. Auth screen should be visible (full page)
3. Email input and buttons are styled correctly
4. Google button has colored logo
5. No CSS errors in console
  </verify>
  <done>
Auth screen HTML and CSS added with magic link form, Google button, password reset views, and offline notice
  </done>
</task>

<task type="auto">
  <name>Task 2: Add AuthUI controller and auth state management</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add AuthUI controller after the AuthManager module:

```javascript
const AuthUI = {
  // Show/hide auth screen based on auth state
  updateAuthState() {
    const authScreen = document.getElementById('auth-screen');
    const mainContent = document.querySelector('.dashboard') || document.querySelector('main');
    const loadingScreen = document.getElementById('loading-screen');

    if (AuthManager.isOfflineMode()) {
      // Show offline notice
      const notice = document.getElementById('auth-offline-notice');
      if (notice) notice.style.display = 'block';
    }

    if (AuthManager.isAuthenticated() || AuthManager.isOfflineMode()) {
      // User authenticated or offline mode - show main app
      if (authScreen) authScreen.classList.add('hidden');
      if (mainContent) mainContent.style.display = '';
    } else {
      // Not authenticated - show login
      if (authScreen) authScreen.classList.remove('hidden');
      if (mainContent) mainContent.style.display = 'none';
      if (loadingScreen) loadingScreen.style.display = 'none';
    }

    // Check for recovery session
    if (AuthManager.isRecoverySession && AuthManager.isRecoverySession()) {
      this.showView('new-password');
    }
  },

  // Show specific auth view (main, reset, new-password)
  showView(view) {
    const container = document.querySelector('.auth-container');
    if (container) {
      container.setAttribute('data-view', view);
    }
    // Clear messages
    this.clearMessages();
  },

  // Clear all message elements
  clearMessages() {
    document.querySelectorAll('.auth-message').forEach(el => {
      el.style.display = 'none';
      el.textContent = '';
      el.className = 'auth-message';
    });
  },

  // Show message
  showMessage(elementId, message, type = 'success') {
    const el = document.getElementById(elementId);
    if (el) {
      el.textContent = message;
      el.className = `auth-message ${type}`;
      el.style.display = 'block';
    }
  },

  // Handle magic link submission
  async handleMagicLink(event) {
    event.preventDefault();
    const email = document.getElementById('auth-email').value.trim();
    const submitBtn = document.getElementById('auth-submit-btn');

    if (!email) return;

    try {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';

      const result = await AuthManager.signInWithMagicLink(email);
      this.showMessage('auth-message', result.message, 'success');

    } catch (error) {
      console.error('Magic link error:', error);
      this.showMessage('auth-message', error.message || 'Failed to send magic link', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Continue with Email';
    }
  },

  // Handle Google sign in
  async handleGoogle() {
    try {
      await AuthManager.signInWithGoogle();
      // User will be redirected to Google
    } catch (error) {
      console.error('Google sign in error:', error);
      this.showMessage('auth-message', error.message || 'Google sign in failed', 'error');
    }
  },

  // Handle password reset request
  async handlePasswordReset(event) {
    event.preventDefault();
    const email = document.getElementById('auth-reset-email').value.trim();

    if (!email) return;

    try {
      const result = await AuthManager.requestPasswordReset(email);
      this.showMessage('auth-reset-message', result.message, 'success');
    } catch (error) {
      console.error('Password reset error:', error);
      this.showMessage('auth-reset-message', error.message || 'Failed to send reset link', 'error');
    }
  },

  // Handle new password submission
  async handleNewPassword(event) {
    event.preventDefault();
    const password = document.getElementById('auth-new-password').value;
    const confirm = document.getElementById('auth-confirm-password').value;

    if (password !== confirm) {
      this.showMessage('auth-password-message', 'Passwords do not match', 'error');
      return;
    }

    if (password.length < 8) {
      this.showMessage('auth-password-message', 'Password must be at least 8 characters', 'error');
      return;
    }

    try {
      const result = await AuthManager.updatePassword(password);
      this.showMessage('auth-password-message', result.message, 'success');

      // Redirect to main app after short delay
      setTimeout(() => {
        this.showView('main');
        this.updateAuthState();
      }, 2000);

    } catch (error) {
      console.error('Password update error:', error);
      this.showMessage('auth-password-message', error.message || 'Failed to update password', 'error');
    }
  },

  // Continue in offline mode (skip auth)
  continueOffline() {
    const authScreen = document.getElementById('auth-screen');
    if (authScreen) authScreen.classList.add('hidden');

    const mainContent = document.querySelector('.dashboard') || document.querySelector('main');
    if (mainContent) mainContent.style.display = '';
  },

  // Initialize auth UI
  init() {
    // Listen for auth state changes
    if (!AuthManager.isOfflineMode()) {
      AuthManager.onAuthStateChange((event, session) => {
        this.updateAuthState();
      });
    }

    // Initial state check
    this.updateAuthState();
  }
};
```

Update the DOMContentLoaded handler to initialize AuthUI after database:

Find the existing DOMContentLoaded handler and add after initializeDatabase():
```javascript
// Initialize Auth UI
AuthUI.init();
```

Or if there's an initApp() function, add there:
```javascript
// After database initialization
AuthUI.init();
```
  </action>
  <verify>
1. Refresh page
2. Auth screen visible (if not authenticated)
3. Enter email, click "Continue with Email" - button shows "Sending..."
4. If Supabase not configured, shows error message
5. Click "Continue without sign in" in offline mode - app shows
  </verify>
  <done>
AuthUI controller handles form submissions, view switching, message display, and coordinates auth state with main app visibility
  </done>
</task>

<task type="auto">
  <name>Task 3: Add profile tab and user menu</name>
  <files>autonomo_dashboard.html</files>
  <action>
1. Add profile tab CSS:

```css
/* User Menu Styles */
.user-menu {
  position: relative;
  margin-left: auto;
}

.user-menu-trigger {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: var(--bg-secondary, #242424);
  border: 1px solid var(--border-color, #333);
  border-radius: 8px;
  color: var(--text-primary, #fff);
  cursor: pointer;
  font-size: 14px;
  transition: background-color 0.2s;
}

.user-menu-trigger:hover {
  background: var(--bg-tertiary, #2a2a2a);
}

.user-avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: var(--accent-color, #3b82f6);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 600;
  color: #fff;
}

.user-menu-dropdown {
  position: absolute;
  top: calc(100% + 8px);
  right: 0;
  background: var(--bg-secondary, #242424);
  border: 1px solid var(--border-color, #333);
  border-radius: 8px;
  min-width: 200px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  z-index: 1000;
  display: none;
}

.user-menu-dropdown.open {
  display: block;
}

.user-menu-item {
  padding: 12px 16px;
  color: var(--text-primary, #fff);
  cursor: pointer;
  font-size: 14px;
  transition: background-color 0.2s;
  display: flex;
  align-items: center;
  gap: 8px;
}

.user-menu-item:first-child {
  border-radius: 8px 8px 0 0;
}

.user-menu-item:last-child {
  border-radius: 0 0 8px 8px;
}

.user-menu-item:hover {
  background: var(--bg-tertiary, #2a2a2a);
}

.user-menu-item.danger {
  color: #ef4444;
}

.user-menu-divider {
  height: 1px;
  background: var(--border-color, #333);
  margin: 4px 0;
}

/* Profile Section Styles */
.profile-section {
  max-width: 600px;
  margin: 0 auto;
  padding: 24px;
}

.profile-header {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 32px;
}

.profile-avatar-large {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: var(--accent-color, #3b82f6);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  font-weight: 600;
  color: #fff;
}

.profile-info h2 {
  margin: 0 0 4px 0;
  font-size: 24px;
  color: var(--text-primary, #fff);
}

.profile-info p {
  margin: 0;
  color: var(--text-secondary, #888);
  font-size: 14px;
}

.profile-form {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.profile-field {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.profile-field label {
  font-size: 13px;
  color: var(--text-secondary, #888);
  font-weight: 500;
}

.profile-field input {
  background: var(--bg-primary, #1a1a1a);
  border: 1px solid var(--border-color, #333);
  border-radius: 8px;
  padding: 12px 14px;
  font-size: 15px;
  color: var(--text-primary, #fff);
  transition: border-color 0.2s;
}

.profile-field input:focus {
  outline: none;
  border-color: var(--accent-color, #3b82f6);
}

.profile-actions {
  display: flex;
  gap: 12px;
  margin-top: 8px;
}

.profile-save-btn {
  background: var(--accent-color, #3b82f6);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 12px 24px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.2s;
}

.profile-save-btn:hover {
  background: #2563eb;
}

.profile-save-btn:disabled {
  background: #4b5563;
  cursor: not-allowed;
}
```

2. Add user menu HTML in the header (find header section, add before closing header tag):

```html
<!-- User Menu (shown when authenticated) -->
<div id="user-menu" class="user-menu" style="display: none;">
  <button class="user-menu-trigger" onclick="UserMenuUI.toggle()">
    <div class="user-avatar" id="user-avatar-initial">?</div>
    <span id="user-menu-name">User</span>
    <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
      <path d="M6 8L2 4h8L6 8z"/>
    </svg>
  </button>
  <div id="user-menu-dropdown" class="user-menu-dropdown">
    <div class="user-menu-item" onclick="UserMenuUI.showProfile()">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
        <path d="M8 8a3 3 0 100-6 3 3 0 000 6zm0 2c-3.314 0-6 1.343-6 3v1h12v-1c0-1.657-2.686-3-6-3z"/>
      </svg>
      Profile
    </div>
    <div class="user-menu-item" onclick="UserMenuUI.showSessions()">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
        <path d="M2 3h12a1 1 0 011 1v8a1 1 0 01-1 1H2a1 1 0 01-1-1V4a1 1 0 011-1zm0 2v6h12V5H2z"/>
      </svg>
      Active Sessions
    </div>
    <div class="user-menu-divider"></div>
    <div class="user-menu-item danger" onclick="UserMenuUI.signOut()">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
        <path d="M11 3v2h2v6h-2v2h4V3h-4zM3 8l4-4v3h4v2H7v3L3 8z"/>
      </svg>
      Sign Out
    </div>
  </div>
</div>
```

3. Add Profile tab content (add as a new tab content section, following existing tab pattern):

```html
<!-- Profile Tab Content -->
<div id="profile-tab" class="tab-content" style="display: none;">
  <div class="profile-section">
    <div class="profile-header">
      <div class="profile-avatar-large" id="profile-avatar">?</div>
      <div class="profile-info">
        <h2 id="profile-display-name">User</h2>
        <p id="profile-email">user@example.com</p>
      </div>
    </div>

    <form class="profile-form" onsubmit="ProfileUI.save(event)">
      <div class="profile-field">
        <label for="profile-name">Full Name</label>
        <input type="text" id="profile-name" placeholder="Your full name">
      </div>

      <div class="profile-field">
        <label for="profile-nif">NIF/CIF</label>
        <input type="text" id="profile-nif" placeholder="12345678A">
      </div>

      <div class="profile-field">
        <label for="profile-phone">Phone</label>
        <input type="tel" id="profile-phone" placeholder="+34 600 000 000">
      </div>

      <div class="profile-field">
        <label for="profile-address">Address</label>
        <input type="text" id="profile-address" placeholder="Street, City, Postal Code">
      </div>

      <div class="profile-actions">
        <button type="submit" class="profile-save-btn">Save Changes</button>
      </div>

      <div id="profile-message" class="auth-message" style="display: none;"></div>
    </form>
  </div>
</div>
```

4. Add UserMenuUI and ProfileUI controllers:

```javascript
const UserMenuUI = {
  // Toggle dropdown
  toggle() {
    const dropdown = document.getElementById('user-menu-dropdown');
    if (dropdown) {
      dropdown.classList.toggle('open');
    }
  },

  // Close dropdown
  close() {
    const dropdown = document.getElementById('user-menu-dropdown');
    if (dropdown) {
      dropdown.classList.remove('open');
    }
  },

  // Update user menu with current user info
  update() {
    const user = AuthManager.getUser();
    const menu = document.getElementById('user-menu');

    if (!menu) return;

    if (user) {
      menu.style.display = '';
      const name = user.user_metadata?.name || user.user_metadata?.full_name || user.email?.split('@')[0] || 'User';
      const initial = name.charAt(0).toUpperCase();

      document.getElementById('user-avatar-initial').textContent = initial;
      document.getElementById('user-menu-name').textContent = name;
    } else if (AuthManager.isOfflineMode()) {
      // Show simplified menu in offline mode
      menu.style.display = '';
      document.getElementById('user-avatar-initial').textContent = 'O';
      document.getElementById('user-menu-name').textContent = 'Offline';
    } else {
      menu.style.display = 'none';
    }
  },

  // Navigate to profile tab
  showProfile() {
    this.close();
    // Activate profile tab (use existing tab switching mechanism)
    if (typeof switchTab === 'function') {
      switchTab('profile-tab');
    } else {
      // Fallback: manually show profile tab
      document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
      const profileTab = document.getElementById('profile-tab');
      if (profileTab) profileTab.style.display = 'block';
    }
    ProfileUI.load();
  },

  // Show sessions modal (to be implemented in Plan 04)
  showSessions() {
    this.close();
    console.log('Sessions - to be implemented in Plan 04');
    // TODO: Show sessions modal
  },

  // Sign out
  async signOut() {
    this.close();
    try {
      await AuthManager.signOut('local');
    } catch (error) {
      console.error('Sign out error:', error);
    }
    // AuthUI will handle showing login screen
  },

  // Initialize
  init() {
    // Update menu when auth state changes
    AuthManager.onAuthStateChange(() => {
      this.update();
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const menu = document.getElementById('user-menu');
      if (menu && !menu.contains(e.target)) {
        this.close();
      }
    });

    // Initial update
    this.update();
  }
};

const ProfileUI = {
  // Load profile data into form
  async load() {
    const user = AuthManager.getUser();
    if (!user) return;

    const profile = await ProfileManager.getProfile(user.id);

    // Update header
    const name = profile?.name || user.user_metadata?.name || user.email?.split('@')[0] || 'User';
    document.getElementById('profile-display-name').textContent = name;
    document.getElementById('profile-email').textContent = user.email || '';
    document.getElementById('profile-avatar').textContent = name.charAt(0).toUpperCase();

    // Fill form
    document.getElementById('profile-name').value = profile?.name || '';
    document.getElementById('profile-nif').value = profile?.nif_cif || '';
    document.getElementById('profile-phone').value = profile?.phone || '';
    document.getElementById('profile-address').value = profile?.address || '';
  },

  // Save profile changes
  async save(event) {
    event.preventDefault();
    const user = AuthManager.getUser();
    if (!user) return;

    const data = {
      name: document.getElementById('profile-name').value.trim(),
      nif_cif: document.getElementById('profile-nif').value.trim(),
      phone: document.getElementById('profile-phone').value.trim(),
      address: document.getElementById('profile-address').value.trim()
    };

    // Validate NIF/CIF if provided
    if (data.nif_cif) {
      const validation = SpanishTaxIdValidator.validate(data.nif_cif);
      if (!validation.valid) {
        this.showMessage(validation.error, 'error');
        return;
      }
      data.nif_cif = validation.normalized;
    }

    try {
      await ProfileManager.upsertProfile(user.id, data);
      this.showMessage('Profile updated successfully', 'success');

      // Update user menu
      UserMenuUI.update();
    } catch (error) {
      console.error('Profile save error:', error);
      this.showMessage('Failed to save profile', 'error');
    }
  },

  showMessage(message, type) {
    const el = document.getElementById('profile-message');
    if (el) {
      el.textContent = message;
      el.className = `auth-message ${type}`;
      el.style.display = 'block';

      // Auto-hide success messages
      if (type === 'success') {
        setTimeout(() => {
          el.style.display = 'none';
        }, 3000);
      }
    }
  }
};
```

5. Initialize UserMenuUI in the app initialization:

Add after AuthUI.init():
```javascript
UserMenuUI.init();
```
  </action>
  <verify>
1. Refresh page and sign in (or continue offline)
2. User menu visible in header
3. Click user menu - dropdown opens with Profile, Active Sessions, Sign Out
4. Click Profile - profile form displays
5. Edit profile fields and save - message shows "Profile updated successfully"
6. Click Sign Out - returns to login screen
  </verify>
  <done>
User menu with dropdown, profile tab with edit form, NIF/CIF validation on profile, sign out functionality
  </done>
</task>

</tasks>

<verification>
1. Open autonomo_dashboard.html
2. Auth screen shows on load (if Supabase not configured, shows offline notice)
3. Can click "Continue without sign in" to enter offline mode
4. User menu appears in header when authenticated/offline
5. Profile page accessible from user menu
6. Profile form validates NIF/CIF with SpanishTaxIdValidator
7. Sign out returns to login screen
</verification>

<success_criteria>
- Auth screen blocks access until authenticated (or offline mode selected)
- Magic link form submits to AuthManager.signInWithMagicLink
- Google button triggers AuthManager.signInWithGoogle
- Password reset flow works (request, new password form)
- User menu shows in header with avatar and name
- Profile page edits name, NIF/CIF, phone, address (AUTH-07)
- NIF/CIF validation uses SpanishTaxIdValidator
- Sign out clears session and shows login screen
</success_criteria>

<output>
After completion, create `.planning/phases/14-authentication-permissions/14-03-SUMMARY.md`
</output>
