---
phase: 14-authentication-permissions
plan: 05
type: execute
wave: 5
depends_on: [14-03]
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "Entity owner can create invitation for user"
    - "Invitation can be sent via email link or shareable code"
    - "Invited user can accept invitation and gain access"
    - "Owner can view pending invitations"
    - "Owner can revoke user access"
    - "Invitations expire after 7 days"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Invitation management UI"
      contains: "invite-modal"
    - path: "autonomo_dashboard.html"
      provides: "Entity sharing management"
      contains: "sharing-section"
  key_links:
    - from: "invite form submit"
      to: "InvitationManager.createInvitation"
      via: "InviteUI.create"
      pattern: "createInvitation"
    - from: "accept invitation"
      to: "InvitationManager.acceptInvitation"
      via: "InviteUI.accept"
      pattern: "acceptInvitation"
---

<objective>
Invitation system for entity sharing with role assignment

Purpose: Enable entity owners to invite users (Gestor/Accountant/Partner) to access their entity data (PERM-01, PERM-02, PERM-03, PERM-05)
Output: Invite modal, pending invitations list, accept invitation flow, entity access management
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-authentication-permissions/14-CONTEXT.md
@.planning/phases/14-authentication-permissions/14-03-SUMMARY.md

Key decisions from 14-CONTEXT.md:
- Two methods available: email invitation link OR shareable code
- Invitations expire after 7 days
- Users can belong to unlimited entities (with potentially different roles)
- New users (no account): Invite link leads to signup flow, then auto-joins entity after account creation
- Roles: Gestor (read-only), Accountant (read-write), Partner (full admin)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add invitation and sharing UI styles</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add CSS styles for invitation system:

```css
/* Invite Modal Styles */
.invite-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

.invite-modal.hidden {
  display: none;
}

.invite-content {
  background: var(--bg-secondary, #242424);
  border: 1px solid var(--border-color, #333);
  border-radius: 12px;
  padding: 24px;
  max-width: 480px;
  width: 90%;
}

.invite-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.invite-header h3 {
  margin: 0;
  font-size: 18px;
  color: var(--text-primary, #fff);
}

.invite-close {
  background: none;
  border: none;
  color: var(--text-secondary, #888);
  cursor: pointer;
  padding: 4px;
  font-size: 20px;
}

.invite-form {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.invite-field {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.invite-field label {
  font-size: 13px;
  color: var(--text-secondary, #888);
  font-weight: 500;
}

.invite-field input,
.invite-field select {
  background: var(--bg-primary, #1a1a1a);
  border: 1px solid var(--border-color, #333);
  border-radius: 8px;
  padding: 12px 14px;
  font-size: 15px;
  color: var(--text-primary, #fff);
  transition: border-color 0.2s;
}

.invite-field input:focus,
.invite-field select:focus {
  outline: none;
  border-color: var(--accent-color, #3b82f6);
}

.invite-field select {
  cursor: pointer;
}

.invite-field .help-text {
  font-size: 12px;
  color: var(--text-tertiary, #666);
  margin-top: 4px;
}

.invite-submit {
  background: var(--accent-color, #3b82f6);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 12px 24px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.2s;
  margin-top: 8px;
}

.invite-submit:hover {
  background: #2563eb;
}

.invite-submit:disabled {
  background: #4b5563;
  cursor: not-allowed;
}

/* Invite result (link/code) */
.invite-result {
  margin-top: 20px;
  padding: 16px;
  background: rgba(34, 197, 94, 0.1);
  border: 1px solid rgba(34, 197, 94, 0.2);
  border-radius: 8px;
}

.invite-result-title {
  font-size: 14px;
  font-weight: 500;
  color: #22c55e;
  margin-bottom: 12px;
}

.invite-result-field {
  margin-bottom: 12px;
}

.invite-result-label {
  font-size: 12px;
  color: var(--text-tertiary, #666);
  margin-bottom: 4px;
}

.invite-result-value {
  display: flex;
  align-items: center;
  gap: 8px;
}

.invite-result-value input {
  flex: 1;
  background: var(--bg-primary, #1a1a1a);
  border: 1px solid var(--border-color, #333);
  border-radius: 6px;
  padding: 10px 12px;
  font-size: 13px;
  color: var(--text-primary, #fff);
  font-family: 'JetBrains Mono', monospace;
}

.invite-copy-btn {
  background: var(--bg-tertiary, #2a2a2a);
  border: 1px solid var(--border-color, #333);
  border-radius: 6px;
  padding: 10px 14px;
  color: var(--text-primary, #fff);
  cursor: pointer;
  font-size: 12px;
  white-space: nowrap;
}

.invite-copy-btn:hover {
  background: var(--border-color, #333);
}

/* Sharing Section Styles */
.sharing-section {
  margin-top: 32px;
  padding-top: 24px;
  border-top: 1px solid var(--border-color, #333);
}

.sharing-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.sharing-header h4 {
  margin: 0;
  font-size: 16px;
  color: var(--text-primary, #fff);
}

.sharing-invite-btn {
  background: var(--accent-color, #3b82f6);
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 8px 16px;
  font-size: 13px;
  cursor: pointer;
}

.sharing-invite-btn:hover {
  background: #2563eb;
}

.sharing-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.sharing-item {
  background: var(--bg-primary, #1a1a1a);
  border: 1px solid var(--border-color, #333);
  border-radius: 8px;
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.sharing-item.pending {
  border-style: dashed;
  opacity: 0.8;
}

.sharing-user {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.sharing-user-name {
  font-size: 14px;
  color: var(--text-primary, #fff);
}

.sharing-user-email {
  font-size: 12px;
  color: var(--text-secondary, #888);
}

.sharing-user-status {
  font-size: 11px;
  color: var(--text-tertiary, #666);
  font-style: italic;
}

.sharing-role {
  display: flex;
  align-items: center;
  gap: 12px;
}

.sharing-role-badge {
  font-size: 12px;
  padding: 4px 10px;
  border-radius: 12px;
  font-weight: 500;
}

.sharing-role-badge.owner {
  background: rgba(168, 85, 247, 0.2);
  color: #a855f7;
}

.sharing-role-badge.partner {
  background: rgba(34, 197, 94, 0.2);
  color: #22c55e;
}

.sharing-role-badge.accountant {
  background: rgba(59, 130, 246, 0.2);
  color: #3b82f6;
}

.sharing-role-badge.gestor {
  background: rgba(234, 179, 8, 0.2);
  color: #eab308;
}

.sharing-revoke {
  background: none;
  border: none;
  color: #ef4444;
  cursor: pointer;
  font-size: 12px;
  padding: 4px 8px;
}

.sharing-revoke:hover {
  text-decoration: underline;
}

.sharing-empty {
  text-align: center;
  color: var(--text-tertiary, #666);
  padding: 24px;
  font-size: 14px;
}

/* Accept Invite Banner */
.invite-accept-banner {
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.2);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.invite-accept-banner.hidden {
  display: none;
}

.invite-accept-info h4 {
  margin: 0 0 4px 0;
  font-size: 14px;
  color: var(--text-primary, #fff);
}

.invite-accept-info p {
  margin: 0;
  font-size: 13px;
  color: var(--text-secondary, #888);
}

.invite-accept-actions {
  display: flex;
  gap: 8px;
}

.invite-accept-btn {
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 13px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.invite-accept-btn.accept {
  background: var(--accent-color, #3b82f6);
  color: #fff;
  border: none;
}

.invite-accept-btn.accept:hover {
  background: #2563eb;
}

.invite-accept-btn.decline {
  background: transparent;
  color: var(--text-secondary, #888);
  border: 1px solid var(--border-color, #333);
}

.invite-accept-btn.decline:hover {
  background: var(--bg-tertiary, #2a2a2a);
}
```
  </action>
  <verify>
CSS added without syntax errors (page loads correctly)
  </verify>
  <done>
CSS styles for invite modal, sharing list, accept banner, role badges
  </done>
</task>

<task type="auto">
  <name>Task 2: Add invitation modal and InviteUI controller</name>
  <files>autonomo_dashboard.html</files>
  <action>
1. Add invite modal HTML (after other modals):

```html
<!-- Invite User Modal (PERM-01, PERM-02) -->
<div id="invite-modal" class="invite-modal hidden">
  <div class="invite-content">
    <div class="invite-header">
      <h3>Invite User to Entity</h3>
      <button class="invite-close" onclick="InviteUI.closeModal()">&times;</button>
    </div>

    <form class="invite-form" id="invite-form" onsubmit="InviteUI.create(event)">
      <div class="invite-field">
        <label for="invite-email">Email Address (optional)</label>
        <input type="email" id="invite-email" placeholder="user@example.com">
        <div class="help-text">Leave empty to generate a shareable link only</div>
      </div>

      <div class="invite-field">
        <label for="invite-role">Role</label>
        <select id="invite-role" required>
          <option value="gestor">Gestor (View Only)</option>
          <option value="accountant">Accountant (View & Edit)</option>
          <option value="partner">Partner (Full Access)</option>
        </select>
        <div class="help-text" id="invite-role-help">
          Can view and export data, but cannot make changes
        </div>
      </div>

      <button type="submit" class="invite-submit" id="invite-submit-btn">
        Create Invitation
      </button>

      <div id="invite-message" class="auth-message" style="display: none;"></div>
    </form>

    <!-- Invitation result (shown after creation) -->
    <div id="invite-result" class="invite-result" style="display: none;">
      <div class="invite-result-title">Invitation Created!</div>

      <div class="invite-result-field">
        <div class="invite-result-label">Shareable Link</div>
        <div class="invite-result-value">
          <input type="text" id="invite-result-link" readonly>
          <button type="button" class="invite-copy-btn" onclick="InviteUI.copyLink()">
            Copy
          </button>
        </div>
      </div>

      <div class="invite-result-field">
        <div class="invite-result-label">Invite Code</div>
        <div class="invite-result-value">
          <input type="text" id="invite-result-code" readonly>
          <button type="button" class="invite-copy-btn" onclick="InviteUI.copyCode()">
            Copy
          </button>
        </div>
      </div>

      <div class="help-text" style="margin-top: 12px;">
        This invitation expires in 7 days.
      </div>
    </div>
  </div>
</div>

<!-- Accept Invitation Banner (shown when URL has invite param) -->
<div id="invite-accept-banner" class="invite-accept-banner hidden">
  <div class="invite-accept-info">
    <h4 id="invite-accept-title">You've been invited!</h4>
    <p id="invite-accept-desc">Entity Owner invited you as Gestor</p>
  </div>
  <div class="invite-accept-actions">
    <button class="invite-accept-btn accept" onclick="InviteUI.acceptFromBanner()">
      Accept
    </button>
    <button class="invite-accept-btn decline" onclick="InviteUI.declineBanner()">
      Decline
    </button>
  </div>
</div>
```

2. Add InviteUI controller:

```javascript
const InviteUI = {
  pendingInviteCode: null,
  pendingInviteData: null,

  // Open invite modal for current entity
  openModal() {
    const modal = document.getElementById('invite-modal');
    if (modal) modal.classList.remove('hidden');

    // Reset form
    document.getElementById('invite-form').reset();
    document.getElementById('invite-result').style.display = 'none';
    document.getElementById('invite-message').style.display = 'none';

    // Update role help text
    this.updateRoleHelp();
  },

  // Close modal
  closeModal() {
    const modal = document.getElementById('invite-modal');
    if (modal) modal.classList.add('hidden');
  },

  // Update role description based on selection
  updateRoleHelp() {
    const role = document.getElementById('invite-role').value;
    const helpEl = document.getElementById('invite-role-help');

    const descriptions = {
      gestor: 'Can view and export data, but cannot make changes',
      accountant: 'Can view, edit, and categorize expenses. Cannot delete or create invoices',
      partner: 'Full access except deleting the entity. Can invite other users'
    };

    if (helpEl) {
      helpEl.textContent = descriptions[role] || '';
    }
  },

  // Create invitation (PERM-01, PERM-02)
  async create(event) {
    event.preventDefault();

    const email = document.getElementById('invite-email').value.trim();
    const role = document.getElementById('invite-role').value;
    const submitBtn = document.getElementById('invite-submit-btn');

    const currentEntity = EntityContext.getCurrentEntity();
    if (!currentEntity) {
      this.showMessage('Please select an entity first', 'error');
      return;
    }

    const user = AuthManager.getUser();
    if (!user) {
      this.showMessage('Please sign in first', 'error');
      return;
    }

    // Check permission
    const canInvite = await EntityAccessManager.canPerformAction(currentEntity.id, 'invite');
    if (!canInvite) {
      this.showMessage('You do not have permission to invite users', 'error');
      return;
    }

    try {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating...';

      const invitation = await InvitationManager.createInvitation(
        currentEntity.id,
        role,
        user.id,
        email || null
      );

      // Show result
      const baseUrl = `${window.location.origin}${window.location.pathname}`;
      const inviteLink = `${baseUrl}?invite=${invitation.inviteCode}`;

      document.getElementById('invite-result-link').value = inviteLink;
      document.getElementById('invite-result-code').value = invitation.inviteCode;
      document.getElementById('invite-result').style.display = 'block';
      document.getElementById('invite-form').style.display = 'none';

      // TODO: If email provided, send invitation email (requires Supabase Edge Function)
      if (email) {
        console.log('Email invitation would be sent to:', email);
        // In production, call Supabase Edge Function to send email
      }

    } catch (error) {
      console.error('Create invitation error:', error);
      this.showMessage(error.message || 'Failed to create invitation', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Create Invitation';
    }
  },

  // Copy invite link
  copyLink() {
    const input = document.getElementById('invite-result-link');
    if (input) {
      input.select();
      navigator.clipboard.writeText(input.value);
      alert('Link copied to clipboard!');
    }
  },

  // Copy invite code
  copyCode() {
    const input = document.getElementById('invite-result-code');
    if (input) {
      input.select();
      navigator.clipboard.writeText(input.value);
      alert('Code copied to clipboard!');
    }
  },

  // Show message in modal
  showMessage(message, type) {
    const el = document.getElementById('invite-message');
    if (el) {
      el.textContent = message;
      el.className = `auth-message ${type}`;
      el.style.display = 'block';
    }
  },

  // Check URL for invite parameter (PERM-03)
  async checkURLInvite() {
    const url = new URL(window.location.href);
    const inviteCode = url.searchParams.get('invite');

    if (!inviteCode) return;

    // Clean URL
    url.searchParams.delete('invite');
    window.history.replaceState({}, document.title, url.pathname + url.search);

    // Get invitation details
    const invitation = await InvitationManager.getInvitation(inviteCode);
    if (!invitation) {
      alert('This invitation is invalid or has expired.');
      return;
    }

    // Get entity name
    const entity = await db.entities.get(invitation.entity_id);
    const entityName = entity?.name || 'Unknown Entity';

    // Store for later
    this.pendingInviteCode = inviteCode;
    this.pendingInviteData = invitation;

    // Show accept banner
    const banner = document.getElementById('invite-accept-banner');
    const title = document.getElementById('invite-accept-title');
    const desc = document.getElementById('invite-accept-desc');

    if (banner && title && desc) {
      title.textContent = `You've been invited to ${entityName}`;
      desc.textContent = `Role: ${this.formatRole(invitation.role)}`;
      banner.classList.remove('hidden');
    }
  },

  // Accept invitation from banner
  async acceptFromBanner() {
    if (!this.pendingInviteCode) return;

    const user = AuthManager.getUser();
    if (!user) {
      alert('Please sign in first to accept this invitation.');
      return;
    }

    try {
      await InvitationManager.acceptInvitation(this.pendingInviteCode, user.id);
      alert('Invitation accepted! You now have access to this entity.');

      // Hide banner
      this.hideBanner();

      // Refresh entity list
      if (typeof EntitySwitcherUI !== 'undefined' && EntitySwitcherUI.refresh) {
        EntitySwitcherUI.refresh();
      }

    } catch (error) {
      console.error('Accept invitation error:', error);
      alert('Failed to accept invitation: ' + error.message);
    }
  },

  // Decline invitation
  declineBanner() {
    this.pendingInviteCode = null;
    this.pendingInviteData = null;
    this.hideBanner();
  },

  hideBanner() {
    const banner = document.getElementById('invite-accept-banner');
    if (banner) banner.classList.add('hidden');
  },

  // Format role for display
  formatRole(role) {
    const names = {
      gestor: 'Gestor (View Only)',
      accountant: 'Accountant (View & Edit)',
      partner: 'Partner (Full Access)'
    };
    return names[role] || role;
  },

  // Initialize
  init() {
    // Check for invite in URL after auth
    AuthManager.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN') {
        this.checkURLInvite();
      }
    });

    // Also check on initial load
    if (AuthManager.isAuthenticated()) {
      this.checkURLInvite();
    }

    // Role select change handler
    const roleSelect = document.getElementById('invite-role');
    if (roleSelect) {
      roleSelect.addEventListener('change', () => this.updateRoleHelp());
    }
  }
};
```

3. Initialize InviteUI in app initialization:

Add after other UI inits:
```javascript
InviteUI.init();
```
  </action>
  <verify>
1. Console: InviteUI.openModal (function exists)
2. Can open invite modal (need to wire button in next task)
3. Role select updates help text
4. Form submits and shows result
  </verify>
  <done>
Invite modal with email/role fields, invitation result with copyable link and code, URL parameter handling for invite acceptance, accept/decline banner
  </done>
</task>

<task type="auto">
  <name>Task 3: Add sharing management section to entity settings</name>
  <files>autonomo_dashboard.html</files>
  <action>
1. Add SharingUI controller for entity sharing management:

```javascript
const SharingUI = {
  // Load sharing section for current entity
  async load() {
    const container = document.getElementById('sharing-list');
    if (!container) return;

    const currentEntity = EntityContext.getCurrentEntity();
    if (!currentEntity) {
      container.innerHTML = '<div class="sharing-empty">Select an entity to manage sharing.</div>';
      return;
    }

    const user = AuthManager.getUser();
    const userRole = await EntityAccessManager.getRole(currentEntity.id, user?.id);

    // Get shares and pending invitations
    const shares = await EntityShareManager.getShares(currentEntity.id);
    const pendingInvites = await InvitationManager.getPendingInvitations(currentEntity.id);

    // Check if user can manage sharing
    const canManage = userRole === 'owner' || userRole === 'partner';

    // Build owner item first
    let html = '';

    // Show owner
    if (currentEntity.owner_id) {
      const ownerProfile = await ProfileManager.getProfile(currentEntity.owner_id);
      const isCurrentUser = currentEntity.owner_id === user?.id;

      html += `
        <div class="sharing-item">
          <div class="sharing-user">
            <div class="sharing-user-name">
              ${this.escapeHtml(ownerProfile?.name || ownerProfile?.email?.split('@')[0] || 'Owner')}
              ${isCurrentUser ? ' (you)' : ''}
            </div>
            <div class="sharing-user-email">${this.escapeHtml(ownerProfile?.email || '')}</div>
          </div>
          <div class="sharing-role">
            <span class="sharing-role-badge owner">Owner</span>
          </div>
        </div>
      `;
    }

    // Show active shares
    for (const share of shares) {
      if (share.accepted_at) {
        const profile = await ProfileManager.getProfile(share.user_id);
        const isCurrentUser = share.user_id === user?.id;

        html += `
          <div class="sharing-item">
            <div class="sharing-user">
              <div class="sharing-user-name">
                ${this.escapeHtml(profile?.name || profile?.email?.split('@')[0] || 'User')}
                ${isCurrentUser ? ' (you)' : ''}
              </div>
              <div class="sharing-user-email">${this.escapeHtml(profile?.email || '')}</div>
            </div>
            <div class="sharing-role">
              <span class="sharing-role-badge ${share.role}">${this.formatRole(share.role)}</span>
              ${canManage && !isCurrentUser ? `
                <button class="sharing-revoke" onclick="SharingUI.revoke(${currentEntity.id}, '${share.user_id}')">
                  Revoke
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }
    }

    // Show pending invitations
    for (const invite of pendingInvites) {
      const expiresIn = this.formatExpiresIn(invite.expires_at);

      html += `
        <div class="sharing-item pending">
          <div class="sharing-user">
            <div class="sharing-user-name">${this.escapeHtml(invite.email || 'Invite Link')}</div>
            <div class="sharing-user-status">Pending &bull; Expires ${expiresIn}</div>
          </div>
          <div class="sharing-role">
            <span class="sharing-role-badge ${invite.role}">${this.formatRole(invite.role)}</span>
            ${canManage ? `
              <button class="sharing-revoke" onclick="SharingUI.cancelInvite(${invite.id})">
                Cancel
              </button>
            ` : ''}
          </div>
        </div>
      `;
    }

    if (!html) {
      html = '<div class="sharing-empty">No users have access to this entity.</div>';
    }

    container.innerHTML = html;

    // Show/hide invite button based on permission
    const inviteBtn = document.getElementById('sharing-invite-btn');
    if (inviteBtn) {
      inviteBtn.style.display = canManage ? '' : 'none';
    }
  },

  // Revoke user access (PERM-05)
  async revoke(entityId, userId) {
    if (!confirm('Are you sure you want to revoke this user\'s access?')) {
      return;
    }

    try {
      await EntityShareManager.removeShare(entityId, userId);
      await this.load(); // Refresh list
    } catch (error) {
      console.error('Revoke access error:', error);
      alert('Failed to revoke access: ' + error.message);
    }
  },

  // Cancel pending invitation
  async cancelInvite(inviteId) {
    if (!confirm('Cancel this invitation?')) {
      return;
    }

    try {
      await db.entity_invitations.update(inviteId, {
        used_at: new Date().toISOString(),
        used_by: null // Cancelled, not used
      });
      await this.load(); // Refresh list
    } catch (error) {
      console.error('Cancel invite error:', error);
      alert('Failed to cancel invitation');
    }
  },

  // Format role for display
  formatRole(role) {
    const names = {
      owner: 'Owner',
      gestor: 'Gestor',
      accountant: 'Accountant',
      partner: 'Partner'
    };
    return names[role] || role;
  },

  // Format expiration time
  formatExpiresIn(isoString) {
    const expires = new Date(isoString);
    const now = new Date();
    const diff = expires - now;

    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor(diff / (1000 * 60 * 60));

    if (days > 1) return `in ${days} days`;
    if (days === 1) return 'tomorrow';
    if (hours > 0) return `in ${hours} hours`;
    return 'soon';
  },

  // Escape HTML
  escapeHtml(str) {
    if (!str) return '';
    return str.replace(/[&<>"']/g, char => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    }[char]));
  }
};
```

2. Add sharing section HTML to the entity settings area (find appropriate location in entity detail or settings):

Look for entity detail/settings section (near EntityModal or after entity switcher). Add this sharing section:

```html
<!-- Entity Sharing Section (PERM-01 through PERM-05) -->
<div id="sharing-section" class="sharing-section" style="display: none;">
  <div class="sharing-header">
    <h4>Team Access</h4>
    <button id="sharing-invite-btn" class="sharing-invite-btn" onclick="InviteUI.openModal()">
      + Invite User
    </button>
  </div>
  <div id="sharing-list" class="sharing-list">
    <!-- Populated by SharingUI.load() -->
  </div>
</div>
```

3. Wire up sharing section visibility based on entity context:

Add to EntityContext subscriber or wherever entity changes are handled:
```javascript
// When entity changes, update sharing section
EntityContext.subscribe(async (entity) => {
  const sharingSection = document.getElementById('sharing-section');
  if (sharingSection) {
    if (entity && AuthManager.isAuthenticated()) {
      sharingSection.style.display = '';
      await SharingUI.load();
    } else {
      sharingSection.style.display = 'none';
    }
  }
});
```

If EntityContext.subscribe doesn't exist or can't be used, add to AuthManager.onAuthStateChange:
```javascript
// In AuthManager initialization or AuthUI
AuthManager.onAuthStateChange(async (event, session) => {
  if (event === 'SIGNED_IN') {
    const sharingSection = document.getElementById('sharing-section');
    if (sharingSection && EntityContext.getCurrentEntity()) {
      sharingSection.style.display = '';
      await SharingUI.load();
    }
  }
});
```
  </action>
  <verify>
1. Sharing section visible when entity selected and authenticated
2. Shows owner with "Owner" badge
3. Shows any shared users with their roles
4. Shows pending invitations with "Pending" status
5. Invite button opens invite modal
6. Revoke button removes access
  </verify>
  <done>
Sharing section shows entity team members with roles, pending invitations, invite button, revoke capability for owners/partners
  </done>
</task>

</tasks>

<verification>
1. Open autonomo_dashboard.html and sign in
2. Select/create an entity
3. Sharing section shows with "Invite User" button
4. Click Invite User - modal opens
5. Enter email (optional) and select role
6. Create invitation - link and code displayed
7. Copy link/code works
8. Sharing list shows pending invitation
9. Can cancel pending invitation
10. Accept invitation flow works (test with ?invite=CODE parameter)
</verification>

<success_criteria>
- Owner can create invitations with role selection (PERM-01, PERM-02)
- Invitation generates shareable link and code
- Email field optional (for link-only sharing)
- Invitations expire after 7 days
- Accept invitation flow via URL parameter (PERM-03)
- Accept banner shows when visiting with invite code
- Sharing section shows all team members with roles
- Can revoke user access (PERM-05)
- Can cancel pending invitations
- Only owners/partners can invite and revoke
</success_criteria>

<output>
After completion, create `.planning/phases/14-authentication-permissions/14-05-SUMMARY.md`
</output>
