---
phase: 08-enhanced-features
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "Income tab appears as 5th tab in navigation (after Expenses, before Compliance)"
    - "User can add income entry with client name, invoice number, amount, date"
    - "Income entries persist across browser sessions"
    - "Total income displays and updates when entries are added/deleted"
    - "User can filter/sort income entries by date, client, amount"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Income tracking tab with CRUD operations"
      contains: "INCOME_STORAGE_KEY"
  key_links:
    - from: "saveIncomeEntry function"
      to: "localStorage"
      via: "setItem with INCOME_STORAGE_KEY"
      pattern: "localStorage\\.setItem.*INCOME_STORAGE_KEY"
    - from: "income form submit"
      to: "renderIncomeList"
      via: "saveIncomeEntry callback"
      pattern: "saveIncomeEntry.*renderIncomeList"
    - from: "#tab-income radio"
      to: ".panel-income"
      via: "CSS :checked selector"
      pattern: "#tab-income:checked.*panel-income"
---

<objective>
Add Income tracking tab for managing client earnings with invoice numbers and auto-calculated totals.

Purpose: Enable users to track income from clients, link to invoices, and have visibility into total earnings that can be imported into scenarios.
Output: Enhanced autonomo_dashboard.html with complete Income tab including add/edit/delete, filtering, and localStorage persistence.

**NOTE:** Income-to-scenario integration (auto-populate scenario revenue from income total) is DEFERRED to a future phase. Per CONTEXT.md, the hybrid approach means users can manually enter revenue in scenarios OR reference income tab values - this plan implements the income tracking itself, not the scenario wiring.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-enhanced-features/08-CONTEXT.md
@.planning/phases/08-enhanced-features/08-RESEARCH.md
@.planning/phases/08-enhanced-features/08-01-SUMMARY.md
@autonomo_dashboard.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Income tab navigation and panel structure</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add the 5th Income tab following the established CSS radio button pattern (ENH-02 part 1):

1. Add radio input in the dashboard div (after existing tab inputs around line 3555, before .tab-nav):
```html
<input type="radio" name="tabs" id="tab-income" class="tab-input">
```

2. Add label in .tab-nav (after Expenses label around line 3568, before Compliance label):
```html
<label for="tab-income" class="tab-label">Income</label>
```

3. Add CSS selectors for Income tab (in the tab navigation section around line 240):
```css
#tab-income:checked ~ .tab-nav .tab-label[for="tab-income"] {
  border-bottom-color: var(--accent);
  color: var(--accent);
  letter-spacing: 0.75px;
}

#tab-income:checked ~ .tab-panels .panel-income {
  display: block;
}
```

4. Add panel structure in .tab-panels (after panel-expenses around line 3740, before panel-compliance):
```html
<div class="tab-panel panel-income">
  <div class="income-header">
    <h2>Income Tracking</h2>
    <div class="income-summary">
      <span class="income-total">Total: <span id="incomeTotalDisplay" class="mono">0.00 EUR</span></span>
      <span class="income-count">(<span id="incomeCountDisplay">0</span> entries)</span>
    </div>
  </div>

  <div class="income-controls">
    <div class="income-filters">
      <select id="incomeSortBy" onchange="renderIncomeList()">
        <option value="date-desc">Newest First</option>
        <option value="date-asc">Oldest First</option>
        <option value="amount-desc">Highest Amount</option>
        <option value="amount-asc">Lowest Amount</option>
        <option value="client-asc">Client A-Z</option>
      </select>
      <input type="text" id="incomeFilterText" placeholder="Filter by client or invoice..." oninput="renderIncomeList()">
    </div>
    <button type="button" class="add-btn" onclick="openIncomeDialog()">+ Add Income</button>
  </div>

  <div id="incomeList" class="income-list">
    <!-- Income entries rendered here -->
  </div>
</div>
```

5. Add CSS for Income panel (add near other panel styles around line 258):
```css
/* Income panel styles */
.panel-income {
  padding: var(--spacing-md);
}

.income-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-md);
  flex-wrap: wrap;
  gap: var(--spacing-sm);
}

.income-header h2 {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 600;
}

.income-summary {
  display: flex;
  gap: var(--spacing-md);
  align-items: center;
}

.income-total {
  font-weight: 600;
  color: var(--accent);
}

.income-count {
  color: var(--text-muted);
  font-size: var(--size-small);
}

.income-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-md);
  gap: var(--spacing-md);
  flex-wrap: wrap;
}

.income-filters {
  display: flex;
  gap: var(--spacing-sm);
  flex-wrap: wrap;
}

.income-filters select,
.income-filters input {
  padding: 8px 12px;
  background: var(--bg-surface);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-size: var(--size-small);
}

.income-filters input {
  min-width: 200px;
}

.income-list {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-sm);
}

/* Income entry card */
.income-entry {
  display: grid;
  grid-template-columns: 1fr auto auto;
  gap: var(--spacing-md);
  padding: var(--spacing-md);
  background: var(--bg-surface);
  border-radius: var(--radius-md);
  border: 1px solid rgba(255,255,255,0.06);
  align-items: center;
}

.income-entry:hover {
  border-color: rgba(255,255,255,0.12);
}

.income-entry-info {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.income-client {
  font-weight: 600;
  color: var(--text);
}

.income-details {
  display: flex;
  gap: var(--spacing-md);
  font-size: var(--size-small);
  color: var(--text-muted);
}

.income-amount {
  font-family: var(--font-mono);
  font-size: var(--size-numbers);
  color: var(--accent);
  font-weight: 600;
}

.income-actions {
  display: flex;
  gap: var(--spacing-xs);
}

.income-actions button {
  padding: 6px 10px;
  font-size: var(--size-small);
  background: transparent;
  border: 1px solid rgba(255,255,255,0.1);
  color: var(--text-muted);
  cursor: pointer;
}

.income-actions button:hover {
  background: rgba(255,255,255,0.05);
  color: var(--text);
}

.income-actions .delete-btn:hover {
  border-color: var(--negative);
  color: var(--negative);
}

/* Empty state */
.income-empty {
  text-align: center;
  padding: var(--spacing-2xl);
  color: var(--text-muted);
}
```

Reference existing tab structure around lines 195-252 and panel-expenses structure.
  </action>
  <verify>
Open autonomo_dashboard.html in browser:
1. Income tab visible in navigation (5th position, between Expenses and Compliance)
2. Clicking Income tab shows the Income panel
3. Other tabs still work correctly
4. Income panel shows header, filters, add button, empty list area
5. Styling consistent with other tabs (dark theme, proper spacing)
  </verify>
  <done>
Income tab added to navigation with CSS radio button pattern. Panel includes header with total/count displays, filter/sort controls, add button, and list container. All styling consistent with existing dashboard aesthetic.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Income dialog and basic CRUD functions</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add Income dialog HTML and core data management functions (ENH-02 part 2a):

1. Add storage constant near other storage keys (around line 3900):
```javascript
const INCOME_STORAGE_KEY = 'autonomo_income_v1';

const DEFAULT_INCOME = Object.freeze({
  version: 1,
  entries: []
});
```

2. Add income dialog HTML (near other dialogs, around line 3850):
```html
<dialog id="incomeDialog" class="modal-dialog">
  <form id="incomeForm" onsubmit="saveIncomeEntry(event)">
    <h3 id="incomeDialogTitle">Add Income Entry</h3>

    <div class="form-group">
      <label for="incomeClient">Client Name *</label>
      <input type="text" id="incomeClient" name="clientName" required>
    </div>

    <div class="form-group">
      <label for="incomeInvoice">Invoice Number</label>
      <input type="text" id="incomeInvoice" name="invoiceNumber" placeholder="INV-2026-001">
    </div>

    <div class="form-group">
      <label for="incomeAmount">Amount (EUR) *</label>
      <input type="number" id="incomeAmount" name="amount" step="0.01" min="0" required>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="incomeDateInvoiced">Date Invoiced</label>
        <input type="date" id="incomeDateInvoiced" name="dateInvoiced">
      </div>
      <div class="form-group">
        <label for="incomeDateReceived">Date Received *</label>
        <input type="date" id="incomeDateReceived" name="dateReceived" required>
      </div>
    </div>

    <div class="form-group">
      <label for="incomeDescription">Description</label>
      <textarea id="incomeDescription" name="description" rows="2" placeholder="IT Consulting - January 2026"></textarea>
    </div>

    <div class="form-group">
      <label for="incomeStatus">Status</label>
      <select id="incomeStatus" name="status">
        <option value="paid">Paid</option>
        <option value="pending">Pending</option>
        <option value="overdue">Overdue</option>
      </select>
    </div>

    <input type="hidden" id="incomeEditId" name="editId">

    <div class="dialog-footer">
      <button type="button" onclick="closeIncomeDialog()">Cancel</button>
      <button type="submit" class="primary">Save</button>
    </div>
  </form>
</dialog>
```

3. Add core income management functions:
```javascript
// Income data management
function loadIncomeData() {
  try {
    const stored = localStorage.getItem(INCOME_STORAGE_KEY);
    if (stored) {
      const data = JSON.parse(stored);
      return data.entries || [];
    }
  } catch (e) {
    console.error('Error loading income data:', e);
  }
  return [];
}

function saveIncomeData(entries) {
  localStorage.setItem(INCOME_STORAGE_KEY, JSON.stringify({
    version: 1,
    entries: entries
  }));
}

function openIncomeDialog(editId = null) {
  const dialog = document.getElementById('incomeDialog');
  const form = document.getElementById('incomeForm');
  const title = document.getElementById('incomeDialogTitle');
  const editIdInput = document.getElementById('incomeEditId');

  form.reset();

  if (editId) {
    title.textContent = 'Edit Income Entry';
    const entries = loadIncomeData();
    const entry = entries.find(e => e.id === editId);
    if (entry) {
      document.getElementById('incomeClient').value = entry.clientName || '';
      document.getElementById('incomeInvoice').value = entry.invoiceNumber || '';
      document.getElementById('incomeAmount').value = entry.amount || '';
      document.getElementById('incomeDateInvoiced').value = entry.dateInvoiced || '';
      document.getElementById('incomeDateReceived').value = entry.dateReceived || '';
      document.getElementById('incomeDescription').value = entry.description || '';
      document.getElementById('incomeStatus').value = entry.status || 'paid';
      editIdInput.value = editId;
    }
  } else {
    title.textContent = 'Add Income Entry';
    editIdInput.value = '';
    // Set default date to today
    document.getElementById('incomeDateReceived').value = new Date().toISOString().split('T')[0];
  }

  dialog.showModal();
}

function closeIncomeDialog() {
  document.getElementById('incomeDialog').close();
}

function saveIncomeEntry(event) {
  event.preventDefault();
  const form = event.target;
  const editId = form.editId.value;

  const entry = {
    id: editId || 'income-' + Date.now(),
    clientName: form.clientName.value.trim(),
    invoiceNumber: form.invoiceNumber.value.trim(),
    amount: parseFloat(form.amount.value) || 0,
    dateInvoiced: form.dateInvoiced.value,
    dateReceived: form.dateReceived.value,
    description: form.description.value.trim(),
    status: form.status.value
  };

  let entries = loadIncomeData();

  if (editId) {
    const index = entries.findIndex(e => e.id === editId);
    if (index !== -1) {
      entries[index] = entry;
    }
  } else {
    entries.push(entry);
  }

  saveIncomeData(entries);
  closeIncomeDialog();
  renderIncomeList();
}

function deleteIncomeEntry(id) {
  if (!confirm('Delete this income entry?')) return;

  let entries = loadIncomeData();
  entries = entries.filter(e => e.id !== id);
  saveIncomeData(entries);
  renderIncomeList();
}
```

4. Add dialog CSS if not already present:
```css
/* Income dialog - reuse modal-dialog pattern */
#incomeDialog {
  max-width: 500px;
}

#incomeDialog .form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--spacing-md);
}

/* Status select color coding */
#incomeStatus option[value="paid"] { color: #4ade80; }
#incomeStatus option[value="pending"] { color: #fb923c; }
#incomeStatus option[value="overdue"] { color: #f87171; }
```

Reference existing expense dialog pattern and localStorage patterns.
  </action>
  <verify>
Open autonomo_dashboard.html in browser, go to Income tab:
1. Click "+ Add Income" - dialog opens with empty form
2. Fill in: Client "Belgian Company BV", Invoice "INV-2026-001", Amount "5000", Date today
3. Save - entry appears in list (basic rendering, will be enhanced in Task 3)
4. Edit entry - form pre-fills, save updates entry
5. Delete entry - confirms and removes
6. Refresh page - data persists from localStorage
  </verify>
  <done>
Income dialog implemented with all form fields (client, invoice, amount, dates, description, status). Core CRUD functions working: loadIncomeData, saveIncomeData, openIncomeDialog, closeIncomeDialog, saveIncomeEntry, deleteIncomeEntry. localStorage persistence with versioned key.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement Income list rendering with filter/sort</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add renderIncomeList function with filtering and sorting (ENH-02 part 2b):

1. Add the main rendering function:
```javascript
function renderIncomeList() {
  const container = document.getElementById('incomeList');
  const totalDisplay = document.getElementById('incomeTotalDisplay');
  const countDisplay = document.getElementById('incomeCountDisplay');
  const sortBy = document.getElementById('incomeSortBy').value;
  const filterText = document.getElementById('incomeFilterText').value.toLowerCase().trim();

  let entries = loadIncomeData();

  // Filter
  if (filterText) {
    entries = entries.filter(e =>
      (e.clientName && e.clientName.toLowerCase().includes(filterText)) ||
      (e.invoiceNumber && e.invoiceNumber.toLowerCase().includes(filterText))
    );
  }

  // Sort
  entries.sort((a, b) => {
    switch (sortBy) {
      case 'date-desc':
        return new Date(b.dateReceived) - new Date(a.dateReceived);
      case 'date-asc':
        return new Date(a.dateReceived) - new Date(b.dateReceived);
      case 'amount-desc':
        return b.amount - a.amount;
      case 'amount-asc':
        return a.amount - b.amount;
      case 'client-asc':
        return (a.clientName || '').localeCompare(b.clientName || '');
      default:
        return 0;
    }
  });

  // Calculate total (from ALL entries, not filtered)
  const allEntries = loadIncomeData();
  const total = allEntries.reduce((sum, e) => sum + (e.amount || 0), 0);
  totalDisplay.textContent = total.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' EUR';
  countDisplay.textContent = allEntries.length;

  // Render
  if (entries.length === 0) {
    container.innerHTML = '<div class="income-empty">No income entries yet. Click "+ Add Income" to start tracking.</div>';
    return;
  }

  const statusColors = {
    paid: 'var(--accent)',
    pending: 'var(--warning)',
    overdue: 'var(--negative)'
  };

  container.innerHTML = entries.map(entry => {
    const dateDisplay = entry.dateReceived ? new Date(entry.dateReceived).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : '-';
    const statusColor = statusColors[entry.status] || 'var(--text-muted)';

    return `
      <div class="income-entry">
        <div class="income-entry-info">
          <span class="income-client">${escapeHtml(entry.clientName)}</span>
          <div class="income-details">
            ${entry.invoiceNumber ? `<span>Invoice: ${escapeHtml(entry.invoiceNumber)}</span>` : ''}
            <span>Received: ${dateDisplay}</span>
            <span style="color: ${statusColor}; text-transform: capitalize;">${entry.status}</span>
          </div>
          ${entry.description ? `<div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">${escapeHtml(entry.description)}</div>` : ''}
        </div>
        <div class="income-amount">${entry.amount.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} EUR</div>
        <div class="income-actions">
          <button type="button" onclick="openIncomeDialog('${entry.id}')">Edit</button>
          <button type="button" class="delete-btn" onclick="deleteIncomeEntry('${entry.id}')">Delete</button>
        </div>
      </div>
    `;
  }).join('');
}

// Helper for HTML escaping (add if not already defined)
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
```

2. Initialize income list on page load - add to initDashboard() or DOMContentLoaded handler:
```javascript
renderIncomeList();
```

3. Ensure escapeHtml function exists (check if already defined elsewhere, add if not).

Reference existing expense list rendering patterns.
  </action>
  <verify>
Open autonomo_dashboard.html in browser, go to Income tab:
1. Add multiple income entries with different clients and amounts
2. Total updates to sum of all amounts
3. Count shows correct number of entries
4. Filter by client name - only matching entries shown, total unchanged
5. Filter by invoice number - works correctly
6. Sort by "Highest Amount" - entries reorder correctly
7. Sort by "Newest First" - entries reorder by date
8. Sort by "Client A-Z" - entries reorder alphabetically
9. Clear filter - all entries visible again
10. Refresh page - entries persist from localStorage
  </verify>
  <done>
Income list rendering fully functional with filter by client/invoice and sort by date/amount/client. Total and count auto-calculate from all entries (unaffected by filter). Empty state message displayed when no entries. All entry data displayed with proper formatting and color-coded status.
  </done>
</task>

</tasks>

<verification>
Full verification after all tasks:
1. Income tab visible and functional in 5th position
2. All existing tabs (Scenarios, Calendar, Expenses, Details, Compliance) still work
3. Income CRUD: add, edit, delete operations work
4. Income filtering and sorting work correctly
5. Total and count update automatically
6. Data persists in localStorage across browser sessions
7. Dialog styling consistent with existing dialogs
8. No console errors
</verification>

<success_criteria>
- ENH-02 complete: Income tracking tab with client earnings, invoice numbers, and auto-calculation
- Tab position correct (after Expenses, before Compliance)
- localStorage persistence working with versioned key
- Filter/sort functionality operational
- Styling consistent with existing dashboard aesthetic
- NOTE: Scenario integration deferred to future phase (manual entry remains primary scenario input method)
</success_criteria>

<output>
After completion, create `.planning/phases/08-enhanced-features/08-02-SUMMARY.md`
</output>
