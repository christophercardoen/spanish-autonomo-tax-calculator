---
phase: 08-enhanced-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "Selected calendar days show prominent green overlay/border before status applied"
    - "Selection count badge displays number of days selected"
    - "Adding expense with keyword like 'Adobe' shows '100% (suggested)' badge"
    - "User can confirm or override suggested 100% deduction percentage"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Enhanced calendar selection visuals and expense auto-detection"
      contains: "DEDUCTIBLE_100_CATEGORIES"
  key_links:
    - from: "day-cell checkbox change"
      to: "selection visual feedback"
      via: "CSS class toggle"
      pattern: "day-cell\\.selected"
    - from: "expense name input"
      to: "detectDeductibleCategory function"
      via: "input event listener"
      pattern: "detectDeductibleCategory"
---

<objective>
Enhance calendar multi-select visual feedback and add intelligent expense auto-detection for 100% deductible categories.

Purpose: Improve user confidence in calendar selections and reduce manual categorization effort for common IT/consulting expenses.
Output: Enhanced autonomo_dashboard.html with prominent selection visuals and expense detection suggestions.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-enhanced-features/08-CONTEXT.md
@.planning/phases/08-enhanced-features/08-RESEARCH.md
@.planning/phases/07.1-critical-bug-fixes/7.1-03-SUMMARY.md
@autonomo_dashboard.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance calendar selection visual feedback</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add prominent visual feedback for selected calendar days (ENH-06):

**PREREQUISITE:** Phase 7.1-03 already implemented multi-select functionality including:
- `selectedDates` Set for tracking selections
- `selectWeek(weekStartKey)` function for "W" button
- `selectMonth(month)` function for "Select All" button
- `updateSelectionIndicator()` function showing count
- `clearSelection()` function
- Basic `.day-cell.selected` CSS class (green highlight outline)
- `#selectionIndicator` element with `#selectionCount` span

This task ENHANCES the existing visuals, not creating new selection logic.

1. ENHANCE existing `.day-cell.selected` CSS (search for existing rule around line 3065):
```css
/* Selected day visual feedback - MORE prominent */
.day-cell.selected {
  background: rgba(74, 222, 128, 0.2) !important;
  border: 2px solid var(--accent) !important;
  box-shadow: 0 0 8px rgba(74, 222, 128, 0.3);
}

/* Checkbox checked state enhancement */
.day-cell.selected .day-checkbox {
  accent-color: var(--accent);
}
```

2. ADD selection count badge styling (new CSS):
```css
/* Selection count badge styling */
.selection-count-badge {
  background: var(--accent);
  color: var(--bg);
  padding: 4px 12px;
  border-radius: 999px;
  font-weight: 600;
  font-size: var(--size-small);
  margin-left: var(--spacing-sm);
}
```

3. UPDATE the existing `updateSelectionIndicator()` function (around line 5050) to include badge:
   - Wrap the count in a span with class `selection-count-badge`
   - Current: `indicator.textContent = count + ' days selected'`
   - New: Include badge span for the count number

4. VERIFY existing handlers already toggle the 'selected' class:
   - `renderCalendar()` applies `.selected` class based on `selectedDates.has(dateKey)`
   - Individual checkbox changes should trigger `renderCalendar()` or manually toggle class

5. Test that enhanced visuals work with all existing selection methods:
   - Individual checkbox click
   - "W" week selector button
   - "Select All" month button
   - Shift-click range selection (if implemented)
   - "Clear Selection" button

Reference existing calendar code: search for `selectedDates`, `selectWeek`, `selectMonth`, `updateSelectionIndicator`.
  </action>
  <verify>
Open autonomo_dashboard.html in browser, go to Calendar tab:
1. Click checkbox on any day - should show green overlay/border with glow
2. Click "W" button - all 7 days show green overlay
3. Click "Select All" for month - all month days show green overlay
4. Selection count badge visible with green background pill showing count
5. Deselect via checkbox - green overlay removed
6. "Clear Selection" removes all overlays
  </verify>
  <done>
Selected days have prominent green overlay (rgba(74, 222, 128, 0.2)), 2px accent border, and subtle glow. Selection count badge shows "X days selected" with green pill background. Visual feedback updates correctly on selection/deselection via all methods (checkbox, W, Select All, Clear).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add expense 100% deductible auto-detection</name>
  <files>autonomo_dashboard.html</files>
  <action>
Implement intelligent expense auto-detection for 100% deductible categories (ENH-01):

1. Add DEDUCTIBLE_100_CATEGORIES constant in the Constants section (near SOURCES):
```javascript
const DEDUCTIBLE_100_CATEGORIES = Object.freeze({
  keywords: [
    // Software (HIGH confidence)
    { pattern: /\b(software|licencia|subscription|suscripcion)\b/i, category: 'Software', confidence: 'HIGH' },
    { pattern: /\b(adobe|microsoft 365|google workspace|slack|notion|github|jira|figma|jetbrains)\b/i, category: 'Software', confidence: 'HIGH' },

    // Cloud/Hosting (HIGH confidence)
    { pattern: /\b(hosting|domain|dominio|servidor|server|cloud|aws|azure|gcp|heroku|vercel|netlify)\b/i, category: 'Cloud/Hosting', confidence: 'HIGH' },

    // Equipment (HIGH confidence)
    { pattern: /\b(ordenador|computer|laptop|macbook|monitor|pantalla)\b/i, category: 'Equipment', confidence: 'HIGH' },
    { pattern: /\b(teclado|keyboard|raton|mouse|webcam|camara|microfono|auriculares|headphones)\b/i, category: 'Equipment', confidence: 'HIGH' },

    // Professional Services (HIGH confidence)
    { pattern: /\b(gestor|gestoria|asesor|asesoria|accountant|contable|abogado|lawyer|notario)\b/i, category: 'Professional Services', confidence: 'HIGH' },

    // Training (HIGH confidence)
    { pattern: /\b(curso|course|formacion|training|certificacion|certification|udemy|coursera|pluralsight)\b/i, category: 'Training', confidence: 'HIGH' },

    // Marketing (HIGH confidence)
    { pattern: /\b(marketing|publicidad|advertising|google ads|facebook ads|linkedin)\b/i, category: 'Marketing', confidence: 'HIGH' },

    // Workspace (MEDIUM confidence)
    { pattern: /\b(coworking|oficina|office)\b/i, category: 'Workspace', confidence: 'MEDIUM' }
  ],

  detect(name) {
    for (const rule of this.keywords) {
      if (rule.pattern.test(name)) {
        return { suggested: true, category: rule.category, confidence: rule.confidence };
      }
    }
    return { suggested: false, category: null, confidence: null };
  }
});
```

2. Add detection badge CSS:
```css
.detection-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 8px;
  border-radius: var(--radius-sm);
  font-size: 11px;
  font-weight: 600;
}

.detection-badge.suggested {
  background: rgba(74, 222, 128, 0.2);
  color: var(--accent);
  border: 1px solid var(--accent);
}

.detection-badge.medium {
  background: rgba(251, 146, 60, 0.2);
  color: var(--warning);
  border: 1px solid var(--warning);
}
```

3. Modify the add expense form (dialog) to:
   - Add 'input' event listener to expense name field
   - Call detectDeductibleCategory() on input
   - Show/hide detection badge next to percentage field
   - For HIGH confidence: show "100% (suggested)" badge and pre-fill percentage to 100
   - For MEDIUM confidence: show "100%?" badge with warning color, don't pre-fill
   - When user changes from suggested 100% to different value, show subtle confirmation ("Software is typically 100% deductible")

4. Add helper function:
```javascript
function detectDeductibleCategory(name) {
  return DEDUCTIBLE_100_CATEGORIES.detect(name);
}
```

5. The detection should only apply to "Spain Deductible" category expenses (not Work-Travel or Private)

Reference existing expense form code around lines 5618-6278.
  </action>
  <verify>
Open autonomo_dashboard.html in browser, go to Expenses tab:
1. Click add expense button for Spain Deductible
2. Type "Adobe Creative Cloud" - should show "100% (suggested)" badge with green border
3. Percentage field should auto-fill to 100
4. Change percentage to 50% - should show confirmation text about typical 100%
5. Type "coworking space" - should show "100%?" badge with orange/warning color (MEDIUM)
6. Type "groceries" - no badge shown (not detected)
7. Detection only appears for Spain Deductible, not for Work-Travel or Private categories
  </verify>
  <done>
DEDUCTIBLE_100_CATEGORIES constant defined with IT/consulting keyword patterns. Add expense form shows detection badge when expense name matches known categories. HIGH confidence shows green "100% (suggested)" and pre-fills percentage. MEDIUM confidence shows orange "100%?" without pre-fill. Override confirmation shown when changing from suggested 100%.
  </done>
</task>

</tasks>

<verification>
Full verification after both tasks:
1. Calendar tab: Multi-select shows prominent green overlay on all selected days
2. Calendar tab: Selection count badge accurate for all selection methods
3. Expenses tab: Auto-detection works for Spain Deductible expenses
4. Expenses tab: Detection does NOT trigger for Work-Travel or Private categories
5. No console errors
6. Existing functionality preserved (scenarios, calculations, exports)
</verification>

<success_criteria>
- ENH-06 complete: Calendar selection has prominent visual feedback (green overlay, badge)
- ENH-01 complete: Expense auto-detection suggests 100% for matching categories
- Both features integrate cleanly with existing UI patterns
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/08-enhanced-features/08-01-SUMMARY.md`
</output>
