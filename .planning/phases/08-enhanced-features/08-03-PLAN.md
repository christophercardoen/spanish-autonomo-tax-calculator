---
phase: 08-enhanced-features
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - autonomo_dashboard.html
autonomous: false

must_haves:
  truths:
    - "User can click any fiscal citation to verify it at official Spanish government source"
    - "User can see where each tax rate, deduction limit, and treaty provision originates"
    - "User trusts the calculator because every number traces to AEAT/BOE/Seguridad Social"
    - "Details tab shows clickable official AEAT source links with external link icon"
    - "Compliance tab shows clickable official AEAT/BOE source links with external link icon"
    - "All fiscal data citations (IRPF, RETA, dietas, treaty) link to official sources"
    - "Clicking source link opens in new tab to correct government page"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Official source links throughout Details and Compliance tabs"
      contains: "OFFICIAL_SOURCES"
  key_links:
    - from: "renderSourceLink function"
      to: "OFFICIAL_SOURCES constant"
      via: "sourceKey lookup"
      pattern: "OFFICIAL_SOURCES\\[sourceKey\\]"
    - from: "source-link elements"
      to: "external URLs"
      via: "target=_blank rel=noopener"
      pattern: "target=\"_blank\" rel=\"noopener"
---

<objective>
Add official Spanish Agencia Tributaria source links throughout Details and Compliance tabs, making all citations clickable with verified URLs.

Purpose: Enable users to verify fiscal data from official government sources, increasing trust and compliance confidence.
Output: Enhanced autonomo_dashboard.html with comprehensive clickable source links throughout.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-enhanced-features/08-CONTEXT.md
@.planning/phases/08-enhanced-features/08-RESEARCH.md
@.planning/phases/08-enhanced-features/08-01-SUMMARY.md
@.planning/phases/08-enhanced-features/08-02-SUMMARY.md
@autonomo_dashboard.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OFFICIAL_SOURCES constant and helper functions</name>
  <files>autonomo_dashboard.html</files>
  <action>
Create the official sources data structure and rendering functions (ENH-03, ENH-04, ENH-05 foundation):

1. Add OFFICIAL_SOURCES constant near the existing SOURCES constant (around line 3950):
```javascript
const OFFICIAL_SOURCES = Object.freeze({
  // IRPF General
  AEAT_IRPF: {
    name: 'IRPF - Agencia Tributaria',
    url: 'https://sede.agenciatributaria.gob.es/Sede/irpf.html',
    description: 'Main IRPF information page'
  },

  // Autonomo Specific
  AEAT_AUTONOMOS: {
    name: 'Empresarios y Profesionales - AEAT',
    url: 'https://sede.agenciatributaria.gob.es/Sede/empresarios-individuales-profesionales.html',
    description: 'Self-employed taxpayer information'
  },

  // Estimation Methods - Gastos Dificil
  AEAT_ESTIMACION_DIRECTA: {
    name: 'Estimacion Directa Simplificada - AEAT',
    url: 'https://sede.agenciatributaria.gob.es/Sede/irpf/empresarios-individuales-profesionales/regimenes-determinar-rendimiento-actividad/estimacion-directa-simplificada.html',
    description: '5% gastos de dificil justificacion, 2000 EUR limit'
  },

  // Minimo Personal
  AEAT_MINIMO_PERSONAL: {
    name: 'Minimo del Contribuyente - AEAT',
    url: 'https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2024/c14-adecuacion-impuesto-circunstancias-personales/cuadro-resumen-minimo-personal-familiar.html',
    description: '5,550 EUR personal allowance'
  },

  // Minimo Descendientes
  AEAT_MINIMO_DESCENDIENTES: {
    name: 'Minimo por Descendientes - AEAT',
    url: 'https://sede.agenciatributaria.gob.es/Sede/ciudadanos-familias-personas-discapacidad/minimo-personal-familiar/minimo-descendientes.html',
    description: '2,400 EUR for first child'
  },

  // RETA Cotizacion
  RETA_COTIZACION: {
    name: 'Sistema de Cotizacion Autonomos - AEAT',
    url: 'https://sede.agenciatributaria.gob.es/Sede/empresarios-individuales-profesionales/nuevo-sistema-cotizacion-autonomos.html',
    description: 'RETA contribution system since 2023'
  },

  // Seguridad Social RETA
  SS_RETA: {
    name: 'Cotizacion Autonomos - Seg. Social',
    url: 'https://www.seg-social.es/wps/portal/wss/internet/Trabajadores/CotizacionRecaudacionTrabajadores/10721/10724/1320',
    description: 'Official RETA contribution rates'
  },

  // Dietas
  AEAT_DIETAS: {
    name: 'Dietas y Gastos de Viaje - AEAT',
    url: 'https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-ayuda-presentacion/irpf-2023/7-cumplimentacion-irpf/7_1-rendimientos-trabajo-personal/7_1_1-rendimientos-integros/7_1_1_2-dietas-gastos-viaje/asignaciones-gastos-manutencion-estancia.html',
    description: '91.35 EUR/day abroad with overnight'
  },

  // Reglamento IRPF - Dietas Article
  BOE_REGLAMENTO_IRPF: {
    name: 'Reglamento IRPF Art. 9 - BOE',
    url: 'https://www.boe.es/buscar/act.php?id=BOE-A-2007-6820&tn=1&p=20231228#a9',
    description: 'Official dietas limits regulation'
  },

  // Spain-Belgium Treaty
  BOE_TREATY: {
    name: 'Convenio Espana-Belgica - BOE',
    url: 'https://www.boe.es/buscar/act.php?id=BOE-A-2003-13375',
    description: 'Double taxation treaty (BOE-A-2003-13375)'
  },

  // AEAT Treaty Page for Belgium
  AEAT_TREATY_BELGIUM: {
    name: 'CDI Belgica - AEAT',
    url: 'https://sede.agenciatributaria.gob.es/Sede/normativa-criterios-interpretativos/fiscalidad-internacional/convenios-doble-imposicion-firmados-espana/belgica.html',
    description: 'AEAT treaty information page for Belgium'
  },

  // LIRPF - Tax Residence Definition
  BOE_LIRPF: {
    name: 'Ley IRPF Art. 9 - BOE',
    url: 'https://www.boe.es/buscar/act.php?id=BOE-A-2006-20764&p=20240101&tn=1#a9',
    description: 'Tax residence definition (183-day rule, family presumption)'
  },

  // Factura Requirements
  AEAT_FACTURACION: {
    name: 'Obligaciones de Facturacion - AEAT',
    url: 'https://sede.agenciatributaria.gob.es/Sede/empresarios-individuales-profesionales/obligacion-facturacion.html',
    description: 'Invoice requirements for autonomos'
  }
});
```

2. Add helper function to render source links (after OFFICIAL_SOURCES):
```javascript
/**
 * Render external link with icon
 * @param {string} sourceKey - Key from OFFICIAL_SOURCES
 * @returns {string} - HTML anchor element
 */
function renderSourceLink(sourceKey) {
  const s = OFFICIAL_SOURCES[sourceKey];
  if (!s) {
    console.warn('Unknown source key:', sourceKey);
    return '';
  }

  return `<a href="${s.url}" target="_blank" rel="noopener noreferrer"
             class="official-source-link" title="${s.description}">
    ${s.name} <span class="external-link-icon">&#8599;</span>
  </a>`;
}

/**
 * Render inline source citation
 * @param {string} sourceKey - Key from OFFICIAL_SOURCES
 * @param {string} label - Optional custom label
 * @returns {string} - HTML anchor element for inline use
 */
function renderInlineSource(sourceKey, label = null) {
  const s = OFFICIAL_SOURCES[sourceKey];
  if (!s) return '';

  const displayLabel = label || s.name;
  return `<a href="${s.url}" target="_blank" rel="noopener noreferrer"
             class="inline-source-link" title="${s.description}">
    ${displayLabel}<span class="external-link-icon">&#8599;</span>
  </a>`;
}
```

3. Add CSS for source links (add near the existing .source-citation styles around line 434):
```css
/* Official source links */
.official-source-link {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  color: var(--belgium);
  text-decoration: none;
  font-size: var(--size-small);
  padding: 4px 8px;
  border-radius: var(--radius-sm);
  background: rgba(96, 165, 250, 0.1);
  border: 1px solid rgba(96, 165, 250, 0.2);
  transition: all 0.15s ease;
}

.official-source-link:hover {
  background: rgba(96, 165, 250, 0.2);
  border-color: var(--belgium);
}

/* Inline source citation (within text) */
.inline-source-link {
  color: var(--belgium);
  text-decoration: none;
  border-bottom: 1px dotted var(--belgium);
}

.inline-source-link:hover {
  border-bottom-style: solid;
}

/* External link icon */
.external-link-icon {
  font-size: 0.8em;
  opacity: 0.7;
}

.official-source-link:hover .external-link-icon,
.inline-source-link:hover .external-link-icon {
  opacity: 1;
}

/* Sources section in Compliance */
.sources-section {
  margin-top: var(--spacing-lg);
  padding: var(--spacing-md);
  background: var(--bg-surface);
  border-radius: var(--radius-md);
  border: 1px solid rgba(255,255,255,0.06);
}

.sources-section h3 {
  margin: 0 0 var(--spacing-md) 0;
  font-size: 1rem;
  color: var(--text);
}

.sources-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: var(--spacing-sm);
}

.sources-category {
  margin-bottom: var(--spacing-md);
}

.sources-category h4 {
  margin: 0 0 var(--spacing-xs) 0;
  font-size: var(--size-small);
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.sources-category-links {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
}
```

Reference existing SOURCES constant and tooltip patterns for style consistency.
  </action>
  <verify>
Verify in browser console:
1. Type `OFFICIAL_SOURCES` - should show frozen object with all sources
2. Type `renderSourceLink('AEAT_IRPF')` - should return HTML string with link
3. No console errors on page load
  </verify>
  <done>
OFFICIAL_SOURCES constant defined with 13 verified official URLs from AEAT, BOE, and Seguridad Social. renderSourceLink and renderInlineSource helper functions created. CSS styling for source links with external icon, hover effects, and sources grid layout.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add source links to Details and Compliance tabs</name>
  <files>autonomo_dashboard.html</files>
  <action>
Integrate clickable source links throughout Details and Compliance tabs (ENH-03, ENH-04, ENH-05):

**DETAILS TAB INTEGRATION POINTS:**

1. In the Details tab panel (`.panel-details`, lines 3742-3838), add source citation links to the "Advanced Options" details section:
   - After the "RETA (Social Security)" input field (around line 3814), add:
     ```html
     <span class="input-hint">Fixed from registration ${renderInlineSource('SS_RETA', 'RETA rates')}</span>
     ```
   - After the "Minimo Personal" input field (around line 3821), add:
     ```html
     <span class="input-hint">${renderInlineSource('AEAT_MINIMO_PERSONAL', 'AEAT source')}</span>
     ```

2. In the results panel rendered by `recalculateTotals()` (search for "calculator-results"), add source links in the tax breakdown section:
   - Near IRPF brackets display: Add link to AEAT_IRPF
   - Near gastos dificil calculation: Add link to AEAT_ESTIMACION_DIRECTA
   - Look for where the breakdown card renders "Gastos de dificil" or "5% (max 2000)" and add source

**COMPLIANCE TAB INTEGRATION POINTS:**

The Compliance tab is rendered by `renderComplianceContent()` function (line 7736). Update the template literal to include inline sources:

3. **Dietas Limits section** (id="content-dietas", around line 7753):
   - Replace the existing `<cite class="source-citation">${DIETAS_LIMITS.source}</cite>` with:
     ```html
     <cite class="source-citation">${renderInlineSource('AEAT_DIETAS', DIETAS_LIMITS.source)} | ${renderInlineSource('BOE_REGLAMENTO_IRPF', 'Reglamento Art. 9')}</cite>
     ```

4. **Factura Completa section** (id="content-factura", around line 7780):
   - Replace the existing `<cite class="source-citation">${FACTURA_REQUIREMENTS.source}</cite>` with:
     ```html
     <cite class="source-citation">${renderInlineSource('AEAT_FACTURACION', FACTURA_REQUIREMENTS.source)}</cite>
     ```

5. **183-Day Threshold section** (id="content-183", around line 7814):
   - Replace the existing `<cite class="source-citation">LIRPF Art. 9.1.a</cite>` with:
     ```html
     <cite class="source-citation">${renderInlineSource('BOE_LIRPF', 'LIRPF Art. 9.1.a')}</cite>
     ```

6. **Family Presumption section** (id="content-family", around line 7825):
   - Replace the existing `<cite class="source-citation">${ARTICLE_9_1_B.source}</cite>` with:
     ```html
     <cite class="source-citation">${renderInlineSource('BOE_LIRPF', ARTICLE_9_1_B.source)}</cite>
     ```

7. **Treaty Tie-Breaker section** (id="content-tiebreaker", around line 7836):
   - After the tie-breaker steps, add:
     ```html
     <cite class="source-citation">${renderInlineSource('BOE_TREATY', 'BOE-A-2003-13375')} | ${renderInlineSource('AEAT_TREATY_BELGIUM', 'AEAT Belgium CDI')}</cite>
     ```

8. **ADD Official Sources section** at the bottom of the Compliance tab HTML in `renderComplianceContent()`:
   After the closing `</div>` of compliance-columns (around line 7860), add:
   ```html
   <div class="sources-section">
     <h3>Official Sources</h3>
     <p style="color: var(--text-muted); font-size: var(--size-small); margin-bottom: var(--spacing-md);">
       All fiscal data in this calculator is sourced from official Spanish government publications.
       Click any link to verify at the original source.
     </p>

     <div class="sources-grid">
       <div class="sources-category">
         <h4>IRPF / Income Tax</h4>
         <div class="sources-category-links" id="sourcesIRPF"></div>
       </div>

       <div class="sources-category">
         <h4>RETA / Social Security</h4>
         <div class="sources-category-links" id="sourcesRETA"></div>
       </div>

       <div class="sources-category">
         <h4>Treaty & Residency</h4>
         <div class="sources-category-links" id="sourcesTreaty"></div>
       </div>

       <div class="sources-category">
         <h4>Expenses & Documentation</h4>
         <div class="sources-category-links" id="sourcesExpenses"></div>
       </div>
     </div>
   </div>
   ```

9. **Add initialization code** to populate sources section. Add this function and call it in `renderComplianceContent()` after setting innerHTML:
   ```javascript
   function initSourcesSection() {
     // IRPF Sources
     const irpfContainer = document.getElementById('sourcesIRPF');
     if (irpfContainer) {
       irpfContainer.innerHTML = [
         renderSourceLink('AEAT_IRPF'),
         renderSourceLink('AEAT_AUTONOMOS'),
         renderSourceLink('AEAT_MINIMO_PERSONAL'),
         renderSourceLink('AEAT_MINIMO_DESCENDIENTES'),
         renderSourceLink('AEAT_ESTIMACION_DIRECTA')
       ].join('');
     }

     // RETA Sources
     const retaContainer = document.getElementById('sourcesRETA');
     if (retaContainer) {
       retaContainer.innerHTML = [
         renderSourceLink('SS_RETA'),
         renderSourceLink('RETA_COTIZACION')
       ].join('');
     }

     // Treaty Sources
     const treatyContainer = document.getElementById('sourcesTreaty');
     if (treatyContainer) {
       treatyContainer.innerHTML = [
         renderSourceLink('BOE_TREATY'),
         renderSourceLink('AEAT_TREATY_BELGIUM'),
         renderSourceLink('BOE_LIRPF')
       ].join('');
     }

     // Expenses Sources
     const expensesContainer = document.getElementById('sourcesExpenses');
     if (expensesContainer) {
       expensesContainer.innerHTML = [
         renderSourceLink('AEAT_DIETAS'),
         renderSourceLink('BOE_REGLAMENTO_IRPF'),
         renderSourceLink('AEAT_FACTURACION')
       ].join('');
     }
   }
   ```

10. Call `initSourcesSection()` at the end of `renderComplianceContent()` function.

Reference RESEARCH.md for verified URLs. Use existing cite.source-citation patterns for inline integration.
  </action>
  <verify>
Open autonomo_dashboard.html in browser:
1. Go to Details tab - see source links in Advanced Options (RETA, Minimo Personal)
2. Go to Compliance tab - see inline source links in each section:
   - Dietas: link to AEAT_DIETAS and BOE_REGLAMENTO_IRPF
   - Factura: link to AEAT_FACTURACION
   - 183-Day: link to BOE_LIRPF
   - Family: link to BOE_LIRPF
   - Treaty: link to BOE_TREATY and AEAT_TREATY_BELGIUM
3. Scroll to bottom of Compliance - see "Official Sources" section with categorized grid
4. Click any source link - opens in new tab to correct AEAT/BOE page
5. All links show external icon (arrow)
6. Hover effects work on all links
  </verify>
  <done>
Details tab shows clickable source links in Advanced Options for RETA and minimo. Compliance tab sections include inline citations linking to official sources (dietas, factura, 183-day, family, treaty). Dedicated "Official Sources" section at bottom of Compliance with categorized grid of all source links (IRPF, RETA, Treaty, Expenses). All links open in new tab with rel=noopener for security. External link icon visible on all source citations.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Official source links throughout the dashboard:
- OFFICIAL_SOURCES constant with 13 verified government URLs
- Details tab source citations
- Compliance tab inline sources and dedicated sources section
- Clickable links with external icon styling
  </what-built>
  <how-to-verify>
1. Open http://localhost:3013/autonomo_dashboard.html (or file directly)
2. Go to Details tab:
   - Verify source links appear in Advanced Options section
   - Click 1-2 links to confirm they open correct AEAT pages
3. Go to Compliance tab:
   - Check each collapsible section for inline source links
   - Scroll to bottom to see "Official Sources" grid section
   - Click links from different categories to verify destinations:
     - IRPF link -> sede.agenciatributaria.gob.es/Sede/irpf.html
     - Treaty link -> boe.es/buscar/act.php?id=BOE-A-2003-13375
     - Dietas link -> AEAT dietas page
4. Verify all links:
   - Open in new tab (not same window)
   - Show external arrow icon
   - Have hover effects (background/border change)
5. Check no broken links (no 404 pages)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with source links</resume-signal>
</task>

</tasks>

<verification>
Full verification after all tasks:
1. OFFICIAL_SOURCES constant has 13 verified URLs
2. Details tab shows source links for RETA and minimo personal
3. Compliance tab sections have inline source citations
4. Official Sources section at bottom of Compliance with categorized links
5. All links work (no 404s)
6. Links open in new tab with correct destination
7. External icon visible and styled correctly
8. No console errors
9. All existing functionality preserved
</verification>

<success_criteria>
- ENH-03 complete: Official Spanish Agencia Tributaria source links in Details tab
- ENH-04 complete: Official Spanish Agencia Tributaria source links in Compliance tab
- ENH-05 complete: All source citations clickable with URLs
- Links verified to open correct government pages
- Consistent styling with external link icon throughout
- User can trace any fiscal number to its official source
</success_criteria>

<output>
After completion, create `.planning/phases/08-enhanced-features/08-03-SUMMARY.md`
</output>
