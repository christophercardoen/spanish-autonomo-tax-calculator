---
phase: 03-scenario-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - autonomo_dashboard.html
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Five pre-configured scenarios (A-E) appear as horizontal cards on page load"
    - "Cards display key metrics: revenue, expenses, IRPF, RETA, leefgeld"
    - "Cards are sorted by leefgeld (highest first) automatically"
    - "Optimal scenario (first card) shows visual indicator"
    - "Belgium patterns match requirements (A/B use low 1K, C/D/E use high 2.5K)"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "SCENARIO_PRESETS constant, scenario state management, card rendering"
      contains: "SCENARIO_PRESETS"
  key_links:
    - from: "SCENARIO_PRESETS"
      to: "renderScenarioCards()"
      via: "getSortedScenarios() calculates and sorts"
      pattern: "getSortedScenarios"
    - from: "calculateScenarioResults"
      to: "calculateFullIRPFWithFiscal"
      via: "calculateScenarioResults() calls calculateFullIRPFWithFiscal() which is derived from Phase 1's calculateFullIRPF"
      pattern: "calculateFullIRPFWithFiscal"
---

<objective>
Implement scenario data system with pre-configured scenarios (A-E) and horizontal card layout displaying key metrics sorted by leefgeld.

Purpose: Provide the foundation for scenario comparison by establishing data structures, state management, and card visualization that shows users which income scenarios yield the highest leefgeld.

Output: Horizontal scrolling scenario cards with A-E preset scenarios, automatic sorting by leefgeld, and optimal scenario highlighting.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-scenario-engine/03-CONTEXT.md
@.planning/phases/03-scenario-engine/03-RESEARCH.md
@autonomo_dashboard.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SCENARIO_PRESETS constant and state management</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add SCENARIO_PRESETS constant after the DEFAULT_EXPENSES constant. Create scenario state management functions.

**SCENARIO_PRESETS structure (frozen objects):**
```javascript
const SCENARIO_PRESETS = Object.freeze({
  'A': Object.freeze({
    id: 'A',
    name: 'Scenario A',
    isPreset: true,
    monthlyRevenue: 3000,
    monthlyExpenses: 750,
    belgiumPattern: 'low',  // 1000 EUR
    hasDescendant: true,
    fiscalOverrides: null
  }),
  'B': Object.freeze({
    id: 'B',
    name: 'Scenario B',
    isPreset: true,
    monthlyRevenue: 6000,
    monthlyExpenses: 1500,
    belgiumPattern: 'low',
    hasDescendant: true,
    fiscalOverrides: null
  }),
  'C': Object.freeze({
    id: 'C',
    name: 'Scenario C',
    isPreset: true,
    monthlyRevenue: 9000,
    monthlyExpenses: 3000,
    belgiumPattern: 'high',  // 2500 EUR
    hasDescendant: true,
    fiscalOverrides: null
  }),
  'D': Object.freeze({
    id: 'D',
    name: 'Scenario D',
    isPreset: true,
    monthlyRevenue: 12000,
    monthlyExpenses: 5000,
    belgiumPattern: 'high',
    hasDescendant: true,
    fiscalOverrides: null
  }),
  'E': Object.freeze({
    id: 'E',
    name: 'Scenario E',
    isPreset: true,
    monthlyRevenue: 18000,
    monthlyExpenses: 8000,
    belgiumPattern: 'high',
    hasDescendant: true,
    fiscalOverrides: null
  })
});
```

**Add state management (after SCENARIO_PRESETS):**
```javascript
const SCENARIO_STORAGE_KEY = 'autonomo_scenarios_v1';

// Scenario state - initialized on DOMContentLoaded
let scenarioState = null;

function initScenarioState() {
  try {
    const stored = localStorage.getItem(SCENARIO_STORAGE_KEY);
    if (stored) {
      const parsed = JSON.parse(stored);
      if (parsed.version === 1) {
        return parsed;
      }
    }
  } catch (e) {
    console.warn('Failed to load scenarios:', e.message);
  }
  // Return default state with presets
  return {
    version: 1,
    scenarios: structuredClone(SCENARIO_PRESETS),
    selected: [],
    customOrder: []
  };
}

function saveScenarioState() {
  try {
    localStorage.setItem(SCENARIO_STORAGE_KEY, JSON.stringify(scenarioState));
    return true;
  } catch (e) {
    console.warn('Failed to save scenarios:', e.message);
    return false;
  }
}
```

**Add calculateFullIRPFWithFiscal (copy of Phase 1's calculateFullIRPF with fiscal parameter):**

This function is a copy of the existing `calculateFullIRPF` function from Phase 1, but accepts an optional `fiscal` configuration parameter. This allows scenarios to override RETA, minimos, and brackets for what-if analysis while keeping the original function untouched for backward compatibility.

```javascript
function calculateFullIRPFWithFiscal(monthlyRevenue, monthlyDeductibleExpenses = 0, hasDescendant = true, fiscal = null) {
  // Use provided fiscal config or default to FISCAL_2025
  const config = fiscal || FISCAL_2025;

  // Step 1: Annualize inputs
  const annualRevenue = monthlyRevenue * 12;
  const annualExpenses = monthlyDeductibleExpenses * 12;

  // Step 2: Total deductible = expenses + RETA
  const totalDeductible = annualExpenses + config.RETA_ANNUAL;

  // Step 3: Rendimiento Neto Previo (before gastos dificil)
  const rendimientoNetoPrevio = annualRevenue - totalDeductible;

  // Step 4: Gastos dificil justificacion (use FISCAL_2025 rates - these don't change)
  const gastosDificil = calculateGastosDificil(rendimientoNetoPrevio);

  // Step 5: Rendimiento Neto = Base Liquidable (for autonomo)
  const rendimientoNeto = rendimientoNetoPrevio - gastosDificil;
  const baseLiquidable = Math.max(0, rendimientoNeto);

  // Step 6: Calculate minimos (can be overridden)
  const minimoPersonal = config.MINIMO_PERSONAL || FISCAL_2025.MINIMO_PERSONAL;
  const minimoDescendientes = hasDescendant
    ? (config.MINIMO_DESCENDIENTES_PRIMERO || FISCAL_2025.MINIMO_DESCENDIENTES_PRIMERO)
    : 0;
  const minimoTotal = minimoPersonal + minimoDescendientes;

  // Step 7: Cuota Integra using 4-phase method
  const cuotaIntegra = calculateCuotaIntegra(baseLiquidable, minimoTotal);

  // Step 8: Effective tax rate
  const effectiveRate = rendimientoNeto > 0 ? (cuotaIntegra / rendimientoNeto) : 0;

  // Step 9: Net income calculations
  const netAnnual = annualRevenue - totalDeductible - gastosDificil - cuotaIntegra;
  const netMonthly = netAnnual / 12;

  // Step 10: Leefgeld (after private costs)
  const privateCostsMonthly = config.PRIVATE_COSTS_MONTHLY || FISCAL_2025.PRIVATE_COSTS_MONTHLY;
  const leefgeld = netMonthly - privateCostsMonthly;

  // Return all values matching Phase 1's calculateFullIRPF return structure
  return {
    // Inputs
    monthlyRevenue,
    annualRevenue,
    monthlyExpenses: monthlyDeductibleExpenses,
    annualExpenses,

    // Deductions
    retaMonthly: (config.RETA_MONTHLY || FISCAL_2025.RETA_MONTHLY),
    retaAnnual: config.RETA_ANNUAL,
    totalDeductible,

    // Calculation chain
    rendimientoNetoPrevio,
    gastosDificil,
    rendimientoNeto,
    baseLiquidable,

    // Minimos (for display)
    minimoPersonal,
    minimoDescendientes,
    minimoTotal,

    // Tax
    cuotaIntegra,
    effectiveRate,

    // Net income
    netAnnual,
    netMonthly,
    leefgeld,

    // Private costs (for reference)
    privateCostsMonthly
  };
}
```

**Add calculation wrapper that accepts fiscal overrides:**
```javascript
function calculateScenarioResults(scenario) {
  const belgiumCost = scenario.belgiumPattern === 'high' ? 2500 : 1000;
  const totalDeductible = scenario.monthlyExpenses + belgiumCost;

  // Allow fiscal overrides for what-if analysis
  const fiscal = scenario.fiscalOverrides
    ? { ...FISCAL_2025, ...scenario.fiscalOverrides }
    : FISCAL_2025;

  // Call calculateFullIRPFWithFiscal (derived from Phase 1's calculateFullIRPF)
  return calculateFullIRPFWithFiscal(
    scenario.monthlyRevenue,
    totalDeductible,
    scenario.hasDescendant,
    fiscal
  );
}
```

**Add getSortedScenarios:**
```javascript
function getSortedScenarios() {
  const scenarios = Object.values(scenarioState.scenarios);
  return scenarios
    .map(s => ({
      ...s,
      results: calculateScenarioResults(s)
    }))
    .sort((a, b) => b.results.leefgeld - a.results.leefgeld);
}
```
  </action>
  <verify>
1. Browser console: `typeof SCENARIO_PRESETS === 'object'` returns true
2. `Object.keys(SCENARIO_PRESETS).length === 5` returns true
3. After page load, `scenarioState.scenarios.A.monthlyRevenue === 3000` returns true
4. Verify calculateFullIRPFWithFiscal exists: `typeof calculateFullIRPFWithFiscal === 'function'` returns true
5. Verify results object structure: `const r = calculateScenarioResults(scenarioState.scenarios.A); console.log(Object.keys(r));` - should include: annualRevenue, totalDeductible, rendimientoNeto, rendimientoNetoPrevio, gastosDificil, baseLiquidable, minimoTotal, minimoPersonal, minimoDescendientes, cuotaIntegra, effectiveRate, retaAnnual, retaMonthly, netMonthly, netAnnual, leefgeld, privateCostsMonthly
  </verify>
  <done>
SCENARIO_PRESETS constant exists with A-E frozen objects. State management loads/saves to localStorage. calculateFullIRPFWithFiscal() is a copy of Phase 1's calculateFullIRPF with fiscal override support. calculateScenarioResults() calls calculateFullIRPFWithFiscal and returns results with all required properties. getSortedScenarios() returns scenarios sorted by leefgeld descending.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add scenario card CSS and HTML structure</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add CSS for horizontal scrolling scenario cards and optimal indicator.

**Add to style section:**
```css
/* Scenario Cards Section */
.scenario-section {
  margin-top: 2rem;
}

.scenario-cards {
  display: flex;
  gap: 1rem;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  scroll-padding: 1rem;
  padding: 1rem 0;
  -webkit-overflow-scrolling: touch;
}

.scenario-card {
  flex: 0 0 280px;
  scroll-snap-align: start;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px;
  padding: 1rem;
  transition: transform 0.2s, box-shadow 0.2s;
}

.scenario-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

/* Optimal scenario indicator */
.scenario-card.optimal {
  background: rgba(74, 222, 128, 0.08);
  border-color: rgba(74, 222, 128, 0.3);
}

/* Custom scenario visual distinction */
.scenario-card.custom {
  border-left: 3px solid #60a5fa;
}

/* Selected scenario */
.scenario-card.selected {
  border: 2px solid var(--accent);
}

.card-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.card-header input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: var(--accent);
}

.card-header h3 {
  margin: 0;
  font-size: 1.1rem;
  flex: 1;
}

.optimal-badge {
  background: var(--accent);
  color: var(--bg);
  font-size: 0.7rem;
  padding: 0.2rem 0.5rem;
  border-radius: 4px;
  font-weight: 600;
}

.card-metrics {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.metric {
  display: flex;
  justify-content: space-between;
  font-size: 0.9rem;
}

.metric .label {
  opacity: 0.7;
}

.metric .value {
  font-family: 'JetBrains Mono', monospace;
}

.metric.highlight .value {
  color: var(--accent);
  font-weight: 600;
}

.edit-btn {
  margin-top: 1rem;
  width: 100%;
  padding: 0.5rem;
  background: transparent;
  border: 1px solid rgba(255,255,255,0.2);
  color: var(--text);
  border-radius: 4px;
  cursor: pointer;
  transition: border-color 0.2s, color 0.2s;
}

.edit-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
}

/* Scrollbar styling */
.scenario-cards::-webkit-scrollbar {
  height: 8px;
}

.scenario-cards::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.05);
  border-radius: 4px;
}

.scenario-cards::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.2);
  border-radius: 4px;
}
```

**Add HTML container (after expenses-container div, before results div):**
```html
<div class="scenario-section">
  <h2>Scenario Comparison</h2>
  <div id="scenarioCards" class="scenario-cards">
    <!-- Populated by renderScenarioCards() -->
  </div>
  <div id="comparisonTable">
    <!-- Populated by renderComparisonTable() in Plan 03 -->
  </div>
</div>
```
  </action>
  <verify>
Open browser DevTools Elements tab. The `.scenario-section` container exists. CSS rules for `.scenario-card`, `.optimal`, `.card-metrics` are defined.
  </verify>
  <done>
CSS for horizontal scrolling cards with snap, optimal indicator, and metric display. HTML container exists for scenario cards section.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement renderScenarioCards and integrate with page initialization</name>
  <files>autonomo_dashboard.html</files>
  <action>
Create renderScenarioCards() function and call it on DOMContentLoaded.

**Add renderScenarioCards function:**
```javascript
function renderScenarioCards() {
  const container = document.getElementById('scenarioCards');
  if (!container) return;

  const sorted = getSortedScenarios();

  container.innerHTML = sorted.map((scenario, index) => {
    const isOptimal = index === 0;
    const isSelected = scenarioState.selected.includes(scenario.id);
    const isCustom = !scenario.isPreset;
    const belgiumCost = scenario.belgiumPattern === 'high' ? 2500 : 1000;
    const totalExpenses = scenario.monthlyExpenses + belgiumCost;

    const classes = [
      'scenario-card',
      isOptimal ? 'optimal' : '',
      isSelected ? 'selected' : '',
      isCustom ? 'custom' : ''
    ].filter(Boolean).join(' ');

    return `
      <div class="${classes}" data-id="${scenario.id}">
        <div class="card-header">
          <input type="checkbox"
                 ${isSelected ? 'checked' : ''}
                 onchange="toggleScenarioSelection('${scenario.id}')"
                 aria-label="Select ${scenario.name} for comparison">
          <h3>${scenario.name}</h3>
          ${isOptimal ? '<span class="optimal-badge">Highest Leefgeld</span>' : ''}
        </div>

        <div class="card-metrics">
          <div class="metric">
            <span class="label">Revenue</span>
            <span class="value">${formatEUR(scenario.monthlyRevenue)}/mo</span>
          </div>
          <div class="metric">
            <span class="label">Expenses</span>
            <span class="value">${formatEUR(totalExpenses)}/mo</span>
          </div>
          <div class="metric">
            <span class="label">IRPF</span>
            <span class="value">${formatEUR(scenario.results.cuotaIntegra / 12)}/mo</span>
          </div>
          <div class="metric">
            <span class="label">RETA</span>
            <span class="value">${formatEUR(scenario.results.retaMonthly)}/mo</span>
          </div>
          <div class="metric highlight">
            <span class="label">Leefgeld</span>
            <span class="value">${formatEUR(scenario.results.leefgeld)}/mo</span>
          </div>
        </div>

        <button class="edit-btn" onclick="openEditModal('${scenario.id}')">
          Edit
        </button>
      </div>
    `;
  }).join('');
}
```

**Add placeholder functions (will be implemented in later plans):**
```javascript
function toggleScenarioSelection(scenarioId) {
  const idx = scenarioState.selected.indexOf(scenarioId);
  if (idx === -1) {
    scenarioState.selected.push(scenarioId);
  } else {
    scenarioState.selected.splice(idx, 1);
  }
  saveScenarioState();
  renderScenarioCards();
  // renderComparisonTable() - Plan 03
}

function openEditModal(scenarioId) {
  // Implemented in Plan 02
  console.log('Edit modal not yet implemented:', scenarioId);
}
```

**Update DOMContentLoaded handler:**
```javascript
document.addEventListener('DOMContentLoaded', () => {
  // Initialize scenario state
  scenarioState = initScenarioState();

  // Existing Phase 2 initialization
  renderAllSections();
  recalculateTotals();

  // Phase 3 initialization
  renderScenarioCards();
});
```
  </action>
  <verify>
Open the dashboard in browser. Five scenario cards (A-E) appear in horizontal scroll container. First card (highest leefgeld) shows "Highest Leefgeld" badge. Cards display Revenue, Expenses, IRPF, RETA, and Leefgeld metrics. Clicking a checkbox toggles selection (card border changes). Console shows "Edit modal not yet implemented" when clicking Edit button.
  </verify>
  <done>
Five pre-configured scenarios render as horizontal cards. Cards sorted by leefgeld (highest first). Optimal scenario shows badge. Selection toggles work and persist. Edit button placeholder ready for Plan 02.
  </done>
</task>

</tasks>

<verification>
1. Open autonomo_dashboard.html in browser
2. Verify scenario cards section appears below expense tracking
3. Verify 5 cards (A-E) are visible in horizontal scroll container
4. Verify first card has "Highest Leefgeld" badge (should be E with 18K revenue)
5. Verify card order matches leefgeld descending (E, D, C, B, A approximately)
6. Verify clicking checkbox adds green border (selected state)
7. Verify selection persists after page refresh (localStorage)
8. Verify Belgium patterns: A/B show lower expenses than C/D/E
</verification>

<success_criteria>
- SCENARIO_PRESETS constant exists with 5 frozen scenario objects
- Scenario state initializes from localStorage or defaults
- calculateFullIRPFWithFiscal function exists and returns all required properties
- calculateScenarioResults returns object with: annualRevenue, totalDeductible, rendimientoNeto, rendimientoNetoPrevio, gastosDificil, baseLiquidable, minimoTotal, minimoPersonal, minimoDescendientes, cuotaIntegra, effectiveRate, retaAnnual, retaMonthly, netMonthly, netAnnual, leefgeld, privateCostsMonthly
- Cards render in horizontal scrolling container
- Cards sorted by leefgeld (highest first)
- Optimal scenario has visual indicator and badge
- Selection checkbox toggles work and persist
- All requirements SCEN-01, SCEN-02, SCEN-07 foundations in place
</success_criteria>

<output>
After completion, create `.planning/phases/03-scenario-engine/03-01-SUMMARY.md`
</output>
