---
phase: 03-scenario-engine
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - autonomo_dashboard.html
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can click Edit on any scenario card and a modal opens"
    - "User sees calculation results update instantly while typing in any input field"
    - "User can modify scenario values and see impact before committing"
    - "User can save changes which updates the card display"
    - "User can cancel (Escape or Cancel button) without saving"
    - "User can enable fiscal overrides (RETA, minimos) for what-if analysis"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Native HTML dialog element with edit form and live results"
      contains: "editScenarioDialog"
  key_links:
    - from: "openEditModal"
      to: "dialog.showModal()"
      via: "populateEditForm then showModal"
      pattern: "showModal"
    - from: "input events"
      to: "updateLiveResults"
      via: "requestAnimationFrame debounced onScenarioInputChange"
      pattern: "requestAnimationFrame"
---

<objective>
Implement edit modal dialog with inputs and live results preview that updates instantly as user types.

Purpose: Enable users to modify any scenario value and immediately see the impact on all calculated results. Supports what-if analysis with fiscal overrides (RETA, minimos).

Output: Native HTML `<dialog>` modal that opens on Edit button click, shows editable inputs with live calculation preview, and saves changes on submit.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-scenario-engine/03-CONTEXT.md
@.planning/phases/03-scenario-engine/03-RESEARCH.md
@.planning/phases/03-scenario-engine/03-01-SUMMARY.md
@autonomo_dashboard.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dialog CSS and HTML structure</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add CSS for the native dialog element and split-view layout.

**Add to style section:**
```css
/* Edit Modal Dialog */
dialog {
  background: var(--bg);
  color: var(--text);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px;
  padding: 0;
  max-width: 900px;
  width: 90vw;
  max-height: 90vh;
}

dialog::backdrop {
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(4px);
}

.dialog-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.dialog-header h2 {
  margin: 0;
  color: var(--accent);
}

.dialog-close {
  background: transparent;
  border: none;
  color: var(--text);
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0.25rem 0.5rem;
  opacity: 0.7;
}

.dialog-close:hover {
  opacity: 1;
}

.dialog-body {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;
  padding: 1.5rem;
  max-height: 60vh;
  overflow-y: auto;
}

.input-pane, .results-pane {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.input-pane h3, .results-pane h3 {
  margin: 0 0 0.5rem 0;
  font-size: 1rem;
  opacity: 0.8;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  padding-bottom: 0.5rem;
}

.results-pane {
  background: rgba(255,255,255,0.03);
  padding: 1rem;
  border-radius: 8px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.form-group label {
  font-size: 0.9rem;
  opacity: 0.8;
}

.form-group input,
.form-group select {
  padding: 0.5rem;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 4px;
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: var(--accent);
}

.checkbox-group {
  flex-direction: row;
  align-items: center;
}

.checkbox-group input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: var(--accent);
}

.fiscal-overrides {
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid rgba(255,255,255,0.1);
}

.fiscal-overrides summary {
  cursor: pointer;
  font-size: 0.9rem;
  opacity: 0.8;
}

.fiscal-overrides[open] summary {
  margin-bottom: 1rem;
}

/* Live results display */
.live-result-row {
  display: flex;
  justify-content: space-between;
  padding: 0.4rem 0;
  font-size: 0.9rem;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.live-result-row:last-child {
  border-bottom: none;
}

.live-result-row .label {
  opacity: 0.7;
}

.live-result-row .value {
  font-family: 'JetBrains Mono', monospace;
}

.live-result-row.highlight {
  padding: 0.6rem 0;
  margin-top: 0.5rem;
  border-top: 1px solid rgba(255,255,255,0.1);
}

.live-result-row.highlight .value {
  color: var(--accent);
  font-weight: 600;
  font-size: 1rem;
}

.dialog-footer {
  display: flex;
  gap: 1rem;
  padding: 1rem 1.5rem;
  border-top: 1px solid rgba(255,255,255,0.1);
}

.dialog-footer .spacer {
  flex: 1;
}

.dialog-footer button {
  padding: 0.5rem 1rem;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9rem;
}

.primary-btn {
  background: var(--accent);
  color: var(--bg);
  border: none;
  font-weight: 600;
}

.primary-btn:hover {
  opacity: 0.9;
}

.secondary-btn {
  background: transparent;
  border: 1px solid rgba(255,255,255,0.2);
  color: var(--text);
}

.secondary-btn:hover {
  border-color: rgba(255,255,255,0.4);
}

.danger-btn {
  background: transparent;
  border: 1px solid #f87171;
  color: #f87171;
}

.danger-btn:hover {
  background: #f87171;
  color: var(--bg);
}

/* Responsive: stack on mobile */
@media (max-width: 700px) {
  .dialog-body {
    grid-template-columns: 1fr;
  }
}
```

**Add dialog HTML (at end of container div, before results div):**
```html
<dialog id="editScenarioDialog" aria-labelledby="dialogTitle">
  <form method="dialog" class="edit-form">
    <header class="dialog-header">
      <h2 id="dialogTitle">Edit Scenario</h2>
      <button type="button" class="dialog-close" aria-label="Close" onclick="closeEditModal()">x</button>
    </header>

    <div class="dialog-body">
      <!-- Input pane (left) -->
      <div class="input-pane">
        <div class="form-group">
          <label for="editScenarioName">Scenario Name</label>
          <input type="text" id="editScenarioName" required autofocus>
        </div>

        <h3>Income & Expenses</h3>
        <div class="form-group">
          <label for="editMonthlyRevenue">Monthly Revenue (EUR)</label>
          <input type="number" id="editMonthlyRevenue" min="0" step="100">
        </div>
        <div class="form-group">
          <label for="editMonthlyExpenses">Monthly Expenses (EUR)</label>
          <input type="number" id="editMonthlyExpenses" min="0" step="100">
        </div>
        <div class="form-group">
          <label for="editBelgiumPattern">Belgium Work Pattern</label>
          <select id="editBelgiumPattern">
            <option value="low">Low (1,000 EUR/month)</option>
            <option value="high">High (2,500 EUR/month)</option>
          </select>
        </div>
        <div class="form-group checkbox-group">
          <input type="checkbox" id="editHasDescendant">
          <label for="editHasDescendant">1 Dependent Child (adds 2,400 EUR minimo)</label>
        </div>

        <details class="fiscal-overrides">
          <summary>Fiscal Overrides (What-If Analysis)</summary>
          <div class="form-group">
            <label for="editRetaOverride">RETA Monthly (EUR)</label>
            <input type="number" id="editRetaOverride" placeholder="428.40" min="0" step="0.01">
          </div>
          <div class="form-group">
            <label for="editMinimoPersonalOverride">Minimo Personal (EUR)</label>
            <input type="number" id="editMinimoPersonalOverride" placeholder="5550" min="0" step="1">
          </div>
          <div class="form-group">
            <label for="editMinimoDescOverride">Minimo Descendientes (EUR)</label>
            <input type="number" id="editMinimoDescOverride" placeholder="2400" min="0" step="1">
          </div>
        </details>
      </div>

      <!-- Results pane (right) - live updating -->
      <div class="results-pane">
        <h3>Calculated Results</h3>
        <div id="liveEditResults">
          <!-- Populated by updateLiveResults() -->
        </div>
      </div>
    </div>

    <footer class="dialog-footer">
      <button type="button" id="deleteScenarioBtn" class="danger-btn" onclick="confirmDeleteScenario()">Delete</button>
      <div class="spacer"></div>
      <button type="button" class="secondary-btn" onclick="closeEditModal()">Cancel</button>
      <button type="submit" value="save" class="primary-btn">Save Changes</button>
    </footer>
  </form>
</dialog>
```
  </action>
  <verify>
Browser DevTools: `document.getElementById('editScenarioDialog')` returns a dialog element. CSS rules for `dialog`, `.dialog-body`, `.input-pane`, `.results-pane` are defined.
  </verify>
  <done>
Native HTML dialog element exists with proper structure. CSS provides dark theme styling, split-view layout, and form styling consistent with dashboard aesthetic.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement modal open/close and form population</name>
  <files>autonomo_dashboard.html</files>
  <action>
Replace the placeholder openEditModal and add supporting functions.

**Add modal state variable:**
```javascript
let currentEditScenarioId = null;
```

**Replace openEditModal function:**
```javascript
function openEditModal(scenarioId) {
  const scenario = scenarioState.scenarios[scenarioId];
  if (!scenario) return;

  currentEditScenarioId = scenarioId;
  const dialog = document.getElementById('editScenarioDialog');

  // Populate form fields
  document.getElementById('editScenarioName').value = scenario.name;
  document.getElementById('editMonthlyRevenue').value = scenario.monthlyRevenue;
  document.getElementById('editMonthlyExpenses').value = scenario.monthlyExpenses;
  document.getElementById('editBelgiumPattern').value = scenario.belgiumPattern;
  document.getElementById('editHasDescendant').checked = scenario.hasDescendant;

  // Populate fiscal overrides (empty means use default)
  const overrides = scenario.fiscalOverrides || {};
  document.getElementById('editRetaOverride').value = overrides.RETA_MONTHLY || '';
  document.getElementById('editMinimoPersonalOverride').value = overrides.MINIMO_PERSONAL || '';
  document.getElementById('editMinimoDescOverride').value = overrides.MINIMO_DESCENDIENTES_PRIMERO || '';

  // Show/hide delete button based on preset status
  const deleteBtn = document.getElementById('deleteScenarioBtn');
  deleteBtn.style.display = scenario.isPreset ? 'none' : 'block';

  // Update dialog title
  document.getElementById('dialogTitle').textContent = `Edit ${scenario.name}`;

  // Calculate and show initial results
  updateLiveResults();

  // Open modal
  dialog.showModal();
}

function closeEditModal() {
  const dialog = document.getElementById('editScenarioDialog');
  dialog.close();
  currentEditScenarioId = null;
}
```

**Add dialog event handlers:**
```javascript
function initEditDialog() {
  const dialog = document.getElementById('editScenarioDialog');
  if (!dialog) return;

  // Handle form submit (Save button)
  dialog.addEventListener('close', () => {
    if (dialog.returnValue === 'save') {
      saveScenarioChanges();
    }
  });

  // Prevent Esc from saving (cancel event)
  dialog.addEventListener('cancel', (e) => {
    // Default behavior is fine - just closes without saving
  });

  // Attach input change handlers for live recalculation
  const inputs = dialog.querySelectorAll('input, select');
  inputs.forEach(input => {
    input.addEventListener('input', onScenarioInputChange);
    input.addEventListener('change', onScenarioInputChange); // For checkboxes and selects
  });
}
```

**Add to DOMContentLoaded:**
```javascript
// Add after existing initialization:
initEditDialog();
```
  </action>
  <verify>
Click Edit button on any scenario card. Modal opens with form populated with scenario values. Clicking X or Cancel closes modal. Pressing Escape closes modal. Dialog title shows scenario name.
  </verify>
  <done>
Modal opens with showModal() (proper focus trap, backdrop). Form populates from scenario data. Delete button hidden for preset scenarios. Close handlers work correctly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement live recalculation and save functionality</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add requestAnimationFrame-debounced live recalculation and save logic.

**Add debounced recalculation:**
```javascript
let liveCalcRafId = null;

function onScenarioInputChange() {
  // Cancel any pending recalculation
  if (liveCalcRafId) {
    cancelAnimationFrame(liveCalcRafId);
  }

  // Schedule recalculation for next frame
  liveCalcRafId = requestAnimationFrame(() => {
    updateLiveResults();
    liveCalcRafId = null;
  });
}

function getEditFormValues() {
  const monthlyRevenue = parseFloat(document.getElementById('editMonthlyRevenue').value) || 0;
  const monthlyExpenses = parseFloat(document.getElementById('editMonthlyExpenses').value) || 0;
  const belgiumPattern = document.getElementById('editBelgiumPattern').value;
  const hasDescendant = document.getElementById('editHasDescendant').checked;

  // Fiscal overrides (empty string = use default)
  const retaOverride = document.getElementById('editRetaOverride').value;
  const minimoPersonalOverride = document.getElementById('editMinimoPersonalOverride').value;
  const minimoDescOverride = document.getElementById('editMinimoDescOverride').value;

  let fiscalOverrides = null;
  if (retaOverride || minimoPersonalOverride || minimoDescOverride) {
    fiscalOverrides = {};
    if (retaOverride) {
      fiscalOverrides.RETA_MONTHLY = parseFloat(retaOverride);
      fiscalOverrides.RETA_ANNUAL = parseFloat(retaOverride) * 12;
    }
    if (minimoPersonalOverride) {
      fiscalOverrides.MINIMO_PERSONAL = parseFloat(minimoPersonalOverride);
    }
    if (minimoDescOverride) {
      fiscalOverrides.MINIMO_DESCENDIENTES_PRIMERO = parseFloat(minimoDescOverride);
    }
  }

  return {
    name: document.getElementById('editScenarioName').value.trim(),
    monthlyRevenue,
    monthlyExpenses,
    belgiumPattern,
    hasDescendant,
    fiscalOverrides
  };
}

function updateLiveResults() {
  const values = getEditFormValues();
  const results = calculateScenarioResults(values);

  // Verify results object has all expected properties (defensive programming)
  // These properties are guaranteed by calculateFullIRPFWithFiscal in Plan 03-01
  const requiredProps = [
    'annualRevenue', 'totalDeductible', 'rendimientoNeto', 'gastosDificil',
    'baseLiquidable', 'minimoTotal', 'cuotaIntegra', 'effectiveRate',
    'retaAnnual', 'netMonthly', 'leefgeld'
  ];
  for (const prop of requiredProps) {
    if (results[prop] === undefined) {
      console.error(`updateLiveResults: missing property '${prop}' in results object`);
    }
  }

  const container = document.getElementById('liveEditResults');
  container.innerHTML = `
    <div class="live-result-row">
      <span class="label">Annual Revenue</span>
      <span class="value">${formatEUR(results.annualRevenue)}</span>
    </div>
    <div class="live-result-row">
      <span class="label">Total Deductible</span>
      <span class="value">${formatEUR(results.totalDeductible)}</span>
    </div>
    <div class="live-result-row">
      <span class="label">Rendimiento Neto</span>
      <span class="value">${formatEUR(results.rendimientoNeto)}</span>
    </div>
    <div class="live-result-row">
      <span class="label">Gastos Dificil (5%)</span>
      <span class="value">${formatEUR(results.gastosDificil)}</span>
    </div>
    <div class="live-result-row">
      <span class="label">Base Liquidable</span>
      <span class="value">${formatEUR(results.baseLiquidable)}</span>
    </div>
    <div class="live-result-row">
      <span class="label">Total Minimos</span>
      <span class="value">${formatEUR(results.minimoTotal)}</span>
    </div>
    <div class="live-result-row">
      <span class="label">Cuota Integra (IRPF)</span>
      <span class="value">${formatEUR(results.cuotaIntegra)}</span>
    </div>
    <div class="live-result-row">
      <span class="label">Effective Tax Rate</span>
      <span class="value">${formatPercent(results.effectiveRate)}</span>
    </div>
    <div class="live-result-row">
      <span class="label">RETA Annual</span>
      <span class="value">${formatEUR(results.retaAnnual)}</span>
    </div>
    <div class="live-result-row">
      <span class="label">Net Monthly</span>
      <span class="value">${formatEUR(results.netMonthly)}</span>
    </div>
    <div class="live-result-row highlight">
      <span class="label">Leefgeld</span>
      <span class="value">${formatEUR(results.leefgeld)}/mo</span>
    </div>
  `;
}
```

**Add save function:**
```javascript
function saveScenarioChanges() {
  if (!currentEditScenarioId) return;

  const values = getEditFormValues();

  // Validate name
  if (!values.name) {
    alert('Please enter a scenario name');
    return;
  }

  const scenario = scenarioState.scenarios[currentEditScenarioId];
  if (!scenario) return;

  // Update scenario (keep id and isPreset)
  Object.assign(scenario, {
    name: values.name,
    monthlyRevenue: values.monthlyRevenue,
    monthlyExpenses: values.monthlyExpenses,
    belgiumPattern: values.belgiumPattern,
    hasDescendant: values.hasDescendant,
    fiscalOverrides: values.fiscalOverrides
  });

  saveScenarioState();
  renderScenarioCards();
  // renderComparisonTable() - Plan 03
}
```

**Add delete function:**
```javascript
function confirmDeleteScenario() {
  if (!currentEditScenarioId) return;

  const scenario = scenarioState.scenarios[currentEditScenarioId];
  if (!scenario) return;

  if (scenario.isPreset) {
    alert('Cannot delete preset scenarios (A-E). You can only delete custom scenarios.');
    return;
  }

  if (confirm(`Delete "${scenario.name}"? This cannot be undone.`)) {
    delete scenarioState.scenarios[currentEditScenarioId];
    scenarioState.customOrder = scenarioState.customOrder.filter(id => id !== currentEditScenarioId);
    scenarioState.selected = scenarioState.selected.filter(id => id !== currentEditScenarioId);
    saveScenarioState();
    closeEditModal();
    renderScenarioCards();
    // renderComparisonTable() - Plan 03
  }
}
```
  </action>
  <verify>
1. Click Edit on Scenario C
2. Change Monthly Revenue from 9000 to 10000
3. Verify results pane updates IMMEDIATELY (no button click needed)
4. Verify Leefgeld value increases
5. Click Save Changes
6. Verify card updates with new values
7. Verify card may have moved position (re-sorted by leefgeld)
8. Refresh page - verify changes persist
9. Edit a preset scenario, change name and save - verify name persists
10. Edit again, expand "Fiscal Overrides", enter 500 for RETA Monthly, verify results update instantly with lower tax
11. Open browser console - verify NO errors about missing properties on results object
  </verify>
  <done>
Live recalculation works on every keystroke with requestAnimationFrame debounce. Results pane shows full calculation breakdown. updateLiveResults verifies all 11 required properties exist on results object. Save updates scenario and re-renders cards. Delete works for custom scenarios. Fiscal overrides enable what-if analysis.
  </done>
</task>

</tasks>

<verification>
1. Open autonomo_dashboard.html in browser
2. Click Edit on any scenario card - modal opens
3. Verify form is populated with scenario data
4. Verify results pane shows calculated values
5. Type new value in Monthly Revenue - results update instantly
6. Toggle Belgium pattern dropdown - results update
7. Uncheck dependent child - minimos change in results
8. Expand Fiscal Overrides, enter 500 for RETA - verify RETA Annual changes
9. Click Save Changes - modal closes, card updates
10. Click Edit on preset (A), verify Delete button is hidden
11. Press Escape in modal - closes without saving
12. Click X button - closes without saving
13. Check browser console for any property access errors - should be clean
</verification>

<success_criteria>
- Native `<dialog>` opens with showModal() (focus trap, backdrop, Esc handling)
- Form populates from scenario data
- Live results update on every input change (debounced with requestAnimationFrame)
- Results show full calculation breakdown (11 properties verified)
- All properties used by updateLiveResults exist on results object from calculateScenarioResults
- Fiscal overrides allow what-if analysis
- Save persists changes to state and localStorage
- Delete available only for custom scenarios
- Requirement SCEN-04 fully satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/03-scenario-engine/03-02-SUMMARY.md`
</output>
