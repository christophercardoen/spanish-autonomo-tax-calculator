---
phase: 03-scenario-engine
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - autonomo_dashboard.html
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Comparison table appears when at least one scenario is selected"
    - "Table shows full calculation breakdown (every step from gross to leefgeld)"
    - "Table header row stays visible when scrolling vertically (sticky)"
    - "Selecting/deselecting scenarios immediately updates table columns"
    - "Optimal values in table are highlighted (highest leefgeld, lowest tax rate)"
    - "+ New button creates custom scenario from template"
    - "Custom scenarios are named by user and persist across sessions"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Comparison table rendering, custom scenario creation"
      contains: "renderComparisonTable"
  key_links:
    - from: "toggleScenarioSelection"
      to: "renderComparisonTable"
      via: "selection change triggers table re-render"
      pattern: "renderComparisonTable"
    - from: "+ New button"
      to: "createCustomScenario"
      via: "prompt for template and name"
      pattern: "createCustomScenario"
---

<objective>
Implement side-by-side comparison table with sticky header and custom scenario creation with template selection.

Purpose: Enable users to compare selected scenarios in detailed tabular format showing every calculation step. Custom scenarios allow personalized what-if planning.

Output: Comparison table that shows selected scenarios with full breakdown, sticky header row, optimal value highlighting. "+ New" button creates custom scenarios from templates.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-scenario-engine/03-CONTEXT.md
@.planning/phases/03-scenario-engine/03-RESEARCH.md
@.planning/phases/03-scenario-engine/03-01-SUMMARY.md
@.planning/phases/03-scenario-engine/03-02-SUMMARY.md
@autonomo_dashboard.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add comparison table CSS and HTML container</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add CSS for comparison table with sticky header row.

**Add to style section:**
```css
/* Comparison Table */
.comparison-container {
  margin-top: 2rem;
  max-height: 500px;
  overflow-y: auto;
  background: rgba(255,255,255,0.02);
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.1);
}

.comparison-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.9rem;
}

.comparison-table thead th {
  position: sticky;
  top: 0;
  background: var(--bg);
  z-index: 10;
  border-bottom: 2px solid var(--accent);
  padding: 0.75rem 1rem;
  text-align: right;
  font-weight: 600;
}

.comparison-table thead th:first-child {
  text-align: left;
}

.comparison-table tbody td {
  padding: 0.5rem 1rem;
  text-align: right;
  font-family: 'JetBrains Mono', monospace;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.comparison-table tbody td:first-child {
  text-align: left;
  font-family: inherit;
  opacity: 0.8;
}

/* Divider row */
.comparison-table tr.divider td {
  padding: 0.25rem 0;
  border-bottom: 1px solid rgba(255,255,255,0.15);
}

/* Highlight row (leefgeld) */
.comparison-table tr.highlight-row td {
  padding: 0.75rem 1rem;
  border-top: 1px solid rgba(255,255,255,0.1);
  font-weight: 600;
}

/* Optimal value cell */
.comparison-table td.optimal {
  color: var(--accent);
  font-weight: 700;
}

/* Empty state */
.comparison-empty {
  text-align: center;
  padding: 2rem;
  opacity: 0.6;
}

.comparison-empty p {
  margin: 0;
}

/* New Scenario Button */
.new-scenario-btn {
  background: transparent;
  border: 2px dashed rgba(255,255,255,0.2);
  color: var(--text);
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1rem;
  margin-left: 1rem;
  flex-shrink: 0;
  transition: border-color 0.2s, color 0.2s;
}

.new-scenario-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
}

/* Template Selection Dialog */
#templateSelectDialog {
  max-width: 400px;
}

.template-options {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  margin: 1rem 0;
}

.template-option {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 4px;
  cursor: pointer;
  transition: border-color 0.2s;
}

.template-option:hover {
  border-color: var(--accent);
}

.template-option input[type="radio"] {
  accent-color: var(--accent);
}

.template-option .template-info {
  flex: 1;
}

.template-option .template-name {
  font-weight: 600;
}

.template-option .template-desc {
  font-size: 0.85rem;
  opacity: 0.7;
}
```

**Update scenario section HTML to include + New button alongside cards:**
The + New button should appear after the scenario cards (inside the scroll container for visual continuity, but fixed-position-like at the end).

Find the `<div id="scenarioCards" class="scenario-cards">` and ensure the "+ New" button is rendered inside renderScenarioCards (see Task 2).
  </action>
  <verify>
CSS rules exist for `.comparison-container`, `.comparison-table`, sticky `thead th`, `.optimal`, `.new-scenario-btn`, and `#templateSelectDialog`.
  </verify>
  <done>
CSS for comparison table with sticky header. CSS for template selection dialog. CSS for "+ New" button.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement renderComparisonTable function with property verification</name>
  <files>autonomo_dashboard.html</files>
  <action>
Create the comparison table rendering function and update toggleScenarioSelection to call it.

**IMPORTANT: Results Object Property Contract**

The comparison table uses properties from the results object returned by `calculateScenarioResults()` (which calls `calculateFullIRPFWithFiscal()` from Plan 03-01). The following properties are required:

**From calculateFullIRPFWithFiscal (Plan 03-01):**
- `annualRevenue` - Annual revenue (monthlyRevenue * 12)
- `annualExpenses` - Annual expenses (monthlyDeductible * 12)
- `retaMonthly` - RETA monthly amount
- `retaAnnual` - RETA annual amount
- `totalDeductible` - Total deductible (annualExpenses + retaAnnual)
- `rendimientoNetoPrevio` - Net income before gastos dificil
- `gastosDificil` - Gastos dificil justificacion (5% with cap)
- `rendimientoNeto` - Net income after gastos dificil
- `baseLiquidable` - Tax base (same as rendimientoNeto for autonomo)
- `minimoPersonal` - Personal minimum
- `minimoDescendientes` - Dependents minimum
- `minimoTotal` - Total minimums
- `cuotaIntegra` - IRPF tax amount
- `effectiveRate` - Effective tax rate
- `netAnnual` - Net annual income
- `netMonthly` - Net monthly income
- `leefgeld` - Disposable income after private costs
- `privateCostsMonthly` - Monthly private costs

**Add renderComparisonTable function:**
```javascript
function renderComparisonTable() {
  const container = document.getElementById('comparisonTable');
  if (!container) return;

  const selectedIds = scenarioState.selected;

  // Empty state
  if (selectedIds.length === 0) {
    container.innerHTML = `
      <div class="comparison-empty">
        <p>Select scenarios using checkboxes to compare them side-by-side</p>
      </div>
    `;
    return;
  }

  // Get selected scenarios with results
  const scenarios = selectedIds
    .map(id => scenarioState.scenarios[id])
    .filter(Boolean)
    .map(s => ({
      ...s,
      results: calculateScenarioResults(s)
    }));

  // Verify all required properties exist on first results object (defensive check)
  if (scenarios.length > 0) {
    const requiredProps = [
      'annualRevenue', 'annualExpenses', 'retaAnnual', 'totalDeductible',
      'rendimientoNetoPrevio', 'gastosDificil', 'baseLiquidable',
      'minimoPersonal', 'minimoDescendientes', 'minimoTotal',
      'cuotaIntegra', 'effectiveRate', 'netAnnual', 'netMonthly',
      'leefgeld', 'privateCostsMonthly'
    ];
    const firstResults = scenarios[0].results;
    for (const prop of requiredProps) {
      if (firstResults[prop] === undefined) {
        console.error(`renderComparisonTable: missing property '${prop}' in results object. Check calculateFullIRPFWithFiscal return value in Plan 03-01.`);
      }
    }
  }

  // Find optimal values for highlighting
  const optimalLeefgeld = Math.max(...scenarios.map(s => s.results.leefgeld));
  const optimalEffRate = Math.min(...scenarios.map(s => s.results.effectiveRate));
  const optimalNetMonthly = Math.max(...scenarios.map(s => s.results.netMonthly));

  // Define metric rows (full breakdown per CONTEXT.md)
  const metrics = [
    { label: 'Monthly Revenue', getValue: (s) => s.monthlyRevenue, format: formatEUR },
    { label: 'Monthly Expenses', getValue: (s) => s.monthlyExpenses, format: formatEUR },
    { label: 'Belgium Work Costs', getValue: (s) => s.belgiumPattern === 'high' ? 2500 : 1000, format: formatEUR },
    { label: 'Total Monthly Expenses', getValue: (s) => s.monthlyExpenses + (s.belgiumPattern === 'high' ? 2500 : 1000), format: formatEUR },
    { divider: true },
    { label: 'Annual Revenue', getValue: (s) => s.results.annualRevenue, format: formatEUR },
    { label: 'RETA (Annual)', getValue: (s) => s.results.retaAnnual, format: formatEUR },
    { label: 'Annual Expenses', getValue: (s) => s.results.annualExpenses, format: formatEUR },
    { label: 'Total Deductible', getValue: (s) => s.results.totalDeductible, format: formatEUR },
    { divider: true },
    { label: 'Rendimiento Neto Previo', getValue: (s) => s.results.rendimientoNetoPrevio, format: formatEUR },
    { label: 'Gastos Dificil (5%)', getValue: (s) => s.results.gastosDificil, format: formatEUR },
    { label: 'Base Liquidable', getValue: (s) => s.results.baseLiquidable, format: formatEUR },
    { divider: true },
    { label: 'Minimo Personal', getValue: (s) => s.results.minimoPersonal, format: formatEUR },
    { label: 'Minimo Descendientes', getValue: (s) => s.results.minimoDescendientes, format: formatEUR },
    { label: 'Total Minimos', getValue: (s) => s.results.minimoTotal, format: formatEUR },
    { divider: true },
    { label: 'Cuota Integra (Annual IRPF)', getValue: (s) => s.results.cuotaIntegra, format: formatEUR },
    { label: 'Effective Tax Rate', getValue: (s) => s.results.effectiveRate, format: formatPercent, optimalMin: true },
    { divider: true },
    { label: 'Net Annual', getValue: (s) => s.results.netAnnual, format: formatEUR },
    { label: 'Net Monthly', getValue: (s) => s.results.netMonthly, format: formatEUR, optimalMax: optimalNetMonthly },
    { label: 'Private Costs', getValue: (s) => s.results.privateCostsMonthly, format: formatEUR },
    { label: 'Leefgeld', getValue: (s) => s.results.leefgeld, format: formatEUR, optimalMax: optimalLeefgeld, highlight: true }
  ];

  // Build table HTML
  let tableHtml = `
    <div class="comparison-container">
      <table class="comparison-table">
        <thead>
          <tr>
            <th>Metric</th>
            ${scenarios.map(s => `<th>${s.name}</th>`).join('')}
          </tr>
        </thead>
        <tbody>
  `;

  metrics.forEach(metric => {
    if (metric.divider) {
      tableHtml += `<tr class="divider"><td colspan="${scenarios.length + 1}"></td></tr>`;
    } else {
      const rowClass = metric.highlight ? 'highlight-row' : '';
      tableHtml += `<tr class="${rowClass}">`;
      tableHtml += `<td>${metric.label}</td>`;

      scenarios.forEach(s => {
        const value = metric.getValue(s);
        let cellClass = '';

        // Determine if this value is optimal
        if (metric.optimalMax !== undefined && value === metric.optimalMax) {
          cellClass = 'optimal';
        }
        if (metric.optimalMin && value === optimalEffRate) {
          cellClass = 'optimal';
        }

        tableHtml += `<td class="${cellClass}">${metric.format(value)}</td>`;
      });

      tableHtml += '</tr>';
    }
  });

  tableHtml += `
        </tbody>
      </table>
    </div>
  `;

  container.innerHTML = tableHtml;
}
```

**Update toggleScenarioSelection to call renderComparisonTable:**
```javascript
function toggleScenarioSelection(scenarioId) {
  const idx = scenarioState.selected.indexOf(scenarioId);
  if (idx === -1) {
    scenarioState.selected.push(scenarioId);
  } else {
    scenarioState.selected.splice(idx, 1);
  }
  saveScenarioState();
  renderScenarioCards();
  renderComparisonTable();  // Add this line
}
```

**Also call renderComparisonTable on page load (in DOMContentLoaded):**
```javascript
// Add after renderScenarioCards():
renderComparisonTable();
```

**Update saveScenarioChanges to call renderComparisonTable:**
Find the `saveScenarioChanges()` function and add `renderComparisonTable();` after `renderScenarioCards();`

**Update confirmDeleteScenario similarly.**
  </action>
  <verify>
1. Load page - comparison area shows "Select scenarios using checkboxes to compare"
2. Check checkbox on Scenario A - table appears with one column
3. Check checkbox on Scenario E - table now shows two columns
4. Verify leefgeld row is highlighted and optimal value has green accent color
5. Scroll table vertically - header row stays visible
6. Uncheck Scenario A - column disappears from table
7. Open browser console - verify NO errors about missing properties
8. Verify ALL rows display values (no undefined or NaN)
  </verify>
  <done>
Comparison table renders for selected scenarios. Full calculation breakdown visible with all 16+ properties verified. Sticky header row works. Optimal values highlighted. Table updates on selection change.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement custom scenario creation with template selection</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add "+ New" button and template selection dialog for custom scenario creation.

**Add template selection dialog HTML (after editScenarioDialog):**
```html
<dialog id="templateSelectDialog" aria-labelledby="templateDialogTitle">
  <form method="dialog">
    <header class="dialog-header">
      <h2 id="templateDialogTitle">Create New Scenario</h2>
      <button type="button" class="dialog-close" aria-label="Close" onclick="closeTemplateDialog()">x</button>
    </header>

    <div style="padding: 1.5rem;">
      <div class="form-group">
        <label for="newScenarioName">Scenario Name (required)</label>
        <input type="text" id="newScenarioName" required placeholder="e.g., Aggressive Growth">
      </div>

      <h3 style="margin-top: 1rem; font-size: 0.95rem;">Copy values from:</h3>
      <div class="template-options" id="templateOptions">
        <!-- Populated by showTemplateDialog() -->
      </div>
    </div>

    <footer class="dialog-footer">
      <div class="spacer"></div>
      <button type="button" class="secondary-btn" onclick="closeTemplateDialog()">Cancel</button>
      <button type="submit" value="create" class="primary-btn">Create Scenario</button>
    </footer>
  </form>
</dialog>
```

**Update renderScenarioCards to include "+ New" button:**
Find the `container.innerHTML = sorted.map(...)` and update to append the "+ New" button at the end:

```javascript
function renderScenarioCards() {
  const container = document.getElementById('scenarioCards');
  if (!container) return;

  const sorted = getSortedScenarios();

  const cardsHtml = sorted.map((scenario, index) => {
    const isOptimal = index === 0;
    const isSelected = scenarioState.selected.includes(scenario.id);
    const isCustom = !scenario.isPreset;
    const belgiumCost = scenario.belgiumPattern === 'high' ? 2500 : 1000;
    const totalExpenses = scenario.monthlyExpenses + belgiumCost;

    const classes = [
      'scenario-card',
      isOptimal ? 'optimal' : '',
      isSelected ? 'selected' : '',
      isCustom ? 'custom' : ''
    ].filter(Boolean).join(' ');

    return `
      <div class="${classes}" data-id="${scenario.id}">
        <div class="card-header">
          <input type="checkbox"
                 ${isSelected ? 'checked' : ''}
                 onchange="toggleScenarioSelection('${scenario.id}')"
                 aria-label="Select ${scenario.name} for comparison">
          <h3>${scenario.name}</h3>
          ${isOptimal ? '<span class="optimal-badge">Highest Leefgeld</span>' : ''}
        </div>

        <div class="card-metrics">
          <div class="metric">
            <span class="label">Revenue</span>
            <span class="value">${formatEUR(scenario.monthlyRevenue)}/mo</span>
          </div>
          <div class="metric">
            <span class="label">Expenses</span>
            <span class="value">${formatEUR(totalExpenses)}/mo</span>
          </div>
          <div class="metric">
            <span class="label">IRPF</span>
            <span class="value">${formatEUR(scenario.results.cuotaIntegra / 12)}/mo</span>
          </div>
          <div class="metric">
            <span class="label">RETA</span>
            <span class="value">${formatEUR(scenario.results.retaMonthly)}/mo</span>
          </div>
          <div class="metric highlight">
            <span class="label">Leefgeld</span>
            <span class="value">${formatEUR(scenario.results.leefgeld)}/mo</span>
          </div>
        </div>

        <button class="edit-btn" onclick="openEditModal('${scenario.id}')">
          Edit
        </button>
      </div>
    `;
  }).join('');

  // Add "+ New" button at end
  const newButtonHtml = `
    <button class="new-scenario-btn" onclick="showTemplateDialog()">+ New Scenario</button>
  `;

  container.innerHTML = cardsHtml + newButtonHtml;
}
```

**Add template dialog functions:**
```javascript
let selectedTemplateId = null;

function showTemplateDialog() {
  const dialog = document.getElementById('templateSelectDialog');
  const optionsContainer = document.getElementById('templateOptions');

  // Build template options from all scenarios
  const allScenarios = Object.values(scenarioState.scenarios);

  optionsContainer.innerHTML = allScenarios.map((s, index) => {
    const belgiumCost = s.belgiumPattern === 'high' ? 2500 : 1000;
    const checked = index === 0 ? 'checked' : '';

    return `
      <label class="template-option">
        <input type="radio" name="template" value="${s.id}" ${checked}>
        <div class="template-info">
          <div class="template-name">${s.name}</div>
          <div class="template-desc">${formatEUR(s.monthlyRevenue)}/mo revenue, ${formatEUR(s.monthlyExpenses + belgiumCost)}/mo expenses</div>
        </div>
      </label>
    `;
  }).join('');

  // Clear name input
  document.getElementById('newScenarioName').value = '';

  dialog.showModal();
}

function closeTemplateDialog() {
  document.getElementById('templateSelectDialog').close();
}

function initTemplateDialog() {
  const dialog = document.getElementById('templateSelectDialog');
  if (!dialog) return;

  dialog.addEventListener('close', () => {
    if (dialog.returnValue === 'create') {
      createCustomScenario();
    }
  });
}

function createCustomScenario() {
  const name = document.getElementById('newScenarioName').value.trim();
  if (!name) {
    alert('Please enter a name for the scenario');
    return;
  }

  // Get selected template
  const selectedRadio = document.querySelector('#templateOptions input[name="template"]:checked');
  if (!selectedRadio) {
    alert('Please select a template');
    return;
  }

  const templateId = selectedRadio.value;
  const template = scenarioState.scenarios[templateId];
  if (!template) return;

  // Create new scenario from template
  const newScenario = {
    ...structuredClone(template),
    id: crypto.randomUUID(),
    name: name,
    isPreset: false,
    fiscalOverrides: null  // Reset any overrides from template
  };

  // Add to state
  scenarioState.scenarios[newScenario.id] = newScenario;
  scenarioState.customOrder.push(newScenario.id);
  saveScenarioState();
  renderScenarioCards();
  renderComparisonTable();

  // Open edit modal for new scenario
  openEditModal(newScenario.id);
}

// Add to DOMContentLoaded:
// initTemplateDialog();
```

**Update DOMContentLoaded to init template dialog:**
Add `initTemplateDialog();` after `initEditDialog();`
  </action>
  <verify>
1. Load page - "+ New Scenario" button appears after scenario cards
2. Click "+ New Scenario" - template selection dialog opens
3. Enter name "Test Custom"
4. Select a template (e.g., Scenario B)
5. Click "Create Scenario" - dialog closes, edit modal opens for new scenario
6. Save the new scenario - new card appears in cards area
7. Verify custom scenario card has blue left border (custom indicator)
8. Refresh page - custom scenario persists
9. Edit custom scenario, click Delete - confirm dialog, scenario removed
  </verify>
  <done>
"+ New" button creates custom scenarios. Template selection dialog shows all existing scenarios as templates. New scenario opens in edit modal for customization. Custom scenarios persist to localStorage. Delete works for custom scenarios.
  </done>
</task>

</tasks>

<verification>
1. Open autonomo_dashboard.html in browser
2. Verify "+ New Scenario" button visible in scenario cards area
3. Check 2-3 scenarios - comparison table appears with full breakdown
4. Scroll comparison table - header row stays fixed
5. Verify optimal leefgeld and lowest tax rate have green highlight
6. Click "+ New Scenario" - template dialog opens
7. Enter name, select template, create - edit modal opens
8. Save custom scenario - appears with blue left border
9. Custom scenario sorted by leefgeld with presets
10. Refresh - custom scenario and selections persist
11. Select custom scenario - appears in comparison table
12. Delete custom scenario via edit modal - removed from cards and table
13. Check browser console - NO errors about undefined properties
</verification>

<success_criteria>
- Comparison table shows selected scenarios with full calculation breakdown
- All 16+ properties from calculateScenarioResults are displayed correctly
- Sticky header row works (visible during vertical scroll)
- Optimal values highlighted (leefgeld, tax rate)
- Table updates when selection changes
- "+ New" button creates custom scenarios
- Template selection works with name input
- Custom scenarios persist to localStorage
- Custom scenarios visually distinguished (blue border)
- Requirements SCEN-03, SCEN-05, SCEN-06 fully satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/03-scenario-engine/03-03-SUMMARY.md`
</output>
