# Phase 7.1: Critical Bug Fixes - Research

**Researched:** 2026-02-02
**Domain:** Vanilla JavaScript UI patterns (modals, toggles, multi-select)
**Confidence:** HIGH

## Summary

This phase addresses five critical bugs discovered in user testing. The research validates that all fixes can be implemented using native browser APIs and standard accessibility patterns without introducing any dependencies.

The key technical domains are:
1. **HTML5 Dialog Element** - For modal tooltips with backdrop blur (replaces hover-based tooltips)
2. **Accessible Toggle Buttons** - For pill-style Belgium cost toggle (replaces checkbox slider)
3. **Calendar Multi-Select** - For week/month selection (extends existing shift-click range selection)
4. **Internationalization** - Replacing Dutch text with English equivalents

All planned approaches align with web standards and accessibility best practices. The existing codebase already uses the HTML5 `<dialog>` element for other modals, making the tooltip modal implementation straightforward.

**Primary recommendation:** Leverage native HTML5 `<dialog>` for modals, use `aria-pressed` for toggle buttons, and extend existing calendar selection logic with week/month helper functions.

## Standard Stack

This phase requires no new libraries. All functionality uses native browser APIs.

### Core
| Feature | API | Purpose | Why Standard |
|---------|-----|---------|--------------|
| Modal Dialogs | HTML5 `<dialog>` | Tooltip modals with backdrop | Native focus trap, Esc handling, backdrop pseudo-element |
| Toggle Buttons | `aria-pressed` | Belgium cost pill toggle | WAI-ARIA standard for toggle state |
| Backdrop Blur | `backdrop-filter` | Modal background effect | CSS standard, widely supported since 2022 |
| Date Handling | Native `Date` | Week/month selection | No dependencies needed |

### Browser Support
| Feature | Chrome | Firefox | Safari | Edge |
|---------|--------|---------|--------|------|
| `<dialog>` | 37+ | 98+ | 15.4+ | 79+ |
| `backdrop-filter` | 76+ | 103+ | 9+ (prefixed) | 79+ |
| `aria-pressed` | Full | Full | Full | Full |

**Installation:** None required - all native APIs.

## Architecture Patterns

### Pattern 1: Modal Tooltip with Dialog Element

**What:** Replace hover-based tooltips with click-triggered modal dialogs
**When to use:** When tooltips need to be readable, accessible, and not clipped by overflow

**Source:** [MDN Dialog Element](https://developer.mozilla.org/en-US/docs/Web/HTML/Reference/Elements/dialog)

```html
<!-- Single modal element, reused for all tooltips -->
<dialog id="tooltipModal" class="tooltip-modal">
  <div class="tooltip-modal-content">
    <h3 id="tooltipModalTitle"></h3>
    <p id="tooltipModalText"></p>
    <button type="button" autofocus onclick="closeTooltipModal()">Got it</button>
  </div>
</dialog>
```

```css
.tooltip-modal::backdrop {
  background: rgba(0, 0, 0, 0.6);
  -webkit-backdrop-filter: blur(4px);  /* Safari 16 and older */
  backdrop-filter: blur(4px);
}
```

```javascript
function openTooltipModal(title, text) {
  const dialog = document.getElementById('tooltipModal');
  document.getElementById('tooltipModalTitle').textContent = title;
  document.getElementById('tooltipModalText').textContent = text;
  dialog.showModal();  // Native focus trap, Esc handling, backdrop
}

function closeTooltipModal() {
  document.getElementById('tooltipModal').close();
}

// Close on backdrop click
document.getElementById('tooltipModal').addEventListener('click', (e) => {
  if (e.target.tagName === 'DIALOG') e.target.close();
});
```

**Key benefits:**
- `showModal()` provides automatic focus trap (Tab cycles within modal)
- Esc key closes modal by default (browser-handled)
- `::backdrop` pseudo-element for blur effect
- Focus returns to trigger element on close

### Pattern 2: Pill-Style Toggle Buttons

**What:** Mutually exclusive button group styled as pills
**When to use:** Binary choice where both options should be visible (not checkbox on/off)

**Source:** [W3C Button Pattern](https://www.w3.org/WAI/ARIA/apg/patterns/button/)

```html
<div class="pill-toggle" role="group" aria-label="Belgium cost pattern">
  <button type="button" class="active" aria-pressed="true" onclick="setBelgiumPattern('low')">
    Low (1K)
  </button>
  <button type="button" aria-pressed="false" onclick="setBelgiumPattern('high')">
    High (2.5K)
  </button>
</div>
```

```css
.pill-toggle {
  display: inline-flex;
  background: rgba(255,255,255,0.1);
  border-radius: 20px;
  padding: 4px;
}

.pill-toggle button {
  padding: 8px 16px;
  border: none;
  background: transparent;
  color: var(--text-muted);
  border-radius: 16px;
  cursor: pointer;
  transition: all 0.2s;
}

.pill-toggle button.active,
.pill-toggle button[aria-pressed="true"] {
  background: var(--accent);
  color: var(--bg);
  font-weight: 600;
}
```

```javascript
function setBelgiumPattern(pattern) {
  expenseData.belgiumPattern = pattern;

  // Update aria-pressed for all buttons
  document.querySelectorAll('.pill-toggle button').forEach(btn => {
    const isActive = btn.textContent.toLowerCase().includes(pattern);
    btn.classList.toggle('active', isActive);
    btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
  });

  updateBelgiumCost();
  saveExpenses();
  recalculateTotals();
}
```

**Accessibility notes:**
- Use `role="group"` with `aria-label` for the container
- Use `aria-pressed` on buttons to convey state to screen readers
- Keep labels consistent (don't change button text based on state)
- Both Enter and Space keys activate buttons natively

### Pattern 3: Calendar Week/Month Selection

**What:** Extend existing multi-select with week and month helper selections
**When to use:** When users need to bulk-select calendar days efficiently

```javascript
/**
 * Select all days in a week
 * @param {string} weekStartKey - ISO date key of week's Monday
 */
function selectWeek(weekStartKey) {
  const start = new Date(weekStartKey);
  selectedDates.clear();

  for (let i = 0; i < 7; i++) {
    const day = new Date(start);
    day.setDate(start.getDate() + i);

    // Only include valid range (Feb-Dec 2026)
    if (day.getFullYear() === 2026 && day.getMonth() >= 1) {
      selectedDates.add(toISODateKey(day));
    }
  }

  renderCalendar();
  updateSelectionIndicator();
  if (selectedDates.size > 0) openBulkPicker();
}

/**
 * Select all days in a month
 * @param {number} month - Month index (0-11)
 */
function selectMonth(month) {
  const year = 2026;
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);  // Last day of month

  selectedDates.clear();

  const current = new Date(firstDay);
  while (current <= lastDay) {
    selectedDates.add(toISODateKey(current));
    current.setDate(current.getDate() + 1);
  }

  renderCalendar();
  updateSelectionIndicator();
  openBulkPicker();
}
```

**UI elements to add:**
- Week selector: Small "W" button at the start of each calendar row
- Month selector: "Select all" button in month header
- Selection indicator: Bar showing "X days selected [Clear]"

### Anti-Patterns to Avoid

- **Custom modal implementations:** Don't build focus traps manually when `<dialog>` provides them
- **Using `open` attribute:** Always use `showModal()` for modal dialogs, not the `open` attribute
- **Checkbox for binary visible choice:** Use pill buttons when both options should be visible
- **Changing toggle label text:** Keep button labels constant, use `aria-pressed` for state

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Modal focus trap | Custom Tab key handler | `dialog.showModal()` | Browser handles focus trapping, Esc, backdrop |
| Backdrop blur | Canvas overlay | `::backdrop` + `backdrop-filter` | Native CSS, hardware accelerated |
| Toggle state announcement | Custom screen reader text | `aria-pressed` attribute | Standard ARIA, consistent across AT |
| Date iteration | Custom day counting | Native `Date` math | Edge cases handled (DST, month boundaries) |

**Key insight:** The HTML5 `<dialog>` element eliminates the need for custom modal code. The existing codebase already uses `<dialog>` for day picker and bulk picker dialogs, so adding tooltip modal follows the same pattern.

## Common Pitfalls

### Pitfall 1: Backdrop Click Not Closing Modal

**What goes wrong:** Clicking the modal backdrop doesn't close the dialog
**Why it happens:** HTML5 `<dialog>` doesn't close on backdrop click by default
**How to avoid:** Add click event listener that checks `e.target === dialog`
**Warning signs:** Users clicking backdrop repeatedly expecting modal to close

```javascript
dialog.addEventListener('click', (e) => {
  if (e.target === dialog) dialog.close();
});
```

### Pitfall 2: Safari Backdrop Filter Prefix

**What goes wrong:** Backdrop blur doesn't work in older Safari versions
**Why it happens:** Safari 16 and earlier require `-webkit-` prefix
**How to avoid:** Always include both prefixed and unprefixed properties
**Warning signs:** Blur effect missing on Safari testing

```css
dialog::backdrop {
  -webkit-backdrop-filter: blur(4px);  /* Safari 16 and older */
  backdrop-filter: blur(4px);
}
```

### Pitfall 3: Toggle Button State Not Announced

**What goes wrong:** Screen readers don't announce toggle state changes
**Why it happens:** Missing `aria-pressed` attribute updates
**How to avoid:** Update `aria-pressed` in JavaScript when state changes
**Warning signs:** Accessibility audit failures, user complaints

### Pitfall 4: Week Selection Crossing Month Boundaries

**What goes wrong:** Selecting a week at month boundary includes invalid dates
**Why it happens:** Week starts in one month, ends in another
**How to avoid:** Filter selected dates by valid range (Feb-Dec 2026 for this app)
**Warning signs:** Calendar showing January dates or 2027 dates selected

### Pitfall 5: Dutch Text in localStorage

**What goes wrong:** Dutch expense names persist after renaming in code
**Why it happens:** User data in localStorage contains old Dutch names
**How to avoid:** Only change display names in DEFAULT_EXPENSES, keep IDs unchanged
**Warning signs:** Dutch text reappearing after page refresh

## Code Examples

### Tooltip Trigger with Click Handler

```javascript
function createTooltip(term, displayText) {
  const tooltip = TOOLTIPS[term];
  if (!tooltip) return displayText;

  // Escape quotes for inline handlers
  const title = tooltip.title.replace(/'/g, "\\'");
  const text = tooltip.text.replace(/'/g, "\\'");

  return `<span class="term-tooltip-trigger" tabindex="0"
    onclick="openTooltipModal('${title}', '${text}')"
    onkeydown="if(event.key==='Enter')openTooltipModal('${title}', '${text}')"
    role="button"
    aria-label="Learn more about ${tooltip.title}">
    ${displayText}<span class="info-icon">i</span>
  </span>`;
}
```

### English Expense Names Mapping

```javascript
const DEFAULT_EXPENSES = Object.freeze({
  spainDeductible: [
    Object.freeze({ id: 'huur', name: 'Rent (30% deductible)', baseAmount: 1155, deductionPct: 30, deletable: true }),
    Object.freeze({ id: 'gsm', name: 'Mobile (50% deductible)', baseAmount: 55, deductionPct: 50, deletable: true }),
    Object.freeze({ id: 'elektriciteit', name: 'Electricity (9% deductible)', baseAmount: 100, deductionPct: 9, deletable: true })
  ],
  private: [
    Object.freeze({ id: 'huur-private', name: 'Rent (70% private)', amount: 808.50, deletable: true }),
    Object.freeze({ id: 'gsm-private', name: 'Mobile (50% private)', amount: 27.50, deletable: true }),
    Object.freeze({ id: 'elektriciteit-private', name: 'Electricity (91% private)', amount: 91, deletable: true }),
    Object.freeze({ id: 'auto', name: 'Car', amount: 600, deletable: true }),
    Object.freeze({ id: 'verzekeringen', name: 'Insurance', amount: 200, deletable: true })
  ]
});
```

**Note:** The `id` values remain unchanged (huur, gsm, elektriciteit, verzekeringen) to maintain backwards compatibility with existing localStorage data.

### Selection Indicator Component

```html
<div id="selectionIndicator" class="selection-indicator hidden">
  <span id="selectionCount">0</span> days selected
  <button type="button" class="clear-selection" onclick="clearSelection()">Clear</button>
</div>
```

```javascript
function updateSelectionIndicator() {
  const indicator = document.getElementById('selectionIndicator');
  const countEl = document.getElementById('selectionCount');

  if (!indicator || !countEl) return;

  if (selectedDates.size > 0) {
    countEl.textContent = selectedDates.size;
    indicator.classList.remove('hidden');
  } else {
    indicator.classList.add('hidden');
  }
}

function clearSelection() {
  selectedDates.clear();
  renderCalendar();
  updateSelectionIndicator();
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Custom modal with `div` + JS focus trap | `<dialog>` with `showModal()` | 2022 (baseline) | Simpler code, better accessibility |
| Checkbox slider toggle | Pill button group with `aria-pressed` | Ongoing best practice | Clearer UX when both options visible |
| Hover tooltips | Click-to-open modal tooltips | Touch devices drove change | Works on touch, no accidental triggers |
| `filter: blur()` on overlay `div` | `backdrop-filter` on `::backdrop` | 2022 (Safari support) | Native, performant |

**Deprecated/outdated:**
- Using `tabindex` on `<dialog>` element: Never valid, breaks accessibility
- Using `open` attribute for modals: Use `showModal()` instead for proper modal behavior
- `-webkit-backdrop-filter` alone: Include unprefixed version as primary

## Open Questions

1. **localStorage Migration**
   - What we know: Existing users have expense data with Dutch names stored in localStorage
   - What's unclear: Whether to migrate existing data or let it coexist
   - Recommendation: Keep IDs unchanged; display names update automatically on next render

2. **Add Expense Button Debug**
   - What we know: Button calls `showAddForm()` which should remove 'hidden' class from form
   - What's unclear: Exact cause of failure (form missing, function not defined, CSS issue)
   - Recommendation: Add console.log debugging during implementation to identify root cause

## Sources

### Primary (HIGH confidence)
- [MDN Dialog Element](https://developer.mozilla.org/en-US/docs/Web/HTML/Reference/Elements/dialog) - Complete `<dialog>` API reference
- [W3C WAI-ARIA Button Pattern](https://www.w3.org/WAI/ARIA/apg/patterns/button/) - Toggle button accessibility
- [W3C Modal Dialog Example](https://www.w3.org/WAI/ARIA/apg/patterns/dialog-modal/examples/dialog/) - Modal dialog best practices

### Secondary (MEDIUM confidence)
- [Can I Use: CSS Backdrop Filter](https://caniuse.com/css-backdrop-filter) - Browser support data
- [Smashing Magazine: Inclusive Toggle Buttons](https://www.smashingmagazine.com/2017/09/building-inclusive-toggle-buttons/) - Accessibility patterns

### Tertiary (LOW confidence)
- [Accessible Toggle Buttons Blog](https://joshcollinsworth.com/blog/accessible-toggle-buttons) - Implementation examples

## Metadata

**Confidence breakdown:**
- Modal pattern: HIGH - Official MDN and W3C documentation
- Toggle pattern: HIGH - W3C ARIA Authoring Practices
- Calendar selection: MEDIUM - Custom implementation, follows existing codebase patterns
- Browser support: HIGH - Can I Use data verified

**Research date:** 2026-02-02
**Valid until:** 2026-05-02 (90 days - stable web APIs)

## Prior Decisions Applied

The following prior decisions from earlier phases constrain this phase:

| Decision | How It Applies |
|----------|----------------|
| Native dialog element over custom modal | Tooltip modal MUST use `<dialog>`, not custom div+JS |
| role=tooltip ARIA pattern | Convert to click-triggered modal with accessible role |
| Escape key dismisses tooltips | Modal inherits Esc handling from `<dialog>` |
| Shift-click for range selection | Preserved; week/month selection supplements it |
| Dutch localization for Excel | Excel remains Dutch; HTML dashboard becomes English |

Note: The decision for "Dutch localization" applies to Excel only (Phase 6). The HTML dashboard has always been English-primary, so removing remaining Dutch text (expense names) aligns with original intent.
