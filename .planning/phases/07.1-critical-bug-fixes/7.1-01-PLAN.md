---
phase: 7.1-critical-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "Add expense button opens a form when clicked"
    - "New expenses appear in the correct category after submission"
    - "All expense names display in English (no Dutch text visible)"
    - "Belgium cost toggle displays as two pill-style buttons (Low/High)"
    - "Clicking a pill button switches the Belgium cost pattern"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Fixed add expense, English text, pill toggle"
      contains: "Rent (30% deductible)"
  key_links:
    - from: "showAddForm function"
      to: "addExpenseForm element"
      via: "classList.remove('hidden')"
      pattern: "form\\.classList\\.remove\\('hidden'\\)"
    - from: "pill-toggle buttons"
      to: "expenseData.belgiumPattern"
      via: "setBelgiumPattern function"
      pattern: "setBelgiumPattern"
---

<objective>
Fix three related expense section bugs: add expense button not working, Dutch text remaining, and Belgium toggle using wrong UI pattern.

Purpose: These three bugs affect the Expenses tab usability and are blocking v1.0 release. Users cannot add expenses, see Dutch text they don't understand, and the toggle design doesn't match modern UX patterns.

Output: Working add expense button, all English expense names, pill-style Belgium toggle
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.1-critical-bug-fixes/07.1-RESEARCH.md
@autonomo_dashboard.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix add expense button and translate Dutch text to English</name>
  <files>autonomo_dashboard.html</files>
  <action>
Debug and fix the add expense button:
1. Search for `showAddForm` function (around line 4432)
2. Add console.log debugging to identify if function is called
3. Verify `addExpenseForm` element exists in DOM (around line 2212)
4. Check if the form's `hidden` class is being properly removed
5. If the form doesn't exist in DOM at runtime, ensure it's rendered before expense sections

Fix root cause: The form element (`id="addExpenseForm"`) is defined in HTML but may be inside a tab panel that's not active. Ensure the form is accessible regardless of active tab, or move it to a global location.

Translate Dutch expense names to English in DEFAULT_EXPENSES constant (around line 3794):

**Spain Deductible:**
- `'Huur (Rent)'` -> `'Rent (30% deductible)'`
- `'GSM (Mobile)'` -> `'Mobile (50% deductible)'`
- `'Elektriciteit'` -> `'Electricity (9% deductible)'`

**Private:**
- `'Huur 70%'` -> `'Rent (70% private)'`
- `'GSM 50%'` -> `'Mobile (50% private)'`
- `'Elektriciteit 91%'` -> `'Electricity (91% private)'`
- `'Auto'` -> `'Car'`
- `'Verzekeringen'` -> `'Insurance'`

IMPORTANT: Keep the `id` fields unchanged (huur, gsm, elektriciteit, auto, verzekeringen) to maintain backwards compatibility with existing localStorage data.
  </action>
  <verify>
1. Open autonomo_dashboard.html in browser
2. Navigate to Expenses tab
3. Click "+ Add Expense" button in any section
4. Confirm form appears (not hidden)
5. Fill in expense details and submit
6. Confirm expense appears in list
7. Confirm all expense names are in English
  </verify>
  <done>
- Add expense button opens form when clicked
- New expenses persist after submission
- All DEFAULT_EXPENSES names display in English
- No Dutch text visible in Expenses tab
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace Belgium toggle checkbox with pill-style buttons</name>
  <files>autonomo_dashboard.html</files>
  <action>
Replace the checkbox slider toggle with accessible pill-style buttons:

1. **Remove old toggle CSS** (around lines 1705-1752):
   - Delete `.toggle-switch`, `.toggle-label`, `.toggle-input`, `.toggle-slider` styles

2. **Add new pill toggle CSS**:
```css
/* Pill Toggle for Belgium Pattern */
.pill-toggle {
  display: inline-flex;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 20px;
  padding: 4px;
  gap: 4px;
}

.pill-toggle button {
  padding: 8px 16px;
  border: none;
  background: transparent;
  color: var(--text-muted);
  border-radius: 16px;
  cursor: pointer;
  font-family: inherit;
  font-size: 0.85rem;
  font-weight: 500;
  transition: all 0.2s ease;
}

.pill-toggle button:hover {
  color: var(--text);
}

.pill-toggle button.active,
.pill-toggle button[aria-pressed="true"] {
  background: var(--accent);
  color: var(--bg);
  font-weight: 600;
}

.pill-toggle button:focus-visible {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}
```

3. **Update renderExpenseSection function** (around line 4336):
   Replace the toggle HTML:
```javascript
// OLD:
headerExtra = `
  <div class="toggle-switch">
    <span class="toggle-label low ${!isHigh ? 'active' : ''}">Low (1K)</span>
    <input type="checkbox" id="belgiumToggle" class="toggle-input" ${isHigh ? 'checked' : ''}>
    <span class="toggle-slider"></span>
    <span class="toggle-label high ${isHigh ? 'active' : ''}">High (2.5K)</span>
  </div>
`;

// NEW:
headerExtra = `
  <div class="pill-toggle" role="group" aria-label="Belgium cost pattern">
    <button type="button" ${!isHigh ? 'class="active" aria-pressed="true"' : 'aria-pressed="false"'}
            onclick="setBelgiumPattern('low')">Low (1K)</button>
    <button type="button" ${isHigh ? 'class="active" aria-pressed="true"' : 'aria-pressed="false"'}
            onclick="setBelgiumPattern('high')">High (2.5K)</button>
  </div>
`;
```

4. **Replace initBelgiumToggle function** (around line 4140):
```javascript
/**
 * Set Belgium cost pattern and update UI
 * @param {string} pattern - 'low' or 'high'
 */
function setBelgiumPattern(pattern) {
  expenseData.belgiumPattern = pattern;

  // Update button states
  document.querySelectorAll('.pill-toggle button').forEach(btn => {
    const isActive = btn.textContent.toLowerCase().includes(pattern);
    btn.classList.toggle('active', isActive);
    btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
  });

  updateBelgiumCost();
  saveExpenses();
  recalculateTotals();

  // Re-render expense sections to update breakdown
  renderExpenses();
}

/**
 * Initialize Belgium toggle state (called after render)
 * Now simplified - state is set via onclick handlers
 */
function initBelgiumToggle() {
  // No longer needed - pill buttons are self-contained
  // Kept for backwards compatibility in case called elsewhere
}
```

5. **Remove updateToggleLabels function** - no longer needed with pill buttons
  </action>
  <verify>
1. Open autonomo_dashboard.html in browser
2. Navigate to Expenses tab
3. Find Belgium Work Costs section
4. Confirm two pill-style buttons visible ("Low (1K)" and "High (2.5K)")
5. Click "Low (1K)" - confirm it becomes highlighted/active
6. Click "High (2.5K)" - confirm it becomes highlighted and Low becomes inactive
7. Confirm Belgium cost value updates in breakdown formula
8. Refresh page and confirm selection persists (localStorage)
9. Test keyboard navigation: Tab to buttons, press Enter/Space to activate
  </verify>
  <done>
- Belgium toggle displays as two pill-style buttons
- Clicking a button switches the pattern and updates visuals
- Active button is highlighted with accent color
- Pattern persists across page refresh
- Keyboard accessible (focusable, Enter/Space activates)
  </done>
</task>

</tasks>

<verification>
1. **Add Expense Flow:**
   - Navigate to Expenses tab
   - Click "+ Add Expense" in Spain Deductible section
   - Form should appear
   - Enter "Test Expense", select category, enter amount
   - Click Save
   - Expense appears in list

2. **English Text:**
   - All expense names in English
   - No "Huur", "GSM", "Elektriciteit", "Verzekeringen", "Auto" visible

3. **Pill Toggle:**
   - Two buttons visible: "Low (1K)" and "High (2.5K)"
   - Active button is highlighted
   - Clicking switches active state
   - Belgium breakdown formula updates

4. **Persistence:**
   - Add expense, change toggle, refresh page
   - Changes persist
</verification>

<success_criteria>
- BUG-01: Add expense button opens form and creates expenses
- BUG-03: All expense names display in English
- BUG-04: Belgium toggle uses pill-style buttons with proper accessibility
- All changes persist to localStorage
- No console errors
</success_criteria>

<output>
After completion, create `.planning/phases/07.1-critical-bug-fixes/7.1-01-SUMMARY.md`
</output>
