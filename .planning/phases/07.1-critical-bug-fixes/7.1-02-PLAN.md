---
phase: 7.1-critical-bug-fixes
plan: 02
type: execute
wave: 1
depends_on:
  - "7.1-01"
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "Clicking an info icon (i) opens a centered modal"
    - "Modal has blurred backdrop behind it"
    - "Modal displays tooltip title and explanation text"
    - "Modal closes on Esc key press"
    - "Modal closes when clicking backdrop"
    - "Modal closes when clicking 'Got it' button"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Tooltip modal system"
      contains: "tooltipModal"
  key_links:
    - from: "term-tooltip-trigger elements"
      to: "openTooltipModal function"
      via: "onclick handler"
      pattern: "openTooltipModal"
    - from: "tooltipModal dialog"
      to: "backdrop pseudo-element"
      via: "::backdrop CSS"
      pattern: "tooltipModal::backdrop"
---

<objective>
Replace hover-based tooltips with click-triggered centered modals that have a blurred backdrop.

Purpose: Current tooltips appear at top of screen and are hard to read. Modal tooltips are more accessible, work on touch devices, and provide a better reading experience.

Output: Click-to-open tooltip modals with blur backdrop, accessible keyboard navigation
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.1-critical-bug-fixes/07.1-RESEARCH.md
@autonomo_dashboard.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tooltip modal dialog element and CSS styles</name>
  <files>autonomo_dashboard.html</files>
  <action>
1. **Add tooltip modal CSS** (in the PHASE 5: TOOLTIPS section, around line 1755):

Replace or augment the existing tooltip CSS with modal styles:

```css
/* ===========================================
   PHASE 5/7.1: TOOLTIP MODALS (UI-09, BUG-02)
   =========================================== */

/* Tooltip trigger - clickable info icon */
.term-tooltip-trigger {
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  color: inherit;
  text-decoration: none;
  border-bottom: 1px dotted var(--text-muted);
}

.term-tooltip-trigger:hover,
.term-tooltip-trigger:focus {
  color: var(--accent);
  border-bottom-color: var(--accent);
}

.term-tooltip-trigger:focus-visible {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

.info-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 16px;
  height: 16px;
  font-size: 10px;
  font-weight: 700;
  color: var(--bg);
  background: var(--accent);
  border-radius: 50%;
  flex-shrink: 0;
}

/* Tooltip Modal Dialog */
.tooltip-modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  max-width: 400px;
  width: 90%;
  padding: 0;
  border: none;
  border-radius: 12px;
  background: var(--bg-surface);
  color: var(--text);
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
}

.tooltip-modal::backdrop {
  background: rgba(0, 0, 0, 0.6);
  -webkit-backdrop-filter: blur(4px);
  backdrop-filter: blur(4px);
}

.tooltip-modal-content {
  padding: 24px;
}

.tooltip-modal-title {
  margin: 0 0 12px 0;
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--accent);
}

.tooltip-modal-text {
  margin: 0 0 20px 0;
  font-size: 0.95rem;
  line-height: 1.6;
  color: var(--text);
}

.tooltip-modal-close {
  display: block;
  width: 100%;
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  background: var(--accent);
  color: var(--bg);
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: opacity 0.2s;
}

.tooltip-modal-close:hover {
  opacity: 0.9;
}

.tooltip-modal-close:focus-visible {
  outline: 2px solid var(--text);
  outline-offset: 2px;
}
```

2. **Add tooltip modal HTML** (after the other dialog elements, around line 2250):

```html
<!-- Tooltip Modal (single instance, reused for all tooltips) -->
<dialog id="tooltipModal" class="tooltip-modal">
  <div class="tooltip-modal-content">
    <h3 id="tooltipModalTitle" class="tooltip-modal-title"></h3>
    <p id="tooltipModalText" class="tooltip-modal-text"></p>
    <button type="button" class="tooltip-modal-close" autofocus onclick="closeTooltipModal()">Got it</button>
  </div>
</dialog>
```

3. **Remove old hover tooltip CSS** (the `.term-tooltip`, `[role="tooltip"]` styles that use hover):
   - Remove lines ~1760-1820 that define hover-based tooltip behavior
   - Keep any styles needed for other tooltips (like `data-tooltip` on source hints)
  </action>
  <verify>
1. Open autonomo_dashboard.html in browser
2. Check that dialog element exists in DOM (DevTools > Elements > search "tooltipModal")
3. Inspect CSS and confirm `.tooltip-modal::backdrop` has blur filter
  </verify>
  <done>
- tooltipModal dialog element exists in HTML
- CSS styles define centered modal with blur backdrop
- Old hover tooltip CSS removed for term-tooltip elements
  </done>
</task>

<task type="auto">
  <name>Task 2: Update createTooltip function and add modal handlers</name>
  <files>autonomo_dashboard.html</files>
  <action>
1. **Update createTooltip function** (around line 3772):

Replace the existing hover-based tooltip markup with click trigger:

```javascript
/**
 * Create clickable tooltip trigger that opens modal
 * @param {string} term - Key from TOOLTIPS constant
 * @param {string} displayText - Text to display as trigger
 * @returns {string} - HTML with click trigger or just displayText if term not found
 */
function createTooltip(term, displayText) {
  const tooltip = TOOLTIPS[term];
  if (!tooltip) return displayText;

  // Escape quotes for inline handlers
  const title = tooltip.title.replace(/'/g, "\\'").replace(/"/g, '&quot;');
  const text = tooltip.text.replace(/'/g, "\\'").replace(/"/g, '&quot;');

  return `<span class="term-tooltip-trigger" tabindex="0"
    onclick="openTooltipModal('${title}', '${text}')"
    onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openTooltipModal('${title}', '${text}')}"
    role="button"
    aria-label="Learn more about ${tooltip.title}">
    ${displayText}<span class="info-icon">i</span>
  </span>`;
}
```

2. **Add tooltip modal functions** (after createTooltip function):

```javascript
/**
 * Open tooltip modal with title and text
 * @param {string} title - Modal title
 * @param {string} text - Modal body text
 */
function openTooltipModal(title, text) {
  const dialog = document.getElementById('tooltipModal');
  if (!dialog) return;

  document.getElementById('tooltipModalTitle').textContent = title;
  document.getElementById('tooltipModalText').textContent = text;
  dialog.showModal();
}

/**
 * Close tooltip modal
 */
function closeTooltipModal() {
  const dialog = document.getElementById('tooltipModal');
  if (dialog) dialog.close();
}
```

3. **Add backdrop click handler** (in the DOMContentLoaded initialization section):

```javascript
// Tooltip modal: close on backdrop click
const tooltipModal = document.getElementById('tooltipModal');
if (tooltipModal) {
  tooltipModal.addEventListener('click', (e) => {
    if (e.target === tooltipModal) {
      tooltipModal.close();
    }
  });
}
```

4. **Update the Escape key handler** (around line 5652):

The existing handler removes focus from `.term-tooltip` - update it to work with the new trigger class:

```javascript
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    // Close tooltip modal if open (handled natively by dialog)
    // Remove focus from any tooltip trigger
    if (document.activeElement.classList.contains('term-tooltip-trigger')) {
      document.activeElement.blur();
    }
  }
});
```
  </action>
  <verify>
1. Open autonomo_dashboard.html in browser
2. Navigate to Scenarios tab
3. Find a term with info icon (e.g., "RETA" in comparison table)
4. Click the info icon
5. Modal should appear centered with blur backdrop
6. Press Esc - modal closes
7. Click info icon again
8. Click outside modal (backdrop) - modal closes
9. Click info icon again
10. Click "Got it" button - modal closes
11. Test keyboard: Tab to info icon, press Enter - modal opens
  </verify>
  <done>
- createTooltip returns click-triggered elements with info icons
- openTooltipModal and closeTooltipModal functions work
- Modal closes on: Esc key, backdrop click, button click
- Keyboard accessible (Enter/Space opens modal)
  </done>
</task>

</tasks>

<verification>
1. **Visual Verification:**
   - Navigate to Scenarios tab
   - Find RETA, IRPF, or other tooltip terms
   - Confirm "i" icon visible next to term
   - Click icon - modal appears centered
   - Background is blurred and darkened

2. **Close Methods:**
   - Press Esc - modal closes
   - Click backdrop - modal closes
   - Click "Got it" - modal closes

3. **Content:**
   - Modal title matches term (e.g., "IRPF (Impuesto sobre la Renta)")
   - Modal text explains the term

4. **Accessibility:**
   - Tab to info icon, press Enter - modal opens
   - Focus moves to "Got it" button
   - Modal traps focus (Tab cycles within)
   - Esc closes and returns focus

5. **All Tooltips:**
   - Test in Scenarios tab comparison table
   - Test in Details section (if any)
   - All 8 TOOLTIPS terms work correctly
</verification>

<success_criteria>
- BUG-02: Info tooltips open as centered modals with background blur
- Modal has title, text, and close button
- Modal closes via Esc, backdrop click, or button
- All 8 tooltip terms work correctly
- Keyboard accessible throughout
- No console errors
</success_criteria>

<output>
After completion, create `.planning/phases/07.1-critical-bug-fixes/7.1-02-SUMMARY.md`
</output>
