---
phase: 05-dashboard-ui
plan: 03
type: execute
wave: 2
depends_on:
  - 05-01
  - 05-02
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "Hovering technical terms (IRPF, RETA, etc.) shows explanatory tooltip"
    - "Tooltips are keyboard accessible (visible on focus, dismissable with Escape)"
    - "Print view shows clean layout with light background"
    - "User can copy comparison table data to clipboard"
    - "Mobile view shows comparison data in vertical blocks instead of horizontal table"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Tooltips, export, and responsive design"
      contains: "role=\"tooltip\""
  key_links:
    - from: "button (copy)"
      to: "navigator.clipboard.writeText"
      via: "click handler"
      pattern: "clipboard.writeText"
    - from: "@media print"
      to: "background: white"
      via: "print stylesheet"
      pattern: "@media print"
---

<objective>
Add accessible tooltips for technical terms, implement print stylesheet and clipboard export, and create responsive mobile layout with vertical comparison blocks.

Purpose: Delivers UI-08 (responsive), UI-09 (tooltips), UI-10 (export) requirements.
Output: Dashboard with hoverable tooltips, print-ready layout, copy-to-clipboard button, and mobile-optimized comparison view.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-dashboard-ui/05-CONTEXT.md
@.planning/phases/05-dashboard-ui/05-RESEARCH.md
@.planning/phases/05-dashboard-ui/05-01-SUMMARY.md
@.planning/phases/05-dashboard-ui/05-02-SUMMARY.md
@autonomo_dashboard.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Accessible ARIA Tooltips</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add tooltip CSS for accessible tooltips per WCAG 1.4.13:

```css
/* ===========================================
   PHASE 5: TOOLTIPS (UI-09)
   =========================================== */

/* Tooltip trigger styling */
.term-tooltip {
  position: relative;
  cursor: help;
  border-bottom: 1px dotted var(--text-muted);
}

/* Tooltip content */
[role="tooltip"] {
  visibility: hidden;
  opacity: 0;
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
  background: var(--bg-elevated);
  border: 1px solid var(--accent);
  border-radius: 6px;
  padding: 0.75rem 1rem;
  max-width: 300px;
  min-width: 200px;
  font-size: var(--size-small);
  line-height: 1.4;
  color: var(--text);
  box-shadow: 0 4px 16px rgba(0,0,0,0.4);
  transition: opacity 0.2s, visibility 0.2s;
  margin-bottom: 8px;
  text-align: left;
  font-weight: 400;
}

/* Tooltip arrow */
[role="tooltip"]::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 6px solid transparent;
  border-top-color: var(--accent);
}

/* Show on hover/focus of trigger AND when hovering tooltip itself */
.term-tooltip:hover [role="tooltip"],
.term-tooltip:focus [role="tooltip"],
.term-tooltip:focus-within [role="tooltip"],
[role="tooltip"]:hover {
  visibility: visible;
  opacity: 1;
}

/* Ensure tooltips in cards don't get clipped */
.scenario-card {
  overflow: visible;
}

/* Tooltip title */
.tooltip-title {
  font-weight: 600;
  color: var(--accent);
  display: block;
  margin-bottom: 0.25rem;
}
```

Add JavaScript for Escape key dismissal:

```javascript
// Tooltip escape key handler
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    // Remove focus from any tooltip trigger
    if (document.activeElement.classList.contains('term-tooltip')) {
      document.activeElement.blur();
    }
  }
});
```

Create a TOOLTIPS constant with technical term definitions:

```javascript
const TOOLTIPS = {
  irpf: {
    title: 'IRPF (Impuesto sobre la Renta)',
    text: 'Spanish personal income tax. Progressive rates from 19% to 47% based on taxable income brackets.'
  },
  reta: {
    title: 'RETA (Regimen Especial)',
    text: 'Spanish social security contribution for self-employed. Fixed monthly quota (cuota) based on income tramo.'
  },
  minimo: {
    title: 'Minimo Personal',
    text: 'Tax-free personal allowance (5,550 EUR). Reduces the tax owed, not the taxable base.'
  },
  descendientes: {
    title: 'Minimo por Descendientes',
    text: 'Child allowance (2,400 EUR for first child). Reduces tax liability after rate application.'
  },
  gastos: {
    title: 'Gastos de Dificil Justificacion',
    text: '5% deduction on net income for hard-to-document expenses. Capped at 2,000 EUR annually.'
  },
  leefgeld: {
    title: 'Leefgeld (Living Money)',
    text: 'Money remaining after all taxes AND private living costs. True disposable income.'
  },
  dietas: {
    title: 'Dietas (Per Diem)',
    text: 'Tax-exempt daily allowance for work travel. Belgium: 91.35 EUR with overnight stay.'
  },
  treaty: {
    title: 'Spain-Belgium Tax Treaty',
    text: 'Bilateral agreement preventing double taxation. Article 4 defines tax residency rules.'
  }
};
```

Create a helper function to generate tooltip HTML:

```javascript
function createTooltip(term, displayText) {
  const tooltip = TOOLTIPS[term];
  if (!tooltip) return displayText;
  return `<span class="term-tooltip" tabindex="0" aria-describedby="tip-${term}">
    ${displayText}
    <span role="tooltip" id="tip-${term}">
      <span class="tooltip-title">${tooltip.title}</span>
      ${tooltip.text}
    </span>
  </span>`;
}
```

Apply tooltips to key terms in the UI by updating the rendering functions:

**In renderScenarioCards() function** (approximately lines 2800-2900 where the card HTML template is built):
- Find the card-metrics div template
- Update the IRPF label: change `<span class="label">IRPF</span>` to `<span class="label">${createTooltip('irpf', 'IRPF')}</span>`
- Update the RETA label: change `<span class="label">RETA</span>` to `<span class="label">${createTooltip('reta', 'RETA')}</span>`
- Update the Leefgeld label: change `<span class="label">Leefgeld</span>` to `<span class="label">${createTooltip('leefgeld', 'Leefgeld')}</span>`

**In renderComparisonTable() function** (find the metrics array definition):
- Update the metrics array labels to include tooltips:
  - `{ label: createTooltip('reta', 'RETA Annual'), key: 'retaAnnual', ... }`
  - `{ label: createTooltip('irpf', 'IRPF Total'), key: 'irpfTotal', ... }`
  - `{ label: createTooltip('leefgeld', 'Leefgeld'), key: 'leefgeld', ... }`

Note: The createTooltip function must be defined BEFORE renderScenarioCards and renderComparisonTable in the script, or moved to the top of the script section.
  </action>
  <verify>
Hover over "IRPF" label on a scenario card - tooltip should appear with explanation. Tab to the term using keyboard - tooltip should appear on focus. Press Escape - tooltip should close. Hover the tooltip itself - it should stay visible (allows reading long content).
  </verify>
  <done>
Technical terms have accessible tooltips. Tooltips appear on hover and focus. Escape key dismisses tooltips. Tooltip content explains IRPF, RETA, Leefgeld, etc.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Print Stylesheet and Export Button</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add print stylesheet at the end of the style block:

```css
/* ===========================================
   PHASE 5: PRINT STYLES (UI-10)
   =========================================== */

@media print {
  /* Light theme for printing */
  body {
    background: white !important;
    color: black !important;
    font-size: 11pt;
    padding: 0;
  }

  .container {
    max-width: 100%;
  }

  /* Hide interactive elements */
  .tab-nav,
  .tab-input,
  .edit-btn,
  .delete-btn,
  .add-expense-btn,
  .new-scenario-btn,
  .export-actions,
  .nav-btn,
  .reset-btn,
  button:not(.print-include),
  dialog,
  .calendar-section,
  .panel-calendar,
  .panel-expenses,
  .panel-details,
  [role="tooltip"] {
    display: none !important;
  }

  /* Show only scenarios panel */
  .tab-panel {
    display: block !important;
  }

  .panel-scenarios {
    display: block !important;
  }

  /* Dashboard header adjustments */
  .dashboard-header {
    border-bottom: 2px solid #333;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
  }

  .dashboard-title {
    color: black;
    font-size: 16pt;
  }

  .dashboard-subtitle {
    color: #666;
  }

  /* Scenario cards in print grid */
  .scenario-cards {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
    overflow: visible !important;
  }

  .scenario-card {
    background: white !important;
    border: 1px solid #ccc !important;
    color: black !important;
    page-break-inside: avoid;
    padding: 0.75rem;
    flex: none !important;
  }

  .scenario-card.optimal {
    border: 2px solid #333 !important;
    background: #f5f5f5 !important;
  }

  .optimal-badge {
    background: #333 !important;
    color: white !important;
  }

  /* Metrics in print */
  .metric .label,
  .metric .value {
    color: black !important;
  }

  .metric.highlight .value {
    color: black !important;
    font-weight: 700;
  }

  /* Comparison table for print */
  .comparison-container {
    overflow: visible !important;
    border: 1px solid #ccc !important;
  }

  .comparison-table {
    width: 100% !important;
  }

  .comparison-table th,
  .comparison-table td {
    position: static !important;
    background: white !important;
    color: black !important;
    border: 1px solid #ddd !important;
    padding: 0.4rem !important;
    font-size: 9pt;
  }

  .comparison-table thead th {
    background: #f0f0f0 !important;
    font-weight: 700;
  }

  .comparison-table td.optimal {
    background: #e8f5e9 !important;
    font-weight: 700;
  }

  /* Color classes in print */
  .value-positive,
  .value-negative,
  .value-warning {
    color: black !important;
  }

  /* Page settings */
  @page {
    margin: 1cm;
    size: landscape;
  }
}
```

Add export actions bar below the comparison table header. In the Scenarios panel HTML, add immediately after the scenario-cards container (before comparison-container):

```html
<div class="export-actions">
  <button onclick="copyTableToClipboard()" class="secondary-btn">
    Copy to Clipboard
  </button>
  <button onclick="window.print()" class="secondary-btn">
    Print / PDF
  </button>
</div>
```

Add CSS for export actions:

```css
/* Export actions bar */
.export-actions {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
  justify-content: flex-end;
}

.export-actions button {
  font-size: var(--size-small);
  padding: 0.4rem 0.75rem;
}
```

Add clipboard copy function:

```javascript
async function copyTableToClipboard() {
  const table = document.querySelector('.comparison-table');
  if (!table) {
    showNotification('No comparison data to copy', 'error');
    return;
  }

  const rows = Array.from(table.querySelectorAll('tr'));
  const text = rows.map(row => {
    const cells = Array.from(row.querySelectorAll('th, td'));
    return cells.map(cell => {
      // Get text content, stripping tooltips
      const clone = cell.cloneNode(true);
      clone.querySelectorAll('[role="tooltip"]').forEach(t => t.remove());
      return clone.textContent.trim();
    }).join('\t');
  }).join('\n');

  try {
    await navigator.clipboard.writeText(text);
    showNotification('Copied to clipboard!');
  } catch (err) {
    console.error('Clipboard write failed:', err);
    showNotification('Copy failed - try again', 'error');
  }
}
```

Reuse the existing showNotification function from Phase 4 (calendar exports). If it doesn't exist, add:

```javascript
function showNotification(message, type = 'success') {
  const existing = document.querySelector('.notification');
  if (existing) existing.remove();

  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  notification.style.cssText = `
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    padding: 0.75rem 1.5rem;
    border-radius: 6px;
    background: ${type === 'error' ? 'var(--negative)' : 'var(--accent)'};
    color: var(--bg);
    font-weight: 500;
    z-index: 10000;
    animation: slideIn 0.3s ease;
  `;
  document.body.appendChild(notification);

  setTimeout(() => {
    notification.style.opacity = '0';
    notification.style.transition = 'opacity 0.3s';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}
```
  </action>
  <verify>
1. Click "Copy to Clipboard" - notification appears confirming copy. Paste in Excel/Sheets - table data appears tab-separated.
2. Click "Print / PDF" - print preview shows light background, no interactive elements, comparison table fits on page.
3. Print preview shows scenarios in 3-column grid, optimal scenario has darker border.
  </verify>
  <done>
Export actions bar with Copy and Print buttons. Clipboard copy works with notification feedback. Print stylesheet produces clean light-theme output suitable for PDF.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement Responsive Mobile Layout</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add responsive CSS for mobile view:

```css
/* ===========================================
   PHASE 5: RESPONSIVE DESIGN (UI-08)
   =========================================== */

/* Tablet breakpoint */
@media (max-width: 900px) {
  .container {
    padding: 1rem;
  }

  .scenario-cards {
    gap: 0.75rem;
  }

  .scenario-card {
    flex: 0 0 280px;
  }

  .dialog-body {
    grid-template-columns: 1fr;
  }
}

/* Mobile breakpoint */
@media (max-width: 600px) {
  body {
    padding: 0.5rem;
  }

  .dashboard-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }

  .dashboard-title {
    font-size: 1.25rem;
  }

  /* Stack tabs vertically on very small screens */
  .tab-nav {
    flex-wrap: wrap;
    gap: 0;
  }

  .tab-label {
    padding: 0.5rem 1rem;
    font-size: var(--size-small);
    flex: 1 1 50%;
    text-align: center;
    border-bottom: none;
    border-right: 1px solid rgba(255,255,255,0.1);
  }

  .tab-label:nth-child(2n) {
    border-right: none;
  }

  /* Scenario cards full width */
  .scenario-cards {
    flex-direction: column;
    overflow-x: visible;
  }

  .scenario-card {
    flex: none;
    width: 100%;
  }

  /* Hide horizontal comparison table on mobile */
  .comparison-container {
    display: none;
  }

  /* Show vertical comparison blocks on mobile */
  .comparison-mobile {
    display: block;
  }

  /* Export actions stack */
  .export-actions {
    flex-direction: column;
  }

  .export-actions button {
    width: 100%;
  }

  /* Calendar adjustments */
  .calendar-grid {
    gap: 1px;
  }

  .day-cell {
    min-height: 45px;
    font-size: 0.8rem;
  }

  .status-emoji {
    font-size: 1rem;
  }

  /* Dialog full width on mobile */
  dialog {
    width: 100vw;
    max-width: 100vw;
    margin: 0;
    border-radius: 0;
  }
}
```

Add mobile comparison view HTML. First, add a placeholder div in the HTML immediately after the `.comparison-container` closing tag (inside the Scenarios panel):

```html
<!-- In panel-scenarios, after </div> of .comparison-container -->
<div class="comparison-mobile"></div>
```

Add the JavaScript function to render mobile comparison blocks:

```javascript
function renderMobileComparison(scenarios) {
  const container = document.createElement('div');
  container.className = 'comparison-mobile';

  scenarios.forEach(s => {
    const block = document.createElement('div');
    block.className = 'comparison-block' + (s.id === scenarios[0].id && s.leefgeld === Math.max(...scenarios.map(x => x.leefgeld)) ? ' optimal' : '');

    block.innerHTML = `
      <h4 class="block-title">${s.name}${s.isOptimal ? ' <span class="optimal-badge">Optimal</span>' : ''}</h4>
      <div class="block-metrics">
        <div class="block-row">
          <span class="label">Revenue</span>
          <span class="value value-positive">${formatEur(s.annualRevenue)}/yr</span>
        </div>
        <div class="block-row">
          <span class="label">Expenses</span>
          <span class="value value-negative">${formatEur(s.totalExpenses)}</span>
        </div>
        <div class="block-row">
          <span class="label">IRPF</span>
          <span class="value value-negative">${formatEur(s.irpfTotal)}</span>
        </div>
        <div class="block-row">
          <span class="label">RETA</span>
          <span class="value value-negative">${formatEur(s.retaAnnual)}</span>
        </div>
        <div class="block-row">
          <span class="label">Tax Rate</span>
          <span class="value">${(s.effectiveTaxRate * 100).toFixed(1)}%</span>
        </div>
        <div class="block-row">
          <span class="label">Net Income</span>
          <span class="value value-positive">${formatEur(s.netIncome)}</span>
        </div>
        <div class="block-row highlight">
          <span class="label">Leefgeld</span>
          <span class="value">${formatEur(s.leefgeld)}/mo</span>
        </div>
      </div>
    `;
    container.appendChild(block);
  });

  return container;
}
```

Add CSS for mobile comparison blocks:

```css
/* Mobile comparison blocks (hidden on desktop) */
.comparison-mobile {
  display: none;
}

.comparison-block {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1rem;
}

.comparison-block.optimal {
  border-color: var(--accent);
  background: rgba(74, 222, 128, 0.05);
}

.block-title {
  margin: 0 0 1rem 0;
  font-size: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.block-metrics {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.block-row {
  display: flex;
  justify-content: space-between;
  padding: 0.4rem 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.block-row:last-child {
  border-bottom: none;
}

.block-row .label {
  color: var(--text-muted);
}

.block-row .value {
  font-family: var(--font-mono);
}

.block-row.highlight {
  padding-top: 0.6rem;
  margin-top: 0.4rem;
  border-top: 1px solid rgba(255,255,255,0.1);
  border-bottom: none;
}

.block-row.highlight .value {
  color: var(--accent);
  font-weight: 600;
}
```

Update renderComparisonTable to also render mobile version. At the end of the renderComparisonTable function, add:

```javascript
// At end of renderComparisonTable function, add:
const mobileContainer = document.querySelector('.comparison-mobile');
if (mobileContainer) {
  mobileContainer.replaceWith(renderMobileComparison(selectedScenarios));
} else {
  // Fallback: insert after comparison-container if placeholder missing
  const comparisonContainer = document.querySelector('.comparison-container');
  if (comparisonContainer) {
    comparisonContainer.insertAdjacentElement(
      'afterend',
      renderMobileComparison(selectedScenarios)
    );
  }
}
```
  </action>
  <verify>
1. Resize browser to 600px width or less
2. Tabs should show in 2x2 grid
3. Scenario cards should stack vertically (full width)
4. Horizontal comparison table should be hidden
5. Vertical comparison blocks should appear (each scenario as its own section)
6. All functionality still works on mobile
  </verify>
  <done>
Responsive design works at mobile breakpoint (600px). Comparison table transposes to vertical blocks. Tabs adapt to smaller screens. Cards stack vertically. Dialog is full-width on mobile.
  </done>
</task>

</tasks>

<verification>
1. **Tooltips:**
   - Hover "IRPF" label - tooltip with explanation appears
   - Tab to term - tooltip appears on focus
   - Press Escape - tooltip closes
   - Hover tooltip content - stays visible

2. **Export:**
   - Click "Copy to Clipboard" - success notification, paste shows table data
   - Click "Print / PDF" - print preview shows light theme, clean layout
   - Print preview: scenarios in grid, no buttons/interactive elements

3. **Responsive:**
   - At 600px width: cards stack, tabs wrap, mobile comparison blocks visible
   - Comparison table hidden on mobile, blocks shown instead
   - Calendar still functional on mobile
</verification>

<success_criteria>
- [ ] TOOLTIPS constant defines 6+ technical terms
- [ ] .term-tooltip elements with role="tooltip" in HTML
- [ ] Tooltips show on :hover and :focus
- [ ] Escape key handler removes focus from tooltip triggers
- [ ] @media print stylesheet produces light theme
- [ ] copyTableToClipboard function uses navigator.clipboard.writeText
- [ ] HTML contains `<div class="comparison-mobile"></div>` placeholder after .comparison-container
- [ ] @media (max-width: 600px) shows .comparison-mobile, hides .comparison-container
- [ ] Mobile comparison blocks render with vertical layout
</success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard-ui/05-03-SUMMARY.md`
</output>
