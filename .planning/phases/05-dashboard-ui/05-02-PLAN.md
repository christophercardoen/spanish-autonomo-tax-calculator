---
phase: 05-dashboard-ui
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "Scenario cards show full breakdown with all major line items visible"
    - "Hovering a card produces visible lift and subtle glow effect"
    - "Clicking a scenario card opens detailed breakdown in a modal"
    - "First column of comparison table stays visible when scrolling horizontally"
    - "Positive values appear green, negative values appear red, warnings appear orange"
    - "Optimal values in comparison table are clearly highlighted"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Enhanced cards and sticky table"
      contains: "position: sticky"
  key_links:
    - from: ".comparison-table td:first-child"
      to: "position: sticky"
      via: "CSS left: 0"
      pattern: "first-child.*sticky.*left.*0"
    - from: ".scenario-card"
      to: "openDetailModal()"
      via: "onclick handler"
      pattern: "onclick.*openDetailModal"
---

<objective>
Enhance scenario cards with full breakdown preview and stronger hover effects. Implement click-to-expand for detailed breakdown. Add sticky first column to comparison table with proper z-index layering. Implement semantic color coding for values.

Purpose: Delivers UI-02 (card metrics), UI-03 (hover effects), UI-04 (click to expand for details), UI-06 (sticky column), UI-07 (color coding).
Output: Cards show all major metrics, clicking opens detail modal, table scrolls with sticky first column, values are color-coded.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-dashboard-ui/05-CONTEXT.md
@.planning/phases/05-dashboard-ui/05-RESEARCH.md
@autonomo_dashboard.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance Scenario Card Styling with Full Breakdown</name>
  <files>autonomo_dashboard.html</files>
  <action>
Update .scenario-card CSS for wider cards with stronger hover effects:

```css
/* Enhanced scenario cards per UI-02, UI-03 */
.scenario-card {
  flex: 0 0 320px;           /* Wider for full breakdown */
  scroll-snap-align: start;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px;
  padding: 1.25rem;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  cursor: pointer;           /* Indicate clickable */
}

.scenario-card:hover {
  transform: translateY(-4px);  /* More pronounced lift */
  box-shadow:
    0 8px 24px rgba(0,0,0,0.4),
    0 0 0 1px rgba(74, 222, 128, 0.2);  /* Subtle green glow */
}

/* Optimal scenario - Bloomberg green highlight */
.scenario-card.optimal {
  background: rgba(74, 222, 128, 0.08);
  border-color: rgba(74, 222, 128, 0.3);
}

.scenario-card.optimal:hover {
  box-shadow:
    0 8px 24px rgba(0,0,0,0.4),
    0 0 0 1px rgba(74, 222, 128, 0.4);  /* Stronger glow for optimal */
}
```

Update the card-metrics CSS for full breakdown display:

```css
/* Full breakdown metrics per CONTEXT.md */
.card-metrics {
  display: flex;
  flex-direction: column;
  gap: 0.4rem;
}

.metric {
  display: flex;
  justify-content: space-between;
  font-size: 0.85rem;
  padding: 0.2rem 0;
}

.metric .label {
  color: var(--text-muted);
}

.metric .value {
  font-family: var(--font-mono);
  font-size: var(--size-labels);
}

/* Divider for metric groups */
.metric.divider {
  padding: 0;
  margin: 0.4rem 0;
  border-top: 1px solid rgba(255,255,255,0.1);
}

/* Highlight row (leefgeld) */
.metric.highlight {
  padding: 0.4rem 0;
  margin-top: 0.4rem;
  border-top: 1px solid rgba(255,255,255,0.15);
}

.metric.highlight .value {
  color: var(--accent);
  font-weight: 600;
  font-size: var(--size-numbers);
}

/* Color-coded values per UI-07 */
.value-positive { color: var(--positive); }
.value-negative { color: var(--negative); }
.value-warning { color: var(--warning); }
```

Update the JavaScript renderScenarioCards function to show full breakdown. Find the existing card rendering and update to include more metrics:

In renderScenarioCards(), update the card HTML template to show full breakdown:

```javascript
// Inside the cardHtml string template, replace card-metrics with:
<div class="card-metrics">
  <div class="metric">
    <span class="label">Revenue</span>
    <span class="value value-positive">${formatEur(s.monthlyRevenue * 12)}/yr</span>
  </div>
  <div class="metric">
    <span class="label">Expenses</span>
    <span class="value value-negative">${formatEur(s.totalExpenses)}/yr</span>
  </div>
  <div class="metric divider"></div>
  <div class="metric">
    <span class="label">IRPF</span>
    <span class="value value-negative">${formatEur(s.irpfTotal)}</span>
  </div>
  <div class="metric">
    <span class="label">RETA</span>
    <span class="value value-negative">${formatEur(s.retaAnnual)}</span>
  </div>
  <div class="metric">
    <span class="label">Tax Rate</span>
    <span class="value">${(s.effectiveTaxRate * 100).toFixed(1)}%</span>
  </div>
  <div class="metric divider"></div>
  <div class="metric">
    <span class="label">Net Income</span>
    <span class="value value-positive">${formatEur(s.netIncome)}/yr</span>
  </div>
  <div class="metric">
    <span class="label">Monthly Net</span>
    <span class="value">${formatEur(s.monthlyNet)}</span>
  </div>
  <div class="metric highlight">
    <span class="label">Leefgeld</span>
    <span class="value">${formatEur(s.leefgeld)}/mo</span>
  </div>
</div>
```

Note: The existing renderScenarioCards function already has these values calculated. The key properties are: monthlyRevenue, totalExpenses, irpfTotal, retaAnnual, effectiveTaxRate, netIncome, monthlyNet, leefgeld.
  </action>
  <verify>
Open dashboard. Scenario cards should be wider (320px). Each card shows: Revenue, Expenses, IRPF, RETA, Tax Rate, Net Income, Monthly Net, Leefgeld. Hovering produces visible lift and green glow. Optimal card has stronger green background.
  </verify>
  <done>
Scenario cards display full breakdown with 8+ metrics. Hover produces lift (-4px) and green glow. Values are color-coded (positive green, negative red).
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Click-to-Expand Detail Modal (UI-04)</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add a detail modal for viewing full scenario breakdown when clicking a card. This is separate from the edit modal - it shows a read-only detailed view.

Add detail modal HTML (place outside the dashboard div, near other dialogs):

```html
<dialog id="detail-modal" class="detail-dialog">
  <div class="detail-content">
    <header class="detail-header">
      <h2 class="detail-title">Scenario Details</h2>
      <button class="close-btn" onclick="closeDetailModal()">&times;</button>
    </header>
    <div class="detail-body" id="detail-body">
      <!-- Populated by JavaScript -->
    </div>
    <footer class="detail-footer">
      <button class="secondary-btn" onclick="closeDetailModal()">Close</button>
      <button class="primary-btn" onclick="editFromDetail()">Edit Scenario</button>
    </footer>
  </div>
</dialog>
```

Add CSS for detail modal:

```css
/* Detail modal for scenario breakdown (UI-04) */
.detail-dialog {
  background: var(--bg);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px;
  padding: 0;
  max-width: 500px;
  width: 90%;
  color: var(--text);
}

.detail-dialog::backdrop {
  background: rgba(0,0,0,0.7);
}

.detail-content {
  padding: 1.5rem;
}

.detail-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.detail-title {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 600;
}

.detail-body {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.detail-section {
  background: rgba(255,255,255,0.03);
  border-radius: 8px;
  padding: 1rem;
}

.detail-section h4 {
  margin: 0 0 0.75rem 0;
  font-size: var(--size-labels);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
}

.detail-row {
  display: flex;
  justify-content: space-between;
  padding: 0.4rem 0;
  font-size: 0.9rem;
}

.detail-row .label {
  color: var(--text-muted);
}

.detail-row .value {
  font-family: var(--font-mono);
}

.detail-row.total {
  border-top: 1px solid rgba(255,255,255,0.1);
  margin-top: 0.5rem;
  padding-top: 0.75rem;
  font-weight: 600;
}

.detail-row.total .value {
  color: var(--accent);
}

.detail-footer {
  display: flex;
  gap: 1rem;
  margin-top: 1.5rem;
  padding-top: 1rem;
  border-top: 1px solid rgba(255,255,255,0.1);
}

.detail-footer button {
  flex: 1;
}
```

Add JavaScript for detail modal:

```javascript
let currentDetailScenarioId = null;

function openDetailModal(scenarioId) {
  const scenario = scenarios.find(s => s.id === scenarioId);
  if (!scenario) return;

  currentDetailScenarioId = scenarioId;
  const body = document.getElementById('detail-body');
  const dialog = document.getElementById('detail-modal');
  const title = dialog.querySelector('.detail-title');

  title.textContent = scenario.name + (scenario.isOptimal ? ' (Optimal)' : '');

  body.innerHTML = `
    <div class="detail-section">
      <h4>Income</h4>
      <div class="detail-row">
        <span class="label">Monthly Revenue</span>
        <span class="value">${formatEur(scenario.monthlyRevenue)}</span>
      </div>
      <div class="detail-row">
        <span class="label">Annual Revenue</span>
        <span class="value">${formatEur(scenario.annualRevenue)}</span>
      </div>
    </div>

    <div class="detail-section">
      <h4>Expenses</h4>
      <div class="detail-row">
        <span class="label">Spain Deductible</span>
        <span class="value value-negative">${formatEur(scenario.spainDeductible)}</span>
      </div>
      <div class="detail-row">
        <span class="label">Belgium Costs</span>
        <span class="value value-negative">${formatEur(scenario.belgiumCosts)}</span>
      </div>
      <div class="detail-row">
        <span class="label">Private Costs</span>
        <span class="value value-negative">${formatEur(scenario.privateCosts)}</span>
      </div>
      <div class="detail-row total">
        <span class="label">Total Expenses</span>
        <span class="value">${formatEur(scenario.totalExpenses)}</span>
      </div>
    </div>

    <div class="detail-section">
      <h4>Taxes</h4>
      <div class="detail-row">
        <span class="label">IRPF (Income Tax)</span>
        <span class="value value-negative">${formatEur(scenario.irpfTotal)}</span>
      </div>
      <div class="detail-row">
        <span class="label">RETA (Social Security)</span>
        <span class="value value-negative">${formatEur(scenario.retaAnnual)}</span>
      </div>
      <div class="detail-row">
        <span class="label">Effective Tax Rate</span>
        <span class="value">${(scenario.effectiveTaxRate * 100).toFixed(1)}%</span>
      </div>
    </div>

    <div class="detail-section">
      <h4>Net Result</h4>
      <div class="detail-row">
        <span class="label">Net Income (Annual)</span>
        <span class="value value-positive">${formatEur(scenario.netIncome)}</span>
      </div>
      <div class="detail-row">
        <span class="label">Monthly Net</span>
        <span class="value value-positive">${formatEur(scenario.monthlyNet)}</span>
      </div>
      <div class="detail-row total">
        <span class="label">Leefgeld (Disposable)</span>
        <span class="value">${formatEur(scenario.leefgeld)}/mo</span>
      </div>
    </div>
  `;

  dialog.showModal();
}

function closeDetailModal() {
  document.getElementById('detail-modal').close();
  currentDetailScenarioId = null;
}

function editFromDetail() {
  closeDetailModal();
  // Open the existing edit modal for this scenario
  if (currentDetailScenarioId && typeof openEditModal === 'function') {
    openEditModal(currentDetailScenarioId);
  }
}
```

Update renderScenarioCards to add onclick handler. Find the card div creation and add the onclick:

```javascript
// In renderScenarioCards(), update the card div to include onclick:
// Find: card.className = 'scenario-card' + ...
// After setting className, add:
card.onclick = (e) => {
  // Don't open detail if clicking edit button or checkbox
  if (e.target.closest('.edit-btn') || e.target.closest('input[type="checkbox"]')) return;
  openDetailModal(s.id);
};
```

Alternatively, if using innerHTML string approach:

```javascript
// Change the card div to include onclick attribute:
<div class="scenario-card${s.isOptimal ? ' optimal' : ''}" onclick="if(!event.target.closest('.edit-btn') && !event.target.closest('input')) openDetailModal('${s.id}')">
```
  </action>
  <verify>
Click on any scenario card (not on edit button or checkbox). Detail modal should open showing: Income section, Expenses section (with breakdown), Taxes section, Net Result section. Click "Close" to dismiss. Click "Edit Scenario" to transition to edit modal.
  </verify>
  <done>
Clicking scenario cards opens detail modal with full breakdown. Modal shows 4 sections: Income, Expenses, Taxes, Net Result. Edit button transitions to edit modal. UI-04 requirement satisfied.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement Sticky First Column on Comparison Table</name>
  <files>autonomo_dashboard.html</files>
  <action>
Update comparison table CSS to support horizontal scrolling with sticky first column. Per RESEARCH.md z-index layering strategy:

```css
/* Comparison container with horizontal scroll */
.comparison-container {
  margin-top: 2rem;
  overflow-x: auto;      /* Enable horizontal scroll */
  overflow-y: visible;   /* Let content expand vertically */
  max-width: 100%;
  background: rgba(255,255,255,0.02);
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.1);
}

/* Base table */
.comparison-table {
  width: max-content;    /* Allow table to exceed container */
  min-width: 100%;
  border-collapse: collapse;
  font-size: 0.9rem;
}

/* Sticky header row - z-index: 100 */
.comparison-table thead th {
  position: sticky;
  top: 0;
  background: var(--bg);
  z-index: 100;
  border-bottom: 2px solid var(--accent);
  padding: 0.75rem 1rem;
  text-align: right;
  font-weight: 600;
  white-space: nowrap;
}

/* Sticky first column (metric names) - z-index: 99 */
.comparison-table tbody td:first-child,
.comparison-table thead th:first-child {
  position: sticky;
  left: 0;
  z-index: 99;
  background: var(--bg);
  min-width: 180px;
  text-align: left;
}

/* Corner cell (sticky both directions) - z-index: 101 */
.comparison-table thead th:first-child {
  z-index: 101;
}

/* Ensure background covers content when scrolling */
.comparison-table tbody td:first-child::after,
.comparison-table thead th:first-child::after {
  content: '';
  position: absolute;
  right: 0;
  top: 0;
  bottom: 0;
  width: 1px;
  background: rgba(255,255,255,0.1);
}

/* Regular cells */
.comparison-table tbody td {
  padding: 0.5rem 1rem;
  text-align: right;
  font-family: var(--font-mono);
  border-bottom: 1px solid rgba(255,255,255,0.05);
  white-space: nowrap;
}

.comparison-table tbody td:first-child {
  font-family: var(--font-ui);
  color: var(--text-muted);
}
```

Update scrollbar styling for horizontal scroll:

```css
/* Horizontal scrollbar for comparison */
.comparison-container::-webkit-scrollbar {
  height: 8px;
}

.comparison-container::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.05);
  border-radius: 4px;
}

.comparison-container::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.2);
  border-radius: 4px;
}

.comparison-container::-webkit-scrollbar-thumb:hover {
  background: rgba(255,255,255,0.3);
}
```

Also update the JavaScript renderComparisonTable function to apply color classes based on value semantics.

Find the metrics array in renderComparisonTable. Update each metric definition to include a valueClass based on type:

```javascript
const metrics = [
  { label: 'Revenue (monthly)', key: 'monthlyRevenue', fmt: formatEur, valueClass: 'value-positive' },
  { label: 'Revenue (annual)', key: 'annualRevenue', fmt: formatEur, valueClass: 'value-positive' },
  { label: 'Spain Deductible', key: 'spainDeductible', fmt: formatEur, valueClass: '' },
  { label: 'Belgium Costs', key: 'belgiumCosts', fmt: formatEur, valueClass: '' },
  { label: 'Total Expenses', key: 'totalExpenses', fmt: formatEur, valueClass: 'value-negative' },
  { divider: true },
  { label: 'RETA Annual', key: 'retaAnnual', fmt: formatEur, valueClass: 'value-negative' },
  { label: 'IRPF Total', key: 'irpfTotal', fmt: formatEur, valueClass: 'value-negative' },
  { label: 'Effective Tax Rate', key: 'effectiveTaxRate', fmt: v => (v * 100).toFixed(1) + '%', valueClass: '', optimalMin: true },
  { divider: true },
  { label: 'Net Income (annual)', key: 'netIncome', fmt: formatEur, valueClass: 'value-positive' },
  { label: 'Monthly Net', key: 'monthlyNet', fmt: formatEur, valueClass: 'value-positive' },
  { label: 'Private Costs', key: 'privateCosts', fmt: formatEur, valueClass: 'value-negative' },
  { label: 'Leefgeld', key: 'leefgeld', fmt: formatEur, highlight: true, optimalMax: true, valueClass: '' }
];
```

In the cell rendering loop, apply the valueClass in addition to the existing optimal class:

```javascript
// When rendering cells, add both optimal class AND valueClass
const cellClasses = [];
if (isOptimal) cellClasses.push('optimal');
if (metric.valueClass) cellClasses.push(metric.valueClass);
const classAttr = cellClasses.length ? ` class="${cellClasses.join(' ')}"` : '';

// td element: <td${classAttr}>${metric.fmt(s[metric.key])}</td>
```

Also add CSS for color classes in comparison table:

```css
/* Color-coded values in comparison table */
.comparison-table .value-positive { color: var(--positive); }
.comparison-table .value-negative { color: var(--negative); }
.comparison-table .value-warning { color: var(--warning); }

/* Optimal overrides color */
.comparison-table td.optimal {
  color: var(--accent);
  font-weight: 700;
}
```
  </action>
  <verify>
With 3+ scenarios selected, comparison table should be scrollable horizontally. Scroll right - the first column (Metric names) should stay fixed. The corner cell (top-left) should always be visible. No visual glitches when scrolling (no transparent overlaps). Revenue/income values should be green. IRPF, RETA, expense values should be red. Optimal cells should have accent green and bold.
  </verify>
  <done>
Comparison table has horizontal scroll. First column (metric names) is sticky with proper z-index (99). Header is sticky (z-index 100). Corner cell has z-index 101. Values are color-coded: positive (green), negative (red). Optimal values remain highlighted.
  </done>
</task>

</tasks>

<verification>
1. Scenario cards are 320px wide with full metric breakdown
2. Hovering cards produces -4px lift and green glow shadow
3. Clicking cards opens detail modal with 4 sections (Income, Expenses, Taxes, Net Result)
4. Detail modal "Edit Scenario" button opens edit modal
5. Optimal card has green-tinted background
6. Comparison table scrolls horizontally when content overflows
7. First column stays fixed during horizontal scroll
8. Revenue/income values are green, expense/tax values are red
9. Optimal values in table are highlighted green + bold
</verification>

<success_criteria>
- [ ] .scenario-card is 320px width with 8+ visible metrics
- [ ] Hover produces transform: translateY(-4px) and box-shadow with green glow
- [ ] Cards have cursor: pointer and onclick handler
- [ ] Detail modal (#detail-modal) exists with 4 sections
- [ ] openDetailModal() and closeDetailModal() functions exist
- [ ] .comparison-table td:first-child has position: sticky; left: 0
- [ ] Z-index hierarchy: 99 (first column), 100 (header), 101 (corner)
- [ ] .value-positive, .value-negative, .value-warning classes defined
- [ ] Existing functionality preserved (scenario selection, edit modal, etc.)
</success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard-ui/05-02-SUMMARY.md`
</output>
