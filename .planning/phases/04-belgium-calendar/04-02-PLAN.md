---
phase: 04-belgium-calendar
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "User can click any day to open status picker modal"
    - "Modal shows day details (date, day of week, contracted status)"
    - "User can set day status to Belgium, Spain, Travel, or Unset"
    - "Monthly count displays Belgium days for current month"
    - "Annual count displays total Belgium + Travel days across Feb-Dec"
    - "Warning banner appears at 170 (yellow), 180 (orange), 183+ (red) days"
    - "Shift-click selects range of days for bulk status change"
    - "Save button commits changes, Cancel reverts to previous state"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Day picker dialog, counting logic, warning display, bulk selection"
      contains: "dayPickerDialog"
  key_links:
    - from: "day-cell click"
      to: "dayPickerDialog"
      via: "openDayPicker function"
      pattern: "onclick.*openDayPicker"
    - from: "calculateCounts"
      to: "warning banner"
      via: "getWarningLevel function"
      pattern: "WARNING_THRESHOLDS"
---

<objective>
Implement day interaction, counting system, and warning thresholds for Belgium calendar.

Purpose: Core UX for tracking and managing Belgium presence days with 183-day threshold awareness.
Output: Clickable days with status picker, real-time counts, tiered warnings, and bulk selection.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-belgium-calendar/04-CONTEXT.md
@.planning/phases/04-belgium-calendar/04-RESEARCH.md
@.planning/phases/04-belgium-calendar/04-01-SUMMARY.md
@autonomo_dashboard.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Day Picker Dialog and Status Setting</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add day status picker dialog and interaction:

1. Add dialog HTML (after contractedWizardDialog):
```html
<dialog id="dayPickerDialog">
  <div class="dialog-header">
    <h2 id="pickerDateDisplay">February 15, 2026</h2>
    <button type="button" class="dialog-close" onclick="closeDayPicker()">x</button>
  </div>
  <div style="padding: 1.5rem;">
    <p id="pickerContracted" style="opacity: 0.7; margin-bottom: 1rem;">Contracted work day</p>

    <div class="status-options">
      <label class="status-option">
        <input type="radio" name="dayStatus" value="belgium">
        <span class="status-emoji-large">flag_be</span>
        <span>Belgium</span>
      </label>
      <label class="status-option">
        <input type="radio" name="dayStatus" value="spain">
        <span class="status-emoji-large">flag_es</span>
        <span>Spain</span>
      </label>
      <label class="status-option">
        <input type="radio" name="dayStatus" value="travel">
        <span class="status-emoji-large">airplane</span>
        <span>Travel</span>
      </label>
      <label class="status-option">
        <input type="radio" name="dayStatus" value="unset">
        <span class="status-emoji-large">circle</span>
        <span>Unset</span>
      </label>
    </div>

    <div class="picker-counts" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
      <p id="pickerMonthCount" style="opacity: 0.8;">12 days in Belgium this month</p>
      <p id="pickerAnnualCount" style="opacity: 0.8;">45 days in Belgium (annual)</p>
    </div>
  </div>
  <div class="dialog-footer">
    <div class="spacer"></div>
    <button class="secondary-btn" onclick="closeDayPicker()">Cancel</button>
    <button class="primary-btn" onclick="saveDayStatus()">Save</button>
  </div>
</dialog>
```

2. Add CSS for status options:
```css
.status-options {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.75rem;
}

.status-option {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 4px;
  cursor: pointer;
  transition: border-color 0.2s;
}

.status-option:hover {
  border-color: var(--accent);
}

.status-option input[type="radio"] {
  accent-color: var(--accent);
}

.status-emoji-large {
  font-size: 1.5rem;
}
```
Note: Replace emoji placeholders with actual emojis (flag_be = Unicode Belgium flag, etc.)

3. Add JavaScript functions:
- `openDayPicker(dateKey)`:
  - Store dateKey in dialog.dataset.dateKey
  - Set date display using Intl.DateTimeFormat (weekday, day, month, year)
  - Show contracted status text
  - Set radio button to current status (default 'unset')
  - Update count displays
  - Call dialog.showModal()

- `saveDayStatus()`:
  - Get selected radio value
  - Update calendarState.days[dateKey].status
  - Preserve contracted flag if exists
  - DO NOT call saveCalendarState() yet (wait for explicit save)
  - Mark state as dirty (add unsavedChanges flag to calendarState)
  - Close dialog, re-render calendar, update counts

- `closeDayPicker()`:
  - Simply close dialog without saving

4. Update day-cell click handler in renderCalendar():
```javascript
onclick="openDayPicker('${dateKey}')"
```
  </action>
  <verify>
1. Click any day cell: Dialog opens showing correct date
2. Dialog shows contracted status for Mon/Tue/first-week Wed-Fri
3. Select Belgium and click Save: Day shows Belgium flag
4. Click same day, select Spain: Changes to Spain flag
5. Select Unset: Day clears (no emoji)
  </verify>
  <done>
Day picker dialog opens on click, shows date and contracted status, allows setting Belgium/Spain/Travel/Unset. Changes reflect in calendar grid immediately.
  </done>
</task>

<task type="auto">
  <name>Task 2: Counting System and Warning Thresholds</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add counting logic and warning display:

1. Add warning threshold constants:
```javascript
const WARNING_THRESHOLDS = Object.freeze({
  YELLOW: 170,
  ORANGE: 180,
  RED: 183
});
```

2. Add counting functions:
```javascript
function calculateCounts() {
  const days = calendarState.days;
  let monthBelgium = 0, monthTravel = 0, monthSpain = 0;
  let annualBelgium = 0, annualTravel = 0, annualSpain = 0;

  const currentMonth = calendarState.currentMonth;
  const year = calendarState.year;

  Object.entries(days).forEach(([dateKey, data]) => {
    const [y, m] = dateKey.split('-').map(Number);
    if (y !== year) return;

    // Annual counts
    if (data.status === 'belgium') annualBelgium++;
    else if (data.status === 'travel') annualTravel++;
    else if (data.status === 'spain') annualSpain++;

    // Monthly counts (for current displayed month)
    if (m - 1 === currentMonth) {  // m is 1-indexed from ISO string
      if (data.status === 'belgium') monthBelgium++;
      else if (data.status === 'travel') monthTravel++;
      else if (data.status === 'spain') monthSpain++;
    }
  });

  return {
    monthBelgium, monthTravel, monthSpain,
    annualBelgium, annualTravel, annualSpain,
    annualThreshold: annualBelgium + annualTravel  // Conservative: both count
  };
}

function getWarningLevel(thresholdCount) {
  if (thresholdCount >= WARNING_THRESHOLDS.RED) return 'red';
  if (thresholdCount >= WARNING_THRESHOLDS.ORANGE) return 'orange';
  if (thresholdCount >= WARNING_THRESHOLDS.YELLOW) return 'yellow';
  return null;
}
```

3. Add count and warning display to calendar UI:
- Add HTML above calendar grid:
```html
<div class="calendar-stats">
  <div class="count-display">
    <span class="count-label">This month:</span>
    <span id="monthBelgiumCount" class="count-value">0</span> Belgium
  </div>
  <div class="count-display">
    <span class="count-label">Annual total:</span>
    <span id="annualBelgiumCount" class="count-value">0</span> Belgium + Travel
    <span id="warningBadge" class="warning-badge hidden"></span>
  </div>
</div>
<div id="warningBanner" class="warning-banner hidden"></div>
```

4. Add CSS for counts and warnings:
```css
.calendar-stats {
  display: flex;
  gap: 2rem;
  margin-bottom: 1rem;
  flex-wrap: wrap;
}

.count-display {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.count-label {
  opacity: 0.7;
}

.count-value {
  font-family: 'JetBrains Mono', monospace;
  font-weight: 600;
  font-size: 1.1rem;
}

.warning-badge {
  padding: 0.2rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 600;
}

.warning-badge.yellow { background: #facc15; color: #1a1a2e; }
.warning-badge.orange { background: #fb923c; color: #1a1a2e; }
.warning-badge.red { background: #f87171; color: #1a1a2e; }

.warning-banner {
  padding: 0.75rem 1rem;
  border-radius: 4px;
  margin-bottom: 1rem;
  font-weight: 500;
}

.warning-banner.yellow { background: rgba(250, 204, 21, 0.15); border: 1px solid #facc15; color: #facc15; }
.warning-banner.orange { background: rgba(251, 146, 60, 0.15); border: 1px solid #fb923c; color: #fb923c; }
.warning-banner.red { background: rgba(248, 113, 113, 0.15); border: 1px solid #f87171; color: #f87171; }

.warning-banner.hidden, .warning-badge.hidden { display: none; }
```

5. Add updateCountDisplays() function:
```javascript
function updateCountDisplays() {
  const counts = calculateCounts();

  document.getElementById('monthBelgiumCount').textContent = counts.monthBelgium;
  document.getElementById('annualBelgiumCount').textContent = counts.annualThreshold;

  const warningLevel = getWarningLevel(counts.annualThreshold);
  const badge = document.getElementById('warningBadge');
  const banner = document.getElementById('warningBanner');

  // Reset classes
  badge.className = 'warning-badge hidden';
  banner.className = 'warning-banner hidden';

  if (warningLevel) {
    badge.className = `warning-badge ${warningLevel}`;
    badge.textContent = warningLevel === 'red' ? 'EXCEEDED' : 'WARNING';

    banner.className = `warning-banner ${warningLevel}`;
    const messages = {
      yellow: `Approaching threshold: ${counts.annualThreshold} days in Belgium (183 triggers residency review)`,
      orange: `Very close to threshold: ${counts.annualThreshold} days in Belgium (183 triggers residency review)`,
      red: `Threshold exceeded: ${counts.annualThreshold} days in Belgium (exceeds 183-day limit)`
    };
    banner.textContent = messages[warningLevel];
  }
}
```

6. Call updateCountDisplays() after renderCalendar() and after saveDayStatus().
  </action>
  <verify>
1. Open calendar: Count displays show 0 / 0 initially (or contracted pattern count)
2. Set days to Belgium: Monthly count updates
3. Navigate months: Monthly count updates per month
4. Set 170+ Belgium days: Yellow warning appears
5. Set 180+ Belgium days: Orange warning
6. Set 183+ Belgium days: Red warning with "EXCEEDED" badge
7. Travel days also count toward threshold
  </verify>
  <done>
Monthly and annual counts display correctly. Warning thresholds trigger at 170/180/183 with appropriate colors. Belgium + Travel both count toward threshold (conservative approach).
  </done>
</task>

<task type="auto">
  <name>Task 3: Bulk Selection and Save Workflow</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add bulk selection (shift-click) and explicit save workflow:

1. Add selection state tracking:
```javascript
let lastClickedDate = null;
let selectedDates = new Set();
let unsavedChanges = false;
```

2. Update day-cell click handler for shift-click:
```javascript
function handleDayClick(dateKey, event) {
  if (event.shiftKey && lastClickedDate) {
    // Range selection
    selectDateRange(lastClickedDate, dateKey);
  } else {
    // Single selection
    selectedDates.clear();
    selectedDates.add(dateKey);
    lastClickedDate = dateKey;
    openDayPicker(dateKey);
  }
}
```

3. Add range selection function:
```javascript
function selectDateRange(start, end) {
  const startDate = new Date(start);
  const endDate = new Date(end);

  // Ensure start < end
  const [from, to] = startDate <= endDate
    ? [startDate, endDate]
    : [endDate, startDate];

  selectedDates.clear();
  const current = new Date(from);
  while (current <= to) {
    // Only include dates in valid range (Feb-Dec 2026)
    const month = current.getMonth();
    if (current.getFullYear() === 2026 && month >= 1 && month <= 11) {
      selectedDates.add(toISODateKey(current));
    }
    current.setDate(current.getDate() + 1);
  }

  // Open picker for bulk action
  openBulkPicker();
}
```

4. Add bulk picker dialog (modify existing or add new):
```html
<dialog id="bulkPickerDialog">
  <div class="dialog-header">
    <h2>Set Status for <span id="bulkCount">5</span> Days</h2>
    <button type="button" class="dialog-close" onclick="closeBulkPicker()">x</button>
  </div>
  <div style="padding: 1.5rem;">
    <p style="opacity: 0.7; margin-bottom: 1rem;">Apply status to all selected days:</p>
    <!-- Same status options as single picker -->
    <div class="status-options">
      <label class="status-option">
        <input type="radio" name="bulkStatus" value="belgium">
        <span class="status-emoji-large">emoji_be</span>
        <span>Belgium</span>
      </label>
      <!-- ... spain, travel, unset options ... -->
    </div>
  </div>
  <div class="dialog-footer">
    <div class="spacer"></div>
    <button class="secondary-btn" onclick="closeBulkPicker()">Cancel</button>
    <button class="primary-btn" onclick="saveBulkStatus()">Apply to All</button>
  </div>
</dialog>
```

5. Add CSS for selected days:
```css
.day-cell.selected {
  outline: 2px solid var(--accent);
  outline-offset: -2px;
}
```

6. Add global save button to calendar section:
```html
<div class="calendar-actions" style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: flex-end;">
  <span id="unsavedIndicator" class="unsaved-indicator hidden">Unsaved changes</span>
  <button id="saveCalendarBtn" class="primary-btn" onclick="commitCalendarChanges()" disabled>Save Calendar</button>
</div>
```

7. Add save workflow functions:
```javascript
function markUnsaved() {
  unsavedChanges = true;
  document.getElementById('unsavedIndicator').classList.remove('hidden');
  document.getElementById('saveCalendarBtn').disabled = false;
}

function commitCalendarChanges() {
  calendarState.lastModified = new Date().toISOString();
  saveCalendarState();
  unsavedChanges = false;
  document.getElementById('unsavedIndicator').classList.add('hidden');
  document.getElementById('saveCalendarBtn').disabled = true;
}
```

8. Update saveDayStatus() and saveBulkStatus() to call markUnsaved() instead of saveCalendarState().

9. Add CSS for unsaved indicator:
```css
.unsaved-indicator {
  color: #facc15;
  font-size: 0.9rem;
  align-self: center;
}
.unsaved-indicator.hidden { display: none; }
```

10. Update renderCalendar() to highlight selected dates.
  </action>
  <verify>
1. Click day A, shift-click day B: All days between A and B selected (highlighted)
2. Bulk picker opens showing count of selected days
3. Apply Belgium: All selected days show Belgium flag
4. "Unsaved changes" indicator appears
5. Click Save Calendar: Changes persist to localStorage
6. Refresh page: Changes still there
7. Make change, don't save, refresh: Changes lost (expected - allows experimentation)
  </verify>
  <done>
Shift-click enables range selection. Bulk picker applies status to multiple days. Explicit Save button commits changes to localStorage. Unsaved changes indicator shows pending state.
  </done>
</task>

</tasks>

<verification>
1. Open browser, navigate to calendar
2. Click a day: Single picker opens with correct date info
3. Set status, close: Day updates, unsaved indicator shows
4. Shift-click to select range: Multiple days highlighted
5. Bulk picker: Apply status to all selected
6. Save Calendar button: Changes persist
7. Test all warning levels (170, 180, 183+)
8. Test month navigation - counts update per month
</verification>

<success_criteria>
- CAL-01: Calendar displays Feb-Dec 2026 with clickable days (COMPLETE)
- CAL-02: Toggle days Belgium/Spain/Travel (COMPLETE)
- CAL-03: Auto-count per month (COMPLETE)
- CAL-04: Annual totals (COMPLETE)
- CAL-05: 183-day threshold warning (COMPLETE)
- Bulk selection via shift-click
- Save workflow allows experimentation before committing
</success_criteria>

<output>
After completion, create `.planning/phases/04-belgium-calendar/04-02-SUMMARY.md`
</output>
