---
phase: 04-belgium-calendar
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "Calendar displays Feb-Dec 2026 (11 months) with month navigation"
    - "User can navigate between months using prev/next buttons"
    - "Days display in correct Monday-start grid alignment"
    - "Contracted work pattern (Mon-Tue weekly, first-week Wed-Fri) pre-fills on wizard acceptance"
    - "Contracted days visually distinct from flexible days (badge indicator)"
    - "Calendar state persists in localStorage"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Calendar section with data structures, grid rendering, and contracted pattern"
      contains: "CALENDAR_STORAGE_KEY"
  key_links:
    - from: "calendarState"
      to: "localStorage"
      via: "saveCalendarState/loadCalendarState"
      pattern: "localStorage\\.setItem.*CALENDAR_STORAGE"
    - from: "generateContractedPattern"
      to: "calendarState.days"
      via: "applyContractedPattern function"
      pattern: "contractedDays.*forEach"
---

<objective>
Build calendar data system and month grid rendering for Feb-Dec 2026 Belgium presence tracking.

Purpose: Foundation for tracking 183-day tax residency threshold with contracted work pattern pre-fill.
Output: Navigable monthly calendar with day grid, contracted pattern wizard, and localStorage persistence.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-belgium-calendar/04-CONTEXT.md
@.planning/phases/04-belgium-calendar/04-RESEARCH.md
@autonomo_dashboard.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Calendar Data System with localStorage</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add calendar data structures and persistence in the JavaScript section:

1. Add constants after existing FISCAL_2025:
```javascript
const CALENDAR_STORAGE_KEY = 'autonomo_calendar_v1';

const DAY_STATUS = Object.freeze({
  UNSET: 'unset',
  BELGIUM: 'belgium',
  SPAIN: 'spain',
  TRAVEL: 'travel'
});

const DEFAULT_CALENDAR_STATE = Object.freeze({
  version: 1,
  year: 2026,
  startMonth: 1,  // February (0-indexed)
  endMonth: 11,   // December (0-indexed)
  days: {},       // { "2026-02-15": { status: "belgium", contracted: true } }
  contractedPatternApplied: false,
  lastModified: null,
  currentMonth: 1  // February (0-indexed) - for navigation
});
```

2. Add calendar state management functions:
- `loadCalendarState()` - Load from localStorage or return structuredClone of DEFAULT
- `saveCalendarState()` - Persist to localStorage with lastModified timestamp
- `toISODateKey(date)` - Convert Date to "YYYY-MM-DD" string
- `calendarState` variable initialized from loadCalendarState()

3. Follow existing patterns:
- Use Object.freeze() for constants (same as FISCAL_2025, SCENARIO_PRESETS)
- Use structuredClone() for mutable copies (same as expense/scenario patterns)
- Storage key includes version (same as autonomo_expenses_v1)
  </action>
  <verify>
Browser console: `calendarState` is defined, `calendarState.days` is an object, `saveCalendarState()` and `loadCalendarState()` exist as functions.
  </verify>
  <done>
Calendar data structure exists with localStorage persistence. State loads on page load and can be saved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Month Grid Rendering with Navigation</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add calendar section and grid rendering:

1. Add HTML section after scenario-section div (before footnotes):
```html
<div class="calendar-section">
  <h2>Belgium Calendar 2026</h2>
  <div id="calendarContainer">
    <!-- Populated by renderCalendar() -->
  </div>
</div>
```

2. Add CSS styles for calendar:
- `.calendar-section` - margin-top 2rem
- `.calendar-header` - flex with space-between, month name centered
- `.nav-btn` - navigation buttons styled like existing buttons
- `.calendar-grid` - CSS grid 7 columns for days
- `.day-header` - Mon/Tue/Wed/Thu/Fri/Sat/Sun headers, opacity 0.6
- `.day-cell` - clickable cell with hover state, min-height 60px
- `.day-cell.empty` - empty cells for padding, no background
- `.day-number` - day number in corner
- `.status-emoji` - centered emoji display
- Day status colors: belgium (blue tint), spain (green tint), travel (orange tint), unset (default)

3. Add JavaScript functions:
- `getMonthGrid(year, month)` - Returns 2D array of weeks, each week is 7 cells (Date or null)
  - Use Monday-start week: `(date.getDay() + 6) % 7` for column position
- `getStatusEmoji(status)` - Returns emoji: belgium='flag_be', spain='flag_es', travel='airplane'
- `renderCalendar()` - Renders current month grid with navigation
  - Shows month name using Intl.DateTimeFormat
  - Prev/Next buttons call navigateMonth(-1) / navigateMonth(1)
  - Disable prev when at Feb, disable next when at Dec
- `navigateMonth(delta)` - Updates currentMonth within bounds [1, 11], calls renderCalendar()

4. Call renderCalendar() in page initialization (after existing init code).
  </action>
  <verify>
Open browser: Calendar section visible, shows current month (February by default), prev/next navigation works, grid shows correct day alignment (Feb 1, 2026 is a Sunday, so first cell of week should be empty Mon-Sat, Sunday shows 1).
  </verify>
  <done>
Calendar grid renders with month navigation. Days display in correct Monday-start alignment. Navigation bounded to Feb-Dec 2026.
  </done>
</task>

<task type="auto">
  <name>Task 3: Contracted Pattern Wizard and Display</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add contracted pattern generation and first-time wizard:

1. Add contracted pattern function:
```javascript
function generateContractedPattern(year, startMonth, endMonth) {
  const contractedDays = [];
  for (let month = startMonth; month <= endMonth; month++) {
    const lastOfMonth = new Date(year, month + 1, 0);
    let isFirstWeek = true;

    for (let day = 1; day <= lastOfMonth.getDate(); day++) {
      const date = new Date(year, month, day);
      const dayOfWeek = date.getDay(); // 0=Sunday, 1=Monday, etc.

      // Monday (1) or Tuesday (2) = always contracted
      if (dayOfWeek === 1 || dayOfWeek === 2) {
        contractedDays.push(toISODateKey(date));
      }

      // First week: Wed(3), Thu(4), Fri(5) also contracted
      if (isFirstWeek && (dayOfWeek === 3 || dayOfWeek === 4 || dayOfWeek === 5)) {
        contractedDays.push(toISODateKey(date));
      }

      // End first week on Sunday (after first full week)
      if (dayOfWeek === 0 && day > 1) {
        isFirstWeek = false;
      }
    }
  }
  return contractedDays;
}
```

2. Add wizard dialog HTML (after editScenarioDialog):
```html
<dialog id="contractedWizardDialog">
  <div class="dialog-header">
    <h2>Apply Contracted Pattern?</h2>
    <button type="button" class="dialog-close" onclick="declineContractedPattern()">x</button>
  </div>
  <div style="padding: 1.5rem;">
    <p>Pre-fill calendar with your contracted work pattern?</p>
    <ul style="opacity: 0.8; margin: 1rem 0;">
      <li>Monday and Tuesday every week</li>
      <li>Wednesday-Friday of first week each month</li>
    </ul>
    <p style="font-size: 0.9rem; opacity: 0.7;">
      Belgian holidays are NOT auto-filled. You can override any day later.
    </p>
  </div>
  <div class="dialog-footer">
    <div class="spacer"></div>
    <button class="secondary-btn" onclick="declineContractedPattern()">Skip</button>
    <button class="primary-btn" onclick="applyContractedPattern()">Apply Pattern</button>
  </div>
</dialog>
```

3. Add wizard functions:
- `showContractedWizard()` - Shows dialog if contractedPatternApplied is false
- `applyContractedPattern()` - Generates pattern, marks days as belgium+contracted, saves, closes
- `declineContractedPattern()` - Sets contractedPatternApplied to true (so wizard doesn't show again), closes

4. Add contracted badge display:
- Update renderCalendar() to show small 'C' badge on contracted days
- Add CSS: `.contracted-badge` - small indicator in corner (font-size 10px, opacity 0.7)

5. Call showContractedWizard() after renderCalendar() in page init IF contractedPatternApplied is false.
  </action>
  <verify>
1. Clear localStorage and refresh: Wizard appears asking to apply pattern
2. Click "Apply Pattern": Calendar shows Belgium flag on Mon/Tue and first-week Wed-Fri
3. Contracted days show 'C' badge
4. Refresh page: Wizard does not appear again, pattern persists
5. Click "Skip" on fresh state: Wizard doesn't appear on next refresh
  </verify>
  <done>
Contracted work pattern generates correctly. First-time wizard allows user to apply or skip. Contracted days display 'C' badge. State persists across sessions.
  </done>
</task>

</tasks>

<verification>
1. Open browser, navigate to calendar section
2. Verify Feb 2026 displays with correct day alignment
3. Navigate through all months (Feb-Dec) using prev/next
4. Clear localStorage, refresh - wizard appears
5. Apply pattern - Mon/Tue marked Belgium with C badge
6. First-week Wed-Fri also marked with C badge
7. Refresh - state persists, wizard does not reappear
</verification>

<success_criteria>
- CAL-01: Calendar displays Feb-Dec 2026 (PARTIAL - grid renders, click handler in Plan 02)
- CAL-06: Contracted pattern pre-fills (COMPLETE)
- CAL-07: Contracted days visually distinct (COMPLETE)
- localStorage persistence works across sessions
</success_criteria>

<output>
After completion, create `.planning/phases/04-belgium-calendar/04-01-SUMMARY.md`
</output>
