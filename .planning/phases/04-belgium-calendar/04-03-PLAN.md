---
phase: 04-belgium-calendar
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "User can export calendar to ICS file (importable to Google Calendar, Outlook)"
    - "User can export calendar to CSV file"
    - "User can copy summary to clipboard"
    - "Entry/exit day warning explains that these days count in BOTH countries"
    - "Export includes status and contracted flag for each marked day"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Export functions (ICS, CSV, clipboard) and entry/exit documentation"
      contains: "generateICS"
  key_links:
    - from: "export buttons"
      to: "Blob download"
      via: "URL.createObjectURL"
      pattern: "createObjectURL.*Blob"
    - from: "copy button"
      to: "clipboard API"
      via: "navigator.clipboard.writeText"
      pattern: "navigator\\.clipboard\\.writeText"
---

<objective>
Implement calendar export functionality (ICS, CSV, clipboard) and entry/exit day documentation.

Purpose: Allow users to export calendar data to external apps and understand entry/exit day counting rules.
Output: Working export buttons for ICS/CSV/clipboard, plus info tooltip about entry/exit days.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-belgium-calendar/04-CONTEXT.md
@.planning/phases/04-belgium-calendar/04-RESEARCH.md
@.planning/phases/04-belgium-calendar/04-01-SUMMARY.md
@.planning/phases/04-belgium-calendar/04-02-SUMMARY.md
@autonomo_dashboard.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: ICS and CSV Export</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add ICS and CSV export functionality:

1. Add export buttons to calendar section (in calendar-actions div or new export section):
```html
<div class="export-section" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
  <h4 style="margin: 0 0 0.75rem 0; opacity: 0.8;">Export Calendar</h4>
  <div class="export-buttons">
    <button class="secondary-btn" onclick="downloadICS()">
      <span style="margin-right: 0.5rem;">calendar_icon</span>
      Export ICS
    </button>
    <button class="secondary-btn" onclick="downloadCSV()">
      <span style="margin-right: 0.5rem;">spreadsheet_icon</span>
      Export CSV
    </button>
    <button class="secondary-btn" onclick="copyToClipboard()">
      <span style="margin-right: 0.5rem;">clipboard_icon</span>
      Copy Summary
    </button>
  </div>
</div>
```
Note: Replace icon placeholders with appropriate Unicode symbols or text.

2. Add CSS for export section:
```css
.export-buttons {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.export-buttons button {
  display: flex;
  align-items: center;
}
```

3. Add ICS generation function (follows RFC 5545):
```javascript
function generateICS() {
  const events = Object.entries(calendarState.days)
    .filter(([_, data]) => data.status && data.status !== 'unset')
    .map(([dateKey, data]) => {
      const date = new Date(dateKey);
      const nextDay = new Date(date);
      nextDay.setDate(nextDay.getDate() + 1);

      const statusText = {
        belgium: 'Belgium Work Day',
        spain: 'Spain',
        travel: 'Travel Day'
      }[data.status];

      const contractedNote = data.contracted ? ' (Contracted)' : '';

      // ICS format for all-day events
      return `BEGIN:VEVENT
UID:${dateKey}-autonomo@tax-calculator
DTSTAMP:${formatICSTimestamp(new Date())}
DTSTART;VALUE=DATE:${dateKey.replace(/-/g, '')}
DTEND;VALUE=DATE:${toISODateKey(nextDay).replace(/-/g, '')}
SUMMARY:${statusText}${contractedNote}
DESCRIPTION:${statusText} - Autonomo Tax Calculator Belgium Tracking
END:VEVENT`;
    });

  return `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Autonomo Tax Calculator//Belgium Calendar//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:Belgium Work Calendar 2026
${events.join('\n')}
END:VCALENDAR`;
}

function formatICSTimestamp(date) {
  return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
}

function downloadICS() {
  const ics = generateICS();
  const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = 'belgium-calendar-2026.ics';
  document.body.appendChild(a);
  a.click();

  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
```

4. Add CSV generation function:
```javascript
function generateCSV() {
  const headers = ['Date', 'Day of Week', 'Status', 'Contracted', 'Month'];
  const rows = Object.entries(calendarState.days)
    .filter(([_, data]) => data.status && data.status !== 'unset')
    .sort(([a], [b]) => a.localeCompare(b))
    .map(([dateKey, data]) => {
      const date = new Date(dateKey);
      return [
        dateKey,
        date.toLocaleDateString('en-GB', { weekday: 'long' }),
        data.status,
        data.contracted ? 'Yes' : 'No',
        date.toLocaleDateString('en-GB', { month: 'long' })
      ];
    });

  // Add summary rows at bottom
  const counts = calculateCounts();
  const summaryRows = [
    [],  // Empty row
    ['SUMMARY'],
    ['Total Belgium Days', counts.annualBelgium],
    ['Total Travel Days', counts.annualTravel],
    ['Total Spain Days', counts.annualSpain],
    ['Combined (Belgium + Travel)', counts.annualThreshold],
    ['183-day Threshold', counts.annualThreshold >= 183 ? 'EXCEEDED' : 'OK']
  ];

  const allRows = [headers, ...rows, ...summaryRows];
  return allRows.map(row => row.map(escapeCSVField).join(',')).join('\n');
}

function escapeCSVField(value) {
  if (value == null) return '';
  const str = String(value);
  if (str.search(/("|,|\n)/g) >= 0) {
    return '"' + str.replace(/"/g, '""') + '"';
  }
  return str;
}

function downloadCSV() {
  const csv = generateCSV();
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = 'belgium-calendar-2026.csv';
  document.body.appendChild(a);
  a.click();

  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
```
  </action>
  <verify>
1. Click "Export ICS": File downloads as belgium-calendar-2026.ics
2. Import ICS to Google Calendar: Events appear correctly as all-day events
3. Click "Export CSV": File downloads as belgium-calendar-2026.csv
4. Open CSV in Excel/Numbers: Data displays correctly with headers and summary
5. Only marked days (not unset) appear in exports
6. Contracted flag correctly shows Yes/No in CSV
  </verify>
  <done>
ICS export generates valid iCalendar file importable to Google Calendar/Outlook. CSV export includes all marked days plus summary statistics. Both downloads trigger correctly via Blob API.
  </done>
</task>

<task type="auto">
  <name>Task 2: Clipboard Copy and Notification</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add clipboard copy functionality with user feedback:

1. Add notification element to page (near top of body or in calendar section):
```html
<div id="notification" class="notification hidden"></div>
```

2. Add notification CSS:
```css
.notification {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  padding: 0.75rem 1.5rem;
  border-radius: 4px;
  font-size: 0.9rem;
  z-index: 1000;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    transform: translateY(1rem);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.notification.success {
  background: rgba(74, 222, 128, 0.2);
  border: 1px solid var(--accent);
  color: var(--accent);
}

.notification.error {
  background: rgba(248, 113, 113, 0.2);
  border: 1px solid #f87171;
  color: #f87171;
}

.notification.hidden {
  display: none;
}
```

3. Add notification function:
```javascript
function showNotification(message, type = 'success') {
  const notification = document.getElementById('notification');
  notification.textContent = message;
  notification.className = `notification ${type}`;

  // Auto-hide after 3 seconds
  setTimeout(() => {
    notification.classList.add('hidden');
  }, 3000);
}
```

4. Add clipboard copy function:
```javascript
async function copyToClipboard() {
  const counts = calculateCounts();
  const warningLevel = getWarningLevel(counts.annualThreshold);
  const warningText = warningLevel
    ? `\nWARNING: ${counts.annualThreshold >= 183 ? 'THRESHOLD EXCEEDED' : 'Approaching threshold'}`
    : '';

  const summary = `Belgium Calendar 2026 Summary
============================
Total Belgium days: ${counts.annualBelgium}
Total Travel days: ${counts.annualTravel}
Total Spain days: ${counts.annualSpain}
Combined (Belgium + Travel): ${counts.annualThreshold}
183-day threshold status: ${counts.annualThreshold >= 183 ? 'EXCEEDED' : 'OK'}${warningText}

Monthly Breakdown:
${generateMonthlyBreakdown()}

Note: Entry and exit days may count in BOTH Belgium and Spain.
Generated by Autonomo Tax Calculator`;

  try {
    await navigator.clipboard.writeText(summary);
    showNotification('Summary copied to clipboard!');
  } catch (err) {
    console.error('Clipboard write failed:', err);
    showNotification('Copy failed - please try again', 'error');
  }
}

function generateMonthlyBreakdown() {
  const months = ['Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  const breakdown = [];

  for (let m = 1; m <= 11; m++) {  // Feb(1) to Dec(11)
    let belgium = 0, travel = 0, spain = 0;

    Object.entries(calendarState.days).forEach(([dateKey, data]) => {
      const month = parseInt(dateKey.split('-')[1], 10) - 1;  // Convert to 0-indexed
      if (month === m) {
        if (data.status === 'belgium') belgium++;
        else if (data.status === 'travel') travel++;
        else if (data.status === 'spain') spain++;
      }
    });

    if (belgium + travel + spain > 0) {
      breakdown.push(`  ${months[m - 1]}: ${belgium} BE, ${travel} Travel, ${spain} ES`);
    }
  }

  return breakdown.length > 0 ? breakdown.join('\n') : '  No days marked yet';
}
```
  </action>
  <verify>
1. Click "Copy Summary": Notification shows "Summary copied to clipboard!"
2. Paste in text editor: Summary text appears with correct counts
3. Summary includes monthly breakdown
4. Warning text appears if threshold approached/exceeded
5. Entry/exit note included in summary
6. Notification auto-hides after 3 seconds
  </verify>
  <done>
Clipboard copy generates formatted text summary with counts and monthly breakdown. Notification provides visual feedback. Entry/exit day note included.
  </done>
</task>

<task type="auto">
  <name>Task 3: Entry/Exit Day Warning Documentation</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add entry/exit day information using existing tooltip pattern:

1. Add info icon and tooltip near the annual count display:
```html
<div class="count-display">
  <span class="count-label">Annual total:</span>
  <span id="annualBelgiumCount" class="count-value">0</span> Belgium + Travel
  <span class="source-hint" data-tooltip="Entry and exit days (travel days between Belgium and Spain) may be counted by BOTH countries' tax authorities. This calculator counts Travel days toward the 183-day threshold as a conservative approach. Art. 4 Spain-Belgium tax treaty applies for tie-breaker.">?</span>
  <span id="warningBadge" class="warning-badge hidden"></span>
</div>
```

2. Add Belgian holidays reference section (collapsible):
```html
<details class="holidays-reference" style="margin-top: 1rem;">
  <summary style="cursor: pointer; opacity: 0.8;">Belgian Public Holidays 2026 (Reference)</summary>
  <div style="padding: 1rem 0; font-size: 0.9rem; opacity: 0.8;">
    <p style="margin-bottom: 0.5rem;">These are NOT auto-marked. Mark manually if you're in Belgium:</p>
    <ul style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">
      <li>Apr 6 - Easter Monday</li>
      <li>May 1 - Labour Day</li>
      <li>May 14 - Ascension Day</li>
      <li>May 25 - Whit Monday</li>
      <li>Jul 21 - Belgian National Holiday</li>
      <li>Aug 15 - Assumption Day (Saturday - substitute TBD)</li>
      <li>Nov 1 - All Saints' Day (Sunday - substitute TBD)</li>
      <li>Nov 11 - Armistice Day</li>
      <li>Dec 25 - Christmas Day</li>
    </ul>
    <p style="margin-top: 0.75rem; font-style: italic;">
      If a holiday falls the day before a contracted work day, you may need to be in Belgium.
      These still count toward the 183-day threshold.
    </p>
  </div>
</details>
```

3. Add entry/exit explanation to the calendar section header area:
```html
<div class="calendar-info" style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 4px; font-size: 0.9rem;">
  <strong style="color: var(--accent);">How days are counted:</strong>
  <ul style="margin: 0.5rem 0 0 1.5rem; opacity: 0.8; line-height: 1.6;">
    <li><strong>Belgium days</strong> + <strong>Travel days</strong> count toward 183-day threshold</li>
    <li><strong>Spain days</strong> do not count toward threshold</li>
    <li><strong>Travel days:</strong> Use for flight days between countries</li>
  </ul>
</div>
```

4. The existing source-hint CSS already handles the tooltip styling (reused from Phase 1).
  </action>
  <verify>
1. Hover over "?" icon near annual count: Tooltip explains entry/exit day counting
2. Click "Belgian Public Holidays" details: Holiday list expands
3. Holiday note about being in Belgium day before contracted day is visible
4. Calendar info section explains how Belgium/Travel/Spain days affect threshold
5. Tooltip mentions Spain-Belgium tax treaty
  </verify>
  <done>
Entry/exit day warning displayed via tooltip explaining both-country counting. Belgian holidays reference available. Calendar info explains counting rules. CAL-09 requirement satisfied.
  </done>
</task>

</tasks>

<verification>
1. Test ICS export:
   - Download belgium-calendar-2026.ics
   - Import to Google Calendar or Apple Calendar
   - Verify events appear as all-day events with correct titles
2. Test CSV export:
   - Download belgium-calendar-2026.csv
   - Open in Excel/Numbers/Google Sheets
   - Verify headers, data rows, and summary section
3. Test clipboard copy:
   - Click "Copy Summary"
   - Notification appears and auto-hides
   - Paste shows formatted summary with counts
4. Test documentation:
   - Hover "?" tooltip shows entry/exit explanation
   - Belgian holidays section expands with list
   - Calendar info section visible
</verification>

<success_criteria>
- CAL-08: Export calendar data (ICS, CSV, clipboard) (COMPLETE)
- CAL-09: Entry/exit days counting warning (COMPLETE)
- All exports include status and contracted information
- User understands 183-day threshold counting rules
</success_criteria>

<output>
After completion, create `.planning/phases/04-belgium-calendar/04-03-SUMMARY.md`
</output>
