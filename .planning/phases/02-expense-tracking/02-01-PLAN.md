---
phase: 02-expense-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "Expense data persists between browser sessions"
    - "Belgium toggle switches between 1K and 2.5K patterns"
    - "Reset button restores all expenses to defaults with confirmation"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "DEFAULT_EXPENSES constant, localStorage functions, Belgium toggle CSS"
      contains: "DEFAULT_EXPENSES"
  key_links:
    - from: "loadExpenses()"
      to: "localStorage"
      via: "JSON.parse/stringify"
      pattern: "localStorage\\.getItem"
    - from: "belgiumToggle change event"
      to: "expenseData.belgiumPattern"
      via: "event listener"
      pattern: "belgiumToggle.*addEventListener"
---

<objective>
Create the expense data system with DEFAULT_EXPENSES constant, localStorage persistence, and Belgium pattern toggle.

Purpose: Establish the data foundation for expense tracking - all expense values, categories, and user preferences will be stored and persisted through this system. The Belgium toggle allows switching between low-travel (1K/month) and high-travel (2.5K/month) cost patterns.

Output: Working data layer with DEFAULT_EXPENSES constant, loadExpenses()/saveExpenses() functions, Belgium CSS toggle switch, and resetToDefaults() with confirmation.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-expense-tracking/02-CONTEXT.md
@.planning/phases/02-expense-tracking/02-RESEARCH.md
@autonomo_dashboard.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DEFAULT_EXPENSES constant and expense data functions</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add after the SOURCES constant (around line 244):

1. Create DEFAULT_EXPENSES constant with three categories:
   - spainDeductible: Pre-filled with Huur (1155, 30%), GSM (55, 50%), Elektriciteit (100, 9%)
   - belgiumCosts: Single entry with isPatternLinked: true, amount based on pattern
   - private: Huur 70% (808.50), GSM 50% (27.50), Elektriciteit 91% (91), Auto (600), Verzekeringen (200)

2. Create STORAGE_KEY constant: 'autonomo_expenses_v1'

3. Create loadExpenses() function:
   - Try to load from localStorage, parse JSON
   - Check version === 1, return parsed data if valid
   - Catch errors (Safari private mode), return structuredClone(DEFAULT_EXPENSES)
   - Log warning to console if localStorage fails

4. Create saveExpenses() function:
   - Try to save to localStorage via JSON.stringify
   - Catch QuotaExceededError, log warning
   - Return boolean success

5. Create global expenseData variable initialized from loadExpenses()

Data structure per RESEARCH.md:
```javascript
const DEFAULT_EXPENSES = {
  version: 1,
  belgiumPattern: 'high',  // 'low' (1000) or 'high' (2500)
  categories: {
    spainDeductible: [
      { id: 'huur', name: 'Huur (Rent)', baseAmount: 1155, deductionPct: 30, deletable: true },
      { id: 'gsm', name: 'GSM (Mobile)', baseAmount: 55, deductionPct: 50, deletable: true },
      { id: 'elektriciteit', name: 'Elektriciteit', baseAmount: 100, deductionPct: 9, deletable: true }
    ],
    belgiumCosts: [
      { id: 'belgium-travel', name: 'Belgium Work Costs', amount: 2500, isPatternLinked: true, deletable: true }
    ],
    private: [
      { id: 'huur-private', name: 'Huur 70%', amount: 808.50, deletable: true },
      { id: 'gsm-private', name: 'GSM 50%', amount: 27.50, deletable: true },
      { id: 'elektriciteit-private', name: 'Elektriciteit 91%', amount: 91, deletable: true },
      { id: 'auto', name: 'Auto', amount: 600, deletable: true },
      { id: 'verzekeringen', name: 'Verzekeringen', amount: 200, deletable: true }
    ]
  }
};
```

Use Object.freeze() on DEFAULT_EXPENSES to prevent accidental mutation.
  </action>
  <verify>
Open browser console, verify:
- DEFAULT_EXPENSES exists and is frozen
- loadExpenses() returns expense data object
- saveExpenses() returns true (or false in private mode without error)
- expenseData is initialized correctly
  </verify>
  <done>DEFAULT_EXPENSES constant exists with all pre-filled expenses, localStorage functions work with error handling, global expenseData initialized on page load</done>
</task>

<task type="auto">
  <name>Task 2: Add Belgium pattern toggle CSS and JavaScript</name>
  <files>autonomo_dashboard.html</files>
  <action>
1. Add CSS for toggle switch in the style block (after existing styles):
```css
/* Belgium Pattern Toggle */
.toggle-switch {
  position: relative;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
  position: absolute;
}

.toggle-switch .slider {
  position: relative;
  width: 50px;
  height: 26px;
  background: #444;
  border-radius: 13px;
  cursor: pointer;
  transition: background 0.3s;
}

.toggle-switch .slider::before {
  content: '';
  position: absolute;
  width: 20px;
  height: 20px;
  left: 3px;
  top: 3px;
  background: white;
  border-radius: 50%;
  transition: transform 0.3s;
}

.toggle-switch input:checked + .slider {
  background: var(--accent);
}

.toggle-switch input:checked + .slider::before {
  transform: translateX(24px);
}

.toggle-switch input:focus + .slider {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

.toggle-label {
  font-size: 0.9rem;
  opacity: 0.7;
}

.toggle-label.active {
  opacity: 1;
  font-weight: 600;
}
```

2. Create updateBelgiumCost() function:
   - Find expense with isPatternLinked: true in belgiumCosts
   - Set amount to 1000 if pattern === 'low', 2500 if 'high'

3. Create initBelgiumToggle() function:
   - Get toggle checkbox element by ID 'belgiumToggle'
   - Set checked state based on expenseData.belgiumPattern === 'high'
   - Update toggle labels' active class based on state
   - Add change event listener that:
     a. Updates expenseData.belgiumPattern
     b. Calls updateBelgiumCost()
     c. Calls saveExpenses()
     d. Updates toggle label active states

4. Create getBelgiumBreakdownFormula() function per RESEARCH.md:
   - If 'high': "~17 days x 91.35 EUR dietas + 4 flights x 250 EUR = ~2,500 EUR"
   - If 'low': "~3 days x 91.35 EUR dietas + 1 flight x 250 EUR = ~1,000 EUR"
   - Use formatEUR() for currency values
  </action>
  <verify>
Browser test (will need UI in Task 3 or Plan 02-02 to fully verify):
- Toggle CSS classes exist in DOM
- initBelgiumToggle() can be called without error
- getBelgiumBreakdownFormula() returns correct strings for both patterns
- updateBelgiumCost() modifies the correct expense amount
  </verify>
  <done>CSS toggle switch styled, Belgium toggle JavaScript functions work, pattern changes persist to localStorage</done>
</task>

<task type="auto">
  <name>Task 3: Add resetToDefaults function and DIETAS source citation</name>
  <files>autonomo_dashboard.html</files>
  <action>
1. Create resetToDefaults() function:
   - Show confirm() dialog: "Reset all expenses to default values? This cannot be undone."
   - If confirmed:
     a. expenseData = structuredClone(DEFAULT_EXPENSES)
     b. saveExpenses()
     c. Re-initialize Belgium toggle state
   - Return boolean indicating if reset occurred

2. Add DIETAS entry to SOURCES constant (for DATA-05 requirement):
```javascript
DIETAS: {
  name: "Dietas y Asignaciones para Gastos de Viaje",
  source: "Reglamento IRPF Art. 9",
  url: "https://www.boe.es/buscar/act.php?id=BOE-A-2007-6820&tn=1&p=20231228#a9",
  note: "Abroad: 91.35 EUR/day with overnight, 48.08 EUR without. Spain: 53.34 EUR/day with overnight, 26.67 EUR without.",
  confidence: "HIGH"
}
```

3. Create calculateDeductible(expense) helper function:
   - If expense has baseAmount and deductionPct: return baseAmount * (deductionPct / 100)
   - Otherwise return expense.amount || 0
   - Round to 2 decimal places

4. Create calculateCategoryTotal(categoryKey) function:
   - Sum calculateDeductible() for all expenses in that category
   - Return total rounded to 2 decimals

5. Create getExpenseTotals() function that returns:
```javascript
{
  spainDeductible: { monthly: X, annual: X*12 },
  belgiumCosts: { monthly: X, annual: X*12 },
  private: { monthly: X, annual: X*12 },
  totalDeductible: { monthly: spain+belgium, annual: (spain+belgium)*12 }
}
```
  </action>
  <verify>
Console tests:
- resetToDefaults() shows confirm dialog
- SOURCES.DIETAS exists with correct URL
- calculateDeductible({baseAmount: 1155, deductionPct: 30}) returns 346.50
- calculateCategoryTotal('spainDeductible') returns 383 (346.50 + 27.50 + 9)
- getExpenseTotals().private.monthly returns 1727
  </verify>
  <done>Reset function with confirmation works, DIETAS source citation added (DATA-05), expense calculation helpers ready for UI integration</done>
</task>

</tasks>

<verification>
After all tasks:

1. **Data persistence test:**
   - Open page, call `saveExpenses()` in console
   - Refresh page
   - Verify `expenseData` matches saved data

2. **Belgium toggle test:**
   - Call `expenseData.belgiumPattern = 'low'; updateBelgiumCost()`
   - Verify belgium expense amount is 1000
   - Toggle back to 'high', verify 2500

3. **Totals calculation test:**
   - `getExpenseTotals().spainDeductible.monthly` === 383 (346.50 + 27.50 + 9)
   - `getExpenseTotals().belgiumCosts.monthly` === 2500 (default high pattern)
   - `getExpenseTotals().private.monthly` === 1727

4. **Reset test:**
   - Modify expenseData manually
   - Call resetToDefaults(), click OK
   - Verify expenseData matches DEFAULT_EXPENSES

5. **Source citation:**
   - SOURCES.DIETAS exists with Reglamento IRPF reference
</verification>

<success_criteria>
- DEFAULT_EXPENSES has all pre-filled expenses from CLAUDE.md
- localStorage persistence works (with graceful fallback)
- Belgium pattern toggle updates expense amount
- Reset restores defaults with confirmation
- DIETAS source added for DATA-05 compliance
- Expense total calculations are correct
</success_criteria>

<output>
After completion, create `.planning/phases/02-expense-tracking/02-01-SUMMARY.md`
</output>
