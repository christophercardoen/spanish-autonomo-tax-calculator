---
phase: 02-expense-tracking
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - autonomo_dashboard.html
autonomous: true

must_haves:
  truths:
    - "Spain deductible expenses display with formulas like '1,155 EUR x 30% = 346.50 EUR/month (4,158 EUR/year)'"
    - "Belgium work costs show toggle and breakdown formula"
    - "Private expenses display separately with clear 'not deductible' indication"
    - "User can add new expenses and delete existing ones"
    - "Changing expenses recalculates the IRPF results"
  artifacts:
    - path: "autonomo_dashboard.html"
      provides: "Three expense sections with formula display, add/delete functionality, Phase 1 integration"
      contains: "expense-section"
  key_links:
    - from: "renderExpenseSection()"
      to: "expenseData.categories"
      via: "DOM rendering"
      pattern: "renderExpenseSection"
    - from: "addExpense()/deleteExpense()"
      to: "recalculateTotals()"
      via: "function call chain"
      pattern: "recalculateTotals"
    - from: "recalculateTotals()"
      to: "calculateFullIRPF()"
      via: "Phase 1 integration"
      pattern: "calculateFullIRPF.*totalDeductible"
---

<objective>
Build the expense tracking UI with three categorized sections, formula display, add/delete functionality, and integration with Phase 1 IRPF calculations.

Purpose: Allow users to see, modify, and manage their expenses with full transparency into how deductions are calculated. Changes to expenses immediately recalculate the tax results.

Output: Complete expense tracking interface with Spain Deductible (green), Belgium Work Costs (blue with toggle), and Private (red) sections. Each expense shows its formula. Users can add/delete expenses. All changes trigger IRPF recalculation.
</objective>

<execution_context>
@/Users/christophercardoen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christophercardoen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-expense-tracking/02-CONTEXT.md
@.planning/phases/02-expense-tracking/02-RESEARCH.md
@.planning/phases/02-expense-tracking/02-01-SUMMARY.md
@autonomo_dashboard.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add expense section CSS styles</name>
  <files>autonomo_dashboard.html</files>
  <action>
Add CSS in the style block for expense sections:

```css
/* Expense Sections */
.expenses-container {
  margin-top: 2rem;
}

.expense-section {
  margin-bottom: 2rem;
  padding: 1rem;
  border-radius: 8px;
  background: rgba(255,255,255,0.03);
}

.expense-section.spain-deductible {
  border-left: 3px solid #4ade80;  /* Green - deductible */
}

.expense-section.belgium-costs {
  border-left: 3px solid #60a5fa;  /* Blue - Belgium */
}

.expense-section.private {
  border-left: 3px solid #f87171;  /* Red - not deductible */
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.section-title {
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.section-total {
  font-family: 'JetBrains Mono', monospace;
  opacity: 0.8;
}

.expense-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  flex-wrap: wrap;
  gap: 0.5rem;
}

.expense-row:last-child {
  border-bottom: none;
}

.expense-name {
  font-weight: 500;
  min-width: 150px;
}

.expense-formula {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.85rem;
  opacity: 0.7;
  flex: 1;
  text-align: center;
}

.expense-value {
  font-family: 'JetBrains Mono', monospace;
  font-weight: 600;
  min-width: 200px;
  text-align: right;
}

.expense-actions {
  display: flex;
  gap: 0.25rem;
}

.delete-btn {
  background: transparent;
  border: 1px solid #f87171;
  color: #f87171;
  width: 24px;
  height: 24px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  line-height: 1;
  padding: 0;
}

.delete-btn:hover {
  background: #f87171;
  color: var(--bg);
}

/* Add Expense Form */
.add-expense-btn {
  background: transparent;
  border: 1px dashed rgba(255,255,255,0.3);
  color: var(--text);
  padding: 0.5rem 1rem;
  border-radius: 4px;
  cursor: pointer;
  margin-top: 0.5rem;
  width: 100%;
}

.add-expense-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
}

.add-form {
  background: rgba(0,0,0,0.2);
  padding: 1rem;
  border-radius: 4px;
  margin-top: 0.5rem;
}

.add-form.hidden {
  display: none;
}

.add-form h4 {
  margin: 0 0 1rem 0;
  color: var(--accent);
}

.form-row {
  margin-bottom: 0.75rem;
}

.form-row label {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  font-size: 0.9rem;
}

.form-row input,
.form-row select {
  padding: 0.5rem;
  background: var(--bg);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 4px;
  color: var(--text);
}

.form-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 1rem;
}

.form-actions button {
  padding: 0.5rem 1rem;
  border-radius: 4px;
  cursor: pointer;
}

.form-actions button:first-child {
  background: var(--accent);
  border: none;
  color: var(--bg);
}

.form-actions button:last-child {
  background: transparent;
  border: 1px solid rgba(255,255,255,0.3);
  color: var(--text);
}

/* Belgium breakdown formula */
.belgium-breakdown {
  font-size: 0.8rem;
  opacity: 0.6;
  margin-top: 0.25rem;
  font-style: italic;
}

/* Reset button */
.reset-btn {
  background: transparent;
  border: 1px solid #f87171;
  color: #f87171;
  padding: 0.5rem 1rem;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.85rem;
}

.reset-btn:hover {
  background: #f87171;
  color: var(--bg);
}
```
  </action>
  <verify>
Open page in browser, inspect CSS:
- .expense-section classes exist with correct border colors
- .toggle-switch classes work (from Plan 02-01)
- Form styles ready for add expense functionality
  </verify>
  <done>All expense section CSS styles in place with color-coded borders, form styling, and responsive layout</done>
</task>

<task type="auto">
  <name>Task 2: Create expense rendering functions and HTML structure</name>
  <files>autonomo_dashboard.html</files>
  <action>
1. Create formatFormula(expense) function:
   - If expense has baseAmount and deductionPct:
     ```
     const result = expense.baseAmount * (expense.deductionPct / 100);
     return `${formatEUR(expense.baseAmount)} x ${expense.deductionPct}% = ${formatEUR(result)}`;
     ```
   - Else for private (0% deduction):
     ```
     return `${formatEUR(expense.amount)} x 0% = ${formatEUR(0)}`;
     ```
   - Else (Belgium costs):
     ```
     return `${formatEUR(expense.amount)} x 100% = ${formatEUR(expense.amount)}`;
     ```

2. Create renderExpenseRow(expense, categoryKey) function:
   - Calculate monthly = calculateDeductible(expense)
   - Calculate annual = monthly * 12
   - Return HTML string:
     ```html
     <div class="expense-row" data-id="${expense.id}" data-category="${categoryKey}">
       <span class="expense-name">${expense.name}</span>
       <span class="expense-formula">${formatFormula(expense)}</span>
       <span class="expense-value">${formatEUR(monthly)}/month (${formatEUR(annual)}/year)</span>
       <div class="expense-actions">
         <button class="delete-btn" onclick="deleteExpense('${categoryKey}', '${expense.id}')" title="Delete">x</button>
       </div>
     </div>
     ```

3. Create renderExpenseSection(categoryKey, sectionClass, title) function:
   - Get expenses from expenseData.categories[categoryKey]
   - Calculate section total using calculateCategoryTotal(categoryKey)
   - For Belgium section, include toggle in header
   - Return full section HTML with header, expense rows, subtotal, and add button

4. Create renderAllSections() function:
   - Clear and render Spain Deductible section
   - Clear and render Belgium Work Costs section (with toggle and breakdown formula)
   - Clear and render Private section
   - Update section totals

5. Add HTML structure in the container div (after input-section, before results):
```html
<div class="expenses-container">
  <h2>Expense Tracking</h2>
  <div id="spainSection"></div>
  <div id="belgiumSection"></div>
  <div id="privateSection"></div>
  <div style="margin-top: 1rem; display: flex; justify-content: flex-end;">
    <button class="reset-btn" onclick="resetToDefaults()">Reset to Defaults</button>
  </div>
</div>
```

6. For Belgium section header, include inline toggle:
```html
<div class="section-header">
  <span class="section-title">Belgium Work Costs</span>
  <div class="toggle-switch">
    <span class="toggle-label" id="lowLabel">Low (1K)</span>
    <label>
      <input type="checkbox" id="belgiumToggle">
      <span class="slider"></span>
    </label>
    <span class="toggle-label" id="highLabel">High (2.5K)</span>
  </div>
  <span class="section-total">Total: ${formatEUR(total)}/month</span>
</div>
<div class="belgium-breakdown">${getBelgiumBreakdownFormula()}</div>
```
  </action>
  <verify>
Render test:
- Call renderAllSections() in console
- Three sections appear with correct colors
- Each expense shows formula in format "X EUR x Y% = Z EUR"
- Belgium section shows toggle and breakdown formula
- Section totals display correctly
  </verify>
  <done>Expense sections render with formulas, Belgium toggle inline, subtotals visible, delete buttons work</done>
</task>

<task type="auto">
  <name>Task 3: Implement add/delete expense functionality and Phase 1 integration</name>
  <files>autonomo_dashboard.html</files>
  <action>
1. Create addExpense(categoryKey, expense) function:
   - Generate ID if not provided: expense.id = expense.id || crypto.randomUUID()
   - Push expense to expenseData.categories[categoryKey]
   - saveExpenses()
   - renderAllSections()
   - recalculateTotals()

2. Create deleteExpense(categoryKey, expenseId) function:
   - Find index in expenseData.categories[categoryKey]
   - If found, splice to remove
   - saveExpenses()
   - renderAllSections()
   - recalculateTotals()

3. Create showAddForm(categoryKey) function:
   - Show the add form div
   - Pre-select the correct category in dropdown
   - Show/hide deduction % field based on category (show for spainDeductible, hide for others)

4. Create hideAddForm() function:
   - Hide the add form div
   - Clear input values

5. Create submitNewExpense() function:
   - Read values from form inputs
   - Validate: name required, amount >= 0
   - Build expense object based on category:
     - spainDeductible: { name, baseAmount, deductionPct, deletable: true }
     - belgiumCosts: { name, amount, deletable: true }
     - private: { name, amount, deletable: true }
   - Call addExpense(category, expense)
   - hideAddForm()

6. Create recalculateTotals() function (KEY INTEGRATION):
   - Get totals from getExpenseTotals()
   - Get monthlyRevenue from existing input
   - Get hasDescendant from existing checkbox
   - Calculate totalDeductible = spainDeductible.monthly + belgiumCosts.monthly
   - Call calculateFullIRPF(monthlyRevenue, totalDeductible, hasDescendant)
   - Update results display
   - Update private costs display in results

7. Modify existing calculate() function:
   - Remove the hardcoded monthlyExpenses input reading
   - Instead, call recalculateTotals() which handles everything

8. Add global add form HTML (one form for all sections):
```html
<div id="addExpenseForm" class="add-form hidden">
  <h4>Add New Expense</h4>
  <div class="form-row">
    <label>Name: <input type="text" id="newExpName" required></label>
  </div>
  <div class="form-row">
    <label>Amount (EUR/month): <input type="number" id="newExpAmount" min="0" step="0.01" required></label>
  </div>
  <div class="form-row">
    <label>Category:
      <select id="newExpCategory" onchange="toggleDeductionField()">
        <option value="spainDeductible">Spain Deductible</option>
        <option value="belgiumCosts">Belgium Travel</option>
        <option value="private">Private</option>
      </select>
    </label>
  </div>
  <div class="form-row" id="deductionRow">
    <label>Deduction %: <input type="number" id="newExpDeduction" min="0" max="100" value="100"></label>
  </div>
  <div class="form-actions">
    <button onclick="submitNewExpense()">Add</button>
    <button onclick="hideAddForm()">Cancel</button>
  </div>
</div>
```

9. Create toggleDeductionField() function:
   - Show deduction row if category is spainDeductible
   - Hide otherwise (Belgium/private don't use percentage)

10. Update DOMContentLoaded event:
    - Call loadExpenses() (already done in 02-01)
    - Call renderAllSections()
    - Call initBelgiumToggle()
    - Call recalculateTotals() instead of calculate()

11. Remove or hide the old "Monthly Deductible Expenses" input field since expenses are now managed through the sections. The revenue input remains.
  </action>
  <verify>
Full integration test:
1. Page loads with expense sections rendered
2. Each expense shows correct formula
3. Click delete on an expense - it disappears, totals update, IRPF recalculates
4. Click "Add Expense" - form appears
5. Add a new expense - it appears in list, totals update, IRPF recalculates
6. Toggle Belgium pattern - amount changes, IRPF recalculates
7. Refresh page - all changes persist
8. Click "Reset to Defaults" - confirm dialog - expenses reset
  </verify>
  <done>Add/delete expense functionality works, Phase 1 integration complete (expense changes trigger IRPF recalculation), persistence verified</done>
</task>

</tasks>

<verification>
After all tasks, verify all EXP requirements:

**EXP-01: Spain deductible expenses**
- Huur shows: "1,155.00 EUR x 30% = 346.50 EUR" with monthly/annual
- GSM shows: "55.00 EUR x 50% = 27.50 EUR" with monthly/annual
- Elektriciteit shows: "100.00 EUR x 9% = 9.00 EUR" with monthly/annual
- Section total: 383.00 EUR/month

**EXP-02: Belgium work costs**
- Toggle switches between 1K and 2.5K
- Breakdown formula visible: "~17 days x 91.35 EUR dietas + 4 flights x 250 EUR = ~2,500 EUR"
- Pattern persists between sessions

**EXP-03: Private expenses**
- Total displays as 1,727 EUR/month
- Each shows 0% deduction formula
- Clearly marked with red border

**EXP-04: Categorization**
- Three distinct sections with color-coded borders
- Green for Spain Deductible
- Blue for Belgium Work Costs
- Red for Private (not deductible)

**EXP-05: Formula display**
- All expenses show calculation formula
- Format: "BASE x PERCENT% = RESULT"
- Both monthly and annual visible

**DATA-05: Dietas source**
- SOURCES.DIETAS exists (from Plan 02-01)
- Can be displayed via sourceHint('DIETAS') on Belgium section

**Integration test:**
1. Change revenue to 9,000 EUR/month
2. Toggle Belgium to High (2,500)
3. Verify IRPF recalculates with totalDeductible = 383 + 2500 = 2883/month
4. Add custom expense (e.g., "Software" 50 EUR/month 100% Spain Deductible)
5. Verify totalDeductible increases to 2933/month and IRPF updates
</verification>

<success_criteria>
- Three expense sections render with correct styling
- All expenses display formulas in "X EUR x Y% = Z EUR" format
- Belgium toggle works and updates amounts
- Add expense form works for all categories
- Delete removes expense and recalculates
- Phase 1 calculateFullIRPF() receives correct expense totals
- localStorage persistence works across page refresh
- Reset to defaults works with confirmation
</success_criteria>

<output>
After completion, create `.planning/phases/02-expense-tracking/02-02-SUMMARY.md`
</output>
