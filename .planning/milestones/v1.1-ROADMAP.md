# Milestone v1.1: Spanish Autónomo Tax Calculator

**Status:** ✅ SHIPPED 2026-02-03
**Phases:** 1-9 (includes 7.1, 7.2 decimal phases)
**Total Plans:** 29

## Overview

This milestone delivered a production-ready Spanish autónomo tax calculator with comprehensive IRPF/RETA calculations, expense tracking, scenario planning, an interactive Belgium work calendar with 183-day residency management, and complete compliance documentation. The tool provides real-time visibility into net income, tax obligations, and deductible expenses for a Spanish self-employed consultant working cross-border with Belgian clients.

The journey progressed from accurate fiscal calculations through expense tracking and scenario comparison to an interactive Belgium work calendar with professional dashboard UI, Excel export, and treaty documentation.

## Phases

### Phase 1: Fiscal Foundation

**Goal:** Accurate IRPF and RETA calculations using official 2025/2026 Spanish fiscal data
**Depends on:** Nothing (first phase)
**Plans:** 2 plans

Plans:
- [x] 01-01: Core IRPF/RETA calculation engine with 4-phase minimo method
- [x] 01-02: Source citations and official references in UI

**Details:**
- Implemented FISCAL_2025 constant with verified 2025/2026 tax rates from AEAT/BOE
- Progressive IRPF calculation with 6 brackets (19%, 24%, 30%, 37%, 45%, 47%)
- Fixed RETA cuota deduction (€428.40/month = €5,140.80/year)
- Mínimo personal (€5,550) and mínimo por descendientes (€2,400 for 1 daughter)
- 5% gastos de difícil justificación with €2,000 annual cap
- 4-phase AEAT method: minimos reduce TAX, not taxable BASE
- SOURCES constant with 6 official government references
- Hover tooltips and footnotes for all fiscal data citations
- All DATA-01 through DATA-04 requirements satisfied

### Phase 2: Expense Tracking

**Goal:** User can input and categorize business expenses vs private costs
**Depends on:** Phase 1
**Plans:** 2 plans

Plans:
- [x] 02-01: Expense data system with localStorage and Belgium toggle
- [x] 02-02: Expense UI sections and Phase 1 integration

**Details:**
- Three expense categories: Spain Deductible, Belgium Costs, Private
- Formula display with "BASE × PERCENT% = RESULT" for transparency
- Belgium cost toggle between low (€1,000) and high (€2,500) patterns
- Add/delete expense functionality with localStorage persistence
- Category-specific forms (baseAmount + deductionPct for Spain Deductible)
- Live IRPF recalculation on expense changes
- All EXP-01 through EXP-05 requirements satisfied

### Phase 3: Scenario Engine

**Goal:** User can compare multiple income scenarios side-by-side with live editing
**Depends on:** Phase 1, Phase 2
**Plans:** 3 plans

Plans:
- [x] 03-01: Scenario data system and horizontal card layout with optimal indicator
- [x] 03-02: Edit modal with split view and live recalculation
- [x] 03-03: Comparison table with sticky header and custom scenario creation

**Details:**
- 5 pre-configured scenarios (A: €3K, B: €6K, C: €9K, D: €12K, E: €18K)
- Belgium patterns: A/B use 'low' (€1K), C/D/E use 'high' (€2.5K)
- Horizontal scrolling scenario cards sorted by leefgeld (highest first)
- "Highest Disposable" badge on optimal scenario
- Edit modal with split view (inputs left, results right)
- Live recalculation with requestAnimationFrame debouncing
- Fiscal overrides in collapsible details element (advanced what-if analysis)
- Comparison table with optimal value highlighting
- Custom scenario creation from templates with structuredClone
- All SCEN-01 through SCEN-07 requirements satisfied

### Phase 4: Belgium Calendar

**Goal:** User can track and manage Belgium presence days with 183-day threshold awareness
**Depends on:** Nothing (independent feature)
**Plans:** 3 plans

Plans:
- [x] 04-01: Calendar data system and grid rendering with contracted pattern wizard
- [x] 04-02: Day picker dialog, counting system, and warning thresholds
- [x] 04-03: Export functionality (ICS, CSV, clipboard) and entry/exit documentation

**Details:**
- Calendar displays Feb-Dec 2026 with Monday-start week alignment
- Contracted pattern wizard pre-fills Mon-Tue weekly + first-week Wed-Fri
- "C" badge distinguishes contracted obligation days from flexible days
- Status colors: Belgium (blue), Spain (green), Travel (orange)
- Day picker dialog with deferred save workflow
- Shift-click range selection for bulk operations
- Monthly and annual day counts with automatic updates
- Warning thresholds at 170/180/183 days (Belgium + Travel counted conservatively)
- ICS export following RFC 5545 for calendar app compatibility
- CSV export with summary statistics
- Clipboard copy with notification
- Entry/exit day tooltip with treaty reference
- Belgian Public Holidays 2026 as reference
- All CAL-01 through CAL-09 requirements satisfied

### Phase 5: Dashboard UI

**Goal:** Professional financial dashboard aesthetic that integrates all calculator features
**Depends on:** Phase 1, Phase 2, Phase 3, Phase 4
**Plans:** 3 plans

Plans:
- [x] 05-01: Typography, theme updates, and tabbed layout structure
- [x] 05-02: Enhanced scenario cards and sticky table column
- [x] 05-03: Tooltips, export functionality, and responsive mobile layout

**Details:**
- DM Sans + JetBrains Mono typography (Bloomberg-inspired professional aesthetic)
- Charcoal #1a1a1a background (pure neutral, no purple tint)
- CSS radio button tabs (no JS, instant switching, keyboard accessible)
- Semantic color variables: green=positive, red=negative, orange=warning, blue=Belgium
- Tabbed layout: Scenarios, Calendar, Expenses, Details, Compliance, Income
- 320px scenario cards with full breakdown (4-section detail modal on click)
- Stronger hover effects: -4px lift with green glow
- Sticky first column in comparison table (z-index hierarchy 99/100/101)
- ARIA tooltips for 8 technical terms (role=tooltip, Escape key dismisses)
- Print stylesheet with light theme for PDF export
- Clipboard copy for comparison table data
- Responsive mobile layout: 600px breakpoint, vertical comparison blocks
- All UI-01 through UI-12 requirements satisfied

### Phase 6: Excel Calculator

**Goal:** Professional Excel workbook that recalculates correctly with no hardcoded values
**Depends on:** Phase 1, Phase 2, Phase 3
**Plans:** 3 plans

Plans:
- [x] 06-01: Node.js project setup with ExcelJS and Constants sheet with named ranges
- [x] 06-02: Scenario sheet template with IRPF brackets and 4-phase minimo
- [x] 06-03: Overview sheet with comparison table and final verification

**Details:**
- Node.js project with ExcelJS dependency for .xlsx generation
- Constanten sheet with 7 named ranges (RETA_MONTHLY, MINIMO_PERSONAL, etc.)
- IRPF brackets reference table (6 brackets from 19% to 47%)
- createScenarioSheet() function with 6-section template
- All 5 scenarios (A-E) with correct preset values and Belgium patterns
- Step-by-step IRPF bracket calculation rows
- 4-phase minimo calculation visible (Base → Brackets → Minimo → Final)
- Conditional formatting: leefgeld (<0 red, 0-500 orange, ≥500 green)
- Overzicht sheet with cross-sheet comparison table
- Dutch localization of all labels (Bruto Inkomsten, Kosten, Belastingen)
- Flexible input cells (no restrictive dropdowns)
- Print layouts and hyperlink navigation
- All XLS-01 through XLS-10 requirements satisfied

### Phase 7: Compliance & Documentation

**Goal:** User understands fiscal compliance obligations and residency defense provisions
**Depends on:** Phase 4 (calendar for 183-day context)
**Plans:** 2 plans

Plans:
- [x] 07-01: Compliance tab with treaty provisions, family presumption, dietas limits, and documentation requirements
- [x] 07-02: Warning banner integration, disclaimer footer, and entry/exit day warning

**Details:**
- Compliance tab (5th tab) with 8 collapsible sections
- Action-phase organization: "Before Travel", "While Working", "When Filing"
- Spain-Belgium Treaty Article 4 tie-breaker hierarchy (5 steps)
- Centro de intereses vitales explanation with family situation
- Art. 9.1.b LIRPF family presumption (Spanish legal text + plain summary)
- Dietas limits table (€91.35 abroad with overnight, €48.08 without)
- Factura completa requirements (13 required fields listed)
- Electronic payment requirement warning
- Invalid document types (4 types that don't qualify)
- 183-day threshold section with entry/exit day warning
- Warning banner at 170/180/183 Belgium days (dismissible, session storage)
- Global disclaimer footer visible on all tabs
- All BOE references cited with source numbers
- All COMP-01 through COMP-10 requirements satisfied

### Phase 7.1: Critical Bug Fixes (INSERTED)

**Goal:** Fix critical bugs and UX issues discovered in user testing that block v1.0 release
**Depends on:** Phase 7
**Plans:** 3 plans

Plans:
- [x] 7.1-01: Fix add expense button, remove Dutch text, redesign Belgium pill toggle
- [x] 7.1-02: Redesign tooltips as centered modals with blur backdrop
- [x] 7.1-03: Enhanced calendar multi-select with week and month selection

**Details:**
- Fixed add expense button functionality (was non-functional)
- Full English localization (removed all Dutch text from UI)
- Belgium cost toggle redesigned with pill-style buttons (Low/High)
- Tooltips converted to centered modals with backdrop blur
- Native dialog element with focus trap and Esc key handling
- Calendar week selection with "W" buttons for each week
- Calendar month "Select All" button
- Selection indicator with count badge and clear functionality
- Enhanced selected day visual highlighting (green overlay + border)
- All BUG-01 through BUG-05 requirements satisfied

### Phase 7.2: UI/UX Polish & Generalization (INSERTED)

**Goal:** Comprehensive UI/UX overhaul - fix bugs, improve visual design, remove hardcoded Belgium features, ensure full English localization
**Depends on:** Phase 7.1
**Plans:** 4 plans

Plans:
- [x] 7.2-01: English localization (Leefgeld replacement) and visual polish (spacing, typography, shadows)
- [x] 7.2-02: Remove Belgium hardcoding (generalize expense system)
- [x] 7.2-03: Mobile and desktop layout audit with automated fixes
- [x] 7.2-04: Human verification and bug fix cycle

**Details:**
- "Disposable Income" terminology replaces "Leefgeld" throughout UI
- CSS spacing tokens (--spacing-xs to --spacing-2xl: 4px to 48px)
- CSS radius tokens (--radius-sm/md/lg: 4px, 8px, 12px)
- :focus-visible for keyboard accessibility
- Enhanced card shadows and button consistency
- Belgium costs generalized to "Work Travel" category with editable items
- workTravelCost property replaces belgiumPattern enum
- Migration function for backwards compatibility
- Responsive breakpoints: 400px, 600px, 768px, 1440px, 1920px
- 44px minimum touch targets (industry standard)
- structuredClone polyfill for older Safari browsers
- Comprehensive mono font fallback stack
- Calendar redesigned with checkbox multi-select (Gmail-style)
- Details tab converted to interactive What-If Calculator
- Compliance tab optimized with 2-column layout
- Native dialog for all modals (consistent pattern)
- All POLISH-01 through POLISH-10 requirements satisfied

### Phase 8: Enhanced Features

**Goal:** Add missing v1 features: multi-select calendar improvements, income tracking, and official source links
**Depends on:** Phase 7.2
**Plans:** 3 plans

Plans:
- [x] 08-01: Calendar visual feedback and expense auto-detection
- [x] 08-02: Income tracking tab with CRUD and localStorage
- [x] 08-03: Official source links throughout Details and Compliance tabs

**Details:**
- Enhanced calendar selection: green overlay, 2px border, glow effect
- Selection count badge with pill styling (border-radius: 999px)
- DEDUCTIBLE_100_CATEGORIES constant (IT/consulting keywords)
- Expense auto-detection for Spain Deductible category
- HIGH confidence: green badge + auto-fill 100%
- MEDIUM confidence: orange badge (no auto-fill)
- Income tracking tab (5th position, after Details)
- Income entries: client, amount, date, invoice, status, description
- Sort by date/amount/client, filter by text search
- Status color coding: paid=green, pending=orange, overdue=red
- Total unaffected by filter (shows all entries)
- XSS protection with escapeHtml for user input
- OFFICIAL_SOURCES constant with 13 verified AEAT/BOE/SS URLs
- renderSourceLink() for button-style external links (blue color)
- renderInlineSource() for inline text citations
- Source hints in Details tab (RETA, Minimo Personal)
- Inline sources throughout Compliance tab sections
- Official Sources grid section at bottom of Compliance
- All ENH-01 through ENH-06 requirements satisfied

### Phase 9: Fix Reset to Defaults Button

**Goal:** Fix critical integration issue preventing "Reset to Defaults" button from working
**Depends on:** Phase 8
**Plans:** 1 plan

Plans:
- [x] 09-01: Fix missing function reference and test reset functionality

**Details:**
- Removed invalid recalculateAllScenarios() call from resetScenarios()
- Fixed JavaScript ReferenceError when clicking Reset to Defaults button
- Documented lazy recalculation pattern (scenarios recalc on next render)
- Verified button now resets all scenarios to A-E presets successfully
- Cleared custom scenarios from localStorage
- Scenario cards and comparison table update correctly after reset

---

## Milestone Summary

**Decimal Phases:**

- Phase 7.1: Critical Bug Fixes (inserted after Phase 7 for urgent user-reported issues)
- Phase 7.2: UI/UX Polish & Generalization (inserted after Phase 7.1 for comprehensive polish)

**Key Decisions:**

- RETA as fixed cuota (€428.40/month) - User has documented cuota from registration
- 4-phase minimo method - Official AEAT methodology (minimos reduce TAX, not BASE)
- Gastos difícil at 5% (not 7%) - 7% was exceptional for 2023; reverted to 5% for 2024+
- Belgium pattern: A/B low (€1K), C/D/E high (€2.5K) - Per requirements specification
- DM Sans + JetBrains Mono typography - Bloomberg-inspired professional aesthetic
- Single-file HTML design - No build tools or frameworks for portability
- Native dialog element for all modals - Consistent pattern with accessibility built-in
- "Disposable Income" over "Leefgeld" - Clear English terminology for international users

**Issues Resolved:**

- Fixed add expense button (was non-functional after Phase 2)
- Fixed tooltip positioning (now centered modals with backdrop blur)
- Removed all Dutch text (full English localization)
- Generalized Belgium expenses (no longer hardcoded special case)
- Fixed calendar UX (checkbox multi-select more intuitive than shift-click)
- Fixed Reset to Defaults button (removed invalid function reference)

**Issues Deferred:**

- Excel generation not auto-synced with HTML (manual `node scripts/generate-excel.js` process)
- Quarterly Modelo 130 calculation and payment tracking (deferred to v2)
- RETA regularization estimator (deferred to v2)
- VeriFactu compliance checker for July 2026 requirement (deferred to v2)

**Technical Debt Incurred:**

- Three similar IRPF calculation functions (intentional for flexibility: main engine, scenario what-if, Excel verification)
- Excel generation requires manual Node.js execution (consider client-side generation in v2)

---

_For current project status, see .planning/ROADMAP.md (will be created for next milestone)_
